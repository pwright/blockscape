<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Blockscape — simple landscape-style tiles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light;
      --space-2xs: 0.2rem;
      --space-xs: 0.35rem;
      --space-sm: 0.5rem;
      --space-md: 0.75rem;
      --space-lg: 1.25rem;
      --space-xl: 2rem;
      --space-2xl: 3rem;

      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;

      --font-text: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      --font-mono: "JetBrains Mono", "Fira Code", monospace;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-md: 1rem;
      --font-size-lg: 1.2rem;
      --font-weight-regular: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;

      --color-text: #1f2937;
      --color-muted: #6b7280;
      --color-border: #d8dde8;
      --color-border-strong: #c3cad7;
      --color-surface: #ffffff;
      --color-surface-muted: #f4f6fb;
      --color-surface-subtle: #eef2f8;
      --color-shadow: 0 18px 36px -22px rgba(15, 23, 42, 0.45);

      --color-primary: #2563eb;
      --color-primary-soft: #e3edff;
      --color-danger: #dc2626;
      --color-danger-soft: #fde4e2;
      --color-warning: #f97316;
      --color-warning-soft: #ffe8d6;
      --color-accent: #0ea5e9;
      --color-external: #94a3b8;

      --transition: 160ms ease;

      --blockscape-tile: 6.5rem;
      --blockscape-gap: var(--space-md);
      --blockscape-radius: var(--radius-lg);
      --blockscape-foreground: var(--color-text);
      --blockscape-muted: var(--color-muted);
      --blockscape-border: var(--color-border);
      --blockscape-surface: var(--color-surface);
      --blockscape-surface-alt: var(--color-surface-muted);
      --blockscape-dep: var(--color-primary);
      --blockscape-revdep: #ef4444;
      --blockscape-reused: var(--color-warning);
      --blockscape-external: var(--color-external);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--color-surface-subtle);
      color: var(--color-text);
      font-family: var(--font-text);
      -webkit-font-smoothing: antialiased;
    }

    a {
      color: inherit;
    }

    .pf-v5-c-page {
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    .pf-v5-c-page__header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--color-surface);
      box-shadow: 0 1px 0 var(--color-border);
    }

    .blockscape-masthead {
      border-bottom: none;
    }

    .blockscape-toolbar {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-md);
      padding: var(--space-sm) var(--space-lg);
      width: min(1180px, 100%);
      margin: 0 auto;
    }

    .blockscape-brand {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-lg);
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-right: var(--space-sm);
    }

    .blockscape-brand h1 {
      font: inherit;
      margin: 0;
    }

    .blockscape-toolbar__controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-sm);
      flex: 1 1 auto;
      min-width: 280px;
    }

    .blockscape-toolbar__controls .pf-v5-c-form-control {
      min-width: 11rem;
    }

    .blockscape-toolbar__controls .pf-v5-c-form-control.is-url {
      min-width: 14rem;
    }

    .blockscape-file {
      position: relative;
    }

    .blockscape-file input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .pf-v5-c-button {
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.4rem 0.95rem;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      line-height: 1;
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition), color var(--transition), box-shadow var(--transition);
      background: transparent;
      color: var(--blockscape-foreground);
    }

    .pf-v5-c-button:hover {
      box-shadow: 0 8px 18px -12px rgba(15, 23, 42, 0.4);
    }

    .pf-v5-c-button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
    }

    .pf-v5-c-button.pf-m-primary {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: #fff;
    }

    .pf-v5-c-button.pf-m-primary:hover {
      background: #1d4fd7;
      border-color: #1d4fd7;
    }

    .pf-v5-c-button.pf-m-secondary {
      background: var(--color-surface-muted);
      border-color: var(--color-border-strong);
      color: var(--blockscape-foreground);
    }

    .pf-v5-c-button.pf-m-secondary:hover {
      background: #e5e9f4;
    }

    .pf-v5-c-button.pf-m-tertiary {
      background: transparent;
      border-color: var(--color-border);
      color: var(--color-muted);
    }

    .pf-v5-c-button.pf-m-tertiary:hover {
      color: var(--blockscape-foreground);
      border-color: var(--color-border-strong);
      background: var(--color-surface-muted);
    }

    .pf-v5-c-button.pf-m-plain {
      border: none;
      padding: 0.35rem;
      color: var(--color-muted);
      border-radius: 50%;
    }

    .pf-v5-c-button.pf-m-plain:hover {
      background: var(--color-surface-muted);
      color: var(--blockscape-foreground);
      box-shadow: none;
    }

    .pf-v5-c-form-control {
      height: 2.5rem;
      padding: 0 0.85rem;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      font-family: inherit;
      font-size: var(--font-size-sm);
      color: inherit;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    .pf-v5-c-form-control::placeholder {
      color: var(--color-muted);
      opacity: 0.75;
    }

    .pf-v5-c-form-control:focus-visible {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .blockscape-legend {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: var(--font-size-xs);
      color: var(--blockscape-muted);
      font-weight: var(--font-weight-medium);
      flex-wrap: wrap;
    }

    .legend-entry {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      white-space: nowrap;
    }

    .legend-dot {
      width: 0.65rem;
      height: 0.65rem;
      border-radius: 50%;
      border: 1px solid var(--blockscape-border);
    }

    .legend-dot--dep {
      background: var(--color-primary-soft);
      border-color: var(--blockscape-dep);
    }

    .legend-dot--revdep {
      background: var(--color-danger-soft);
      border-color: var(--blockscape-revdep);
    }

    .legend-dot--reused {
      background: var(--color-warning-soft);
      border-color: var(--blockscape-reused);
    }

    .legend-dot--external {
      background: #edf1f7;
      border-color: var(--blockscape-external);
    }

    .pf-v5-c-page__main {
      flex: 1 1 auto;
    }

    .blockscape-content {
      display: flex;
      gap: var(--space-lg);
      width: min(1180px, calc(100% - 2 * var(--space-lg)));
      margin: 0 auto;
      padding: var(--space-lg) 0 var(--space-xl);
      align-items: flex-start;
    }

    .blockscape-sidebar {
      flex: 0 0 240px;
      background: var(--blockscape-surface);
      border: 1px solid var(--blockscape-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      box-shadow: var(--color-shadow);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .sidebar-heading {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--blockscape-muted);
    }

    .model-nav-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .model-nav-list li {
      margin: 0;
      padding: 0;
    }

    .model-nav-button {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2xs);
      border: 1px solid transparent;
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--color-text);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      padding: var(--space-sm);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition), color var(--transition);
    }

    .model-nav-button:hover,
    .model-nav-button:focus-visible {
      outline: none;
      border-color: var(--color-border);
      background: var(--color-surface-muted);
    }

    .model-nav-button.is-active {
      border-color: var(--color-primary);
      background: var(--color-primary-soft);
      color: var(--color-primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.1);
    }

    .model-nav-label {
      font-weight: var(--font-weight-semibold);
    }

    .model-nav-meta {
      font-size: var(--font-size-xs);
      color: var(--blockscape-muted);
    }

    .model-nav-empty {
      font-size: var(--font-size-xs);
      color: var(--blockscape-muted);
    }

    .model-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .model-actions .pf-v5-c-button {
      width: 100%;
    }

    .blockscape-main {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }

    .blockscape-json-panel,
    .blockscape-main-section {
      width: 100%;
      margin: 0;
    }

    .blockscape-json-panel {
      padding: 0;
      border: none;
      background: transparent;
      box-shadow: none;
    }

    .blockscape-json-panel details {
      background: var(--blockscape-surface);
      border: 1px solid var(--blockscape-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      box-shadow: var(--color-shadow);
    }

    details summary {
      list-style: none;
      cursor: pointer;
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details[open] summary {
      margin-bottom: var(--space-sm);
    }

    .blockscape-json-panel .muted {
      font-size: var(--font-size-xs);
      margin: 0.5rem 0 1rem 0;
    }

    .blockscape-json-controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-md);
      align-items: flex-start;
    }

    .blockscape-json-controls textarea {
      flex: 1 1 22rem;
      min-height: 12rem;
      font-family: var(--font-mono);
      font-size: var(--font-size-sm);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      padding: var(--space-sm) var(--space-md);
      background: var(--color-surface-muted);
      color: var(--blockscape-foreground);
      resize: vertical;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    .blockscape-json-controls textarea:focus-visible {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      background: var(--color-surface);
    }

    .blockscape-json-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      min-width: 12rem;
    }

    .blockscape-main-section {
      padding: 0 var(--space-lg) var(--space-xl);
    }

    .blockscape-abstract {
      font-size: var(--font-size-sm);
      color: var(--blockscape-muted);
      line-height: 1.5;
      padding: var(--space-md);
      background: var(--blockscape-surface-alt);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--blockscape-dep);
      margin-bottom: var(--space-lg);
      box-shadow: var(--color-shadow);
    }

    .category {
      margin: var(--space-lg) 0;
    }

    .cat-head {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }

    .cat-title {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--blockscape-muted);
    }

    .cat-count {
      font-size: var(--font-size-xs);
      color: var(--color-muted);
    }

    .grid {
      position: relative;
      display: grid;
      grid-auto-rows: var(--blockscape-tile);
      grid-template-columns: repeat(auto-fill, minmax(var(--blockscape-tile), 1fr));
      gap: var(--blockscape-gap);
      padding: var(--blockscape-gap) 0;
      border-top: 1px dashed var(--blockscape-border);
    }

    .tile {
      position: relative;
      background: var(--blockscape-surface);
      border: 1px solid var(--blockscape-border);
      border-radius: var(--blockscape-radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      cursor: grab;
      transition: box-shadow var(--transition), transform var(--transition), border-color var(--transition);
      box-shadow: var(--color-shadow);
    }

    .tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 30px -24px rgba(15, 23, 42, 0.55);
    }

    .tile:active {
      transform: translateY(1px);
    }

    .tile.dragging {
      opacity: 0.5;
      cursor: grabbing;
      transform: rotate(4deg);
    }

    .tile.drag-over {
      border-color: var(--blockscape-dep);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .grid.drag-active {
      background: var(--color-primary-soft);
    }

    .logo {
      width: 44px;
      height: 44px;
      object-fit: contain;
      opacity: .95;
    }

    .name {
      font-size: var(--font-size-xs);
      text-align: center;
      line-height: 1.15;
      padding: 0 var(--space-sm) var(--space-xs);
    }

    .badge {
      position: absolute;
      top: var(--space-sm);
      right: var(--space-sm);
      font-size: var(--font-size-xs);
      background: var(--color-warning-soft);
      color: var(--blockscape-reused);
      border: 1px solid var(--color-warning);
      border-radius: 999px;
      padding: 0.1rem 0.45rem;
      display: none;
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .tile.reused .badge {
      display: inline-block;
    }

    .tile.external {
      border-style: dashed;
      border-color: var(--color-external);
      color: var(--blockscape-muted);
      background: #f8fafc;
    }

    .tile.dep {
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      border-color: var(--blockscape-dep);
    }

    .tile.revdep {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
      border-color: var(--blockscape-revdep);
    }

    .tile.selected {
      outline: 3px solid rgba(15, 23, 42, 0.25);
      outline-offset: 2px;
    }

    .muted {
      color: var(--blockscape-muted);
    }

    .svg-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .item-preview {
      position: fixed;
      display: flex;
      flex-direction: column;
      width: min(420px, calc(100vw - 2 * var(--space-md)));
      max-height: 70vh;
      background: var(--blockscape-surface);
      border: 1px solid var(--blockscape-border);
      border-radius: var(--radius-md);
      box-shadow: var(--color-shadow);
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity var(--transition), transform var(--transition);
      z-index: 999;
    }

    .item-preview.is-visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .item-preview__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      border-bottom: 1px solid var(--color-border);
      background: var(--color-surface-muted);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
    }

    .item-preview__title {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1 1 auto;
    }

    .item-preview__close {
      border: none;
      background: transparent;
      color: var(--color-muted);
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
      border-radius: var(--radius-sm);
      padding: 0 var(--space-2xs);
    }

    .item-preview__close:hover,
    .item-preview__close:focus-visible {
      color: var(--blockscape-foreground);
      background: var(--color-surface-muted);
      outline: none;
    }

    .item-preview__body {
      flex: 1 1 auto;
      overflow: auto;
      padding: var(--space-sm);
      background: var(--blockscape-surface);
      font-size: var(--font-size-xs);
      line-height: 1.4;
    }

    .item-preview__frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .item-preview--has-frame .item-preview__body {
      padding: 0;
    }

    .item-preview__status {
      color: var(--color-muted);
    }

    @media (max-width: 1024px) {
      .blockscape-toolbar {
        padding: var(--space-sm) var(--space-md);
        gap: var(--space-sm);
      }

      .blockscape-content {
        flex-direction: column;
        gap: var(--space-md);
        width: calc(100% - 2 * var(--space-md));
        padding: var(--space-md) 0 var(--space-lg);
      }

      .blockscape-sidebar {
        width: 100%;
      }
    }

    @media (max-width: 720px) {
      .blockscape-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .blockscape-content {
        width: calc(100% - 2 * var(--space-sm));
        gap: var(--space-sm);
      }

      .blockscape-brand {
        justify-content: space-between;
        width: 100%;
      }

      .blockscape-toolbar__controls {
        width: 100%;
      }

      .blockscape-toolbar__controls .pf-v5-c-form-control,
      .blockscape-toolbar__controls .pf-v5-c-button {
        flex: 1 1 auto;
      }

      .blockscape-legend {
        width: 100%;
        justify-content: flex-start;
        margin-left: 0;
      }

      .blockscape-json-actions {
        width: 100%;
        flex-direction: row;
        justify-content: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="pf-v5-c-page">
    <header class="pf-v5-c-page__header">
      <div class="pf-v5-c-masthead pf-m-display-inline blockscape-masthead">
        <div class="pf-v5-c-masthead__content">
          <div class="blockscape-toolbar">
            <div class="blockscape-brand">
              <h1>Blockscape</h1>
              <a href="https://github.com/pwright/blockscape" target="_blank"
                class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                </svg>
              </a>
            </div>
            <div class="blockscape-toolbar__controls">
              <label class="sr-only" for="search">Search tiles</label>
              <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…" />
              <label class="sr-only" for="urlInput">Load JSON from URL</label>
              <input id="urlInput" class="pf-v5-c-form-control is-url" type="text"
                placeholder="Load JSON from URL…" />
              <button id="loadUrl" class="pf-v5-c-button pf-m-secondary" type="button">Load URL</button>
              <label class="pf-v5-c-button pf-m-secondary blockscape-file" role="button">
                <span>Add JSON files</span>
                <input id="file" type="file" accept=".json,.txt" multiple />
              </label>
            </div>
            <div class="blockscape-legend" role="presentation">
              <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
              <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
              <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
              <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="pf-v5-c-page__main">
      <div class="blockscape-content">
        <aside class="blockscape-sidebar" aria-label="Models">
          <div class="sidebar-heading">Models</div>
          <ul id="modelList" class="model-nav-list"></ul>
          <div class="model-actions">
            <button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button"
              title="Remove selected model">Remove active</button>
            <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>
          </div>
        </aside>
        <div class="blockscape-main">
          <section class="pf-v5-c-page__main-section blockscape-json-panel">
            <details>
              <summary>Paste / edit JSON for the <b>active</b> model (schema below)</summary>
              <div class="muted">
                Schema: <code>{ categories:[{id, title, items:[{id,name,logo?,external?,color?,deps:[] }]}],
                  links?:[{from,to}] }</code><br />
                You can paste multiple objects separated by <code>---</code> to append several models. A single object
                replaces only when you click “Replace active with JSON”.
              </div>
              <div class="blockscape-json-controls">
                <textarea id="jsonBox" class="pf-v5-c-form-control"
                  aria-label="JSON editor for the active model"></textarea>
                <div class="blockscape-json-actions">
                  <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button>
                  <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                    JSON</button>
                </div>
              </div>
            </details>
          </section>

          <section class="pf-v5-c-page__main-section blockscape-main-section">
            <div id="app" aria-live="polite"></div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <template id="seed">
    {
      "abstract": "Blockscape is a tool for visualizing value chains and dependency relationships. It can be used to visualize the value chain of a project, a product, or a service. It can also be used to visualize the dependencies between different components of a project.<br>The tool enables users to understand dependencies, relationships, and value chains within a domain.<br>You can choose other data from left hand menu.<br>Or load data from a URL.<br>Select an item to see its dependencies.",
      "categories": [
        {
          "id": "communication",
          "title": "Communication Effects",
          "items": [
            {
              "id": "glance_comprehension",
              "name": "Glanceable Landscape",
              "deps": [
                "value_visibility_axis",
                "legend_minimal"
              ]
            },
            {
              "id": "component_values",
              "name": "Component Values",
              "deps": [
                "layout_engine",
                "model_components"
              ]
            },
            {
              "id": "review_alignment",
              "name": "Shared Understanding",
              "deps": [
                "glance_comprehension",
                "component_values"
              ]
            }
          ]
        },
        {
          "id": "inputs",
          "title": "Inputs",
          "items": [
            {
              "id": "domain_prompt",
              "name": "Domain Prompt",
              "deps": []
            },
            {
              "id": "domain_json",
              "name": "Domain JSON",
              "deps": []
            }
          ]
        },
        {
          "id": "modeling",
          "title": "Modeling",
          "items": [
            {
              "id": "model_components",
              "name": "Components and Categories",
              "deps": [
                "domain_json"
              ]
            },
            {
              "id": "model_dependencies",
              "name": "Dependencies",
              "deps": [
                "model_components"
              ]
            }
          ]
        },
        {
          "id": "rendering",
          "title": "Rendering",
          "items": [
            {
              "id": "layout_engine",
              "name": "Layout Engine",
              "deps": [
                "model_components",
                "model_dependencies"
              ]
            },
            {
              "id": "value_visibility_axis",
              "name": "Vertical Position = Visible Value",
              "deps": [
                "layout_engine"
              ]
            },
            {
              "id": "evolution_axis",
              "name": "Horizontal Evolution (Optional)",
              "deps": [
                "layout_engine"
              ]
            }
          ]
        },
        {
          "id": "outputs",
          "title": "Outputs",
          "items": [
            {
              "id": "guideframe",
              "name": "Video creation",
              "deps": [
 
              ]
            },
            {
              "id": "website",
              "name": "Website",
              "deps": [
                "layout_engine"
              ]
            }

          ]
        }
      ]
    }
  </template>

  <svg id="overlay" class="svg-layer"></svg>

  <div id="itemPreview" class="item-preview" hidden aria-hidden="true">
    <div class="item-preview__header">
      <span class="item-preview__title">Preview</span>
      <button type="button" class="item-preview__close" aria-label="Close preview">&times;</button>
    </div>
    <div class="item-preview__body">
      <div class="item-preview__status">Right-click a tile to see related notes.</div>
    </div>
  </div>

  <script>
    console.log("[Blockscape] init");

    const jsonBox = document.getElementById('jsonBox');
    const app = document.getElementById('app');
    const overlay = document.getElementById('overlay');
    const modelList = document.getElementById('modelList');
    const preview = document.getElementById('itemPreview');
    const previewTitle = preview.querySelector('.item-preview__title');
    const previewBody = preview.querySelector('.item-preview__body');
    const previewClose = preview.querySelector('.item-preview__close');

    // Show the seed in the editor initially.
    jsonBox.value = document.getElementById('seed').innerHTML.trim();

    // ===== State =====
    /** @type {{id:string,title:string,data:any}[]} */
    let models = [];
    let activeIndex = -1;

    let model = null;           // parsed result of active model: { m, fwd, rev, reusedLocal, seen }
    let index = new Map();      // id -> {el, catId, rect}
    let selection = null;
    let previewRequestId = 0;
    let previewAnchor = { x: 0, y: 0 };

    // ===== Utilities =====
    function uid() { return Math.random().toString(36).slice(2, 10); }

    // --- NEW: letter → color mapping and helpers ---
    // Letter → color mapping (tailwind-ish palette). G => green.
    const LETTER_COLOR_MAP = {
      A: '#ef4444', B: '#3b82f6', C: '#06b6d4', D: '#a855f7',
      E: '#f59e0b', F: '#f97316', G: '#22c55e', H: '#84cc16',
      I: '#10b981', J: '#14b8a6', K: '#0ea5e9', L: '#60a5fa',
      M: '#8b5cf6', N: '#d946ef', O: '#f43f5e', P: '#e11d48',
      Q: '#dc2626', R: '#f59e0b', S: '#eab308', T: '#a3e635',
      U: '#22d3ee', V: '#38bdf8', W: '#818cf8', X: '#a78bfa',
      Y: '#f472b6', Z: '#fb7185'
    };

    // Prefer explicit item.color (if present), else map by first letter.
    function getBadgeColor(text, explicit) {
      if (explicit && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(explicit)) return explicit;
      const ch = (text || '?').charAt(0).toUpperCase();
      return LETTER_COLOR_MAP[ch] || '#9ca3af'; // fallback gray
    }

    // Compute readable letter color (black/white) against bg
    function idealTextColor(bgHex) {
      const hex = bgHex.replace('#', '');
      const expanded = hex.length === 3 ? hex.split('').map(c=>c+c).join('') : hex;
      const bigint = parseInt(expanded, 16);
      const r = (bigint >> 16) & 255, g = (bigint >> 8) & 255, b = bigint & 255;
      // luminance (sRGB)
      const L = 0.2126*Math.pow(r/255,2.2) + 0.7152*Math.pow(g/255,2.2) + 0.0722*Math.pow(b/255,2.2);
      return L > 0.35 ? '#111111' : '#ffffff';
    }

    function setActive(i) {
      hidePreview();
      if (i < 0 || i >= models.length) {
        console.warn("[Blockscape] setActive called with out-of-range index:", i);
        return;
      }
      activeIndex = i;
      console.log("[Blockscape] active model:", models[i].title, "(index", i + " )");
      renderModelList();
      loadActiveIntoEditor();
      rebuildFromActive();
    }

    function renderModelList() {
      modelList.innerHTML = "";
      if (!models.length) {
        const empty = document.createElement('li');
        empty.className = 'model-nav-empty';
        empty.textContent = 'No models loaded yet.';
        modelList.appendChild(empty);
        return;
      }

      models.forEach((m, i) => {
        const li = document.createElement('li');
        li.className = 'model-nav-item';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'model-nav-button' + (i === activeIndex ? ' is-active' : '');
        btn.dataset.index = String(i);
        btn.setAttribute('aria-current', i === activeIndex ? 'true' : 'false');

        const label = document.createElement('span');
        label.className = 'model-nav-label';
        label.textContent = `${i + 1}. ${m.title}`;

        const categories = Array.isArray(m.data?.categories) ? m.data.categories : [];
        const itemsCount = categories.reduce((sum, cat) => sum + ((cat.items || []).length), 0);

        const meta = document.createElement('span');
        meta.className = 'model-nav-meta';
        meta.textContent = `${categories.length} cat · ${itemsCount} items`;

        btn.appendChild(label);
        btn.appendChild(meta);
        li.appendChild(btn);
        modelList.appendChild(li);
      });
    }

    function loadActiveIntoEditor() {
      if (activeIndex < 0) { jsonBox.value = ""; return; }
      jsonBox.value = JSON.stringify(models[activeIndex].data, null, 2);
    }

    function tryParseJson(txt) { try { return JSON.parse(txt); } catch { return null; } }

    // Accept 1) object, 2) array-of-objects, 3) '---' separated objects
    function normalizeToModelsFromText(txt, titleBase = "Pasted") {
      const trimmed = (txt || "").trim();
      if (!trimmed) return [];
      const parsed = tryParseJson(trimmed);
      if (parsed) return (Array.isArray(parsed) ? parsed : [parsed]).map((o, idx) => ({
        id: uid(),
        title: `${titleBase} #${idx + 1}`,
        data: o
      }));
      const parts = trimmed.split(/^\s*---\s*$/m).map(s => s.trim()).filter(Boolean);
      return parts.map((p, i) => ({
        id: uid(),
        title: `${titleBase} #${i + 1}`,
        data: JSON.parse(p)
      }));
    }

    function parse(mObj) {
      console.log("[Blockscape] parsing model; categories=", (mObj?.categories || []).length);
      const fwd = new Map();
      const rev = new Map();
      const seen = new Set();

      (mObj.categories || []).forEach(c => (c.items || []).forEach(it => {
        seen.add(it.id);
        const deps = new Set(it.deps || []);
        (mObj.links || []).forEach(l => { if (l.from === it.id) deps.add(l.to); });
        fwd.set(it.id, deps);
        deps.forEach(d => {
          if (!rev.has(d)) rev.set(d, new Set());
          rev.get(d).add(it.id);
        });
      }));

      const reusedLocal = new Set();
      rev.forEach((dependents, node) => { if ((dependents?.size || 0) >= 2) reusedLocal.add(node); });
      return { m: mObj, fwd, rev, reusedLocal, seen };
    }

    // --- MODIFIED: color-aware letter image ---
    function generateLetterImage(text, explicitColor) {
      console.log("[Blockscape] generateLetterImage for:", text);
      const canvas = document.createElement('canvas');
      const size = 44;
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext('2d');

      const letter = (text || '?').charAt(0).toUpperCase();
      const bg = getBadgeColor(text, explicitColor);
      const fg = idealTextColor(bg);

      // Circle
      ctx.fillStyle = bg;
      ctx.beginPath();
      ctx.arc(size/2, size/2, size/2 - 2, 0, 2*Math.PI);
      ctx.fill();

      // Subtle ring
      ctx.strokeStyle = 'rgba(0,0,0,0.15)';
      ctx.lineWidth = 1;
      ctx.stroke();

      // Letter
      ctx.fillStyle = fg;
      ctx.font = `bold ${size * 0.5}px system-ui, -apple-system, sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(letter, size/2, size/2);

      return canvas.toDataURL('image/png');
    }

    // ===== Render =====
    function render() {
      if (!model) return;
      console.log("[Blockscape] rendering categories=", model.m.categories.length);
      console.log("[Blockscape] model.m has abstract?", !!model.m.abstract, "- value:", model.m.abstract ? model.m.abstract.substring(0, 50) + "..." : "none");
      app.innerHTML = "";
      index.clear();

      overlay.setAttribute("width", window.innerWidth);
      overlay.setAttribute("height", window.innerHeight);

      // Add abstract if present
      if (model.m.abstract) {
        console.log("[Blockscape] Creating abstract div");
        const abstractDiv = document.createElement('div');
        abstractDiv.className = 'blockscape-abstract';
        abstractDiv.innerHTML = model.m.abstract;
        app.appendChild(abstractDiv);
        console.log("[Blockscape] Abstract div appended to DOM");
      } else {
        console.log("[Blockscape] No abstract found in model.m");
      }

      model.m.categories.forEach(cat => {
        const section = document.createElement('section');
        section.className = 'category';
        section.dataset.cat = cat.id;

        const head = document.createElement('div');
        head.className = 'cat-head';
        head.innerHTML = `<div class="cat-title">${escapeHtml(cat.title || cat.id)}</div>
                          <div class="muted cat-count">${(cat.items || []).length} items</div>`;
        section.appendChild(head);

        const grid = document.createElement('div');
        grid.className = 'grid';
        section.appendChild(grid);

        (cat.items || []).forEach(it => {
          const tile = document.createElement('div');
          tile.className = 'tile' + (it.external ? ' external' : '');
          tile.tabIndex = 0;
          tile.dataset.id = it.id;

          const img = document.createElement('img');
          img.className = 'logo';
          if (it.logo) {
            img.src = it.logo; img.alt = it.name || it.id;
          } else {
            img.alt = "";
            img.style.opacity = 1; // colored letter icon is the intended visual
            img.src = generateLetterImage(it.name || it.id, it.color); // supports optional per-item color
          }

          const nm = document.createElement('div');
          nm.className = 'name';
          nm.textContent = it.name || it.id;

          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = 'reused';

          tile.appendChild(img);
          tile.appendChild(nm);
          tile.appendChild(badge);
          grid.appendChild(tile);

          index.set(it.id, { el: tile, catId: cat.id, rect: null });
        });

        app.appendChild(section);
      });

      model.reusedLocal.forEach(id => {
        const hit = index.get(id);
        if (hit) {
          hit.el.classList.add('reused');
          hit.el.querySelector('.badge').style.display = 'inline-block';
        }
      });

      wireEvents();
      reflowRects();
      drawLinks();
    }

    function wireEvents() {
      app.querySelectorAll('.tile').forEach(t => {
        t.addEventListener('click', (event) => {
          if (typeof event.button === 'number' && event.button !== 0) return;
          hidePreview();
          const id = t.dataset.id;
          console.log("[Blockscape] click", id);
          if (selection === id) { clearSelection(); return; }
          select(id);
        });
        t.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); t.click(); }
        });
        t.draggable = true;
        t.addEventListener('dragstart', handleDragStart);
        t.addEventListener('dragend', handleDragEnd);
      });

      app.querySelectorAll('.grid').forEach(grid => {
        grid.addEventListener('dragover', handleDragOver);
        grid.addEventListener('drop', handleDrop);
        grid.addEventListener('dragenter', handleDragEnter);
        grid.addEventListener('dragleave', handleDragLeave);
      });

      window.addEventListener('resize', () => { reflowRects(); drawLinks(); });
      document.getElementById('clear').onclick = () => clearSelection();
    }

    function reflowRects() { index.forEach((v) => { v.rect = v.el.getBoundingClientRect(); }); }

    function select(id) {
      selection = id;
      clearStyles();
      const deps = Array.from(model.fwd.get(id) || []);
      const revs = Array.from(model.rev.get(id) || []);
      console.log("[Blockscape] selecting id=", id, "deps=", deps, "revs=", revs);
      const sel = index.get(id); if (sel) sel.el.classList.add('selected');
      deps.forEach(d => { const hit = index.get(d); if (hit) hit.el.classList.add('dep'); });
      revs.forEach(r => { const hit = index.get(r); if (hit) hit.el.classList.add('revdep'); });
      drawLinks();
    }

    function clearSelection() { selection = null; clearStyles(); drawLinks(); }
    function clearStyles() { app.querySelectorAll('.tile').forEach(t => t.classList.remove('dep', 'revdep', 'selected')); }

    function drawLinks() {
      while (overlay.firstChild) overlay.removeChild(overlay.firstChild);
      if (!selection) return;

      const fromRect = index.get(selection)?.rect;
      if (!fromRect) return;

      const toList = new Set([...(model.fwd.get(selection) || []), ...(model.rev.get(selection) || [])]);
      toList.forEach(to => {
        const target = index.get(to);
        if (!target || !target.rect) return;
        const a = center(fromRect);
        const b = center(target.rect);
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const c1x = (a.x + b.x) / 2, c1y = a.y;
        const c2x = (a.x + b.x) / 2, c2y = b.y;
        const isDep = (model.fwd.get(selection) || new Set()).has(to);
        path.setAttribute("d", `M ${a.x},${a.y} C ${c1x},${c1y} ${c2x},${c2y} ${b.x},${b.y}`);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", isDep ? "var(--blockscape-dep)" : "var(--blockscape-revdep)");
        path.setAttribute("stroke-opacity", "0.45");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("vector-effect", "non-scaling-stroke");
        overlay.appendChild(path);
      });
    }

    function center(r) { return { x: r.left + r.width / 2, y: r.top + r.height / 2 }; }
    function escapeHtml(s) { return s.replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[m])); }

    function hidePreview() {
      if (!preview) return;
      preview.classList.remove('is-visible', 'item-preview--has-frame');
      preview.setAttribute('aria-hidden', 'true');
      preview.hidden = true;
    }

    function showPreviewAt(x, y) {
      if (!preview) return;
      previewAnchor = { x, y };
      preview.hidden = false;
      preview.setAttribute('aria-hidden', 'false');
      preview.classList.add('is-visible');
      positionPreview(x, y);
    }

    function positionPreview(x, y) {
      if (!preview) return;
      const margin = 12;
      preview.style.left = `${x + margin}px`;
      preview.style.top = `${y + margin}px`;
      const rect = preview.getBoundingClientRect();
      let left = rect.left;
      let top = rect.top;
      if (rect.right > window.innerWidth - margin) {
        left = Math.max(margin, window.innerWidth - rect.width - margin);
      }
      if (rect.bottom > window.innerHeight - margin) {
        top = Math.max(margin, window.innerHeight - rect.height - margin);
      }
      preview.style.left = `${left}px`;
      preview.style.top = `${top}px`;
    }

    async function handleTileContextMenu(event, tile) {
      if (!preview) return;
      event.stopPropagation();
      event.preventDefault();
      const id = tile.dataset.id;
      const displayName = tile.querySelector('.name')?.textContent || id || 'Preview';
      const filename = id ? `${id}.html` : '';
      const requestId = ++previewRequestId;

      previewTitle.textContent = displayName;
      previewBody.innerHTML = '<div class="item-preview__status">Loading…</div>';
      preview.classList.remove('item-preview--has-frame');
      showPreviewAt(event.clientX, event.clientY);

      if (!filename) {
        previewBody.innerHTML = '<div class="item-preview__status">Preview unavailable for this item.</div>';
        positionPreview(previewAnchor.x, previewAnchor.y);
        return;
      }

      try {
        const response = await fetch(filename, { cache: 'no-cache' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const html = await response.text();
        if (requestId !== previewRequestId) return;
        const trimmed = html.trim();
        if (!trimmed) {
          previewBody.innerHTML = `<div class="item-preview__status">No content in <code>${escapeHtml(filename)}</code>.</div>`;
          positionPreview(previewAnchor.x, previewAnchor.y);
          return;
        }
        const frame = document.createElement('iframe');
        frame.className = 'item-preview__frame';
        frame.title = `${displayName} details`;
        frame.srcdoc = html;
        previewBody.innerHTML = '';
        previewBody.appendChild(frame);
        preview.classList.add('item-preview--has-frame');
        positionPreview(previewAnchor.x, previewAnchor.y);
      } catch (error) {
        if (requestId !== previewRequestId) return;
        previewBody.innerHTML = `<div class="item-preview__status">No preview available for <strong>${escapeHtml(displayName)}</strong>.</div>`;
        console.warn(`[Blockscape] preview unavailable for ${filename}`, error);
        positionPreview(previewAnchor.x, previewAnchor.y);
      }
    }

    if (previewClose) {
      previewClose.addEventListener('click', hidePreview);
    }

    if (app) {
      app.addEventListener('contextmenu', (event) => {
        const tile = event.target.closest('.tile');
        if (!tile || !app.contains(tile)) return;
        handleTileContextMenu(event, tile);
      });
    }

    document.addEventListener('click', (event) => {
      if (typeof event.button === 'number' && event.button !== 0) return;
      if (!preview || preview.hidden) return;
      if (preview.contains(event.target)) return;
      hidePreview();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && preview && !preview.hidden) {
        hidePreview();
      }
    });

    window.addEventListener('resize', () => {
      if (!preview || preview.hidden) return;
      positionPreview(previewAnchor.x, previewAnchor.y);
    });

    window.addEventListener('scroll', () => {
      if (!preview || preview.hidden) return;
      hidePreview();
    }, true);

    // ===== Drag and drop reorder (per model) =====
    let draggedItemId = null;
    let draggedCategoryId = null;

    function handleDragStart(e) {
      hidePreview();
      draggedItemId = e.target.dataset.id;
      draggedCategoryId = e.target.closest('.category').dataset.cat;

      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', JSON.stringify({
        itemId: draggedItemId,
        categoryId: draggedCategoryId
      }));

      const category = e.target.closest('.category');
      const grid = category.querySelector('.grid');
      grid.classList.add('drag-active');

      console.log("[Blockscape] drag start", draggedItemId, "from", draggedCategoryId);
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      app.querySelectorAll('.grid').forEach(grid => grid.classList.remove('drag-active'));
      app.querySelectorAll('.tile').forEach(tile => tile.classList.remove('drag-over'));
      draggedItemId = null;
      draggedCategoryId = null;
    }

    function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
    function handleDragEnter(e) {
      e.preventDefault();
      const grid = e.target.closest('.grid');
      if (grid) grid.classList.add('drag-active');
    }
    function handleDragLeave(e) {
      const grid = e.target.closest('.grid');
      if (grid && !grid.contains(e.relatedTarget)) grid.classList.remove('drag-active');
    }

    function handleDrop(e) {
      e.preventDefault();
      const targetGrid = e.target.closest('.grid');
      const targetCategory = targetGrid.closest('.category');
      const targetCategoryId = targetCategory.dataset.cat;

      if (!draggedItemId || !targetCategoryId) return;
      if (draggedCategoryId !== targetCategoryId) {
        console.log("[Blockscape] drop rejected - different category");
        return;
      }

      const tiles = Array.from(targetGrid.querySelectorAll('.tile'));
      const targetTile = tiles.find(tile => {
        const rect = tile.getBoundingClientRect();
        return e.clientY < rect.top + rect.height / 2;
      });

      reorderItem(draggedItemId, targetTile ? targetTile.dataset.id : null, targetCategoryId);
      render();
      console.log("[Blockscape] drop completed", draggedItemId, "in", targetCategoryId);
    }

    function reorderItem(itemId, targetItemId, categoryId) {
      if (activeIndex < 0) return;
      const mobj = models[activeIndex].data;
      const category = (mobj.categories || []).find(cat => cat.id === categoryId);
      if (!category) return;

      const itemIndex = (category.items || []).findIndex(item => item.id === itemId);
      if (itemIndex === -1) return;

      const [movedItem] = category.items.splice(itemIndex, 1);
      if (targetItemId) {
        const targetIndex = category.items.findIndex(item => item.id === targetItemId);
        if (targetIndex !== -1) category.items.splice(targetIndex, 0, movedItem);
        else category.items.push(movedItem);
      } else {
        category.items.push(movedItem);
      }
      // keep editor in sync
      loadActiveIntoEditor();
      rebuildFromActive();
    }

    // ===== Controls =====

    // Append models from textarea
    document.getElementById('appendFromBox').onclick = () => {
      try {
        const appended = normalizeToModelsFromText(jsonBox.value, "Pasted");
        if (!appended.length) { alert("No valid JSON found to append."); return; }
        console.log("[Blockscape] appending", appended.length, "model(s)");
        models.push(...appended);
        if (activeIndex === -1) setActive(0); else { renderModelList(); }
      } catch (e) {
        console.error("[Blockscape] append error:", e);
        alert("Append error (see console).");
      }
    };

    // Replace active model data with JSON from textarea
    document.getElementById('replaceActive').onclick = () => {
      if (activeIndex < 0) { alert("No active model selected."); return; }
      try {
        const obj = JSON.parse(jsonBox.value);
        models[activeIndex].data = obj;
        console.log("[Blockscape] replaced active model:", models[activeIndex].title);
        rebuildFromActive();
      } catch (e) {
        console.error("[Blockscape] replace error:", e);
        alert("JSON parse error (see console).");
      }
    };

    // Load files: each text may be single object, array, or --- separated
    document.getElementById('file').onchange = async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      try {
        console.log("[Blockscape] reading", files.length, "file(s)");
        for (const f of files) {
          const txt = await f.text();
          const entries = normalizeToModelsFromText(txt, f.name.replace(/\.[^.]+$/, '') || "File");
          if (!entries.length) {
            console.warn("[Blockscape] no models in file:", f.name);
            continue;
          }
          // Ensure file-derived entries use filename as title base
          models.push(...entries.map((en, i) => ({ ...en, title: entries.length > 1 ? `${f.name} #${i + 1}` : f.name })));
        }
        if (activeIndex === -1 && models.length) setActive(0);
        else renderModelList();
      } catch (err) {
        console.error("[Blockscape] file load error:", err);
        alert("File load error (see console).");
      } finally {
        e.target.value = ""; // allow re-selecting the same files
      }
    };

    // Switch active model from sidebar
    modelList.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-index]');
      if (!button) return;
      const i = parseInt(button.dataset.index, 10);
      if (!Number.isInteger(i)) return;
      setActive(i);
    });

    // Remove selected model
    document.getElementById('removeModel').onclick = () => {
      if (activeIndex < 0) return;
      console.log("[Blockscape] removing model:", models[activeIndex].title);
      models.splice(activeIndex, 1);
      if (!models.length) {
        activeIndex = -1;
        model = null;
        app.innerHTML = "";
        overlay.innerHTML = "";
        jsonBox.value = "";
        renderModelList();
        return;
      }
      const next = Math.min(activeIndex, models.length - 1);
      setActive(next);
    };

    // Search filter
    document.getElementById('search').addEventListener('input', (e) => {
      const q = e.target.value.trim().toLowerCase();
      console.log("[Blockscape] search:", q);
      app.querySelectorAll('.tile').forEach(t => {
        const name = t.querySelector('.name').textContent.toLowerCase();
        t.style.opacity = (!q || name.includes(q)) ? 1 : .2;
      });
    });

    // Load from URL
    document.getElementById('loadUrl').addEventListener('click', async () => {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert("Please enter a URL");
        return;
      }
      await loadFromUrl(url);
      document.getElementById('urlInput').value = ''; // Clear input after successful load
    });

    // Allow Enter key in URL input
    document.getElementById('urlInput').addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('loadUrl').click();
      }
    });

    // Helpers
    function rebuildFromActive() {
      if (activeIndex < 0) return;
      try {
        const parsed = parse(models[activeIndex].data);
        model = parsed;
        render();
      } catch (e) {
        console.error("[Blockscape] rebuild error (active model likely malformed):", e);
        alert("Active model parse/render error (see console).");
      }
    }

    // Load JSON files from same directory (for static hosting)
    async function loadJsonFiles() {
      const jsonFiles = ['NFR.json', 'ISO-IEC-25010.json', 'SEII-QAW.json'];
      
      for (const filename of jsonFiles) {
        try {
          const response = await fetch(filename);
          if (response.ok) {
            const data = await response.json();
            models.push({ 
              id: uid(), 
              title: filename.replace('.json', ''), 
              data: data 
            });
            console.log("[Blockscape] loaded", filename);
          }
        } catch (error) {
          console.log("[Blockscape] could not load", filename, "- this is normal for file:// protocol");
        }
      }
    }

    // Load JSON from custom URL
    async function loadFromUrl(url) {
      try {
        console.log("[Blockscape] loading from URL:", url);
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        const filename = url.split('/').pop().replace('.json', '') || 'URL Model';
        models.push({ 
          id: uid(), 
          title: filename, 
          data: data 
        });
        console.log("[Blockscape] loaded from URL:", filename);
        renderModelList();
        if (activeIndex === -1) setActive(0);
        return true;
      } catch (error) {
        console.error("[Blockscape] URL load error:", error);
        alert(`Failed to load JSON from URL: ${error.message}`);
        return false;
      }
    }

    // Bootstrap with Blockscape
    (async function bootstrap() {
      const seedObj = JSON.parse(document.getElementById('seed').innerHTML.trim());
      
      models.push({ id: uid(), title: "Blockscape", data: seedObj });
      
      // Try to load JSON files from same directory
      await loadJsonFiles();
      
      setActive(0);
    })();
  </script>
</body>

</html>
