var Blockscape=function(){"use strict";var vu=Object.defineProperty;var wu=(Ln,xt,ni)=>xt in Ln?vu(Ln,xt,{enumerable:!0,configurable:!0,writable:!0,value:ni}):Ln[xt]=ni;var ti=(Ln,xt,ni)=>wu(Ln,typeof xt!="symbol"?xt+"":xt,ni);var Ln=typeof document<"u"?document.currentScript:null;function xt(){}function ni(r){return r()}function dr(){return Object.create(null)}function qi(r){r.forEach(ni)}function ur(r){return typeof r=="function"}function So(r,l){return r!=r?l==l:r!==l||r&&typeof r=="object"||typeof r=="function"}function Ys(r){return Object.keys(r).length===0}const Xs=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function _(r,l){r.appendChild(l)}function Et(r,l,p){r.insertBefore(l,p||null)}function bt(r){r.parentNode&&r.parentNode.removeChild(r)}function U(r){return document.createElement(r)}function pr(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function ia(r){return document.createTextNode(r)}function ce(){return ia(" ")}function ii(r,l,p,C){return r.addEventListener(l,p,C),()=>r.removeEventListener(l,p,C)}function Zs(r){return function(l){return l.preventDefault(),r.call(this,l)}}function v(r,l,p){p==null?r.removeAttribute(l):r.getAttribute(l)!==p&&r.setAttribute(l,p)}function Qs(r){let l;return{p(...p){l=p,l.forEach(C=>r.push(C))},r(){l.forEach(p=>r.splice(r.indexOf(p),1))}}}function el(r){return Array.from(r.childNodes)}function tl(r,l){l=""+l,r.data!==l&&(r.data=l)}function oi(r,l){r.value=l??""}class nl{constructor(l=!1){ti(this,"is_svg",!1);ti(this,"e");ti(this,"n");ti(this,"t");ti(this,"a");this.is_svg=l,this.e=this.n=null}c(l){this.h(l)}m(l,p,C=null){this.e||(this.is_svg?this.e=pr(p.nodeName):this.e=U(p.nodeType===11?"TEMPLATE":p.nodeName),this.t=p.tagName!=="TEMPLATE"?p:p.content,this.c(l)),this.i(C)}h(l){this.e.innerHTML=l,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(l){for(let p=0;p<this.n.length;p+=1)Et(this.t,this.n[p],l)}p(l){this.d(),this.h(l),this.i(this.a)}d(){this.n.forEach(bt)}}let Gi;function Ki(r){Gi=r}function il(){if(!Gi)throw new Error("Function called outside component initialization");return Gi}function ol(r){il().$$.on_mount.push(r)}const hi=[],fr=[];let gi=[];const mr=[],al=Promise.resolve();let oa=!1;function rl(){oa||(oa=!0,al.then(hr))}function aa(r){gi.push(r)}const ra=new Set;let bi=0;function hr(){if(bi!==0)return;const r=Gi;do{try{for(;bi<hi.length;){const l=hi[bi];bi++,Ki(l),sl(l.$$)}}catch(l){throw hi.length=0,bi=0,l}for(Ki(null),hi.length=0,bi=0;fr.length;)fr.pop()();for(let l=0;l<gi.length;l+=1){const p=gi[l];ra.has(p)||(ra.add(p),p())}gi.length=0}while(hi.length);for(;mr.length;)mr.pop()();oa=!1,ra.clear(),Ki(r)}function sl(r){if(r.fragment!==null){r.update(),qi(r.before_update);const l=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,l),r.after_update.forEach(aa)}}function ll(r){const l=[],p=[];gi.forEach(C=>r.indexOf(C)===-1?l.push(C):p.push(C)),p.forEach(C=>C()),gi=l}const Io=new Set;let cl;function ko(r,l){r&&r.i&&(Io.delete(r),r.i(l))}function sa(r,l,p,C){if(r&&r.o){if(Io.has(r))return;Io.add(r),cl.c.push(()=>{Io.delete(r)}),r.o(l)}}function la(r){r&&r.c()}function _o(r,l,p){const{fragment:C,after_update:S}=r.$$;C&&C.m(l,p),aa(()=>{const F=r.$$.on_mount.map(ni).filter(ur);r.$$.on_destroy?r.$$.on_destroy.push(...F):qi(F),r.$$.on_mount=[]}),S.forEach(aa)}function Co(r,l){const p=r.$$;p.fragment!==null&&(ll(p.after_update),qi(p.on_destroy),p.fragment&&p.fragment.d(l),p.on_destroy=p.fragment=null,p.ctx=[])}function dl(r,l){r.$$.dirty[0]===-1&&(hi.push(r),rl(),r.$$.dirty.fill(0)),r.$$.dirty[l/31|0]|=1<<l%31}function xo(r,l,p,C,S,F,Q=null,Y=[-1]){const ne=Gi;Ki(r);const k=r.$$={fragment:null,ctx:[],props:F,update:xt,not_equal:S,bound:dr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(ne?ne.$$.context:[])),callbacks:dr(),dirty:Y,skip_bound:!1,root:l.target||ne.$$.root};Q&&Q(k.root);let se=!1;if(k.ctx=p?p(r,l.props||{},(R,be,...Se)=>{const nt=Se.length?Se[0]:be;return k.ctx&&S(k.ctx[R],k.ctx[R]=nt)&&(!k.skip_bound&&k.bound[R]&&k.bound[R](nt),se&&dl(r,R)),be}):[],k.update(),se=!0,qi(k.before_update),k.fragment=C?C(k.ctx):!1,l.target){if(l.hydrate){const R=el(l.target);k.fragment&&k.fragment.l(R),R.forEach(bt)}else k.fragment&&k.fragment.c();l.intro&&ko(r.$$.fragment),_o(r,l.target,l.anchor),hr()}Ki(ne)}class Ao{constructor(){ti(this,"$$");ti(this,"$$set")}$destroy(){Co(this,1),this.$destroy=xt}$on(l,p){if(!ur(p))return xt;const C=this.$$.callbacks[l]||(this.$$.callbacks[l]=[]);return C.push(p),()=>{const S=C.indexOf(p);S!==-1&&C.splice(S,1)}}$set(l){this.$$set&&!Ys(l)&&(this.$$.skip_bound=!0,this.$$set(l),this.$$.skip_bound=!1)}}const ul="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(ul);const gr="blockscape:apicurioConfig",ca="http://localhost:8080/apis/registry/v3",To="bs",br="-series",da=!1,ua=!1;function pl({models:r,getActiveIndex:l,setActive:p,ensureModelMetadata:C,ensureSeriesId:S,getModelId:F,getSeriesId:Q,getModelTitle:Y,computeJsonFingerprint:ne,uid:k}){let se=null,R=null,be=null,Se=null,nt=null,qe=null,Ge=null,Ae=null,G=null,q=null;const ye=new Set,M={baseUrl:ca,groupId:To,authToken:"",enabled:da,useSemver:ua},Te=new Map,Ie=new Map;function pe(u){return(u||"").toString().trim().replace(/\/+$/,"")}function Be(u){return`${(u||"").toString().trim()||To}${br}`}function fe(){return!!(M.baseUrl&&M.groupId)}function ve(){return M.enabled!==!1}function Oe(){ye.forEach(u=>{try{u(ve())}catch(h){console.warn("[Blockscape] failed to run Apicurio enabled listener",h)}})}function P(u){return typeof u=="function"&&ye.add(u),()=>ye.delete(u)}function j(){be&&(be.value=M.baseUrl||""),Se&&(Se.value=M.groupId||""),nt&&(nt.value=M.authToken||""),qe&&(qe.checked=ve()),Ge&&(Ge.checked=!!M.useSemver)}function c(u="",h="muted"){Ae&&(Ae.textContent=u||"",Ae.classList.remove("is-error","is-success"),h==="error"?Ae.classList.add("is-error"):h==="success"&&Ae.classList.add("is-success"))}function X(u){if(!q||(q.innerHTML="",!u))return;const h=document.createElement("p");h.className="apicurio-hint",h.textContent=u,q.appendChild(h)}function me(u){Te.clear(),Ie.clear(),X(u)}function he(){const u=l(),h=ve(),L=fe(),T=u>=0?r[u]:null,E=!!(T!=null&&T.apicurioVersions&&T.apicurioVersions.length>1);if(se){const B=se.dataset.loading==="true",ee=h&&L&&u>=0&&!!Ze(r[u]);se.disabled=!h||B||!ee,h?B||(se.textContent="Push to Apicurio"):se.textContent="Enable Apicurio to push"}if(G){const B=G.dataset.loading==="true",ee=h&&L&&E&&!!Ze(T);G.disabled=!ee||B,G.hidden=!E,h?B||(G.textContent="Push series"):G.textContent="Enable Apicurio to push series"}if(R){const B=R.dataset.loading==="true",ee=h&&L;R.disabled=!ee||B,B||(h?L?R.textContent="List artifacts":R.textContent="Enter details to list":R.textContent="Enable Apicurio to list")}}function ge(){j(),ve()?fe()?(c("Apicurio push is ready when a model is selected.","muted"),Te.size||X("Click “List artifacts” to browse the current group.")):(c("Enter Apicurio connection details to enable push.","muted"),me("Enter registry details to browse artifacts.")):(c("Apicurio integration is off. Enable it to allow pushes.","muted"),me("Apicurio integration is disabled.")),he()}function Ke(){if(window!=null&&window.localStorage)try{localStorage.setItem(gr,JSON.stringify(M))}catch(u){console.warn("[Blockscape] unable to persist Apicurio settings",u)}}function ke(){let u={};if(window!=null&&window.localStorage)try{const B=localStorage.getItem(gr);if(B){const ee=JSON.parse(B);ee&&typeof ee=="object"&&(u=ee)}}catch(B){console.warn("[Blockscape] failed to restore Apicurio settings",B)}const h=pe(u.baseUrl??ca),L=(u.groupId??To).toString().trim();let T=da,E=ua;typeof u.enabled=="boolean"?T=u.enabled:typeof u.enabled=="string"&&(T=u.enabled==="true"),typeof u.useSemver=="boolean"?E=u.useSemver:typeof u.useSemver=="string"&&(E=u.useSemver==="true"),M.baseUrl=h||ca,M.groupId=L||To,M.authToken=(u.authToken??"").toString().trim(),M.enabled=T,M.useSemver=E,ge(),Oe()}function Pe(){const u={Accept:"application/json"},h=(M.authToken||"").trim();return h&&(u.Authorization=/\s/.test(h)?h:`Bearer ${h}`),u}function Ye(u,h,{title:L,description:T,version:E}={}){const B={artifactId:u,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:h},metadata:{properties:{}}}};E&&(B.firstVersion.version=E),L&&(B.name=L),T&&(B.description=T);try{const ee=JSON.parse(h),z=ee==null?void 0:ee.seriesId;z&&typeof z=="string"&&(B.firstVersion.metadata.properties.seriesId=z)}catch{}return B}function He(u,{version:h}={}){const L={content:{contentType:"application/json",content:u},metadata:{properties:{}}};try{const T=JSON.parse(u),E=T==null?void 0:T.seriesId;E&&typeof E=="string"&&(L.metadata.properties.seriesId=E)}catch{}return h&&(L.version=h),L}function it(u){if(u==null)return null;const h=String(u).trim();if(!h)return null;const L=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(h);if(L)return{major:Number(L[1]),minor:Number(L[2]),patch:Number(L[3])};const T=/^v?(\d+)$/.exec(h);return T?{major:Number(T[1]),minor:0,patch:0}:null}function wt(u){return`${u.major}.${u.minor}.${u.patch}`}function We(u,h){return!u&&!h?0:u?h?u.major!==h.major?u.major-h.major:u.minor!==h.minor?u.minor-h.minor:u.patch-h.patch:1:-1}function V(u=[]){let h=null;if(u.forEach(T=>{const E=it((T==null?void 0:T.version)??T);E&&(!h||We(E,h)>0)&&(h=E)}),!h)return"1.0.0";const L={...h,patch:h.patch+1};return wt(L)}function Ze(u,{seriesName:h,fallbackTitle:L}={}){var B;if(!u)return null;const T=h||u.title||u.apicurioArtifactName||Y(u),E=L||T;if(typeof S=="function"&&(u.isSeries||((B=u.apicurioVersions)==null?void 0:B.length)>1)&&S(u,{seriesName:T,fallbackTitle:E}),typeof Q=="function"){const ee=Q(u,{seriesName:T,fallbackTitle:E});if(ee)return ee}return F(u)}function Dt(u){return Array.isArray(u)?u:Array.isArray(u==null?void 0:u.artifacts)?u.artifacts:Array.isArray(u==null?void 0:u.items)?u.items:Array.isArray(u==null?void 0:u.results)?u.results:[]}function y(u){return Array.isArray(u)?u:Array.isArray(u==null?void 0:u.versions)?u.versions:Array.isArray(u==null?void 0:u.items)?u.items:[]}function b(u=[]){if(!Array.isArray(u)||!u.length)return null;const h=[...u].filter(Boolean);return h.sort((L,T)=>{const E=L!=null&&L.createdOn?new Date(L.createdOn).getTime():0,B=T!=null&&T.createdOn?new Date(T.createdOn).getTime():0;if(E!==B)return B-E;const ee=Number(L==null?void 0:L.version),z=Number(T==null?void 0:T.version),Ee=Number.isFinite(ee),de=Number.isFinite(z);if(Ee&&de&&ee!==z)return z-ee;const re=String((L==null?void 0:L.version)??"");return String((T==null?void 0:T.version)??"").localeCompare(re,void 0,{numeric:!0})}),h[0]||null}function $e(u){if(!u)return u;let h=u;if(!Array.isArray(u==null?void 0:u.categories)){const T=u==null?void 0:u.content;if(typeof T=="string")try{h=JSON.parse(T)}catch(E){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",E)}else T&&typeof T=="object"&&(h=T)}return h}async function J(u,h,L){const T=encodeURIComponent(h),E=encodeURIComponent(L),B=`${u}/groups/${T}/artifacts/${E}`,ee=Pe();ee.Accept="application/json";const z=await fetch(B,{method:"GET",headers:ee});if(!z.ok){let Ee=z.statusText||"Unknown error";try{const de=await z.text();de&&(Ee=de.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${z.status}): ${Ee}`)}return z.json()}async function Ce(u,h,L){const T=encodeURIComponent(h),E=encodeURIComponent(L),B=`${u}/groups/${T}/artifacts/${E}/versions?limit=50&order=desc`,ee=Pe();ee.Accept="application/json";const z=await fetch(B,{method:"GET",headers:ee});if(!z.ok){let de=z.statusText||"Unknown error";try{const re=await z.text();re&&(de=re.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${z.status}): ${de}`)}const Ee=await z.json();return y(Ee).filter(de=>de&&de.version!=null)}async function dt(u,h,L,T="latest"){const E=encodeURIComponent(h),B=encodeURIComponent(L),ee=encodeURIComponent(T||"latest"),z=`${u}/groups/${E}/artifacts/${B}/versions/${ee}/content`,Ee=Pe();Ee.Accept="application/json, application/*+json, */*;q=0.8";const de=await fetch(z,{method:"GET",headers:Ee});if(!de.ok){let lt=de.statusText||"Unknown error";try{const Z=await de.text();Z&&(lt=Z.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${de.status}): ${lt}`)}const re=await de.text();let Ve=null;try{Ve=JSON.parse(re)}catch{throw new Error("Artifact content is not valid JSON.")}return $e(Ve)}async function K(u,h,L,T="latest"){const E=await dt(u,h,L,T);return{data:E,fingerprint:ne(E)}}async function je(u,h,L){try{const E=await Ce(u,h,L);if(E!=null&&E.length){Ie.set(L,E);const B=b(E);if((B==null?void 0:B.version)!=null)return B.version}}catch(E){console.warn("[Blockscape] compare-version: unable to fetch versions list",E)}try{const E=await J(u,h,L);if((E==null?void 0:E.version)!=null)return E.version}catch(E){console.warn("[Blockscape] compare-version: unable to fetch metadata",E)}const T=Ie.get(L);if(T&&T.length){const E=b(T);if((E==null?void 0:E.version)!=null)return E.version}return"latest"}async function ft(u,h,L,T){if(!M.useSemver)return null;if(!T)return"1.0.0";try{const E=await Ce(u,h,L);return V(E)}catch(E){throw new Error(`Unable to compute next semantic version: ${E.message}`)}}function at(u=document){se=u.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),G=u.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),R=u.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),be=u.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),Se=u.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),nt=u.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),qe=u.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),Ge=u.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),Ae=u.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),q=u.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function bn(){M.baseUrl=pe((be==null?void 0:be.value)??M.baseUrl),M.groupId=((Se==null?void 0:Se.value)??"").trim(),M.authToken=((nt==null?void 0:nt.value)??"").trim(),Ke(),ge()}function jt(u){M.enabled=u!==!1,Ke(),ge(),Oe()}function Ut(){jt(qe?qe.checked:da)}function zn(){M.useSemver=Ge?Ge.checked:ua,Ke(),ge()}function vt(){[be,Se,nt].forEach(u=>{u&&u.addEventListener("input",bn)}),se&&se.addEventListener("click",()=>{Ht()}),G&&G.addEventListener("click",()=>{Xt()}),qe&&qe.addEventListener("change",Ut),Ge&&Ge.addEventListener("change",zn),R&&R.addEventListener("click",qn),q&&q.addEventListener("click",u=>{const h=u.target.closest("[data-artifact-version]");if(h){u.stopPropagation();const E=h.dataset.artifactId,B=h.dataset.artifactVersion;E&&B&&Jt(E,B);return}const L=u.target.closest("[data-artifact-load-all]");if(L){u.stopPropagation(),L.dataset.artifactId&&ln();return}const T=u.target.closest("[data-artifact-trigger]");if(T){const E=T.dataset.artifactId;if(!E)return;Yt(E)}})}function vn(){const u=document.createElement("div");return u.className="blockscape-registry-panel",u.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,u}function Nn(u){if(!u)return;u.innerHTML="";const h=vn();u.appendChild(h),at(u),vt(),ge()}function ri(u){if(!q)return;if(q.innerHTML="",!u.length){X("No artifacts found in this group.");return}const h=E=>{const B=document.createElement("section");B.className="apicurio-artifact-section";const ee=document.createElement("h3");ee.textContent=E,B.appendChild(ee);const z=document.createElement("ul");return z.className="apicurio-artifact-list",B.appendChild(z),{section:B,list:z}},L=h("Series artifacts"),T=h("Artifacts");u.forEach(E=>{if(!(E!=null&&E.artifactId))return;const ee=E._groupId&&E._groupId.endsWith(br)?L.list:T.list,z=document.createElement("li"),Ee=document.createElement("button");Ee.type="button",Ee.className="apicurio-artifact",Ee.dataset.artifactId=E.artifactId,Ee.dataset.artifactTrigger="toggle";const de=document.createElement("span");de.className="apicurio-artifact-title",de.textContent=E.artifactId,Ee.appendChild(de);const re=[];if(E.name&&re.push(E.name),E.version!=null&&re.push(`v${E.version}`),E.type&&re.push(E.type),E._groupId&&re.push(E._groupId),re.length){const Z=document.createElement("span");Z.className="apicurio-artifact-meta",Z.textContent=re.join(" • "),Ee.appendChild(Z)}if(E.description){const Z=document.createElement("span");Z.className="apicurio-artifact-meta",Z.textContent=E.description,Ee.appendChild(Z)}z.appendChild(Ee);const Ve=document.createElement("div");Ve.className="apicurio-version-list",Ve.dataset.versionPanel=E.artifactId,Ve.hidden=!0;const lt=document.createElement("p");lt.className="apicurio-hint",lt.textContent="Click to load the latest or open versions.",Ve.appendChild(lt),z.appendChild(Ve),ee.appendChild(z)}),L.list.children.length&&q.appendChild(L.section),T.list.children.length&&q.appendChild(T.section)}function Sn(u){return q?q.querySelector(`[data-version-panel="${u}"]`):null}function Mt(u,h){if(!u||(u.innerHTML="",!h))return;const L=document.createElement("p");L.className="apicurio-hint",L.textContent=h,u.appendChild(L)}function rn(u,h){const L=Sn(u);if(L){if(L.innerHTML="",!h.length){Mt(L,"No versions found for this artifact.");return}h.forEach(T=>{const E=document.createElement("button");E.type="button",E.className="apicurio-version-button",E.dataset.artifactId=u,E.dataset.artifactVersion=T.version;const B=[`Version ${T.version}`];if(T.createdOn){const ee=new Date(T.createdOn);isNaN(ee)||B.push(ee.toISOString().slice(0,10))}E.textContent=B.join(" — "),L.appendChild(E)})}}async function Yt(u){const h=Sn(u);if(!h)return;if(h.dataset.open==="true"){h.hidden=!0,h.dataset.open="false";return}if(h.hidden=!1,h.dataset.open="true",h.dataset.loaded!=="true"){if(!fe()){Mt(h,"Enter registry details first.");return}Mt(h,"Loading versions…");try{const T=pe(M.baseUrl),E=Te.get(u),B=M.groupId.trim(),ee=(E==null?void 0:E._groupId)||B,z=await Ce(T,ee,u);Ie.set(u,z),h.dataset.loaded="true",rn(u,z)}catch(T){console.error("[Blockscape] failed to load versions",T),Mt(h,`Unable to fetch versions: ${T.message}`)}}}function sn(u,h){var T;const L=r.findIndex(E=>E.apicurioArtifactId===u);if(L!==-1){const E=r[L].id;r[L]={...h,id:E||h.id},((T=r[L].apicurioVersions)==null?void 0:T.length)>1&&(r[L].isSeries=!0),p(L)}else r.push(h),p(r.length-1)}async function At(u,h,L,T){const E=encodeURIComponent(h),B=encodeURIComponent(L),ee=`${u}/groups/${E}/artifacts/${B}`;try{const z=await fetch(ee,{method:"GET",headers:T});if(z.status===404)return!1;if(z.ok)return!0;throw z.status===401||z.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${z.status} while checking the artifact.`)}catch(z){throw z instanceof TypeError?new Error("Network error while contacting Apicurio registry."):z}}async function Ht(){var ee;if(!se||se.dataset.loading==="true")return;if(!ve()){c("Apicurio integration is off. Enable it first.","error");return}if(!fe()){c("Enter the registry base URL and group ID before pushing.","error");return}const u=l();if(u<0||!r[u]){c("No active model to push.","error");return}const h=Ze(r[u],{fallbackTitle:Y(r[u])});if(!h){c("Active model needs an id before pushing.","error");return}const L=pe(M.baseUrl),T=M.groupId.trim(),E=JSON.stringify(r[u].data,null,2),B=Pe();se.dataset.loading="true",se.textContent="Pushing…",se.disabled=!0,c("Pushing to Apicurio…","muted");try{const z=await At(L,T,h,B),Ee=ne(r[u].data);if(z)try{const rt=await je(L,T,h),{data:St,fingerprint:yt}=await K(L,T,h,rt);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",rt),console.log("local fingerprint",Ee),console.log("registry fingerprint",yt),console.log("local payload",r[u].data),console.log("registry payload",St),console.groupEnd(),Ee&&yt&&Ee===yt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){c("Push cancelled (content matches the latest registry version).","muted");return}c("Pushing identical content by user choice.","muted")}else yt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):c("Unable to compare with registry content (skipping confirmation).","muted")}catch(rt){console.warn("[Blockscape] unable to compare registry content before push",rt),c("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const de=M.useSemver?await ft(L,T,h,z):null;if(M.useSemver&&!de)throw new Error("Semantic versioning is enabled but no version could be computed.");const re=encodeURIComponent(T),Ve=encodeURIComponent(h),lt=z?`${L}/groups/${re}/artifacts/${Ve}/versions`:`${L}/groups/${re}/artifacts`,Z={...B,"Content-Type":"application/json"};de&&(Z["X-Registry-Version"]=de,c(`Pushing to Apicurio as version ${de}…`,"muted"));const Le=z?He(E,{version:de}):Ye(h,E,{title:Y(r[u]),description:(ee=r[u].data)==null?void 0:ee.abstract,version:de}),Bt=await fetch(lt,{method:"POST",headers:Z,body:JSON.stringify(Le)});if(!Bt.ok){let rt=Bt.statusText||"Unknown error";try{const St=await Bt.text();St&&(rt=St.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Bt.status}): ${rt}`)}let $t=null;try{$t=await Bt.json()}catch{$t=null}const De=($t==null?void 0:$t.version)||($t==null?void 0:$t.globalId)||"",gt=z?"Updated":"Created",cn=De?` (version ${De})`:"";c(`${gt} ${h}${cn}`,"success")}catch(z){console.error("[Blockscape] Apicurio push failed",z),c(`Apicurio push failed: ${z.message}`,"error")}finally{se.dataset.loading="false",he()}}async function Xt(){var de,re;if(!G||G.dataset.loading==="true")return;if(!ve()){c("Apicurio integration is off. Enable it first.","error");return}if(!fe()){c("Enter the registry base URL and group ID before pushing.","error");return}const u=l(),h=u>=0?r[u]:null;if(!h||!h.apicurioVersions||h.apicurioVersions.length<2){c("Series push requires a model with multiple versions.","error");return}const L=Ze(h,{seriesName:h.title||h.apicurioArtifactName||Y(h)});if(!L){c("Active series needs an id before pushing.","error");return}typeof S=="function"&&S(h,{seriesName:h.title||h.apicurioArtifactName||Y(h)});const T=pe(M.baseUrl),E=M.groupId.trim(),B=h.apicurioVersions.map(Ve=>Ve.data),ee=JSON.stringify(B,null,2),z=Pe(),Ee=Be(E);G.dataset.loading="true",G.textContent="Pushing…",G.disabled=!0,c("Pushing series to Apicurio…","muted");try{const Ve=await At(T,Ee,L,z),lt=ne(B);if(Ve)try{const dn=await je(T,Ee,L),{data:kn,fingerprint:si}=await K(T,Ee,L,dn);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",dn),console.log("local fingerprint",lt),console.log("registry fingerprint",si),console.log("local payload (series)",B),console.log("registry payload",kn),console.groupEnd(),lt&&si&&lt===si){if(!window.confirm("The current registry version matches this series. Push anyway?")){c("Series push cancelled (content matches latest).","muted");return}c("Pushing identical series by user choice.","muted")}else si?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):c("Unable to compare with registry content (skipping confirmation).","muted")}catch(dn){console.warn("[Blockscape] unable to compare registry content before series push",dn),c("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const Z=M.useSemver?await ft(T,Ee,L,Ve):null;if(M.useSemver&&!Z)throw new Error("Semantic versioning is enabled but no version could be computed.");const Le=encodeURIComponent(Ee),Bt=encodeURIComponent(L),$t=Ve?`${T}/groups/${Le}/artifacts/${Bt}/versions`:`${T}/groups/${Le}/artifacts`,De={...z,"Content-Type":"application/json"};Z&&(De["X-Registry-Version"]=Z,c(`Pushing series to Apicurio as version ${Z}…`,"muted"));const gt=Ve?He(ee,{version:Z}):Ye(L,ee,{title:h.apicurioArtifactName||((de=h.data)==null?void 0:de.title)||L,description:(re=h.data)==null?void 0:re.abstract,version:Z}),cn=await fetch($t,{method:"POST",headers:De,body:JSON.stringify(gt)});if(!cn.ok){let dn=cn.statusText||"Unknown error";try{const kn=await cn.text();kn&&(dn=kn.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${cn.status}): ${dn}`)}let rt=null;try{rt=await cn.json()}catch{rt=null}const St=(rt==null?void 0:rt.version)||(rt==null?void 0:rt.globalId)||"",yt=Ve?"Updated":"Created",In=St?` (version ${St})`:"";c(`${yt} ${L} series${In}`,"success")}catch(Ve){console.error("[Blockscape] Apicurio series push failed",Ve),c(`Apicurio series push failed: ${Ve.message}`,"error")}finally{G.dataset.loading="false",he()}}async function qn(){if(!R||R.dataset.loading==="true")return;if(!ve()){c("Enable Apicurio integration to list artifacts.","error");return}if(!fe()){c("Enter registry base URL and group ID before listing.","error");return}const u=pe(M.baseUrl),h=M.groupId.trim(),L=Be(h),T=[{groupId:h,label:"base"},{groupId:L,label:"series"}];R.dataset.loading="true",R.textContent="Listing…",R.disabled=!0,c("Listing artifacts…","muted"),X("Contacting registry…");try{const E=Pe();E.Accept="application/json";const B=[];for(const z of T){const Ee=encodeURIComponent(z.groupId),de=`${u}/groups/${Ee}/artifacts?limit=50&offset=0`,re=await fetch(de,{method:"GET",headers:E});if(!re.ok){let Z=re.statusText||"Unknown error";try{const Le=await re.text();Le&&(Z=Le.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${z.groupId} (${re.status}): ${Z}`);continue}const Ve=await re.json(),lt=Dt(Ve).filter(Z=>Z&&Z.artifactId);lt.forEach(Z=>{Z&&(Z._groupId=z.groupId)}),B.push(...lt)}Te.clear(),Ie.clear(),B.forEach(z=>{z!=null&&z.artifactId&&Te.set(z.artifactId,z)}),ri(B);const ee=B.length;c(ee?`Found ${ee} artifact${ee===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",ee?"success":"muted")}catch(E){console.error("[Blockscape] failed to list artifacts",E),me("Unable to list artifacts."),c(`Listing failed: ${E.message}`,"error")}finally{R.dataset.loading="false",he()}}async function Jt(u,h=null){var Ve,lt,Z,Le,Bt,$t;if(!u)return;if(!ve()){c("Enable Apicurio integration to load artifacts.","error");return}if(!fe()){c("Enter registry connection details before loading artifacts.","error");return}const L=pe(M.baseUrl),T=M.groupId.trim(),E=u&&((Ve=Te.get(u))==null?void 0:Ve._groupId)||T;let B=Te.get(u);const ee=async()=>{try{const De=await J(L,E,u);return De!=null&&De.artifactId&&Te.set(u,De),De}catch(De){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",De),De}};if(!B)try{B=await ee()}catch(De){c(`Failed to fetch artifact metadata: ${De.message}`,"error");return}const z=Ie.get(u)||[];let Ee="latest",de="latest";if(h)Ee=h,de=h;else{if(!B||B.version==null)try{B=await ee()}catch(De){c(`Failed to fetch artifact metadata: ${De.message}`,"error");return}Ee=(B==null?void 0:B.version)||"latest",de=(B==null?void 0:B.version)||"latest"}const re=z.find(De=>String(De.version)===String(Ee));(re==null?void 0:re.version)!=null&&(de=re.version),c(`Loading artifact ${u}…`,"muted");try{const De=await dt(L,E,u,Ee),gt=Te.get(u)||B||{},cn=Array.isArray(De);let rt=null;if(cn){const St=De.map((In,dn)=>(C(In,{titleHint:gt.name||u,idHint:u}),{version:String(dn+1),data:In,createdOn:(re==null?void 0:re.createdOn)||gt.createdOn}));rt={id:k(),title:((Z=(lt=St[0])==null?void 0:lt.data)==null?void 0:Z.title)||gt.name||u,data:(Le=St[0])==null?void 0:Le.data,apicurioArtifactId:u,apicurioArtifactName:gt.name||"",apicurioVersions:St,apicurioActiveVersionIndex:0,isSeries:!0};const yt=((Bt=gt==null?void 0:gt.properties)==null?void 0:Bt.seriesId)||u;typeof S=="function"&&S(rt,{seriesName:yt,fallbackTitle:yt}),c(`Loaded series artifact ${u}.`,"success")}else{C(De,{titleHint:gt.name||u,idHint:u});const St={version:de,data:De,createdOn:(re==null?void 0:re.createdOn)||gt.createdOn};rt={id:k(),title:De.title||gt.name||u,data:De,apicurioArtifactId:u,apicurioArtifactName:gt.name||"",apicurioVersions:[St],apicurioActiveVersionIndex:0};const yt=($t=gt==null?void 0:gt.properties)==null?void 0:$t.seriesId;yt&&typeof S=="function"&&S(rt,{seriesName:yt,fallbackTitle:yt});const In=de?` (version ${de})`:"";c(`Loaded artifact ${u}${In}.`,"success")}sn(u,rt)}catch(De){console.error("[Blockscape] failed to load artifact",De),c(`Failed to load artifact: ${De.message}`,"error")}}async function ln(u){}return{hydrateConfig:ke,mount:Nn,updateAvailability:he,isEnabled:ve,setEnabled:jt,onEnabledChange:P}}const an={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Wn(r,l){if(typeof r!="function")throw new Error(`[itemEditor] expected ${l} to be a function`)}function fl(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}function ml(r,{excludeId:l}={}){if(!r)return[];const p=r.split(/[\s,]+/).map(S=>S.trim()).filter(Boolean),C=[];return p.forEach(S=>{l&&S===l||C.includes(S)||C.push(S)}),C}function hl(r,l,p){if(!l||!p||l===p)return;((r==null?void 0:r.categories)||[]).forEach(S=>{(S.items||[]).forEach(F=>{Array.isArray(F.deps)&&(F.deps=F.deps.map(Q=>Q===l?p:Q))})}),Array.isArray(r==null?void 0:r.links)&&r.links.forEach(S=>{S.from===l&&(S.from=p),S.to===l&&(S.to=p)})}function gl({findItemAndCategoryById:r,collectAllItemIds:l,updateItemReferences:p,loadActiveIntoEditor:C,rebuildFromActive:S,select:F,onSelectionRenamed:Q,makeSlug:Y=fl,isAutoIdFromNameEnabled:ne=()=>!0}={}){Wn(r,"findItemAndCategoryById"),Wn(l,"collectAllItemIds"),Wn(p,"updateItemReferences"),Wn(C,"loadActiveIntoEditor"),Wn(S,"rebuildFromActive"),Wn(F,"select"),Wn(Y,"makeSlug"),Wn(ne,"isAutoIdFromNameEnabled");const k={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function se(G){if(k.fields.errorEl){if(!G){k.fields.errorEl.hidden=!0,k.fields.errorEl.textContent="";return}k.fields.errorEl.hidden=!1,k.fields.errorEl.textContent=G}}function R(){k.wrapper&&(k.wrapper.hidden=!0,k.wrapper.setAttribute("aria-hidden","true"),se(""),k.categoryId=null,k.itemId=null,k.modelData=null,document.body.classList.remove("item-editor-open"))}function be(){k.wrapper&&(k.wrapper.hidden=!1,k.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var G,q;(G=k.fields.nameInput)==null||G.focus(),(q=k.fields.nameInput)==null||q.select()}))}function Se({force:G}={}){var ye,M;if(!((ye=k.fields)!=null&&ye.idInput)||!((M=k.fields)!=null&&M.nameInput)||!k.autoSyncEnabled||!ne()||!G&&k.autoIdManuallyEdited)return;const q=Y(k.fields.nameInput.value||k.itemId||"item");k.fields.idInput.value=q}function nt(G){var ve;if(!k.modelData||!k.categoryId||!k.itemId)throw new Error("No item loaded.");const ye=(((ve=k.modelData)==null?void 0:ve.categories)||[]).find(Oe=>Oe.id===k.categoryId);if(!ye)throw new Error("Category not found.");ye.items=ye.items||[];const M=ye.items.find(Oe=>Oe.id===k.itemId);if(!M)throw new Error("Item not found.");const Te=(G.id||"").trim();if(!Te)throw new Error("ID is required.");const Ie=l(k.modelData);if(Te!==M.id&&Ie.has(Te))throw new Error("Another item already uses that ID.");M.id=Te;const pe=(G.name||"").trim();M.name=pe||M.id;const Be=(G.logo||"").trim();if(Be?M.logo=Be:delete M.logo,G.externalFlag&&!G.external)M.external=!0;else{const Oe=(G.external??"").toString().trim();Oe?M.external=Oe:delete M.external}const fe=(G.color||"").trim();return fe?M.color=fe:delete M.color,M.deps=Array.isArray(G.deps)?G.deps:[],M.id!==G.originalId&&typeof Q=="function"&&Q(G.originalId,M.id),p(k.modelData,G.originalId,M.id),C(),S(),F(M.id),M.id}function qe(){if(!k.fields||!k.fields.idInput)return!1;const G=(k.fields.idInput.value||"").trim(),q={originalId:k.itemId,id:G,name:k.fields.nameInput.value||"",logo:k.fields.logoInput.value||"",external:k.fields.externalInput.value||"",externalFlag:k.fields.externalFlagInput.checked,color:k.fields.colorInput.value||"",deps:ml(k.fields.depsInput.value,{excludeId:G})};try{return nt(q),R(),!0}catch(ye){return console.warn("[itemEditor] item edit failed",ye),se((ye==null?void 0:ye.message)||"Unable to save item."),!1}}function Ge(){if(k.wrapper)return k.wrapper;const G=document.createElement("div");G.className="item-editor-modal",G.hidden=!0,G.setAttribute("role","dialog"),G.setAttribute("aria-modal","true");const q=document.createElement("div");q.className="item-editor-modal__backdrop",G.appendChild(q);const ye=document.createElement("div");ye.className="item-editor",G.appendChild(ye);const M=document.createElement("div");M.className="item-editor__header";const Te=document.createElement("h2");Te.className="item-editor__title",Te.textContent="Edit item";const Ie=document.createElement("button");Ie.type="button",Ie.className="item-editor__close",Ie.setAttribute("aria-label","Close item editor"),Ie.textContent="×",M.appendChild(Te),M.appendChild(Ie),ye.appendChild(M);const pe=document.createElement("form");pe.className="item-editor__form",ye.appendChild(pe);const Be=document.createElement("div");Be.className="item-editor__meta",Be.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',pe.appendChild(Be);const fe=document.createElement("div");fe.className="item-editor__error",fe.hidden=!0,pe.appendChild(fe);const ve=(y,b,$e)=>{const J=document.createElement("label");J.className="item-editor__field";const Ce=document.createElement("span");if(Ce.className="item-editor__label",Ce.textContent=y,J.appendChild(Ce),b.classList.add("item-editor__control"),J.appendChild(b),$e){const dt=document.createElement("div");dt.className="item-editor__hint",dt.textContent=$e,J.appendChild(dt)}return J},Oe=document.createElement("input");Oe.type="text",Oe.required=!0,pe.appendChild(ve("ID",Oe,"Unique identifier used for links and dependencies."));const P=document.createElement("input");P.type="text",pe.appendChild(ve("Name",P,"Visible label shown on the tile."));const j=document.createElement("input");j.type="url",j.inputMode="url",j.placeholder="https://…",pe.appendChild(ve("Logo URL",j,"Optional image URL."));const c=document.createElement("input");c.type="url",c.inputMode="url",c.placeholder="https://…",pe.appendChild(ve("External link",c,"Shown with ↗ icon and in preview."));const X=document.createElement("div");X.className="item-editor__checkbox";const me=document.createElement("label");me.className="item-editor__checkbox-row";const he=document.createElement("input");he.type="checkbox";const ge=document.createElement("span");ge.textContent="Mark as external without link";const Ke=document.createElement("div");Ke.className="item-editor__hint",Ke.textContent="Keeps dashed border even without a URL.",me.appendChild(he),me.appendChild(ge),X.appendChild(me),X.appendChild(Ke),pe.appendChild(X);const ke=document.createElement("input");ke.type="text",ke.placeholder=an.color.primary,pe.appendChild(ve("Color",ke,"Optional badge color (hex or CSS color)."));const Pe=document.createElement("textarea");Pe.rows=2,Pe.placeholder="Comma or space separated ids",pe.appendChild(ve("Dependencies",Pe,"Use item IDs, separated by commas or spaces."));const Ye=document.createElement("div");Ye.className="item-editor__checkbox";const He=document.createElement("label");He.className="item-editor__checkbox-row";const it=document.createElement("input");it.type="checkbox";const wt=document.createElement("span");wt.textContent="Sync ID while editing name";const We=document.createElement("div");We.className="item-editor__hint",We.textContent="Turn off to keep typing names without changing the ID.",He.appendChild(it),He.appendChild(wt),Ye.appendChild(He),Ye.appendChild(We),pe.appendChild(Ye);const V=document.createElement("div");V.className="item-editor__actions";const Ze=document.createElement("button");Ze.type="button",Ze.className="pf-v5-c-button pf-m-tertiary",Ze.textContent="Cancel";const Dt=document.createElement("button");return Dt.type="submit",Dt.className="pf-v5-c-button pf-m-primary",Dt.textContent="Save",V.appendChild(Ze),V.appendChild(Dt),pe.appendChild(V),k.wrapper=G,k.fields={idInput:Oe,nameInput:P,logoInput:j,externalInput:c,externalFlagInput:he,colorInput:ke,depsInput:Pe,syncCheckbox:it,categoryValue:Be.querySelector(".item-editor__meta-value"),errorEl:fe},Ze.addEventListener("click",R),Ie.addEventListener("click",R),q.addEventListener("click",R),Oe.addEventListener("input",()=>{k.autoIdManuallyEdited=!0}),P.addEventListener("input",Se),it.addEventListener("change",()=>{k.autoSyncEnabled=!!it.checked,k.autoSyncEnabled&&(k.autoIdManuallyEdited=!1,Se({force:!0}))}),pe.addEventListener("submit",y=>{y.preventDefault(),qe()}),document.addEventListener("keydown",y=>{y.key==="Escape"&&!G.hidden&&(y.preventDefault(),y.stopPropagation(),R())}),document.body.appendChild(G),G}function Ae(G){const q=r(G);if(!q)return!1;Ge(),k.categoryId=q.category.id,k.itemId=q.item.id,k.modelData=q.modelData,k.autoIdManuallyEdited=!1;const ye=!!ne();return k.autoSyncEnabled=ye,k.fields.categoryValue.textContent=q.category.title||q.category.id,k.fields.idInput.value=q.item.id||"",k.fields.nameInput.value=q.item.name||"",k.fields.logoInput.value=q.item.logo||"",k.fields.externalInput.value=typeof q.item.external=="string"?q.item.external:"",k.fields.externalFlagInput.checked=q.item.external===!0,k.fields.colorInput.value=q.item.color||"",k.fields.depsInput.value=Array.isArray(q.item.deps)?q.item.deps.join(", "):"",k.fields.syncCheckbox.checked=k.autoSyncEnabled,k.fields.syncCheckbox.disabled=!ye,!k.fields.idInput.value&&ye&&Se({force:!0}),se(""),F(q.item.id),be(),!0}return{open:Ae,hide:R,isOpen:()=>!!k.wrapper&&!k.wrapper.hidden}}function bl({menuEl:r,previewEl:l,previewTitleEl:p,previewBodyEl:C,previewActionsEl:S,previewCloseEl:F,escapeHtml:Q,onEditItem:Y,onChangeColor:ne,selectItem:k,colorPresets:se=[]}={}){const R=r||(()=>{const P=document.createElement("div");return P.className="tile-context-menu",P.hidden=!0,P.setAttribute("aria-hidden","true"),document.body.appendChild(P),P})();let be={x:0,y:0},Se=0,nt=Array.isArray(se)?se:[];function qe(){R&&(R.classList.remove("is-open"),R.hidden=!0,R.setAttribute("aria-hidden","true"),R.innerHTML="")}function Ge(P=[]){S&&(S.innerHTML="",P.forEach(j=>{const c=document.createElement("button");c.type="button",c.className="item-preview__action",c.textContent=j.label||"Action",j.title&&(c.title=j.title),c.addEventListener("click",X=>{X.stopPropagation(),typeof j.onClick=="function"&&j.onClick(X)}),S.appendChild(c)}),S.hidden=P.length===0)}function Ae(){qe(),l&&(l.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),l.setAttribute("aria-hidden","true"),l.hidden=!0,Ge([]))}function G(P,j){l&&(be={x:P,y:j},l.hidden=!1,l.setAttribute("aria-hidden","false"),l.classList.add("is-visible"),q(P,j))}function q(P,j){if(!l)return;const c=12;l.style.left=`${P+c}px`,l.style.top=`${j+c}px`;const X=l.getBoundingClientRect();let me=X.left,he=X.top;X.right>window.innerWidth-c&&(me=Math.max(c,window.innerWidth-X.width-c)),X.bottom>window.innerHeight-c&&(he=Math.max(c,window.innerHeight-X.height-c)),l.style.left=`${me}px`,l.style.top=`${he}px`}function ye(P,j){var ge;if(!P)return null;const c=P.dataset.id,X=((ge=P.querySelector(".name"))==null?void 0:ge.textContent)||c||"Preview",me=c?`${c}.html`:"",he=me?`items/${me}`:"";return{id:c,displayName:X,filename:me,filepath:he,externalUrl:P.dataset.externalUrl||"",obsidianUrl:P.dataset.obsidianUrl||"",anchorX:(j==null?void 0:j.clientX)??0,anchorY:(j==null?void 0:j.clientY)??0}}function M(P,j){const c=document.createElement("button");return c.type="button",c.className="tile-context-menu__item",c.textContent=P,c.addEventListener("click",()=>{qe(),typeof j=="function"&&j()}),c}function Te(P){if(!R)return;R.innerHTML="";const j=document.createElement("div");j.className="tile-context-menu__list",j.appendChild(M("File view",()=>pe(P))),typeof Y=="function"&&j.appendChild(M("Edit",()=>Y(P.id))),typeof ne=="function"&&P.id&&nt.forEach(c=>{if(!(c!=null&&c.value))return;const X=c.name||c.value;j.appendChild(M(`Set color: ${X}`,()=>ne(P.id,c.value)))}),R.appendChild(j)}function Ie(P,j){if(!R)return;const c=4;R.style.left=`${P+c}px`,R.style.top=`${j+c}px`,R.hidden=!1,R.setAttribute("aria-hidden","false"),R.classList.add("is-open");const X=R.getBoundingClientRect();let me=X.left,he=X.top;X.right>window.innerWidth-c&&(me=Math.max(c,window.innerWidth-X.width-c)),X.bottom>window.innerHeight-c&&(he=Math.max(c,window.innerHeight-X.height-c)),R.style.left=`${me}px`,R.style.top=`${he}px`}async function pe(P){if(!l||!p||!C||!P)return;const j=++Se,c=[];if(typeof Y=="function"&&P.id&&c.push({label:"Edit",title:"Edit this item",onClick:()=>{Ae(),Y(P.id)}}),P.externalUrl&&c.push({label:"Open link ↗",title:P.externalUrl,onClick:()=>window.open(P.externalUrl,"_blank","noopener")}),P.obsidianUrl&&c.push({label:"Open in Obsidian",title:P.obsidianUrl,onClick:()=>window.open(P.obsidianUrl,"_blank","noopener")}),Ge(c),P.id&&typeof k=="function"&&k(P.id),p.textContent=P.displayName,C.innerHTML='<div class="item-preview__status">Loading…</div>',l.classList.remove("item-preview--has-frame"),l.classList.add("item-preview--expanded"),G(P.anchorX,P.anchorY),!P.filepath){C.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',q(be.x,be.y);return}try{const X=await fetch(P.filepath,{cache:"no-cache"});if(!X.ok)throw new Error(`HTTP ${X.status}`);const me=await X.text();if(j!==Se)return;if(!me.trim()){const Ke=Q?Q(P.filename):P.filename;C.innerHTML=`<div class="item-preview__status">No content in <code>${Ke}</code>.</div>`,q(be.x,be.y);return}const ge=document.createElement("iframe");ge.className="item-preview__frame",ge.title=`${P.displayName} details`,ge.srcdoc=me,C.innerHTML="",C.appendChild(ge),l.classList.add("item-preview--has-frame"),q(be.x,be.y)}catch(X){if(j!==Se)return;const me=Q?Q(P.displayName):P.displayName;C.innerHTML=`<div class="item-preview__status">No preview available for <strong>${me}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${P.filepath}`,X),q(be.x,be.y)}}function Be(P,j){if(!j)return;P.preventDefault(),P.stopPropagation();const c=ye(j,P);!c||!c.id||(typeof k=="function"&&k(c.id),Te(c),Ie(P.clientX,P.clientY))}function fe(P){const j=P==null?void 0:P.target,c=R&&!R.hidden&&R.contains(j),X=l&&!l.hidden&&l.contains(j);!c&&!X&&Ae()}function ve(){!l||l.hidden||q(be.x,be.y)}function Oe(){Ae()}return F&&F.addEventListener("click",Ae),{handleTileContextMenu:Be,hidePreview:Ae,hideMenu:qe,handleDocumentClick:fe,handleWindowResize:ve,handleWindowScroll:Oe,updateColorPresets:P=>{nt=Array.isArray(P)?P:[]}}}function vr(r,l="series"){return(r||l).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||l}function gn(r,l="series"){const p=vr(r,l).replace(/\./g,"-");return p.replace(/-series$/i,"").replace(/-+$/,"")||p||vr(l,"series")}function wr(r,{seriesName:l,fallbackTitle:p="unknown"}={}){var Y,ne;const S=[r==null?void 0:r.seriesId,(Y=r==null?void 0:r.data)==null?void 0:Y.seriesId,r==null?void 0:r.apicurioArtifactId,l,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(ne=r==null?void 0:r.data)==null?void 0:ne.title,p].map(k=>(k??"").toString().trim()),F=S.findIndex(Boolean),Q=F!==-1?S[F]:"";return Q?(console.log("[Series] deriveSeriesId: picked base",{base:Q,sourceIndex:F,candidates:S}),gn(Q,p)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:p}),null)}function Nt(r,{seriesName:l,fallbackTitle:p="unknown"}={}){if(!r||typeof r!="object")return null;const C=wr(r,{seriesName:l,fallbackTitle:p});return C?(r.seriesId=C,r.apicurioArtifactId||(r.apicurioArtifactId=C),C):null}function jn(r,l={}){var S,F;if(!r)return null;const p=r.isSeries||((S=r.apicurioVersions)==null?void 0:S.length)>1||r.seriesId||((F=r.data)==null?void 0:F.seriesId)||r.apicurioArtifactId;if(!p&&!l.force)return null;const C=wr(r,l);return C||(p?gn(l.fallbackTitle||"unknown"):null)}const yr={selectionDimOpacity:.2,selectionDimEnabled:!0},Jn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,l=!0)=>{const p=Math.round((1-r)*100);return l?p===0?"Off":`${p}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function ai(r){return r===!0||r==="true"||r===1||r==="1"}function vl(r,{localBackend:l}={}){const p=l&&typeof l.getAutoReloadConfig=="function"&&l.getAutoReloadConfig(),C={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets};return p&&(C.autoReloadEnabled=!!p.enabled,C.autoReloadIntervalMs=p.intervalMs),C}function wl(r={},l){var He,it,wt,We;if(!r||typeof r!="object")return{applied:[]};const p=[],{applyTheme:C,applyTileHoverScale:S,persistTileHoverScale:F,applySelectionDimEnabled:Q,persistSelectionDimEnabled:Y,applySelectionDimOpacity:ne,persistSelectionDimOpacity:k,applyTileCompactness:se,persistTileCompactness:R,applyTitleWrapMode:be,persistTitleWrapMode:Se,applyTitleHoverWidthMultiplier:nt,persistTitleHoverWidthMultiplier:qe,applyTitleHoverTextPortion:Ge,persistTitleHoverTextPortion:Ae,applyObsidianLinksEnabled:G,persistObsidianLinksEnabled:q,applyObsidianLinkMode:ye,persistObsidianLinkMode:M,applyObsidianVaultName:Te,persistObsidianVaultName:Ie,applyAutoIdFromNameEnabled:pe,persistAutoIdFromNameEnabled:Be,applySeriesNavDoubleClickWait:fe,persistSeriesNavDoubleClickWait:ve,applyCenterItems:Oe,persistCenterItems:P,localBackend:j,ui:c,refreshObsidianLinks:X,scheduleOverlaySync:me,selection:he,select:ge,clearStyles:Ke,drawLinks:ke,applyReusedHighlights:Pe,current:Ye}=l;if(r.theme){const Ze=((C==null?void 0:C(r.theme))||r.theme)==="dark";(He=l.ui)!=null&&He.themeToggle&&(l.ui.themeToggle.checked=Ze),(it=l.ui)!=null&&it.tabThemeToggle&&(l.ui.tabThemeToggle.checked=Ze),p.push("theme")}if(r.hoverScale!=null){const V=S(parseFloat(r.hoverScale));F(V),c!=null&&c.hoverScaleInput&&(c.hoverScaleInput.value=String(V)),c!=null&&c.hoverScaleValue&&(c.hoverScaleValue.textContent=Jn.hoverScale(V)),he&&me(),p.push("hoverScale")}if(r.selectionDimEnabled!=null){const V=Q(ai(r.selectionDimEnabled));Y(V),c!=null&&c.selectionDimToggle&&(c.selectionDimToggle.checked=V),c!=null&&c.selectionDimInput&&(c.selectionDimInput.disabled=!V),c!=null&&c.selectionDimValue&&(c.selectionDimValue.textContent=Jn.selectionDimming(Ye.selectionDimOpacity??yr.selectionDimOpacity,V)),p.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const V=ne(parseFloat(r.selectionDimOpacity));k(V),c!=null&&c.selectionDimInput&&(c.selectionDimInput.value=String(V)),c!=null&&c.selectionDimValue&&(c.selectionDimValue.textContent=Jn.selectionDimming(V,Ye.selectionDimEnabled??yr.selectionDimEnabled)),p.push("selectionDimOpacity")}if(r.tileCompactness!=null){const V=se(parseFloat(r.tileCompactness));R(V),c!=null&&c.tileCompactnessInput&&(c.tileCompactnessInput.value=String(V)),c!=null&&c.tileCompactnessValue&&(c.tileCompactnessValue.textContent=Jn.compactness(V)),he&&me(),p.push("tileCompactness")}if(r.titleWrapMode){const V=be(r.titleWrapMode);Se(V),c!=null&&c.titleWrapInput&&(c.titleWrapInput.checked=V!=="nowrap"),p.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const V=nt(parseFloat(r.titleHoverWidthMultiplier));qe(V),c!=null&&c.titleWidthInput&&(c.titleWidthInput.value=String(V)),c!=null&&c.titleWidthValue&&(c.titleWidthValue.textContent=Jn.titleWidth(V)),p.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const V=Ge(parseFloat(r.titleHoverTextPortion));Ae(V),c!=null&&c.titleZoomInput&&(c.titleZoomInput.value=String(V)),c!=null&&c.titleZoomValue&&(c.titleZoomValue.textContent=Jn.titleZoomPortion(V)),p.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const V=G(ai(r.obsidianLinksEnabled));q(V),c!=null&&c.obsidianToggle&&(c.obsidianToggle.checked=V),(wt=c==null?void 0:c.obsidianModeInputs)==null||wt.forEach(Ze=>{Ze.disabled=!V}),c!=null&&c.obsidianVaultInput&&(c.obsidianVaultInput.disabled=!V),X==null||X(),p.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const V=ye(r.obsidianLinkMode);M(V),(We=c==null?void 0:c.obsidianModeInputs)==null||We.forEach(Ze=>{Ze.checked=Ze.value===V}),X==null||X(),p.push("obsidianLinkMode")}if(r.obsidianVault!=null){const V=Te(r.obsidianVault);Ie(V),c!=null&&c.obsidianVaultInput&&(c.obsidianVaultInput.value=V),X==null||X(),p.push("obsidianVault")}if(r.colorPresets&&(typeof l.setColorPresets=="function"&&l.setColorPresets(r.colorPresets),p.push("colorPresets")),r.autoIdFromName!=null){const V=pe(ai(r.autoIdFromName));Be(V),c!=null&&c.autoIdToggle&&(c.autoIdToggle.checked=V),p.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const V=fe(parseInt(r.seriesNavDoubleClickMs,10));ve(V),c!=null&&c.seriesNavInput&&(c.seriesNavInput.value=String(V)),c!=null&&c.seriesNavValue&&(c.seriesNavValue.textContent=Jn.seriesNavWait(V)),p.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&j&&typeof j.setAutoReloadEnabled=="function"){const V=ai(r.autoReloadEnabled);j.setAutoReloadEnabled(V),c!=null&&c.autoReloadToggle&&(c.autoReloadToggle.checked=V),c!=null&&c.autoReloadInput&&(c.autoReloadInput.disabled=!V),p.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&j&&typeof j.setAutoReloadInterval=="function"){const V=j.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));c!=null&&c.autoReloadInput&&(c.autoReloadInput.value=String(V)),c!=null&&c.autoReloadValue&&(c.autoReloadValue.textContent=Jn.autoReloadInterval(V)),p.push("autoReloadIntervalMs")}if(r.centerItems!=null){const V=Oe==null?void 0:Oe(ai(r.centerItems));P==null||P(V),c!=null&&c.tabCenterToggle&&(c.tabCenterToggle.checked=V),p.push("centerItems")}if(r.showSecondaryLinks!=null){const V=ai(r.showSecondaryLinks);typeof l.setShowSecondaryLinks=="function"?l.setShowSecondaryLinks(V):l.showSecondaryLinks=V,c!=null&&c.secondaryLinksToggle&&(c.secondaryLinksToggle.checked=V),c!=null&&c.tabSecondaryLinksToggle&&(c.tabSecondaryLinksToggle.checked=V),he?ge(he):(Ke(),ke()),p.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const V=ai(r.showReusedInMap);typeof l.setShowReusedInMap=="function"?l.setShowReusedInMap(V):l.showReusedInMap=V,c!=null&&c.reusedToggle&&(c.reusedToggle.checked=V),Pe==null||Pe(),p.push("showReusedInMap")}return{applied:p}}function yl(r,l){const p=new Blob([l],{type:"application/json"}),C=URL.createObjectURL(p),S=document.createElement("a");S.href=C,S.download=r,S.click(),URL.revokeObjectURL(C)}const Lo=typeof{url:Ln&&Ln.tagName.toUpperCase()==="SCRIPT"&&Ln.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function El(r={}){console.log("[Blockscape] init");const l={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,seriesNavMinVersions:1,...r},p=document.getElementById("jsonBox"),C=document.querySelector(".blockscape-json-panel"),S=document.getElementById("app"),F=document.getElementById("overlay"),Q=document.getElementById("tabTooltip"),Y=document.getElementById("modelList"),ne=document.getElementById("itemPreview"),k=document.getElementById("urlForm"),se=document.getElementById("urlInput"),R=document.getElementById("loadUrl"),be=ne.querySelector(".item-preview__title"),Se=ne.querySelector(".item-preview__body"),nt=ne.querySelector(".item-preview__actions"),qe=ne.querySelector(".item-preview__close"),Ge=document.getElementById("downloadJson"),Ae=document.getElementById("shareModel"),G=document.getElementById("createVersion"),q=document.getElementById("openInEditor"),ye=document.getElementById("copyJson"),M=document.getElementById("copySeries"),Te=document.getElementById("pasteJson"),Ie=document.getElementById("helpButton"),pe=document.getElementById("newPanelButton"),Be=document.getElementById("newBlankButton"),fe=document.getElementById("shortcutHelp"),ve=document.getElementById("shortcutHelpList"),Oe=document.getElementById("shortcutHelpClose"),P=document.getElementById("shortcutHelpBackdrop"),j=document.getElementById("newPanel"),c=document.getElementById("newPanelClose"),X=document.getElementById("newPanelBackdrop"),me=document.getElementById("search"),he=document.getElementById("searchResults"),ge=document.getElementById("localBackendPanel"),Ke=document.getElementById("localBackendStatus"),ke=document.getElementById("localFileList"),Pe=document.getElementById("localDirSelect"),Ye=document.getElementById("refreshLocalFiles"),He=document.getElementById("loadLocalFile"),it=document.getElementById("saveLocalFile"),wt=document.getElementById("saveLocalFileAs"),We=document.getElementById("localSavePath"),V="blockscape:editorPayload",Ze="blockscape:editorTransfer",Dt=document.title;ge&&(ge.hidden=!0),!l.localBackend&&ge&&(ge.hidden=!0),l.fileOpen||(He&&(He.hidden=!0),Pe&&(Pe.hidden=!0),Ye&&(Ye.hidden=!0),ke&&(ke.hidden=!0)),l.fileSave||(it&&(it.hidden=!0),wt&&(wt.hidden=!0),We&&(We.hidden=!0)),p.value=document.getElementById("seed").textContent.trim();let y=[],b=-1;const $e=pl({models:y,getActiveIndex:()=>b,setActive:It,ensureModelMetadata:_n,getModelId:mt,getSeriesId:jn,ensureSeriesId:Nt,getModelTitle:ze,computeJsonFingerprint:Po,uid:di});let J=null,Ce=new Map,dt=new Map,K=null,je=null,ft=null,at=null,bn=!0,jt=!1,Ut=!1,zn="map",vt=null,vn=null,Nn=!1,ri=null;const Sn=2e3;let Mt=null,rn=null,Yt=null,sn=null,At=null,Ht=null,Xt=null,qn=null,Jt=null,ln="",u=!1,h=null;const L=new Map;let T=null,E=null,B=[],ee=null;const z=30,Ee=1e3,de="blockscape:hoverScale",re=1.5,Ve=1,lt=2.5,Z="blockscape:selectionDimOpacity",Le="blockscape:selectionDimEnabled",Bt=.2,$t=.05,De=1,gt="blockscape:titleWrap",cn="blockscape:titleHoverWidth",rt="blockscape:titleHoverTextPortion",St="wrap",yt=1.3,In=1,dn=1.6,kn=.25,si=0,pa=.6,kr="blockscape:tileCompactness",Yi=1,_r=.75,Cr=1.25,xr="blockscape:obsidianLinksEnabled",Ar="blockscape:obsidianLinkMode",Tr="blockscape:obsidianVault",fa="title",No="id",Mo=fa,Lr="blockscape:autoReloadEnabled",Nr="blockscape:autoReloadIntervalMs",Xi=1e3,Mr=500,Br=1e4,$r="blockscape:autoIdFromName",Bo=!0,Rr="blockscape:colorPresets",Or="blockscape:centerItems",Pr="blockscape:theme",vi="light",li="dark",$o="cat:",Ro=!1;let wi=re,Mn=Bt,Bn=!0,yi=Yi,ma=St,Ei=yt,Si=kn,Ii=!1,Zi=Mo,ki="",ci=Bo,Qi=vi,Ft=[],Zt=Ro,_i=null;const Vr="blockscape:seriesNavDoubleClickMs",eo=900,Dr=300,Ur=4e3;let $n=eo;const _e={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null},Rl={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:Xi}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},Je=l.localBackend?Gl():Rl,Hr=l.localBackend?Je.detect():Promise.resolve(!1);$e.hydrateConfig(),ha(Ul()),xi(Wl(),{silent:!0}),sc(),lc(),uc(),mc(),pc(),fc(),wc(),Sc(),Ec(),Ic(),cc(),dc(),Fl(),Wt();function di(){return Math.random().toString(36).slice(2,10)}function Ol(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(i=>{n+=String.fromCharCode(i)}),btoa(n)}function Pl(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new TextDecoder().decode(n)}function Vl(e){return Ol(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Dl(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Pl(t)}const Fr=(e,t)=>yl(e,t);function Ul(){if(typeof window>"u"||!window.localStorage)return vi;try{return window.localStorage.getItem(Pr)===li?li:vi}catch{return vi}}function Hl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Pr,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function ha(e){const t=e===li?li:vi;return Qi=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),Hl(t),Qi}function Wr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Or,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function Ci(e){return Zt=!!e,S&&(S.classList.toggle("is-center-mode",Zt),S.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",Zt)}),S.querySelectorAll(".tile-add").forEach(t=>{t.hidden=Zt,t.tabIndex=Zt?-1:0,t.setAttribute("aria-hidden",Zt?"true":"false")})),J&&(jo(),Kn()),Zt}function Fl(){if(typeof window>"u"||!window.localStorage)return Ci(Ro);try{const e=window.localStorage.getItem(Or);return e==null?Ci(Ro):Ci(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),Ci(Ro)}}function jr(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Jr(e){const t=i=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(i||"");if(!Array.isArray(e))return to();const n=e.map(i=>({name:((i==null?void 0:i.name)||"").toString().trim()||"Custom",value:((i==null?void 0:i.value)||"").toString().trim()})).filter(i=>t(i.value));return n.length?n:to()}function to(){return[{name:"Black",value:an.color.ink},{name:"White",value:an.color.white},{name:"Red",value:an.blockscape.revdep},{name:"Green",value:an.color.success}]}function Wl(){if(typeof window>"u"||!window.localStorage)return to();try{const e=window.localStorage.getItem(Rr);if(!e)return to();const t=JSON.parse(e);return Jr(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),to()}}function jl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Rr,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function xi(e,{silent:t=!1}={}){return Ft=Jr(e),jl(Ft),!t&&typeof Ui=="function"&&Ui(Ft),_i==null||_i(),Ft}function Jl(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),i=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||i&&["1","true","yes","on"].includes(i.toLowerCase())}function Oo(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const i=ui(e);if(!i)return;const o=y[b],a=ui(o==null?void 0:o.sourcePath),s=t??(a&&a===i?mt(o):null),d=n??(a&&a===i?K:null),f=i.split("/").filter(Boolean).map(x=>encodeURIComponent(x)),g=s?encodeURIComponent(s):null,w=d?encodeURIComponent(d):null;try{const x=new URL(window.location.href),$=new URLSearchParams(x.search);$.delete("load"),$.delete("share");const A=["","server",...f,...g?[g]:[],...w?[w]:[]].join("/").replace(/\/+/g,"/");x.pathname=A,x.search=$.toString()?`?${$.toString()}`:"",x.hash="",window.history.replaceState({},document.title,x.toString())}catch(x){console.warn("[Blockscape] failed to update URL for server path",x)}}function zl(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),i=n.findIndex(O=>O.toLowerCase()==="server");if(i===-1)return null;const o=n.slice(i+1);if(!o.length)return null;const a=o.findIndex(O=>O.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=o.slice(0,a+1),d=o.slice(a+1),f=O=>{try{return decodeURIComponent(O)}catch{return O}},g=s.map(f),w=d.map(f),x=g.join("/"),$=ui(x);if(!$)return null;const A=w[0]?w[0].trim():null,N=w[1]?w[1].trim():null;return{path:$,modelId:A||null,itemId:N||null}}function ga({itemId:e}={}){const t=y[b];t!=null&&t.sourcePath&&Oo(t.sourcePath,{modelId:mt(t),itemId:e===void 0?K:e})}function ql(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function Gl(){const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(I,W={}){console.log("[Blockscape][local-backend]",I,{...e(),...W})}if(ql())return t("Disabled on github.io host"),ge&&(ge.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!Jl()||!ge||!Ke)return t("Opt-in flag missing or panel unavailable"),ge&&(ge.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!ge||!Ke)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let i=!1,o="",a=[],s=[],d="",f=new Map,g=O(),w=Ne(),x=null,$=!1;const A=new Set;function N(){return A.size>0}function O(){if(typeof window>"u"||!window.localStorage)return!0;try{const I=window.localStorage.getItem(Lr);return I==null?!0:I==="true"}catch{return!0}}function le(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Lr,I?"true":"false")}catch(W){console.warn("[Blockscape] auto-reload: failed to persist",W)}}function Ne(){if(typeof window>"u"||!window.localStorage)return Xi;try{const I=window.localStorage.getItem(Nr);if(!I)return Xi;const W=parseInt(I,10);return we(W)}catch{return Xi}}function st(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Nr,String(I))}catch(W){console.warn("[Blockscape] auto-reload: failed to persist interval",W)}}function we(I){return Number.isFinite(I)?Math.min(Br,Math.max(Mr,I)):Xi}function xe(I){if(!I)return"";const W=I.split("/").filter(Boolean);return W.pop(),W.join("/")}function et(I,{error:W=!1}={}){Ke.textContent=I,Ke.style.color=W?an.color.dangerStrong:"",t("Status",{text:I,error:W})}function Ue(I){return ui(I)}function ut(I){const W=Uo(I);return W?{payload:W,isSeries:!0}:{payload:I==null?void 0:I.data,isSeries:!1}}function Ot(){var W;if(b>=0&&((W=y[b])!=null&&W.sourcePath))return y[b].sourcePath;if(b<0)return"blockscape.bs";const I=ze(y[b])||"blockscape";return`${gn(I,"blockscape")}.bs`}function pt(){var I;We&&(We.placeholder=Ot(),(I=y[b])!=null&&I.sourcePath&&(We.value=y[b].sourcePath))}function Xe(){if(!Pe)return;Pe.innerHTML="";const I=document.createElement("option");I.value="",I.textContent="All (~/blockscape)",Pe.appendChild(I),s.forEach(oe=>{const ae=document.createElement("option");ae.value=oe,ae.textContent=oe||"(root)",Pe.appendChild(ae)});const W=s.includes(d)?d:"";Pe.value=W,d=W}function kt(){if(!ke)return;ke.innerHTML="";const I=d?a.filter(W=>W.path.startsWith(`${d}/`)):a;if(!I.length){const W=document.createElement("option");W.disabled=!0,W.textContent="No .bs files found yet",ke.appendChild(W),ke.disabled=!0;return}ke.disabled=!1,I.forEach(W=>{const oe=document.createElement("option");oe.value=W.path;const ae=W.mtimeMs?new Date(W.mtimeMs).toLocaleString():"";oe.textContent=ae?`${W.path} · ${ae}`:W.path,ke.appendChild(oe)}),o&&Array.from(ke.options).forEach(W=>{W.value===o&&(W.selected=!0)}),!ke.value&&ke.options.length&&(ke.options[0].selected=!0)}function qt(I){if(!i||!ke||!I||!a.find(tt=>tt.path===I))return;const oe=xe(I);oe!==d&&(d=oe,Xe()),kt(),Array.from(ke.options).forEach(tt=>{tt.selected=tt.value===I});const ae=Array.from(ke.options).find(tt=>tt.value===I);ae!=null&&ae.scrollIntoView&&ae.scrollIntoView({block:"nearest"}),We&&(We.value=I)}function ct(){x&&(clearInterval(x),x=null)}function Pt(){ct(),!(!i||!g||N())&&(x=setInterval(Qt,w))}function xn(I){if(!I)return;const W=A.size;A.add(I),A.size!==W&&(t("Auto-reload paused",{reason:I}),Pt())}function wn(I){if(!I)return;A.delete(I)&&(t("Auto-reload resumed",{reason:I}),Pt())}async function Gt(I){const W=y.findIndex(oe=>oe.sourcePath===I);if(W!==-1)try{const oe=await fetch(`/api/file?path=${encodeURIComponent(I)}`,{cache:"no-store"});if(!oe.ok)throw new Error(`HTTP ${oe.status}`);const ae=await oe.json(),tt=JSON.stringify(ae.data??ae,null,2),_t=Pn(tt,I,{seriesTitleOverride:`${I} series`});if(!_t.length)return;const ue=_t[0];if(ue.sourcePath=I,_n(ue,{titleHint:ze(y[W]),idHint:mt(y[W])}),ue.isSeries){const ot=ue.title||ze(ue)||ze(y[W]),tn=gn(ot||"unknown");pi(ue,tn),Nt(ue,{seriesName:ot||"unknown",fallbackTitle:"unknown"})}y[W]={...y[W],...ue,title:ue.title||ze(ue),data:ue.data,sourcePath:I},W===b?(Rt(),Lt()):On(),console.log("[Blockscape] auto-reloaded model from",I)}catch(oe){console.warn("[Blockscape] auto-reload failed for",I,oe)}}async function Qt(){if(!(!i||!g||N()||$)){$=!0;try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);const oe=((await I.json()).files||[]).slice().sort((ue,ot)=>{const tn=(ue==null?void 0:ue.mtimeMs)||0,Hn=(ot==null?void 0:ot.mtimeMs)||0;return tn===Hn?(ue.path||"").localeCompare(ot.path||""):Hn-tn}),ae=new Map;oe.forEach(ue=>ae.set(ue.path,ue.mtimeMs||0));const tt=y.map((ue,ot)=>({path:ue.sourcePath,idx:ot})).filter(ue=>ue.path);for(const ue of tt){const ot=f.get(ue.path)||0;(ae.get(ue.path)||0)>ot&&await Gt(ue.path)}a=oe;const _t=new Set;a.forEach(ue=>_t.add(xe(ue.path))),s=Array.from(_t).filter(ue=>ue!=="").sort(),f=ae,Xe(),kt()}catch(I){console.warn("[Blockscape] auto-reload check failed",I)}finally{$=!1}}}function An(I){g=!!I,le(g),Pt()}function Qe(I){return w=we(I),st(w),Pt(),w}function en(I){i=!1,a=[],f=new Map,ct(),kt(),ge.hidden=!0,I&&et(I,{error:!0}),t("Panel hidden",{message:I})}async function Xn({silent:I=!1}={}){try{t("Health check start");const W=await fetch("/api/health",{cache:"no-store"});if(!W.ok)throw new Error(`HTTP ${W.status}`);const oe=await W.json();if(i=!!(oe!=null&&oe.ok),!i)throw new Error("Health check failed");return ge.hidden=!1,I||et(oe.root?`Local server ready (root: ${oe.root})`:"Local server ready"),t("Health check ok",{payload:oe}),!0}catch(W){return I||console.log("[Blockscape] local backend health failed",W),en("Local server unavailable"),!1}}async function yn(){if(i&&ke){et("Loading files…");try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);a=((await I.json()).files||[]).slice().sort((ae,tt)=>{const _t=(ae==null?void 0:ae.mtimeMs)||0,ue=(tt==null?void 0:tt.mtimeMs)||0;return _t===ue?(ae.path||"").localeCompare(tt.path||""):ue-_t});const oe=new Set;a.forEach(ae=>{oe.add(xe(ae.path))}),s=Array.from(oe).filter(ae=>ae!=="").sort(),d&&!oe.has(d)&&(d=""),!d&&o&&(d=xe(o)),f=new Map(a.map(ae=>[ae.path,ae.mtimeMs||0])),Xe(),kt(),et(a.length?`Browsing ${a.length} file(s) in ~/blockscape`:"No .bs files in ~/blockscape yet")}catch(I){console.warn("[Blockscape] local backend refresh failed",I),en("Local server unavailable")}}}async function Na(){i=!1,en(),et("Checking for local server…");try{return t("Detect start"),await Xn()?(pt(),await yn(),Pt(),!0):!1}catch(I){return i=!1,console.log("[Blockscape] local backend not detected",I),t("Detect failed",{err:I}),!1}}async function qo(){if(!i||!ke)return;const I=Array.from(ke.selectedOptions||[]).map(oe=>oe.value).filter(Boolean).sort((oe,ae)=>oe.localeCompare(ae));if(!I.length){alert("Select one or more files to load from ~/blockscape.");return}let W=null;for(const oe of I)try{et(`Loading ${oe}…`);const ae=await zr(oe);W==null&&(W=(ae==null?void 0:ae.firstIndex)??null),o=oe,Oo(oe)}catch(ae){console.error("[Blockscape] failed to load from local server",ae),alert(`Local load failed for ${oe}: ${ae.message}`)}W!=null&&It(W),et(`Loaded ${I.length} file(s)`),kt()}async function so(I,{statusPrefix:W="Saved to",updateInput:oe=!0}={}){if(!i)return;if(b<0){alert("No active model to save.");return}const ae=y[b],{payload:tt,isSeries:_t}=ut(ae);if(!tt){alert("No model data to save.");return}const ue=Ue(I);if(!ue){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const ot=JSON.stringify(tt,null,2);et(`Saving ${_t?"series":"map"} to ${ue}…`);const Hn=await fetch(`/api/file?path=${encodeURIComponent(ue)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:ot});if(!Hn.ok)throw new Error(`HTTP ${Hn.status}`);const nn=await Hn.json();o=nn.path||ue,ae.sourcePath=nn.path||ue,oe&&We&&(We.value=nn.path||ue),Oo(nn.path||ue),et(`${W} ${nn.path||ue}`),await yn()}catch(ot){console.error("[Blockscape] local save failed",ot),alert(`Local save failed: ${ot.message}`),en("Local server unavailable")}}async function lo(){var W;const I=Ue(We==null?void 0:We.value)||Ue((W=y[b])==null?void 0:W.sourcePath)||Ot();if(!I){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await so(I,{statusPrefix:"Saved to"})}async function co(){var ae;if(!i)return;if(b<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const I=Ue((ae=y[b])==null?void 0:ae.sourcePath)||Ot(),W=window.prompt("Save active map as (under ~/blockscape):",I);if(W==null)return;const oe=Ue(W);if(!oe){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await so(oe,{statusPrefix:"Saved to"})}async function uo(I,W,{refreshAfter:oe=!0,statusPrefix:ae="Saved to"}={}){if(!i)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(I)||I<0)return{ok:!1,error:"Invalid model index"};const tt=y[I],{payload:_t,isSeries:ue}=ut(tt);if(!_t)return{ok:!1,error:"Model has no data"};const ot=Ue(W)||Ue(tt==null?void 0:tt.sourcePath)||Ot();if(!ot)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const tn=JSON.stringify(_t,null,2);et(`Saving ${ue?"series":"map"} to ${ot}…`);const nn=await fetch(`/api/file?path=${encodeURIComponent(ot)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:tn});if(!nn.ok)throw new Error(`HTTP ${nn.status}`);const on=await nn.json();return o=on.path||ot,tt.sourcePath=on.path||ot,I===b&&pt(),et(`${ae} ${on.path||ot}`),oe&&await yn(),{ok:!0,path:on.path||ot}}catch(tn){return console.error("[Blockscape] local save failed",tn),en("Local server unavailable"),{ok:!1,error:tn.message}}}if(Ye&&(Ye.onclick=()=>yn()),He&&(He.onclick=()=>qo()),it&&(it.onclick=()=>lo()),wt&&(wt.onclick=()=>co()),ke&&We&&(ke.addEventListener("change",()=>{const I=Array.from(ke.selectedOptions||[])[0];I!=null&&I.value&&(We.value=I.value)}),ke.addEventListener("dblclick",()=>{qo()})),Pe&&Pe.addEventListener("change",()=>{d=Pe.value||"",kt()}),ge){const I="local-files-panel-focus",W="local-files-panel-pointer";let oe=!1,ae=!1;ge.addEventListener("focusin",()=>{oe||(oe=!0,xn(I))}),ge.addEventListener("focusout",tt=>{if(!oe)return;const _t=tt.relatedTarget;_t&&ge.contains(_t)||(oe=!1,wn(I))}),ge.addEventListener("pointerenter",()=>{ae||(ae=!0,xn(W))}),ge.addEventListener("pointerleave",()=>{ae&&(ae=!1,wn(W))})}return{detect:Na,refresh:yn,updateActiveSavePlaceholder:pt,isAvailable:()=>i,highlightSource:qt,saveModelByIndex:uo,getAutoReloadConfig:()=>({enabled:g,intervalMs:w,available:i}),setAutoReloadEnabled:An,setAutoReloadInterval:Qe}}async function zr(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const i=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);const o=await i.json(),a=JSON.stringify(o.data??o,null,2),s=Pn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let d=null;return s.forEach((f,g)=>{if(f.sourcePath=e,f.isSeries&&!f.title){const $=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");f.title=$}const w=Cn(f,{versionLabel:s.length>1?`${t} #${g+1}`:t});d==null&&(d=w)}),{firstIndex:d,total:s.length}}async function qr(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function Kl(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function zt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function ui(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function Yl(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Xl(e,t){const n=ui(e);if(!n)return null;const i=n.split("/"),s=`${(i.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...i,s].filter(Boolean).join("/")}function ba(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function no(){try{await Hr}catch{}return typeof(Je==null?void 0:Je.isAvailable)=="function"?Je.isAvailable():!1}async function Zl(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Ql(e,t){const n=ui(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const i=n.split("/"),a=(i.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const d=`${a}-${s}.bs`,f=[...i,d].filter(Boolean).join("/");if(!t.has(f))return f}return null}function ec(e,t="clipboard"){const n=ze(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",i=zt(n),o=ba();return`${i}-${o}.bs`}function tc(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=Yl(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const i=gn(n||"unknown");return pi(e,i),Nt(e,{seriesName:n,fallbackTitle:n}),!0}function nc(e){return Number.isFinite(e)?Math.min(lt,Math.max(Ve,e)):re}function Wt(){if(!S)return;const e=!!K||!!je;S.classList.toggle("blockscape-has-selection",e),S.classList.toggle("blockscape-has-item-selection",!!K)}function Ai(e){return wi=nc(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",wi),wi}function ic(e){return Number.isFinite(e)?Math.min(De,Math.max($t,e)):Bt}function Ti(e){Mn=ic(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Mn);const t=Bn?Mn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Mn}function oc(e){return Number.isFinite(e)?Math.min(Cr,Math.max(_r,e)):Yi}function Li(e){return yi=oc(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",yi),yi}function ac(e){return Number.isFinite(e)?Math.min(dn,Math.max(In,e)):yt}function Ni(e){return Ei=ac(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",Ei),Ei}function rc(e){return Number.isFinite(e)?Math.min(pa,Math.max(si,e)):kn}function Mi(e){return Si=rc(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Si),Si}function Bi(e){const t=e==="nowrap"?"nowrap":"wrap";ma=t;const n=t==="nowrap"?"nowrap":"normal",i=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",i),t}function Gr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(de,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function sc(){if(typeof window>"u"||!window.localStorage)return Ai(re);try{const e=window.localStorage.getItem(de);if(!e)return Ai(re);const t=parseFloat(e);return Ai(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Ai(re)}}function Kr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Z,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function lc(){if(typeof window>"u"||!window.localStorage)return Ti(Bt);try{const e=window.localStorage.getItem(Z);if(!e)return Ti(Bt);const t=parseFloat(e);return Ti(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Ti(Bt)}}function $i(e){Bn=!!e;const t=Bn?Mn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),S&&S.classList.toggle("blockscape-dimming-disabled",!Bn),Bn}function Yr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Le,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function cc(){if(typeof window>"u"||!window.localStorage)return $i(!0);try{const e=window.localStorage.getItem(Le);return e==null?$i(!0):$i(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),$i(!0)}}function Ri(e){return ci=!!e,ci}function Xr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem($r,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function dc(){if(typeof window>"u"||!window.localStorage)return Ri(Bo);try{const e=window.localStorage.getItem($r);return e==null?Ri(Bo):Ri(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Ri(Bo)}}function Zr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(kr,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function uc(){if(typeof window>"u"||!window.localStorage)return Li(Yi);try{const e=window.localStorage.getItem(kr);if(!e)return Li(Yi);const t=parseFloat(e);return Li(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Li(Yi)}}function Qr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(cn,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function pc(){if(typeof window>"u"||!window.localStorage)return Ni(yt);try{const e=window.localStorage.getItem(cn);if(!e)return Ni(yt);const t=parseFloat(e);return Ni(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Ni(yt)}}function es(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(rt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function fc(){if(typeof window>"u"||!window.localStorage)return Mi(kn);try{const e=window.localStorage.getItem(rt);if(!e)return Mi(kn);const t=parseFloat(e);return Mi(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Mi(kn)}}function ts(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(gt,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function mc(){if(typeof window>"u"||!window.localStorage)return Bi(St);try{const e=window.localStorage.getItem(gt);return Bi(e||St)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Bi(St)}}function hc(e){return Number.isFinite(e)?Math.min(Ur,Math.max(Dr,e)):eo}function Oi(e){return $n=hc(e),$n}function gc(e){bn=!!e}function bc(e){Ut=!!e}function ns(){return{hoverScale:wi,selectionDimOpacity:Mn,selectionDimEnabled:Bn,tileCompactness:yi,titleWrapMode:ma,titleHoverWidthMultiplier:Ei,titleHoverTextPortion:Si,obsidianLinksEnabled:Ii,obsidianLinkMode:Zi,obsidianVaultName:ki,autoIdFromNameEnabled:ci,seriesNavDoubleClickWaitMs:$n,showSecondaryLinks:bn,centerItems:Zt,showReusedInMap:Ut,theme:Qi,colorPresets:Ft}}function vc(e,{refreshObsidianLinks:t}={}){return wl(e,{applyTileHoverScale:Ai,persistTileHoverScale:Gr,applySelectionDimEnabled:$i,persistSelectionDimEnabled:Yr,applySelectionDimOpacity:Ti,persistSelectionDimOpacity:Kr,applyTileCompactness:Li,persistTileCompactness:Zr,applyTitleWrapMode:Bi,persistTitleWrapMode:ts,applyTitleHoverWidthMultiplier:Ni,persistTitleHoverWidthMultiplier:Qr,applyTitleHoverTextPortion:Mi,persistTitleHoverTextPortion:es,applyObsidianLinksEnabled:Vi,persistObsidianLinksEnabled:as,applyObsidianLinkMode:Pi,persistObsidianLinkMode:os,applyObsidianVaultName:Di,persistObsidianVaultName:rs,applyAutoIdFromNameEnabled:Ri,persistAutoIdFromNameEnabled:Xr,applySeriesNavDoubleClickWait:Oi,persistSeriesNavDoubleClickWait:is,localBackend:Je,ui:_e,refreshObsidianLinks:t,scheduleOverlaySync:Fi,selection:K,select:Tt,clearStyles:zo,drawLinks:Kn,applyReusedHighlights:Ta,setShowSecondaryLinks:gc,setShowReusedInMap:bc,applyTheme:ha,setColorPresets:xi,applyCenterItems:Ci,persistCenterItems:Wr,current:ns()})}function is(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Vr,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function wc(){if(typeof window>"u"||!window.localStorage)return Oi(eo);try{const e=window.localStorage.getItem(Vr);if(!e)return Oi(eo);const t=parseInt(e,10);return Oi(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Oi(eo)}}function yc(e){return e===No?No:fa}function Pi(e){return Zi=yc(e),Zi}function os(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ar,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function Ec(){if(typeof window>"u"||!window.localStorage)return Pi(Mo);try{const e=window.localStorage.getItem(Ar);return Pi(e||Mo)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Pi(Mo)}}function Vi(e){return Ii=!!e,Ii}function as(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(xr,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function Sc(){if(typeof window>"u"||!window.localStorage)return Vi(!1);try{const e=window.localStorage.getItem(xr);return e==null?Vi(!1):Vi(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Vi(!1)}}function Di(e){return ki=(e??"").toString().trim(),ki}function rs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Tr,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Ic(){if(typeof window>"u"||!window.localStorage)return Di("");try{const e=window.localStorage.getItem(Tr);return Di(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Di("")}}function kc(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function _c(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const i=n.find(a=>a&&typeof a=="object")||n[0];return((i==null?void 0:i.title)??"").toString().trim()||`${t} series`}function pi(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function Cc(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||Vo(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const i=n.trim();if(!i)return!1;const o=jn(e,{seriesName:i,fallbackTitle:i})||gn(i,i),a=window.prompt("Series ID (used for linking and downloads)",o);if(a==null)return!1;const s=gn(a.trim()||i,i||"series");return e.title=i,e.apicurioArtifactName=i,pi(e,s),!0}function va(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(i=>va(i)).join(",")}]`:`{${Object.keys(e).sort().map(i=>`${JSON.stringify(i)}:${va(e[i])}`).join(",")}}`}function ss(e){try{return va(e)}catch{return""}}function Po(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=ss(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=ss(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const xc=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function _n(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const i=(e.title??"").toString().trim();e.title=i||t||"Untitled Model";const o=(e.id??"").toString().trim();if(o)e.id=o;else{const a=n||e.title||t||"model",s=zt(a).replace(/\./g,"-");e.id=s||`model-${di()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function Ac(e){return JSON.parse(JSON.stringify(e))}function ze(e,t="Untitled Model"){var i;return e&&(((i=e.data)==null?void 0:i.title)??e.title??"").toString().trim()||t}function Vo(e,t="Untitled Model"){var i;if(((i=e==null?void 0:e.apicurioVersions)==null?void 0:i.length)>1||(e==null?void 0:e.isSeries)){const o=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(o)return o;const a=mt(e);return a?`${a} series`:t}return ze(e,t)}function mt(e){var o;const t=jn(e);if(t)return t;const n=(o=e==null?void 0:e.data)==null?void 0:o.id;return n&&n.toString().trim()||null}function ls(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function Tc(e){return e?e.toString().replace(/-series$/i,""):null}function wa(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<y.length;n++){const i=(mt(y[n])||"").toLowerCase(),o=(ls(y[n])||"").toLowerCase();if(t===i||t===o)return n}return-1}function cs(e){var d;if(e<0||e>=y.length||!p)return!0;const t=y[e],n=(p.value||"").trim();if(!n)return!0;let i;try{i=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}_n(i,{titleHint:ze(t),idHint:mt(t)});const o=Po(t.data),a=Po(i);if(o===a)return!0;t.data=i;const s=Vn(t);return s>=0&&((d=t.apicurioVersions)!=null&&d[s])&&(t.apicurioVersions[s].data=i),!0}function ds(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(i=>{i!=null&&i.id&&t.add(i.id)})),t}function ya(e){if(b<0||!e)return null;const t=y[b].data,n=(t==null?void 0:t.categories)||[];for(const i of n){const a=(i.items||[]).find(s=>s.id===e);if(a)return{category:i,item:a,modelData:t}}return null}function Lc(e,t){const n=ya(e);return n?(t?n.item.color=t:delete n.item.color,Rt(),Lt(),Tt(e),!0):!1}function Nc(e,t){const n=ds(t);let i=zt(e||"item");if(!n.has(i))return i;const o=()=>di().slice(0,4);for(;n.has(i);)i=`${zt(e||"item")}-${o()}`;return i}function Mc(e="category",t){const n=(t==null?void 0:t.categories)||[],i=zt(e||"category"),o=d=>n.some(f=>f.id===d);let a=i||`category-${di()}`;if(!o(a))return a;let s=n.length+1;for(;o(`${i}-${s}`);)s+=1;return`${i}-${s}`}const fi=gl({findItemAndCategoryById:ya,collectAllItemIds:ds,updateItemReferences:hl,loadActiveIntoEditor:Rt,rebuildFromActive:Lt,select:e=>Tt(e),onSelectionRenamed:(e,t)=>{var n;K===e&&(K=t,Wt()),((n=vt==null?void 0:vt.item)==null?void 0:n.id)===e&&(vt.item.id=t)},makeSlug:zt,isAutoIdFromNameEnabled:()=>ci});function Bc({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:i,onCategoryRenamed:o}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=N=>{if(a.fields.errorEl){if(!N){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=N}},d=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},f=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var N,O;(N=a.fields.titleInput)==null||N.focus(),(O=a.fields.titleInput)==null||O.select()}))},g=({force:N}={})=>{var le,Ne;if(!ci||!a.autoSyncEnabled||!((le=a.fields)!=null&&le.idInput)||!((Ne=a.fields)!=null&&Ne.titleInput)||!N&&a.idManuallyEdited)return;const O=zt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=O},w=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const N=a.modelData.categories||[],O=N.find(xe=>xe.id===a.categoryId);if(!O)throw new Error("Category not found.");const le=(a.fields.idInput.value||"").trim();if(!le)throw new Error("ID is required.");const Ne=(a.fields.titleInput.value||"").trim();if(N.some(xe=>xe.id===le&&xe.id!==O.id))throw new Error("Another category already uses that ID.");const we=O.id;return O.id=le,O.title=Ne||O.id,we!==le&&typeof o=="function"&&o(we,le),t(),n(),i(le,{scrollIntoView:!0}),!0},x=()=>{try{return w(),d(),!0}catch(N){return console.warn("[CategoryEditor] save failed",N),s((N==null?void 0:N.message)||"Unable to save category."),!1}},$=()=>{if(a.wrapper)return a.wrapper;const N=document.createElement("div");N.className="item-editor-modal category-editor-modal",N.hidden=!0,N.setAttribute("role","dialog"),N.setAttribute("aria-modal","true");const O=document.createElement("div");O.className="item-editor-modal__backdrop",N.appendChild(O);const le=document.createElement("div");le.className="item-editor",N.appendChild(le);const Ne=document.createElement("div");Ne.className="item-editor__header";const st=document.createElement("h2");st.className="item-editor__title",st.textContent="Edit category";const we=document.createElement("button");we.type="button",we.className="item-editor__close",we.setAttribute("aria-label","Close category editor"),we.textContent="×",Ne.appendChild(st),Ne.appendChild(we),le.appendChild(Ne);const xe=document.createElement("form");xe.className="item-editor__form",le.appendChild(xe);const et=document.createElement("div");et.className="item-editor__meta",et.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',xe.appendChild(et);const Ue=document.createElement("div");Ue.className="item-editor__error",Ue.hidden=!0,xe.appendChild(Ue);const ut=(Qt,An,Qe)=>{const en=document.createElement("label");en.className="item-editor__field";const Xn=document.createElement("span");if(Xn.className="item-editor__label",Xn.textContent=Qt,en.appendChild(Xn),An.classList.add("item-editor__control"),en.appendChild(An),Qe){const yn=document.createElement("div");yn.className="item-editor__hint",yn.textContent=Qe,en.appendChild(yn)}return en},Ot=document.createElement("input");Ot.type="text",xe.appendChild(ut("Title",Ot,"Display label shown in the map."));const pt=document.createElement("input");pt.type="text",pt.required=!0,xe.appendChild(ut("ID",pt,"Unique identifier for this category (used in URLs and references)."));const Xe=document.createElement("div");Xe.className="item-editor__checkbox";const kt=document.createElement("label");kt.className="item-editor__checkbox-row";const qt=document.createElement("input");qt.type="checkbox";const ct=document.createElement("span");ct.textContent="Sync ID while editing title";const Pt=document.createElement("div");Pt.className="item-editor__hint",Pt.textContent="Turn off to keep typing titles without changing the ID.",kt.append(qt,ct),Xe.append(kt,Pt),xe.appendChild(Xe);const xn=document.createElement("div");xn.className="item-editor__actions";const wn=document.createElement("button");wn.type="submit",wn.className="item-editor__action item-editor__action--primary",wn.textContent="Save";const Gt=document.createElement("button");return Gt.type="button",Gt.className="item-editor__action",Gt.textContent="Cancel",xn.appendChild(wn),xn.appendChild(Gt),xe.appendChild(xn),xe.addEventListener("submit",Qt=>{Qt.preventDefault(),x()}),Gt.addEventListener("click",d),we.addEventListener("click",d),O.addEventListener("click",d),pt.addEventListener("input",()=>{a.idManuallyEdited=!0}),Ot.addEventListener("input",()=>g()),qt.addEventListener("change",()=>{a.autoSyncEnabled=!!qt.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,g({force:!0}))}),N.addEventListener("keydown",Qt=>{Qt.key==="Escape"&&(Qt.preventDefault(),d())}),document.body.appendChild(N),a.wrapper=N,a.fields={titleInput:Ot,idInput:pt,errorEl:Ue,metaLabel:et.querySelector(".item-editor__meta-value"),syncCheckbox:qt},N};return{open:N=>{if(!N||!$())return!1;const le=e(),st=((le==null?void 0:le.categories)||[]).find(xe=>xe.id===N);if(!st)return!1;a.categoryId=st.id,a.modelData=le,a.idManuallyEdited=!1;const we=!!ci;return a.autoSyncEnabled=we,a.fields.metaLabel.textContent=st.title||st.id||"Category",a.fields.titleInput.value=st.title||st.id||"",a.fields.idInput.value=st.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!we,!a.fields.idInput.value&&we&&g({force:!0}),s(""),f(),!0},hide:d,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const $c=Bc({getActiveModelData:()=>{var e;return(e=y[b])==null?void 0:e.data},loadActiveIntoEditor:Rt,rebuildFromActive:Lt,selectCategory:(e,t={})=>Dn(e,t),onCategoryRenamed:(e,t)=>{je===e&&(je=t,Wt())}}),{handleTileContextMenu:Rc,hidePreview:Gn,handleDocumentClick:Oc,handleWindowResize:Pc,handleWindowScroll:Vc,updateColorPresets:Ui}=bl({menuEl:document.getElementById("tileContextMenu"),previewEl:ne,previewTitleEl:be,previewBodyEl:Se,previewActionsEl:nt,previewCloseEl:qe,escapeHtml:oo,onEditItem:e=>fi.open(e),onChangeColor:(e,t)=>Lc(e,t),selectItem:e=>Tt(e),colorPresets:Ft});function Do(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const i={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[i],e.apicurioActiveVersionIndex=0;const o=e.title||ze(e);return Nt(e,{seriesName:o,fallbackTitle:o}),e.isSeries=!0,e}function Dc({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=zt(`${e||"blank"}-${ba()}`),i={id:n,title:t,categories:[],links:[],abstract:""};return e&&(i.seriesId=e),_n(i,{titleHint:t,idHint:n}),i}function Uc(){const t=`Blank series ${ba()}`,n=gn(t,"blank-series"),i=Dc({seriesId:n,mapTitle:"Blank map"}),o={id:n,title:t,apicurioArtifactName:t,data:i,apicurioVersions:[{version:"1",data:i,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return pi(o,n),Nt(o,{seriesName:t,fallbackTitle:t}),o}function Hc(){const e=Uc(),t=Cn(e,{versionLabel:"blank"});return It(t),Ho(),Rn("Blank series created. Add categories and tiles to start.",2600),t}function Cn(e,{versionLabel:t,createdOn:n}={}){var f,g,w;if(e!=null&&e.isSeries||((f=e==null?void 0:e.apicurioVersions)==null?void 0:f.length)>1){const x=e.title||ze(e);Nt(e,{seriesName:x,fallbackTitle:x}),Fo(e)}const i=mt(e);if(!i)return Do(e,{versionLabel:t||"1",createdOn:n}),y.push(e),y.length-1;const o=y.findIndex(x=>mt(x)===i);if(o===-1)return Do(e,{versionLabel:t||"1",createdOn:n}),y.push(e),y.length-1;const a=y[o];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(w=(g=a.apicurioVersions)==null?void 0:g[0])==null?void 0:w.createdOn}],a.apicurioActiveVersionIndex=0;const x=a.title||ze(a);Nt(a,{seriesName:x,fallbackTitle:x})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=ze(e)||a.title,a.isSeries=!0;const d=a.title||ze(a);return Nt(a,{seriesName:d,fallbackTitle:d}),o}function us({versionLabel:e}={}){var s;if(b<0||!y[b])throw new Error("Load or select a model before creating a version.");const t=y[b];Do(t,{versionLabel:"1"});let n;try{n=Ac(t.data)}catch(d){throw console.warn("[Blockscape] failed to clone active model for versioning",d),new Error("Could not copy the current model.")}_n(n,{titleHint:ze(t),idHint:mt(t)||jn(t)});const o={version:e||String((((s=t.apicurioVersions)==null?void 0:s.length)||0)+1),data:n,createdOn:new Date().toISOString()};t.apicurioVersions.push(o),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=n,t.isSeries=!0;const a=t.title||ze(t);return Nt(t,{seriesName:a,fallbackTitle:a}),b}function Ea(){const e=b>=0&&y[b]?y[b]:null,t=mt(e);document.title=t?`${t}-blockscape`:Dt}function Uo(e){if(!e)return null;Fo(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||ze(e);return Nt(e,{seriesName:n,fallbackTitle:n}),t.filter((o,a)=>{var f;const s=((o==null?void 0:o.version)??"").toString().trim(),d=(((f=o==null?void 0:o.data)==null?void 0:f.id)??(o==null?void 0:o.id)??"").toString().trim();return o!=null&&o.isCategoryView||s.startsWith($o)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:d}),!1):!0}).map(o=>o&&typeof o=="object"&&"data"in o?o.data:o)}function Fc(){const e=y[b],t=Uo(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function ps(e="shortcut",t=!1){const n=p.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const i=y[b],o=t?Uo(i):null,a=!!o,s=a?JSON.stringify(o,null,2):n,d=jn(i),f=mt(i),g=d||f||ze(i,"blockscape"),w=a?"-series":"",x=`${zt(g)}${w}.bs`;return Fr(x,s),console.log(`[Blockscape] saved JSON (${e}):`,x),!0}const Wc=an.palette.letter,jc=an.palette.letterFallback;function fs(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Wc[n]||jc}function Jc(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(f=>f+f).join(""):t,i=parseInt(n,16),o=i>>16&255,a=i>>8&255,s=i&255;return .2126*Math.pow(o/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?an.color.ink:an.color.white}function zc(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function Sa(){if(At)return;At=document.createElement("div"),At.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",Ht=document.createElement("span"),Ht.className="series-nav-notice__text",At.appendChild(e),At.appendChild(Ht),document.body.appendChild(At)}function Ia(){Xt&&(clearTimeout(Xt),Xt=null),At&&At.classList.remove("is-visible"),Ht&&(Ht.textContent="")}function Hi(){Mt=null,rn&&(clearTimeout(rn),rn=null),Ia()}function ka(){Yt=null,sn&&(clearTimeout(sn),sn=null),Ia()}function qc(e,t){var i;if(!((i=e==null?void 0:e.apicurioVersions)!=null&&i[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function Gc(e,t,n){Sa(),Mt={id:e,targetVersionIndex:t},rn&&clearTimeout(rn),rn=setTimeout(()=>{rn=null,Hi()},$n);const i=qc(n,t);Rn(`Click again to open ${i} in this series.`,$n)}function Kc(e,t){Sa(),Yt={id:e,targetIndex:t},sn&&clearTimeout(sn),sn=setTimeout(()=>{sn=null,ka()},$n);const n=Vo(y[t]);Rn(`Click again to open "${n}".`,$n)}function Rn(e,t=Sn,n=null){if(Sa(),Ht.textContent="",Ht.appendChild(document.createTextNode(e)),n){const i=document.createTextNode(" "),o=document.createElement("a");o.href=n,o.target="_blank",o.rel="noopener",o.textContent=n,Ht.appendChild(i),Ht.appendChild(o)}At.classList.add("is-visible"),Xt&&clearTimeout(Xt),Xt=setTimeout(()=>Ia(),t)}function Yc(){ve&&(ve.innerHTML="",xc.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((o,a)=>{if(a>0){const d=document.createElement("span");d.className="shortcut-help__or",d.textContent="or",n.appendChild(d)}const s=document.createElement("div");s.className="shortcut-help__combo",o.forEach((d,f)=>{if(f>0){const w=document.createElement("span");w.className="shortcut-help__sep",w.textContent="+",s.appendChild(w)}const g=document.createElement("kbd");g.className="shortcut-help__key",g.textContent=d,s.appendChild(g)}),n.appendChild(s)});const i=document.createElement("div");i.className="shortcut-help__desc",i.textContent=e.description,t.appendChild(n),t.appendChild(i),ve.appendChild(t)}),Nn=!0)}function Xc(){return!!fe&&fe.hidden===!1}function Zc(){if(!fe)return;Nn||Yc(),ri=document.activeElement,fe.hidden=!1,fe.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=fe.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function _a(){if(!fe||fe.hidden)return;fe.hidden=!0,fe.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=ri;e!=null&&e.focus?e.focus({preventScroll:!0}):Ie!=null&&Ie.focus&&Ie.focus({preventScroll:!0})}function Qc(){if(!j)return;j.hidden=!1,j.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=j.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ho(){!j||j.hidden||(j.hidden=!0,j.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),pe!=null&&pe.focus&&pe.focus({preventScroll:!0}))}let Ca=!1;function Fi(){Ca||(Ca=!0,requestAnimationFrame(()=>{Ca=!1,jo(),Kn()}))}let ms=!1;function hs(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function ed(e){const t=hs(e);if(!t.length){S.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}S.querySelectorAll(".tile").forEach(n=>{var s;const i=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),o=(n.dataset.id||"").toLowerCase(),a=t.every(d=>i.includes(d)||o.includes(d));n.style.opacity=a?"1":"0.2"})}function td(e){const t=hs(e);if(!t.length)return[];const n=[];return y.forEach((i,o)=>{var g;const a=Vo(i),s=mt(i)||"",d=`${a} ${s}`.toLowerCase();t.every(w=>d.includes(w))&&n.push({type:"model",modelIndex:o,modelTitle:a,modelId:s}),(Array.isArray((g=i.data)==null?void 0:g.categories)?i.data.categories:[]).forEach(w=>{const x=(w.title||w.id||"").toString();(w.items||[]).forEach($=>{const A=($.name||$.id||"").toString(),N=`${A} ${$.id||""} ${x}`.toLowerCase();t.every(O=>N.includes(O))&&n.push({type:"item",modelIndex:o,modelTitle:a,modelId:s,itemId:$.id,itemName:A,categoryTitle:x})})})}),n.slice(0,z)}function gs(e){if(!he)return;he.innerHTML="";const t=(e||"").toString();if(!t.trim()){he.hidden=!0;return}if(!y.length){const i=document.createElement("div");i.className="search-results__empty",i.textContent="Load models to search",he.appendChild(i),he.hidden=!1;return}const n=td(t);if(!n.length){const i=document.createElement("div");i.className="search-results__empty",i.textContent="No matches yet",he.appendChild(i),he.hidden=!1;return}n.forEach(i=>{const o=document.createElement("button");o.type="button",o.className="search-result",o.dataset.modelIndex=String(i.modelIndex),i.itemId&&(o.dataset.itemId=i.itemId),i.type&&(o.dataset.type=i.type),i.modelIndex===b&&(!i.itemId||K===i.itemId)&&o.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=i.type==="model"?i.modelTitle:i.itemName||i.itemId||"Item",a.appendChild(s);const d=document.createElement("span");d.className="search-result__badge",d.textContent=i.type==="item"?i.categoryTitle||"Item":"Model",a.appendChild(d);const f=document.createElement("div");f.className="search-result__meta";const g=document.createElement("span");if(g.textContent=i.modelId?`${i.modelTitle} · ${i.modelId}`:i.modelTitle,f.appendChild(g),i.type==="item"&&i.itemId){const w=document.createElement("span");w.textContent=`Item ID: ${i.itemId}`,f.appendChild(w)}else if(i.type==="model"){const w=document.createElement("span");w.textContent="Matches model title",f.appendChild(w)}o.appendChild(a),o.appendChild(f),he.appendChild(o)}),he.hidden=!1}function bs(e){ed(e||""),gs(e||"")}function nd(e){!e||!Number.isInteger(e.modelIndex)||(It(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(b!==e.modelIndex)return;const t=(n=Ce.get(e.itemId))==null?void 0:n.el;t&&(Tt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function It(e){var t;if(Gn(),Hi(),vt=null,vn=null,je=null,at=null,e<0||e>=y.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(u=!0,b=e,console.log("[Blockscape] active model:",ze(y[e]),"(index",e+" )"),typeof(Je==null?void 0:Je.highlightSource)=="function"){const n=((t=y[e])==null?void 0:t.sourcePath)||null;Je.highlightSource(n)}Ea(),On(),Rt(),Lt(),me&&bs(me.value||""),Je.updateActiveSavePlaceholder(),$e.updateAvailability(),ga()}function On(){if(Y.innerHTML="",!y.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",Y.appendChild(e);return}y.forEach((e,t)=>{var x;const n=document.createElement("li");n.className="model-nav-item";const i=document.createElement("button");i.type="button",i.className="model-nav-button"+(t===b?" is-active":""),i.dataset.index=String(t),i.setAttribute("aria-current",t===b?"true":"false");const o=document.createElement("span");o.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=Vo(e),o.appendChild(a);const s=Tc(ls(e)||mt(e));if(s){const $=document.createElement("span");$.className="model-nav-id",$.textContent=s,o.appendChild($)}const d=Array.isArray((x=e.data)==null?void 0:x.categories)?e.data.categories:[],f=d.reduce(($,A)=>$+(A.items||[]).length,0),g=document.createElement("span");g.className="model-nav-meta";const w=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";g.textContent=`${d.length} cat · ${f} items${w}`,i.appendChild(o),i.appendChild(g),n.appendChild(i),Y.appendChild(n)}),$e.updateAvailability()}function Rt(){if(b<0){p.value="",M&&(M.disabled=!0);return}const e=y[b];p.value=JSON.stringify(e.data,null,2),M&&(M.disabled=!Uo(e))}function id(e){try{return JSON.parse(e)}catch{return null}}function vs(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function od(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,d)=>{const f=s==null?void 0:s.data;if(!f||!Array.isArray(f.categories))return;const g=ze(f,`Map ${d+1}`),w=(f.id??"").toString().trim()||zt(g||`map-${d+1}`),x=zt(w||g||`map-${d+1}`);f.categories.forEach($=>{const A=(($==null?void 0:$.id)??"").toString().trim();if(!A)return;n.has(A)||n.set(A,{catTitle:$.title||A,sources:[]});const N=n.get(A);!N.catTitle&&($.title||A)&&(N.catTitle=$.title||A),N.sources.push({category:$,mapId:w,mapTitle:g,mapSlug:x,versionIndex:d})})});const i=jn(e)||null,o=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||ze(e,"Series"),a=[];return n.forEach((s,d)=>{var $;if(((($=s.sources)==null?void 0:$.length)||0)<2)return;const f=s.catTitle||d,g=new Set,w=s.sources.map(A=>{var st;let O=A.mapSlug||zt(A.mapTitle||A.mapId)||`map-${A.versionIndex+1}`;g.has(O)&&(O=`${O}-${A.versionIndex+1}`),g.add(O);const le=new Map,Ne=(((st=A.category)==null?void 0:st.items)||[]).map((we,xe)=>{const et=((we==null?void 0:we.id)??"").toString().trim()||`item-${xe+1}`,Ue=`${O}-${et}`;le.set(et,Ue);const ut={...we,id:Ue};return ut.deps=Array.isArray(we==null?void 0:we.deps)?[...we.deps]:[],ut});return Ne.forEach(we=>{we.deps=(we.deps||[]).map(xe=>le.get(xe)).filter(Boolean)}),{id:O,title:A.mapTitle||A.mapId||`Map ${A.versionIndex+1}`,items:Ne}}),x={id:zt(`${d}-category-view`),title:f,abstract:`Items from "${f}" across ${s.sources.length} maps in this series${o?` (${o})`:""}.`,categories:w,links:[]};i&&(x.seriesId=i),_n(x,{titleHint:f,idHint:`${i||"series"}-${d}`}),a.push({version:`${$o}${d}`,data:x,isCategoryView:!0,categoryViewKey:d})}),a}function ws(e){var i;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${$o}${e.categoryViewKey}`;const t=(((i=e.data)==null?void 0:i.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function Fo(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=ws(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(d=>!(d!=null&&d.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Vn(e),e.apicurioVersions.length-1));const d=e.apicurioVersions[e.apicurioActiveVersionIndex];return d!=null&&d.data&&(e.data=d.data),e}const i=od({...e,apicurioVersions:n});e.apicurioVersions=[...n,...i];let o=e.apicurioVersions.findIndex(d=>ws(d)===t);o===-1&&(o=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(o,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function ad(e,t="Pasted",n={}){const i=Array.isArray(e)?e:[];if(!i.length)return[];const o=i.map((w,x)=>!w||typeof w!="object"?null:(_n(w,{titleHint:`${t} #${x+1}`}),{obj:w,idx:x})).filter(Boolean);if(!o.length)return[];const a=o[0].obj,{seriesTitleOverride:s}=n;let d=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const f={id:di(),title:d,data:a,apicurioVersions:o.map(({obj:w,idx:x})=>({version:String(x+1),data:w})),apicurioActiveVersionIndex:0,isSeries:!0},g=Nt(f,{seriesName:d,fallbackTitle:d});return g&&(f.id=g),Fo(f),[f]}function ys(e,t="Pasted",n={}){return Array.isArray(e)?ad(e,t,n):!e||typeof e!="object"?[]:(_n(e,{titleHint:`${t} #1`}),[{id:di(),title:e.title||`${t} #1`,data:e}])}function Pn(e,t="Pasted",n={}){const o=(vs(typeof e=="string"?e:"")||"").trim();if(!o)return[];const a=id(o);if(a){let d=n;if(Array.isArray(a)&&n.promptForSeriesName){const g=_c(a,t),w=kc(g);d={...n,promptForSeriesName:!1,seriesTitleOverride:w||g}}const f=ys(a,t,d);if(f.length)return f}return o.split(/^\s*(?:---|%%%)\s*$/m).map(d=>d.trim()).filter(Boolean).map((d,f)=>{const g=JSON.parse(d);return _n(g,{titleHint:`${t} #${f+1}`}),{id:di(),title:g.title||`${t} #${f+1}`,data:g}})}function rd(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function mi(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!rd(e)}function sd(e){if(!e)return!1;const n=(vs(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function Es(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(V)}catch(o){return console.warn("[Blockscape] failed to access editor payload",o),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(o){console.warn("[Blockscape] invalid payload JSON",o);try{localStorage.removeItem(V)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(V)}catch(o){console.warn("[Blockscape] failed to clear editor payload",o)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=Pn(t.text,t.title||"Editor Export")}catch(o){return console.warn("[Blockscape] could not parse payload text",o),null}if(!n.length)return null;let i=null;return n.forEach(o=>{const a=Cn(o,{versionLabel:"editor"});i==null&&(i=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:i,count:n.length}}function Ss(e="storage"){const t=Es();return!t||typeof t.index!="number"?!1:(It(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function ld(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let i;try{const s=Dl(t);i=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!i||typeof i!="object"||i.data==null)return console.warn("[Blockscape] share payload missing data"),null;const o=ys(i.data,i.title||"Shared Model");if(!o.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return o.forEach(s=>{const d=s.isSeries?i.title||s.title:null,f=Cn({...s,apicurioArtifactName:d||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=f)}),a}async function cd(){const e=zl();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:i}=e;try{if(!await no())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await zr(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(Je==null?void 0:Je.highlightSource)=="function"&&Je.highlightSource(t);let s=a.firstIndex;if(n){const d=wa(n);d!==-1&&(s=d)}return{modelIndex:s,itemId:i||null,modelId:n||null}}return null}catch(o){return console.warn("[Blockscape] server-path autoload failed",o),null}}async function dd(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const i=new URLSearchParams(window.location.search);i.has("load")&&(t=i.get("load"))}if(!t)return null;try{const i=await La(t);return typeof i=="number"?i:null}catch(i){return console.warn("[Blockscape] load param failed",i),null}}function ud(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,i=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{i.add(s.id);const d=new Set(s.deps||[]);(e.links||[]).forEach(f=>{f.from===s.id&&d.add(f.to)}),t.set(s.id,d),d.forEach(f=>{n.has(f)||n.set(f,new Set),n.get(f).add(s.id)})}));const o=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&o.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:o,seen:i}}function pd(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),i=44;n.width=i,n.height=i;const o=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=fs(e,t),d=Jc(s);return o.fillStyle=s,o.beginPath(),o.arc(i/2,i/2,i/2-2,0,2*Math.PI),o.fill(),o.strokeStyle="rgba(0,0,0,0.15)",o.lineWidth=1,o.stroke(),o.fillStyle=d,o.font=`bold ${i*.5}px system-ui, -apple-system, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(a,i/2,i/2),n.toDataURL("image/png")}function Vn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Is(e){const t=Vn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function ks(e,t="active"){return jn(e)||mt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function fd(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,i)=>{var s,d;const o=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();o&&t.set(o,i);const a=(((d=n==null?void 0:n.data)==null?void 0:d.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,i)}),t}function md(e,t){if(!e||!t)return null;const n=new Set,i=o=>{const a=(o??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(zt(a)))};i(e.id),i(e.title);for(const o of n)if(t.has(o))return t.get(o);for(const o of n){const a=o.toLowerCase();for(const[s,d]of t.entries())if(s.toLowerCase()===a)return d}return null}const _s=new WeakMap;function hd(e,t){var Ue;if(!((Ue=e==null?void 0:e.apicurioVersions)!=null&&Ue[t]))return null;const n=e.apicurioVersions[t],i=n.data,o=Po(i),a=_s.get(n);if(a&&a.fingerprint===o)return a.dataUrl;const s=160,d=160,f=document.createElement("canvas");f.width=s,f.height=d;const g=f.getContext("2d"),w=jr("--color-surface-ghost")||an.color.surfaceGhost,x=jr("--color-border-muted")||an.color.borderMuted;g.fillStyle=w,g.fillRect(0,0,s,d),g.strokeStyle=x,g.strokeRect(.5,.5,s-1,d-1);const $=8,A=8,N=4,O=Array.isArray(i==null?void 0:i.categories)?i.categories:[],le=Math.max(O.length,1),Ne=s-N*2,st=N*3,we=le>1?Math.min(st,Ne/(le-1)):0,xe=le>1?(s-we*(le-1))/2:s/2;O.forEach((ut,Ot)=>{const pt=xe+Ot*we,Xe=Array.isArray(ut.items)?ut.items:[],kt=Math.max(Xe.length,1),qt=d-$-A-N*2,ct=kt>1?Math.min(N*3,qt/(kt-1)):0;Xe.forEach((Pt,xn)=>{const wn=d-A-N-xn*ct;g.beginPath(),g.arc(pt,wn,N,0,Math.PI*2);const Gt=fs(Pt.name||Pt.id||"",Pt.color);g.fillStyle=Gt,g.strokeStyle="rgba(15,23,42,0.25)",g.fill(),g.stroke()})});const et=f.toDataURL("image/png");return _s.set(n,{fingerprint:o,dataUrl:et}),et}function Wo(e,t){var d;if(Hi(),e<0||e>=y.length)return!1;const n=y[e];if(!((d=n==null?void 0:n.apicurioVersions)!=null&&d.length)||!cs(e))return!1;const o=n.apicurioVersions.length,a=(t%o+o)%o,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,u=!0,K=null,ft=null,Wt(),Rt(),Lt(),!0):!1}function xa(e){var i;if(!e||b<0)return!1;const t=y[b];if(!((i=t==null?void 0:t.apicurioVersions)!=null&&i.length))return!1;const n=Vn(t);return n===-1?!1:Wo(b,n+e)}function gd(e,t){if(Hi(),e<0||e>=y.length)return!1;const n=y[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!cs(e))return!1;const i=Math.min(Math.max(t,0),n.apicurioVersions.length-1),o=Vn(n),[a]=n.apicurioVersions.splice(i,1);if(!a)return!1;let s=o;i===o?s=Math.min(i,n.apicurioVersions.length-1):i<o&&(s=Math.max(0,o-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const d=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(d==null?void 0:d.data)||n.data,n.isSeries=n.apicurioVersions.length>1,It(e),!0}function bd(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,l.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const i=document.createElement("div");i.className="version-nav__title",i.textContent=e.apicurioArtifactName||e.apicurioArtifactId||mt(e)||"Artifact",i.title="Double-click to rename this series",i.setAttribute("role","button"),i.tabIndex=0,i.addEventListener("dblclick",()=>{var Ne;const O=y[b];!((Ne=O==null?void 0:O.apicurioVersions)!=null&&Ne.length)||!Cc(O)||(On(),Rt(),Lt())}),n.appendChild(i);const o=document.createElement("div");o.className="version-nav__status";const a=Vn(e),s=Is(e)||"latest";o.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(o);const d=document.createElement("div");d.className="version-nav__controls";const f=document.createElement("button");f.type="button",f.className="version-nav__button",f.textContent="Previous",f.addEventListener("click",()=>xa(-1));const g=document.createElement("button");g.type="button",g.className="version-nav__button",g.textContent="Next",g.addEventListener("click",()=>xa(1)),d.appendChild(f),d.appendChild(g),n.appendChild(d);const w=document.createElement("div");w.className="version-nav__thumbs",e.apicurioVersions.forEach((O,le)=>{var Ot,pt;const Ne=document.createElement("button");Ne.type="button",Ne.className="version-nav__thumb",O!=null&&O.isCategoryView&&Ne.classList.add("version-nav__thumb--category"),le===a&&Ne.classList.add("is-active");const st=hd(e,le);if(st){const Xe=document.createElement("img");Xe.src=st,Xe.alt=`Version ${le+1}`,Ne.appendChild(Xe)}const we=document.createElement("div");we.className="version-nav__thumb-label";const xe=document.createElement("span");xe.className="version-nav__thumb-label-text";const et=(((Ot=O==null?void 0:O.data)==null?void 0:Ot.id)??(O==null?void 0:O.id)??"").toString().trim();let Ue=et||(O!=null&&O.version?`v${O.version}`:`${le+1}`),ut=et||Ue;if(O!=null&&O.isCategoryView){const Xe=((pt=O.data)==null?void 0:pt.title)||O.categoryViewKey||Ue||"Category";Ue=Xe,ut=`Category view: ${Xe}`,Ne.dataset.computed="true"}if(xe.textContent=Ue,we.title=ut,we.appendChild(xe),Ne.appendChild(we),_d(we,xe),e.apicurioVersions.length>1&&!(O!=null&&O.isCategoryView)){const Xe=document.createElement("span");Xe.className="version-nav__thumb-remove",Xe.title=`Remove ${Ue} from this series`,Xe.setAttribute("aria-label",`Remove ${Ue} from this series`),Xe.setAttribute("role","button"),Xe.tabIndex=-1,Xe.textContent="×",Xe.addEventListener("click",kt=>{kt.stopPropagation(),kt.preventDefault(),window.confirm(`Remove ${Ue} from this series?`)&&gd(b,le)}),Ne.appendChild(Xe)}Ne.addEventListener("click",()=>Wo(b,le)),xd(Ne,O),w.appendChild(Ne)});const x=document.createElement("button");x.type="button",x.className="version-nav__thumb version-nav__thumb--add",x.title="Create a new version from this map",x.addEventListener("click",()=>{try{const O=us({versionLabel:"manual"});It(O)}catch(O){alert((O==null?void 0:O.message)||"Unable to create a new version right now.")}});const $=document.createElement("span");$.className="version-nav__thumb-add-icon",$.textContent="+",x.appendChild($),w.appendChild(x),n.appendChild(w);const A=ks(e,"active"),N=L.get(A);return typeof N=="number"&&!Number.isNaN(N)&&requestAnimationFrame(()=>{w.scrollLeft=N}),w.addEventListener("scroll",()=>{L.set(A,w.scrollLeft)}),n}function Wi(){var Js,zs,qs,Gs,Ks;if(!J)return;const e=b>=0&&y[b]?y[b]:null,t=S&&S.querySelector?S.querySelector(".version-nav__thumbs"):null;if(t&&e){const m=ks(e,b);L.set(m,t.scrollLeft)}Un(),Array.isArray(J.m.categories)||(J.m.categories=[]),console.log("[Blockscape] rendering categories=",J.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!J.m.abstract,"- value:",J.m.abstract?J.m.abstract.substring(0,50)+"...":"none"),S.innerHTML="",Ce.clear(),dt.clear(),B=[],Do(y[b],{versionLabel:"1"});const n=bd(y[b]);n&&S.appendChild(n),F.setAttribute("width",window.innerWidth),F.setAttribute("height",window.innerHeight);const i=document.createElement("div");i.className="blockscape-model-meta";const o=document.createElement("div");o.className="blockscape-model-title",o.textContent=J.m.title&&J.m.title.trim()||ze(y[b]),i.appendChild(o),((Js=y[b])!=null&&Js.isSeries||(qs=(zs=y[b])==null?void 0:zs.apicurioVersions)!=null&&qs.length)&&Nt(y[b],{seriesName:y[b].title||J.m.title||ze(y[b])});const a=Is(y[b]),s=jn(y[b]),d=(J.m.id??"").toString().trim(),f=document.createElement("div");f.className="blockscape-model-meta__details";const g=(m,D)=>{if(!D)return;const H=document.createElement("div");H.className="blockscape-model-id";const ie=document.createElement("span");ie.className="blockscape-model-id__label",ie.textContent=m;const Re=document.createElement("span");Re.className="blockscape-model-id__value",Re.textContent=D,H.append(ie,Re),f.appendChild(H)};g("Series ID",s),g("Model ID",d),g("No. in series",a),f.childElementCount&&i.appendChild(f),S.appendChild(i);const w=document.createElement("div");w.className="blockscape-tabs";const x=document.createElement("div");x.className="blockscape-tabrow";const $=document.createElement("div");$.className="blockscape-tablist",$.setAttribute("role","tablist"),x.appendChild($);const A=document.createElement("div");A.className="blockscape-tabactions",x.appendChild(A),w.appendChild(x);const N=document.createElement("div");N.className="blockscape-tabpanels",w.appendChild(N);const O=document.createElement("div"),le=document.createElement("div"),Ne=document.createElement("div"),st=document.createElement("div");let we="";const xe=fd(y[b]),et=Vn(y[b]),Ue=((Ks=(Gs=y[b])==null?void 0:Gs.apicurioVersions)==null?void 0:Ks[et])||null,ut=jt=!!(Ue!=null&&Ue.isCategoryView||((Ue==null?void 0:Ue.version)||"").startsWith($o));Jt=null,ln="";const Ot=(m,D)=>{!m||!D||(m.title=m.title?`${m.title}
${D}`:D)},pt=[{id:"map",label:"Map",panel:O},{id:"abstract",label:"Info",panel:le},{id:"source",label:"Settings",panel:Ne},{id:"apicurio",label:"Apicurio",panel:st}],Xe=typeof $e.isEnabled=="function"?$e.isEnabled():!1,kt=m=>{if(!F)return;const D=m==="map";F.hidden=!D,D?(jo(),Kn()):F.innerHTML=""};pt.forEach((m,D)=>{const H=document.createElement("button");H.type="button",H.id=`tab-${m.id}`,H.className="blockscape-tab"+(D===0?" is-active":""),H.setAttribute("role","tab"),H.setAttribute("aria-controls",`panel-${m.id}`),H.setAttribute("aria-selected",D===0?"true":"false"),H.textContent=m.label,m.id==="apicurio"&&!Xe&&(H.hidden=!0,H.tabIndex=-1,H.setAttribute("aria-hidden","true"),H.style.display="none"),m.button=H,$.appendChild(H),m.panel.id=`panel-${m.id}`,m.panel.classList.add("blockscape-tabpanel"),m.panel.setAttribute("role","tabpanel"),m.panel.setAttribute("aria-labelledby",H.id),m.panel.hidden=D!==0,D===0&&m.panel.classList.add("is-active"),N.appendChild(m.panel)});const qt=m=>{zn=m,pt.forEach(D=>{const H=D.id===m;D.button.classList.toggle("is-active",H),D.button.setAttribute("aria-selected",H?"true":"false"),D.panel.classList.toggle("is-active",H),D.panel.hidden=!H}),kt(m)},ct=pt.find(m=>m.id==="apicurio"),Pt=m=>{if(!ct||!ct.button||!ct.panel)return;const D=!!m;if(ct.button.hidden=!D,ct.button.tabIndex=D?0:-1,ct.button.setAttribute("aria-hidden",D?"false":"true"),ct.button.style.display=D?"":"none",D){const H=zn==="apicurio";ct.button.classList.toggle("is-active",H),ct.button.setAttribute("aria-selected",H?"true":"false"),ct.panel.classList.toggle("is-active",H),ct.panel.hidden=!H}else{const H=ct.panel.classList.contains("is-active");if(ct.button.classList.remove("is-active"),ct.button.setAttribute("aria-selected","false"),ct.panel.classList.remove("is-active"),ct.panel.hidden=!0,H){const ie=pt.find(Re=>Re.id!=="apicurio");ie&&qt(ie.id)}}T&&(T.checked=D)};pt.forEach(m=>{m.button.addEventListener("click",()=>{Un(),qt(m.id)}),m.id==="abstract"&&(Jt=m.button,m.button.addEventListener("mouseenter",()=>ao(m.button,we,{offset:12})),m.button.addEventListener("mouseleave",Un),m.button.addEventListener("focus",()=>ao(m.button,we,{offset:12})),m.button.addEventListener("blur",Un))});const wn=(m=>{const D=pt.find(ie=>ie.id===zn);if(D&&(D.id!=="apicurio"||m))return D.id;const H=pt.find(ie=>ie.id!=="apicurio"||m);return(H==null?void 0:H.id)||pt[0].id})(Xe);qt(wn),Pt(Xe),typeof $e.onEnabledChange=="function"&&$e.onEnabledChange(Pt),S.appendChild(w);const Gt=document.createElement("div");Gt.className="blockscape-render",O.appendChild(Gt);const Qt=document.createElement("div");if(Qt.className="blockscape-abstract-panel",J.m.abstract){console.log("[Blockscape] Rendering abstract content");const m=document.createElement("div");m.className="blockscape-abstract",m.innerHTML=J.m.abstract,Zd(m),Qt.appendChild(m),we=m.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const m=document.createElement("div");m.className="blockscape-abstract-placeholder",m.textContent="No abstract has been provided for this model.",Qt.appendChild(m),we=m.outerHTML}ln=we,le.appendChild(Qt);const An=document.createElement("div");An.className="blockscape-source-panel";const Qe=document.createElement("div");Qe.className="blockscape-settings-panel";const en=m=>{_e.themeToggle&&(_e.themeToggle.checked=m),_e.tabThemeToggle&&(_e.tabThemeToggle.checked=m)},Xn=m=>{en(m),ha(m?li:vi)},yn=m=>{_e.tabCenterToggle&&(_e.tabCenterToggle.checked=m)},Na=m=>{const D=Ci(m);yn(D),Wr(D)},qo=m=>{_e.secondaryLinksToggle&&(_e.secondaryLinksToggle.checked=m),_e.tabSecondaryLinksToggle&&(_e.tabSecondaryLinksToggle.checked=m)},so=m=>{const D=!!m;qo(D),bn=D,K?Tt(K):(zo(),Kn())},lo=({id:m,label:D,checked:H,onChange:ie})=>{const Re=document.createElement("label");Re.className="blockscape-tab-toggle",Re.setAttribute("for",m);const te=document.createElement("input");te.type="checkbox",te.id=m,te.checked=H,typeof ie=="function"&&te.addEventListener("change",()=>ie(te.checked));const Me=document.createElement("span");return Me.className="blockscape-tab-toggle__label",Me.textContent=D,Re.append(te,Me),{row:Re,input:te}},co=document.createElement("p");co.className="blockscape-settings-panel__title",co.textContent="Feature toggles",Qe.appendChild(co);const uo=document.createElement("label");uo.className="settings-toggle";const I=document.createElement("input");I.type="checkbox",I.checked=Qi===li;const W=document.createElement("span");W.className="settings-toggle__text";const oe=document.createElement("span");oe.className="settings-toggle__label",oe.textContent="Dark mode";const ae=document.createElement("span");ae.className="settings-toggle__hint",ae.textContent="Switch Blockscape UI to dark colors.",W.append(oe,ae),uo.append(I,W),I.addEventListener("change",()=>{Xn(I.checked)}),Qe.appendChild(uo),_e.themeToggle=I;const{row:tt,input:_t}=lo({id:"tabToggleTheme",label:"Dark mode",checked:Qi===li,onChange:m=>Xn(m)});A.appendChild(tt),_e.tabThemeToggle=_t;const{row:ue,input:ot}=lo({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:bn,onChange:m=>so(m)});A.appendChild(ue),_e.tabSecondaryLinksToggle=ot;const{row:tn,input:Hn}=lo({id:"tabToggleCenterItems",label:"Center",checked:Zt,onChange:m=>Na(m)});A.appendChild(tn),_e.tabCenterToggle=Hn;const nn=document.createElement("div");nn.className="settings-actions";const on=document.createElement("input");on.type="file",on.accept="application/json",on.hidden=!0;const po=document.createElement("button");po.type="button",po.className="pf-v5-c-button pf-m-secondary",po.textContent="Load settings",po.addEventListener("click",()=>on.click()),on.addEventListener("change",async()=>{var D,H;const m=(D=on.files)==null?void 0:D[0];if(m)try{const ie=await m.text(),Re=JSON.parse(ie),te=(Re==null?void 0:Re.settings)||Re,ht=((H=vc(te||{},{refreshObsidianLinks:Ko}).applied)==null?void 0:H.length)||0;Rn(ht?`Loaded ${ht} setting${ht===1?"":"s"} from ${m.name}.`:`No matching settings found in ${m.name}.`,2200)}catch(ie){console.warn("[Blockscape] failed to load settings.json",ie),Rn("Invalid settings file.",2400)}finally{on.value=""}});const fo=document.createElement("button");fo.type="button",fo.className="pf-v5-c-button pf-m-tertiary",fo.textContent="Download settings",fo.addEventListener("click",()=>{const m={version:1,exportedAt:new Date().toISOString(),settings:vl(ns(),{localBackend:Je})};Fr("settings.json",JSON.stringify(m,null,2)),Rn("Settings downloaded.",2e3)}),nn.append(po,fo,on),Qe.appendChild(nn);const Go=document.createElement("div");Go.className="color-presets";const Ma=document.createElement("div");Ma.className="settings-text__label",Ma.textContent="Color presets";const Ba=document.createElement("div");Ba.className="settings-text__hint",Ba.textContent="Shown in tile context menu for quick coloring.",Go.append(Ma,Ba);const mo=document.createElement("div");mo.className="color-presets__list";const $a=document.createElement("div");$a.className="color-presets__add";const zi=document.createElement("input");zi.type="text",zi.placeholder="Name",zi.className="settings-text__input";const ho=document.createElement("input");ho.type="color",ho.value="#2563eb",ho.className="settings-color-input";const go=document.createElement("button");go.type="button",go.className="pf-v5-c-button pf-m-primary",go.textContent="Add preset",go.addEventListener("click",()=>{const m=zi.value.trim()||"Custom",D=ho.value,H=[...Ft,{name:m,value:D}];xi(H),Ui(Ft),zi.value=""}),$a.append(zi,ho,go),Go.append(mo,$a),Qe.appendChild(Go),_e.colorPresetList=mo,_i=()=>{mo.innerHTML="",Ft.forEach((m,D)=>{const H=document.createElement("div");H.className="color-presets__row";const ie=document.createElement("input");ie.type="text",ie.className="settings-text__input",ie.value=m.name||"",ie.placeholder="Name",ie.addEventListener("input",()=>{const Me=[...Ft];Me[D]={...Me[D],name:ie.value},xi(Me),Ui(Ft)});const Re=document.createElement("input");Re.type="color",Re.className="settings-color-input",Re.value=m.value,Re.addEventListener("input",()=>{const Me=[...Ft];Me[D]={...Me[D],value:Re.value},xi(Me),Ui(Ft)});const te=document.createElement("button");te.type="button",te.className="pf-v5-c-button pf-m-plain",te.textContent="✕",te.title="Remove preset",te.addEventListener("click",()=>{const Me=Ft.filter((ht,Fe)=>Fe!==D);xi(Me),Ui(Ft),_i()}),H.append(ie,Re,te),mo.appendChild(H)})},_i();const Zn=({id:m,label:D,hint:H,checked:ie,className:Re="",onChange:te})=>{const Me=document.createElement("label");Me.className=["settings-toggle",Re].filter(Boolean).join(" ");const ht=document.createElement("input");ht.type="checkbox",ht.id=m,ht.checked=ie;const Fe=document.createElement("span");Fe.className="settings-toggle__text";const Ct=document.createElement("span");if(Ct.className="settings-toggle__label",Ct.textContent=D,Fe.appendChild(Ct),H){const Kt=document.createElement("span");Kt.className="settings-toggle__hint",Kt.textContent=H,Fe.appendChild(Kt)}return Me.appendChild(ht),Me.appendChild(Fe),typeof te=="function"&&ht.addEventListener("change",()=>te(ht.checked)),{row:Me,input:ht}},Ko=()=>{S.querySelectorAll(".tile").forEach(m=>{const D=m.dataset.id,H=ya(D);if(!(H!=null&&H.item))return;const ie=Ts(H.item.external),Re=As(H.item,{externalMeta:ie,seriesIdLookup:xe});Ls(m,Re)})},{row:nu,input:iu}=Zn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:bn,className:"map-controls__toggle",onChange:m=>so(m)});Qe.appendChild(nu),_e.secondaryLinksToggle=iu;const{row:ou,input:au}=Zn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:Ut,className:"map-controls__toggle",onChange:m=>{Ut=m,Ta()}});Qe.appendChild(ou),_e.reusedToggle=au;const{row:ru,input:su}=Zn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:ci,className:"map-controls__toggle",onChange:m=>{const D=Ri(m);Xr(D)}});Qe.appendChild(ru),_e.autoIdToggle=su;const Ra=[],{row:lu,input:cu}=Zn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:Ii,className:"map-controls__toggle",onChange:m=>{const D=Vi(m);as(D),Ra.forEach(H=>{H.disabled=!D}),Ko()}});if(Qe.appendChild(lu),_e.obsidianToggle=cu,typeof(Je==null?void 0:Je.isAvailable)=="function"&&Je.isAvailable()&&typeof(Je==null?void 0:Je.getAutoReloadConfig)=="function"){const{enabled:m,intervalMs:D}=Je.getAutoReloadConfig();let H=null;const{row:ie,input:Re}=Zn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:m,className:"map-controls__toggle",onChange:Tn=>{Je.setAutoReloadEnabled(Tn),H&&(H.disabled=!Tn)}});Qe.appendChild(ie),_e.autoReloadToggle=Re;const te=Tn=>`${(Tn/1e3).toFixed(2)}s`,Me=document.createElement("label");Me.className="settings-slider",Me.setAttribute("for","autoReloadInterval");const ht=document.createElement("div");ht.className="settings-slider__text";const Fe=document.createElement("span");Fe.className="settings-slider__label",Fe.textContent="Auto-reload interval";const Ct=document.createElement("span");Ct.className="settings-slider__hint",Ct.textContent="Adjust how often to poll for file changes.",ht.append(Fe,Ct);const Kt=document.createElement("span");Kt.className="settings-slider__value",Kt.textContent=te(D),H=document.createElement("input"),H.type="range",H.id="autoReloadInterval",H.className="settings-slider__input",H.min=String(Mr),H.max=String(Br),H.step="100",H.value=String(D),H.disabled=!m,H.setAttribute("aria-label","Set auto-reload polling interval"),H.addEventListener("input",()=>{const Tn=Je.setAutoReloadInterval(parseInt(H.value,10));Kt.textContent=te(Tn)}),Me.append(ht,Kt,H),Qe.appendChild(Me),_e.autoReloadInput=H,_e.autoReloadValue=Kt}const Oa=document.createElement("div");Oa.className="settings-radio";const Pa=document.createElement("div");Pa.className="settings-radio__label",Pa.textContent="Obsidian link format";const Va=document.createElement("div");Va.className="settings-radio__hint",Va.textContent="Use the tile title or id when building Obsidian links.";const Da=document.createElement("div");Da.className="settings-radio__options";const Vs=(m,D)=>{const H=document.createElement("label");H.className="settings-radio__option";const ie=document.createElement("input");ie.type="radio",ie.name="obsidianLinkMode",ie.value=m,ie.checked=Zi===m,ie.disabled=!Ii,ie.addEventListener("change",()=>{if(!ie.checked)return;const te=Pi(m);os(te),Ko()});const Re=document.createElement("span");Re.textContent=D,H.append(ie,Re),Ra.push(ie),Da.appendChild(H)};Vs(fa,"Use title"),Vs(No,"Use id"),Oa.append(Pa,Da,Va),Qe.appendChild(Oa),_e.obsidianModeInputs=Ra;const Yo=document.createElement("label");Yo.className="settings-text",Yo.setAttribute("for","obsidianVaultInput");const Ua=document.createElement("div");Ua.className="settings-text__text";const Ha=document.createElement("span");Ha.className="settings-text__label",Ha.textContent="Obsidian vault";const Fa=document.createElement("span");Fa.className="settings-text__hint",Fa.textContent="Optional. Set the vault name to avoid duplicates.",Ua.append(Ha,Fa);const Fn=document.createElement("input");Fn.type="text",Fn.id="obsidianVaultInput",Fn.className="settings-text__input",Fn.placeholder="Vault name",Fn.value=ki,Fn.addEventListener("input",()=>{const m=Di(Fn.value);rs(m),Ko()}),Yo.append(Ua,Fn),Qe.appendChild(Yo),_e.obsidianVaultInput=Fn;const Wa=document.createElement("p");Wa.className="settings-note",Wa.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',Qe.appendChild(Wa);const Ds=m=>`${(m/1e3).toFixed(1)}s`,Xo=document.createElement("label");Xo.className="settings-slider",Xo.setAttribute("for","seriesNavDoubleClickWait");const ja=document.createElement("div");ja.className="settings-slider__text";const Ja=document.createElement("span");Ja.className="settings-slider__label",Ja.textContent="Series double-click wait";const za=document.createElement("span");za.className="settings-slider__hint",za.textContent="Time window to double-click into another map version.",ja.append(Ja,za);const bo=document.createElement("span");bo.className="settings-slider__value",bo.textContent=Ds($n);const un=document.createElement("input");un.type="range",un.id="seriesNavDoubleClickWait",un.className="settings-slider__input",un.min=String(Dr),un.max=String(Ur),un.step="50",un.value=String($n),un.setAttribute("aria-label","Adjust double-click wait for series navigation"),un.addEventListener("input",()=>{const m=Oi(parseInt(un.value,10));bo.textContent=Ds(m),is(m)}),Xo.append(ja,bo,un),Qe.appendChild(Xo),_e.seriesNavInput=un,_e.seriesNavValue=bo;const Us=m=>`${Math.round((m-1)*100)}%`,Zo=document.createElement("label");Zo.className="settings-slider",Zo.setAttribute("for","hoverScaleSlider");const qa=document.createElement("div");qa.className="settings-slider__text";const Ga=document.createElement("span");Ga.className="settings-slider__label",Ga.textContent="Hover zoom";const Ka=document.createElement("span");Ka.className="settings-slider__hint",Ka.textContent="Expand tiles on hover to see more detail.",qa.append(Ga,Ka);const vo=document.createElement("span");vo.className="settings-slider__value",vo.textContent=Us(wi);const pn=document.createElement("input");pn.type="range",pn.id="hoverScaleSlider",pn.className="settings-slider__input",pn.min=String(Ve),pn.max=String(lt),pn.step="0.1",pn.value=String(wi),pn.setAttribute("aria-label","Adjust hover zoom"),pn.addEventListener("input",()=>{const m=Ai(parseFloat(pn.value));vo.textContent=Us(m),Gr(m),K&&Fi()}),Zo.append(qa,vo,pn),Qe.appendChild(Zo),_e.hoverScaleInput=pn,_e.hoverScaleValue=vo;let Vt=null,Qn=null;const Ya=m=>{const D=Math.round((1-m)*100);return D===0?"Off":`${D}% dim`},{row:du,input:uu}=Zn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Bn,className:"map-controls__toggle",onChange:m=>{const D=$i(m);Yr(D),Vt&&(Vt.disabled=!D),Qn&&(Qn.textContent=Ya(D?Mn:1))}});Qe.appendChild(du),_e.selectionDimToggle=uu;const Qo=document.createElement("label");Qo.className="settings-slider",Qo.setAttribute("for","selectionDimmingSlider");const Xa=document.createElement("div");Xa.className="settings-slider__text";const Za=document.createElement("span");Za.className="settings-slider__label",Za.textContent="Dimming strength";const Qa=document.createElement("span");Qa.className="settings-slider__hint",Qa.textContent="Adjust how much unrelated tiles fade when dimming is on.",Xa.append(Za,Qa),Qn=document.createElement("span"),Qn.className="settings-slider__value",Qn.textContent=Ya(Bn?Mn:1),Vt=document.createElement("input"),Vt.type="range",Vt.id="selectionDimmingSlider",Vt.className="settings-slider__input",Vt.min=String($t),Vt.max=String(De),Vt.step="0.05",Vt.value=String(Mn),Vt.disabled=!Bn,Vt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Vt.addEventListener("input",()=>{const m=Ti(parseFloat(Vt.value));Qn.textContent=Ya(m),Kr(m)}),Qo.append(Xa,Qn,Vt),Qe.appendChild(Qo),_e.selectionDimInput=Vt,_e.selectionDimValue=Qn;const Hs=m=>m===1?"Default":`${Math.round(m*100)}%`,ea=document.createElement("label");ea.className="settings-slider",ea.setAttribute("for","tileCompactnessSlider");const er=document.createElement("div");er.className="settings-slider__text";const tr=document.createElement("span");tr.className="settings-slider__label",tr.textContent="Tile compactness";const nr=document.createElement("span");nr.className="settings-slider__hint",nr.textContent="Adjust padding, gap, and logo size for tiles.",er.append(tr,nr);const wo=document.createElement("span");wo.className="settings-slider__value",wo.textContent=Hs(yi);const fn=document.createElement("input");fn.type="range",fn.id="tileCompactnessSlider",fn.className="settings-slider__input",fn.min=String(_r),fn.max=String(Cr),fn.step="0.05",fn.value=String(yi),fn.setAttribute("aria-label","Adjust tile compactness"),fn.addEventListener("input",()=>{const m=Li(parseFloat(fn.value));wo.textContent=Hs(m),Zr(m),K&&Fi()}),ea.append(er,wo,fn),Qe.appendChild(ea),_e.tileCompactnessInput=fn,_e.tileCompactnessValue=wo;const{row:pu,input:fu}=Zn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:ma!=="nowrap",className:"map-controls__toggle",onChange:m=>{const D=m?"wrap":"nowrap";Bi(D),ts(D)}});Qe.appendChild(pu),_e.titleWrapInput=fu;const Fs=m=>`${Math.round((m-1)*100)}% extra`,ta=document.createElement("label");ta.className="settings-slider",ta.setAttribute("for","titleHoverWidthSlider");const ir=document.createElement("div");ir.className="settings-slider__text";const or=document.createElement("span");or.className="settings-slider__label",or.textContent="Title width on hover";const ar=document.createElement("span");ar.className="settings-slider__hint",ar.textContent="Give titles more room horizontally when zoomed.",ir.append(or,ar);const yo=document.createElement("span");yo.className="settings-slider__value",yo.textContent=Fs(Ei);const mn=document.createElement("input");mn.type="range",mn.id="titleHoverWidthSlider",mn.className="settings-slider__input",mn.min=String(In),mn.max=String(dn),mn.step="0.05",mn.value=String(Ei),mn.setAttribute("aria-label","Adjust title width boost on hover"),mn.addEventListener("input",()=>{const m=Ni(parseFloat(mn.value));yo.textContent=Fs(m),Qr(m)}),ta.append(ir,yo,mn),Qe.appendChild(ta),_e.titleWidthInput=mn,_e.titleWidthValue=yo;const Ws=m=>`${Math.round(m*100)}% of hover zoom`,na=document.createElement("label");na.className="settings-slider",na.setAttribute("for","titleZoomPortionSlider");const rr=document.createElement("div");rr.className="settings-slider__text";const sr=document.createElement("span");sr.className="settings-slider__label",sr.textContent="Title zoom influence";const lr=document.createElement("span");lr.className="settings-slider__hint",lr.textContent="How much the title scales relative to tile hover zoom.",rr.append(sr,lr);const Eo=document.createElement("span");Eo.className="settings-slider__value",Eo.textContent=Ws(Si);const hn=document.createElement("input");hn.type="range",hn.id="titleZoomPortionSlider",hn.className="settings-slider__input",hn.min=String(si),hn.max=String(pa),hn.step="0.05",hn.value=String(Si),hn.setAttribute("aria-label","Adjust how much titles scale on hover"),hn.addEventListener("input",()=>{const m=Mi(parseFloat(hn.value));Eo.textContent=Ws(m),es(m)}),na.append(rr,Eo,hn),Qe.appendChild(na),_e.titleZoomInput=hn,_e.titleZoomValue=Eo;const mu=typeof $e.isEnabled=="function"?$e.isEnabled():!1,{row:hu,input:gu}=Zn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:mu,className:"apicurio-toggle",onChange:m=>{typeof $e.setEnabled=="function"&&$e.setEnabled(m)}});if(T=gu,Qe.appendChild(hu),An.appendChild(Qe),C)C.hidden=!1,C.classList.remove("pf-v5-c-page__main-section"),An.appendChild(C);else{const m=document.createElement("p");m.className="muted",m.textContent="Source editor unavailable.",An.appendChild(m)}Ne.appendChild(An),$e.mount(st);let js=0;if(J.m.categories.forEach(m=>{const D=document.createElement("section");D.className="category",D.dataset.cat=m.id;const H=ut?md(m,xe):null,ie=document.createElement("div");ie.className="cat-head",ie.dataset.cat=m.id,ie.tabIndex=0,ut&&Number.isInteger(H)?(ie.dataset.seriesVersionIndex=String(H),ie.title="Open this category's map in the series",ie.classList.add("cat-head--series-link")):ie.title="Select category",ie.innerHTML=`<div class="cat-title">${oo(m.title||m.id)}</div>
                          <div class="muted cat-count">${(m.items||[]).length} items</div>`,ie.addEventListener("click",()=>{var Ct;const te=ie.dataset.seriesVersionIndex!=null?parseInt(ie.dataset.seriesVersionIndex,10):null,Me=y[b],ht=Me?Vn(Me):-1;ut&&((Ct=Me==null?void 0:Me.apicurioVersions)==null?void 0:Ct.length)>1&&Number.isInteger(te)&&te!==ht&&Wo(b,te)||Dn(m.id)}),ie.addEventListener("keydown",te=>{(te.key==="Enter"||te.key===" ")&&(te.preventDefault(),ie.click())}),ie.addEventListener("focus",()=>Dn(m.id,{scrollIntoView:!1})),D.appendChild(ie);const Re=document.createElement("div");if(Re.className="grid"+(Zt?" is-centered":""),D.appendChild(Re),(m.items||[]).forEach(te=>{js+=1;const Me=Ts(te.external),ht=As(te,{externalMeta:Me,seriesIdLookup:xe}),Fe=document.createElement("div");if(Fe.className=Me.isExternal?"tile external":"tile",Fe.tabIndex=0,Fe.dataset.id=te.id,Fe.dataset.globalIndex=String(js),Me.url&&(Fe.dataset.externalUrl=Me.url),!ut){let En=null;if(xe.has(te.id)&&(En=xe.get(te.id)),Number.isInteger(En)){Fe.dataset.seriesVersionIndex=String(En),Fe.classList.add("tile--series-link");const bu=En===et?"Current map in this series":`Open version ${En+1} in this series`;Ot(Fe,bu)}}if(ht&&(Fe.dataset.obsidianUrl=ht),!ut){const En=wa(te.id);En!==-1&&En!==b&&(Fe.classList.add("tile--series-link"),Fe.dataset.navTargetIndex=String(En))}const Ct=document.createElement("img");Ct.className="logo",te.logo?(Ct.src=te.logo,Ct.alt=te.name||te.id):(Ct.alt="",Ct.style.opacity=1,Ct.src=pd(te.name||te.id,te.color));const Kt=document.createElement("div");Kt.className="name",Kt.textContent=te.name||te.id;const Tn=document.createElement("div");Tn.className="tile-id",Tn.textContent=te.id||"";const cr=document.createElement("div");cr.className="badge",cr.textContent="reused";let ei=null;ut||(ei=document.createElement("button"),ei.type="button",ei.className="tile-delete",ei.setAttribute("aria-label",`Delete ${te.name||te.id}`),ei.textContent="×",ei.addEventListener("click",En=>{En.stopPropagation(),Gd(te.id)})),Me.url&&Fe.appendChild(kd(Me.url)),Ls(Fe,ht),ei&&Fe.appendChild(ei),Fe.appendChild(Ct),Fe.appendChild(Kt),Fe.appendChild(Tn),Fe.appendChild(cr),Re.appendChild(Fe),Ce.set(te.id,{el:Fe,catId:m.id,rect:null})}),Gt.appendChild(D),dt.set(m.id,{el:D,headEl:ie}),!ut){const te=document.createElement("button");te.type="button",te.className="tile-add",te.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',te.hidden=Zt,te.tabIndex=Zt?-1:0,te.setAttribute("aria-hidden",Zt?"true":"false"),te.addEventListener("click",()=>Od(m.id)),Re.appendChild(te)}}),!ut){const m=document.createElement("button");m.type="button",m.className="category-add",m.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',m.addEventListener("click",()=>Bs()),Gt.appendChild(m)}Ta(),vd(),jo(),Kn(),ji(),Ad()}function vd(){S.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var A;if(typeof n.button=="number"&&n.button!==0)return;Gn();const i=e.dataset.id,o=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,d=y[b],f=d?Vn(d):-1,g=((A=d==null?void 0:d.apicurioVersions)==null?void 0:A.length)>1&&Number.isInteger(o)&&o!==f,w=Number.isInteger(s)&&s!==b&&s>=0&&s<y.length,x=Mt&&Mt.id===i&&Mt.targetVersionIndex===o,$=Yt&&Yt.id===i&&Yt.targetIndex===s;if(Mt&&!x&&Hi(),Yt&&!$&&ka(),g)if(x){if(Hi(),Wo(b,o))return}else Gc(i,o,d);else if(w){if($){ka(),It(s);return}Kc(i,s)}else Number.isInteger(a)&&a>0&&a%5===0&&Rn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",i),K===i&&!(g&&x)&&!(w&&$)){Ji();return}Tt(i)}),e.addEventListener("dblclick",n=>{n.preventDefault();const i=e.dataset.id,o=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):wa(i);o!==-1&&o!==b&&It(o)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{K&&Fi()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t),e.draggable=!0,e.addEventListener("dragstart",Ld),e.addEventListener("dragend",Nd)}),S.querySelectorAll(".grid").forEach(e=>{e.addEventListener("dragover",Md),e.addEventListener("drop",Rd),e.addEventListener("dragenter",Bd),e.addEventListener("dragleave",$d)}),ms||(ms=!0,window.addEventListener("resize",Fi),window.addEventListener("scroll",Fi,{passive:!0}),window.addEventListener("resize",Ns),document.addEventListener("click",e=>{var a,s,d;if(!K&&!je||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),i=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),o=(d=t==null?void 0:t.closest)==null?void 0:d.call(t,".tile-context-menu");n||i||o||Ji()})),document.getElementById("clear").onclick=()=>Ji()}function jo(){Ce.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function Cs(e,{includeSecondary:t=bn}={}){if(!e||!J)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(J.fwd.get(e)||[]),i=new Set(J.rev.get(e)||[]),o=new Set,a=new Set,s=[],d=new Set,f=(g,w,x,$)=>{if(!g||!w)return;const A=`${g}->${w}:${x}:${$}`;d.has(A)||(d.add(A),s.push({from:g,to:w,type:x,depth:$}))};return n.forEach(g=>f(e,g,"dep",1)),i.forEach(g=>f(e,g,"revdep",1)),t&&new Set([...n,...i]).forEach(w=>{(J.fwd.get(w)||new Set).forEach(A=>{const N=A===e;N||o.add(A),N||f(w,A,"dep",2)}),(J.rev.get(w)||new Set).forEach(A=>{const N=A===e;N||a.add(A),N||f(w,A,"revdep",2)})}),{deps:n,revs:i,secondaryDeps:o,secondaryRevs:a,edges:s}}function Jo(e,t){const n=Ce.get(e);n&&n.el.classList.add(t)}function Tt(e){var d,f,g;if(!e)return;je=null,K=e,at=null,ft=Cs(e),Wt(),zo(),ji();const{deps:t,revs:n,secondaryDeps:i,secondaryRevs:o}=ft;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=Ce.get(e);a&&a.el.classList.add("selected"),t.forEach(w=>Jo(w,"dep")),n.forEach(w=>Jo(w,"revdep")),i.forEach(w=>{!t.has(w)&&w!==e&&Jo(w,"dep-indirect")}),o.forEach(w=>{!n.has(w)&&!t.has(w)&&w!==e&&Jo(w,"revdep-indirect")}),Kn();const s=(g=(f=(d=Ce.get(e))==null?void 0:d.el)==null?void 0:f.dataset)==null?void 0:g.externalUrl;s&&Rn("This item has link to",Sn,s),ga()}function Dn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,d;if(!((s=J==null?void 0:J.m)!=null&&s.categories)||!e)return!1;const o=(J.m.categories||[]).find(f=>f.id===e);if(!o)return!1;Gn(),Aa(),n||(at=null),je=o.id,Wt(),ji();const a=dt.get(o.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(d=a.headEl)==null||d.focus({preventScroll:!0})),!0}function ji(){if(dt.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!je)return;const e=dt.get(je);if(!(e!=null&&e.el)){je=null,at=null,Wt();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function io(){if(je)return je;const e=K?Ce.get(K):null;return e!=null&&e.catId?e.catId:null}function wd(e){var a,s,d,f;if(!((s=(a=J==null?void 0:J.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=J.m.categories,n=io();let i=t.findIndex(g=>g.id===n);if(i===-1){const g=((d=t.find(w=>(w.items||[]).length))==null?void 0:d.id)||((f=t[0])==null?void 0:f.id);return g?Dn(g):!1}const o=i+e;return o<0||o>=t.length?!1:Dn(t[o].id)}function Aa(){K=null,ft=null,zo(),Kn(),ga({itemId:null})}function yd(){je=null,at=null,ji()}function Ji(){Aa(),yd(),at=null,Wt()}function zo(){S.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function Ta(){J!=null&&J.reusedLocal&&J.reusedLocal.forEach(e=>{const t=Ce.get(e);if(!t)return;t.el.classList.toggle("reused",Ut);const n=t.el.querySelector(".badge");n&&(n.style.display=Ut?"inline-block":"none")})}function Kn(){for(;F.firstChild;)F.removeChild(F.firstChild);if(!K||F.hidden)return;ft=Cs(K),ft.edges.forEach(t=>{var x,$;const n=(x=Ce.get(t.from))==null?void 0:x.rect,i=($=Ce.get(t.to))==null?void 0:$.rect;if(!n||!i)return;const o=xs(n),a=xs(i),s=document.createElementNS("http://www.w3.org/2000/svg","path"),d=(o.x+a.x)/2,f=o.y,g=(o.x+a.x)/2,w=a.y;s.setAttribute("d",`M ${o.x},${o.y} C ${d},${f} ${g},${w} ${a.x},${a.y}`),s.setAttribute("fill","none"),s.setAttribute("stroke",t.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),s.setAttribute("stroke-opacity",t.depth===1?"0.45":"0.22"),s.setAttribute("stroke-width",t.depth===1?"2":"1.5"),t.depth>1&&s.setAttribute("stroke-dasharray","4 3"),s.setAttribute("vector-effect","non-scaling-stroke"),F.appendChild(s)})}function xs(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function oo(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Ed(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,i=new URLSearchParams;return i.set("filepath",n),i.set("data"," "),i.set("mode","append"),ki&&i.set("vault",ki),`obsidian://advanced-uri?${i.toString()}`}function Sd(e){return e?Zi===No?e.id??e.name??"":e.name??e.id??"":""}function As(e,{externalMeta:t,seriesIdLookup:n}={}){var o;if(!Ii||!e||(o=n==null?void 0:n.has)!=null&&o.call(n,e.id))return"";const i=Sd(e);return Ed(i)}function Ts(e){if(typeof e=="string"){const t=e.trim();if(!t)return{isExternal:!1,url:""};try{const n=new URL(t);return/^https?:/i.test(n.protocol)?{isExternal:!0,url:n.toString()}:{isExternal:!1,url:""}}catch(n){return console.warn("[Blockscape] invalid external url skipped",e,n),{isExternal:!1,url:""}}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Id(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function kd(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Ls(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(Id(t))}function Ns(){ee||(ee=requestAnimationFrame(()=>{ee=null,B=B.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),B.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const i=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${i}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function _d(e,t){!e||!t||(B.push({labelEl:e,textEl:t}),Ns())}function Cd(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${oo(t)}</div>`],i=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();i&&n.push(`<div class="version-nav__tooltip-meta">Version ${oo(i)}</div>`);const o=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return o?n.push(`<div class="version-nav__tooltip-body">${o}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function ao(e,t,{offset:n=8}={}){!Q||!e||!t||(Q.innerHTML=t,Q.hidden=!1,Q.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const i=e.getBoundingClientRect(),o=Q.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let d=i.left+i.width/2-o.width/2+a,f=i.top-o.height-n+s;d<a+n&&(d=a+n);const g=a+window.innerWidth-o.width-n;d>g&&(d=g),f<s+n&&(f=i.bottom+n+s),Q.style.left=`${d}px`,Q.style.top=`${f}px`,Q.classList.add("is-visible")}))}function Un(){qn&&(clearTimeout(qn),qn=null),Q&&(Q.classList.remove("is-visible"),Q.setAttribute("aria-hidden","true"),Q.hidden=!0)}function xd(e,t){if(!e)return;const n=ze((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const i=Cd(t,n);let o=null;const a=()=>{o&&(clearTimeout(o),o=null)},s=()=>{E=e,ao(e,`<div class="version-nav__tooltip-title">${oo(n)}</div>`,{offset:10})},d=()=>{a(),o=setTimeout(()=>{E===e&&ao(e,i,{offset:10})},Ee)},f=()=>{s(),d()},g=()=>{E!==e&&s(),d()},w=()=>{a(),E===e&&(E=null,Un())};e.addEventListener("mouseenter",f),e.addEventListener("focus",f),e.addEventListener("pointermove",g),e.addEventListener("mouseleave",w),e.addEventListener("blur",w),e.addEventListener("click",w)}function Ad(){u&&(u=!1,!(!Jt||!ln)&&(Un(),ao(Jt,ln,{offset:12}),qn=setTimeout(()=>{Un(),Td()},1e3)))}function Td(){Jt&&(h&&(clearTimeout(h),h=null),Jt.classList.add("blockscape-tab--twinkle"),h=setTimeout(()=>{Jt.classList.remove("blockscape-tab--twinkle"),h=null},1400))}window.addEventListener("scroll",Un,!0),window.addEventListener("resize",Un),Ie&&Ie.addEventListener("click",()=>{Zc()}),pe&&pe.addEventListener("click",()=>{Qc()}),Be&&Be.addEventListener("click",()=>{try{zc(),Hc()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),Oe&&Oe.addEventListener("click",_a),P&&P.addEventListener("click",_a),c&&c.addEventListener("click",Ho),X&&X.addEventListener("click",Ho),S&&S.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");jt||!t||!S.contains(t)||Rc(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||Oc(e)}),Ge&&Ge.addEventListener("click",()=>{ps("button")}),G&&G.addEventListener("click",()=>{if(b<0){alert("Load or select a model before creating a version.");return}try{const e=us({versionLabel:"map edit"});It(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),Ae&&Ae.addEventListener("click",async()=>{var a;if(b<0||!y[b]){alert("Select or load a model before sharing.");return}const e={title:ze(y[b],"Shared Model"),data:y[b].data};let t;try{t=Vl(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const i=n.toString();try{window.history.replaceState({},document.title,i)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let o=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(i),o=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}o?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",i)}),q&&q.addEventListener("click",()=>{const e=(p.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};K&&(n.selectedItemId=K),localStorage.setItem(V,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";K&&(t=`editor.html?selected=${encodeURIComponent(K)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==V||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||Ss("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===Ze&&Ss("message")})),document.addEventListener("keydown",e=>{var i,o,a,s,d,f,g,w,x,$;if(Xc()){e.key==="Escape"&&(e.preventDefault(),_a());return}if(!(j!=null&&j.hidden)&&e.key==="Escape"){e.preventDefault(),Ho();return}if((i=fi==null?void 0:fi.isOpen)==null?void 0:i.call(fi))return;const n=jt;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const A=y[b],N=((o=A==null?void 0:A.apicurioVersions)==null?void 0:o.length)>1;ps("shortcut",N);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!mi())return;if(jd()){e.preventDefault();return}}if(e.key==="Escape"){let A=!1;ne&&!ne.hidden&&(Gn(),A=!0),(K||je)&&(Ji(),A=!0),A&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!mi())return;const A=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if((e.ctrlKey||e.metaKey)&&!e.shiftKey){xa(A)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(je&&!e.shiftKey){e.preventDefault();return}e.shiftKey?Vd(A)&&e.preventDefault():Dd(A)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!mi())return;const A=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){Wd(A)&&e.preventDefault();return}if(e.altKey)return;if(je&&!K&&!e.shiftKey){if(Hd(A)){e.preventDefault();return}if(wd(A)){e.preventDefault();return}}e.shiftKey?Fd(A)&&e.preventDefault():Ud(A)&&e.preventDefault()}if(e.key==="Delete"){if(n||!mi()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const A=je?qd():!1,N=A?!0:$s();(A||N)&&e.preventDefault()}if(e.key==="F2"){if(n||!mi())return;const A=je&&!K&&je||!K&&((f=(d=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:d.dataset)==null?void 0:f.cat)||null;if(A&&!K&&Pd(A)){e.preventDefault();return}const N=K||(($=(x=(w=(g=e.target)==null?void 0:g.closest)==null?void 0:w.call(g,".tile"))==null?void 0:x.dataset)==null?void 0:$.id);N&&fi.open(N)&&e.preventDefault()}if(e.key==="Insert"){if(n||!mi()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Bs()&&e.preventDefault()}}),window.addEventListener("resize",()=>{Pc()}),window.addEventListener("scroll",()=>Vc(),!0);let Yn=null,ro=null;function Ld(e){if(jt){e.preventDefault();return}Gn(),Yn=e.target.dataset.id,ro=e.target.closest(".category").dataset.cat,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({itemId:Yn,categoryId:ro})),e.target.closest(".category").querySelector(".grid").classList.add("drag-active"),console.log("[Blockscape] drag start",Yn,"from",ro)}function Nd(e){e.target.classList.remove("dragging"),S.querySelectorAll(".grid").forEach(t=>t.classList.remove("drag-active")),S.querySelectorAll(".tile").forEach(t=>t.classList.remove("drag-over")),Yn=null,ro=null}function Md(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function Bd(e){e.preventDefault();const t=e.target.closest(".grid");t&&t.classList.add("drag-active")}function $d(e){const t=e.target.closest(".grid");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-active")}function Rd(e){e.preventDefault();const t=e.target.closest(".grid");if(!t)return;const n=t.closest(".category");if(!n)return;const i=n.dataset.cat;if(!Yn||!i)return;const a=Array.from(t.querySelectorAll(".tile")).filter(s=>s.dataset.id!==Yn).find(s=>{const d=s.getBoundingClientRect();return e.clientY<d.top+d.height/2});Ms(Yn,a?a.dataset.id:null,i),Wi(),console.log("[Blockscape] drop completed",Yn,"from",ro,"to",i)}function Ms(e,t,n){if(b<0)return;const o=y[b].data.categories||[],a=o.find(w=>(w.items||[]).some(x=>x.id===e)),s=o.find(w=>w.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const d=a.items.findIndex(w=>w.id===e);if(d===-1)return;const[f]=a.items.splice(d,1);let g=s.items.length;if(t){const w=s.items.findIndex(x=>x.id===t);w!==-1&&(g=w)}s.items.splice(g,0,f),Rt(),Lt()}function Od(e){if(b<0||!e)return;const t=y[b].data,i=(t.categories||[]).find(f=>f.id===e);if(!i)return;i.items=i.items||[];const o=`New item ${i.items.length+1}`,s={id:Nc(`${e}-${i.items.length+1}`,t),name:o,deps:[]};i.items.push(s),Rt(),Lt(),Gn(),Tt(s.id);const d=Ce.get(s.id);d!=null&&d.el&&d.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Bs(){if(b<0)return!1;const e=y[b].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=Mc(t,e),i={id:n,title:t,items:[]};return e.categories.push(i),je=n,K=null,ft=null,at=null,Rt(),Lt(),Dn(n),console.log("[Blockscape] added category",n),!0}function Pd(e=io()){if(b<0||!e)return!1;const t=$c.open(e);return t&&(K=null,ft=null,Wt()),t}function Vd(e){if(!K||b<0||!e)return!1;const n=y[b].data.categories||[],i=Ce.get(K);let o=null;if(i!=null&&i.catId&&(o=n.find(f=>f.id===i.catId)),o||(o=n.find(f=>(f.items||[]).some(g=>g.id===K))),!o)return!1;o.items=o.items||[];const a=o.items.findIndex(f=>f.id===K);if(a===-1)return!1;const s=a+e;if(s<0||s>=o.items.length)return!1;const[d]=o.items.splice(a,1);return o.items.splice(s,0,d),Rt(),Lt(),Wi(),Tt(K),!0}function Dd(e){if(!J||!J.m||!e)return!1;const t=J.m.categories||[];if(!t.length)return!1;const n=()=>{const f=t.find(g=>(g.items||[]).length);return f?{category:f,item:f.items[0]}:null};if(!K){const f=n();return f?(Tt(f.item.id),!0):!1}const i=Ce.get(K);let o=null;if(i!=null&&i.catId&&(o=t.find(f=>f.id===i.catId)),o||(o=t.find(f=>(f.items||[]).some(g=>g.id===K))),!o){const f=n();return f?(Tt(f.item.id),!0):!1}const a=o.items||[];if(!a.length)return!1;const s=a.findIndex(f=>f.id===K);if(s===-1)return!1;const d=s+e;return d<0||d>=a.length?!1:(Tt(a[d].id),!0)}function Ud(e){if(!J||!J.m||!e)return!1;const t=J.m.categories||[];if(!t.length)return!1;const n=io();let i=t.findIndex(s=>s.id===n),o=i+e;if(i===-1&&(o=e>0?0:t.length-1),o<0||o>=t.length)return!1;const a=t[o];if(K){const d=(t[i].items||[]).findIndex(f=>f.id===K);at={catId:a.id,position:d===-1?0:d}}else at=null;return Dn(a.id,{preserveEntryHint:!0})}function Hd(e){var a;if(!je||!((a=J==null?void 0:J.m)!=null&&a.categories)||!e)return!1;const n=(J.m.categories||[]).find(s=>s.id===je);if(!n)return!1;const i=n.items||[];if(!i.length)return!1;let o=e>0?0:Math.max(0,i.length-1);return(at==null?void 0:at.catId)===n.id&&(o=Math.min(i.length-1,Math.max(0,at.position||0))),at=null,Tt(i[o].id),!0}function Fd(e){if(!K||b<0||!e)return!1;const n=y[b].data.categories||[];if(!n.length)return!1;const i=Ce.get(K);let o=-1;if(i!=null&&i.catId&&(o=n.findIndex(x=>x.id===i.catId)),o===-1&&(o=n.findIndex(x=>(x.items||[]).some($=>$.id===K))),o===-1)return!1;const a=o+e;if(a<0||a>=n.length)return!1;const s=n[o],d=n[a];if(!d)return!1;s.items=s.items||[],d.items=d.items||[];const f=s.items.findIndex(x=>x.id===K);if(f===-1)return!1;const g=Math.min(d.items.length,Math.max(0,f)),w=g<d.items.length?d.items[g].id:null;return Ms(K,w,d.id),Wi(),Tt(K),!0}function Wd(e){if(b<0||!e)return!1;const n=y[b].data.categories||[];if(!n.length)return!1;const i=io();if(!i)return!1;const o=n.findIndex(d=>d.id===i);if(o===-1)return!1;const a=o+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(o,1);return n.splice(a,0,s),je=s.id,Aa(),at=null,Wt(),Rt(),Lt(),ji(),console.log("[Blockscape] moved category",s.id,"from",o,"to",a),!0}function jd(){if(b<0)return!1;const e=y[b],t=mt(e)||(e?e.id:null),n=[];if(vt&&t===vt.modelId&&n.push({...vt,type:"item"}),vn&&t===vn.modelId&&n.push({...vn,type:"category"}),!n.length)return!1;const i=n.reduce((o,a)=>o?(a.ts||0)>(o.ts||0)?a:o:a,null);if(!i)return!1;if(i.type==="category"){if(zd(i))return!0}else if(i.type==="item"&&Jd(i))return!0;return!1}function Jd(e){const t=y[b],n=mt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(d=>d.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),vt=null,Gn(),K=null,ft=null,Wt(),Rt(),Lt(),Wi(),Tt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function zd(e){const t=y[b],n=mt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const i=t.data;i.categories=i.categories||[];const o=Math.min(Math.max(e.index,0),i.categories.length);return i.categories.splice(o,0,e.category),vn=null,K=null,ft=null,je=e.category.id,at=null,Wt(),Rt(),Lt(),ji(),Dn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function $s(){if(!K||b<0)return!1;const t=y[b].data.categories||[];if(!t.length)return!1;const n=Ce.get(K);let i=null;if(n!=null&&n.catId&&(i=t.find(g=>g.id===n.catId)),i||(i=t.find(g=>(g.items||[]).some(w=>w.id===K))),!i||!Array.isArray(i.items))return!1;const o=i.items.findIndex(g=>g.id===K);if(o===-1)return!1;const a=i.items.splice(o,1)[0];if(!a)return!1;const s=y[b];vt={item:a,categoryId:i.id,index:o,modelId:mt(s)||(s?s.id:null),ts:Date.now()};const f=(()=>{var w;if(i.items.length){const x=Math.min(o,i.items.length-1);return((w=i.items[x])==null?void 0:w.id)||null}const g=t.findIndex(x=>x.id===i.id);if(g===-1)return null;for(let x=g+1;x<t.length;x++){const $=t[x].items||[];if($.length)return $[0].id}for(let x=g-1;x>=0;x--){const $=t[x].items||[];if($.length)return $[0].id}return null})();return Gn(),K=null,ft=null,at=null,Wt(),Rt(),Lt(),Wi(),f?Tt(f):Ji(),console.log("[Blockscape] removed item",a.id),!0}function qd(){var d,f;const e=io();if(!e||b<0)return!1;const n=y[b].data.categories||[];if(!n.length)return!1;const i=n.findIndex(g=>g.id===e);if(i===-1)return!1;const[o]=n.splice(i,1);if(!o)return!1;const a=y[b];vn={category:o,index:i,modelId:mt(a)||(a?a.id:null),ts:Date.now()},je=null,K=null,ft=null,at=null,Wt(),Rt(),Lt();const s=((d=n[i])==null?void 0:d.id)||((f=n[i-1])==null?void 0:f.id)||null;return s?Dn(s):Ji(),console.log("[Blockscape] removed category",o.id),!0}function Gd(e){if(!e)return!1;const t=K;K=e;const n=$s();return n||(K=t,Wt()),n}ye&&ye.addEventListener("click",async()=>{const e=p.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await qr(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),M&&M.addEventListener("click",async()=>{const e=Fc();if(!e){alert("No series available to copy. Create another version first.");return}await qr(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),Te&&Te.addEventListener("click",async()=>{try{const e=await Kl();if(!e){alert("Clipboard is empty.");return}p.value=e,p.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await no(),t=Pn(p.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const i=[];t.forEach((o,a)=>{const s=Cn(o,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),i.push(s)}),b===-1&&n!=null?It(n):On(),e&&await Rs(i,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(b<0){alert("No active model selected.");return}try{const t=JSON.parse(p.value);if(_n(t,{titleHint:ze(y[b]),idHint:mt(y[b])||ze(y[b])}),y[b].data=t,y[b].title=t.title||y[b].title,y[b].isSeries||((e=y[b].apicurioVersions)==null?void 0:e.length)>1){const n=y[b].title||ze(y[b]);Nt(y[b],{seriesName:n,fallbackTitle:n})}Ea(),console.log("[Blockscape] replaced active model:",ze(y[b])),Lt(),$e.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const i of t){const o=await i.text(),a=i.name.replace(/\.[^.]+$/,"")||"File",s=Pn(o,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",i.name);continue}s.forEach((d,f)=>{var O;const g=(((O=d.data)==null?void 0:O.title)??"").toString().trim(),w=s.length>1?`${i.name} #${f+1}`:i.name,x=`${a} series`,$=d.isSeries?x:null;let A={...d};if(d.isSeries){const le=$||g||d.title||w||"unknown";A.title=le;const Ne=gn(le||"unknown");pi(A,Ne),Nt(A,{seriesName:le,fallbackTitle:"unknown"}),A.apicurioArtifactName=A.apicurioArtifactName||le}else A.title=g||w;const N=Cn({...A,apicurioArtifactName:A.apicurioArtifactName||$||A.apicurioArtifactName},{versionLabel:i.name});n==null&&(n=N)})}b===-1&&n!=null?It(n):On()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",Kd);async function Kd(e){var a;if(!mi())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!sd(t))return;let n=[];try{const s=await no();n=Pn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let i=null;const o=[];n.forEach((s,d)=>{const f=Cn(s,{versionLabel:n.length>1?`paste #${d+1}`:"paste"});i==null&&(i=f),o.push(f)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),i!=null&&It(i),await no()&&await Rs(o,{origin:"clipboard"})}async function Rs(e,{origin:t="clipboard"}={}){if(!await no()||typeof(Je==null?void 0:Je.saveModelByIndex)!="function")return;const i=(Array.isArray(e)?e:[]).filter($=>{const A=y[$];return A&&!A.sourcePath});if(!i.length)return;const o=i.length===1?"model":"models",a=y[i[0]],s=ec(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const d=window.prompt(`Save pasted ${o} as a new .bs file (under ~/blockscape):`,s);if(d==null)return;const f=ui(d);if(!f){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const g=await Zl(),w=[];for(let $=0;$<i.length;$++){const A=i.length===1?f:Xl(f,$+1),N=Ql(A,g);if(!N){alert("Could not find a unique filename to save.");return}g.add(N),w.push(N)}let x=null;for(let $=0;$<i.length;$++){const A=i[$],N=w[$],O=y[A];if(!O)continue;i.length===1&&tc(O,N);const le=await Je.saveModelByIndex(A,N,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(le!=null&&le.ok)){alert(`Local auto-save failed: ${(le==null?void 0:le.error)||"unknown error"}`);return}x==null&&(x=N)}x&&Oo(x),await Je.refresh(),On(),Rn(`Saved ${i.length} ${o}.`,2500)}Y.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&It(n)}),document.getElementById("removeModel").onclick=()=>{if(b<0)return;const e=ze(y[b]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",ze(y[b])),y.splice(b,1),!y.length){b=-1,J=null,S.innerHTML="",F.innerHTML="",p.value="",On(),Ea();return}const n=Math.min(b,y.length-1);It(n)},me&&(me.addEventListener("input",e=>{bs(e.target.value||"")}),me.addEventListener("focus",()=>{me.value&&me.value.trim()&&gs(me.value)})),he&&he.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),i=t.dataset.itemId;nd({modelIndex:n,itemId:i})}),document.addEventListener("click",e=>{if(!he||he.hidden)return;const t=e.target;he.contains(t)||me&&(t===me||me.contains(t))||(he.hidden=!0)}),k&&se&&R&&k.addEventListener("submit",async e=>{e.preventDefault();const t=se.value.trim();if(!t){alert("Please enter a URL"),se.focus();return}const n=await La(t);if(typeof n=="number"){It(n),se.value="";const i=document.getElementById("urlHint");i&&(i.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!se||!t)return;let n=null;se.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=se.value.slice(-12);t.textContent=o?`…${o}`:""},300)})}();function Lt(){if(!(b<0))try{Fo(y[b]),J=ud(y[b].data),Wi()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Yd(){const e=["comms.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>Lo?Lo.endsWith("/")?`${Lo}${n}`:`${Lo}/${n}`:n;for(const n of e)try{const i=await fetch(t(n),{cache:"no-store"});if(!i.ok){console.warn(`[Blockscape] ${n} not fetched (${i.status}); skipping`);continue}const o=await i.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=Pn(o,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(d=>{let f={...d};if(d.isSeries){const g=`${a} series`;f={...d,title:g,apicurioArtifactName:g};const w=gn(g||"unknown");pi(f,w),Nt(f,{seriesName:g,fallbackTitle:"unknown"})}Cn(f,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(i){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",i)}On()}async function Xd(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const i of t)try{console.log(`[Blockscape] fetching ${e} with cache="${i.cache??"default"}"`);const o=await fetch(e,i);if(o.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return await o.text()}catch(o){n=o}throw n||new Error("Unable to fetch URL")}function Zd(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(i=>Qd(i)),e.querySelectorAll("a[href]").forEach(i=>{const o=i.getAttribute("href");Ps(o)&&Os(i,o)})}function Qd(e){var d,f;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(f=(d=e.parentNode)==null?void 0:d.closest)!=null&&f.call(d,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,i=[];let o;for(;(o=n.exec(t))!==null;)i.push({url:o[0],index:o.index});if(!i.length)return;const a=document.createDocumentFragment();let s=0;i.forEach(({url:g,index:w})=>{w>s&&a.appendChild(document.createTextNode(t.slice(s,w))),a.appendChild(eu(g)),s=w+g.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function eu(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Ps(e)&&Os(t,e),t}function Os(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>tu(n,t,e)))}async function tu(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await La(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Ps(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function La(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Xd(e),i=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let o;try{o=Pn(t,i)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!o.length)throw new Error("No JSON objects found in response.");let a=null;return o.forEach((s,d)=>{var A;const f=(((A=s.data)==null?void 0:A.title)??"").toString().trim(),g=o.length>1?`${i} #${d+1}`:i,w=s.isSeries?`${i} series`:null;let x={...s};if(s.isSeries){const N=w||f||x.title||g;x={...s,title:N,apicurioArtifactName:N||s.apicurioArtifactName};const O=gn(N||"unknown");pi(x,O),Nt(x,{seriesName:N||w||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:O,url:e,baseName:i,seriesTitle:N})}const $=Cn({...x,title:f||x.title||g,apicurioArtifactName:x.apicurioArtifactName||w||s.apicurioArtifactName},{versionLabel:i});a==null&&(a=$)}),console.log(`[Blockscape] loaded ${o.length} model(s) from URL:`,i),b===-1&&a!=null?It(a):On(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const i=Pn(n,"Blockscape");if(!i.length)throw new Error("Seed template could not be parsed.");let o=null;i.forEach(A=>{const N=Cn(A,{versionLabel:"seed"});o==null&&(o=N)}),!await Hr&&l.autoLoadFromDir&&await Yd();const s=await cd(),d=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,f=await dd(),g=Es(),w=g==null?void 0:g.index,x=ld(),$=typeof d=="number"?d:typeof f=="number"?f:typeof x=="number"?x:typeof w=="number"?w:o??0;It($),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===$&&requestAnimationFrame(()=>{var N;if(b!==s.modelIndex)return;const A=(N=Ce.get(s.itemId))==null?void 0:N.el;A&&(Tt(s.itemId),A.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),A.focus({preventScroll:!0}))})})()}function Sl(r){let l;return{c(){l=U("div"),l.innerHTML='<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>',v(l,"id","shortcutHelp"),v(l,"class","shortcut-help"),l.hidden=!0,v(l,"aria-hidden","true"),v(l,"role","dialog"),v(l,"aria-modal","true"),v(l,"aria-labelledby","shortcutHelpTitle")},m(p,C){Et(p,l,C)},p:xt,i:xt,o:xt,d(p){p&&bt(l)}}}class Il extends Ao{constructor(l){super(),xo(this,l,null,Sl,So,{})}}const kl=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping, but do not add extra fields for it.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function Er(r){let l,p,C,S,F,Q,Y,ne;return{c(){l=U("div"),p=U("div"),C=U("a"),S=ia("Open Blockscape GPT"),F=ce(),Q=U("div"),Q.textContent="Paste the copied prompt into that chat.",Y=ce(),ne=U("div"),ne.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',v(C,"href",Cl),v(C,"target","_blank"),v(C,"rel","noreferrer"),v(Q,"class","new-panel__hint"),v(p,"class","new-panel__link"),v(ne,"class","new-panel__link new-panel__link--disabled"),v(l,"class","new-panel__links")},m(k,se){Et(k,l,se),_(l,p),_(p,C),_(C,S),_(p,F),_(p,Q),_(l,Y),_(l,ne)},p:xt,d(k){k&&bt(l)}}}function Sr(r){let l,p,C,S,F,Q;return{c(){l=U("div"),p=U("div"),p.textContent="Generated prompt",C=ce(),S=U("textarea"),v(p,"class","new-panel__prompt-label"),v(S,"class","pf-v5-c-form-control new-panel__textarea"),v(S,"rows","4"),S.readOnly=!0,v(l,"class","new-panel__prompt")},m(Y,ne){Et(Y,l,ne),_(l,p),_(l,C),_(l,S),oi(S,r[4]),F||(Q=ii(S,"input",r[12]),F=!0)},p(Y,ne){ne&16&&oi(S,Y[4])},d(Y){Y&&bt(l),F=!1,Q()}}}function _l(r){let l,p,C,S,F,Q,Y,ne,k,se,R,be,Se,nt,qe,Ge,Ae,G,q,ye,M,Te,Ie,pe,Be,fe,ve,Oe,P,j,c,X,me,he,ge,Ke,ke,Pe,Ye,He,it,wt,We,V,Ze,Dt,y,b=r[2]==="gpt"&&Er(),$e=r[4]&&r[5]&&Sr(r);return Ze=Qs(r[10][0]),{c(){l=U("div"),p=U("div"),C=ce(),S=U("div"),F=U("div"),F.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',Q=ce(),Y=U("form"),ne=U("div"),k=U("label"),k.textContent="Domain",se=ce(),R=U("p"),R.textContent="Describe what you want to create a map for.",be=ce(),Se=U("textarea"),nt=ce(),qe=U("div"),Ge=U("label"),Ae=U("input"),G=ce(),q=U("span"),q.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,ye=ce(),M=U("fieldset"),Te=U("legend"),Te.textContent="Target",Ie=ce(),pe=U("p"),pe.textContent="Choose where you plan to use the prompt.",Be=ce(),fe=U("label"),ve=U("input"),Oe=ce(),P=U("div"),P.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',j=ce(),c=U("label"),X=U("input"),me=ce(),he=U("div"),he.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',ge=ce(),Ke=U("div"),ke=U("button"),ke.textContent="Copy prompt",Pe=ce(),Ye=U("button"),Ye.textContent="New blank",He=ce(),it=U("div"),wt=ia(r[3]),We=ce(),b&&b.c(),V=ce(),$e&&$e.c(),v(p,"id","newPanelBackdrop"),v(p,"class","shortcut-help__backdrop"),v(F,"class","shortcut-help__header"),v(k,"for","newDomain"),v(R,"class","new-panel__hint"),v(Se,"id","newDomain"),v(Se,"class","pf-v5-c-form-control new-panel__textarea"),v(Se,"rows","4"),Se.required=!0,v(Se,"placeholder","Ex: Companies building open-source geospatial tools"),v(ne,"class","new-panel__field"),v(Ae,"id","seriesToggle"),v(Ae,"type","checkbox"),v(Ge,"class","new-panel__toggle"),v(Ge,"for","seriesToggle"),v(qe,"class","new-panel__field"),v(pe,"class","new-panel__hint"),v(ve,"type","radio"),v(ve,"name","target"),ve.__value="gpt",oi(ve,ve.__value),v(fe,"class","new-panel__option"),v(X,"type","radio"),v(X,"name","target"),X.__value="plain",oi(X,X.__value),v(c,"class","new-panel__option"),v(M,"class","new-panel__field"),v(ke,"class","pf-v5-c-button pf-m-primary"),v(ke,"type","submit"),v(Ye,"id","newBlankButton"),v(Ye,"class","pf-v5-c-button pf-m-secondary"),v(Ye,"type","button"),v(Ye,"title","Start from an empty map"),v(it,"class","new-panel__status"),v(it,"aria-live","polite"),v(Ke,"class","new-panel__actions"),v(Y,"class","shortcut-help__list new-panel__form"),v(S,"class","shortcut-help__panel"),v(S,"tabindex","-1"),v(l,"id","newPanel"),v(l,"class","shortcut-help"),l.hidden=!0,v(l,"aria-hidden","true"),v(l,"role","dialog"),v(l,"aria-modal","true"),v(l,"aria-labelledby","newPanelTitle"),Ze.p(ve,X)},m(J,Ce){Et(J,l,Ce),_(l,p),_(l,C),_(l,S),_(S,F),_(S,Q),_(S,Y),_(Y,ne),_(ne,k),_(ne,se),_(ne,R),_(ne,be),_(ne,Se),oi(Se,r[0]),_(Y,nt),_(Y,qe),_(qe,Ge),_(Ge,Ae),Ae.checked=r[1],_(Ge,G),_(Ge,q),_(Y,ye),_(Y,M),_(M,Te),_(M,Ie),_(M,pe),_(M,Be),_(M,fe),_(fe,ve),ve.checked=ve.__value===r[2],_(fe,Oe),_(fe,P),_(M,j),_(M,c),_(c,X),X.checked=X.__value===r[2],_(c,me),_(c,he),_(Y,ge),_(Y,Ke),_(Ke,ke),_(Ke,Pe),_(Ke,Ye),_(Ke,He),_(Ke,it),_(it,wt),_(Y,We),b&&b.m(Y,null),_(Y,V),$e&&$e.m(Y,null),Dt||(y=[ii(Se,"input",r[7]),ii(Ae,"change",r[8]),ii(ve,"change",r[9]),ii(X,"change",r[11]),ii(Y,"submit",Zs(r[6]))],Dt=!0)},p(J,[Ce]){Ce&1&&oi(Se,J[0]),Ce&2&&(Ae.checked=J[1]),Ce&4&&(ve.checked=ve.__value===J[2]),Ce&4&&(X.checked=X.__value===J[2]),Ce&8&&tl(wt,J[3]),J[2]==="gpt"?b?b.p(J,Ce):(b=Er(),b.c(),b.m(Y,V)):b&&(b.d(1),b=null),J[4]&&J[5]?$e?$e.p(J,Ce):($e=Sr(J),$e.c(),$e.m(Y,null)):$e&&($e.d(1),$e=null)},i:xt,o:xt,d(J){J&&bt(l),b&&b.d(),$e&&$e.d(),Ze.r(),Dt=!1,qi(y)}}}const Cl="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function xl(r,l,p){let C="",S=!1,F="gpt",Q="",Y="",ne=!1;const k=()=>{var G;return typeof navigator<"u"&&!!((G=navigator.clipboard)!=null&&G.writeText)};function se(G){const q=G||"[DOMAIN]",ye=S?"series":"map",Te=kl.replaceAll("[DOMAIN NAME]",q).replaceAll("[DOMAIN]",q).replaceAll("[map|series]",ye).split(`
`),Ie=`Generate a **blockscape ${ye}** for the domain of ${q}.`,pe=Te.findIndex(fe=>fe.toLowerCase().includes("generate a **blockscape value")||fe.toLowerCase().includes("generate a blockscape [map|series]")||fe.toLowerCase().startsWith("generate a blockscape"));pe>=0?Te[pe]=Ie:Te.unshift(Ie);const Be=S?`

User requested a series (return an array of models).`:"";return`${Te.join(`
`).trim()}${Be}`}async function R(G){G.preventDefault();const q=C.trim();if(p(3,Q=""),p(5,ne=F!=="gpt"),!q){p(3,Q="Add a domain to generate a prompt."),p(4,Y="");return}if(F==="gpt"?p(4,Y=`${S?"Create a series":"Create a map"} for ${q}`):(p(4,Y=se(q)),p(5,ne=!0)),!k()){p(3,Q="Clipboard access is unavailable. Copy the prompt below."),p(5,ne=!0);return}try{await navigator.clipboard.writeText(Y),p(3,Q=F==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),F==="gpt"&&p(5,ne=!1)}catch(M){console.warn("[Blockscape] clipboard write failed",M),p(3,Q="Copy failed. Use the prompt below."),p(5,ne=!0)}}const be=[[]];function Se(){C=this.value,p(0,C)}function nt(){S=this.checked,p(1,S)}function qe(){F=this.__value,p(2,F)}function Ge(){F=this.__value,p(2,F)}function Ae(){Y=this.value,p(4,Y)}return[C,S,F,Q,Y,ne,R,Se,nt,qe,be,Ge,Ae]}class Al extends Ao{constructor(l){super(),xo(this,l,xl,_l,So,{})}}const{document:Ir}=Xs;function Tl(r){let l,p,C,S,F,Q,Y,ne,k,se,R,be,Se,nt,qe,Ge,Ae,G,q,ye,M,Te,Ie,pe,Be,fe,ve,Oe,P,j,c,X,me,he,ge,Ke,ke,Pe,Ye,He,it,wt,We,V,Ze,Dt,y,b,$e,J,Ce,dt,K,je,ft,at,bn,jt,Ut,zn,vt,vn,Nn,ri,Sn,Mt,rn,Yt,sn,At,Ht,Xt,qn=`<script id="seed" type="application/json">${r[3]}<\/script>`,Jt,ln,u,h,L,T,E,B,ee,z,Ee,de,re,Ve,lt;return z=new Il({}),de=new Al({}),{c(){l=U("link"),p=ce(),C=U("div"),S=U("header"),F=U("div"),Q=U("div"),Y=U("div"),ne=U("div"),ne.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/> <a href="https://github.com/pwright/blockscape" target="_blank" class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a>',k=ce(),se=U("div"),R=U("div"),be=U("button"),Se=U("span"),Se.textContent="Toggle search and edit tools",nt=ce(),qe=U("span"),qe.textContent="▾",Ge=ce(),Ae=U("button"),Ae.textContent="New",G=ce(),q=U("form"),q.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',ye=ce(),M=U("label"),M.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',Te=ce(),Ie=U("button"),Ie.textContent="Help",pe=ce(),Be=U("div"),fe=U("div"),fe.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',ve=ce(),Oe=U("button"),Oe.textContent="Edit",P=ce(),j=U("button"),j.textContent="Share",he=ce(),ge=U("div"),ge.innerHTML='<span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span> <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span> <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span> <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>',ke=ce(),Pe=U("main"),Ye=U("div"),He=U("aside"),it=U("div"),it.textContent="Models",wt=ce(),We=U("ul"),V=ce(),Ze=U("div"),Ze.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',Dt=ce(),y=U("section"),b=U("div"),b.textContent="Local files",$e=ce(),J=U("p"),J.textContent="Checking for local server…",Ce=ce(),dt=U("div"),K=U("label"),K.textContent="Blockscape files under ~/blockscape",je=ce(),ft=U("div"),at=U("label"),at.textContent="Folder",bn=ce(),jt=U("select"),Ut=U("option"),Ut.textContent="All (~/blockscape)",zn=ce(),vt=U("select"),vn=ce(),Nn=U("div"),Nn.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button>',ri=ce(),Sn=U("div"),Sn.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',rn=ce(),Yt=U("div"),Yt.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,sn=ce(),At=U("footer"),At.innerHTML='<div class="blockscape-footer__inner"><a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a></div>',Ht=ce(),Xt=new nl(!1),Jt=ce(),ln=pr("svg"),u=ce(),h=U("div"),L=ce(),T=U("div"),E=ce(),B=U("div"),B.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',ee=ce(),la(z.$$.fragment),Ee=ce(),la(de.$$.fragment),Ir.title="Blockscape — simple landscape-style tiles",v(l,"rel","icon"),v(l,"type","image/svg+xml"),v(l,"href","./favicon.svg"),v(ne,"class","blockscape-brand"),v(Se,"class","sr-only"),v(qe,"class","blockscape-toolbar__toggle-icon"),v(qe,"aria-hidden","true"),v(be,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__toggle"),v(be,"type","button"),v(be,"aria-expanded",r[0]),v(be,"aria-controls","blockscapeHeaderExtras"),v(Ae,"id","newPanelButton"),v(Ae,"class","pf-v5-c-button pf-m-primary"),v(Ae,"type","button"),v(Ae,"title","Create something new"),v(q,"id","urlForm"),v(q,"class","blockscape-url-form"),v(q,"autocomplete","on"),q.noValidate=!0,v(M,"class","pf-v5-c-button pf-m-primary blockscape-file"),v(Ie,"id","helpButton"),v(Ie,"class","pf-v5-c-button pf-m-primary"),v(Ie,"type","button"),v(Ie,"title","Show keyboard shortcuts"),v(R,"class","blockscape-toolbar__primary"),v(fe,"class","blockscape-search"),v(Oe,"id","openInEditor"),v(Oe,"class","pf-v5-c-button pf-m-secondary"),v(Oe,"type","button"),v(Oe,"title","Open current JSON in the editor"),v(j,"id","shareModel"),v(j,"class","pf-v5-c-button pf-m-secondary"),v(j,"type","button"),v(j,"title","Copy a shareable URL for this model"),v(Be,"id","blockscapeHeaderExtras"),v(Be,"class","blockscape-toolbar__extras"),Be.hidden=c=!r[0],v(Be,"aria-hidden",X=!r[0]),v(se,"class","blockscape-toolbar__controls"),v(se,"data-expanded",me=r[0]?"true":"false"),v(ge,"class","blockscape-legend"),v(ge,"role","presentation"),v(Y,"class","blockscape-toolbar"),v(Q,"class","pf-v5-c-masthead__content"),v(F,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),v(S,"class","pf-v5-c-page__header"),S.hidden=Ke=!r[2],v(it,"class","sidebar-heading"),v(We,"id","modelList"),v(We,"class","model-nav-list"),v(Ze,"class","model-actions"),v(b,"class","sidebar-heading"),v(J,"id","localBackendStatus"),v(J,"class","local-backend__status muted"),v(K,"class","sr-only"),v(K,"for","localFileList"),v(at,"for","localDirSelect"),Ut.__value="",oi(Ut,Ut.__value),v(jt,"id","localDirSelect"),v(jt,"class","pf-v5-c-form-control"),v(jt,"aria-label","Folder filter"),v(ft,"class","local-backend__dir"),v(vt,"id","localFileList"),v(vt,"class","pf-v5-c-form-control"),v(vt,"size","12"),vt.multiple=!0,v(vt,"aria-label","Blockscape files on local server"),v(Nn,"class","local-backend__actions"),v(dt,"class","local-backend__list"),v(Sn,"class","local-backend__save"),v(y,"id","localBackendPanel"),v(y,"class","local-backend"),y.hidden=!0,v(He,"class","blockscape-sidebar"),v(He,"aria-label","Models"),He.hidden=Mt=!r[1],v(Yt,"class","blockscape-main"),v(Ye,"class","blockscape-content"),v(Pe,"class","pf-v5-c-page__main"),v(At,"class","pf-v5-c-page__footer blockscape-footer"),v(C,"class","pf-v5-c-page"),Xt.a=Jt,v(ln,"id","overlay"),v(ln,"class","svg-layer"),v(h,"id","tabTooltip"),v(h,"class","blockscape-tab-tooltip"),h.hidden=!0,v(h,"aria-hidden","true"),v(T,"id","tileContextMenu"),v(T,"class","tile-context-menu"),T.hidden=!0,v(T,"aria-hidden","true"),v(B,"id","itemPreview"),v(B,"class","item-preview"),B.hidden=!0,v(B,"aria-hidden","true")},m(Z,Le){_(Ir.head,l),Et(Z,p,Le),Et(Z,C,Le),_(C,S),_(S,F),_(F,Q),_(Q,Y),_(Y,ne),_(Y,k),_(Y,se),_(se,R),_(R,be),_(be,Se),_(be,nt),_(be,qe),_(R,Ge),_(R,Ae),_(R,G),_(R,q),_(R,ye),_(R,M),_(R,Te),_(R,Ie),_(se,pe),_(se,Be),_(Be,fe),_(Be,ve),_(Be,Oe),_(Be,P),_(Be,j),_(Y,he),_(Y,ge),_(C,ke),_(C,Pe),_(Pe,Ye),_(Ye,He),_(He,it),_(He,wt),_(He,We),_(He,V),_(He,Ze),_(He,Dt),_(He,y),_(y,b),_(y,$e),_(y,J),_(y,Ce),_(y,dt),_(dt,K),_(dt,je),_(dt,ft),_(ft,at),_(ft,bn),_(ft,jt),_(jt,Ut),_(dt,zn),_(dt,vt),_(dt,vn),_(dt,Nn),_(y,ri),_(y,Sn),_(Ye,rn),_(Ye,Yt),_(C,sn),_(C,At),Et(Z,Ht,Le),Xt.m(qn,Z,Le),Et(Z,Jt,Le),Et(Z,ln,Le),Et(Z,u,Le),Et(Z,h,Le),Et(Z,L,Le),Et(Z,T,Le),Et(Z,E,Le),Et(Z,B,Le),Et(Z,ee,Le),_o(z,Z,Le),Et(Z,Ee,Le),_o(de,Z,Le),re=!0,Ve||(lt=ii(be,"click",r[4]),Ve=!0)},p(Z,[Le]){(!re||Le&1)&&v(be,"aria-expanded",Z[0]),(!re||Le&1&&c!==(c=!Z[0]))&&(Be.hidden=c),(!re||Le&1&&X!==(X=!Z[0]))&&v(Be,"aria-hidden",X),(!re||Le&1&&me!==(me=Z[0]?"true":"false"))&&v(se,"data-expanded",me),(!re||Le&4&&Ke!==(Ke=!Z[2]))&&(S.hidden=Ke),(!re||Le&2&&Mt!==(Mt=!Z[1]))&&(He.hidden=Mt)},i(Z){re||(ko(z.$$.fragment,Z),ko(de.$$.fragment,Z),re=!0)},o(Z){sa(z.$$.fragment,Z),sa(de.$$.fragment,Z),re=!1},d(Z){Z&&(bt(p),bt(C),bt(Ht),Xt.d(),bt(Jt),bt(ln),bt(u),bt(h),bt(L),bt(T),bt(E),bt(B),bt(ee),bt(Ee)),bt(l),Co(z,Z),Co(de,Z),Ve=!1,lt()}}}function Ll(r,l,p){let C,S,{seed:F}=l,{features:Q={}}=l;const ne=F?JSON.stringify(F,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let k=!1;const se=()=>{if(p(0,k=!k),!k){const R=document.getElementById("search");R&&R.value&&(R.value="",R.dispatchEvent(new Event("input",{bubbles:!0})))}};return ol(()=>{El(Q)}),r.$$set=R=>{"seed"in R&&p(5,F=R.seed),"features"in R&&p(6,Q=R.features)},r.$$.update=()=>{r.$$.dirty&64&&p(2,C=Q.showHeader!==!1),r.$$.dirty&64&&p(1,S=Q.showSidebar!==!1)},[k,S,C,ne,se,F,Q]}class Nl extends Ao{constructor(l){super(),xo(this,l,Ll,Tl,So,{seed:5,features:6})}}function Ml(r){let l,p;return l=new Nl({props:{seed:r[0],features:r[1]}}),{c(){la(l.$$.fragment)},m(C,S){_o(l,C,S),p=!0},p(C,[S]){const F={};S&1&&(F.seed=C[0]),S&2&&(F.features=C[1]),l.$set(F)},i(C){p||(ko(l.$$.fragment,C),p=!0)},o(C){sa(l.$$.fragment,C),p=!1},d(C){Co(l,C)}}}function Bl(r,l,p){let{seed:C}=l,{features:S={}}=l;return r.$$set=F=>{"seed"in F&&p(0,C=F.seed),"features"in F&&p(1,S=F.features)},[C,S]}class $l extends Ao{constructor(l){super(),xo(this,l,Bl,Ml,So,{seed:0,features:1})}}return $l}();
