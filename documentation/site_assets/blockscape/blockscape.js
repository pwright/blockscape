var Blockscape=function(){"use strict";var hu=Object.defineProperty;var gu=(An,wt,ei)=>wt in An?hu(An,wt,{enumerable:!0,configurable:!0,writable:!0,value:ei}):An[wt]=ei;var Qn=(An,wt,ei)=>gu(An,typeof wt!="symbol"?wt+"":wt,ei);var An=typeof document<"u"?document.currentScript:null;function wt(){}function ei(r){return r()}function cr(){return Object.create(null)}function Gi(r){r.forEach(ei)}function dr(r){return typeof r=="function"}function Eo(r,c){return r!=r?c==c:r!==c||r&&typeof r=="object"||typeof r=="function"}function Gs(r){return Object.keys(r).length===0}const Ks=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function _(r,c){r.appendChild(c)}function mt(r,c,p){r.insertBefore(c,p||null)}function ft(r){r.parentNode&&r.parentNode.removeChild(r)}function U(r){return document.createElement(r)}function ur(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function ia(r){return document.createTextNode(r)}function se(){return ia(" ")}function ti(r,c,p,I){return r.addEventListener(c,p,I),()=>r.removeEventListener(c,p,I)}function Ys(r){return function(c){return c.preventDefault(),r.call(this,c)}}function b(r,c,p){p==null?r.removeAttribute(c):r.getAttribute(c)!==p&&r.setAttribute(c,p)}function Xs(r){let c;return{p(...p){c=p,c.forEach(I=>r.push(I))},r(){c.forEach(p=>r.splice(r.indexOf(p),1))}}}function Zs(r){return Array.from(r.childNodes)}function Qs(r,c){c=""+c,r.data!==c&&(r.data=c)}function ni(r,c){r.value=c??""}class el{constructor(c=!1){Qn(this,"is_svg",!1);Qn(this,"e");Qn(this,"n");Qn(this,"t");Qn(this,"a");this.is_svg=c,this.e=this.n=null}c(c){this.h(c)}m(c,p,I=null){this.e||(this.is_svg?this.e=ur(p.nodeName):this.e=U(p.nodeType===11?"TEMPLATE":p.nodeName),this.t=p.tagName!=="TEMPLATE"?p:p.content,this.c(c)),this.i(I)}h(c){this.e.innerHTML=c,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(c){for(let p=0;p<this.n.length;p+=1)mt(this.t,this.n[p],c)}p(c){this.d(),this.h(c),this.i(this.a)}d(){this.n.forEach(ft)}}let Ki;function Yi(r){Ki=r}function tl(){if(!Ki)throw new Error("Function called outside component initialization");return Ki}function nl(r){tl().$$.on_mount.push(r)}const hi=[],pr=[];let gi=[];const fr=[],il=Promise.resolve();let oa=!1;function ol(){oa||(oa=!0,il.then(mr))}function aa(r){gi.push(r)}const ra=new Set;let bi=0;function mr(){if(bi!==0)return;const r=Ki;do{try{for(;bi<hi.length;){const c=hi[bi];bi++,Yi(c),al(c.$$)}}catch(c){throw hi.length=0,bi=0,c}for(Yi(null),hi.length=0,bi=0;pr.length;)pr.pop()();for(let c=0;c<gi.length;c+=1){const p=gi[c];ra.has(p)||(ra.add(p),p())}gi.length=0}while(hi.length);for(;fr.length;)fr.pop()();oa=!1,ra.clear(),Yi(r)}function al(r){if(r.fragment!==null){r.update(),Gi(r.before_update);const c=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,c),r.after_update.forEach(aa)}}function rl(r){const c=[],p=[];gi.forEach(I=>r.indexOf(I)===-1?c.push(I):p.push(I)),p.forEach(I=>I()),gi=c}const So=new Set;let sl;function Io(r,c){r&&r.i&&(So.delete(r),r.i(c))}function sa(r,c,p,I){if(r&&r.o){if(So.has(r))return;So.add(r),sl.c.push(()=>{So.delete(r)}),r.o(c)}}function la(r){r&&r.c()}function ko(r,c,p){const{fragment:I,after_update:N}=r.$$;I&&I.m(c,p),aa(()=>{const X=r.$$.on_mount.map(ei).filter(dr);r.$$.on_destroy?r.$$.on_destroy.push(...X):Gi(X),r.$$.on_mount=[]}),N.forEach(aa)}function _o(r,c){const p=r.$$;p.fragment!==null&&(rl(p.after_update),Gi(p.on_destroy),p.fragment&&p.fragment.d(c),p.on_destroy=p.fragment=null,p.ctx=[])}function ll(r,c){r.$$.dirty[0]===-1&&(hi.push(r),ol(),r.$$.dirty.fill(0)),r.$$.dirty[c/31|0]|=1<<c%31}function Co(r,c,p,I,N,X,ie=null,q=[-1]){const K=Ki;Yi(r);const C=r.$$={fragment:null,ctx:[],props:X,update:wt,not_equal:N,bound:cr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(c.context||(K?K.$$.context:[])),callbacks:cr(),dirty:q,skip_bound:!1,root:c.target||K.$$.root};ie&&ie(C.root);let he=!1;if(C.ctx=p?p(r,c.props||{},(j,me,...ke)=>{const Ye=ke.length?ke[0]:me;return C.ctx&&N(C.ctx[j],C.ctx[j]=Ye)&&(!C.skip_bound&&C.bound[j]&&C.bound[j](Ye),he&&ll(r,j)),me}):[],C.update(),he=!0,Gi(C.before_update),C.fragment=I?I(C.ctx):!1,c.target){if(c.hydrate){const j=Zs(c.target);C.fragment&&C.fragment.l(j),j.forEach(ft)}else C.fragment&&C.fragment.c();c.intro&&Io(r.$$.fragment),ko(r,c.target,c.anchor),mr()}Yi(K)}class xo{constructor(){Qn(this,"$$");Qn(this,"$$set")}$destroy(){_o(this,1),this.$destroy=wt}$on(c,p){if(!dr(p))return wt;const I=this.$$.callbacks[c]||(this.$$.callbacks[c]=[]);return I.push(p),()=>{const N=I.indexOf(p);N!==-1&&I.splice(N,1)}}$set(c){this.$$set&&!Gs(c)&&(this.$$.skip_bound=!0,this.$$set(c),this.$$.skip_bound=!1)}}const cl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(cl);const hr="blockscape:apicurioConfig",ca="http://localhost:8080/apis/registry/v3",Ao="bs",gr="-series",da=!1,ua=!1;function dl({models:r,getActiveIndex:c,setActive:p,ensureModelMetadata:I,ensureSeriesId:N,getModelId:X,getSeriesId:ie,getModelTitle:q,computeJsonFingerprint:K,uid:C}){let he=null,j=null,me=null,ke=null,Ye=null,je=null,Ge=null,Te=null,z=null,W=null;const ye=new Set,M={baseUrl:ca,groupId:Ao,authToken:"",enabled:da,useSemver:ua},Ie=new Map,Me=new Map;function ce(u){return(u||"").toString().trim().replace(/\/+$/,"")}function Le(u){return`${(u||"").toString().trim()||Ao}${gr}`}function Ce(){return!!(M.baseUrl&&M.groupId)}function be(){return M.enabled!==!1}function ge(){ye.forEach(u=>{try{u(be())}catch(g){console.warn("[Blockscape] failed to run Apicurio enabled listener",g)}})}function O(u){return typeof u=="function"&&ye.add(u),()=>ye.delete(u)}function Y(){me&&(me.value=M.baseUrl||""),ke&&(ke.value=M.groupId||""),Ye&&(Ye.value=M.authToken||""),je&&(je.checked=be()),Ge&&(Ge.checked=!!M.useSemver)}function l(u="",g="muted"){Te&&(Te.textContent=u||"",Te.classList.remove("is-error","is-success"),g==="error"?Te.classList.add("is-error"):g==="success"&&Te.classList.add("is-success"))}function P(u){if(!W||(W.innerHTML="",!u))return;const g=document.createElement("p");g.className="apicurio-hint",g.textContent=u,W.appendChild(g)}function le(u){Ie.clear(),Me.clear(),P(u)}function Oe(){const u=c(),g=be(),L=Ce(),x=u>=0?r[u]:null,S=!!(x!=null&&x.apicurioVersions&&x.apicurioVersions.length>1);if(he){const R=he.dataset.loading==="true",ee=g&&L&&u>=0&&!!y(r[u]);he.disabled=!g||R||!ee,g?R||(he.textContent="Push to Apicurio"):he.textContent="Enable Apicurio to push"}if(z){const R=z.dataset.loading==="true",ee=g&&L&&S&&!!y(x);z.disabled=!ee||R,z.hidden=!S,g?R||(z.textContent="Push series"):z.textContent="Enable Apicurio to push series"}if(j){const R=j.dataset.loading==="true",ee=g&&L;j.disabled=!ee||R,R||(g?L?j.textContent="List artifacts":j.textContent="Enter details to list":j.textContent="Enable Apicurio to list")}}function ue(){Y(),be()?Ce()?(l("Apicurio push is ready when a model is selected.","muted"),Ie.size||P("Click “List artifacts” to browse the current group.")):(l("Enter Apicurio connection details to enable push.","muted"),le("Enter registry details to browse artifacts.")):(l("Apicurio integration is off. Enable it to allow pushes.","muted"),le("Apicurio integration is disabled.")),Oe()}function He(){if(window!=null&&window.localStorage)try{localStorage.setItem(hr,JSON.stringify(M))}catch(u){console.warn("[Blockscape] unable to persist Apicurio settings",u)}}function st(){let u={};if(window!=null&&window.localStorage)try{const R=localStorage.getItem(hr);if(R){const ee=JSON.parse(R);ee&&typeof ee=="object"&&(u=ee)}}catch(R){console.warn("[Blockscape] failed to restore Apicurio settings",R)}const g=ce(u.baseUrl??ca),L=(u.groupId??Ao).toString().trim();let x=da,S=ua;typeof u.enabled=="boolean"?x=u.enabled:typeof u.enabled=="string"&&(x=u.enabled==="true"),typeof u.useSemver=="boolean"?S=u.useSemver:typeof u.useSemver=="string"&&(S=u.useSemver==="true"),M.baseUrl=g||ca,M.groupId=L||Ao,M.authToken=(u.authToken??"").toString().trim(),M.enabled=x,M.useSemver=S,ue(),ge()}function Xe(){const u={Accept:"application/json"},g=(M.authToken||"").trim();return g&&(u.Authorization=/\s/.test(g)?g:`Bearer ${g}`),u}function Pe(u,g,{title:L,description:x,version:S}={}){const R={artifactId:u,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:g},metadata:{properties:{}}}};S&&(R.firstVersion.version=S),L&&(R.name=L),x&&(R.description=x);try{const ee=JSON.parse(g),J=ee==null?void 0:ee.seriesId;J&&typeof J=="string"&&(R.firstVersion.metadata.properties.seriesId=J)}catch{}return R}function ut(u,{version:g}={}){const L={content:{contentType:"application/json",content:u},metadata:{properties:{}}};try{const x=JSON.parse(u),S=x==null?void 0:x.seriesId;S&&typeof S=="string"&&(L.metadata.properties.seriesId=S)}catch{}return g&&(L.version=g),L}function Fe(u){if(u==null)return null;const g=String(u).trim();if(!g)return null;const L=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(g);if(L)return{major:Number(L[1]),minor:Number(L[2]),patch:Number(L[3])};const x=/^v?(\d+)$/.exec(g);return x?{major:Number(x[1]),minor:0,patch:0}:null}function lt(u){return`${u.major}.${u.minor}.${u.patch}`}function kt(u,g){return!u&&!g?0:u?g?u.major!==g.major?u.major-g.major:u.minor!==g.minor?u.minor-g.minor:u.patch-g.patch:1:-1}function V(u=[]){let g=null;if(u.forEach(x=>{const S=Fe((x==null?void 0:x.version)??x);S&&(!g||kt(S,g)>0)&&(g=S)}),!g)return"1.0.0";const L={...g,patch:g.patch+1};return lt(L)}function y(u,{seriesName:g,fallbackTitle:L}={}){var R;if(!u)return null;const x=g||u.title||u.apicurioArtifactName||q(u),S=L||x;if(typeof N=="function"&&(u.isSeries||((R=u.apicurioVersions)==null?void 0:R.length)>1)&&N(u,{seriesName:x,fallbackTitle:S}),typeof ie=="function"){const ee=ie(u,{seriesName:x,fallbackTitle:S});if(ee)return ee}return X(u)}function v(u){return Array.isArray(u)?u:Array.isArray(u==null?void 0:u.artifacts)?u.artifacts:Array.isArray(u==null?void 0:u.items)?u.items:Array.isArray(u==null?void 0:u.results)?u.results:[]}function Je(u){return Array.isArray(u)?u:Array.isArray(u==null?void 0:u.versions)?u.versions:Array.isArray(u==null?void 0:u.items)?u.items:[]}function G(u=[]){if(!Array.isArray(u)||!u.length)return null;const g=[...u].filter(Boolean);return g.sort((L,x)=>{const S=L!=null&&L.createdOn?new Date(L.createdOn).getTime():0,R=x!=null&&x.createdOn?new Date(x.createdOn).getTime():0;if(S!==R)return R-S;const ee=Number(L==null?void 0:L.version),J=Number(x==null?void 0:x.version),de=Number.isFinite(ee),fe=Number.isFinite(J);if(de&&fe&&ee!==J)return J-ee;const Ee=String((L==null?void 0:L.version)??"");return String((x==null?void 0:x.version)??"").localeCompare(Ee,void 0,{numeric:!0})}),g[0]||null}function ve(u){if(!u)return u;let g=u;if(!Array.isArray(u==null?void 0:u.categories)){const x=u==null?void 0:u.content;if(typeof x=="string")try{g=JSON.parse(x)}catch(S){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",S)}else x&&typeof x=="object"&&(g=x)}return g}async function Ve(u,g,L){const x=encodeURIComponent(g),S=encodeURIComponent(L),R=`${u}/groups/${x}/artifacts/${S}`,ee=Xe();ee.Accept="application/json";const J=await fetch(R,{method:"GET",headers:ee});if(!J.ok){let de=J.statusText||"Unknown error";try{const fe=await J.text();fe&&(de=fe.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${J.status}): ${de}`)}return J.json()}async function $(u,g,L){const x=encodeURIComponent(g),S=encodeURIComponent(L),R=`${u}/groups/${x}/artifacts/${S}/versions?limit=50&order=desc`,ee=Xe();ee.Accept="application/json";const J=await fetch(R,{method:"GET",headers:ee});if(!J.ok){let fe=J.statusText||"Unknown error";try{const Ee=await J.text();Ee&&(fe=Ee.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${J.status}): ${fe}`)}const de=await J.json();return Je(de).filter(fe=>fe&&fe.version!=null)}async function xe(u,g,L,x="latest"){const S=encodeURIComponent(g),R=encodeURIComponent(L),ee=encodeURIComponent(x||"latest"),J=`${u}/groups/${S}/artifacts/${R}/versions/${ee}/content`,de=Xe();de.Accept="application/json, application/*+json, */*;q=0.8";const fe=await fetch(J,{method:"GET",headers:de});if(!fe.ok){let we=fe.statusText||"Unknown error";try{const Ae=await fe.text();Ae&&(we=Ae.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${fe.status}): ${we}`)}const Ee=await fe.text();let Z=null;try{Z=JSON.parse(Ee)}catch{throw new Error("Artifact content is not valid JSON.")}return ve(Z)}async function ht(u,g,L,x="latest"){const S=await xe(u,g,L,x);return{data:S,fingerprint:K(S)}}async function Ze(u,g,L){try{const S=await $(u,g,L);if(S!=null&&S.length){Me.set(L,S);const R=G(S);if((R==null?void 0:R.version)!=null)return R.version}}catch(S){console.warn("[Blockscape] compare-version: unable to fetch versions list",S)}try{const S=await Ve(u,g,L);if((S==null?void 0:S.version)!=null)return S.version}catch(S){console.warn("[Blockscape] compare-version: unable to fetch metadata",S)}const x=Me.get(L);if(x&&x.length){const S=G(x);if((S==null?void 0:S.version)!=null)return S.version}return"latest"}async function Ft(u,g,L,x){if(!M.useSemver)return null;if(!x)return"1.0.0";try{const S=await $(u,g,L);return V(S)}catch(S){throw new Error(`Unable to compute next semantic version: ${S.message}`)}}function Tn(u=document){he=u.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),z=u.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),j=u.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),me=u.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),ke=u.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),Ye=u.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),je=u.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),Ge=u.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),Te=u.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),W=u.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function Ot(){M.baseUrl=ce((me==null?void 0:me.value)??M.baseUrl),M.groupId=((ke==null?void 0:ke.value)??"").trim(),M.authToken=((Ye==null?void 0:Ye.value)??"").trim(),He(),ue()}function Kt(u){M.enabled=u!==!1,He(),ue(),ge()}function Pt(){Kt(je?je.checked:da)}function _t(){M.useSemver=Ge?Ge.checked:ua,He(),ue()}function oi(){[me,ke,Ye].forEach(u=>{u&&u.addEventListener("input",Ot)}),he&&he.addEventListener("click",()=>{Jn()}),z&&z.addEventListener("click",()=>{jt()}),je&&je.addEventListener("change",Pt),Ge&&Ge.addEventListener("change",_t),j&&j.addEventListener("click",un),W&&W.addEventListener("click",u=>{const g=u.target.closest("[data-artifact-version]");if(g){u.stopPropagation();const S=g.dataset.artifactId,R=g.dataset.artifactVersion;S&&R&&Sn(S,R);return}const L=u.target.closest("[data-artifact-load-all]");if(L){u.stopPropagation(),L.dataset.artifactId&&Dt();return}const x=u.target.closest("[data-artifact-trigger]");if(x){const S=x.dataset.artifactId;if(!S)return;xt(S)}})}function Ln(){const u=document.createElement("div");return u.className="blockscape-registry-panel",u.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,u}function ai(u){if(!u)return;u.innerHTML="";const g=Ln();u.appendChild(g),Tn(u),oi(),ue()}function Yt(u){if(!W)return;if(W.innerHTML="",!u.length){P("No artifacts found in this group.");return}const g=S=>{const R=document.createElement("section");R.className="apicurio-artifact-section";const ee=document.createElement("h3");ee.textContent=S,R.appendChild(ee);const J=document.createElement("ul");return J.className="apicurio-artifact-list",R.appendChild(J),{section:R,list:J}},L=g("Series artifacts"),x=g("Artifacts");u.forEach(S=>{if(!(S!=null&&S.artifactId))return;const ee=S._groupId&&S._groupId.endsWith(gr)?L.list:x.list,J=document.createElement("li"),de=document.createElement("button");de.type="button",de.className="apicurio-artifact",de.dataset.artifactId=S.artifactId,de.dataset.artifactTrigger="toggle";const fe=document.createElement("span");fe.className="apicurio-artifact-title",fe.textContent=S.artifactId,de.appendChild(fe);const Ee=[];if(S.name&&Ee.push(S.name),S.version!=null&&Ee.push(`v${S.version}`),S.type&&Ee.push(S.type),S._groupId&&Ee.push(S._groupId),Ee.length){const Ae=document.createElement("span");Ae.className="apicurio-artifact-meta",Ae.textContent=Ee.join(" • "),de.appendChild(Ae)}if(S.description){const Ae=document.createElement("span");Ae.className="apicurio-artifact-meta",Ae.textContent=S.description,de.appendChild(Ae)}J.appendChild(de);const Z=document.createElement("div");Z.className="apicurio-version-list",Z.dataset.versionPanel=S.artifactId,Z.hidden=!0;const we=document.createElement("p");we.className="apicurio-hint",we.textContent="Click to load the latest or open versions.",Z.appendChild(we),J.appendChild(Z),ee.appendChild(J)}),L.list.children.length&&W.appendChild(L.section),x.list.children.length&&W.appendChild(x.section)}function Xt(u){return W?W.querySelector(`[data-version-panel="${u}"]`):null}function Ct(u,g){if(!u||(u.innerHTML="",!g))return;const L=document.createElement("p");L.className="apicurio-hint",L.textContent=g,u.appendChild(L)}function dn(u,g){const L=Xt(u);if(L){if(L.innerHTML="",!g.length){Ct(L,"No versions found for this artifact.");return}g.forEach(x=>{const S=document.createElement("button");S.type="button",S.className="apicurio-version-button",S.dataset.artifactId=u,S.dataset.artifactVersion=x.version;const R=[`Version ${x.version}`];if(x.createdOn){const ee=new Date(x.createdOn);isNaN(ee)||R.push(ee.toISOString().slice(0,10))}S.textContent=R.join(" — "),L.appendChild(S)})}}async function xt(u){const g=Xt(u);if(!g)return;if(g.dataset.open==="true"){g.hidden=!0,g.dataset.open="false";return}if(g.hidden=!1,g.dataset.open="true",g.dataset.loaded!=="true"){if(!Ce()){Ct(g,"Enter registry details first.");return}Ct(g,"Loading versions…");try{const x=ce(M.baseUrl),S=Ie.get(u),R=M.groupId.trim(),ee=(S==null?void 0:S._groupId)||R,J=await $(x,ee,u);Me.set(u,J),g.dataset.loaded="true",dn(u,J)}catch(x){console.error("[Blockscape] failed to load versions",x),Ct(g,`Unable to fetch versions: ${x.message}`)}}}function Vt(u,g){var x;const L=r.findIndex(S=>S.apicurioArtifactId===u);if(L!==-1){const S=r[L].id;r[L]={...g,id:S||g.id},((x=r[L].apicurioVersions)==null?void 0:x.length)>1&&(r[L].isSeries=!0),p(L)}else r.push(g),p(r.length-1)}async function Wt(u,g,L,x){const S=encodeURIComponent(g),R=encodeURIComponent(L),ee=`${u}/groups/${S}/artifacts/${R}`;try{const J=await fetch(ee,{method:"GET",headers:x});if(J.status===404)return!1;if(J.ok)return!0;throw J.status===401||J.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${J.status} while checking the artifact.`)}catch(J){throw J instanceof TypeError?new Error("Network error while contacting Apicurio registry."):J}}async function Jn(){var ee;if(!he||he.dataset.loading==="true")return;if(!be()){l("Apicurio integration is off. Enable it first.","error");return}if(!Ce()){l("Enter the registry base URL and group ID before pushing.","error");return}const u=c();if(u<0||!r[u]){l("No active model to push.","error");return}const g=y(r[u],{fallbackTitle:q(r[u])});if(!g){l("Active model needs an id before pushing.","error");return}const L=ce(M.baseUrl),x=M.groupId.trim(),S=JSON.stringify(r[u].data,null,2),R=Xe();he.dataset.loading="true",he.textContent="Pushing…",he.disabled=!0,l("Pushing to Apicurio…","muted");try{const J=await Wt(L,x,g,R),de=K(r[u].data);if(J)try{const Qe=await Ze(L,x,g),{data:Tt,fingerprint:Lt}=await ht(L,x,g,Qe);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",Qe),console.log("local fingerprint",de),console.log("registry fingerprint",Lt),console.log("local payload",r[u].data),console.log("registry payload",Tt),console.groupEnd(),de&&Lt&&de===Lt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){l("Push cancelled (content matches the latest registry version).","muted");return}l("Pushing identical content by user choice.","muted")}else Lt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):l("Unable to compare with registry content (skipping confirmation).","muted")}catch(Qe){console.warn("[Blockscape] unable to compare registry content before push",Qe),l("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const fe=M.useSemver?await Ft(L,x,g,J):null;if(M.useSemver&&!fe)throw new Error("Semantic versioning is enabled but no version could be computed.");const Ee=encodeURIComponent(x),Z=encodeURIComponent(g),we=J?`${L}/groups/${Ee}/artifacts/${Z}/versions`:`${L}/groups/${Ee}/artifacts`,Ae={...R,"Content-Type":"application/json"};fe&&(Ae["X-Registry-Version"]=fe,l(`Pushing to Apicurio as version ${fe}…`,"muted"));const Zt=J?ut(S,{version:fe}):Pe(g,S,{title:q(r[u]),description:(ee=r[u].data)==null?void 0:ee.abstract,version:fe}),Qt=await fetch(we,{method:"POST",headers:Ae,body:JSON.stringify(Zt)});if(!Qt.ok){let Qe=Qt.statusText||"Unknown error";try{const Tt=await Qt.text();Tt&&(Qe=Tt.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Qt.status}): ${Qe}`)}let At=null;try{At=await Qt.json()}catch{At=null}const De=(At==null?void 0:At.version)||(At==null?void 0:At.globalId)||"",pt=J?"Updated":"Created",Jt=De?` (version ${De})`:"";l(`${pt} ${g}${Jt}`,"success")}catch(J){console.error("[Blockscape] Apicurio push failed",J),l(`Apicurio push failed: ${J.message}`,"error")}finally{he.dataset.loading="false",Oe()}}async function jt(){var fe,Ee;if(!z||z.dataset.loading==="true")return;if(!be()){l("Apicurio integration is off. Enable it first.","error");return}if(!Ce()){l("Enter the registry base URL and group ID before pushing.","error");return}const u=c(),g=u>=0?r[u]:null;if(!g||!g.apicurioVersions||g.apicurioVersions.length<2){l("Series push requires a model with multiple versions.","error");return}const L=y(g,{seriesName:g.title||g.apicurioArtifactName||q(g)});if(!L){l("Active series needs an id before pushing.","error");return}typeof N=="function"&&N(g,{seriesName:g.title||g.apicurioArtifactName||q(g)});const x=ce(M.baseUrl),S=M.groupId.trim(),R=g.apicurioVersions.map(Z=>Z.data),ee=JSON.stringify(R,null,2),J=Xe(),de=Le(S);z.dataset.loading="true",z.textContent="Pushing…",z.disabled=!0,l("Pushing series to Apicurio…","muted");try{const Z=await Wt(x,de,L,J),we=K(R);if(Z)try{const pn=await Ze(x,de,L),{data:ri,fingerprint:si}=await ht(x,de,L,pn);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",pn),console.log("local fingerprint",we),console.log("registry fingerprint",si),console.log("local payload (series)",R),console.log("registry payload",ri),console.groupEnd(),we&&si&&we===si){if(!window.confirm("The current registry version matches this series. Push anyway?")){l("Series push cancelled (content matches latest).","muted");return}l("Pushing identical series by user choice.","muted")}else si?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):l("Unable to compare with registry content (skipping confirmation).","muted")}catch(pn){console.warn("[Blockscape] unable to compare registry content before series push",pn),l("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const Ae=M.useSemver?await Ft(x,de,L,Z):null;if(M.useSemver&&!Ae)throw new Error("Semantic versioning is enabled but no version could be computed.");const Zt=encodeURIComponent(de),Qt=encodeURIComponent(L),At=Z?`${x}/groups/${Zt}/artifacts/${Qt}/versions`:`${x}/groups/${Zt}/artifacts`,De={...J,"Content-Type":"application/json"};Ae&&(De["X-Registry-Version"]=Ae,l(`Pushing series to Apicurio as version ${Ae}…`,"muted"));const pt=Z?ut(ee,{version:Ae}):Pe(L,ee,{title:g.apicurioArtifactName||((fe=g.data)==null?void 0:fe.title)||L,description:(Ee=g.data)==null?void 0:Ee.abstract,version:Ae}),Jt=await fetch(At,{method:"POST",headers:De,body:JSON.stringify(pt)});if(!Jt.ok){let pn=Jt.statusText||"Unknown error";try{const ri=await Jt.text();ri&&(pn=ri.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${Jt.status}): ${pn}`)}let Qe=null;try{Qe=await Jt.json()}catch{Qe=null}const Tt=(Qe==null?void 0:Qe.version)||(Qe==null?void 0:Qe.globalId)||"",Lt=Z?"Updated":"Created",en=Tt?` (version ${Tt})`:"";l(`${Lt} ${L} series${en}`,"success")}catch(Z){console.error("[Blockscape] Apicurio series push failed",Z),l(`Apicurio series push failed: ${Z.message}`,"error")}finally{z.dataset.loading="false",Oe()}}async function un(){if(!j||j.dataset.loading==="true")return;if(!be()){l("Enable Apicurio integration to list artifacts.","error");return}if(!Ce()){l("Enter registry base URL and group ID before listing.","error");return}const u=ce(M.baseUrl),g=M.groupId.trim(),L=Le(g),x=[{groupId:g,label:"base"},{groupId:L,label:"series"}];j.dataset.loading="true",j.textContent="Listing…",j.disabled=!0,l("Listing artifacts…","muted"),P("Contacting registry…");try{const S=Xe();S.Accept="application/json";const R=[];for(const J of x){const de=encodeURIComponent(J.groupId),fe=`${u}/groups/${de}/artifacts?limit=50&offset=0`,Ee=await fetch(fe,{method:"GET",headers:S});if(!Ee.ok){let Ae=Ee.statusText||"Unknown error";try{const Zt=await Ee.text();Zt&&(Ae=Zt.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${J.groupId} (${Ee.status}): ${Ae}`);continue}const Z=await Ee.json(),we=v(Z).filter(Ae=>Ae&&Ae.artifactId);we.forEach(Ae=>{Ae&&(Ae._groupId=J.groupId)}),R.push(...we)}Ie.clear(),Me.clear(),R.forEach(J=>{J!=null&&J.artifactId&&Ie.set(J.artifactId,J)}),Yt(R);const ee=R.length;l(ee?`Found ${ee} artifact${ee===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",ee?"success":"muted")}catch(S){console.error("[Blockscape] failed to list artifacts",S),le("Unable to list artifacts."),l(`Listing failed: ${S.message}`,"error")}finally{j.dataset.loading="false",Oe()}}async function Sn(u,g=null){var Z,we,Ae,Zt,Qt,At;if(!u)return;if(!be()){l("Enable Apicurio integration to load artifacts.","error");return}if(!Ce()){l("Enter registry connection details before loading artifacts.","error");return}const L=ce(M.baseUrl),x=M.groupId.trim(),S=u&&((Z=Ie.get(u))==null?void 0:Z._groupId)||x;let R=Ie.get(u);const ee=async()=>{try{const De=await Ve(L,S,u);return De!=null&&De.artifactId&&Ie.set(u,De),De}catch(De){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",De),De}};if(!R)try{R=await ee()}catch(De){l(`Failed to fetch artifact metadata: ${De.message}`,"error");return}const J=Me.get(u)||[];let de="latest",fe="latest";if(g)de=g,fe=g;else{if(!R||R.version==null)try{R=await ee()}catch(De){l(`Failed to fetch artifact metadata: ${De.message}`,"error");return}de=(R==null?void 0:R.version)||"latest",fe=(R==null?void 0:R.version)||"latest"}const Ee=J.find(De=>String(De.version)===String(de));(Ee==null?void 0:Ee.version)!=null&&(fe=Ee.version),l(`Loading artifact ${u}…`,"muted");try{const De=await xe(L,S,u,de),pt=Ie.get(u)||R||{},Jt=Array.isArray(De);let Qe=null;if(Jt){const Tt=De.map((en,pn)=>(I(en,{titleHint:pt.name||u,idHint:u}),{version:String(pn+1),data:en,createdOn:(Ee==null?void 0:Ee.createdOn)||pt.createdOn}));Qe={id:C(),title:((Ae=(we=Tt[0])==null?void 0:we.data)==null?void 0:Ae.title)||pt.name||u,data:(Zt=Tt[0])==null?void 0:Zt.data,apicurioArtifactId:u,apicurioArtifactName:pt.name||"",apicurioVersions:Tt,apicurioActiveVersionIndex:0,isSeries:!0};const Lt=((Qt=pt==null?void 0:pt.properties)==null?void 0:Qt.seriesId)||u;typeof N=="function"&&N(Qe,{seriesName:Lt,fallbackTitle:Lt}),l(`Loaded series artifact ${u}.`,"success")}else{I(De,{titleHint:pt.name||u,idHint:u});const Tt={version:fe,data:De,createdOn:(Ee==null?void 0:Ee.createdOn)||pt.createdOn};Qe={id:C(),title:De.title||pt.name||u,data:De,apicurioArtifactId:u,apicurioArtifactName:pt.name||"",apicurioVersions:[Tt],apicurioActiveVersionIndex:0};const Lt=(At=pt==null?void 0:pt.properties)==null?void 0:At.seriesId;Lt&&typeof N=="function"&&N(Qe,{seriesName:Lt,fallbackTitle:Lt});const en=fe?` (version ${fe})`:"";l(`Loaded artifact ${u}${en}.`,"success")}Vt(u,Qe)}catch(De){console.error("[Blockscape] failed to load artifact",De),l(`Failed to load artifact: ${De.message}`,"error")}}async function Dt(u){}return{hydrateConfig:st,mount:ai,updateAvailability:Oe,isEnabled:be,setEnabled:Kt,onEnabledChange:O}}const cn={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Fn(r,c){if(typeof r!="function")throw new Error(`[itemEditor] expected ${c} to be a function`)}function ul(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}function pl(r,{excludeId:c}={}){if(!r)return[];const p=r.split(/[\s,]+/).map(N=>N.trim()).filter(Boolean),I=[];return p.forEach(N=>{c&&N===c||I.includes(N)||I.push(N)}),I}function fl(r,c,p){if(!c||!p||c===p)return;((r==null?void 0:r.categories)||[]).forEach(N=>{(N.items||[]).forEach(X=>{Array.isArray(X.deps)&&(X.deps=X.deps.map(ie=>ie===c?p:ie))})}),Array.isArray(r==null?void 0:r.links)&&r.links.forEach(N=>{N.from===c&&(N.from=p),N.to===c&&(N.to=p)})}function ml({findItemAndCategoryById:r,collectAllItemIds:c,updateItemReferences:p,loadActiveIntoEditor:I,rebuildFromActive:N,select:X,onSelectionRenamed:ie,makeSlug:q=ul,isAutoIdFromNameEnabled:K=()=>!0}={}){Fn(r,"findItemAndCategoryById"),Fn(c,"collectAllItemIds"),Fn(p,"updateItemReferences"),Fn(I,"loadActiveIntoEditor"),Fn(N,"rebuildFromActive"),Fn(X,"select"),Fn(q,"makeSlug"),Fn(K,"isAutoIdFromNameEnabled");const C={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function he(z){if(C.fields.errorEl){if(!z){C.fields.errorEl.hidden=!0,C.fields.errorEl.textContent="";return}C.fields.errorEl.hidden=!1,C.fields.errorEl.textContent=z}}function j(){C.wrapper&&(C.wrapper.hidden=!0,C.wrapper.setAttribute("aria-hidden","true"),he(""),C.categoryId=null,C.itemId=null,C.modelData=null,document.body.classList.remove("item-editor-open"))}function me(){C.wrapper&&(C.wrapper.hidden=!1,C.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var z,W;(z=C.fields.nameInput)==null||z.focus(),(W=C.fields.nameInput)==null||W.select()}))}function ke({force:z}={}){var ye,M;if(!((ye=C.fields)!=null&&ye.idInput)||!((M=C.fields)!=null&&M.nameInput)||!C.autoSyncEnabled||!K()||!z&&C.autoIdManuallyEdited)return;const W=q(C.fields.nameInput.value||C.itemId||"item");C.fields.idInput.value=W}function Ye(z){var be;if(!C.modelData||!C.categoryId||!C.itemId)throw new Error("No item loaded.");const ye=(((be=C.modelData)==null?void 0:be.categories)||[]).find(ge=>ge.id===C.categoryId);if(!ye)throw new Error("Category not found.");ye.items=ye.items||[];const M=ye.items.find(ge=>ge.id===C.itemId);if(!M)throw new Error("Item not found.");const Ie=(z.id||"").trim();if(!Ie)throw new Error("ID is required.");const Me=c(C.modelData);if(Ie!==M.id&&Me.has(Ie))throw new Error("Another item already uses that ID.");M.id=Ie;const ce=(z.name||"").trim();M.name=ce||M.id;const Le=(z.logo||"").trim();if(Le?M.logo=Le:delete M.logo,z.externalFlag&&!z.external)M.external=!0;else{const ge=(z.external??"").toString().trim();ge?M.external=ge:delete M.external}const Ce=(z.color||"").trim();return Ce?M.color=Ce:delete M.color,M.deps=Array.isArray(z.deps)?z.deps:[],M.id!==z.originalId&&typeof ie=="function"&&ie(z.originalId,M.id),p(C.modelData,z.originalId,M.id),I(),N(),X(M.id),M.id}function je(){if(!C.fields||!C.fields.idInput)return!1;const z=(C.fields.idInput.value||"").trim(),W={originalId:C.itemId,id:z,name:C.fields.nameInput.value||"",logo:C.fields.logoInput.value||"",external:C.fields.externalInput.value||"",externalFlag:C.fields.externalFlagInput.checked,color:C.fields.colorInput.value||"",deps:pl(C.fields.depsInput.value,{excludeId:z})};try{return Ye(W),j(),!0}catch(ye){return console.warn("[itemEditor] item edit failed",ye),he((ye==null?void 0:ye.message)||"Unable to save item."),!1}}function Ge(){if(C.wrapper)return C.wrapper;const z=document.createElement("div");z.className="item-editor-modal",z.hidden=!0,z.setAttribute("role","dialog"),z.setAttribute("aria-modal","true");const W=document.createElement("div");W.className="item-editor-modal__backdrop",z.appendChild(W);const ye=document.createElement("div");ye.className="item-editor",z.appendChild(ye);const M=document.createElement("div");M.className="item-editor__header";const Ie=document.createElement("h2");Ie.className="item-editor__title",Ie.textContent="Edit item";const Me=document.createElement("button");Me.type="button",Me.className="item-editor__close",Me.setAttribute("aria-label","Close item editor"),Me.textContent="×",M.appendChild(Ie),M.appendChild(Me),ye.appendChild(M);const ce=document.createElement("form");ce.className="item-editor__form",ye.appendChild(ce);const Le=document.createElement("div");Le.className="item-editor__meta",Le.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',ce.appendChild(Le);const Ce=document.createElement("div");Ce.className="item-editor__error",Ce.hidden=!0,ce.appendChild(Ce);const be=(Je,G,ve)=>{const Ve=document.createElement("label");Ve.className="item-editor__field";const $=document.createElement("span");if($.className="item-editor__label",$.textContent=Je,Ve.appendChild($),G.classList.add("item-editor__control"),Ve.appendChild(G),ve){const xe=document.createElement("div");xe.className="item-editor__hint",xe.textContent=ve,Ve.appendChild(xe)}return Ve},ge=document.createElement("input");ge.type="text",ge.required=!0,ce.appendChild(be("ID",ge,"Unique identifier used for links and dependencies."));const O=document.createElement("input");O.type="text",ce.appendChild(be("Name",O,"Visible label shown on the tile."));const Y=document.createElement("input");Y.type="url",Y.inputMode="url",Y.placeholder="https://…",ce.appendChild(be("Logo URL",Y,"Optional image URL."));const l=document.createElement("input");l.type="url",l.inputMode="url",l.placeholder="https://…",ce.appendChild(be("External link",l,"Shown with ↗ icon and in preview."));const P=document.createElement("div");P.className="item-editor__checkbox";const le=document.createElement("label");le.className="item-editor__checkbox-row";const Oe=document.createElement("input");Oe.type="checkbox";const ue=document.createElement("span");ue.textContent="Mark as external without link";const He=document.createElement("div");He.className="item-editor__hint",He.textContent="Keeps dashed border even without a URL.",le.appendChild(Oe),le.appendChild(ue),P.appendChild(le),P.appendChild(He),ce.appendChild(P);const st=document.createElement("input");st.type="text",st.placeholder=cn.color.primary,ce.appendChild(be("Color",st,"Optional badge color (hex or CSS color)."));const Xe=document.createElement("textarea");Xe.rows=2,Xe.placeholder="Comma or space separated ids",ce.appendChild(be("Dependencies",Xe,"Use item IDs, separated by commas or spaces."));const Pe=document.createElement("div");Pe.className="item-editor__checkbox";const ut=document.createElement("label");ut.className="item-editor__checkbox-row";const Fe=document.createElement("input");Fe.type="checkbox";const lt=document.createElement("span");lt.textContent="Sync ID while editing name";const kt=document.createElement("div");kt.className="item-editor__hint",kt.textContent="Turn off to keep typing names without changing the ID.",ut.appendChild(Fe),ut.appendChild(lt),Pe.appendChild(ut),Pe.appendChild(kt),ce.appendChild(Pe);const V=document.createElement("div");V.className="item-editor__actions";const y=document.createElement("button");y.type="button",y.className="pf-v5-c-button pf-m-tertiary",y.textContent="Cancel";const v=document.createElement("button");return v.type="submit",v.className="pf-v5-c-button pf-m-primary",v.textContent="Save",V.appendChild(y),V.appendChild(v),ce.appendChild(V),C.wrapper=z,C.fields={idInput:ge,nameInput:O,logoInput:Y,externalInput:l,externalFlagInput:Oe,colorInput:st,depsInput:Xe,syncCheckbox:Fe,categoryValue:Le.querySelector(".item-editor__meta-value"),errorEl:Ce},y.addEventListener("click",j),Me.addEventListener("click",j),W.addEventListener("click",j),ge.addEventListener("input",()=>{C.autoIdManuallyEdited=!0}),O.addEventListener("input",ke),Fe.addEventListener("change",()=>{C.autoSyncEnabled=!!Fe.checked,C.autoSyncEnabled&&(C.autoIdManuallyEdited=!1,ke({force:!0}))}),ce.addEventListener("submit",Je=>{Je.preventDefault(),je()}),document.addEventListener("keydown",Je=>{Je.key==="Escape"&&!z.hidden&&(Je.preventDefault(),Je.stopPropagation(),j())}),document.body.appendChild(z),z}function Te(z){const W=r(z);if(!W)return!1;Ge(),C.categoryId=W.category.id,C.itemId=W.item.id,C.modelData=W.modelData,C.autoIdManuallyEdited=!1;const ye=!!K();return C.autoSyncEnabled=ye,C.fields.categoryValue.textContent=W.category.title||W.category.id,C.fields.idInput.value=W.item.id||"",C.fields.nameInput.value=W.item.name||"",C.fields.logoInput.value=W.item.logo||"",C.fields.externalInput.value=typeof W.item.external=="string"?W.item.external:"",C.fields.externalFlagInput.checked=W.item.external===!0,C.fields.colorInput.value=W.item.color||"",C.fields.depsInput.value=Array.isArray(W.item.deps)?W.item.deps.join(", "):"",C.fields.syncCheckbox.checked=C.autoSyncEnabled,C.fields.syncCheckbox.disabled=!ye,!C.fields.idInput.value&&ye&&ke({force:!0}),he(""),X(W.item.id),me(),!0}return{open:Te,hide:j,isOpen:()=>!!C.wrapper&&!C.wrapper.hidden}}function hl({menuEl:r,previewEl:c,previewTitleEl:p,previewBodyEl:I,previewActionsEl:N,previewCloseEl:X,escapeHtml:ie,onEditItem:q,onChangeColor:K,selectItem:C,colorPresets:he=[]}={}){const j=r||(()=>{const O=document.createElement("div");return O.className="tile-context-menu",O.hidden=!0,O.setAttribute("aria-hidden","true"),document.body.appendChild(O),O})();let me={x:0,y:0},ke=0,Ye=Array.isArray(he)?he:[];function je(){j&&(j.classList.remove("is-open"),j.hidden=!0,j.setAttribute("aria-hidden","true"),j.innerHTML="")}function Ge(O=[]){N&&(N.innerHTML="",O.forEach(Y=>{const l=document.createElement("button");l.type="button",l.className="item-preview__action",l.textContent=Y.label||"Action",Y.title&&(l.title=Y.title),l.addEventListener("click",P=>{P.stopPropagation(),typeof Y.onClick=="function"&&Y.onClick(P)}),N.appendChild(l)}),N.hidden=O.length===0)}function Te(){je(),c&&(c.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),c.setAttribute("aria-hidden","true"),c.hidden=!0,Ge([]))}function z(O,Y){c&&(me={x:O,y:Y},c.hidden=!1,c.setAttribute("aria-hidden","false"),c.classList.add("is-visible"),W(O,Y))}function W(O,Y){if(!c)return;const l=12;c.style.left=`${O+l}px`,c.style.top=`${Y+l}px`;const P=c.getBoundingClientRect();let le=P.left,Oe=P.top;P.right>window.innerWidth-l&&(le=Math.max(l,window.innerWidth-P.width-l)),P.bottom>window.innerHeight-l&&(Oe=Math.max(l,window.innerHeight-P.height-l)),c.style.left=`${le}px`,c.style.top=`${Oe}px`}function ye(O,Y){var ue;if(!O)return null;const l=O.dataset.id,P=((ue=O.querySelector(".name"))==null?void 0:ue.textContent)||l||"Preview",le=l?`${l}.html`:"",Oe=le?`items/${le}`:"";return{id:l,displayName:P,filename:le,filepath:Oe,externalUrl:O.dataset.externalUrl||"",obsidianUrl:O.dataset.obsidianUrl||"",anchorX:(Y==null?void 0:Y.clientX)??0,anchorY:(Y==null?void 0:Y.clientY)??0}}function M(O,Y){const l=document.createElement("button");return l.type="button",l.className="tile-context-menu__item",l.textContent=O,l.addEventListener("click",()=>{je(),typeof Y=="function"&&Y()}),l}function Ie(O){if(!j)return;j.innerHTML="";const Y=document.createElement("div");Y.className="tile-context-menu__list",Y.appendChild(M("File view",()=>ce(O))),typeof q=="function"&&Y.appendChild(M("Edit",()=>q(O.id))),typeof K=="function"&&O.id&&Ye.forEach(l=>{if(!(l!=null&&l.value))return;const P=l.name||l.value;Y.appendChild(M(`Set color: ${P}`,()=>K(O.id,l.value)))}),j.appendChild(Y)}function Me(O,Y){if(!j)return;const l=4;j.style.left=`${O+l}px`,j.style.top=`${Y+l}px`,j.hidden=!1,j.setAttribute("aria-hidden","false"),j.classList.add("is-open");const P=j.getBoundingClientRect();let le=P.left,Oe=P.top;P.right>window.innerWidth-l&&(le=Math.max(l,window.innerWidth-P.width-l)),P.bottom>window.innerHeight-l&&(Oe=Math.max(l,window.innerHeight-P.height-l)),j.style.left=`${le}px`,j.style.top=`${Oe}px`}async function ce(O){if(!c||!p||!I||!O)return;const Y=++ke,l=[];if(typeof q=="function"&&O.id&&l.push({label:"Edit",title:"Edit this item",onClick:()=>{Te(),q(O.id)}}),O.externalUrl&&l.push({label:"Open link ↗",title:O.externalUrl,onClick:()=>window.open(O.externalUrl,"_blank","noopener")}),O.obsidianUrl&&l.push({label:"Open in Obsidian",title:O.obsidianUrl,onClick:()=>window.open(O.obsidianUrl,"_blank","noopener")}),Ge(l),O.id&&typeof C=="function"&&C(O.id),p.textContent=O.displayName,I.innerHTML='<div class="item-preview__status">Loading…</div>',c.classList.remove("item-preview--has-frame"),c.classList.add("item-preview--expanded"),z(O.anchorX,O.anchorY),!O.filepath){I.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',W(me.x,me.y);return}try{const P=await fetch(O.filepath,{cache:"no-cache"});if(!P.ok)throw new Error(`HTTP ${P.status}`);const le=await P.text();if(Y!==ke)return;if(!le.trim()){const He=ie?ie(O.filename):O.filename;I.innerHTML=`<div class="item-preview__status">No content in <code>${He}</code>.</div>`,W(me.x,me.y);return}const ue=document.createElement("iframe");ue.className="item-preview__frame",ue.title=`${O.displayName} details`,ue.srcdoc=le,I.innerHTML="",I.appendChild(ue),c.classList.add("item-preview--has-frame"),W(me.x,me.y)}catch(P){if(Y!==ke)return;const le=ie?ie(O.displayName):O.displayName;I.innerHTML=`<div class="item-preview__status">No preview available for <strong>${le}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${O.filepath}`,P),W(me.x,me.y)}}function Le(O,Y){if(!Y)return;O.preventDefault(),O.stopPropagation();const l=ye(Y,O);!l||!l.id||(typeof C=="function"&&C(l.id),Ie(l),Me(O.clientX,O.clientY))}function Ce(O){const Y=O==null?void 0:O.target,l=j&&!j.hidden&&j.contains(Y),P=c&&!c.hidden&&c.contains(Y);!l&&!P&&Te()}function be(){!c||c.hidden||W(me.x,me.y)}function ge(){Te()}return X&&X.addEventListener("click",Te),{handleTileContextMenu:Le,hidePreview:Te,hideMenu:je,handleDocumentClick:Ce,handleWindowResize:be,handleWindowScroll:ge,updateColorPresets:O=>{Ye=Array.isArray(O)?O:[]}}}function br(r,c="series"){return(r||c).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||c}function vn(r,c="series"){const p=br(r,c).replace(/\./g,"-");return p.replace(/-series$/i,"").replace(/-+$/,"")||p||br(c,"series")}function vr(r,{seriesName:c,fallbackTitle:p="unknown"}={}){var q,K;const N=[r==null?void 0:r.seriesId,(q=r==null?void 0:r.data)==null?void 0:q.seriesId,r==null?void 0:r.apicurioArtifactId,c,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(K=r==null?void 0:r.data)==null?void 0:K.title,p].map(C=>(C??"").toString().trim()),X=N.findIndex(Boolean),ie=X!==-1?N[X]:"";return ie?(console.log("[Series] deriveSeriesId: picked base",{base:ie,sourceIndex:X,candidates:N}),vn(ie,p)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:p}),null)}function It(r,{seriesName:c,fallbackTitle:p="unknown"}={}){if(!r||typeof r!="object")return null;const I=vr(r,{seriesName:c,fallbackTitle:p});return I?(r.seriesId=I,r.apicurioArtifactId||(r.apicurioArtifactId=I),I):null}function Wn(r,c={}){var N,X;if(!r)return null;const p=r.isSeries||((N=r.apicurioVersions)==null?void 0:N.length)>1||r.seriesId||((X=r.data)==null?void 0:X.seriesId)||r.apicurioArtifactId;if(!p&&!c.force)return null;const I=vr(r,c);return I||(p?vn(c.fallbackTitle||"unknown"):null)}const wr={selectionDimOpacity:.2,selectionDimEnabled:!0},jn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,c=!0)=>{const p=Math.round((1-r)*100);return c?p===0?"Off":`${p}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function ii(r){return r===!0||r==="true"||r===1||r==="1"}function gl(r,{localBackend:c}={}){const p=c&&typeof c.getAutoReloadConfig=="function"&&c.getAutoReloadConfig(),I={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets};return p&&(I.autoReloadEnabled=!!p.enabled,I.autoReloadIntervalMs=p.intervalMs),I}function bl(r={},c){var ut,Fe,lt,kt;if(!r||typeof r!="object")return{applied:[]};const p=[],{applyTheme:I,applyTileHoverScale:N,persistTileHoverScale:X,applySelectionDimEnabled:ie,persistSelectionDimEnabled:q,applySelectionDimOpacity:K,persistSelectionDimOpacity:C,applyTileCompactness:he,persistTileCompactness:j,applyTitleWrapMode:me,persistTitleWrapMode:ke,applyTitleHoverWidthMultiplier:Ye,persistTitleHoverWidthMultiplier:je,applyTitleHoverTextPortion:Ge,persistTitleHoverTextPortion:Te,applyObsidianLinksEnabled:z,persistObsidianLinksEnabled:W,applyObsidianLinkMode:ye,persistObsidianLinkMode:M,applyObsidianVaultName:Ie,persistObsidianVaultName:Me,applyAutoIdFromNameEnabled:ce,persistAutoIdFromNameEnabled:Le,applySeriesNavDoubleClickWait:Ce,persistSeriesNavDoubleClickWait:be,applyCenterItems:ge,persistCenterItems:O,localBackend:Y,ui:l,refreshObsidianLinks:P,scheduleOverlaySync:le,selection:Oe,select:ue,clearStyles:He,drawLinks:st,applyReusedHighlights:Xe,current:Pe}=c;if(r.theme){const y=((I==null?void 0:I(r.theme))||r.theme)==="dark";(ut=c.ui)!=null&&ut.themeToggle&&(c.ui.themeToggle.checked=y),(Fe=c.ui)!=null&&Fe.tabThemeToggle&&(c.ui.tabThemeToggle.checked=y),p.push("theme")}if(r.hoverScale!=null){const V=N(parseFloat(r.hoverScale));X(V),l!=null&&l.hoverScaleInput&&(l.hoverScaleInput.value=String(V)),l!=null&&l.hoverScaleValue&&(l.hoverScaleValue.textContent=jn.hoverScale(V)),Oe&&le(),p.push("hoverScale")}if(r.selectionDimEnabled!=null){const V=ie(ii(r.selectionDimEnabled));q(V),l!=null&&l.selectionDimToggle&&(l.selectionDimToggle.checked=V),l!=null&&l.selectionDimInput&&(l.selectionDimInput.disabled=!V),l!=null&&l.selectionDimValue&&(l.selectionDimValue.textContent=jn.selectionDimming(Pe.selectionDimOpacity??wr.selectionDimOpacity,V)),p.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const V=K(parseFloat(r.selectionDimOpacity));C(V),l!=null&&l.selectionDimInput&&(l.selectionDimInput.value=String(V)),l!=null&&l.selectionDimValue&&(l.selectionDimValue.textContent=jn.selectionDimming(V,Pe.selectionDimEnabled??wr.selectionDimEnabled)),p.push("selectionDimOpacity")}if(r.tileCompactness!=null){const V=he(parseFloat(r.tileCompactness));j(V),l!=null&&l.tileCompactnessInput&&(l.tileCompactnessInput.value=String(V)),l!=null&&l.tileCompactnessValue&&(l.tileCompactnessValue.textContent=jn.compactness(V)),Oe&&le(),p.push("tileCompactness")}if(r.titleWrapMode){const V=me(r.titleWrapMode);ke(V),l!=null&&l.titleWrapInput&&(l.titleWrapInput.checked=V!=="nowrap"),p.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const V=Ye(parseFloat(r.titleHoverWidthMultiplier));je(V),l!=null&&l.titleWidthInput&&(l.titleWidthInput.value=String(V)),l!=null&&l.titleWidthValue&&(l.titleWidthValue.textContent=jn.titleWidth(V)),p.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const V=Ge(parseFloat(r.titleHoverTextPortion));Te(V),l!=null&&l.titleZoomInput&&(l.titleZoomInput.value=String(V)),l!=null&&l.titleZoomValue&&(l.titleZoomValue.textContent=jn.titleZoomPortion(V)),p.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const V=z(ii(r.obsidianLinksEnabled));W(V),l!=null&&l.obsidianToggle&&(l.obsidianToggle.checked=V),(lt=l==null?void 0:l.obsidianModeInputs)==null||lt.forEach(y=>{y.disabled=!V}),l!=null&&l.obsidianVaultInput&&(l.obsidianVaultInput.disabled=!V),P==null||P(),p.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const V=ye(r.obsidianLinkMode);M(V),(kt=l==null?void 0:l.obsidianModeInputs)==null||kt.forEach(y=>{y.checked=y.value===V}),P==null||P(),p.push("obsidianLinkMode")}if(r.obsidianVault!=null){const V=Ie(r.obsidianVault);Me(V),l!=null&&l.obsidianVaultInput&&(l.obsidianVaultInput.value=V),P==null||P(),p.push("obsidianVault")}if(r.colorPresets&&(typeof c.setColorPresets=="function"&&c.setColorPresets(r.colorPresets),p.push("colorPresets")),r.autoIdFromName!=null){const V=ce(ii(r.autoIdFromName));Le(V),l!=null&&l.autoIdToggle&&(l.autoIdToggle.checked=V),p.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const V=Ce(parseInt(r.seriesNavDoubleClickMs,10));be(V),l!=null&&l.seriesNavInput&&(l.seriesNavInput.value=String(V)),l!=null&&l.seriesNavValue&&(l.seriesNavValue.textContent=jn.seriesNavWait(V)),p.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&Y&&typeof Y.setAutoReloadEnabled=="function"){const V=ii(r.autoReloadEnabled);Y.setAutoReloadEnabled(V),l!=null&&l.autoReloadToggle&&(l.autoReloadToggle.checked=V),l!=null&&l.autoReloadInput&&(l.autoReloadInput.disabled=!V),p.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&Y&&typeof Y.setAutoReloadInterval=="function"){const V=Y.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));l!=null&&l.autoReloadInput&&(l.autoReloadInput.value=String(V)),l!=null&&l.autoReloadValue&&(l.autoReloadValue.textContent=jn.autoReloadInterval(V)),p.push("autoReloadIntervalMs")}if(r.centerItems!=null){const V=ge==null?void 0:ge(ii(r.centerItems));O==null||O(V),l!=null&&l.tabCenterToggle&&(l.tabCenterToggle.checked=V),p.push("centerItems")}if(r.showSecondaryLinks!=null){const V=ii(r.showSecondaryLinks);typeof c.setShowSecondaryLinks=="function"?c.setShowSecondaryLinks(V):c.showSecondaryLinks=V,l!=null&&l.secondaryLinksToggle&&(l.secondaryLinksToggle.checked=V),l!=null&&l.tabSecondaryLinksToggle&&(l.tabSecondaryLinksToggle.checked=V),Oe?ue(Oe):(He(),st()),p.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const V=ii(r.showReusedInMap);typeof c.setShowReusedInMap=="function"?c.setShowReusedInMap(V):c.showReusedInMap=V,l!=null&&l.reusedToggle&&(l.reusedToggle.checked=V),Xe==null||Xe(),p.push("showReusedInMap")}return{applied:p}}function vl(r,c){const p=new Blob([c],{type:"application/json"}),I=URL.createObjectURL(p),N=document.createElement("a");N.href=I,N.download=r,N.click(),URL.revokeObjectURL(I)}const To=typeof{url:An&&An.tagName.toUpperCase()==="SCRIPT"&&An.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function wl(){console.log("[Blockscape] init");const r=document.getElementById("jsonBox"),c=document.querySelector(".blockscape-json-panel"),p=document.getElementById("app"),I=document.getElementById("overlay"),N=document.getElementById("tabTooltip"),X=document.getElementById("modelList"),ie=document.getElementById("itemPreview"),q=document.getElementById("urlForm"),K=document.getElementById("urlInput"),C=document.getElementById("loadUrl"),he=ie.querySelector(".item-preview__title"),j=ie.querySelector(".item-preview__body"),me=ie.querySelector(".item-preview__actions"),ke=ie.querySelector(".item-preview__close"),Ye=document.getElementById("downloadJson"),je=document.getElementById("shareModel"),Ge=document.getElementById("createVersion"),Te=document.getElementById("openInEditor"),z=document.getElementById("copyJson"),W=document.getElementById("copySeries"),ye=document.getElementById("pasteJson"),M=document.getElementById("helpButton"),Ie=document.getElementById("newPanelButton"),Me=document.getElementById("newBlankButton"),ce=document.getElementById("shortcutHelp"),Le=document.getElementById("shortcutHelpList"),Ce=document.getElementById("shortcutHelpClose"),be=document.getElementById("shortcutHelpBackdrop"),ge=document.getElementById("newPanel"),O=document.getElementById("newPanelClose"),Y=document.getElementById("newPanelBackdrop"),l=document.getElementById("search"),P=document.getElementById("searchResults"),le=document.getElementById("localBackendPanel"),Oe=document.getElementById("localBackendStatus"),ue=document.getElementById("localFileList"),He=document.getElementById("localDirSelect"),st=document.getElementById("refreshLocalFiles"),Xe=document.getElementById("loadLocalFile"),Pe=document.getElementById("saveLocalFile"),ut=document.getElementById("saveLocalFileAs"),Fe=document.getElementById("localSavePath"),lt="blockscape:editorPayload",kt="blockscape:editorTransfer",V=document.title;le&&(le.hidden=!0),r.value=document.getElementById("seed").textContent.trim();let y=[],v=-1;const Je=dl({models:y,getActiveIndex:()=>v,setActive:gt,ensureModelMetadata:In,getModelId:ct,getSeriesId:Wn,ensureSeriesId:It,getModelTitle:qe,computeJsonFingerprint:Po,uid:di});let G=null,ve=new Map,Ve=new Map,$=null,xe=null,ht=null,Ze=null,Ft=!0,Tn=!1,Ot=!1,Kt="map",Pt=null,_t=null,oi=!1,Ln=null;const ai=2e3;let Yt=null,Xt=null,Ct=null,dn=null,xt=null,Vt=null,Wt=null,Jn=null,jt=null,un="",Sn=!1,Dt=null;const u=new Map;let g=null,L=null,x=[],S=null;const R=30,ee=1e3,J="blockscape:hoverScale",de=1.5,fe=1,Ee=2.5,Z="blockscape:selectionDimOpacity",we="blockscape:selectionDimEnabled",Ae=.2,Zt=.05,Qt=1,At="blockscape:titleWrap",De="blockscape:titleHoverWidth",pt="blockscape:titleHoverTextPortion",Jt="wrap",Qe=1.3,Tt=1,Lt=1.6,en=.25,pn=0,ri=.6,si="blockscape:tileCompactness",vi=1,Ir=.75,kr=1.25,_r="blockscape:obsidianLinksEnabled",Cr="blockscape:obsidianLinkMode",xr="blockscape:obsidianVault",pa="title",Lo="id",No=pa,Ar="blockscape:autoReloadEnabled",Tr="blockscape:autoReloadIntervalMs",Mo=1e3,Lr=500,Nr=1e4,Mr="blockscape:autoIdFromName",$o=!0,$r="blockscape:colorPresets",Br="blockscape:centerItems",Rr="blockscape:theme",wi="light",li="dark",Bo="cat:",Ro=!1;let yi=de,Nn=Ae,Mn=!0,Ei=vi,fa=Jt,Si=Qe,Ii=en,ki=!1,Xi=No,_i="",ci=$o,Zi=wi,Ut=[],tn=Ro,Ci=null;const Or="blockscape:seriesNavDoubleClickMs",Qi=900,Pr=300,Vr=4e3;let $n=Qi;const _e={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null},ze=Jl(),Dr=ze.detect();Je.hydrateConfig(),ma(Pl()),Ai(Ul(),{silent:!0}),oc(),ac(),lc(),uc(),cc(),dc(),gc(),wc(),vc(),yc(),rc(),sc(),Dl(),Ht();function di(){return Math.random().toString(36).slice(2,10)}function $l(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(i=>{n+=String.fromCharCode(i)}),btoa(n)}function Bl(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new TextDecoder().decode(n)}function Rl(e){return $l(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Ol(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Bl(t)}const Ur=(e,t)=>vl(e,t);function Pl(){if(typeof window>"u"||!window.localStorage)return wi;try{return window.localStorage.getItem(Rr)===li?li:wi}catch{return wi}}function Vl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Rr,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function ma(e){const t=e===li?li:wi;return Zi=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),Vl(t),Zi}function Hr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Br,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function xi(e){return tn=!!e,p&&(p.classList.toggle("is-center-mode",tn),p.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",tn)}),p.querySelectorAll(".tile-add").forEach(t=>{t.hidden=tn,t.tabIndex=tn?-1:0,t.setAttribute("aria-hidden",tn?"true":"false")})),G&&(jo(),qn()),tn}function Dl(){if(typeof window>"u"||!window.localStorage)return xi(Ro);try{const e=window.localStorage.getItem(Br);return e==null?xi(Ro):xi(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),xi(Ro)}}function Fr(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Wr(e){const t=i=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(i||"");if(!Array.isArray(e))return eo();const n=e.map(i=>({name:((i==null?void 0:i.name)||"").toString().trim()||"Custom",value:((i==null?void 0:i.value)||"").toString().trim()})).filter(i=>t(i.value));return n.length?n:eo()}function eo(){return[{name:"Black",value:cn.color.ink},{name:"White",value:cn.color.white},{name:"Red",value:cn.blockscape.revdep},{name:"Green",value:cn.color.success}]}function Ul(){if(typeof window>"u"||!window.localStorage)return eo();try{const e=window.localStorage.getItem($r);if(!e)return eo();const t=JSON.parse(e);return Wr(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),eo()}}function Hl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem($r,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function Ai(e,{silent:t=!1}={}){return Ut=Wr(e),Hl(Ut),!t&&typeof Hi=="function"&&Hi(Ut),Ci==null||Ci(),Ut}function Fl(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),i=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||i&&["1","true","yes","on"].includes(i.toLowerCase())}function Oo(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const i=ui(e);if(!i)return;const o=y[v],a=ui(o==null?void 0:o.sourcePath),s=t??(a&&a===i?ct(o):null),d=n??(a&&a===i?$:null),f=i.split("/").filter(Boolean).map(T=>encodeURIComponent(T)),h=s?encodeURIComponent(s):null,w=d?encodeURIComponent(d):null;try{const T=new URL(window.location.href),B=new URLSearchParams(T.search);B.delete("load"),B.delete("share");const A=["","server",...f,...h?[h]:[],...w?[w]:[]].join("/").replace(/\/+/g,"/");T.pathname=A,T.search=B.toString()?`?${B.toString()}`:"",T.hash="",window.history.replaceState({},document.title,T.toString())}catch(T){console.warn("[Blockscape] failed to update URL for server path",T)}}function Wl(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),i=n.findIndex(te=>te.toLowerCase()==="server");if(i===-1)return null;const o=n.slice(i+1);if(!o.length)return null;const a=o.findIndex(te=>te.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=o.slice(0,a+1),d=o.slice(a+1),f=te=>{try{return decodeURIComponent(te)}catch{return te}},h=s.map(f),w=d.map(f),T=h.join("/"),B=ui(T);if(!B)return null;const A=w[0]?w[0].trim():null,E=w[1]?w[1].trim():null;return{path:B,modelId:A||null,itemId:E||null}}function ha({itemId:e}={}){const t=y[v];t!=null&&t.sourcePath&&Oo(t.sourcePath,{modelId:ct(t),itemId:e===void 0?$:e})}function jl(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function Jl(){const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(k,F={}){console.log("[Blockscape][local-backend]",k,{...e(),...F})}if(jl())return t("Disabled on github.io host"),le&&(le.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!Fl()||!le||!Oe)return t("Opt-in flag missing or panel unavailable"),le&&(le.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!le||!Oe)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let i=!1,o="",a=[],s=[],d="",f=new Map,h=te(),w=ot(),T=null,B=!1;const A=new Set;function E(){return A.size>0}function te(){if(typeof window>"u"||!window.localStorage)return!0;try{const k=window.localStorage.getItem(Ar);return k==null?!0:k==="true"}catch{return!0}}function ne(k){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ar,k?"true":"false")}catch(F){console.warn("[Blockscape] auto-reload: failed to persist",F)}}function ot(){if(typeof window>"u"||!window.localStorage)return Mo;try{const k=window.localStorage.getItem(Tr);if(!k)return Mo;const F=parseInt(k,10);return Se(F)}catch{return Mo}}function et(k){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Tr,String(k))}catch(F){console.warn("[Blockscape] auto-reload: failed to persist interval",F)}}function Se(k){return Number.isFinite(k)?Math.min(Nr,Math.max(Lr,k)):Mo}function $e(k){if(!k)return"";const F=k.split("/").filter(Boolean);return F.pop(),F.join("/")}function Ue(k,{error:F=!1}={}){Oe.textContent=k,Oe.style.color=F?cn.color.dangerStrong:"",t("Status",{text:k,error:F})}function tt(k){return ui(k)}function rt(k){const F=Uo(k);return F?{payload:F,isSeries:!0}:{payload:k==null?void 0:k.data,isSeries:!1}}function Mt(){var F;if(v>=0&&((F=y[v])!=null&&F.sourcePath))return y[v].sourcePath;if(v<0)return"blockscape.bs";const k=qe(y[v])||"blockscape";return`${vn(k,"blockscape")}.bs`}function Be(){var k;Fe&&(Fe.placeholder=Mt(),(k=y[v])!=null&&k.sourcePath&&(Fe.value=y[v].sourcePath))}function St(){if(!He)return;He.innerHTML="";const k=document.createElement("option");k.value="",k.textContent="All (~/blockscape)",He.appendChild(k),s.forEach(ae=>{const re=document.createElement("option");re.value=ae,re.textContent=ae||"(root)",He.appendChild(re)});const F=s.includes(d)?d:"";He.value=F,d=F}function $t(){if(!ue)return;ue.innerHTML="";const k=d?a.filter(F=>F.path.startsWith(`${d}/`)):a;if(!k.length){const F=document.createElement("option");F.disabled=!0,F.textContent="No .bs files found yet",ue.appendChild(F),ue.disabled=!0;return}ue.disabled=!1,k.forEach(F=>{const ae=document.createElement("option");ae.value=F.path;const re=F.mtimeMs?new Date(F.mtimeMs).toLocaleString():"";ae.textContent=re?`${F.path} · ${re}`:F.path,ue.appendChild(ae)}),o&&Array.from(ue.options).forEach(F=>{F.value===o&&(F.selected=!0)}),!ue.value&&ue.options.length&&(ue.options[0].selected=!0)}function nn(k){if(!i||!ue||!k||!a.find(nt=>nt.path===k))return;const ae=$e(k);ae!==d&&(d=ae,St()),$t(),Array.from(ue.options).forEach(nt=>{nt.selected=nt.value===k});const re=Array.from(ue.options).find(nt=>nt.value===k);re!=null&&re.scrollIntoView&&re.scrollIntoView({block:"nearest"}),Fe&&(Fe.value=k)}function at(){T&&(clearInterval(T),T=null)}function Bt(){at(),!(!i||!h||E())&&(T=setInterval(on,w))}function _n(k){if(!k)return;const F=A.size;A.add(k),A.size!==F&&(t("Auto-reload paused",{reason:k}),Bt())}function wn(k){if(!k)return;A.delete(k)&&(t("Auto-reload resumed",{reason:k}),Bt())}async function qt(k){const F=y.findIndex(ae=>ae.sourcePath===k);if(F!==-1)try{const ae=await fetch(`/api/file?path=${encodeURIComponent(k)}`,{cache:"no-store"});if(!ae.ok)throw new Error(`HTTP ${ae.status}`);const re=await ae.json(),nt=JSON.stringify(re.data??re,null,2),bt=On(nt,k,{seriesTitleOverride:`${k} series`});if(!bt.length)return;const pe=bt[0];if(pe.sourcePath=k,In(pe,{titleHint:qe(y[F]),idHint:ct(y[F])}),pe.isSeries){const it=pe.title||qe(pe)||qe(y[F]),rn=vn(it||"unknown");pi(pe,rn),It(pe,{seriesName:it||"unknown",fallbackTitle:"unknown"})}y[F]={...y[F],...pe,title:pe.title||qe(pe),data:pe.data,sourcePath:k},F===v?(Nt(),Et()):Rn(),console.log("[Blockscape] auto-reloaded model from",k)}catch(ae){console.warn("[Blockscape] auto-reload failed for",k,ae)}}async function on(){if(!(!i||!h||E()||B)){B=!0;try{const k=await fetch("/api/files",{cache:"no-store"});if(!k.ok)throw new Error(`HTTP ${k.status}`);const ae=((await k.json()).files||[]).slice().sort((pe,it)=>{const rn=(pe==null?void 0:pe.mtimeMs)||0,Un=(it==null?void 0:it.mtimeMs)||0;return rn===Un?(pe.path||"").localeCompare(it.path||""):Un-rn}),re=new Map;ae.forEach(pe=>re.set(pe.path,pe.mtimeMs||0));const nt=y.map((pe,it)=>({path:pe.sourcePath,idx:it})).filter(pe=>pe.path);for(const pe of nt){const it=f.get(pe.path)||0;(re.get(pe.path)||0)>it&&await qt(pe.path)}a=ae;const bt=new Set;a.forEach(pe=>bt.add($e(pe.path))),s=Array.from(bt).filter(pe=>pe!=="").sort(),f=re,St(),$t()}catch(k){console.warn("[Blockscape] auto-reload check failed",k)}finally{B=!1}}}function Cn(k){h=!!k,ne(h),Bt()}function Ke(k){return w=Se(k),et(w),Bt(),w}function an(k){i=!1,a=[],f=new Map,at(),$t(),le.hidden=!0,k&&Ue(k,{error:!0}),t("Panel hidden",{message:k})}async function Kn({silent:k=!1}={}){try{t("Health check start");const F=await fetch("/api/health",{cache:"no-store"});if(!F.ok)throw new Error(`HTTP ${F.status}`);const ae=await F.json();if(i=!!(ae!=null&&ae.ok),!i)throw new Error("Health check failed");return le.hidden=!1,k||Ue(ae.root?`Local server ready (root: ${ae.root})`:"Local server ready"),t("Health check ok",{payload:ae}),!0}catch(F){return k||console.log("[Blockscape] local backend health failed",F),an("Local server unavailable"),!1}}async function yn(){if(i&&ue){Ue("Loading files…");try{const k=await fetch("/api/files",{cache:"no-store"});if(!k.ok)throw new Error(`HTTP ${k.status}`);a=((await k.json()).files||[]).slice().sort((re,nt)=>{const bt=(re==null?void 0:re.mtimeMs)||0,pe=(nt==null?void 0:nt.mtimeMs)||0;return bt===pe?(re.path||"").localeCompare(nt.path||""):pe-bt});const ae=new Set;a.forEach(re=>{ae.add($e(re.path))}),s=Array.from(ae).filter(re=>re!=="").sort(),d&&!ae.has(d)&&(d=""),!d&&o&&(d=$e(o)),f=new Map(a.map(re=>[re.path,re.mtimeMs||0])),St(),$t(),Ue(a.length?`Browsing ${a.length} file(s) in ~/blockscape`:"No .bs files in ~/blockscape yet")}catch(k){console.warn("[Blockscape] local backend refresh failed",k),an("Local server unavailable")}}}async function La(){i=!1,an(),Ue("Checking for local server…");try{return t("Detect start"),await Kn()?(Be(),await yn(),Bt(),!0):!1}catch(k){return i=!1,console.log("[Blockscape] local backend not detected",k),t("Detect failed",{err:k}),!1}}async function qo(){if(!i||!ue)return;const k=Array.from(ue.selectedOptions||[]).map(ae=>ae.value).filter(Boolean).sort((ae,re)=>ae.localeCompare(re));if(!k.length){alert("Select one or more files to load from ~/blockscape.");return}let F=null;for(const ae of k)try{Ue(`Loading ${ae}…`);const re=await jr(ae);F==null&&(F=(re==null?void 0:re.firstIndex)??null),o=ae,Oo(ae)}catch(re){console.error("[Blockscape] failed to load from local server",re),alert(`Local load failed for ${ae}: ${re.message}`)}F!=null&&gt(F),Ue(`Loaded ${k.length} file(s)`),$t()}async function ro(k,{statusPrefix:F="Saved to",updateInput:ae=!0}={}){if(!i)return;if(v<0){alert("No active model to save.");return}const re=y[v],{payload:nt,isSeries:bt}=rt(re);if(!nt){alert("No model data to save.");return}const pe=tt(k);if(!pe){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const it=JSON.stringify(nt,null,2);Ue(`Saving ${bt?"series":"map"} to ${pe}…`);const Un=await fetch(`/api/file?path=${encodeURIComponent(pe)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:it});if(!Un.ok)throw new Error(`HTTP ${Un.status}`);const sn=await Un.json();o=sn.path||pe,re.sourcePath=sn.path||pe,ae&&Fe&&(Fe.value=sn.path||pe),Oo(sn.path||pe),Ue(`${F} ${sn.path||pe}`),await yn()}catch(it){console.error("[Blockscape] local save failed",it),alert(`Local save failed: ${it.message}`),an("Local server unavailable")}}async function so(){var F;const k=tt(Fe==null?void 0:Fe.value)||tt((F=y[v])==null?void 0:F.sourcePath)||Mt();if(!k){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await ro(k,{statusPrefix:"Saved to"})}async function lo(){var re;if(!i)return;if(v<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const k=tt((re=y[v])==null?void 0:re.sourcePath)||Mt(),F=window.prompt("Save active map as (under ~/blockscape):",k);if(F==null)return;const ae=tt(F);if(!ae){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await ro(ae,{statusPrefix:"Saved to"})}async function co(k,F,{refreshAfter:ae=!0,statusPrefix:re="Saved to"}={}){if(!i)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(k)||k<0)return{ok:!1,error:"Invalid model index"};const nt=y[k],{payload:bt,isSeries:pe}=rt(nt);if(!bt)return{ok:!1,error:"Model has no data"};const it=tt(F)||tt(nt==null?void 0:nt.sourcePath)||Mt();if(!it)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const rn=JSON.stringify(bt,null,2);Ue(`Saving ${pe?"series":"map"} to ${it}…`);const sn=await fetch(`/api/file?path=${encodeURIComponent(it)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:rn});if(!sn.ok)throw new Error(`HTTP ${sn.status}`);const ln=await sn.json();return o=ln.path||it,nt.sourcePath=ln.path||it,k===v&&Be(),Ue(`${re} ${ln.path||it}`),ae&&await yn(),{ok:!0,path:ln.path||it}}catch(rn){return console.error("[Blockscape] local save failed",rn),an("Local server unavailable"),{ok:!1,error:rn.message}}}if(st&&(st.onclick=()=>yn()),Xe&&(Xe.onclick=()=>qo()),Pe&&(Pe.onclick=()=>so()),ut&&(ut.onclick=()=>lo()),ue&&Fe&&(ue.addEventListener("change",()=>{const k=Array.from(ue.selectedOptions||[])[0];k!=null&&k.value&&(Fe.value=k.value)}),ue.addEventListener("dblclick",()=>{qo()})),He&&He.addEventListener("change",()=>{d=He.value||"",$t()}),le){const k="local-files-panel-focus",F="local-files-panel-pointer";let ae=!1,re=!1;le.addEventListener("focusin",()=>{ae||(ae=!0,_n(k))}),le.addEventListener("focusout",nt=>{if(!ae)return;const bt=nt.relatedTarget;bt&&le.contains(bt)||(ae=!1,wn(k))}),le.addEventListener("pointerenter",()=>{re||(re=!0,_n(F))}),le.addEventListener("pointerleave",()=>{re&&(re=!1,wn(F))})}return{detect:La,refresh:yn,updateActiveSavePlaceholder:Be,isAvailable:()=>i,highlightSource:nn,saveModelByIndex:co,getAutoReloadConfig:()=>({enabled:h,intervalMs:w,available:i}),setAutoReloadEnabled:Cn,setAutoReloadInterval:Ke}}async function jr(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const i=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);const o=await i.json(),a=JSON.stringify(o.data??o,null,2),s=On(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let d=null;return s.forEach((f,h)=>{if(f.sourcePath=e,f.isSeries&&!f.title){const B=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");f.title=B}const w=kn(f,{versionLabel:s.length>1?`${t} #${h+1}`:t});d==null&&(d=w)}),{firstIndex:d,total:s.length}}async function Jr(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function zl(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function zt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function ui(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function ql(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Gl(e,t){const n=ui(e);if(!n)return null;const i=n.split("/"),s=`${(i.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...i,s].filter(Boolean).join("/")}function ga(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function to(){try{await Dr}catch{}return typeof(ze==null?void 0:ze.isAvailable)=="function"?ze.isAvailable():!1}async function Kl(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Yl(e,t){const n=ui(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const i=n.split("/"),a=(i.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const d=`${a}-${s}.bs`,f=[...i,d].filter(Boolean).join("/");if(!t.has(f))return f}return null}function Xl(e,t="clipboard"){const n=qe(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",i=zt(n),o=ga();return`${i}-${o}.bs`}function Zl(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=ql(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const i=vn(n||"unknown");return pi(e,i),It(e,{seriesName:n,fallbackTitle:n}),!0}function Ql(e){return Number.isFinite(e)?Math.min(Ee,Math.max(fe,e)):de}function Ht(){if(!p)return;const e=!!$||!!xe;p.classList.toggle("blockscape-has-selection",e),p.classList.toggle("blockscape-has-item-selection",!!$)}function Ti(e){return yi=Ql(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",yi),yi}function ec(e){return Number.isFinite(e)?Math.min(Qt,Math.max(Zt,e)):Ae}function Li(e){Nn=ec(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Nn);const t=Mn?Nn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Nn}function tc(e){return Number.isFinite(e)?Math.min(kr,Math.max(Ir,e)):vi}function Ni(e){return Ei=tc(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",Ei),Ei}function nc(e){return Number.isFinite(e)?Math.min(Lt,Math.max(Tt,e)):Qe}function Mi(e){return Si=nc(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",Si),Si}function ic(e){return Number.isFinite(e)?Math.min(ri,Math.max(pn,e)):en}function $i(e){return Ii=ic(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Ii),Ii}function Bi(e){const t=e==="nowrap"?"nowrap":"wrap";fa=t;const n=t==="nowrap"?"nowrap":"normal",i=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",i),t}function zr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(J,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function oc(){if(typeof window>"u"||!window.localStorage)return Ti(de);try{const e=window.localStorage.getItem(J);if(!e)return Ti(de);const t=parseFloat(e);return Ti(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Ti(de)}}function qr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Z,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function ac(){if(typeof window>"u"||!window.localStorage)return Li(Ae);try{const e=window.localStorage.getItem(Z);if(!e)return Li(Ae);const t=parseFloat(e);return Li(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Li(Ae)}}function Ri(e){Mn=!!e;const t=Mn?Nn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),p&&p.classList.toggle("blockscape-dimming-disabled",!Mn),Mn}function Gr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(we,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function rc(){if(typeof window>"u"||!window.localStorage)return Ri(!0);try{const e=window.localStorage.getItem(we);return e==null?Ri(!0):Ri(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),Ri(!0)}}function Oi(e){return ci=!!e,ci}function Kr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Mr,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function sc(){if(typeof window>"u"||!window.localStorage)return Oi($o);try{const e=window.localStorage.getItem(Mr);return e==null?Oi($o):Oi(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Oi($o)}}function Yr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(si,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function lc(){if(typeof window>"u"||!window.localStorage)return Ni(vi);try{const e=window.localStorage.getItem(si);if(!e)return Ni(vi);const t=parseFloat(e);return Ni(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Ni(vi)}}function Xr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(De,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function cc(){if(typeof window>"u"||!window.localStorage)return Mi(Qe);try{const e=window.localStorage.getItem(De);if(!e)return Mi(Qe);const t=parseFloat(e);return Mi(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Mi(Qe)}}function Zr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(pt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function dc(){if(typeof window>"u"||!window.localStorage)return $i(en);try{const e=window.localStorage.getItem(pt);if(!e)return $i(en);const t=parseFloat(e);return $i(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),$i(en)}}function Qr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(At,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function uc(){if(typeof window>"u"||!window.localStorage)return Bi(Jt);try{const e=window.localStorage.getItem(At);return Bi(e||Jt)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Bi(Jt)}}function pc(e){return Number.isFinite(e)?Math.min(Vr,Math.max(Pr,e)):Qi}function Pi(e){return $n=pc(e),$n}function fc(e){Ft=!!e}function mc(e){Ot=!!e}function es(){return{hoverScale:yi,selectionDimOpacity:Nn,selectionDimEnabled:Mn,tileCompactness:Ei,titleWrapMode:fa,titleHoverWidthMultiplier:Si,titleHoverTextPortion:Ii,obsidianLinksEnabled:ki,obsidianLinkMode:Xi,obsidianVaultName:_i,autoIdFromNameEnabled:ci,seriesNavDoubleClickWaitMs:$n,showSecondaryLinks:Ft,centerItems:tn,showReusedInMap:Ot,theme:Zi,colorPresets:Ut}}function hc(e,{refreshObsidianLinks:t}={}){return bl(e,{applyTileHoverScale:Ti,persistTileHoverScale:zr,applySelectionDimEnabled:Ri,persistSelectionDimEnabled:Gr,applySelectionDimOpacity:Li,persistSelectionDimOpacity:qr,applyTileCompactness:Ni,persistTileCompactness:Yr,applyTitleWrapMode:Bi,persistTitleWrapMode:Qr,applyTitleHoverWidthMultiplier:Mi,persistTitleHoverWidthMultiplier:Xr,applyTitleHoverTextPortion:$i,persistTitleHoverTextPortion:Zr,applyObsidianLinksEnabled:Di,persistObsidianLinksEnabled:is,applyObsidianLinkMode:Vi,persistObsidianLinkMode:ns,applyObsidianVaultName:Ui,persistObsidianVaultName:os,applyAutoIdFromNameEnabled:Oi,persistAutoIdFromNameEnabled:Kr,applySeriesNavDoubleClickWait:Pi,persistSeriesNavDoubleClickWait:ts,localBackend:ze,ui:_e,refreshObsidianLinks:t,scheduleOverlaySync:Wi,selection:$,select:yt,clearStyles:zo,drawLinks:qn,applyReusedHighlights:Aa,setShowSecondaryLinks:fc,setShowReusedInMap:mc,applyTheme:ma,setColorPresets:Ai,applyCenterItems:xi,persistCenterItems:Hr,current:es()})}function ts(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Or,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function gc(){if(typeof window>"u"||!window.localStorage)return Pi(Qi);try{const e=window.localStorage.getItem(Or);if(!e)return Pi(Qi);const t=parseInt(e,10);return Pi(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Pi(Qi)}}function bc(e){return e===Lo?Lo:pa}function Vi(e){return Xi=bc(e),Xi}function ns(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Cr,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function vc(){if(typeof window>"u"||!window.localStorage)return Vi(No);try{const e=window.localStorage.getItem(Cr);return Vi(e||No)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Vi(No)}}function Di(e){return ki=!!e,ki}function is(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(_r,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function wc(){if(typeof window>"u"||!window.localStorage)return Di(!1);try{const e=window.localStorage.getItem(_r);return e==null?Di(!1):Di(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Di(!1)}}function Ui(e){return _i=(e??"").toString().trim(),_i}function os(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(xr,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function yc(){if(typeof window>"u"||!window.localStorage)return Ui("");try{const e=window.localStorage.getItem(xr);return Ui(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Ui("")}}function Ec(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Sc(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const i=n.find(a=>a&&typeof a=="object")||n[0];return((i==null?void 0:i.title)??"").toString().trim()||`${t} series`}function pi(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function Ic(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||Vo(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const i=n.trim();if(!i)return!1;const o=Wn(e,{seriesName:i,fallbackTitle:i})||vn(i,i),a=window.prompt("Series ID (used for linking and downloads)",o);if(a==null)return!1;const s=vn(a.trim()||i,i||"series");return e.title=i,e.apicurioArtifactName=i,pi(e,s),!0}function ba(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(i=>ba(i)).join(",")}]`:`{${Object.keys(e).sort().map(i=>`${JSON.stringify(i)}:${ba(e[i])}`).join(",")}}`}function as(e){try{return ba(e)}catch{return""}}function Po(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=as(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=as(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const kc=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function In(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const i=(e.title??"").toString().trim();e.title=i||t||"Untitled Model";const o=(e.id??"").toString().trim();if(o)e.id=o;else{const a=n||e.title||t||"model",s=zt(a).replace(/\./g,"-");e.id=s||`model-${di()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function _c(e){return JSON.parse(JSON.stringify(e))}function qe(e,t="Untitled Model"){var i;return e&&(((i=e.data)==null?void 0:i.title)??e.title??"").toString().trim()||t}function Vo(e,t="Untitled Model"){var i;if(((i=e==null?void 0:e.apicurioVersions)==null?void 0:i.length)>1||(e==null?void 0:e.isSeries)){const o=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(o)return o;const a=ct(e);return a?`${a} series`:t}return qe(e,t)}function ct(e){var o;const t=Wn(e);if(t)return t;const n=(o=e==null?void 0:e.data)==null?void 0:o.id;return n&&n.toString().trim()||null}function rs(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function Cc(e){return e?e.toString().replace(/-series$/i,""):null}function va(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<y.length;n++){const i=(ct(y[n])||"").toLowerCase(),o=(rs(y[n])||"").toLowerCase();if(t===i||t===o)return n}return-1}function ss(e){var d;if(e<0||e>=y.length||!r)return!0;const t=y[e],n=(r.value||"").trim();if(!n)return!0;let i;try{i=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}In(i,{titleHint:qe(t),idHint:ct(t)});const o=Po(t.data),a=Po(i);if(o===a)return!0;t.data=i;const s=Pn(t);return s>=0&&((d=t.apicurioVersions)!=null&&d[s])&&(t.apicurioVersions[s].data=i),!0}function ls(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(i=>{i!=null&&i.id&&t.add(i.id)})),t}function wa(e){if(v<0||!e)return null;const t=y[v].data,n=(t==null?void 0:t.categories)||[];for(const i of n){const a=(i.items||[]).find(s=>s.id===e);if(a)return{category:i,item:a,modelData:t}}return null}function xc(e,t){const n=wa(e);return n?(t?n.item.color=t:delete n.item.color,Nt(),Et(),yt(e),!0):!1}function Ac(e,t){const n=ls(t);let i=zt(e||"item");if(!n.has(i))return i;const o=()=>di().slice(0,4);for(;n.has(i);)i=`${zt(e||"item")}-${o()}`;return i}function Tc(e="category",t){const n=(t==null?void 0:t.categories)||[],i=zt(e||"category"),o=d=>n.some(f=>f.id===d);let a=i||`category-${di()}`;if(!o(a))return a;let s=n.length+1;for(;o(`${i}-${s}`);)s+=1;return`${i}-${s}`}const fi=ml({findItemAndCategoryById:wa,collectAllItemIds:ls,updateItemReferences:fl,loadActiveIntoEditor:Nt,rebuildFromActive:Et,select:e=>yt(e),onSelectionRenamed:(e,t)=>{var n;$===e&&($=t,Ht()),((n=Pt==null?void 0:Pt.item)==null?void 0:n.id)===e&&(Pt.item.id=t)},makeSlug:zt,isAutoIdFromNameEnabled:()=>ci});function Lc({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:i,onCategoryRenamed:o}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=E=>{if(a.fields.errorEl){if(!E){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=E}},d=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},f=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var E,te;(E=a.fields.titleInput)==null||E.focus(),(te=a.fields.titleInput)==null||te.select()}))},h=({force:E}={})=>{var ne,ot;if(!ci||!a.autoSyncEnabled||!((ne=a.fields)!=null&&ne.idInput)||!((ot=a.fields)!=null&&ot.titleInput)||!E&&a.idManuallyEdited)return;const te=zt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=te},w=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const E=a.modelData.categories||[],te=E.find($e=>$e.id===a.categoryId);if(!te)throw new Error("Category not found.");const ne=(a.fields.idInput.value||"").trim();if(!ne)throw new Error("ID is required.");const ot=(a.fields.titleInput.value||"").trim();if(E.some($e=>$e.id===ne&&$e.id!==te.id))throw new Error("Another category already uses that ID.");const Se=te.id;return te.id=ne,te.title=ot||te.id,Se!==ne&&typeof o=="function"&&o(Se,ne),t(),n(),i(ne,{scrollIntoView:!0}),!0},T=()=>{try{return w(),d(),!0}catch(E){return console.warn("[CategoryEditor] save failed",E),s((E==null?void 0:E.message)||"Unable to save category."),!1}},B=()=>{if(a.wrapper)return a.wrapper;const E=document.createElement("div");E.className="item-editor-modal category-editor-modal",E.hidden=!0,E.setAttribute("role","dialog"),E.setAttribute("aria-modal","true");const te=document.createElement("div");te.className="item-editor-modal__backdrop",E.appendChild(te);const ne=document.createElement("div");ne.className="item-editor",E.appendChild(ne);const ot=document.createElement("div");ot.className="item-editor__header";const et=document.createElement("h2");et.className="item-editor__title",et.textContent="Edit category";const Se=document.createElement("button");Se.type="button",Se.className="item-editor__close",Se.setAttribute("aria-label","Close category editor"),Se.textContent="×",ot.appendChild(et),ot.appendChild(Se),ne.appendChild(ot);const $e=document.createElement("form");$e.className="item-editor__form",ne.appendChild($e);const Ue=document.createElement("div");Ue.className="item-editor__meta",Ue.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',$e.appendChild(Ue);const tt=document.createElement("div");tt.className="item-editor__error",tt.hidden=!0,$e.appendChild(tt);const rt=(on,Cn,Ke)=>{const an=document.createElement("label");an.className="item-editor__field";const Kn=document.createElement("span");if(Kn.className="item-editor__label",Kn.textContent=on,an.appendChild(Kn),Cn.classList.add("item-editor__control"),an.appendChild(Cn),Ke){const yn=document.createElement("div");yn.className="item-editor__hint",yn.textContent=Ke,an.appendChild(yn)}return an},Mt=document.createElement("input");Mt.type="text",$e.appendChild(rt("Title",Mt,"Display label shown in the map."));const Be=document.createElement("input");Be.type="text",Be.required=!0,$e.appendChild(rt("ID",Be,"Unique identifier for this category (used in URLs and references)."));const St=document.createElement("div");St.className="item-editor__checkbox";const $t=document.createElement("label");$t.className="item-editor__checkbox-row";const nn=document.createElement("input");nn.type="checkbox";const at=document.createElement("span");at.textContent="Sync ID while editing title";const Bt=document.createElement("div");Bt.className="item-editor__hint",Bt.textContent="Turn off to keep typing titles without changing the ID.",$t.append(nn,at),St.append($t,Bt),$e.appendChild(St);const _n=document.createElement("div");_n.className="item-editor__actions";const wn=document.createElement("button");wn.type="submit",wn.className="item-editor__action item-editor__action--primary",wn.textContent="Save";const qt=document.createElement("button");return qt.type="button",qt.className="item-editor__action",qt.textContent="Cancel",_n.appendChild(wn),_n.appendChild(qt),$e.appendChild(_n),$e.addEventListener("submit",on=>{on.preventDefault(),T()}),qt.addEventListener("click",d),Se.addEventListener("click",d),te.addEventListener("click",d),Be.addEventListener("input",()=>{a.idManuallyEdited=!0}),Mt.addEventListener("input",()=>h()),nn.addEventListener("change",()=>{a.autoSyncEnabled=!!nn.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,h({force:!0}))}),E.addEventListener("keydown",on=>{on.key==="Escape"&&(on.preventDefault(),d())}),document.body.appendChild(E),a.wrapper=E,a.fields={titleInput:Mt,idInput:Be,errorEl:tt,metaLabel:Ue.querySelector(".item-editor__meta-value"),syncCheckbox:nn},E};return{open:E=>{if(!E||!B())return!1;const ne=e(),et=((ne==null?void 0:ne.categories)||[]).find($e=>$e.id===E);if(!et)return!1;a.categoryId=et.id,a.modelData=ne,a.idManuallyEdited=!1;const Se=!!ci;return a.autoSyncEnabled=Se,a.fields.metaLabel.textContent=et.title||et.id||"Category",a.fields.titleInput.value=et.title||et.id||"",a.fields.idInput.value=et.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!Se,!a.fields.idInput.value&&Se&&h({force:!0}),s(""),f(),!0},hide:d,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const Nc=Lc({getActiveModelData:()=>{var e;return(e=y[v])==null?void 0:e.data},loadActiveIntoEditor:Nt,rebuildFromActive:Et,selectCategory:(e,t={})=>Vn(e,t),onCategoryRenamed:(e,t)=>{xe===e&&(xe=t,Ht())}}),{handleTileContextMenu:Mc,hidePreview:zn,handleDocumentClick:$c,handleWindowResize:Bc,handleWindowScroll:Rc,updateColorPresets:Hi}=hl({menuEl:document.getElementById("tileContextMenu"),previewEl:ie,previewTitleEl:he,previewBodyEl:j,previewActionsEl:me,previewCloseEl:ke,escapeHtml:io,onEditItem:e=>fi.open(e),onChangeColor:(e,t)=>xc(e,t),selectItem:e=>yt(e),colorPresets:Ut});function Do(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const i={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[i],e.apicurioActiveVersionIndex=0;const o=e.title||qe(e);return It(e,{seriesName:o,fallbackTitle:o}),e.isSeries=!0,e}function Oc({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=zt(`${e||"blank"}-${ga()}`),i={id:n,title:t,categories:[],links:[],abstract:""};return e&&(i.seriesId=e),In(i,{titleHint:t,idHint:n}),i}function Pc(){const t=`Blank series ${ga()}`,n=vn(t,"blank-series"),i=Oc({seriesId:n,mapTitle:"Blank map"}),o={id:n,title:t,apicurioArtifactName:t,data:i,apicurioVersions:[{version:"1",data:i,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return pi(o,n),It(o,{seriesName:t,fallbackTitle:t}),o}function Vc(){const e=Pc(),t=kn(e,{versionLabel:"blank"});return gt(t),Ho(),Bn("Blank series created. Add categories and tiles to start.",2600),t}function kn(e,{versionLabel:t,createdOn:n}={}){var f,h,w;if(e!=null&&e.isSeries||((f=e==null?void 0:e.apicurioVersions)==null?void 0:f.length)>1){const T=e.title||qe(e);It(e,{seriesName:T,fallbackTitle:T}),Fo(e)}const i=ct(e);if(!i)return Do(e,{versionLabel:t||"1",createdOn:n}),y.push(e),y.length-1;const o=y.findIndex(T=>ct(T)===i);if(o===-1)return Do(e,{versionLabel:t||"1",createdOn:n}),y.push(e),y.length-1;const a=y[o];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(w=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:w.createdOn}],a.apicurioActiveVersionIndex=0;const T=a.title||qe(a);It(a,{seriesName:T,fallbackTitle:T})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=qe(e)||a.title,a.isSeries=!0;const d=a.title||qe(a);return It(a,{seriesName:d,fallbackTitle:d}),o}function cs({versionLabel:e}={}){var s;if(v<0||!y[v])throw new Error("Load or select a model before creating a version.");const t=y[v];Do(t,{versionLabel:"1"});let n;try{n=_c(t.data)}catch(d){throw console.warn("[Blockscape] failed to clone active model for versioning",d),new Error("Could not copy the current model.")}In(n,{titleHint:qe(t),idHint:ct(t)||Wn(t)});const o={version:e||String((((s=t.apicurioVersions)==null?void 0:s.length)||0)+1),data:n,createdOn:new Date().toISOString()};t.apicurioVersions.push(o),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=n,t.isSeries=!0;const a=t.title||qe(t);return It(t,{seriesName:a,fallbackTitle:a}),v}function ya(){const e=v>=0&&y[v]?y[v]:null,t=ct(e);document.title=t?`${t}-blockscape`:V}function Uo(e){if(!e)return null;Fo(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||qe(e);return It(e,{seriesName:n,fallbackTitle:n}),t.filter((o,a)=>{var f;const s=((o==null?void 0:o.version)??"").toString().trim(),d=(((f=o==null?void 0:o.data)==null?void 0:f.id)??(o==null?void 0:o.id)??"").toString().trim();return o!=null&&o.isCategoryView||s.startsWith(Bo)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:d}),!1):!0}).map(o=>o&&typeof o=="object"&&"data"in o?o.data:o)}function Dc(){const e=y[v],t=Uo(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function ds(e="shortcut",t=!1){const n=r.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const i=y[v],o=t?Uo(i):null,a=!!o,s=a?JSON.stringify(o,null,2):n,d=Wn(i),f=ct(i),h=d||f||qe(i,"blockscape"),w=a?"-series":"",T=`${zt(h)}${w}.bs`;return Ur(T,s),console.log(`[Blockscape] saved JSON (${e}):`,T),!0}const Uc=cn.palette.letter,Hc=cn.palette.letterFallback;function us(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Uc[n]||Hc}function Fc(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(f=>f+f).join(""):t,i=parseInt(n,16),o=i>>16&255,a=i>>8&255,s=i&255;return .2126*Math.pow(o/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?cn.color.ink:cn.color.white}function Wc(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function Ea(){if(xt)return;xt=document.createElement("div"),xt.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",Vt=document.createElement("span"),Vt.className="series-nav-notice__text",xt.appendChild(e),xt.appendChild(Vt),document.body.appendChild(xt)}function Sa(){Wt&&(clearTimeout(Wt),Wt=null),xt&&xt.classList.remove("is-visible"),Vt&&(Vt.textContent="")}function Fi(){Yt=null,Xt&&(clearTimeout(Xt),Xt=null),Sa()}function Ia(){Ct=null,dn&&(clearTimeout(dn),dn=null),Sa()}function jc(e,t){var i;if(!((i=e==null?void 0:e.apicurioVersions)!=null&&i[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function Jc(e,t,n){Ea(),Yt={id:e,targetVersionIndex:t},Xt&&clearTimeout(Xt),Xt=setTimeout(()=>{Xt=null,Fi()},$n);const i=jc(n,t);Bn(`Click again to open ${i} in this series.`,$n)}function zc(e,t){Ea(),Ct={id:e,targetIndex:t},dn&&clearTimeout(dn),dn=setTimeout(()=>{dn=null,Ia()},$n);const n=Vo(y[t]);Bn(`Click again to open "${n}".`,$n)}function Bn(e,t=ai,n=null){if(Ea(),Vt.textContent="",Vt.appendChild(document.createTextNode(e)),n){const i=document.createTextNode(" "),o=document.createElement("a");o.href=n,o.target="_blank",o.rel="noopener",o.textContent=n,Vt.appendChild(i),Vt.appendChild(o)}xt.classList.add("is-visible"),Wt&&clearTimeout(Wt),Wt=setTimeout(()=>Sa(),t)}function qc(){Le&&(Le.innerHTML="",kc.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((o,a)=>{if(a>0){const d=document.createElement("span");d.className="shortcut-help__or",d.textContent="or",n.appendChild(d)}const s=document.createElement("div");s.className="shortcut-help__combo",o.forEach((d,f)=>{if(f>0){const w=document.createElement("span");w.className="shortcut-help__sep",w.textContent="+",s.appendChild(w)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=d,s.appendChild(h)}),n.appendChild(s)});const i=document.createElement("div");i.className="shortcut-help__desc",i.textContent=e.description,t.appendChild(n),t.appendChild(i),Le.appendChild(t)}),oi=!0)}function Gc(){return!!ce&&ce.hidden===!1}function Kc(){if(!ce)return;oi||qc(),Ln=document.activeElement,ce.hidden=!1,ce.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=ce.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function ka(){if(!ce||ce.hidden)return;ce.hidden=!0,ce.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=Ln;e!=null&&e.focus?e.focus({preventScroll:!0}):M!=null&&M.focus&&M.focus({preventScroll:!0})}function Yc(){if(!ge)return;ge.hidden=!1,ge.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=ge.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ho(){!ge||ge.hidden||(ge.hidden=!0,ge.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),Ie!=null&&Ie.focus&&Ie.focus({preventScroll:!0}))}let _a=!1;function Wi(){_a||(_a=!0,requestAnimationFrame(()=>{_a=!1,jo(),qn()}))}let ps=!1;function fs(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function Xc(e){const t=fs(e);if(!t.length){p.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}p.querySelectorAll(".tile").forEach(n=>{var s;const i=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),o=(n.dataset.id||"").toLowerCase(),a=t.every(d=>i.includes(d)||o.includes(d));n.style.opacity=a?"1":"0.2"})}function Zc(e){const t=fs(e);if(!t.length)return[];const n=[];return y.forEach((i,o)=>{var h;const a=Vo(i),s=ct(i)||"",d=`${a} ${s}`.toLowerCase();t.every(w=>d.includes(w))&&n.push({type:"model",modelIndex:o,modelTitle:a,modelId:s}),(Array.isArray((h=i.data)==null?void 0:h.categories)?i.data.categories:[]).forEach(w=>{const T=(w.title||w.id||"").toString();(w.items||[]).forEach(B=>{const A=(B.name||B.id||"").toString(),E=`${A} ${B.id||""} ${T}`.toLowerCase();t.every(te=>E.includes(te))&&n.push({type:"item",modelIndex:o,modelTitle:a,modelId:s,itemId:B.id,itemName:A,categoryTitle:T})})})}),n.slice(0,R)}function ms(e){if(!P)return;P.innerHTML="";const t=(e||"").toString();if(!t.trim()){P.hidden=!0;return}if(!y.length){const i=document.createElement("div");i.className="search-results__empty",i.textContent="Load models to search",P.appendChild(i),P.hidden=!1;return}const n=Zc(t);if(!n.length){const i=document.createElement("div");i.className="search-results__empty",i.textContent="No matches yet",P.appendChild(i),P.hidden=!1;return}n.forEach(i=>{const o=document.createElement("button");o.type="button",o.className="search-result",o.dataset.modelIndex=String(i.modelIndex),i.itemId&&(o.dataset.itemId=i.itemId),i.type&&(o.dataset.type=i.type),i.modelIndex===v&&(!i.itemId||$===i.itemId)&&o.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=i.type==="model"?i.modelTitle:i.itemName||i.itemId||"Item",a.appendChild(s);const d=document.createElement("span");d.className="search-result__badge",d.textContent=i.type==="item"?i.categoryTitle||"Item":"Model",a.appendChild(d);const f=document.createElement("div");f.className="search-result__meta";const h=document.createElement("span");if(h.textContent=i.modelId?`${i.modelTitle} · ${i.modelId}`:i.modelTitle,f.appendChild(h),i.type==="item"&&i.itemId){const w=document.createElement("span");w.textContent=`Item ID: ${i.itemId}`,f.appendChild(w)}else if(i.type==="model"){const w=document.createElement("span");w.textContent="Matches model title",f.appendChild(w)}o.appendChild(a),o.appendChild(f),P.appendChild(o)}),P.hidden=!1}function hs(e){Xc(e||""),ms(e||"")}function Qc(e){!e||!Number.isInteger(e.modelIndex)||(gt(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(v!==e.modelIndex)return;const t=(n=ve.get(e.itemId))==null?void 0:n.el;t&&(yt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function gt(e){var t;if(zn(),Fi(),Pt=null,_t=null,xe=null,Ze=null,e<0||e>=y.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(Sn=!0,v=e,console.log("[Blockscape] active model:",qe(y[e]),"(index",e+" )"),typeof(ze==null?void 0:ze.highlightSource)=="function"){const n=((t=y[e])==null?void 0:t.sourcePath)||null;ze.highlightSource(n)}ya(),Rn(),Nt(),Et(),l&&hs(l.value||""),ze.updateActiveSavePlaceholder(),Je.updateAvailability(),ha()}function Rn(){if(X.innerHTML="",!y.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",X.appendChild(e);return}y.forEach((e,t)=>{var T;const n=document.createElement("li");n.className="model-nav-item";const i=document.createElement("button");i.type="button",i.className="model-nav-button"+(t===v?" is-active":""),i.dataset.index=String(t),i.setAttribute("aria-current",t===v?"true":"false");const o=document.createElement("span");o.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=Vo(e),o.appendChild(a);const s=Cc(rs(e)||ct(e));if(s){const B=document.createElement("span");B.className="model-nav-id",B.textContent=s,o.appendChild(B)}const d=Array.isArray((T=e.data)==null?void 0:T.categories)?e.data.categories:[],f=d.reduce((B,A)=>B+(A.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const w=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";h.textContent=`${d.length} cat · ${f} items${w}`,i.appendChild(o),i.appendChild(h),n.appendChild(i),X.appendChild(n)}),Je.updateAvailability()}function Nt(){if(v<0){r.value="",W&&(W.disabled=!0);return}const e=y[v];r.value=JSON.stringify(e.data,null,2),W&&(W.disabled=!Uo(e))}function ed(e){try{return JSON.parse(e)}catch{return null}}function gs(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function td(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,d)=>{const f=s==null?void 0:s.data;if(!f||!Array.isArray(f.categories))return;const h=qe(f,`Map ${d+1}`),w=(f.id??"").toString().trim()||zt(h||`map-${d+1}`),T=zt(w||h||`map-${d+1}`);f.categories.forEach(B=>{const A=((B==null?void 0:B.id)??"").toString().trim();if(!A)return;n.has(A)||n.set(A,{catTitle:B.title||A,sources:[]});const E=n.get(A);!E.catTitle&&(B.title||A)&&(E.catTitle=B.title||A),E.sources.push({category:B,mapId:w,mapTitle:h,mapSlug:T,versionIndex:d})})});const i=Wn(e)||null,o=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||qe(e,"Series"),a=[];return n.forEach((s,d)=>{var B;if((((B=s.sources)==null?void 0:B.length)||0)<2)return;const f=s.catTitle||d,h=new Set,w=s.sources.map(A=>{var et;let te=A.mapSlug||zt(A.mapTitle||A.mapId)||`map-${A.versionIndex+1}`;h.has(te)&&(te=`${te}-${A.versionIndex+1}`),h.add(te);const ne=new Map,ot=(((et=A.category)==null?void 0:et.items)||[]).map((Se,$e)=>{const Ue=((Se==null?void 0:Se.id)??"").toString().trim()||`item-${$e+1}`,tt=`${te}-${Ue}`;ne.set(Ue,tt);const rt={...Se,id:tt};return rt.deps=Array.isArray(Se==null?void 0:Se.deps)?[...Se.deps]:[],rt});return ot.forEach(Se=>{Se.deps=(Se.deps||[]).map($e=>ne.get($e)).filter(Boolean)}),{id:te,title:A.mapTitle||A.mapId||`Map ${A.versionIndex+1}`,items:ot}}),T={id:zt(`${d}-category-view`),title:f,abstract:`Items from "${f}" across ${s.sources.length} maps in this series${o?` (${o})`:""}.`,categories:w,links:[]};i&&(T.seriesId=i),In(T,{titleHint:f,idHint:`${i||"series"}-${d}`}),a.push({version:`${Bo}${d}`,data:T,isCategoryView:!0,categoryViewKey:d})}),a}function bs(e){var i;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${Bo}${e.categoryViewKey}`;const t=(((i=e.data)==null?void 0:i.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function Fo(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=bs(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(d=>!(d!=null&&d.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Pn(e),e.apicurioVersions.length-1));const d=e.apicurioVersions[e.apicurioActiveVersionIndex];return d!=null&&d.data&&(e.data=d.data),e}const i=td({...e,apicurioVersions:n});e.apicurioVersions=[...n,...i];let o=e.apicurioVersions.findIndex(d=>bs(d)===t);o===-1&&(o=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(o,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function nd(e,t="Pasted",n={}){const i=Array.isArray(e)?e:[];if(!i.length)return[];const o=i.map((w,T)=>!w||typeof w!="object"?null:(In(w,{titleHint:`${t} #${T+1}`}),{obj:w,idx:T})).filter(Boolean);if(!o.length)return[];const a=o[0].obj,{seriesTitleOverride:s}=n;let d=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const f={id:di(),title:d,data:a,apicurioVersions:o.map(({obj:w,idx:T})=>({version:String(T+1),data:w})),apicurioActiveVersionIndex:0,isSeries:!0},h=It(f,{seriesName:d,fallbackTitle:d});return h&&(f.id=h),Fo(f),[f]}function vs(e,t="Pasted",n={}){return Array.isArray(e)?nd(e,t,n):!e||typeof e!="object"?[]:(In(e,{titleHint:`${t} #1`}),[{id:di(),title:e.title||`${t} #1`,data:e}])}function On(e,t="Pasted",n={}){const o=(gs(typeof e=="string"?e:"")||"").trim();if(!o)return[];const a=ed(o);if(a){let d=n;if(Array.isArray(a)&&n.promptForSeriesName){const h=Sc(a,t),w=Ec(h);d={...n,promptForSeriesName:!1,seriesTitleOverride:w||h}}const f=vs(a,t,d);if(f.length)return f}return o.split(/^\s*(?:---|%%%)\s*$/m).map(d=>d.trim()).filter(Boolean).map((d,f)=>{const h=JSON.parse(d);return In(h,{titleHint:`${t} #${f+1}`}),{id:di(),title:h.title||`${t} #${f+1}`,data:h}})}function id(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function mi(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!id(e)}function od(e){if(!e)return!1;const n=(gs(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function ws(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(lt)}catch(o){return console.warn("[Blockscape] failed to access editor payload",o),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(o){console.warn("[Blockscape] invalid payload JSON",o);try{localStorage.removeItem(lt)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(lt)}catch(o){console.warn("[Blockscape] failed to clear editor payload",o)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=On(t.text,t.title||"Editor Export")}catch(o){return console.warn("[Blockscape] could not parse payload text",o),null}if(!n.length)return null;let i=null;return n.forEach(o=>{const a=kn(o,{versionLabel:"editor"});i==null&&(i=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:i,count:n.length}}function ys(e="storage"){const t=ws();return!t||typeof t.index!="number"?!1:(gt(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function ad(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let i;try{const s=Ol(t);i=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!i||typeof i!="object"||i.data==null)return console.warn("[Blockscape] share payload missing data"),null;const o=vs(i.data,i.title||"Shared Model");if(!o.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return o.forEach(s=>{const d=s.isSeries?i.title||s.title:null,f=kn({...s,apicurioArtifactName:d||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=f)}),a}async function rd(){const e=Wl();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:i}=e;try{if(!await to())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await jr(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(ze==null?void 0:ze.highlightSource)=="function"&&ze.highlightSource(t);let s=a.firstIndex;if(n){const d=va(n);d!==-1&&(s=d)}return{modelIndex:s,itemId:i||null,modelId:n||null}}return null}catch(o){return console.warn("[Blockscape] server-path autoload failed",o),null}}async function sd(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const i=new URLSearchParams(window.location.search);i.has("load")&&(t=i.get("load"))}if(!t)return null;try{const i=await Ta(t);return typeof i=="number"?i:null}catch(i){return console.warn("[Blockscape] load param failed",i),null}}function ld(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,i=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{i.add(s.id);const d=new Set(s.deps||[]);(e.links||[]).forEach(f=>{f.from===s.id&&d.add(f.to)}),t.set(s.id,d),d.forEach(f=>{n.has(f)||n.set(f,new Set),n.get(f).add(s.id)})}));const o=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&o.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:o,seen:i}}function cd(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),i=44;n.width=i,n.height=i;const o=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=us(e,t),d=Fc(s);return o.fillStyle=s,o.beginPath(),o.arc(i/2,i/2,i/2-2,0,2*Math.PI),o.fill(),o.strokeStyle="rgba(0,0,0,0.15)",o.lineWidth=1,o.stroke(),o.fillStyle=d,o.font=`bold ${i*.5}px system-ui, -apple-system, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(a,i/2,i/2),n.toDataURL("image/png")}function Pn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Es(e){const t=Pn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Ss(e,t="active"){return Wn(e)||ct(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function dd(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,i)=>{var s,d;const o=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();o&&t.set(o,i);const a=(((d=n==null?void 0:n.data)==null?void 0:d.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,i)}),t}function ud(e,t){if(!e||!t)return null;const n=new Set,i=o=>{const a=(o??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(zt(a)))};i(e.id),i(e.title);for(const o of n)if(t.has(o))return t.get(o);for(const o of n){const a=o.toLowerCase();for(const[s,d]of t.entries())if(s.toLowerCase()===a)return d}return null}const Is=new WeakMap;function pd(e,t){var tt;if(!((tt=e==null?void 0:e.apicurioVersions)!=null&&tt[t]))return null;const n=e.apicurioVersions[t],i=n.data,o=Po(i),a=Is.get(n);if(a&&a.fingerprint===o)return a.dataUrl;const s=160,d=160,f=document.createElement("canvas");f.width=s,f.height=d;const h=f.getContext("2d"),w=Fr("--color-surface-ghost")||cn.color.surfaceGhost,T=Fr("--color-border-muted")||cn.color.borderMuted;h.fillStyle=w,h.fillRect(0,0,s,d),h.strokeStyle=T,h.strokeRect(.5,.5,s-1,d-1);const B=8,A=8,E=4,te=Array.isArray(i==null?void 0:i.categories)?i.categories:[],ne=Math.max(te.length,1),ot=s-E*2,et=E*3,Se=ne>1?Math.min(et,ot/(ne-1)):0,$e=ne>1?(s-Se*(ne-1))/2:s/2;te.forEach((rt,Mt)=>{const Be=$e+Mt*Se,St=Array.isArray(rt.items)?rt.items:[],$t=Math.max(St.length,1),nn=d-B-A-E*2,at=$t>1?Math.min(E*3,nn/($t-1)):0;St.forEach((Bt,_n)=>{const wn=d-A-E-_n*at;h.beginPath(),h.arc(Be,wn,E,0,Math.PI*2);const qt=us(Bt.name||Bt.id||"",Bt.color);h.fillStyle=qt,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const Ue=f.toDataURL("image/png");return Is.set(n,{fingerprint:o,dataUrl:Ue}),Ue}function Wo(e,t){var d;if(Fi(),e<0||e>=y.length)return!1;const n=y[e];if(!((d=n==null?void 0:n.apicurioVersions)!=null&&d.length)||!ss(e))return!1;const o=n.apicurioVersions.length,a=(t%o+o)%o,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,Sn=!0,$=null,ht=null,Ht(),Nt(),Et(),!0):!1}function Ca(e){var i;if(!e||v<0)return!1;const t=y[v];if(!((i=t==null?void 0:t.apicurioVersions)!=null&&i.length))return!1;const n=Pn(t);return n===-1?!1:Wo(v,n+e)}function fd(e,t){if(Fi(),e<0||e>=y.length)return!1;const n=y[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!ss(e))return!1;const i=Math.min(Math.max(t,0),n.apicurioVersions.length-1),o=Pn(n),[a]=n.apicurioVersions.splice(i,1);if(!a)return!1;let s=o;i===o?s=Math.min(i,n.apicurioVersions.length-1):i<o&&(s=Math.max(0,o-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const d=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(d==null?void 0:d.data)||n.data,n.isSeries=n.apicurioVersions.length>1,gt(e),!0}function md(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=document.createElement("div");t.className="version-nav";const n=document.createElement("div");n.className="version-nav__title",n.textContent=e.apicurioArtifactName||e.apicurioArtifactId||ct(e)||"Artifact",n.title="Double-click to rename this series",n.setAttribute("role","button"),n.tabIndex=0,n.addEventListener("dblclick",()=>{var ne;const E=y[v];!((ne=E==null?void 0:E.apicurioVersions)!=null&&ne.length)||!Ic(E)||(Rn(),Nt(),Et())}),t.appendChild(n);const i=document.createElement("div");i.className="version-nav__status";const o=Pn(e),a=Es(e)||"latest";i.textContent=`No. in series ${a} (${o+1} of ${e.apicurioVersions.length})`,t.appendChild(i);const s=document.createElement("div");s.className="version-nav__controls";const d=document.createElement("button");d.type="button",d.className="version-nav__button",d.textContent="Previous",d.addEventListener("click",()=>Ca(-1));const f=document.createElement("button");f.type="button",f.className="version-nav__button",f.textContent="Next",f.addEventListener("click",()=>Ca(1)),s.appendChild(d),s.appendChild(f),t.appendChild(s);const h=document.createElement("div");h.className="version-nav__thumbs",e.apicurioVersions.forEach((E,te)=>{var rt,Mt;const ne=document.createElement("button");ne.type="button",ne.className="version-nav__thumb",E!=null&&E.isCategoryView&&ne.classList.add("version-nav__thumb--category"),te===o&&ne.classList.add("is-active");const ot=pd(e,te);if(ot){const Be=document.createElement("img");Be.src=ot,Be.alt=`Version ${te+1}`,ne.appendChild(Be)}const et=document.createElement("div");et.className="version-nav__thumb-label";const Se=document.createElement("span");Se.className="version-nav__thumb-label-text";const $e=(((rt=E==null?void 0:E.data)==null?void 0:rt.id)??(E==null?void 0:E.id)??"").toString().trim();let Ue=$e||(E!=null&&E.version?`v${E.version}`:`${te+1}`),tt=$e||Ue;if(E!=null&&E.isCategoryView){const Be=((Mt=E.data)==null?void 0:Mt.title)||E.categoryViewKey||Ue||"Category";Ue=Be,tt=`Category view: ${Be}`,ne.dataset.computed="true"}if(Se.textContent=Ue,et.title=tt,et.appendChild(Se),ne.appendChild(et),Sd(et,Se),e.apicurioVersions.length>1&&!(E!=null&&E.isCategoryView)){const Be=document.createElement("span");Be.className="version-nav__thumb-remove",Be.title=`Remove ${Ue} from this series`,Be.setAttribute("aria-label",`Remove ${Ue} from this series`),Be.setAttribute("role","button"),Be.tabIndex=-1,Be.textContent="×",Be.addEventListener("click",St=>{St.stopPropagation(),St.preventDefault(),window.confirm(`Remove ${Ue} from this series?`)&&fd(v,te)}),ne.appendChild(Be)}ne.addEventListener("click",()=>Wo(v,te)),kd(ne,E),h.appendChild(ne)});const w=document.createElement("button");w.type="button",w.className="version-nav__thumb version-nav__thumb--add",w.title="Create a new version from this map",w.addEventListener("click",()=>{try{const E=cs({versionLabel:"manual"});gt(E)}catch(E){alert((E==null?void 0:E.message)||"Unable to create a new version right now.")}});const T=document.createElement("span");T.className="version-nav__thumb-add-icon",T.textContent="+",w.appendChild(T),h.appendChild(w),t.appendChild(h);const B=Ss(e,"active"),A=u.get(B);return typeof A=="number"&&!Number.isNaN(A)&&requestAnimationFrame(()=>{h.scrollLeft=A}),h.addEventListener("scroll",()=>{u.set(B,h.scrollLeft)}),t}function ji(){var Ws,js,Js,zs,qs;if(!G)return;const e=v>=0&&y[v]?y[v]:null,t=p&&p.querySelector?p.querySelector(".version-nav__thumbs"):null;if(t&&e){const m=Ss(e,v);u.set(m,t.scrollLeft)}Dn(),Array.isArray(G.m.categories)||(G.m.categories=[]),console.log("[Blockscape] rendering categories=",G.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!G.m.abstract,"- value:",G.m.abstract?G.m.abstract.substring(0,50)+"...":"none"),p.innerHTML="",ve.clear(),Ve.clear(),x=[],Do(y[v],{versionLabel:"1"});const n=md(y[v]);n&&p.appendChild(n),I.setAttribute("width",window.innerWidth),I.setAttribute("height",window.innerHeight);const i=document.createElement("div");i.className="blockscape-model-meta";const o=document.createElement("div");o.className="blockscape-model-title",o.textContent=G.m.title&&G.m.title.trim()||qe(y[v]),i.appendChild(o),((Ws=y[v])!=null&&Ws.isSeries||(Js=(js=y[v])==null?void 0:js.apicurioVersions)!=null&&Js.length)&&It(y[v],{seriesName:y[v].title||G.m.title||qe(y[v])});const a=Es(y[v]),s=Wn(y[v]),d=(G.m.id??"").toString().trim(),f=document.createElement("div");f.className="blockscape-model-meta__details";const h=(m,D)=>{if(!D)return;const H=document.createElement("div");H.className="blockscape-model-id";const oe=document.createElement("span");oe.className="blockscape-model-id__label",oe.textContent=m;const Re=document.createElement("span");Re.className="blockscape-model-id__value",Re.textContent=D,H.append(oe,Re),f.appendChild(H)};h("Series ID",s),h("Model ID",d),h("No. in series",a),f.childElementCount&&i.appendChild(f),p.appendChild(i);const w=document.createElement("div");w.className="blockscape-tabs";const T=document.createElement("div");T.className="blockscape-tabrow";const B=document.createElement("div");B.className="blockscape-tablist",B.setAttribute("role","tablist"),T.appendChild(B);const A=document.createElement("div");A.className="blockscape-tabactions",T.appendChild(A),w.appendChild(T);const E=document.createElement("div");E.className="blockscape-tabpanels",w.appendChild(E);const te=document.createElement("div"),ne=document.createElement("div"),ot=document.createElement("div"),et=document.createElement("div");let Se="";const $e=dd(y[v]),Ue=Pn(y[v]),tt=((qs=(zs=y[v])==null?void 0:zs.apicurioVersions)==null?void 0:qs[Ue])||null,rt=Tn=!!(tt!=null&&tt.isCategoryView||((tt==null?void 0:tt.version)||"").startsWith(Bo));jt=null,un="";const Mt=(m,D)=>{!m||!D||(m.title=m.title?`${m.title}
${D}`:D)},Be=[{id:"map",label:"Map",panel:te},{id:"abstract",label:"Info",panel:ne},{id:"source",label:"Settings",panel:ot},{id:"apicurio",label:"Apicurio",panel:et}],St=typeof Je.isEnabled=="function"?Je.isEnabled():!1,$t=m=>{if(!I)return;const D=m==="map";I.hidden=!D,D?(jo(),qn()):I.innerHTML=""};Be.forEach((m,D)=>{const H=document.createElement("button");H.type="button",H.id=`tab-${m.id}`,H.className="blockscape-tab"+(D===0?" is-active":""),H.setAttribute("role","tab"),H.setAttribute("aria-controls",`panel-${m.id}`),H.setAttribute("aria-selected",D===0?"true":"false"),H.textContent=m.label,m.id==="apicurio"&&!St&&(H.hidden=!0,H.tabIndex=-1,H.setAttribute("aria-hidden","true"),H.style.display="none"),m.button=H,B.appendChild(H),m.panel.id=`panel-${m.id}`,m.panel.classList.add("blockscape-tabpanel"),m.panel.setAttribute("role","tabpanel"),m.panel.setAttribute("aria-labelledby",H.id),m.panel.hidden=D!==0,D===0&&m.panel.classList.add("is-active"),E.appendChild(m.panel)});const nn=m=>{Kt=m,Be.forEach(D=>{const H=D.id===m;D.button.classList.toggle("is-active",H),D.button.setAttribute("aria-selected",H?"true":"false"),D.panel.classList.toggle("is-active",H),D.panel.hidden=!H}),$t(m)},at=Be.find(m=>m.id==="apicurio"),Bt=m=>{if(!at||!at.button||!at.panel)return;const D=!!m;if(at.button.hidden=!D,at.button.tabIndex=D?0:-1,at.button.setAttribute("aria-hidden",D?"false":"true"),at.button.style.display=D?"":"none",D){const H=Kt==="apicurio";at.button.classList.toggle("is-active",H),at.button.setAttribute("aria-selected",H?"true":"false"),at.panel.classList.toggle("is-active",H),at.panel.hidden=!H}else{const H=at.panel.classList.contains("is-active");if(at.button.classList.remove("is-active"),at.button.setAttribute("aria-selected","false"),at.panel.classList.remove("is-active"),at.panel.hidden=!0,H){const oe=Be.find(Re=>Re.id!=="apicurio");oe&&nn(oe.id)}}g&&(g.checked=D)};Be.forEach(m=>{m.button.addEventListener("click",()=>{Dn(),nn(m.id)}),m.id==="abstract"&&(jt=m.button,m.button.addEventListener("mouseenter",()=>oo(m.button,Se,{offset:12})),m.button.addEventListener("mouseleave",Dn),m.button.addEventListener("focus",()=>oo(m.button,Se,{offset:12})),m.button.addEventListener("blur",Dn))});const wn=(m=>{const D=Be.find(oe=>oe.id===Kt);if(D&&(D.id!=="apicurio"||m))return D.id;const H=Be.find(oe=>oe.id!=="apicurio"||m);return(H==null?void 0:H.id)||Be[0].id})(St);nn(wn),Bt(St),typeof Je.onEnabledChange=="function"&&Je.onEnabledChange(Bt),p.appendChild(w);const qt=document.createElement("div");qt.className="blockscape-render",te.appendChild(qt);const on=document.createElement("div");if(on.className="blockscape-abstract-panel",G.m.abstract){console.log("[Blockscape] Rendering abstract content");const m=document.createElement("div");m.className="blockscape-abstract",m.innerHTML=G.m.abstract,Kd(m),on.appendChild(m),Se=m.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const m=document.createElement("div");m.className="blockscape-abstract-placeholder",m.textContent="No abstract has been provided for this model.",on.appendChild(m),Se=m.outerHTML}un=Se,ne.appendChild(on);const Cn=document.createElement("div");Cn.className="blockscape-source-panel";const Ke=document.createElement("div");Ke.className="blockscape-settings-panel";const an=m=>{_e.themeToggle&&(_e.themeToggle.checked=m),_e.tabThemeToggle&&(_e.tabThemeToggle.checked=m)},Kn=m=>{an(m),ma(m?li:wi)},yn=m=>{_e.tabCenterToggle&&(_e.tabCenterToggle.checked=m)},La=m=>{const D=xi(m);yn(D),Hr(D)},qo=m=>{_e.secondaryLinksToggle&&(_e.secondaryLinksToggle.checked=m),_e.tabSecondaryLinksToggle&&(_e.tabSecondaryLinksToggle.checked=m)},ro=m=>{const D=!!m;qo(D),Ft=D,$?yt($):(zo(),qn())},so=({id:m,label:D,checked:H,onChange:oe})=>{const Re=document.createElement("label");Re.className="blockscape-tab-toggle",Re.setAttribute("for",m);const Q=document.createElement("input");Q.type="checkbox",Q.id=m,Q.checked=H,typeof oe=="function"&&Q.addEventListener("change",()=>oe(Q.checked));const Ne=document.createElement("span");return Ne.className="blockscape-tab-toggle__label",Ne.textContent=D,Re.append(Q,Ne),{row:Re,input:Q}},lo=document.createElement("p");lo.className="blockscape-settings-panel__title",lo.textContent="Feature toggles",Ke.appendChild(lo);const co=document.createElement("label");co.className="settings-toggle";const k=document.createElement("input");k.type="checkbox",k.checked=Zi===li;const F=document.createElement("span");F.className="settings-toggle__text";const ae=document.createElement("span");ae.className="settings-toggle__label",ae.textContent="Dark mode";const re=document.createElement("span");re.className="settings-toggle__hint",re.textContent="Switch Blockscape UI to dark colors.",F.append(ae,re),co.append(k,F),k.addEventListener("change",()=>{Kn(k.checked)}),Ke.appendChild(co),_e.themeToggle=k;const{row:nt,input:bt}=so({id:"tabToggleTheme",label:"Dark mode",checked:Zi===li,onChange:m=>Kn(m)});A.appendChild(nt),_e.tabThemeToggle=bt;const{row:pe,input:it}=so({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:Ft,onChange:m=>ro(m)});A.appendChild(pe),_e.tabSecondaryLinksToggle=it;const{row:rn,input:Un}=so({id:"tabToggleCenterItems",label:"Center",checked:tn,onChange:m=>La(m)});A.appendChild(rn),_e.tabCenterToggle=Un;const sn=document.createElement("div");sn.className="settings-actions";const ln=document.createElement("input");ln.type="file",ln.accept="application/json",ln.hidden=!0;const uo=document.createElement("button");uo.type="button",uo.className="pf-v5-c-button pf-m-secondary",uo.textContent="Load settings",uo.addEventListener("click",()=>ln.click()),ln.addEventListener("change",async()=>{var D,H;const m=(D=ln.files)==null?void 0:D[0];if(m)try{const oe=await m.text(),Re=JSON.parse(oe),Q=(Re==null?void 0:Re.settings)||Re,dt=((H=hc(Q||{},{refreshObsidianLinks:Ko}).applied)==null?void 0:H.length)||0;Bn(dt?`Loaded ${dt} setting${dt===1?"":"s"} from ${m.name}.`:`No matching settings found in ${m.name}.`,2200)}catch(oe){console.warn("[Blockscape] failed to load settings.json",oe),Bn("Invalid settings file.",2400)}finally{ln.value=""}});const po=document.createElement("button");po.type="button",po.className="pf-v5-c-button pf-m-tertiary",po.textContent="Download settings",po.addEventListener("click",()=>{const m={version:1,exportedAt:new Date().toISOString(),settings:gl(es(),{localBackend:ze})};Ur("settings.json",JSON.stringify(m,null,2)),Bn("Settings downloaded.",2e3)}),sn.append(uo,po,ln),Ke.appendChild(sn);const Go=document.createElement("div");Go.className="color-presets";const Na=document.createElement("div");Na.className="settings-text__label",Na.textContent="Color presets";const Ma=document.createElement("div");Ma.className="settings-text__hint",Ma.textContent="Shown in tile context menu for quick coloring.",Go.append(Na,Ma);const fo=document.createElement("div");fo.className="color-presets__list";const $a=document.createElement("div");$a.className="color-presets__add";const qi=document.createElement("input");qi.type="text",qi.placeholder="Name",qi.className="settings-text__input";const mo=document.createElement("input");mo.type="color",mo.value="#2563eb",mo.className="settings-color-input";const ho=document.createElement("button");ho.type="button",ho.className="pf-v5-c-button pf-m-primary",ho.textContent="Add preset",ho.addEventListener("click",()=>{const m=qi.value.trim()||"Custom",D=mo.value,H=[...Ut,{name:m,value:D}];Ai(H),Hi(Ut),qi.value=""}),$a.append(qi,mo,ho),Go.append(fo,$a),Ke.appendChild(Go),_e.colorPresetList=fo,Ci=()=>{fo.innerHTML="",Ut.forEach((m,D)=>{const H=document.createElement("div");H.className="color-presets__row";const oe=document.createElement("input");oe.type="text",oe.className="settings-text__input",oe.value=m.name||"",oe.placeholder="Name",oe.addEventListener("input",()=>{const Ne=[...Ut];Ne[D]={...Ne[D],name:oe.value},Ai(Ne),Hi(Ut)});const Re=document.createElement("input");Re.type="color",Re.className="settings-color-input",Re.value=m.value,Re.addEventListener("input",()=>{const Ne=[...Ut];Ne[D]={...Ne[D],value:Re.value},Ai(Ne),Hi(Ut)});const Q=document.createElement("button");Q.type="button",Q.className="pf-v5-c-button pf-m-plain",Q.textContent="✕",Q.title="Remove preset",Q.addEventListener("click",()=>{const Ne=Ut.filter((dt,We)=>We!==D);Ai(Ne),Hi(Ut),Ci()}),H.append(oe,Re,Q),fo.appendChild(H)})},Ci();const Yn=({id:m,label:D,hint:H,checked:oe,className:Re="",onChange:Q})=>{const Ne=document.createElement("label");Ne.className=["settings-toggle",Re].filter(Boolean).join(" ");const dt=document.createElement("input");dt.type="checkbox",dt.id=m,dt.checked=oe;const We=document.createElement("span");We.className="settings-toggle__text";const vt=document.createElement("span");if(vt.className="settings-toggle__label",vt.textContent=D,We.appendChild(vt),H){const Gt=document.createElement("span");Gt.className="settings-toggle__hint",Gt.textContent=H,We.appendChild(Gt)}return Ne.appendChild(dt),Ne.appendChild(We),typeof Q=="function"&&dt.addEventListener("change",()=>Q(dt.checked)),{row:Ne,input:dt}},Ko=()=>{p.querySelectorAll(".tile").forEach(m=>{const D=m.dataset.id,H=wa(D);if(!(H!=null&&H.item))return;const oe=xs(H.item.external),Re=Cs(H.item,{externalMeta:oe,seriesIdLookup:$e});As(m,Re)})},{row:Qd,input:eu}=Yn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:Ft,className:"map-controls__toggle",onChange:m=>ro(m)});Ke.appendChild(Qd),_e.secondaryLinksToggle=eu;const{row:tu,input:nu}=Yn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:Ot,className:"map-controls__toggle",onChange:m=>{Ot=m,Aa()}});Ke.appendChild(tu),_e.reusedToggle=nu;const{row:iu,input:ou}=Yn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:ci,className:"map-controls__toggle",onChange:m=>{const D=Oi(m);Kr(D)}});Ke.appendChild(iu),_e.autoIdToggle=ou;const Ba=[],{row:au,input:ru}=Yn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:ki,className:"map-controls__toggle",onChange:m=>{const D=Di(m);is(D),Ba.forEach(H=>{H.disabled=!D}),Ko()}});if(Ke.appendChild(au),_e.obsidianToggle=ru,typeof(ze==null?void 0:ze.isAvailable)=="function"&&ze.isAvailable()&&typeof(ze==null?void 0:ze.getAutoReloadConfig)=="function"){const{enabled:m,intervalMs:D}=ze.getAutoReloadConfig();let H=null;const{row:oe,input:Re}=Yn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:m,className:"map-controls__toggle",onChange:xn=>{ze.setAutoReloadEnabled(xn),H&&(H.disabled=!xn)}});Ke.appendChild(oe),_e.autoReloadToggle=Re;const Q=xn=>`${(xn/1e3).toFixed(2)}s`,Ne=document.createElement("label");Ne.className="settings-slider",Ne.setAttribute("for","autoReloadInterval");const dt=document.createElement("div");dt.className="settings-slider__text";const We=document.createElement("span");We.className="settings-slider__label",We.textContent="Auto-reload interval";const vt=document.createElement("span");vt.className="settings-slider__hint",vt.textContent="Adjust how often to poll for file changes.",dt.append(We,vt);const Gt=document.createElement("span");Gt.className="settings-slider__value",Gt.textContent=Q(D),H=document.createElement("input"),H.type="range",H.id="autoReloadInterval",H.className="settings-slider__input",H.min=String(Lr),H.max=String(Nr),H.step="100",H.value=String(D),H.disabled=!m,H.setAttribute("aria-label","Set auto-reload polling interval"),H.addEventListener("input",()=>{const xn=ze.setAutoReloadInterval(parseInt(H.value,10));Gt.textContent=Q(xn)}),Ne.append(dt,Gt,H),Ke.appendChild(Ne),_e.autoReloadInput=H,_e.autoReloadValue=Gt}const Ra=document.createElement("div");Ra.className="settings-radio";const Oa=document.createElement("div");Oa.className="settings-radio__label",Oa.textContent="Obsidian link format";const Pa=document.createElement("div");Pa.className="settings-radio__hint",Pa.textContent="Use the tile title or id when building Obsidian links.";const Va=document.createElement("div");Va.className="settings-radio__options";const Os=(m,D)=>{const H=document.createElement("label");H.className="settings-radio__option";const oe=document.createElement("input");oe.type="radio",oe.name="obsidianLinkMode",oe.value=m,oe.checked=Xi===m,oe.disabled=!ki,oe.addEventListener("change",()=>{if(!oe.checked)return;const Q=Vi(m);ns(Q),Ko()});const Re=document.createElement("span");Re.textContent=D,H.append(oe,Re),Ba.push(oe),Va.appendChild(H)};Os(pa,"Use title"),Os(Lo,"Use id"),Ra.append(Oa,Va,Pa),Ke.appendChild(Ra),_e.obsidianModeInputs=Ba;const Yo=document.createElement("label");Yo.className="settings-text",Yo.setAttribute("for","obsidianVaultInput");const Da=document.createElement("div");Da.className="settings-text__text";const Ua=document.createElement("span");Ua.className="settings-text__label",Ua.textContent="Obsidian vault";const Ha=document.createElement("span");Ha.className="settings-text__hint",Ha.textContent="Optional. Set the vault name to avoid duplicates.",Da.append(Ua,Ha);const Hn=document.createElement("input");Hn.type="text",Hn.id="obsidianVaultInput",Hn.className="settings-text__input",Hn.placeholder="Vault name",Hn.value=_i,Hn.addEventListener("input",()=>{const m=Ui(Hn.value);os(m),Ko()}),Yo.append(Da,Hn),Ke.appendChild(Yo),_e.obsidianVaultInput=Hn;const Fa=document.createElement("p");Fa.className="settings-note",Fa.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',Ke.appendChild(Fa);const Ps=m=>`${(m/1e3).toFixed(1)}s`,Xo=document.createElement("label");Xo.className="settings-slider",Xo.setAttribute("for","seriesNavDoubleClickWait");const Wa=document.createElement("div");Wa.className="settings-slider__text";const ja=document.createElement("span");ja.className="settings-slider__label",ja.textContent="Series double-click wait";const Ja=document.createElement("span");Ja.className="settings-slider__hint",Ja.textContent="Time window to double-click into another map version.",Wa.append(ja,Ja);const go=document.createElement("span");go.className="settings-slider__value",go.textContent=Ps($n);const fn=document.createElement("input");fn.type="range",fn.id="seriesNavDoubleClickWait",fn.className="settings-slider__input",fn.min=String(Pr),fn.max=String(Vr),fn.step="50",fn.value=String($n),fn.setAttribute("aria-label","Adjust double-click wait for series navigation"),fn.addEventListener("input",()=>{const m=Pi(parseInt(fn.value,10));go.textContent=Ps(m),ts(m)}),Xo.append(Wa,go,fn),Ke.appendChild(Xo),_e.seriesNavInput=fn,_e.seriesNavValue=go;const Vs=m=>`${Math.round((m-1)*100)}%`,Zo=document.createElement("label");Zo.className="settings-slider",Zo.setAttribute("for","hoverScaleSlider");const za=document.createElement("div");za.className="settings-slider__text";const qa=document.createElement("span");qa.className="settings-slider__label",qa.textContent="Hover zoom";const Ga=document.createElement("span");Ga.className="settings-slider__hint",Ga.textContent="Expand tiles on hover to see more detail.",za.append(qa,Ga);const bo=document.createElement("span");bo.className="settings-slider__value",bo.textContent=Vs(yi);const mn=document.createElement("input");mn.type="range",mn.id="hoverScaleSlider",mn.className="settings-slider__input",mn.min=String(fe),mn.max=String(Ee),mn.step="0.1",mn.value=String(yi),mn.setAttribute("aria-label","Adjust hover zoom"),mn.addEventListener("input",()=>{const m=Ti(parseFloat(mn.value));bo.textContent=Vs(m),zr(m),$&&Wi()}),Zo.append(za,bo,mn),Ke.appendChild(Zo),_e.hoverScaleInput=mn,_e.hoverScaleValue=bo;let Rt=null,Xn=null;const Ka=m=>{const D=Math.round((1-m)*100);return D===0?"Off":`${D}% dim`},{row:su,input:lu}=Yn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Mn,className:"map-controls__toggle",onChange:m=>{const D=Ri(m);Gr(D),Rt&&(Rt.disabled=!D),Xn&&(Xn.textContent=Ka(D?Nn:1))}});Ke.appendChild(su),_e.selectionDimToggle=lu;const Qo=document.createElement("label");Qo.className="settings-slider",Qo.setAttribute("for","selectionDimmingSlider");const Ya=document.createElement("div");Ya.className="settings-slider__text";const Xa=document.createElement("span");Xa.className="settings-slider__label",Xa.textContent="Dimming strength";const Za=document.createElement("span");Za.className="settings-slider__hint",Za.textContent="Adjust how much unrelated tiles fade when dimming is on.",Ya.append(Xa,Za),Xn=document.createElement("span"),Xn.className="settings-slider__value",Xn.textContent=Ka(Mn?Nn:1),Rt=document.createElement("input"),Rt.type="range",Rt.id="selectionDimmingSlider",Rt.className="settings-slider__input",Rt.min=String(Zt),Rt.max=String(Qt),Rt.step="0.05",Rt.value=String(Nn),Rt.disabled=!Mn,Rt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Rt.addEventListener("input",()=>{const m=Li(parseFloat(Rt.value));Xn.textContent=Ka(m),qr(m)}),Qo.append(Ya,Xn,Rt),Ke.appendChild(Qo),_e.selectionDimInput=Rt,_e.selectionDimValue=Xn;const Ds=m=>m===1?"Default":`${Math.round(m*100)}%`,ea=document.createElement("label");ea.className="settings-slider",ea.setAttribute("for","tileCompactnessSlider");const Qa=document.createElement("div");Qa.className="settings-slider__text";const er=document.createElement("span");er.className="settings-slider__label",er.textContent="Tile compactness";const tr=document.createElement("span");tr.className="settings-slider__hint",tr.textContent="Adjust padding, gap, and logo size for tiles.",Qa.append(er,tr);const vo=document.createElement("span");vo.className="settings-slider__value",vo.textContent=Ds(Ei);const hn=document.createElement("input");hn.type="range",hn.id="tileCompactnessSlider",hn.className="settings-slider__input",hn.min=String(Ir),hn.max=String(kr),hn.step="0.05",hn.value=String(Ei),hn.setAttribute("aria-label","Adjust tile compactness"),hn.addEventListener("input",()=>{const m=Ni(parseFloat(hn.value));vo.textContent=Ds(m),Yr(m),$&&Wi()}),ea.append(Qa,vo,hn),Ke.appendChild(ea),_e.tileCompactnessInput=hn,_e.tileCompactnessValue=vo;const{row:cu,input:du}=Yn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:fa!=="nowrap",className:"map-controls__toggle",onChange:m=>{const D=m?"wrap":"nowrap";Bi(D),Qr(D)}});Ke.appendChild(cu),_e.titleWrapInput=du;const Us=m=>`${Math.round((m-1)*100)}% extra`,ta=document.createElement("label");ta.className="settings-slider",ta.setAttribute("for","titleHoverWidthSlider");const nr=document.createElement("div");nr.className="settings-slider__text";const ir=document.createElement("span");ir.className="settings-slider__label",ir.textContent="Title width on hover";const or=document.createElement("span");or.className="settings-slider__hint",or.textContent="Give titles more room horizontally when zoomed.",nr.append(ir,or);const wo=document.createElement("span");wo.className="settings-slider__value",wo.textContent=Us(Si);const gn=document.createElement("input");gn.type="range",gn.id="titleHoverWidthSlider",gn.className="settings-slider__input",gn.min=String(Tt),gn.max=String(Lt),gn.step="0.05",gn.value=String(Si),gn.setAttribute("aria-label","Adjust title width boost on hover"),gn.addEventListener("input",()=>{const m=Mi(parseFloat(gn.value));wo.textContent=Us(m),Xr(m)}),ta.append(nr,wo,gn),Ke.appendChild(ta),_e.titleWidthInput=gn,_e.titleWidthValue=wo;const Hs=m=>`${Math.round(m*100)}% of hover zoom`,na=document.createElement("label");na.className="settings-slider",na.setAttribute("for","titleZoomPortionSlider");const ar=document.createElement("div");ar.className="settings-slider__text";const rr=document.createElement("span");rr.className="settings-slider__label",rr.textContent="Title zoom influence";const sr=document.createElement("span");sr.className="settings-slider__hint",sr.textContent="How much the title scales relative to tile hover zoom.",ar.append(rr,sr);const yo=document.createElement("span");yo.className="settings-slider__value",yo.textContent=Hs(Ii);const bn=document.createElement("input");bn.type="range",bn.id="titleZoomPortionSlider",bn.className="settings-slider__input",bn.min=String(pn),bn.max=String(ri),bn.step="0.05",bn.value=String(Ii),bn.setAttribute("aria-label","Adjust how much titles scale on hover"),bn.addEventListener("input",()=>{const m=$i(parseFloat(bn.value));yo.textContent=Hs(m),Zr(m)}),na.append(ar,yo,bn),Ke.appendChild(na),_e.titleZoomInput=bn,_e.titleZoomValue=yo;const uu=typeof Je.isEnabled=="function"?Je.isEnabled():!1,{row:pu,input:fu}=Yn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:uu,className:"apicurio-toggle",onChange:m=>{typeof Je.setEnabled=="function"&&Je.setEnabled(m)}});if(g=fu,Ke.appendChild(pu),Cn.appendChild(Ke),c)c.hidden=!1,c.classList.remove("pf-v5-c-page__main-section"),Cn.appendChild(c);else{const m=document.createElement("p");m.className="muted",m.textContent="Source editor unavailable.",Cn.appendChild(m)}ot.appendChild(Cn),Je.mount(et);let Fs=0;if(G.m.categories.forEach(m=>{const D=document.createElement("section");D.className="category",D.dataset.cat=m.id;const H=rt?ud(m,$e):null,oe=document.createElement("div");oe.className="cat-head",oe.dataset.cat=m.id,oe.tabIndex=0,rt&&Number.isInteger(H)?(oe.dataset.seriesVersionIndex=String(H),oe.title="Open this category's map in the series",oe.classList.add("cat-head--series-link")):oe.title="Select category",oe.innerHTML=`<div class="cat-title">${io(m.title||m.id)}</div>
                          <div class="muted cat-count">${(m.items||[]).length} items</div>`,oe.addEventListener("click",()=>{var vt;const Q=oe.dataset.seriesVersionIndex!=null?parseInt(oe.dataset.seriesVersionIndex,10):null,Ne=y[v],dt=Ne?Pn(Ne):-1;rt&&((vt=Ne==null?void 0:Ne.apicurioVersions)==null?void 0:vt.length)>1&&Number.isInteger(Q)&&Q!==dt&&Wo(v,Q)||Vn(m.id)}),oe.addEventListener("keydown",Q=>{(Q.key==="Enter"||Q.key===" ")&&(Q.preventDefault(),oe.click())}),oe.addEventListener("focus",()=>Vn(m.id,{scrollIntoView:!1})),D.appendChild(oe);const Re=document.createElement("div");if(Re.className="grid"+(tn?" is-centered":""),D.appendChild(Re),(m.items||[]).forEach(Q=>{Fs+=1;const Ne=xs(Q.external),dt=Cs(Q,{externalMeta:Ne,seriesIdLookup:$e}),We=document.createElement("div");if(We.className=Ne.isExternal?"tile external":"tile",We.tabIndex=0,We.dataset.id=Q.id,We.dataset.globalIndex=String(Fs),Ne.url&&(We.dataset.externalUrl=Ne.url),!rt){let En=null;if($e.has(Q.id)&&(En=$e.get(Q.id)),Number.isInteger(En)){We.dataset.seriesVersionIndex=String(En),We.classList.add("tile--series-link");const mu=En===Ue?"Current map in this series":`Open version ${En+1} in this series`;Mt(We,mu)}}if(dt&&(We.dataset.obsidianUrl=dt),!rt){const En=va(Q.id);En!==-1&&En!==v&&(We.classList.add("tile--series-link"),We.dataset.navTargetIndex=String(En))}const vt=document.createElement("img");vt.className="logo",Q.logo?(vt.src=Q.logo,vt.alt=Q.name||Q.id):(vt.alt="",vt.style.opacity=1,vt.src=cd(Q.name||Q.id,Q.color));const Gt=document.createElement("div");Gt.className="name",Gt.textContent=Q.name||Q.id;const xn=document.createElement("div");xn.className="tile-id",xn.textContent=Q.id||"";const lr=document.createElement("div");lr.className="badge",lr.textContent="reused";let Zn=null;rt||(Zn=document.createElement("button"),Zn.type="button",Zn.className="tile-delete",Zn.setAttribute("aria-label",`Delete ${Q.name||Q.id}`),Zn.textContent="×",Zn.addEventListener("click",En=>{En.stopPropagation(),Jd(Q.id)})),Ne.url&&We.appendChild(Ed(Ne.url)),As(We,dt),Zn&&We.appendChild(Zn),We.appendChild(vt),We.appendChild(Gt),We.appendChild(xn),We.appendChild(lr),Re.appendChild(We),ve.set(Q.id,{el:We,catId:m.id,rect:null})}),qt.appendChild(D),Ve.set(m.id,{el:D,headEl:oe}),!rt){const Q=document.createElement("button");Q.type="button",Q.className="tile-add",Q.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',Q.hidden=tn,Q.tabIndex=tn?-1:0,Q.setAttribute("aria-hidden",tn?"true":"false"),Q.addEventListener("click",()=>$d(m.id)),Re.appendChild(Q)}}),!rt){const m=document.createElement("button");m.type="button",m.className="category-add",m.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',m.addEventListener("click",()=>Ns()),qt.appendChild(m)}Aa(),hd(),jo(),qn(),Ji(),_d()}function hd(){p.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var A;if(typeof n.button=="number"&&n.button!==0)return;zn();const i=e.dataset.id,o=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,d=y[v],f=d?Pn(d):-1,h=((A=d==null?void 0:d.apicurioVersions)==null?void 0:A.length)>1&&Number.isInteger(o)&&o!==f,w=Number.isInteger(s)&&s!==v&&s>=0&&s<y.length,T=Yt&&Yt.id===i&&Yt.targetVersionIndex===o,B=Ct&&Ct.id===i&&Ct.targetIndex===s;if(Yt&&!T&&Fi(),Ct&&!B&&Ia(),h)if(T){if(Fi(),Wo(v,o))return}else Jc(i,o,d);else if(w){if(B){Ia(),gt(s);return}zc(i,s)}else Number.isInteger(a)&&a>0&&a%5===0&&Bn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",i),$===i&&!(h&&T)&&!(w&&B)){zi();return}yt(i)}),e.addEventListener("dblclick",n=>{n.preventDefault();const i=e.dataset.id,o=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):va(i);o!==-1&&o!==v&&gt(o)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{$&&Wi()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t),e.draggable=!0,e.addEventListener("dragstart",xd),e.addEventListener("dragend",Ad)}),p.querySelectorAll(".grid").forEach(e=>{e.addEventListener("dragover",Td),e.addEventListener("drop",Md),e.addEventListener("dragenter",Ld),e.addEventListener("dragleave",Nd)}),ps||(ps=!0,window.addEventListener("resize",Wi),window.addEventListener("scroll",Wi,{passive:!0}),window.addEventListener("resize",Ts),document.addEventListener("click",e=>{var a,s,d;if(!$&&!xe||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),i=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),o=(d=t==null?void 0:t.closest)==null?void 0:d.call(t,".tile-context-menu");n||i||o||zi()})),document.getElementById("clear").onclick=()=>zi()}function jo(){ve.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function ks(e,{includeSecondary:t=Ft}={}){if(!e||!G)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(G.fwd.get(e)||[]),i=new Set(G.rev.get(e)||[]),o=new Set,a=new Set,s=[],d=new Set,f=(h,w,T,B)=>{if(!h||!w)return;const A=`${h}->${w}:${T}:${B}`;d.has(A)||(d.add(A),s.push({from:h,to:w,type:T,depth:B}))};return n.forEach(h=>f(e,h,"dep",1)),i.forEach(h=>f(e,h,"revdep",1)),t&&new Set([...n,...i]).forEach(w=>{(G.fwd.get(w)||new Set).forEach(A=>{const E=A===e;E||o.add(A),E||f(w,A,"dep",2)}),(G.rev.get(w)||new Set).forEach(A=>{const E=A===e;E||a.add(A),E||f(w,A,"revdep",2)})}),{deps:n,revs:i,secondaryDeps:o,secondaryRevs:a,edges:s}}function Jo(e,t){const n=ve.get(e);n&&n.el.classList.add(t)}function yt(e){var d,f,h;if(!e)return;xe=null,$=e,Ze=null,ht=ks(e),Ht(),zo(),Ji();const{deps:t,revs:n,secondaryDeps:i,secondaryRevs:o}=ht;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=ve.get(e);a&&a.el.classList.add("selected"),t.forEach(w=>Jo(w,"dep")),n.forEach(w=>Jo(w,"revdep")),i.forEach(w=>{!t.has(w)&&w!==e&&Jo(w,"dep-indirect")}),o.forEach(w=>{!n.has(w)&&!t.has(w)&&w!==e&&Jo(w,"revdep-indirect")}),qn();const s=(h=(f=(d=ve.get(e))==null?void 0:d.el)==null?void 0:f.dataset)==null?void 0:h.externalUrl;s&&Bn("This item has link to",ai,s),ha()}function Vn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,d;if(!((s=G==null?void 0:G.m)!=null&&s.categories)||!e)return!1;const o=(G.m.categories||[]).find(f=>f.id===e);if(!o)return!1;zn(),xa(),n||(Ze=null),xe=o.id,Ht(),Ji();const a=Ve.get(o.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(d=a.headEl)==null||d.focus({preventScroll:!0})),!0}function Ji(){if(Ve.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!xe)return;const e=Ve.get(xe);if(!(e!=null&&e.el)){xe=null,Ze=null,Ht();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function no(){if(xe)return xe;const e=$?ve.get($):null;return e!=null&&e.catId?e.catId:null}function gd(e){var a,s,d,f;if(!((s=(a=G==null?void 0:G.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=G.m.categories,n=no();let i=t.findIndex(h=>h.id===n);if(i===-1){const h=((d=t.find(w=>(w.items||[]).length))==null?void 0:d.id)||((f=t[0])==null?void 0:f.id);return h?Vn(h):!1}const o=i+e;return o<0||o>=t.length?!1:Vn(t[o].id)}function xa(){$=null,ht=null,zo(),qn(),ha({itemId:null})}function bd(){xe=null,Ze=null,Ji()}function zi(){xa(),bd(),Ze=null,Ht()}function zo(){p.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function Aa(){G!=null&&G.reusedLocal&&G.reusedLocal.forEach(e=>{const t=ve.get(e);if(!t)return;t.el.classList.toggle("reused",Ot);const n=t.el.querySelector(".badge");n&&(n.style.display=Ot?"inline-block":"none")})}function qn(){for(;I.firstChild;)I.removeChild(I.firstChild);if(!$||I.hidden)return;ht=ks($),ht.edges.forEach(t=>{var T,B;const n=(T=ve.get(t.from))==null?void 0:T.rect,i=(B=ve.get(t.to))==null?void 0:B.rect;if(!n||!i)return;const o=_s(n),a=_s(i),s=document.createElementNS("http://www.w3.org/2000/svg","path"),d=(o.x+a.x)/2,f=o.y,h=(o.x+a.x)/2,w=a.y;s.setAttribute("d",`M ${o.x},${o.y} C ${d},${f} ${h},${w} ${a.x},${a.y}`),s.setAttribute("fill","none"),s.setAttribute("stroke",t.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),s.setAttribute("stroke-opacity",t.depth===1?"0.45":"0.22"),s.setAttribute("stroke-width",t.depth===1?"2":"1.5"),t.depth>1&&s.setAttribute("stroke-dasharray","4 3"),s.setAttribute("vector-effect","non-scaling-stroke"),I.appendChild(s)})}function _s(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function io(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function vd(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,i=new URLSearchParams;return i.set("filepath",n),i.set("data"," "),i.set("mode","append"),_i&&i.set("vault",_i),`obsidian://advanced-uri?${i.toString()}`}function wd(e){return e?Xi===Lo?e.id??e.name??"":e.name??e.id??"":""}function Cs(e,{externalMeta:t,seriesIdLookup:n}={}){var o;if(!ki||!e||(o=n==null?void 0:n.has)!=null&&o.call(n,e.id))return"";const i=wd(e);return vd(i)}function xs(e){if(typeof e=="string"){const t=e.trim();if(!t)return{isExternal:!1,url:""};try{const n=new URL(t);return/^https?:/i.test(n.protocol)?{isExternal:!0,url:n.toString()}:{isExternal:!1,url:""}}catch(n){return console.warn("[Blockscape] invalid external url skipped",e,n),{isExternal:!1,url:""}}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function yd(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Ed(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function As(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(yd(t))}function Ts(){S||(S=requestAnimationFrame(()=>{S=null,x=x.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),x.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const i=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${i}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function Sd(e,t){!e||!t||(x.push({labelEl:e,textEl:t}),Ts())}function Id(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${io(t)}</div>`],i=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();i&&n.push(`<div class="version-nav__tooltip-meta">Version ${io(i)}</div>`);const o=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return o?n.push(`<div class="version-nav__tooltip-body">${o}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function oo(e,t,{offset:n=8}={}){!N||!e||!t||(N.innerHTML=t,N.hidden=!1,N.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const i=e.getBoundingClientRect(),o=N.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let d=i.left+i.width/2-o.width/2+a,f=i.top-o.height-n+s;d<a+n&&(d=a+n);const h=a+window.innerWidth-o.width-n;d>h&&(d=h),f<s+n&&(f=i.bottom+n+s),N.style.left=`${d}px`,N.style.top=`${f}px`,N.classList.add("is-visible")}))}function Dn(){Jn&&(clearTimeout(Jn),Jn=null),N&&(N.classList.remove("is-visible"),N.setAttribute("aria-hidden","true"),N.hidden=!0)}function kd(e,t){if(!e)return;const n=qe((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const i=Id(t,n);let o=null;const a=()=>{o&&(clearTimeout(o),o=null)},s=()=>{L=e,oo(e,`<div class="version-nav__tooltip-title">${io(n)}</div>`,{offset:10})},d=()=>{a(),o=setTimeout(()=>{L===e&&oo(e,i,{offset:10})},ee)},f=()=>{s(),d()},h=()=>{L!==e&&s(),d()},w=()=>{a(),L===e&&(L=null,Dn())};e.addEventListener("mouseenter",f),e.addEventListener("focus",f),e.addEventListener("pointermove",h),e.addEventListener("mouseleave",w),e.addEventListener("blur",w),e.addEventListener("click",w)}function _d(){Sn&&(Sn=!1,!(!jt||!un)&&(Dn(),oo(jt,un,{offset:12}),Jn=setTimeout(()=>{Dn(),Cd()},1e3)))}function Cd(){jt&&(Dt&&(clearTimeout(Dt),Dt=null),jt.classList.add("blockscape-tab--twinkle"),Dt=setTimeout(()=>{jt.classList.remove("blockscape-tab--twinkle"),Dt=null},1400))}window.addEventListener("scroll",Dn,!0),window.addEventListener("resize",Dn),M&&M.addEventListener("click",()=>{Kc()}),Ie&&Ie.addEventListener("click",()=>{Yc()}),Me&&Me.addEventListener("click",()=>{try{Wc(),Vc()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),Ce&&Ce.addEventListener("click",ka),be&&be.addEventListener("click",ka),O&&O.addEventListener("click",Ho),Y&&Y.addEventListener("click",Ho),p&&p.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");Tn||!t||!p.contains(t)||Mc(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||$c(e)}),Ye&&Ye.addEventListener("click",()=>{ds("button")}),Ge&&Ge.addEventListener("click",()=>{if(v<0){alert("Load or select a model before creating a version.");return}try{const e=cs({versionLabel:"map edit"});gt(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),je&&je.addEventListener("click",async()=>{var a;if(v<0||!y[v]){alert("Select or load a model before sharing.");return}const e={title:qe(y[v],"Shared Model"),data:y[v].data};let t;try{t=Rl(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const i=n.toString();try{window.history.replaceState({},document.title,i)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let o=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(i),o=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}o?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",i)}),Te&&Te.addEventListener("click",()=>{const e=(r.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};$&&(n.selectedItemId=$),localStorage.setItem(lt,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";$&&(t=`editor.html?selected=${encodeURIComponent($)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==lt||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||ys("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===kt&&ys("message")})),document.addEventListener("keydown",e=>{var i,o,a,s,d,f,h,w,T,B;if(Gc()){e.key==="Escape"&&(e.preventDefault(),ka());return}if(!(ge!=null&&ge.hidden)&&e.key==="Escape"){e.preventDefault(),Ho();return}if((i=fi==null?void 0:fi.isOpen)==null?void 0:i.call(fi))return;const n=Tn;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const A=y[v],E=((o=A==null?void 0:A.apicurioVersions)==null?void 0:o.length)>1;ds("shortcut",E);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!mi())return;if(Hd()){e.preventDefault();return}}if(e.key==="Escape"){let A=!1;ie&&!ie.hidden&&(zn(),A=!0),($||xe)&&(zi(),A=!0),A&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!mi())return;const A=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if((e.ctrlKey||e.metaKey)&&!e.shiftKey){Ca(A)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(xe&&!e.shiftKey){e.preventDefault();return}e.shiftKey?Rd(A)&&e.preventDefault():Od(A)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!mi())return;const A=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){Ud(A)&&e.preventDefault();return}if(e.altKey)return;if(xe&&!$&&!e.shiftKey){if(Vd(A)){e.preventDefault();return}if(gd(A)){e.preventDefault();return}}e.shiftKey?Dd(A)&&e.preventDefault():Pd(A)&&e.preventDefault()}if(e.key==="Delete"){if(n||!mi()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const A=xe?jd():!1,E=A?!0:Ms();(A||E)&&e.preventDefault()}if(e.key==="F2"){if(n||!mi())return;const A=xe&&!$&&xe||!$&&((f=(d=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:d.dataset)==null?void 0:f.cat)||null;if(A&&!$&&Bd(A)){e.preventDefault();return}const E=$||((B=(T=(w=(h=e.target)==null?void 0:h.closest)==null?void 0:w.call(h,".tile"))==null?void 0:T.dataset)==null?void 0:B.id);E&&fi.open(E)&&e.preventDefault()}if(e.key==="Insert"){if(n||!mi()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Ns()&&e.preventDefault()}}),window.addEventListener("resize",()=>{Bc()}),window.addEventListener("scroll",()=>Rc(),!0);let Gn=null,ao=null;function xd(e){if(Tn){e.preventDefault();return}zn(),Gn=e.target.dataset.id,ao=e.target.closest(".category").dataset.cat,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({itemId:Gn,categoryId:ao})),e.target.closest(".category").querySelector(".grid").classList.add("drag-active"),console.log("[Blockscape] drag start",Gn,"from",ao)}function Ad(e){e.target.classList.remove("dragging"),p.querySelectorAll(".grid").forEach(t=>t.classList.remove("drag-active")),p.querySelectorAll(".tile").forEach(t=>t.classList.remove("drag-over")),Gn=null,ao=null}function Td(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function Ld(e){e.preventDefault();const t=e.target.closest(".grid");t&&t.classList.add("drag-active")}function Nd(e){const t=e.target.closest(".grid");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-active")}function Md(e){e.preventDefault();const t=e.target.closest(".grid");if(!t)return;const n=t.closest(".category");if(!n)return;const i=n.dataset.cat;if(!Gn||!i)return;const a=Array.from(t.querySelectorAll(".tile")).filter(s=>s.dataset.id!==Gn).find(s=>{const d=s.getBoundingClientRect();return e.clientY<d.top+d.height/2});Ls(Gn,a?a.dataset.id:null,i),ji(),console.log("[Blockscape] drop completed",Gn,"from",ao,"to",i)}function Ls(e,t,n){if(v<0)return;const o=y[v].data.categories||[],a=o.find(w=>(w.items||[]).some(T=>T.id===e)),s=o.find(w=>w.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const d=a.items.findIndex(w=>w.id===e);if(d===-1)return;const[f]=a.items.splice(d,1);let h=s.items.length;if(t){const w=s.items.findIndex(T=>T.id===t);w!==-1&&(h=w)}s.items.splice(h,0,f),Nt(),Et()}function $d(e){if(v<0||!e)return;const t=y[v].data,i=(t.categories||[]).find(f=>f.id===e);if(!i)return;i.items=i.items||[];const o=`New item ${i.items.length+1}`,s={id:Ac(`${e}-${i.items.length+1}`,t),name:o,deps:[]};i.items.push(s),Nt(),Et(),zn(),yt(s.id);const d=ve.get(s.id);d!=null&&d.el&&d.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Ns(){if(v<0)return!1;const e=y[v].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=Tc(t,e),i={id:n,title:t,items:[]};return e.categories.push(i),xe=n,$=null,ht=null,Ze=null,Nt(),Et(),Vn(n),console.log("[Blockscape] added category",n),!0}function Bd(e=no()){if(v<0||!e)return!1;const t=Nc.open(e);return t&&($=null,ht=null,Ht()),t}function Rd(e){if(!$||v<0||!e)return!1;const n=y[v].data.categories||[],i=ve.get($);let o=null;if(i!=null&&i.catId&&(o=n.find(f=>f.id===i.catId)),o||(o=n.find(f=>(f.items||[]).some(h=>h.id===$))),!o)return!1;o.items=o.items||[];const a=o.items.findIndex(f=>f.id===$);if(a===-1)return!1;const s=a+e;if(s<0||s>=o.items.length)return!1;const[d]=o.items.splice(a,1);return o.items.splice(s,0,d),Nt(),Et(),ji(),yt($),!0}function Od(e){if(!G||!G.m||!e)return!1;const t=G.m.categories||[];if(!t.length)return!1;const n=()=>{const f=t.find(h=>(h.items||[]).length);return f?{category:f,item:f.items[0]}:null};if(!$){const f=n();return f?(yt(f.item.id),!0):!1}const i=ve.get($);let o=null;if(i!=null&&i.catId&&(o=t.find(f=>f.id===i.catId)),o||(o=t.find(f=>(f.items||[]).some(h=>h.id===$))),!o){const f=n();return f?(yt(f.item.id),!0):!1}const a=o.items||[];if(!a.length)return!1;const s=a.findIndex(f=>f.id===$);if(s===-1)return!1;const d=s+e;return d<0||d>=a.length?!1:(yt(a[d].id),!0)}function Pd(e){if(!G||!G.m||!e)return!1;const t=G.m.categories||[];if(!t.length)return!1;const n=no();let i=t.findIndex(s=>s.id===n),o=i+e;if(i===-1&&(o=e>0?0:t.length-1),o<0||o>=t.length)return!1;const a=t[o];if($){const d=(t[i].items||[]).findIndex(f=>f.id===$);Ze={catId:a.id,position:d===-1?0:d}}else Ze=null;return Vn(a.id,{preserveEntryHint:!0})}function Vd(e){var a;if(!xe||!((a=G==null?void 0:G.m)!=null&&a.categories)||!e)return!1;const n=(G.m.categories||[]).find(s=>s.id===xe);if(!n)return!1;const i=n.items||[];if(!i.length)return!1;let o=e>0?0:Math.max(0,i.length-1);return(Ze==null?void 0:Ze.catId)===n.id&&(o=Math.min(i.length-1,Math.max(0,Ze.position||0))),Ze=null,yt(i[o].id),!0}function Dd(e){if(!$||v<0||!e)return!1;const n=y[v].data.categories||[];if(!n.length)return!1;const i=ve.get($);let o=-1;if(i!=null&&i.catId&&(o=n.findIndex(T=>T.id===i.catId)),o===-1&&(o=n.findIndex(T=>(T.items||[]).some(B=>B.id===$))),o===-1)return!1;const a=o+e;if(a<0||a>=n.length)return!1;const s=n[o],d=n[a];if(!d)return!1;s.items=s.items||[],d.items=d.items||[];const f=s.items.findIndex(T=>T.id===$);if(f===-1)return!1;const h=Math.min(d.items.length,Math.max(0,f)),w=h<d.items.length?d.items[h].id:null;return Ls($,w,d.id),ji(),yt($),!0}function Ud(e){if(v<0||!e)return!1;const n=y[v].data.categories||[];if(!n.length)return!1;const i=no();if(!i)return!1;const o=n.findIndex(d=>d.id===i);if(o===-1)return!1;const a=o+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(o,1);return n.splice(a,0,s),xe=s.id,xa(),Ze=null,Ht(),Nt(),Et(),Ji(),console.log("[Blockscape] moved category",s.id,"from",o,"to",a),!0}function Hd(){if(v<0)return!1;const e=y[v],t=ct(e)||(e?e.id:null),n=[];if(Pt&&t===Pt.modelId&&n.push({...Pt,type:"item"}),_t&&t===_t.modelId&&n.push({..._t,type:"category"}),!n.length)return!1;const i=n.reduce((o,a)=>o?(a.ts||0)>(o.ts||0)?a:o:a,null);if(!i)return!1;if(i.type==="category"){if(Wd(i))return!0}else if(i.type==="item"&&Fd(i))return!0;return!1}function Fd(e){const t=y[v],n=ct(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(d=>d.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),Pt=null,zn(),$=null,ht=null,Ht(),Nt(),Et(),ji(),yt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function Wd(e){const t=y[v],n=ct(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const i=t.data;i.categories=i.categories||[];const o=Math.min(Math.max(e.index,0),i.categories.length);return i.categories.splice(o,0,e.category),_t=null,$=null,ht=null,xe=e.category.id,Ze=null,Ht(),Nt(),Et(),Ji(),Vn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function Ms(){if(!$||v<0)return!1;const t=y[v].data.categories||[];if(!t.length)return!1;const n=ve.get($);let i=null;if(n!=null&&n.catId&&(i=t.find(h=>h.id===n.catId)),i||(i=t.find(h=>(h.items||[]).some(w=>w.id===$))),!i||!Array.isArray(i.items))return!1;const o=i.items.findIndex(h=>h.id===$);if(o===-1)return!1;const a=i.items.splice(o,1)[0];if(!a)return!1;const s=y[v];Pt={item:a,categoryId:i.id,index:o,modelId:ct(s)||(s?s.id:null),ts:Date.now()};const f=(()=>{var w;if(i.items.length){const T=Math.min(o,i.items.length-1);return((w=i.items[T])==null?void 0:w.id)||null}const h=t.findIndex(T=>T.id===i.id);if(h===-1)return null;for(let T=h+1;T<t.length;T++){const B=t[T].items||[];if(B.length)return B[0].id}for(let T=h-1;T>=0;T--){const B=t[T].items||[];if(B.length)return B[0].id}return null})();return zn(),$=null,ht=null,Ze=null,Ht(),Nt(),Et(),ji(),f?yt(f):zi(),console.log("[Blockscape] removed item",a.id),!0}function jd(){var d,f;const e=no();if(!e||v<0)return!1;const n=y[v].data.categories||[];if(!n.length)return!1;const i=n.findIndex(h=>h.id===e);if(i===-1)return!1;const[o]=n.splice(i,1);if(!o)return!1;const a=y[v];_t={category:o,index:i,modelId:ct(a)||(a?a.id:null),ts:Date.now()},xe=null,$=null,ht=null,Ze=null,Ht(),Nt(),Et();const s=((d=n[i])==null?void 0:d.id)||((f=n[i-1])==null?void 0:f.id)||null;return s?Vn(s):zi(),console.log("[Blockscape] removed category",o.id),!0}function Jd(e){if(!e)return!1;const t=$;$=e;const n=Ms();return n||($=t,Ht()),n}z&&z.addEventListener("click",async()=>{const e=r.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await Jr(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),W&&W.addEventListener("click",async()=>{const e=Dc();if(!e){alert("No series available to copy. Create another version first.");return}await Jr(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),ye&&ye.addEventListener("click",async()=>{try{const e=await zl();if(!e){alert("Clipboard is empty.");return}r.value=e,r.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await to(),t=On(r.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const i=[];t.forEach((o,a)=>{const s=kn(o,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),i.push(s)}),v===-1&&n!=null?gt(n):Rn(),e&&await $s(i,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(v<0){alert("No active model selected.");return}try{const t=JSON.parse(r.value);if(In(t,{titleHint:qe(y[v]),idHint:ct(y[v])||qe(y[v])}),y[v].data=t,y[v].title=t.title||y[v].title,y[v].isSeries||((e=y[v].apicurioVersions)==null?void 0:e.length)>1){const n=y[v].title||qe(y[v]);It(y[v],{seriesName:n,fallbackTitle:n})}ya(),console.log("[Blockscape] replaced active model:",qe(y[v])),Et(),Je.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const i of t){const o=await i.text(),a=i.name.replace(/\.[^.]+$/,"")||"File",s=On(o,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",i.name);continue}s.forEach((d,f)=>{var te;const h=(((te=d.data)==null?void 0:te.title)??"").toString().trim(),w=s.length>1?`${i.name} #${f+1}`:i.name,T=`${a} series`,B=d.isSeries?T:null;let A={...d};if(d.isSeries){const ne=B||h||d.title||w||"unknown";A.title=ne;const ot=vn(ne||"unknown");pi(A,ot),It(A,{seriesName:ne,fallbackTitle:"unknown"}),A.apicurioArtifactName=A.apicurioArtifactName||ne}else A.title=h||w;const E=kn({...A,apicurioArtifactName:A.apicurioArtifactName||B||A.apicurioArtifactName},{versionLabel:i.name});n==null&&(n=E)})}v===-1&&n!=null?gt(n):Rn()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",zd);async function zd(e){var a;if(!mi())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!od(t))return;let n=[];try{const s=await to();n=On(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let i=null;const o=[];n.forEach((s,d)=>{const f=kn(s,{versionLabel:n.length>1?`paste #${d+1}`:"paste"});i==null&&(i=f),o.push(f)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),i!=null&&gt(i),await to()&&await $s(o,{origin:"clipboard"})}async function $s(e,{origin:t="clipboard"}={}){if(!await to()||typeof(ze==null?void 0:ze.saveModelByIndex)!="function")return;const i=(Array.isArray(e)?e:[]).filter(B=>{const A=y[B];return A&&!A.sourcePath});if(!i.length)return;const o=i.length===1?"model":"models",a=y[i[0]],s=Xl(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const d=window.prompt(`Save pasted ${o} as a new .bs file (under ~/blockscape):`,s);if(d==null)return;const f=ui(d);if(!f){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const h=await Kl(),w=[];for(let B=0;B<i.length;B++){const A=i.length===1?f:Gl(f,B+1),E=Yl(A,h);if(!E){alert("Could not find a unique filename to save.");return}h.add(E),w.push(E)}let T=null;for(let B=0;B<i.length;B++){const A=i[B],E=w[B],te=y[A];if(!te)continue;i.length===1&&Zl(te,E);const ne=await ze.saveModelByIndex(A,E,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(ne!=null&&ne.ok)){alert(`Local auto-save failed: ${(ne==null?void 0:ne.error)||"unknown error"}`);return}T==null&&(T=E)}T&&Oo(T),await ze.refresh(),Rn(),Bn(`Saved ${i.length} ${o}.`,2500)}X.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&gt(n)}),document.getElementById("removeModel").onclick=()=>{if(v<0)return;const e=qe(y[v]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",qe(y[v])),y.splice(v,1),!y.length){v=-1,G=null,p.innerHTML="",I.innerHTML="",r.value="",Rn(),ya();return}const n=Math.min(v,y.length-1);gt(n)},l&&(l.addEventListener("input",e=>{hs(e.target.value||"")}),l.addEventListener("focus",()=>{l.value&&l.value.trim()&&ms(l.value)})),P&&P.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),i=t.dataset.itemId;Qc({modelIndex:n,itemId:i})}),document.addEventListener("click",e=>{if(!P||P.hidden)return;const t=e.target;P.contains(t)||l&&(t===l||l.contains(t))||(P.hidden=!0)}),q&&K&&C&&q.addEventListener("submit",async e=>{e.preventDefault();const t=K.value.trim();if(!t){alert("Please enter a URL"),K.focus();return}const n=await Ta(t);if(typeof n=="number"){gt(n),K.value="";const i=document.getElementById("urlHint");i&&(i.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!K||!t)return;let n=null;K.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=K.value.slice(-12);t.textContent=o?`…${o}`:""},300)})}();function Et(){if(!(v<0))try{Fo(y[v]),G=ld(y[v].data),ji()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function qd(){const e=["comms.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>To?To.endsWith("/")?`${To}${n}`:`${To}/${n}`:n;for(const n of e)try{const i=await fetch(t(n),{cache:"no-store"});if(!i.ok){console.warn(`[Blockscape] ${n} not fetched (${i.status}); skipping`);continue}const o=await i.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=On(o,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(d=>{let f={...d};if(d.isSeries){const h=`${a} series`;f={...d,title:h,apicurioArtifactName:h};const w=vn(h||"unknown");pi(f,w),It(f,{seriesName:h,fallbackTitle:"unknown"})}kn(f,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(i){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",i)}Rn()}async function Gd(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const i of t)try{console.log(`[Blockscape] fetching ${e} with cache="${i.cache??"default"}"`);const o=await fetch(e,i);if(o.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return await o.text()}catch(o){n=o}throw n||new Error("Unable to fetch URL")}function Kd(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(i=>Yd(i)),e.querySelectorAll("a[href]").forEach(i=>{const o=i.getAttribute("href");Rs(o)&&Bs(i,o)})}function Yd(e){var d,f;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(f=(d=e.parentNode)==null?void 0:d.closest)!=null&&f.call(d,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,i=[];let o;for(;(o=n.exec(t))!==null;)i.push({url:o[0],index:o.index});if(!i.length)return;const a=document.createDocumentFragment();let s=0;i.forEach(({url:h,index:w})=>{w>s&&a.appendChild(document.createTextNode(t.slice(s,w))),a.appendChild(Xd(h)),s=w+h.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function Xd(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Rs(e)&&Bs(t,e),t}function Bs(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Zd(n,t,e)))}async function Zd(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await Ta(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Rs(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function Ta(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Gd(e),i=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let o;try{o=On(t,i)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!o.length)throw new Error("No JSON objects found in response.");let a=null;return o.forEach((s,d)=>{var A;const f=(((A=s.data)==null?void 0:A.title)??"").toString().trim(),h=o.length>1?`${i} #${d+1}`:i,w=s.isSeries?`${i} series`:null;let T={...s};if(s.isSeries){const E=w||f||T.title||h;T={...s,title:E,apicurioArtifactName:E||s.apicurioArtifactName};const te=vn(E||"unknown");pi(T,te),It(T,{seriesName:E||w||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:te,url:e,baseName:i,seriesTitle:E})}const B=kn({...T,title:f||T.title||h,apicurioArtifactName:T.apicurioArtifactName||w||s.apicurioArtifactName},{versionLabel:i});a==null&&(a=B)}),console.log(`[Blockscape] loaded ${o.length} model(s) from URL:`,i),v===-1&&a!=null?gt(a):Rn(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const i=On(n,"Blockscape");if(!i.length)throw new Error("Seed template could not be parsed.");let o=null;i.forEach(A=>{const E=kn(A,{versionLabel:"seed"});o==null&&(o=E)}),await Dr||await qd();const s=await rd(),d=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,f=await sd(),h=ws(),w=h==null?void 0:h.index,T=ad(),B=typeof d=="number"?d:typeof f=="number"?f:typeof T=="number"?T:typeof w=="number"?w:o??0;gt(B),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===B&&requestAnimationFrame(()=>{var E;if(v!==s.modelIndex)return;const A=(E=ve.get(s.itemId))==null?void 0:E.el;A&&(yt(s.itemId),A.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),A.focus({preventScroll:!0}))})})()}function yl(r){let c;return{c(){c=U("div"),c.innerHTML='<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>',b(c,"id","shortcutHelp"),b(c,"class","shortcut-help"),c.hidden=!0,b(c,"aria-hidden","true"),b(c,"role","dialog"),b(c,"aria-modal","true"),b(c,"aria-labelledby","shortcutHelpTitle")},m(p,I){mt(p,c,I)},p:wt,i:wt,o:wt,d(p){p&&ft(c)}}}class El extends xo{constructor(c){super(),Co(this,c,null,yl,Eo,{})}}const Sl=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping, but do not add extra fields for it.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function yr(r){let c,p,I,N,X,ie,q,K;return{c(){c=U("div"),p=U("div"),I=U("a"),N=ia("Open Blockscape GPT"),X=se(),ie=U("div"),ie.textContent="Paste the copied prompt into that chat.",q=se(),K=U("div"),K.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',b(I,"href",kl),b(I,"target","_blank"),b(I,"rel","noreferrer"),b(ie,"class","new-panel__hint"),b(p,"class","new-panel__link"),b(K,"class","new-panel__link new-panel__link--disabled"),b(c,"class","new-panel__links")},m(C,he){mt(C,c,he),_(c,p),_(p,I),_(I,N),_(p,X),_(p,ie),_(c,q),_(c,K)},p:wt,d(C){C&&ft(c)}}}function Er(r){let c,p,I,N,X,ie;return{c(){c=U("div"),p=U("div"),p.textContent="Generated prompt",I=se(),N=U("textarea"),b(p,"class","new-panel__prompt-label"),b(N,"class","pf-v5-c-form-control new-panel__textarea"),b(N,"rows","4"),N.readOnly=!0,b(c,"class","new-panel__prompt")},m(q,K){mt(q,c,K),_(c,p),_(c,I),_(c,N),ni(N,r[4]),X||(ie=ti(N,"input",r[12]),X=!0)},p(q,K){K&16&&ni(N,q[4])},d(q){q&&ft(c),X=!1,ie()}}}function Il(r){let c,p,I,N,X,ie,q,K,C,he,j,me,ke,Ye,je,Ge,Te,z,W,ye,M,Ie,Me,ce,Le,Ce,be,ge,O,Y,l,P,le,Oe,ue,He,st,Xe,Pe,ut,Fe,lt,kt,V,y,v,Je,G=r[2]==="gpt"&&yr(),ve=r[4]&&r[5]&&Er(r);return y=Xs(r[10][0]),{c(){c=U("div"),p=U("div"),I=se(),N=U("div"),X=U("div"),X.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',ie=se(),q=U("form"),K=U("div"),C=U("label"),C.textContent="Domain",he=se(),j=U("p"),j.textContent="Describe what you want to create a map for.",me=se(),ke=U("textarea"),Ye=se(),je=U("div"),Ge=U("label"),Te=U("input"),z=se(),W=U("span"),W.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,ye=se(),M=U("fieldset"),Ie=U("legend"),Ie.textContent="Target",Me=se(),ce=U("p"),ce.textContent="Choose where you plan to use the prompt.",Le=se(),Ce=U("label"),be=U("input"),ge=se(),O=U("div"),O.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',Y=se(),l=U("label"),P=U("input"),le=se(),Oe=U("div"),Oe.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',ue=se(),He=U("div"),st=U("button"),st.textContent="Copy prompt",Xe=se(),Pe=U("button"),Pe.textContent="New blank",ut=se(),Fe=U("div"),lt=ia(r[3]),kt=se(),G&&G.c(),V=se(),ve&&ve.c(),b(p,"id","newPanelBackdrop"),b(p,"class","shortcut-help__backdrop"),b(X,"class","shortcut-help__header"),b(C,"for","newDomain"),b(j,"class","new-panel__hint"),b(ke,"id","newDomain"),b(ke,"class","pf-v5-c-form-control new-panel__textarea"),b(ke,"rows","4"),ke.required=!0,b(ke,"placeholder","Ex: Companies building open-source geospatial tools"),b(K,"class","new-panel__field"),b(Te,"id","seriesToggle"),b(Te,"type","checkbox"),b(Ge,"class","new-panel__toggle"),b(Ge,"for","seriesToggle"),b(je,"class","new-panel__field"),b(ce,"class","new-panel__hint"),b(be,"type","radio"),b(be,"name","target"),be.__value="gpt",ni(be,be.__value),b(Ce,"class","new-panel__option"),b(P,"type","radio"),b(P,"name","target"),P.__value="plain",ni(P,P.__value),b(l,"class","new-panel__option"),b(M,"class","new-panel__field"),b(st,"class","pf-v5-c-button pf-m-primary"),b(st,"type","submit"),b(Pe,"id","newBlankButton"),b(Pe,"class","pf-v5-c-button pf-m-secondary"),b(Pe,"type","button"),b(Pe,"title","Start from an empty map"),b(Fe,"class","new-panel__status"),b(Fe,"aria-live","polite"),b(He,"class","new-panel__actions"),b(q,"class","shortcut-help__list new-panel__form"),b(N,"class","shortcut-help__panel"),b(N,"tabindex","-1"),b(c,"id","newPanel"),b(c,"class","shortcut-help"),c.hidden=!0,b(c,"aria-hidden","true"),b(c,"role","dialog"),b(c,"aria-modal","true"),b(c,"aria-labelledby","newPanelTitle"),y.p(be,P)},m(Ve,$){mt(Ve,c,$),_(c,p),_(c,I),_(c,N),_(N,X),_(N,ie),_(N,q),_(q,K),_(K,C),_(K,he),_(K,j),_(K,me),_(K,ke),ni(ke,r[0]),_(q,Ye),_(q,je),_(je,Ge),_(Ge,Te),Te.checked=r[1],_(Ge,z),_(Ge,W),_(q,ye),_(q,M),_(M,Ie),_(M,Me),_(M,ce),_(M,Le),_(M,Ce),_(Ce,be),be.checked=be.__value===r[2],_(Ce,ge),_(Ce,O),_(M,Y),_(M,l),_(l,P),P.checked=P.__value===r[2],_(l,le),_(l,Oe),_(q,ue),_(q,He),_(He,st),_(He,Xe),_(He,Pe),_(He,ut),_(He,Fe),_(Fe,lt),_(q,kt),G&&G.m(q,null),_(q,V),ve&&ve.m(q,null),v||(Je=[ti(ke,"input",r[7]),ti(Te,"change",r[8]),ti(be,"change",r[9]),ti(P,"change",r[11]),ti(q,"submit",Ys(r[6]))],v=!0)},p(Ve,[$]){$&1&&ni(ke,Ve[0]),$&2&&(Te.checked=Ve[1]),$&4&&(be.checked=be.__value===Ve[2]),$&4&&(P.checked=P.__value===Ve[2]),$&8&&Qs(lt,Ve[3]),Ve[2]==="gpt"?G?G.p(Ve,$):(G=yr(),G.c(),G.m(q,V)):G&&(G.d(1),G=null),Ve[4]&&Ve[5]?ve?ve.p(Ve,$):(ve=Er(Ve),ve.c(),ve.m(q,null)):ve&&(ve.d(1),ve=null)},i:wt,o:wt,d(Ve){Ve&&ft(c),G&&G.d(),ve&&ve.d(),y.r(),v=!1,Gi(Je)}}}const kl="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function _l(r,c,p){let I="",N=!1,X="gpt",ie="",q="",K=!1;const C=()=>{var z;return typeof navigator<"u"&&!!((z=navigator.clipboard)!=null&&z.writeText)};function he(z){const W=z||"[DOMAIN]",ye=N?"series":"map",Ie=Sl.replaceAll("[DOMAIN NAME]",W).replaceAll("[DOMAIN]",W).replaceAll("[map|series]",ye).split(`
`),Me=`Generate a **blockscape ${ye}** for the domain of ${W}.`,ce=Ie.findIndex(Ce=>Ce.toLowerCase().includes("generate a **blockscape value")||Ce.toLowerCase().includes("generate a blockscape [map|series]")||Ce.toLowerCase().startsWith("generate a blockscape"));ce>=0?Ie[ce]=Me:Ie.unshift(Me);const Le=N?`

User requested a series (return an array of models).`:"";return`${Ie.join(`
`).trim()}${Le}`}async function j(z){z.preventDefault();const W=I.trim();if(p(3,ie=""),p(5,K=X!=="gpt"),!W){p(3,ie="Add a domain to generate a prompt."),p(4,q="");return}if(X==="gpt"?p(4,q=`${N?"Create a series":"Create a map"} for ${W}`):(p(4,q=he(W)),p(5,K=!0)),!C()){p(3,ie="Clipboard access is unavailable. Copy the prompt below."),p(5,K=!0);return}try{await navigator.clipboard.writeText(q),p(3,ie=X==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),X==="gpt"&&p(5,K=!1)}catch(M){console.warn("[Blockscape] clipboard write failed",M),p(3,ie="Copy failed. Use the prompt below."),p(5,K=!0)}}const me=[[]];function ke(){I=this.value,p(0,I)}function Ye(){N=this.checked,p(1,N)}function je(){X=this.__value,p(2,X)}function Ge(){X=this.__value,p(2,X)}function Te(){q=this.value,p(4,q)}return[I,N,X,ie,q,K,j,ke,Ye,je,me,Ge,Te]}class Cl extends xo{constructor(c){super(),Co(this,c,_l,Il,Eo,{})}}const{document:Sr}=Ks;function xl(r){let c,p,I,N,X,ie,q,K,C,he,j,me,ke,Ye,je,Ge,Te,z,W,ye,M,Ie,Me,ce,Le,Ce,be,ge,O,Y,l,P,le,Oe,ue,He,st,Xe,Pe,ut,Fe,lt,kt,V,y,v,Je,G,ve,Ve,$,xe,ht,Ze,Ft,Tn,Ot,Kt,Pt,_t,oi,Ln,ai,Yt,Xt,Ct,dn,xt,Vt,Wt,Jn=`<script id="seed" type="application/json">${r[1]}<\/script>`,jt,un,Sn,Dt,u,g,L,x,S,R,ee,J,de,fe,Ee;return R=new El({}),J=new Cl({}),{c(){c=U("link"),p=se(),I=U("div"),N=U("header"),X=U("div"),ie=U("div"),q=U("div"),K=U("div"),K.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/> <a href="https://github.com/pwright/blockscape" target="_blank" class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a>',C=se(),he=U("div"),j=U("div"),me=U("button"),ke=U("span"),ke.textContent="Toggle search and edit tools",Ye=se(),je=U("span"),je.textContent="▾",Ge=se(),Te=U("button"),Te.textContent="New",z=se(),W=U("form"),W.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',ye=se(),M=U("label"),M.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',Ie=se(),Me=U("button"),Me.textContent="Help",ce=se(),Le=U("div"),Ce=U("div"),Ce.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',be=se(),ge=U("button"),ge.textContent="Edit",O=se(),Y=U("button"),Y.textContent="Share",Oe=se(),ue=U("div"),ue.innerHTML='<span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span> <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span> <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span> <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>',He=se(),st=U("main"),Xe=U("div"),Pe=U("aside"),ut=U("div"),ut.textContent="Models",Fe=se(),lt=U("ul"),kt=se(),V=U("div"),V.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',y=se(),v=U("section"),Je=U("div"),Je.textContent="Local files",G=se(),ve=U("p"),ve.textContent="Checking for local server…",Ve=se(),$=U("div"),xe=U("label"),xe.textContent="Blockscape files under ~/blockscape",ht=se(),Ze=U("div"),Ft=U("label"),Ft.textContent="Folder",Tn=se(),Ot=U("select"),Kt=U("option"),Kt.textContent="All (~/blockscape)",Pt=se(),_t=U("select"),oi=se(),Ln=U("div"),Ln.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button>',ai=se(),Yt=U("div"),Yt.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',Xt=se(),Ct=U("div"),Ct.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,dn=se(),xt=U("footer"),xt.innerHTML='<div class="blockscape-footer__inner"><a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a></div>',Vt=se(),Wt=new el(!1),jt=se(),un=ur("svg"),Sn=se(),Dt=U("div"),u=se(),g=U("div"),L=se(),x=U("div"),x.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',S=se(),la(R.$$.fragment),ee=se(),la(J.$$.fragment),Sr.title="Blockscape — simple landscape-style tiles",b(c,"rel","icon"),b(c,"type","image/svg+xml"),b(c,"href","./favicon.svg"),b(K,"class","blockscape-brand"),b(ke,"class","sr-only"),b(je,"class","blockscape-toolbar__toggle-icon"),b(je,"aria-hidden","true"),b(me,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__toggle"),b(me,"type","button"),b(me,"aria-expanded",r[0]),b(me,"aria-controls","blockscapeHeaderExtras"),b(Te,"id","newPanelButton"),b(Te,"class","pf-v5-c-button pf-m-primary"),b(Te,"type","button"),b(Te,"title","Create something new"),b(W,"id","urlForm"),b(W,"class","blockscape-url-form"),b(W,"autocomplete","on"),W.noValidate=!0,b(M,"class","pf-v5-c-button pf-m-primary blockscape-file"),b(Me,"id","helpButton"),b(Me,"class","pf-v5-c-button pf-m-primary"),b(Me,"type","button"),b(Me,"title","Show keyboard shortcuts"),b(j,"class","blockscape-toolbar__primary"),b(Ce,"class","blockscape-search"),b(ge,"id","openInEditor"),b(ge,"class","pf-v5-c-button pf-m-secondary"),b(ge,"type","button"),b(ge,"title","Open current JSON in the editor"),b(Y,"id","shareModel"),b(Y,"class","pf-v5-c-button pf-m-secondary"),b(Y,"type","button"),b(Y,"title","Copy a shareable URL for this model"),b(Le,"id","blockscapeHeaderExtras"),b(Le,"class","blockscape-toolbar__extras"),Le.hidden=l=!r[0],b(Le,"aria-hidden",P=!r[0]),b(he,"class","blockscape-toolbar__controls"),b(he,"data-expanded",le=r[0]?"true":"false"),b(ue,"class","blockscape-legend"),b(ue,"role","presentation"),b(q,"class","blockscape-toolbar"),b(ie,"class","pf-v5-c-masthead__content"),b(X,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),b(N,"class","pf-v5-c-page__header"),b(ut,"class","sidebar-heading"),b(lt,"id","modelList"),b(lt,"class","model-nav-list"),b(V,"class","model-actions"),b(Je,"class","sidebar-heading"),b(ve,"id","localBackendStatus"),b(ve,"class","local-backend__status muted"),b(xe,"class","sr-only"),b(xe,"for","localFileList"),b(Ft,"for","localDirSelect"),Kt.__value="",ni(Kt,Kt.__value),b(Ot,"id","localDirSelect"),b(Ot,"class","pf-v5-c-form-control"),b(Ot,"aria-label","Folder filter"),b(Ze,"class","local-backend__dir"),b(_t,"id","localFileList"),b(_t,"class","pf-v5-c-form-control"),b(_t,"size","12"),_t.multiple=!0,b(_t,"aria-label","Blockscape files on local server"),b(Ln,"class","local-backend__actions"),b($,"class","local-backend__list"),b(Yt,"class","local-backend__save"),b(v,"id","localBackendPanel"),b(v,"class","local-backend"),v.hidden=!0,b(Pe,"class","blockscape-sidebar"),b(Pe,"aria-label","Models"),b(Ct,"class","blockscape-main"),b(Xe,"class","blockscape-content"),b(st,"class","pf-v5-c-page__main"),b(xt,"class","pf-v5-c-page__footer blockscape-footer"),b(I,"class","pf-v5-c-page"),Wt.a=jt,b(un,"id","overlay"),b(un,"class","svg-layer"),b(Dt,"id","tabTooltip"),b(Dt,"class","blockscape-tab-tooltip"),Dt.hidden=!0,b(Dt,"aria-hidden","true"),b(g,"id","tileContextMenu"),b(g,"class","tile-context-menu"),g.hidden=!0,b(g,"aria-hidden","true"),b(x,"id","itemPreview"),b(x,"class","item-preview"),x.hidden=!0,b(x,"aria-hidden","true")},m(Z,we){_(Sr.head,c),mt(Z,p,we),mt(Z,I,we),_(I,N),_(N,X),_(X,ie),_(ie,q),_(q,K),_(q,C),_(q,he),_(he,j),_(j,me),_(me,ke),_(me,Ye),_(me,je),_(j,Ge),_(j,Te),_(j,z),_(j,W),_(j,ye),_(j,M),_(j,Ie),_(j,Me),_(he,ce),_(he,Le),_(Le,Ce),_(Le,be),_(Le,ge),_(Le,O),_(Le,Y),_(q,Oe),_(q,ue),_(I,He),_(I,st),_(st,Xe),_(Xe,Pe),_(Pe,ut),_(Pe,Fe),_(Pe,lt),_(Pe,kt),_(Pe,V),_(Pe,y),_(Pe,v),_(v,Je),_(v,G),_(v,ve),_(v,Ve),_(v,$),_($,xe),_($,ht),_($,Ze),_(Ze,Ft),_(Ze,Tn),_(Ze,Ot),_(Ot,Kt),_($,Pt),_($,_t),_($,oi),_($,Ln),_(v,ai),_(v,Yt),_(Xe,Xt),_(Xe,Ct),_(I,dn),_(I,xt),mt(Z,Vt,we),Wt.m(Jn,Z,we),mt(Z,jt,we),mt(Z,un,we),mt(Z,Sn,we),mt(Z,Dt,we),mt(Z,u,we),mt(Z,g,we),mt(Z,L,we),mt(Z,x,we),mt(Z,S,we),ko(R,Z,we),mt(Z,ee,we),ko(J,Z,we),de=!0,fe||(Ee=ti(me,"click",r[2]),fe=!0)},p(Z,[we]){(!de||we&1)&&b(me,"aria-expanded",Z[0]),(!de||we&1&&l!==(l=!Z[0]))&&(Le.hidden=l),(!de||we&1&&P!==(P=!Z[0]))&&b(Le,"aria-hidden",P),(!de||we&1&&le!==(le=Z[0]?"true":"false"))&&b(he,"data-expanded",le)},i(Z){de||(Io(R.$$.fragment,Z),Io(J.$$.fragment,Z),de=!0)},o(Z){sa(R.$$.fragment,Z),sa(J.$$.fragment,Z),de=!1},d(Z){Z&&(ft(p),ft(I),ft(Vt),Wt.d(),ft(jt),ft(un),ft(Sn),ft(Dt),ft(u),ft(g),ft(L),ft(x),ft(S),ft(ee)),ft(c),_o(R,Z),_o(J,Z),fe=!1,Ee()}}}function Al(r,c,p){let{seed:I}=c;const X=I?JSON.stringify(I,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let ie=!1;const q=()=>{if(p(0,ie=!ie),!ie){const K=document.getElementById("search");K&&K.value&&(K.value="",K.dispatchEvent(new Event("input",{bubbles:!0})))}};return nl(()=>{wl()}),r.$$set=K=>{"seed"in K&&p(3,I=K.seed)},[ie,X,q,I]}class Tl extends xo{constructor(c){super(),Co(this,c,Al,xl,Eo,{seed:3})}}function Ll(r){let c,p;return c=new Tl({props:{seed:r[0]}}),{c(){la(c.$$.fragment)},m(I,N){ko(c,I,N),p=!0},p(I,[N]){const X={};N&1&&(X.seed=I[0]),c.$set(X)},i(I){p||(Io(c.$$.fragment,I),p=!0)},o(I){sa(c.$$.fragment,I),p=!1},d(I){_o(c,I)}}}function Nl(r,c,p){let{seed:I}=c;return r.$$set=N=>{"seed"in N&&p(0,I=N.seed)},[I]}class Ml extends xo{constructor(c){super(),Co(this,c,Nl,Ll,Eo,{seed:0})}}return Ml}();
