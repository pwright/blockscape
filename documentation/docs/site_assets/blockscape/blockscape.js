var Blockscape=function(){"use strict";var zp=Object.defineProperty;var Gp=(On,Ft,ro)=>Ft in On?zp(On,Ft,{enumerable:!0,configurable:!0,writable:!0,value:ro}):On[Ft]=ro;var ao=(On,Ft,ro)=>Gp(On,typeof Ft!="symbol"?Ft+"":Ft,ro);var On=typeof document<"u"?document.currentScript:null;function Ft(){}function ro(r){return r()}function Yr(){return Object.create(null)}function Eo(r){r.forEach(ro)}function Zr(r){return typeof r=="function"}function Di(r,l){return r!=r?l==l:r!==l||r&&typeof r=="object"||typeof r=="function"}function ec(r){return Object.keys(r).length===0}const tc=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function E(r,l){r.appendChild(l)}function Pt(r,l,m){r.insertBefore(l,m||null)}function xt(r){r.parentNode&&r.parentNode.removeChild(r)}function U(r){return document.createElement(r)}function Xr(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function Ui(r){return document.createTextNode(r)}function ae(){return Ui(" ")}function Nn(r,l,m,T){return r.addEventListener(l,m,T),()=>r.removeEventListener(l,m,T)}function nc(r){return function(l){return l.preventDefault(),r.call(this,l)}}function b(r,l,m){m==null?r.removeAttribute(l):r.getAttribute(l)!==m&&r.setAttribute(l,m)}function oc(r){let l;return{p(...m){l=m,l.forEach(T=>r.push(T))},r(){l.forEach(m=>r.splice(r.indexOf(m),1))}}}function ic(r){return Array.from(r.childNodes)}function Qr(r,l){l=""+l,r.data!==l&&(r.data=l)}function so(r,l){r.value=l??""}class ac{constructor(l=!1){ao(this,"is_svg",!1);ao(this,"e");ao(this,"n");ao(this,"t");ao(this,"a");this.is_svg=l,this.e=this.n=null}c(l){this.h(l)}m(l,m,T=null){this.e||(this.is_svg?this.e=Xr(m.nodeName):this.e=U(m.nodeType===11?"TEMPLATE":m.nodeName),this.t=m.tagName!=="TEMPLATE"?m:m.content,this.c(l)),this.i(T)}h(l){this.e.innerHTML=l,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(l){for(let m=0;m<this.n.length;m+=1)Pt(this.t,this.n[m],l)}p(l){this.d(),this.h(l),this.i(this.a)}d(){this.n.forEach(xt)}}let ri;function si(r){ri=r}function rc(){if(!ri)throw new Error("Function called outside component initialization");return ri}function sc(r){rc().$$.on_mount.push(r)}const ko=[],es=[];let Io=[];const ts=[],lc=Promise.resolve();let ka=!1;function cc(){ka||(ka=!0,lc.then(ns))}function Ia(r){Io.push(r)}const _a=new Set;let _o=0;function ns(){if(_o!==0)return;const r=ri;do{try{for(;_o<ko.length;){const l=ko[_o];_o++,si(l),dc(l.$$)}}catch(l){throw ko.length=0,_o=0,l}for(si(null),ko.length=0,_o=0;es.length;)es.pop()();for(let l=0;l<Io.length;l+=1){const m=Io[l];_a.has(m)||(_a.add(m),m())}Io.length=0}while(ko.length);for(;ts.length;)ts.pop()();ka=!1,_a.clear(),si(r)}function dc(r){if(r.fragment!==null){r.update(),Eo(r.before_update);const l=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,l),r.after_update.forEach(Ia)}}function uc(r){const l=[],m=[];Io.forEach(T=>r.indexOf(T)===-1?l.push(T):m.push(T)),m.forEach(T=>T()),Io=l}const Hi=new Set;let pc;function Fi(r,l){r&&r.i&&(Hi.delete(r),r.i(l))}function Ca(r,l,m,T){if(r&&r.o){if(Hi.has(r))return;Hi.add(r),pc.c.push(()=>{Hi.delete(r)}),r.o(l)}}function xa(r){r&&r.c()}function Wi(r,l,m){const{fragment:T,after_update:_}=r.$$;T&&T.m(l,m),Ia(()=>{const G=r.$$.on_mount.map(ro).filter(Zr);r.$$.on_destroy?r.$$.on_destroy.push(...G):Eo(G),r.$$.on_mount=[]}),_.forEach(Ia)}function ji(r,l){const m=r.$$;m.fragment!==null&&(uc(m.after_update),Eo(m.on_destroy),m.fragment&&m.fragment.d(l),m.on_destroy=m.fragment=null,m.ctx=[])}function fc(r,l){r.$$.dirty[0]===-1&&(ko.push(r),cc(),r.$$.dirty.fill(0)),r.$$.dirty[l/31|0]|=1<<l%31}function zi(r,l,m,T,_,G,te=null,J=[-1]){const Z=ri;si(r);const C=r.$$={fragment:null,ctx:[],props:G,update:Ft,not_equal:_,bound:Yr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(Z?Z.$$.context:[])),callbacks:Yr(),dirty:J,skip_bound:!1,root:l.target||Z.$$.root};te&&te(C.root);let se=!1;if(C.ctx=m?m(r,l.props||{},(j,re,...fe)=>{const st=fe.length?fe[0]:re;return C.ctx&&_(C.ctx[j],C.ctx[j]=st)&&(!C.skip_bound&&C.bound[j]&&C.bound[j](st),se&&fc(r,j)),re}):[],C.update(),se=!0,Eo(C.before_update),C.fragment=T?T(C.ctx):!1,l.target){if(l.hydrate){const j=ic(l.target);C.fragment&&C.fragment.l(j),j.forEach(xt)}else C.fragment&&C.fragment.c();l.intro&&Fi(r.$$.fragment),Wi(r,l.target,l.anchor),ns()}si(Z)}class Gi{constructor(){ao(this,"$$");ao(this,"$$set")}$destroy(){ji(this,1),this.$destroy=Ft}$on(l,m){if(!Zr(m))return Ft;const T=this.$$.callbacks[l]||(this.$$.callbacks[l]=[]);return T.push(m),()=>{const _=T.indexOf(m);_!==-1&&T.splice(_,1)}}$set(l){this.$$set&&!ec(l)&&(this.$$.skip_bound=!0,this.$$set(l),this.$$.skip_bound=!1)}}const mc="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(mc);const os="blockscape:apicurioConfig",Ta="http://localhost:8080/apis/registry/v3",Ji="bs",is="-series",Aa=!1,La=!1;function hc({models:r,getActiveIndex:l,setActive:m,ensureModelMetadata:T,ensureSeriesId:_,getModelId:G,getSeriesId:te,getModelTitle:J,computeJsonFingerprint:Z,uid:C}){let se=null,j=null,re=null,fe=null,st=null,Fe=null,We=null,je=null,z=null,D=null;const ie=new Set,R={baseUrl:Ta,groupId:Ji,authToken:"",enabled:Aa,useSemver:La},me=new Map,Me=new Map;function he(d){return(d||"").toString().trim().replace(/\/+$/,"")}function ot(d){return`${(d||"").toString().trim()||Ji}${is}`}function Se(){return!!(R.baseUrl&&R.groupId)}function le(){return R.enabled!==!1}function mt(){ie.forEach(d=>{try{d(le())}catch(v){console.warn("[Blockscape] failed to run Apicurio enabled listener",v)}})}function O(d){return typeof d=="function"&&ie.add(d),()=>ie.delete(d)}function Y(){re&&(re.value=R.baseUrl||""),fe&&(fe.value=R.groupId||""),st&&(st.value=R.authToken||""),Fe&&(Fe.checked=le()),We&&(We.checked=!!R.useSemver)}function x(d="",v="muted"){je&&(je.textContent=d||"",je.classList.remove("is-error","is-success"),v==="error"?je.classList.add("is-error"):v==="success"&&je.classList.add("is-success"))}function X(d){if(!D||(D.innerHTML="",!d))return;const v=document.createElement("p");v.className="apicurio-hint",v.textContent=d,D.appendChild(v)}function ve(d){me.clear(),Me.clear(),X(d)}function ce(){const d=l(),v=le(),M=Se(),L=d>=0?r[d]:null,k=!!(L!=null&&L.apicurioVersions&&L.apicurioVersions.length>1);if(se){const V=se.dataset.loading==="true",Q=v&&M&&d>=0&&!!Le(r[d]);se.disabled=!v||V||!Q,v?V||(se.textContent="Push to Apicurio"):se.textContent="Enable Apicurio to push"}if(z){const V=z.dataset.loading==="true",Q=v&&M&&k&&!!Le(L);z.disabled=!Q||V,z.hidden=!k,v?V||(z.textContent="Push series"):z.textContent="Enable Apicurio to push series"}if(j){const V=j.dataset.loading==="true",Q=v&&M;j.disabled=!Q||V,V||(v?M?j.textContent="List artifacts":j.textContent="Enter details to list":j.textContent="Enable Apicurio to list")}}function ye(){Y(),le()?Se()?(x("Apicurio push is ready when a model is selected.","muted"),me.size||X("Click “List artifacts” to browse the current group.")):(x("Enter Apicurio connection details to enable push.","muted"),ve("Enter registry details to browse artifacts.")):(x("Apicurio integration is off. Enable it to allow pushes.","muted"),ve("Apicurio integration is disabled.")),ce()}function Ae(){if(window!=null&&window.localStorage)try{localStorage.setItem(os,JSON.stringify(R))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function ge(){let d={};if(window!=null&&window.localStorage)try{const V=localStorage.getItem(os);if(V){const Q=JSON.parse(V);Q&&typeof Q=="object"&&(d=Q)}}catch(V){console.warn("[Blockscape] failed to restore Apicurio settings",V)}const v=he(d.baseUrl??Ta),M=(d.groupId??Ji).toString().trim();let L=Aa,k=La;typeof d.enabled=="boolean"?L=d.enabled:typeof d.enabled=="string"&&(L=d.enabled==="true"),typeof d.useSemver=="boolean"?k=d.useSemver:typeof d.useSemver=="string"&&(k=d.useSemver==="true"),R.baseUrl=v||Ta,R.groupId=M||Ji,R.authToken=(d.authToken??"").toString().trim(),R.enabled=L,R.useSemver=k,ye(),mt()}function Re(){const d={Accept:"application/json"},v=(R.authToken||"").trim();return v&&(d.Authorization=/\s/.test(v)?v:`Bearer ${v}`),d}function w(d,v,{title:M,description:L,version:k}={}){const V={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:v},metadata:{properties:{}}}};k&&(V.firstVersion.version=k),M&&(V.name=M),L&&(V.description=L);try{const Q=JSON.parse(v),K=Q==null?void 0:Q.seriesId;K&&typeof K=="string"&&(V.firstVersion.metadata.properties.seriesId=K)}catch{}return V}function dt(d,{version:v}={}){const M={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const L=JSON.parse(d),k=L==null?void 0:L.seriesId;k&&typeof k=="string"&&(M.metadata.properties.seriesId=k)}catch{}return v&&(M.version=v),M}function ut(d){if(d==null)return null;const v=String(d).trim();if(!v)return null;const M=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(v);if(M)return{major:Number(M[1]),minor:Number(M[2]),patch:Number(M[3])};const L=/^v?(\d+)$/.exec(v);return L?{major:Number(L[1]),minor:0,patch:0}:null}function lt(d){return`${d.major}.${d.minor}.${d.patch}`}function Lt(d,v){return!d&&!v?0:d?v?d.major!==v.major?d.major-v.major:d.minor!==v.minor?d.minor-v.minor:d.patch-v.patch:1:-1}function It(d=[]){let v=null;if(d.forEach(L=>{const k=ut((L==null?void 0:L.version)??L);k&&(!v||Lt(k,v)>0)&&(v=k)}),!v)return"1.0.0";const M={...v,patch:v.patch+1};return lt(M)}function Le(d,{seriesName:v,fallbackTitle:M}={}){var V;if(!d)return null;const L=v||d.title||d.apicurioArtifactName||J(d),k=M||L;if(typeof _=="function"&&(d.isSeries||((V=d.apicurioVersions)==null?void 0:V.length)>1)&&_(d,{seriesName:L,fallbackTitle:k}),typeof te=="function"){const Q=te(d,{seriesName:L,fallbackTitle:k});if(Q)return Q}return G(d)}function it(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function Nt(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function Je(d=[]){if(!Array.isArray(d)||!d.length)return null;const v=[...d].filter(Boolean);return v.sort((M,L)=>{const k=M!=null&&M.createdOn?new Date(M.createdOn).getTime():0,V=L!=null&&L.createdOn?new Date(L.createdOn).getTime():0;if(k!==V)return V-k;const Q=Number(M==null?void 0:M.version),K=Number(L==null?void 0:L.version),Ie=Number.isFinite(Q),ue=Number.isFinite(K);if(Ie&&ue&&Q!==K)return K-Q;const Ee=String((M==null?void 0:M.version)??"");return String((L==null?void 0:L.version)??"").localeCompare(Ee,void 0,{numeric:!0})}),v[0]||null}function ct(d){if(!d)return d;let v=d;if(!Array.isArray(d==null?void 0:d.categories)){const L=d==null?void 0:d.content;if(typeof L=="string")try{v=JSON.parse(L)}catch(k){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",k)}else L&&typeof L=="object"&&(v=L)}return v}async function Ke(d,v,M){const L=encodeURIComponent(v),k=encodeURIComponent(M),V=`${d}/groups/${L}/artifacts/${k}`,Q=Re();Q.Accept="application/json";const K=await fetch(V,{method:"GET",headers:Q});if(!K.ok){let Ie=K.statusText||"Unknown error";try{const ue=await K.text();ue&&(Ie=ue.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${K.status}): ${Ie}`)}return K.json()}async function Be(d,v,M){const L=encodeURIComponent(v),k=encodeURIComponent(M),V=`${d}/groups/${L}/artifacts/${k}/versions?limit=50&order=desc`,Q=Re();Q.Accept="application/json";const K=await fetch(V,{method:"GET",headers:Q});if(!K.ok){let ue=K.statusText||"Unknown error";try{const Ee=await K.text();Ee&&(ue=Ee.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${K.status}): ${ue}`)}const Ie=await K.json();return Nt(Ie).filter(ue=>ue&&ue.version!=null)}async function p(d,v,M,L="latest"){const k=encodeURIComponent(v),V=encodeURIComponent(M),Q=encodeURIComponent(L||"latest"),K=`${d}/groups/${k}/artifacts/${V}/versions/${Q}/content`,Ie=Re();Ie.Accept="application/json, application/*+json, */*;q=0.8";const ue=await fetch(K,{method:"GET",headers:Ie});if(!ue.ok){let ft=ue.statusText||"Unknown error";try{const $e=await ue.text();$e&&(ft=$e.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${ue.status}): ${ft}`)}const Ee=await ue.text();let Ue=null;try{Ue=JSON.parse(Ee)}catch{throw new Error("Artifact content is not valid JSON.")}return ct(Ue)}async function y(d,v,M,L="latest"){const k=await p(d,v,M,L);return{data:k,fingerprint:Z(k)}}async function _t(d,v,M){try{const k=await Be(d,v,M);if(k!=null&&k.length){Me.set(M,k);const V=Je(k);if((V==null?void 0:V.version)!=null)return V.version}}catch(k){console.warn("[Blockscape] compare-version: unable to fetch versions list",k)}try{const k=await Ke(d,v,M);if((k==null?void 0:k.version)!=null)return k.version}catch(k){console.warn("[Blockscape] compare-version: unable to fetch metadata",k)}const L=Me.get(M);if(L&&L.length){const k=Je(L);if((k==null?void 0:k.version)!=null)return k.version}return"latest"}async function de(d,v,M,L){if(!R.useSemver)return null;if(!L)return"1.0.0";try{const k=await Be(d,v,M);return It(k)}catch(k){throw new Error(`Unable to compute next semantic version: ${k.message}`)}}function gt(d=document){se=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),z=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),j=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),re=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),fe=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),st=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),Fe=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),We=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),je=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),D=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function Mn(){R.baseUrl=he((re==null?void 0:re.value)??R.baseUrl),R.groupId=((fe==null?void 0:fe.value)??"").trim(),R.authToken=((st==null?void 0:st.value)??"").trim(),Ae(),ye()}function W(d){R.enabled=d!==!1,Ae(),ye(),mt()}function Xe(){W(Fe?Fe.checked:Aa)}function Wt(){R.useSemver=We?We.checked:La,Ae(),ye()}function pt(){[re,fe,st].forEach(d=>{d&&d.addEventListener("input",Mn)}),se&&se.addEventListener("click",()=>{Cn()}),z&&z.addEventListener("click",()=>{jt()}),Fe&&Fe.addEventListener("change",Xe),We&&We.addEventListener("change",Wt),j&&j.addEventListener("click",xn),D&&D.addEventListener("click",d=>{const v=d.target.closest("[data-artifact-version]");if(v){d.stopPropagation();const k=v.dataset.artifactId,V=v.dataset.artifactVersion;k&&V&&rn(k,V);return}const M=d.target.closest("[data-artifact-load-all]");if(M){d.stopPropagation(),M.dataset.artifactId&&sn();return}const L=d.target.closest("[data-artifact-trigger]");if(L){const k=L.dataset.artifactId;if(!k)return;lo(k)}})}function In(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function Kt(d){if(!d)return;d.innerHTML="";const v=In();d.appendChild(v),gt(d),pt(),ye()}function an(d){if(!D)return;if(D.innerHTML="",!d.length){X("No artifacts found in this group.");return}const v=k=>{const V=document.createElement("section");V.className="apicurio-artifact-section";const Q=document.createElement("h3");Q.textContent=k,V.appendChild(Q);const K=document.createElement("ul");return K.className="apicurio-artifact-list",V.appendChild(K),{section:V,list:K}},M=v("Series artifacts"),L=v("Artifacts");d.forEach(k=>{if(!(k!=null&&k.artifactId))return;const Q=k._groupId&&k._groupId.endsWith(is)?M.list:L.list,K=document.createElement("li"),Ie=document.createElement("button");Ie.type="button",Ie.className="apicurio-artifact",Ie.dataset.artifactId=k.artifactId,Ie.dataset.artifactTrigger="toggle";const ue=document.createElement("span");ue.className="apicurio-artifact-title",ue.textContent=k.artifactId,Ie.appendChild(ue);const Ee=[];if(k.name&&Ee.push(k.name),k.version!=null&&Ee.push(`v${k.version}`),k.type&&Ee.push(k.type),k._groupId&&Ee.push(k._groupId),Ee.length){const $e=document.createElement("span");$e.className="apicurio-artifact-meta",$e.textContent=Ee.join(" • "),Ie.appendChild($e)}if(k.description){const $e=document.createElement("span");$e.className="apicurio-artifact-meta",$e.textContent=k.description,Ie.appendChild($e)}K.appendChild(Ie);const Ue=document.createElement("div");Ue.className="apicurio-version-list",Ue.dataset.versionPanel=k.artifactId,Ue.hidden=!0;const ft=document.createElement("p");ft.className="apicurio-hint",ft.textContent="Click to load the latest or open versions.",Ue.appendChild(ft),K.appendChild(Ue),Q.appendChild(K)}),M.list.children.length&&D.appendChild(M.section),L.list.children.length&&D.appendChild(L.section)}function Dn(d){return D?D.querySelector(`[data-version-panel="${d}"]`):null}function St(d,v){if(!d||(d.innerHTML="",!v))return;const M=document.createElement("p");M.className="apicurio-hint",M.textContent=v,d.appendChild(M)}function pn(d,v){const M=Dn(d);if(M){if(M.innerHTML="",!v.length){St(M,"No versions found for this artifact.");return}v.forEach(L=>{const k=document.createElement("button");k.type="button",k.className="apicurio-version-button",k.dataset.artifactId=d,k.dataset.artifactVersion=L.version;const V=[`Version ${L.version}`];if(L.createdOn){const Q=new Date(L.createdOn);isNaN(Q)||V.push(Q.toISOString().slice(0,10))}k.textContent=V.join(" — "),M.appendChild(k)})}}async function lo(d){const v=Dn(d);if(!v)return;if(v.dataset.open==="true"){v.hidden=!0,v.dataset.open="false";return}if(v.hidden=!1,v.dataset.open="true",v.dataset.loaded!=="true"){if(!Se()){St(v,"Enter registry details first.");return}St(v,"Loading versions…");try{const L=he(R.baseUrl),k=me.get(d),V=R.groupId.trim(),Q=(k==null?void 0:k._groupId)||V,K=await Be(L,Q,d);Me.set(d,K),v.dataset.loaded="true",pn(d,K)}catch(L){console.error("[Blockscape] failed to load versions",L),St(v,`Unable to fetch versions: ${L.message}`)}}}function _n(d,v){var L;const M=r.findIndex(k=>k.apicurioArtifactId===d);if(M!==-1){const k=r[M].id;r[M]={...v,id:k||v.id},((L=r[M].apicurioVersions)==null?void 0:L.length)>1&&(r[M].isSeries=!0),m(M)}else r.push(v),m(r.length-1)}async function hn(d,v,M,L){const k=encodeURIComponent(v),V=encodeURIComponent(M),Q=`${d}/groups/${k}/artifacts/${V}`;try{const K=await fetch(Q,{method:"GET",headers:L});if(K.status===404)return!1;if(K.ok)return!0;throw K.status===401||K.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${K.status} while checking the artifact.`)}catch(K){throw K instanceof TypeError?new Error("Network error while contacting Apicurio registry."):K}}async function Cn(){var Q;if(!se||se.dataset.loading==="true")return;if(!le()){x("Apicurio integration is off. Enable it first.","error");return}if(!Se()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=l();if(d<0||!r[d]){x("No active model to push.","error");return}const v=Le(r[d],{fallbackTitle:J(r[d])});if(!v){x("Active model needs an id before pushing.","error");return}const M=he(R.baseUrl),L=R.groupId.trim(),k=JSON.stringify(r[d].data,null,2),V=Re();se.dataset.loading="true",se.textContent="Pushing…",se.disabled=!0,x("Pushing to Apicurio…","muted");try{const K=await hn(M,L,v,V),Ie=Z(r[d].data);if(K)try{const ze=await _t(M,L,v),{data:At,fingerprint:vt}=await y(M,L,v,ze);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",ze),console.log("local fingerprint",Ie),console.log("registry fingerprint",vt),console.log("local payload",r[d].data),console.log("registry payload",At),console.groupEnd(),Ie&&vt&&Ie===vt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){x("Push cancelled (content matches the latest registry version).","muted");return}x("Pushing identical content by user choice.","muted")}else vt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(ze){console.warn("[Blockscape] unable to compare registry content before push",ze),x("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const ue=R.useSemver?await de(M,L,v,K):null;if(R.useSemver&&!ue)throw new Error("Semantic versioning is enabled but no version could be computed.");const Ee=encodeURIComponent(L),Ue=encodeURIComponent(v),ft=K?`${M}/groups/${Ee}/artifacts/${Ue}/versions`:`${M}/groups/${Ee}/artifacts`,$e={...V,"Content-Type":"application/json"};ue&&($e["X-Registry-Version"]=ue,x(`Pushing to Apicurio as version ${ue}…`,"muted"));const Ct=K?dt(k,{version:ue}):w(v,k,{title:J(r[d]),description:(Q=r[d].data)==null?void 0:Q.abstract,version:ue}),Tt=await fetch(ft,{method:"POST",headers:$e,body:JSON.stringify(Ct)});if(!Tt.ok){let ze=Tt.statusText||"Unknown error";try{const At=await Tt.text();At&&(ze=At.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Tt.status}): ${ze}`)}let bt=null;try{bt=await Tt.json()}catch{bt=null}const Ve=(bt==null?void 0:bt.version)||(bt==null?void 0:bt.globalId)||"",at=K?"Updated":"Created",qt=Ve?` (version ${Ve})`:"";x(`${at} ${v}${qt}`,"success")}catch(K){console.error("[Blockscape] Apicurio push failed",K),x(`Apicurio push failed: ${K.message}`,"error")}finally{se.dataset.loading="false",ce()}}async function jt(){var ue,Ee;if(!z||z.dataset.loading==="true")return;if(!le()){x("Apicurio integration is off. Enable it first.","error");return}if(!Se()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=l(),v=d>=0?r[d]:null;if(!v||!v.apicurioVersions||v.apicurioVersions.length<2){x("Series push requires a model with multiple versions.","error");return}const M=Le(v,{seriesName:v.title||v.apicurioArtifactName||J(v)});if(!M){x("Active series needs an id before pushing.","error");return}typeof _=="function"&&_(v,{seriesName:v.title||v.apicurioArtifactName||J(v)});const L=he(R.baseUrl),k=R.groupId.trim(),V=v.apicurioVersions.map(Ue=>Ue.data),Q=JSON.stringify(V,null,2),K=Re(),Ie=ot(k);z.dataset.loading="true",z.textContent="Pushing…",z.disabled=!0,x("Pushing series to Apicurio…","muted");try{const Ue=await hn(L,Ie,M,K),ft=Z(V);if(Ue)try{const Yt=await _t(L,Ie,M),{data:Bn,fingerprint:we}=await y(L,Ie,M,Yt);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",Yt),console.log("local fingerprint",ft),console.log("registry fingerprint",we),console.log("local payload (series)",V),console.log("registry payload",Bn),console.groupEnd(),ft&&we&&ft===we){if(!window.confirm("The current registry version matches this series. Push anyway?")){x("Series push cancelled (content matches latest).","muted");return}x("Pushing identical series by user choice.","muted")}else we?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(Yt){console.warn("[Blockscape] unable to compare registry content before series push",Yt),x("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const $e=R.useSemver?await de(L,Ie,M,Ue):null;if(R.useSemver&&!$e)throw new Error("Semantic versioning is enabled but no version could be computed.");const Ct=encodeURIComponent(Ie),Tt=encodeURIComponent(M),bt=Ue?`${L}/groups/${Ct}/artifacts/${Tt}/versions`:`${L}/groups/${Ct}/artifacts`,Ve={...K,"Content-Type":"application/json"};$e&&(Ve["X-Registry-Version"]=$e,x(`Pushing series to Apicurio as version ${$e}…`,"muted"));const at=Ue?dt(Q,{version:$e}):w(M,Q,{title:v.apicurioArtifactName||((ue=v.data)==null?void 0:ue.title)||M,description:(Ee=v.data)==null?void 0:Ee.abstract,version:$e}),qt=await fetch(bt,{method:"POST",headers:Ve,body:JSON.stringify(at)});if(!qt.ok){let Yt=qt.statusText||"Unknown error";try{const Bn=await qt.text();Bn&&(Yt=Bn.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${qt.status}): ${Yt}`)}let ze=null;try{ze=await qt.json()}catch{ze=null}const At=(ze==null?void 0:ze.version)||(ze==null?void 0:ze.globalId)||"",vt=Ue?"Updated":"Created",wt=At?` (version ${At})`:"";x(`${vt} ${M} series${wt}`,"success")}catch(Ue){console.error("[Blockscape] Apicurio series push failed",Ue),x(`Apicurio series push failed: ${Ue.message}`,"error")}finally{z.dataset.loading="false",ce()}}async function xn(){if(!j||j.dataset.loading==="true")return;if(!le()){x("Enable Apicurio integration to list artifacts.","error");return}if(!Se()){x("Enter registry base URL and group ID before listing.","error");return}const d=he(R.baseUrl),v=R.groupId.trim(),M=ot(v),L=[{groupId:v,label:"base"},{groupId:M,label:"series"}];j.dataset.loading="true",j.textContent="Listing…",j.disabled=!0,x("Listing artifacts…","muted"),X("Contacting registry…");try{const k=Re();k.Accept="application/json";const V=[];for(const K of L){const Ie=encodeURIComponent(K.groupId),ue=`${d}/groups/${Ie}/artifacts?limit=50&offset=0`,Ee=await fetch(ue,{method:"GET",headers:k});if(!Ee.ok){let $e=Ee.statusText||"Unknown error";try{const Ct=await Ee.text();Ct&&($e=Ct.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${K.groupId} (${Ee.status}): ${$e}`);continue}const Ue=await Ee.json(),ft=it(Ue).filter($e=>$e&&$e.artifactId);ft.forEach($e=>{$e&&($e._groupId=K.groupId)}),V.push(...ft)}me.clear(),Me.clear(),V.forEach(K=>{K!=null&&K.artifactId&&me.set(K.artifactId,K)}),an(V);const Q=V.length;x(Q?`Found ${Q} artifact${Q===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",Q?"success":"muted")}catch(k){console.error("[Blockscape] failed to list artifacts",k),ve("Unable to list artifacts."),x(`Listing failed: ${k.message}`,"error")}finally{j.dataset.loading="false",ce()}}async function rn(d,v=null){var Ue,ft,$e,Ct,Tt,bt;if(!d)return;if(!le()){x("Enable Apicurio integration to load artifacts.","error");return}if(!Se()){x("Enter registry connection details before loading artifacts.","error");return}const M=he(R.baseUrl),L=R.groupId.trim(),k=d&&((Ue=me.get(d))==null?void 0:Ue._groupId)||L;let V=me.get(d);const Q=async()=>{try{const Ve=await Ke(M,k,d);return Ve!=null&&Ve.artifactId&&me.set(d,Ve),Ve}catch(Ve){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",Ve),Ve}};if(!V)try{V=await Q()}catch(Ve){x(`Failed to fetch artifact metadata: ${Ve.message}`,"error");return}const K=Me.get(d)||[];let Ie="latest",ue="latest";if(v)Ie=v,ue=v;else{if(!V||V.version==null)try{V=await Q()}catch(Ve){x(`Failed to fetch artifact metadata: ${Ve.message}`,"error");return}Ie=(V==null?void 0:V.version)||"latest",ue=(V==null?void 0:V.version)||"latest"}const Ee=K.find(Ve=>String(Ve.version)===String(Ie));(Ee==null?void 0:Ee.version)!=null&&(ue=Ee.version),x(`Loading artifact ${d}…`,"muted");try{const Ve=await p(M,k,d,Ie),at=me.get(d)||V||{},qt=Array.isArray(Ve);let ze=null;if(qt){const At=Ve.map((wt,Yt)=>(T(wt,{titleHint:at.name||d,idHint:d}),{version:String(Yt+1),data:wt,createdOn:(Ee==null?void 0:Ee.createdOn)||at.createdOn}));ze={id:C(),title:(($e=(ft=At[0])==null?void 0:ft.data)==null?void 0:$e.title)||at.name||d,data:(Ct=At[0])==null?void 0:Ct.data,apicurioArtifactId:d,apicurioArtifactName:at.name||"",apicurioVersions:At,apicurioActiveVersionIndex:0,isSeries:!0};const vt=((Tt=at==null?void 0:at.properties)==null?void 0:Tt.seriesId)||d;typeof _=="function"&&_(ze,{seriesName:vt,fallbackTitle:vt}),x(`Loaded series artifact ${d}.`,"success")}else{T(Ve,{titleHint:at.name||d,idHint:d});const At={version:ue,data:Ve,createdOn:(Ee==null?void 0:Ee.createdOn)||at.createdOn};ze={id:C(),title:Ve.title||at.name||d,data:Ve,apicurioArtifactId:d,apicurioArtifactName:at.name||"",apicurioVersions:[At],apicurioActiveVersionIndex:0};const vt=(bt=at==null?void 0:at.properties)==null?void 0:bt.seriesId;vt&&typeof _=="function"&&_(ze,{seriesName:vt,fallbackTitle:vt});const wt=ue?` (version ${ue})`:"";x(`Loaded artifact ${d}${wt}.`,"success")}_n(d,ze)}catch(Ve){console.error("[Blockscape] failed to load artifact",Ve),x(`Failed to load artifact: ${Ve.message}`,"error")}}async function sn(d){}return{hydrateConfig:ge,mount:Kt,updateAvailability:ce,isEnabled:le,setEnabled:W,onEnabledChange:O}}const Gt={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Qn(r,l){if(typeof r!="function")throw new Error(`[itemEditor] expected ${l} to be a function`)}function gc(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}const Na=1,Ma=4;function bc(r){if(r==null)return null;const l=Number(r);if(!Number.isFinite(l))return null;const m=Math.round(l);return m<Na||m>Ma?null:m}function wc(r,{excludeId:l}={}){if(!r)return[];const m=r.split(/[\s,]+/).map(_=>_.trim()).filter(Boolean),T=[];return m.forEach(_=>{l&&_===l||T.includes(_)||T.push(_)}),T}function vc(r,l,m){if(!l||!m||l===m)return;((r==null?void 0:r.categories)||[]).forEach(_=>{(_.items||[]).forEach(G=>{Array.isArray(G.deps)&&(G.deps=G.deps.map(te=>te===l?m:te))})})}function yc({findItemAndCategoryById:r,collectAllItemIds:l,updateItemReferences:m,loadActiveIntoEditor:T,rebuildFromActive:_,select:G,onSelectionRenamed:te,makeSlug:J=gc,isAutoIdFromNameEnabled:Z=()=>!0}={}){Qn(r,"findItemAndCategoryById"),Qn(l,"collectAllItemIds"),Qn(m,"updateItemReferences"),Qn(T,"loadActiveIntoEditor"),Qn(_,"rebuildFromActive"),Qn(G,"select"),Qn(J,"makeSlug"),Qn(Z,"isAutoIdFromNameEnabled");const C={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function se(z){if(C.fields.errorEl){if(!z){C.fields.errorEl.hidden=!0,C.fields.errorEl.textContent="";return}C.fields.errorEl.hidden=!1,C.fields.errorEl.textContent=z}}function j(){C.wrapper&&(C.wrapper.hidden=!0,C.wrapper.setAttribute("aria-hidden","true"),se(""),C.categoryId=null,C.itemId=null,C.modelData=null,document.body.classList.remove("item-editor-open"))}function re(){C.wrapper&&(C.wrapper.hidden=!1,C.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var z,D;(z=C.fields.nameInput)==null||z.focus(),(D=C.fields.nameInput)==null||D.select()}))}function fe({force:z}={}){var ie,R;if(!((ie=C.fields)!=null&&ie.idInput)||!((R=C.fields)!=null&&R.nameInput)||!C.autoSyncEnabled||!Z()||!z&&C.autoIdManuallyEdited)return;const D=J(C.fields.nameInput.value||C.itemId||"item");C.fields.idInput.value=D}function st(z){var mt;if(!C.modelData||!C.categoryId||!C.itemId)throw new Error("No item loaded.");const ie=(((mt=C.modelData)==null?void 0:mt.categories)||[]).find(O=>O.id===C.categoryId);if(!ie)throw new Error("Category not found.");ie.items=ie.items||[];const R=ie.items.find(O=>O.id===C.itemId);if(!R)throw new Error("Item not found.");const me=(z.id||"").trim();if(!me)throw new Error("ID is required.");const Me=l(C.modelData);if(me!==R.id&&Me.has(me))throw new Error("Another item already uses that ID.");R.id=me;const he=(z.name||"").trim();R.name=he||R.id;const ot=(z.logo||"").trim();if(ot?R.logo=ot:delete R.logo,z.externalFlag&&!z.external)R.external=!0;else{const O=(z.external??"").toString().trim();O?R.external=O:delete R.external}const Se=(z.color||"").trim();Se?R.color=Se:delete R.color;const le=bc(z.stage);return le!=null?R.stage=le:delete R.stage,R.deps=Array.isArray(z.deps)?z.deps:[],R.id!==z.originalId&&typeof te=="function"&&te(z.originalId,R.id),m(C.modelData,z.originalId,R.id),T(),_(),G(R.id),R.id}function Fe(){if(!C.fields||!C.fields.idInput)return!1;const z=(C.fields.idInput.value||"").trim(),D={originalId:C.itemId,id:z,name:C.fields.nameInput.value||"",logo:C.fields.logoInput.value||"",external:C.fields.externalInput.value||"",externalFlag:C.fields.externalFlagInput.checked,color:C.fields.colorInput.value||"",stage:C.fields.stageInput.value,deps:wc(C.fields.depsInput.value,{excludeId:z})};try{return st(D),j(),!0}catch(ie){return console.warn("[itemEditor] item edit failed",ie),se((ie==null?void 0:ie.message)||"Unable to save item."),!1}}function We(){if(C.wrapper)return C.wrapper;const z=document.createElement("div");z.className="item-editor-modal",z.hidden=!0,z.setAttribute("role","dialog"),z.setAttribute("aria-modal","true");const D=document.createElement("div");D.className="item-editor-modal__backdrop",z.appendChild(D);const ie=document.createElement("div");ie.className="item-editor",z.appendChild(ie);const R=document.createElement("div");R.className="item-editor__header";const me=document.createElement("h2");me.className="item-editor__title",me.textContent="Edit item";const Me=document.createElement("button");Me.type="button",Me.className="item-editor__close",Me.setAttribute("aria-label","Close item editor"),Me.textContent="×",R.appendChild(me),R.appendChild(Me),ie.appendChild(R);const he=document.createElement("form");he.className="item-editor__form",ie.appendChild(he);const ot=document.createElement("div");ot.className="item-editor__meta",ot.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',he.appendChild(ot);const Se=document.createElement("div");Se.className="item-editor__error",Se.hidden=!0,he.appendChild(Se);const le=(Je,ct,Ke)=>{const Be=document.createElement("label");Be.className="item-editor__field";const p=document.createElement("span");if(p.className="item-editor__label",p.textContent=Je,Be.appendChild(p),ct.classList.add("item-editor__control"),Be.appendChild(ct),Ke){const y=document.createElement("div");y.className="item-editor__hint",y.textContent=Ke,Be.appendChild(y)}return Be},mt=document.createElement("input");mt.type="text",mt.required=!0,he.appendChild(le("ID",mt,"Unique identifier used for dependencies."));const O=document.createElement("input");O.type="text",he.appendChild(le("Name",O,"Visible label shown on the tile."));const Y=document.createElement("input");Y.type="url",Y.inputMode="url",Y.placeholder="https://…",he.appendChild(le("Logo URL",Y,"Optional image URL."));const x=document.createElement("input");x.type="url",x.inputMode="url",x.placeholder="https://…",he.appendChild(le("External link",x,"Shown with ↗ icon and in preview."));const X=document.createElement("div");X.className="item-editor__checkbox";const ve=document.createElement("label");ve.className="item-editor__checkbox-row";const ce=document.createElement("input");ce.type="checkbox";const ye=document.createElement("span");ye.textContent="Mark as external without link";const Ae=document.createElement("div");Ae.className="item-editor__hint",Ae.textContent="Keeps dashed border even without a URL.",ve.appendChild(ce),ve.appendChild(ye),X.appendChild(ve),X.appendChild(Ae),he.appendChild(X);const ge=document.createElement("input");ge.type="text",ge.placeholder=Gt.color.primary,he.appendChild(le("Color",ge,"Optional badge color (hex or CSS color)."));const Re=document.createElement("input");Re.type="number",Re.min=String(Na),Re.max=String(Ma),Re.inputMode="numeric",Re.placeholder=`${Na}-${Ma}`,he.appendChild(le("Stage",Re,"Optional 1 (far left) to 4 (far right) when Center view is on."));const w=document.createElement("textarea");w.rows=2,w.placeholder="Comma or space separated ids",he.appendChild(le("Dependencies",w,"Use item IDs, separated by commas or spaces."));const dt=document.createElement("div");dt.className="item-editor__checkbox";const ut=document.createElement("label");ut.className="item-editor__checkbox-row";const lt=document.createElement("input");lt.type="checkbox";const Lt=document.createElement("span");Lt.textContent="Sync ID while editing name";const It=document.createElement("div");It.className="item-editor__hint",It.textContent="Turn off to keep typing names without changing the ID.",ut.appendChild(lt),ut.appendChild(Lt),dt.appendChild(ut),dt.appendChild(It),he.appendChild(dt);const Le=document.createElement("div");Le.className="item-editor__actions";const it=document.createElement("button");it.type="button",it.className="pf-v5-c-button pf-m-tertiary",it.textContent="Cancel";const Nt=document.createElement("button");return Nt.type="submit",Nt.className="pf-v5-c-button pf-m-primary",Nt.textContent="Save",Le.appendChild(it),Le.appendChild(Nt),he.appendChild(Le),C.wrapper=z,C.fields={idInput:mt,nameInput:O,logoInput:Y,externalInput:x,externalFlagInput:ce,colorInput:ge,stageInput:Re,depsInput:w,syncCheckbox:lt,categoryValue:ot.querySelector(".item-editor__meta-value"),errorEl:Se},it.addEventListener("click",j),Me.addEventListener("click",j),D.addEventListener("click",j),mt.addEventListener("input",()=>{C.autoIdManuallyEdited=!0}),O.addEventListener("input",fe),lt.addEventListener("change",()=>{C.autoSyncEnabled=!!lt.checked,C.autoSyncEnabled&&(C.autoIdManuallyEdited=!1,fe({force:!0}))}),he.addEventListener("submit",Je=>{Je.preventDefault(),Fe()}),document.addEventListener("keydown",Je=>{Je.key==="Escape"&&!z.hidden&&(Je.preventDefault(),Je.stopPropagation(),j())}),document.body.appendChild(z),z}function je(z){const D=r(z);if(!D)return!1;We(),C.categoryId=D.category.id,C.itemId=D.item.id,C.modelData=D.modelData,C.autoIdManuallyEdited=!1;const ie=!!Z();return C.autoSyncEnabled=ie,C.fields.categoryValue.textContent=D.category.title||D.category.id,C.fields.idInput.value=D.item.id||"",C.fields.nameInput.value=D.item.name||"",C.fields.logoInput.value=D.item.logo||"",C.fields.externalInput.value=typeof D.item.external=="string"?D.item.external:"",C.fields.externalFlagInput.checked=D.item.external===!0,C.fields.colorInput.value=D.item.color||"",C.fields.stageInput.value=D.item.stage??"",C.fields.depsInput.value=Array.isArray(D.item.deps)?D.item.deps.join(", "):"",C.fields.syncCheckbox.checked=C.autoSyncEnabled,C.fields.syncCheckbox.disabled=!ie,!C.fields.idInput.value&&ie&&fe({force:!0}),se(""),G(D.item.id),re(),!0}return{open:je,hide:j,isOpen:()=>!!C.wrapper&&!C.wrapper.hidden}}function Sc(){return typeof window<"u"&&window.Neutralino&&window.Neutralino.os&&typeof window.Neutralino.os.open=="function"}function li(r){if(!r)return!1;if(Sc())try{return window.Neutralino.os.open(r),!0}catch(l){console.warn("[Blockscape] failed to open external url",r,l)}return window.open(r,"_blank","noopener"),!0}function Ec(r){if(!r||r.startsWith("#")||/^javascript:/i.test(r))return!1;try{const l=new URL(r,window.location.href);return l.protocol==="http:"||l.protocol==="https:"?l.origin!==window.location.origin:!0}catch{return!1}}function kc(r){try{return new URL(r,window.location.href).toString()}catch{return r}}function Ic({menuEl:r,previewEl:l,previewTitleEl:m,previewBodyEl:T,previewActionsEl:_,previewCloseEl:G,escapeHtml:te,onEditItem:J,onChangeColor:Z,selectItem:C,colorPresets:se=[]}={}){const j=r||(()=>{const O=document.createElement("div");return O.className="tile-context-menu",O.hidden=!0,O.setAttribute("aria-hidden","true"),document.body.appendChild(O),O})();let re={x:0,y:0},fe=0,st=Array.isArray(se)?se:[];function Fe(){j&&(j.classList.remove("is-open"),j.hidden=!0,j.setAttribute("aria-hidden","true"),j.innerHTML="")}function We(O=[]){_&&(_.innerHTML="",O.forEach(Y=>{const x=document.createElement("button");x.type="button",x.className="item-preview__action",x.textContent=Y.label||"Action",Y.title&&(x.title=Y.title),x.addEventListener("click",X=>{X.stopPropagation(),typeof Y.onClick=="function"&&Y.onClick(X)}),_.appendChild(x)}),_.hidden=O.length===0)}function je(){Fe(),l&&(l.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),l.setAttribute("aria-hidden","true"),l.hidden=!0,We([]))}function z(O,Y){l&&(re={x:O,y:Y},l.hidden=!1,l.setAttribute("aria-hidden","false"),l.classList.add("is-visible"),D(O,Y))}function D(O,Y){if(!l)return;const x=12;l.style.left=`${O+x}px`,l.style.top=`${Y+x}px`;const X=l.getBoundingClientRect();let ve=X.left,ce=X.top;X.right>window.innerWidth-x&&(ve=Math.max(x,window.innerWidth-X.width-x)),X.bottom>window.innerHeight-x&&(ce=Math.max(x,window.innerHeight-X.height-x)),l.style.left=`${ve}px`,l.style.top=`${ce}px`}function ie(O,Y){var ye;if(!O)return null;const x=O.dataset.id,X=((ye=O.querySelector(".name"))==null?void 0:ye.textContent)||x||"Preview",ve=x?`${x}.html`:"",ce=ve?`items/${ve}`:"";return{id:x,displayName:X,filename:ve,filepath:ce,externalUrl:O.dataset.externalUrl||"",obsidianUrl:O.dataset.obsidianUrl||"",anchorX:(Y==null?void 0:Y.clientX)??0,anchorY:(Y==null?void 0:Y.clientY)??0}}function R(O,Y){const x=document.createElement("button");return x.type="button",x.className="tile-context-menu__item",x.textContent=O,x.addEventListener("click",()=>{Fe(),typeof Y=="function"&&Y()}),x}function me(O){if(!j)return;j.innerHTML="";const Y=document.createElement("div");Y.className="tile-context-menu__list",Y.appendChild(R("File view",()=>he(O))),typeof J=="function"&&Y.appendChild(R("Edit",()=>J(O.id))),typeof Z=="function"&&O.id&&st.forEach(x=>{if(!(x!=null&&x.value))return;const X=x.name||x.value;Y.appendChild(R(`Set color: ${X}`,()=>Z(O.id,x.value)))}),j.appendChild(Y)}function Me(O,Y){if(!j)return;const x=4;j.style.left=`${O+x}px`,j.style.top=`${Y+x}px`,j.hidden=!1,j.setAttribute("aria-hidden","false"),j.classList.add("is-open");const X=j.getBoundingClientRect();let ve=X.left,ce=X.top;X.right>window.innerWidth-x&&(ve=Math.max(x,window.innerWidth-X.width-x)),X.bottom>window.innerHeight-x&&(ce=Math.max(x,window.innerHeight-X.height-x)),j.style.left=`${ve}px`,j.style.top=`${ce}px`}async function he(O){if(!l||!m||!T||!O)return;const Y=++fe,x=[];if(typeof J=="function"&&O.id&&x.push({label:"Edit",title:"Edit this item",onClick:()=>{je(),J(O.id)}}),O.externalUrl&&x.push({label:"Open link ↗",title:O.externalUrl,onClick:()=>li(O.externalUrl)}),O.obsidianUrl&&x.push({label:"Open in Obsidian",title:O.obsidianUrl,onClick:()=>li(O.obsidianUrl)}),We(x),O.id&&typeof C=="function"&&C(O.id),m.textContent=O.displayName,T.innerHTML='<div class="item-preview__status">Loading…</div>',l.classList.remove("item-preview--has-frame"),l.classList.add("item-preview--expanded"),z(O.anchorX,O.anchorY),!O.filepath){T.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',D(re.x,re.y);return}try{const X=await fetch(O.filepath,{cache:"no-cache"});if(!X.ok)throw new Error(`HTTP ${X.status}`);const ve=await X.text();if(Y!==fe)return;if(!ve.trim()){const Ae=te?te(O.filename):O.filename;T.innerHTML=`<div class="item-preview__status">No content in <code>${Ae}</code>.</div>`,D(re.x,re.y);return}const ye=document.createElement("iframe");ye.className="item-preview__frame",ye.title=`${O.displayName} details`,ye.srcdoc=ve,T.innerHTML="",T.appendChild(ye),l.classList.add("item-preview--has-frame"),D(re.x,re.y)}catch(X){if(Y!==fe)return;const ve=te?te(O.displayName):O.displayName;T.innerHTML=`<div class="item-preview__status">No preview available for <strong>${ve}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${O.filepath}`,X),D(re.x,re.y)}}function ot(O,Y){if(!Y)return;O.preventDefault(),O.stopPropagation();const x=ie(Y,O);!x||!x.id||(typeof C=="function"&&C(x.id),me(x),Me(O.clientX,O.clientY))}function Se(O){const Y=O==null?void 0:O.target,x=j&&!j.hidden&&j.contains(Y),X=l&&!l.hidden&&l.contains(Y);!x&&!X&&je()}function le(){!l||l.hidden||D(re.x,re.y)}function mt(){je()}return G&&G.addEventListener("click",je),{handleTileContextMenu:ot,hidePreview:je,hideMenu:Fe,handleDocumentClick:Se,handleWindowResize:le,handleWindowScroll:mt,updateColorPresets:O=>{st=Array.isArray(O)?O:[]}}}function as(r,l="series"){return(r||l).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||l}function kn(r,l="series"){const m=as(r,l).replace(/\./g,"-");return m.replace(/-series$/i,"").replace(/-+$/,"")||m||as(l,"series")}function rs(r,{seriesName:l,fallbackTitle:m="unknown"}={}){var J,Z;const _=[r==null?void 0:r.seriesId,(J=r==null?void 0:r.data)==null?void 0:J.seriesId,r==null?void 0:r.apicurioArtifactId,l,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(Z=r==null?void 0:r.data)==null?void 0:Z.title,m].map(C=>(C??"").toString().trim()),G=_.findIndex(Boolean),te=G!==-1?_[G]:"";return te?(console.log("[Series] deriveSeriesId: picked base",{base:te,sourceIndex:G,candidates:_}),kn(te,m)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:m}),null)}function Jt(r,{seriesName:l,fallbackTitle:m="unknown"}={}){if(!r||typeof r!="object")return null;const T=rs(r,{seriesName:l,fallbackTitle:m});return T?(r.seriesId=T,r.apicurioArtifactId||(r.apicurioArtifactId=T),T):null}function Vn(r,l={}){var _,G;if(!r)return null;const m=r.isSeries||((_=r.apicurioVersions)==null?void 0:_.length)>1||r.seriesId||((G=r.data)==null?void 0:G.seriesId)||r.apicurioArtifactId;if(!m&&!l.force)return null;const T=rs(r,l);return T||(m?kn(l.fallbackTitle||"unknown"):null)}const ss={selectionDimOpacity:.2,selectionDimEnabled:!0},eo={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,l=!0)=>{const m=Math.round((1-r)*100);return l?m===0?"Off":`${m}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function to(r){return r===!0||r==="true"||r===1||r==="1"}function _c(r,{localBackend:l}={}){const m=l&&typeof l.getAutoReloadConfig=="function"&&l.getAutoReloadConfig(),T={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness,stripParentheticalNames:r.stripParentheticalNames};return m&&(T.autoReloadEnabled=!!m.enabled,T.autoReloadIntervalMs=m.intervalMs),T}function Cc(r={},l){var Je,ct,Ke,Be;if(!r||typeof r!="object")return{applied:[]};const m=[],{applyTheme:T,applyTileHoverScale:_,persistTileHoverScale:G,applySelectionDimEnabled:te,persistSelectionDimEnabled:J,applySelectionDimOpacity:Z,persistSelectionDimOpacity:C,applyTileCompactness:se,persistTileCompactness:j,applyTitleWrapMode:re,persistTitleWrapMode:fe,applyTitleHoverWidthMultiplier:st,persistTitleHoverWidthMultiplier:Fe,applyTitleHoverTextPortion:We,persistTitleHoverTextPortion:je,applyLinkThickness:z,persistLinkThickness:D,applyDepColor:ie,persistDepColor:R,applyRevdepColor:me,persistRevdepColor:Me,applyObsidianLinksEnabled:he,persistObsidianLinksEnabled:ot,applyObsidianLinkMode:Se,persistObsidianLinkMode:le,applyObsidianVaultName:mt,persistObsidianVaultName:O,applyAutoIdFromNameEnabled:Y,persistAutoIdFromNameEnabled:x,applySeriesNavDoubleClickWait:X,persistSeriesNavDoubleClickWait:ve,applyCenterItems:ce,persistCenterItems:ye,applyStripParentheticalNames:Ae,persistStripParentheticalNames:ge,localBackend:Re,ui:w,refreshObsidianLinks:dt,scheduleOverlaySync:ut,selection:lt,select:Lt,clearStyles:It,drawLinks:Le,applyReusedHighlights:it,current:Nt}=l;if(r.theme){const y=((T==null?void 0:T(r.theme))||r.theme)==="dark";(Je=l.ui)!=null&&Je.themeToggle&&(l.ui.themeToggle.checked=y),(ct=l.ui)!=null&&ct.tabThemeToggle&&(l.ui.tabThemeToggle.checked=y),m.push("theme")}if(r.hoverScale!=null){const p=_(parseFloat(r.hoverScale));G(p),w!=null&&w.hoverScaleInput&&(w.hoverScaleInput.value=String(p)),w!=null&&w.hoverScaleValue&&(w.hoverScaleValue.textContent=eo.hoverScale(p)),lt&&ut(),m.push("hoverScale")}if(r.selectionDimEnabled!=null){const p=te(to(r.selectionDimEnabled));J(p),w!=null&&w.selectionDimToggle&&(w.selectionDimToggle.checked=p),w!=null&&w.selectionDimInput&&(w.selectionDimInput.disabled=!p),w!=null&&w.selectionDimValue&&(w.selectionDimValue.textContent=eo.selectionDimming(Nt.selectionDimOpacity??ss.selectionDimOpacity,p)),m.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const p=Z(parseFloat(r.selectionDimOpacity));C(p),w!=null&&w.selectionDimInput&&(w.selectionDimInput.value=String(p)),w!=null&&w.selectionDimValue&&(w.selectionDimValue.textContent=eo.selectionDimming(p,Nt.selectionDimEnabled??ss.selectionDimEnabled)),m.push("selectionDimOpacity")}if(r.tileCompactness!=null){const p=se(parseFloat(r.tileCompactness));j(p),w!=null&&w.tileCompactnessInput&&(w.tileCompactnessInput.value=String(p)),w!=null&&w.tileCompactnessValue&&(w.tileCompactnessValue.textContent=eo.compactness(p)),lt&&ut(),m.push("tileCompactness")}if(r.titleWrapMode){const p=re(r.titleWrapMode);fe(p),w!=null&&w.titleWrapInput&&(w.titleWrapInput.checked=p!=="nowrap"),m.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const p=st(parseFloat(r.titleHoverWidthMultiplier));Fe(p),w!=null&&w.titleWidthInput&&(w.titleWidthInput.value=String(p)),w!=null&&w.titleWidthValue&&(w.titleWidthValue.textContent=eo.titleWidth(p)),m.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const p=We(parseFloat(r.titleHoverTextPortion));je(p),w!=null&&w.titleZoomInput&&(w.titleZoomInput.value=String(p)),w!=null&&w.titleZoomValue&&(w.titleZoomValue.textContent=eo.titleZoomPortion(p)),m.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const p=he(to(r.obsidianLinksEnabled));ot(p),w!=null&&w.obsidianToggle&&(w.obsidianToggle.checked=p),(Ke=w==null?void 0:w.obsidianModeInputs)==null||Ke.forEach(y=>{y.disabled=!p}),w!=null&&w.obsidianVaultInput&&(w.obsidianVaultInput.disabled=!p),dt==null||dt(),m.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const p=Se(r.obsidianLinkMode);le(p),(Be=w==null?void 0:w.obsidianModeInputs)==null||Be.forEach(y=>{y.checked=y.value===p}),dt==null||dt(),m.push("obsidianLinkMode")}if(r.obsidianVault!=null){const p=mt(r.obsidianVault);O(p),w!=null&&w.obsidianVaultInput&&(w.obsidianVaultInput.value=p),dt==null||dt(),m.push("obsidianVault")}if(r.colorPresets&&(typeof l.setColorPresets=="function"&&l.setColorPresets(r.colorPresets),m.push("colorPresets")),r.linkThickness){const p=z==null?void 0:z(r.linkThickness);p&&(D==null||D(p),w!=null&&w.linkThicknessInput&&(w.linkThicknessInput.value=p),m.push("linkThickness"))}if(r.stripParentheticalNames!=null){const p=Ae==null?void 0:Ae(to(r.stripParentheticalNames));ge==null||ge(p),w!=null&&w.stripParentheticalToggle&&(w.stripParentheticalToggle.checked=p),m.push("stripParentheticalNames")}if(r.depColor){const p=ie==null?void 0:ie(r.depColor);p&&(R==null||R(p),w!=null&&w.depColorInput&&(w.depColorInput.value=p),m.push("depColor"))}if(r.revdepColor){const p=me==null?void 0:me(r.revdepColor);p&&(Me==null||Me(p),w!=null&&w.revdepColorInput&&(w.revdepColorInput.value=p),m.push("revdepColor"))}if(r.autoIdFromName!=null){const p=Y(to(r.autoIdFromName));x(p),w!=null&&w.autoIdToggle&&(w.autoIdToggle.checked=p),m.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const p=X(parseInt(r.seriesNavDoubleClickMs,10));ve(p),w!=null&&w.seriesNavInput&&(w.seriesNavInput.value=String(p)),w!=null&&w.seriesNavValue&&(w.seriesNavValue.textContent=eo.seriesNavWait(p)),m.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&Re&&typeof Re.setAutoReloadEnabled=="function"){const p=to(r.autoReloadEnabled);Re.setAutoReloadEnabled(p),w!=null&&w.autoReloadToggle&&(w.autoReloadToggle.checked=p),w!=null&&w.autoReloadInput&&(w.autoReloadInput.disabled=!p),m.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&Re&&typeof Re.setAutoReloadInterval=="function"){const p=Re.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));w!=null&&w.autoReloadInput&&(w.autoReloadInput.value=String(p)),w!=null&&w.autoReloadValue&&(w.autoReloadValue.textContent=eo.autoReloadInterval(p)),m.push("autoReloadIntervalMs")}if(r.centerItems!=null){const p=ce==null?void 0:ce(to(r.centerItems));ye==null||ye(p),w!=null&&w.tabCenterToggle&&(w.tabCenterToggle.checked=p),m.push("centerItems")}if(r.showSecondaryLinks!=null){const p=to(r.showSecondaryLinks);typeof l.setShowSecondaryLinks=="function"?l.setShowSecondaryLinks(p):l.showSecondaryLinks=p,w!=null&&w.secondaryLinksToggle&&(w.secondaryLinksToggle.checked=p),w!=null&&w.tabSecondaryLinksToggle&&(w.tabSecondaryLinksToggle.checked=p),lt?Lt(lt):(It(),Le()),m.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const p=to(r.showReusedInMap);typeof l.setShowReusedInMap=="function"?l.setShowReusedInMap(p):l.showReusedInMap=p,w!=null&&w.reusedToggle&&(w.reusedToggle.checked=p),it==null||it(),m.push("showReusedInMap")}return{applied:m}}function xc(r,l){const m=new Blob([l],{type:"application/json"}),T=URL.createObjectURL(m),_=document.createElement("a");_.href=T,_.download=r,_.click(),URL.revokeObjectURL(T)}const Ki=typeof{url:On&&On.tagName.toUpperCase()==="SCRIPT"&&On.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function Tc(r={}){console.log("[Blockscape] init");const l={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},m=document.getElementById("jsonBox"),T=document.querySelector(".blockscape-json-panel"),_=document.getElementById("app"),G=document.getElementById("overlay"),te=document.getElementById("tabTooltip"),J=document.getElementById("modelList"),Z=document.getElementById("itemPreview"),C=document.getElementById("urlForm"),se=document.getElementById("urlInput"),j=document.getElementById("loadUrl"),re=Z.querySelector(".item-preview__title"),fe=Z.querySelector(".item-preview__body"),st=Z.querySelector(".item-preview__actions"),Fe=Z.querySelector(".item-preview__close"),We=document.getElementById("downloadJson"),je=document.getElementById("shareModel"),z=document.getElementById("createVersion"),D=document.getElementById("openInEditor"),ie=document.getElementById("copyJson"),R=document.getElementById("copySeries"),me=document.getElementById("pasteJson"),Me=document.getElementById("helpButton"),he=document.getElementById("newPanelButton"),ot=document.getElementById("newBlankButton"),Se=document.getElementById("shortcutHelp"),le=document.getElementById("shortcutHelpList"),mt=document.getElementById("shortcutHelpClose"),O=document.getElementById("shortcutHelpBackdrop"),Y=document.getElementById("newPanel"),x=document.getElementById("newPanelClose"),X=document.getElementById("newPanelBackdrop"),ve=document.getElementById("search"),ce=document.getElementById("searchResults"),ye=document.getElementById("localBackendPanel"),Ae=document.getElementById("localBackendStatus"),ge=document.getElementById("localFileList"),Re=document.getElementById("localDirSelect"),w=document.getElementById("refreshLocalFiles"),dt=document.getElementById("loadLocalFile"),ut=document.getElementById("deleteLocalFile"),lt=document.getElementById("toggleServerSidebar"),Lt=document.getElementById("saveLocalFile"),It=document.getElementById("saveLocalFileAs"),Le=document.getElementById("localSavePath"),it="blockscape:editorPayload",Nt="blockscape:editorTransfer",Je="blockscape:serverSidebarWide",ct=document.title;let Ke=0,Be=0;ye&&(ye.hidden=!0),!l.localBackend&&ye&&(ye.hidden=!0),l.fileOpen||(dt&&(dt.hidden=!0),Re&&(Re.hidden=!0),w&&(w.hidden=!0),ut&&(ut.hidden=!0),ge&&(ge.hidden=!0)),l.fileSave||(Lt&&(Lt.hidden=!0),It&&(It.hidden=!0),Le&&(Le.hidden=!0)),m.value=document.getElementById("seed").textContent.trim();let p=[],y=-1;const _t=hc({models:p,getActiveIndex:()=>y,setActive:Ot,ensureModelMetadata:Rn,getModelId:kt,getSeriesId:Vn,ensureSeriesId:Jt,getModelTitle:Qe,computeJsonFingerprint:aa,uid:po});let de=null,gt=new Map,Mn=new Map,W=null,Xe=null,Wt=null,pt=null,In=!0,Kt=!1,an=!1,Dn="map",St=null,pn=null,lo=!1,_n=null;const hn=2e3;let Cn=null,jt=null,xn=null,rn=null,sn=null,d=null,v=null,M=null,L=null,k="",V=!1,Q=null;const K=new Map;let Ie=null,ue=null,Ee=[],Ue=null;const ft=30,$e=1e3,Ct="blockscape:hoverScale",Tt=1.5,bt=1,Ve=2.5,at="blockscape:selectionDimOpacity",qt="blockscape:selectionDimEnabled",ze=.2,At=.05,vt=1,wt="blockscape:titleWrap",Yt="blockscape:titleHoverWidth",Bn="blockscape:titleHoverTextPortion",we="wrap",Ze=1.3,us=1,ps=1.6,ci=.25,fs=0,ms=.6,hs="blockscape:tileCompactness",di=1,gs=.75,bs=1.25,ws="blockscape:obsidianLinksEnabled",vs="blockscape:obsidianLinkMode",ys="blockscape:obsidianVault",Ba="title",qi="id",Yi=Ba,Ss="blockscape:autoReloadEnabled",Es="blockscape:autoReloadIntervalMs",ui=1e3,ks=500,Is=1e4,_s="blockscape:autoIdFromName",Zi=!0,Cs="blockscape:stripParentheticalNames",Xi=!0,xs="blockscape:colorPresets",Ts="blockscape:centerItems",As="blockscape:theme",Ls=4,Co=1,Qi=4,Ns="0.2rem",xo="light",co="dark",ea="cat:",ta=!1,Ms="blockscape:depColor",Bs="blockscape:revdepColor",Rs="blockscape:linkThickness",$s=6,Ps={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let To=Tt,Un=ze,Hn=!0,Ao=di,Ra=we,Lo=Ze,No=ci,Mo=!1,pi=Yi,Bo="",uo=Zi,fi=Xi,mi=xo,en=[],Et=ta,na="",oa="",hi="m",Ro=null,$a=null;const Os="blockscape:seriesNavDoubleClickMs",gi=900,Vs=300,Ds=4e3;let Fn=gi;const _e={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null,stripParentheticalToggle:null},Gc={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:ui}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},tt=l.localBackend?wd():Gc,Us=l.localBackend?tt.detect():Promise.resolve(!1);_t.hydrateConfig(),Oa(Qc()),Oo(sd(),{silent:!0}),nd(),od(),rd(),Nd(),Md(),$d(),Vd(),Pd(),Od(),Wd(),qd(),zd(),Yd(),Bd(),Rd(),Kd(),td(),nn();function po(){return Math.random().toString(36).slice(2,10)}function Jc(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function Kc(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function qc(e){return Jc(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Yc(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Kc(t)}const Hs=(e,t)=>xc(e,t);function Pa(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function Zc(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await Hl(i),s=JSON.parse(a),c=Pa(s);if(c)return c}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function Xc(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];l.initialSettings&&t.push({type:"inline",snapshot:l.initialSettings}),l.initialSettingsUrl&&t.push({type:"url",url:l.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?Pa(o.snapshot):await Zc(o.url);if(!i)continue;const a=Ga(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function Qc(){if(typeof window>"u"||!window.localStorage)return xo;try{return window.localStorage.getItem(As)===co?co:xo}catch{return xo}}function ed(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(As,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function Oa(e){const t=e===co?co:xo;return mi=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),ed(t),mi}function Fs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ts,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function $o(e){return Et=!!e,_&&(_.classList.toggle("is-center-mode",Et),_.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",Et)}),_.querySelectorAll(".tile-add").forEach(t=>{t.hidden=Et,t.tabIndex=Et?-1:0,t.setAttribute("aria-hidden",Et?"true":"false")}),_.querySelectorAll(".category-add").forEach(t=>{t.hidden=Et,t.tabIndex=Et?-1:0,t.setAttribute("aria-hidden",Et?"true":"false")})),js(),Ws(),de&&(pa(),Tn()),Et}function td(){if(typeof window>"u"||!window.localStorage)return $o(ta);try{const e=window.localStorage.getItem(Ts);return e==null?$o(ta):$o(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),$o(ta)}}function bi(e){if(e==null)return null;const t=Number(e);if(!Number.isFinite(t))return null;const n=Math.round(t);return n<Co||n>Qi?null:n}function Ws(){if(!_)return;const e=`repeat(${Ls}, minmax(var(--blockscape-tile), 1fr))`;_.querySelectorAll(".grid").forEach(t=>{const n=Array.from(t.querySelectorAll(".tile[data-stage]")).map((h,S)=>({tile:h,stage:bi(h.dataset.stage),order:S})),o=n.some(h=>h.stage),i=Et&&o;i?(t.style.gridTemplateColumns=e,t.style.gridAutoFlow="row",t.style.justifyContent="space-between",t.style.justifyItems="start",t.style.columnGap=Ns,t.style.rowGap=Ns):(t.style.removeProperty("grid-template-columns"),t.style.removeProperty("grid-auto-flow"),t.style.removeProperty("justify-content"),t.style.removeProperty("justify-items"),t.style.removeProperty("column-gap"),t.style.removeProperty("row-gap"));const a=h=>{h.style.removeProperty("grid-column"),h.style.removeProperty("grid-row")};if(t.querySelectorAll(".tile").forEach(a),!i)return;const s=n.filter(h=>h.stage).sort((h,S)=>h.stage!==S.stage?h.stage-S.stage:h.order-S.order),c=(h,S,$)=>{if(S.has(h)&&S.get(h)===$)return{col:h,needsNewRow:!0};const A=Ls-1;for(let N=0;N<=A;N+=1){const P=[];h-N>=Co&&P.push(h-N),N!==0&&h+N<=Qi&&P.push(h+N);for(const ee of P)if(!S.has(ee))return{col:ee,needsNewRow:!1}}return{col:null,needsNewRow:!1}};let u=1,g=new Map;s.forEach(({tile:h,stage:S})=>{let $=c(S,g,S);$.needsNewRow&&(u+=1,g=new Map,$=c(S,g,S)),$.col!=null&&(g.set($.col,S),h.style.gridColumn=String($.col),h.style.gridRow=String(u))})}),js()}function js(){$a&&($a.hidden=!Et)}function Po(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function zs(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function Va(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function Gs(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=Po(i[1]);if(a)return Va(a,n);if(t){const s=Po(t);if(s)return Va(s,n)}}return Va(o,n)}function Js(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function Da(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ms,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function Ua(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Bs,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function Ha(e){const t=Gs(e,{fallbackVar:"--color-primary",fallbackColor:Gt.color.primary});return na=t,zs("--blockscape-dep",t),G&&Tn(),na}function Fa(e){const t=Gs(e,{fallbackVar:"--color-danger",fallbackColor:Gt.blockscape.revdep});return oa=t,zs("--blockscape-revdep",t),G&&Tn(),oa}function nd(){const e=Js(Ms),t=Ha(e||Po("--blockscape-dep")||Gt.color.primary);return Da(t),t}function od(){const e=Js(Bs),t=Fa(e||Po("--blockscape-revdep")||Gt.blockscape.revdep);return Ua(t),t}function id(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function ad(){return Ps[hi]||Ps.m}function wi(e){return hi=id(e),Tn(),hi}function Wa(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Rs,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function rd(){if(typeof window>"u"||!window.localStorage)return wi("m");try{const e=window.localStorage.getItem(Rs),t=wi(e||"m");return Wa(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),wi("m")}}function Ks(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return vi();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:vi()}function vi(){return[{name:"Black",value:Gt.color.ink},{name:"White",value:Gt.color.white},{name:"Red",value:Gt.blockscape.revdep},{name:"Green",value:Gt.color.success}]}function sd(){if(typeof window>"u"||!window.localStorage)return vi();try{const e=window.localStorage.getItem(xs);if(!e)return vi();const t=JSON.parse(e);return Ks(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),vi()}}function ld(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(xs,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function Oo(e,{silent:t=!1}={}){return en=Ks(e),ld(en),!t&&typeof Xo=="function"&&Xo(en),Ro==null||Ro(),en}function cd(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function ia(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=fo(e);if(!o)return;const i=p[y],a=fo(i==null?void 0:i.sourcePath),s=t??(a&&a===o?kt(i):null),c=n??(a&&a===o?W:null),u=o.split("/").filter(Boolean).map(S=>encodeURIComponent(S)),g=s?encodeURIComponent(s):null,h=c?encodeURIComponent(c):null;try{const S=new URL(window.location.href),$=new URLSearchParams(S.search);$.delete("load"),$.delete("share");const A=["","server",...u,...g?[g]:[],...h?[h]:[]].join("/").replace(/\/+/g,"/");S.pathname=A,S.search=$.toString()?`?${$.toString()}`:"",S.hash="",window.history.replaceState({},document.title,S.toString())}catch(S){console.warn("[Blockscape] failed to update URL for server path",S)}}function dd(e,{origin:t}={}){if(!(typeof window>"u"||!e))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-path",{detail:{path:e,origin:t}}))}catch(n){console.warn("[Blockscape] failed to notify local save path",n)}}function ud({origin:e}={}){if(!(typeof window>"u"))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-clear",{detail:{origin:e}}))}catch(t){console.warn("[Blockscape] failed to notify local save clear",t)}}function pd(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(P=>P.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex(P=>P.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),c=i.slice(a+1),u=P=>{try{return decodeURIComponent(P)}catch{return P}},g=s.map(u),h=c.map(u),S=g.join("/"),$=fo(S);if(!$)return null;const A=h[0]?h[0].trim():null,N=h[1]?h[1].trim():null;return{path:$,modelId:A||null,itemId:N||null}}function fd(){if(!(typeof window>"u"||!window.location))try{const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(c=>c.toLowerCase()==="server");if(o===-1)return;const i=n.slice(0,o),a=new URLSearchParams(e.search);a.delete("load"),a.delete("share");const s=i.length?`/${i.join("/")}`:"/";e.pathname=s.replace(/\/+/g,"/"),e.search=a.toString()?`?${a.toString()}`:"",e.hash="",window.history.replaceState({},document.title,e.toString())}catch(e){console.warn("[Blockscape] failed to clear server path from URL",e)}}function ja({itemId:e}={}){const t=p[y];if(!(t!=null&&t.sourcePath)){fd();return}ia(t.sourcePath,{modelId:kt(t),itemId:e===void 0?W:e})}function md(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function hd(){if(typeof window>"u"||!window.localStorage)return!0;try{const e=window.localStorage.getItem(Je);return e==null?!0:e==="true"}catch{return!0}}function gd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Je,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist sidebar width",t)}}function qs(e){var t;typeof document>"u"||((t=document.body)==null||t.classList.toggle("blockscape-server-sidebar-wide",!!e),lt&&(lt.setAttribute("aria-pressed",e?"true":"false"),lt.textContent=e?"<":">",lt.title=e?"Switch to thin menu":"Switch to wide menu"))}function bd(e){if(!lt||(lt.hidden=!e,!e))return;let t=hd();qs(t),lt.onclick=()=>{t=!t,gd(t),qs(t)}}function wd(){var ii;const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(I,H={}){console.log("[Blockscape][local-backend]",I,{...e(),...H})}if(md())return t("Disabled on github.io host"),ye&&(ye.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};const n=cd();if(n&&typeof document<"u"&&((ii=document.body)==null||ii.classList.add("blockscape-server-mode")),bd(n),!n||!ye||!Ae)return t("Opt-in flag missing or panel unavailable"),ye&&(ye.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!ye||!Ae)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],c="",u=new Map,g=P(),h=Ne(),S=null,$=!1;const A=new Set;function N(){return A.size>0}function P(){if(typeof window>"u"||!window.localStorage)return!0;try{const I=window.localStorage.getItem(Ss);return I==null?!0:I==="true"}catch{return!0}}function ee(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ss,I?"true":"false")}catch(H){console.warn("[Blockscape] auto-reload: failed to persist",H)}}function Ne(){if(typeof window>"u"||!window.localStorage)return ui;try{const I=window.localStorage.getItem(Es);if(!I)return ui;const H=parseInt(I,10);return ke(H)}catch{return ui}}function ht(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Es,String(I))}catch(H){console.warn("[Blockscape] auto-reload: failed to persist interval",H)}}function ke(I){return Number.isFinite(I)?Math.min(Is,Math.max(ks,I)):ui}function Ce(I){if(!I)return"";const H=I.split("/").filter(Boolean);return H.pop(),H.join("/")}function rt(I,{error:H=!1}={}){Ae.textContent=I,Ae.style.color=H?Gt.color.dangerStrong:"",t("Status",{text:I,error:H})}function Ge(I){return fo(I)}function Dt(I){const H=la(I);return H?{payload:H,isSeries:!0}:{payload:I==null?void 0:I.data,isSeries:!1}}function Zt(){var H;if(y>=0&&((H=p[y])!=null&&H.sourcePath))return p[y].sourcePath;if(y<0)return"blockscape.bs";const I=Qe(p[y])||"blockscape";return`${kn(I,"blockscape")}.bs`}function Ut(){var H;if(!Le)return;Le.placeholder=Zt();const I=(H=p[y])==null?void 0:H.sourcePath;if(I){Le.value=I;return}Le.value&&(Le.value="")}function xe(){if(!Re)return;Re.innerHTML="";const I=document.createElement("option");I.value="",I.textContent="Root (~/blockscape)",Re.appendChild(I),s.forEach(ne=>{const be=document.createElement("option");be.value=ne,be.textContent=ne||"(root)",Re.appendChild(be)});const H=s.includes(c)?c:"";Re.value=H,c=H}function Rt(){if(!ge)return;ge.innerHTML="";const I=a.filter(H=>Ce(H.path)===c);if(!I.length){const H=document.createElement("option");H.disabled=!0,H.textContent="No .bs files found yet",ge.appendChild(H),ge.disabled=!0;return}ge.disabled=!1,I.forEach(H=>{const ne=document.createElement("option");ne.value=H.path;const be=H.mtimeMs?new Date(H.mtimeMs).toLocaleString():"";ne.textContent=be?`${H.path} · ${be}`:H.path,ge.appendChild(ne)}),i&&Array.from(ge.options).forEach(H=>{H.value===i&&(H.selected=!0)}),!ge.value&&ge.options.length&&(ge.options[0].selected=!0)}function An(I){if(!o||!ge)return;if(!I){i="",Array.from(ge.options).forEach(nt=>{nt.selected=!1}),Le&&(Le.value="");return}if(!a.find(nt=>nt.path===I))return;const ne=Ce(I);ne!==c&&(c=ne,xe()),Rt(),Array.from(ge.options).forEach(nt=>{nt.selected=nt.value===I});const be=Array.from(ge.options).find(nt=>nt.value===I);be!=null&&be.scrollIntoView&&be.scrollIntoView({block:"nearest"}),Le&&(Le.value=I)}function qn(){S&&(clearInterval(S),S=null)}function $t(){qn(),!(!o||!g||N())&&(S=setInterval(dn,h))}function zt(I){if(!I)return;const H=A.size;A.add(I),A.size!==H&&(t("Auto-reload paused",{reason:I}),$t())}function ln(I){if(!I)return;A.delete(I)&&(t("Auto-reload resumed",{reason:I}),$t())}async function cn(I){const H=p.findIndex(ne=>ne.sourcePath===I);if(H!==-1)try{const ne=await fetch(`/api/file?path=${encodeURIComponent(I)}`,{cache:"no-store"});if(!ne.ok)throw new Error(`HTTP ${ne.status}`);const be=await ne.json(),nt=JSON.stringify(be.data??be,null,2),qe=zn(nt,I,{seriesTitleOverride:`${I} series`});if(!qe.length)return;const oe=qe[0];if(oe.sourcePath=I,Rn(oe,{titleHint:Qe(p[H]),idHint:kt(p[H])}),oe.isSeries){const Pe=oe.title||Qe(oe)||Qe(p[H]),yt=kn(Pe||"unknown");mo(oe,yt),Jt(oe,{seriesName:Pe||"unknown",fallbackTitle:"unknown"})}p[H]={...p[H],...oe,title:oe.title||Qe(oe),data:oe.data,sourcePath:I},H===y?(Vt(),Bt()):jn(),console.log("[Blockscape] auto-reloaded model from",I)}catch(ne){console.warn("[Blockscape] auto-reload failed for",I,ne)}}async function dn(){if(!(!o||!g||N()||$)){$=!0;try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);const ne=((await I.json()).files||[]).slice().sort((oe,Pe)=>{const yt=(oe==null?void 0:oe.mtimeMs)||0,mn=(Pe==null?void 0:Pe.mtimeMs)||0;return yt===mn?(oe.path||"").localeCompare(Pe.path||""):mn-yt}),be=new Map;ne.forEach(oe=>be.set(oe.path,oe.mtimeMs||0));const nt=p.map((oe,Pe)=>({path:oe.sourcePath,idx:Pe})).filter(oe=>oe.path);for(const oe of nt){const Pe=u.get(oe.path)||0;(be.get(oe.path)||0)>Pe&&await cn(oe.path)}a=ne;const qe=new Set;a.forEach(oe=>qe.add(Ce(oe.path))),s=Array.from(qe).filter(oe=>oe!=="").sort(),u=be,xe(),Rt()}catch(I){console.warn("[Blockscape] auto-reload check failed",I)}finally{$=!1}}}function et(I){g=!!I,ee(g),$t()}function ni(I){return h=ke(I),ht(h),$t(),h}function un(I){o=!1,a=[],u=new Map,qn(),Rt(),ye.hidden=!0,I&&rt(I,{error:!0}),t("Panel hidden",{message:I})}async function wo({silent:I=!1}={}){try{t("Health check start");const H=await fetch("/api/health",{cache:"no-store"});if(!H.ok)throw new Error(`HTTP ${H.status}`);const ne=await H.json();if(o=!!(ne!=null&&ne.ok),!o)throw new Error("Health check failed");return ye.hidden=!1,I||rt(ne.root?`Local server ready (root: ${ne.root})`:"Local server ready"),t("Health check ok",{payload:ne}),!0}catch(H){return I||console.log("[Blockscape] local backend health failed",H),un("Local server unavailable"),!1}}async function gn(){if(o&&ge){rt("Loading files…");try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);a=((await I.json()).files||[]).slice().sort((qe,oe)=>{const Pe=(qe==null?void 0:qe.mtimeMs)||0,yt=(oe==null?void 0:oe.mtimeMs)||0;return Pe===yt?(qe.path||"").localeCompare(oe.path||""):yt-Pe});const ne=new Set;a.forEach(qe=>{ne.add(Ce(qe.path))}),s=Array.from(ne).filter(qe=>qe!=="").sort(),c&&!ne.has(c)&&(c=""),!c&&i&&(c=Ce(i)),u=new Map(a.map(qe=>[qe.path,qe.mtimeMs||0])),xe(),Rt();const be=a.filter(qe=>Ce(qe.path)===c).length,nt=c?`~/blockscape/${c}`:"~/blockscape";rt(be?`Browsing ${be} file(s) in ${nt}`:`No .bs files in ${nt} yet`)}catch(I){console.warn("[Blockscape] local backend refresh failed",I),un("Local server unavailable")}}}async function lr(){o=!1,un(),rt("Checking for local server…");try{return t("Detect start"),await wo()?(Ut(),await gn(),$t(),!0):!1}catch(I){return o=!1,console.log("[Blockscape] local backend not detected",I),t("Detect failed",{err:I}),!1}}async function Ci(){if(!o||!ge)return;const I=Array.from(ge.selectedOptions||[]).map(ne=>ne.value).filter(Boolean).sort((ne,be)=>ne.localeCompare(be));if(!I.length){alert("Select one or more files to load from ~/blockscape.");return}let H=null;for(const ne of I)try{rt(`Loading ${ne}…`);const be=await Ys(ne);H==null&&(H=(be==null?void 0:be.firstIndex)??null),i=ne,ia(ne)}catch(be){console.error("[Blockscape] failed to load from local server",be),alert(`Local load failed for ${ne}: ${be.message}`)}H!=null&&Ot(H),rt(`Loaded ${I.length} file(s)`),Rt()}async function xi(){if(!o||!ge)return;const I=Array.from(ge.selectedOptions||[]).map(oe=>oe.value).filter(Boolean).sort((oe,Pe)=>oe.localeCompare(Pe));if(!I.length){alert("Select one or more files to delete from ~/blockscape.");return}const H=I.length,ne=H===1?I[0]:`${H} file(s)`,be=H===1?`Delete "${ne}" from ~/blockscape? This cannot be undone.`:`Delete ${ne} from ~/blockscape? This cannot be undone.`;if(!window.confirm(be))return;const nt="local-files-delete";zt(nt);const qe=[];try{rt(`Deleting ${ne}…`);for(const oe of I)try{const Pe=await fetch(`/api/file?path=${encodeURIComponent(oe)}`,{method:"DELETE"});if(!Pe.ok)throw new Error(`HTTP ${Pe.status}`);oe===i&&(i=""),(Le==null?void 0:Le.value)===oe&&(Le.value="")}catch(Pe){qe.push(oe),console.warn("[Blockscape] local delete failed",oe,Pe)}await gn(),qe.length?rt(`Deleted ${H-qe.length} file(s), ${qe.length} failed`,{error:!0}):rt(`Deleted ${H} file(s)`)}finally{ln(nt)}}async function oi(I,{statusPrefix:H="Saved to",updateInput:ne=!0}={}){if(!o)return;if(y<0){alert("No active model to save.");return}const be=p[y],{payload:nt,isSeries:qe}=Dt(be);if(!nt){alert("No model data to save.");return}const oe=Ge(I);if(!oe){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const Pe=JSON.stringify(nt,null,2);rt(`Saving ${qe?"series":"map"} to ${oe}…`);const mn=await fetch(`/api/file?path=${encodeURIComponent(oe)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:Pe});if(!mn.ok)throw new Error(`HTTP ${mn.status}`);const on=await mn.json();i=on.path||oe,be.sourcePath=on.path||oe,ne&&Le&&(Le.value=on.path||oe),ia(on.path||oe),rt(`${H} ${on.path||oe}`),await gn()}catch(Pe){console.error("[Blockscape] local save failed",Pe),alert(`Local save failed: ${Pe.message}`),un("Local server unavailable")}}async function Ti(){var H;const I=Ge(Le==null?void 0:Le.value)||Ge((H=p[y])==null?void 0:H.sourcePath)||Zt();if(!I){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await oi(I,{statusPrefix:"Saved to"})}async function no(){var be;if(!o)return;if(y<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const I=Ge((be=p[y])==null?void 0:be.sourcePath)||Zt(),H=window.prompt("Save active map as (under ~/blockscape):",I);if(H==null)return;const ne=Ge(H);if(!ne){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await oi(ne,{statusPrefix:"Saved to"})}async function Ai(I,H,{refreshAfter:ne=!0,statusPrefix:be="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(I)||I<0)return{ok:!1,error:"Invalid model index"};const nt=p[I],{payload:qe,isSeries:oe}=Dt(nt);if(!qe)return{ok:!1,error:"Model has no data"};const Pe=Ge(H)||Ge(nt==null?void 0:nt.sourcePath)||Zt();if(!Pe)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const yt=JSON.stringify(qe,null,2);rt(`Saving ${oe?"series":"map"} to ${Pe}…`);const on=await fetch(`/api/file?path=${encodeURIComponent(Pe)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:yt});if(!on.ok)throw new Error(`HTTP ${on.status}`);const Yn=await on.json();return i=Yn.path||Pe,nt.sourcePath=Yn.path||Pe,I===y&&Ut(),rt(`${be} ${Yn.path||Pe}`),ne&&await gn(),{ok:!0,path:Yn.path||Pe}}catch(yt){return console.error("[Blockscape] local save failed",yt),un("Local server unavailable"),{ok:!1,error:yt.message}}}if(w&&(w.onclick=()=>gn()),dt&&(dt.onclick=()=>Ci()),ut&&(ut.onclick=()=>xi()),Lt&&(Lt.onclick=()=>Ti()),It&&(It.onclick=()=>no()),ge&&Le&&(ge.addEventListener("change",()=>{const I=Array.from(ge.selectedOptions||[])[0];I!=null&&I.value&&(Le.value=I.value)}),ge.addEventListener("dblclick",()=>{Ci()})),Re&&Re.addEventListener("change",()=>{c=Re.value||"",Rt()}),ye){const I="local-files-panel-focus",H="local-files-panel-pointer";let ne=!1,be=!1;ye.addEventListener("focusin",()=>{ne||(ne=!0,zt(I))}),ye.addEventListener("focusout",nt=>{if(!ne)return;const qe=nt.relatedTarget;qe&&ye.contains(qe)||(ne=!1,ln(I))}),ye.addEventListener("pointerenter",()=>{be||(be=!0,zt(H))}),ye.addEventListener("pointerleave",()=>{be&&(be=!1,ln(H))})}return{detect:lr,refresh:gn,updateActiveSavePlaceholder:Ut,isAvailable:()=>o,highlightSource:An,saveModelByIndex:Ai,getAutoReloadConfig:()=>({enabled:g,intervalMs:h,available:o}),setAutoReloadEnabled:et,setAutoReloadInterval:ni}}async function Ys(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=zn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let c=null;return s.forEach((u,g)=>{if(u.sourcePath=e,u.isSeries&&!u.title){const $=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");u.title=$}const h=$n(u,{versionLabel:s.length>1?`${t} #${g+1}`:t});c==null&&(c=h)}),{firstIndex:c,total:s.length}}async function Zs(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function vd(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function tn(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function fo(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function yd(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Sd(e,t){const n=fo(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function za(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function yi(){try{await Us}catch{}return typeof(tt==null?void 0:tt.isAvailable)=="function"?tt.isAvailable():!1}async function Ed(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function kd(e,t){const n=fo(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const c=`${a}-${s}.bs`,u=[...o,c].filter(Boolean).join("/");if(!t.has(u))return u}return null}function Id(e,t="clipboard"){const n=Qe(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=tn(n),i=za();return`${o}-${i}.bs`}function _d(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=yd(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=kn(n||"unknown");return mo(e,o),Jt(e,{seriesName:n,fallbackTitle:n}),!0}function Cd(e){return Number.isFinite(e)?Math.min(Ve,Math.max(bt,e)):Tt}function nn(){if(!_)return;const e=!!W||!!Xe;_.classList.toggle("blockscape-has-selection",e),_.classList.toggle("blockscape-has-item-selection",!!W)}function Vo(e){return To=Cd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",To),To}function xd(e){return Number.isFinite(e)?Math.min(vt,Math.max(At,e)):ze}function Do(e){Un=xd(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Un);const t=Hn?Un:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Un}function Td(e){return Number.isFinite(e)?Math.min(bs,Math.max(gs,e)):di}function Uo(e){return Ao=Td(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",Ao),Ao}function Ad(e){return Number.isFinite(e)?Math.min(ps,Math.max(us,e)):Ze}function Ho(e){return Lo=Ad(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",Lo),Lo}function Ld(e){return Number.isFinite(e)?Math.min(ms,Math.max(fs,e)):ci}function Fo(e){return No=Ld(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",No),No}function Wo(e){const t=e==="nowrap"?"nowrap":"wrap";Ra=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function Xs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ct,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function Nd(){if(typeof window>"u"||!window.localStorage)return Vo(Tt);try{const e=window.localStorage.getItem(Ct);if(!e)return Vo(Tt);const t=parseFloat(e);return Vo(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Vo(Tt)}}function Qs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(at,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function Md(){if(typeof window>"u"||!window.localStorage)return Do(ze);try{const e=window.localStorage.getItem(at);if(!e)return Do(ze);const t=parseFloat(e);return Do(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Do(ze)}}function jo(e){Hn=!!e;const t=Hn?Un:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),_&&_.classList.toggle("blockscape-dimming-disabled",!Hn),Hn}function el(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(qt,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function Bd(){if(typeof window>"u"||!window.localStorage)return jo(!0);try{const e=window.localStorage.getItem(qt);return e==null?jo(!0):jo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),jo(!0)}}function zo(e){return uo=!!e,uo}function tl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(_s,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function Rd(){if(typeof window>"u"||!window.localStorage)return zo(Zi);try{const e=window.localStorage.getItem(_s);return e==null?zo(Zi):zo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),zo(Zi)}}function nl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(hs,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function $d(){if(typeof window>"u"||!window.localStorage)return Uo(di);try{const e=window.localStorage.getItem(hs);if(!e)return Uo(di);const t=parseFloat(e);return Uo(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Uo(di)}}function ol(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Yt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function Pd(){if(typeof window>"u"||!window.localStorage)return Ho(Ze);try{const e=window.localStorage.getItem(Yt);if(!e)return Ho(Ze);const t=parseFloat(e);return Ho(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Ho(Ze)}}function il(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Bn,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function Od(){if(typeof window>"u"||!window.localStorage)return Fo(ci);try{const e=window.localStorage.getItem(Bn);if(!e)return Fo(ci);const t=parseFloat(e);return Fo(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Fo(ci)}}function al(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(wt,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function Vd(){if(typeof window>"u"||!window.localStorage)return Wo(we);try{const e=window.localStorage.getItem(wt);return Wo(e||we)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Wo(we)}}function Dd(e){return Number.isFinite(e)?Math.min(Ds,Math.max(Vs,e)):gi}function Go(e){return Fn=Dd(e),Fn}function Ud(e){In=!!e}function Hd(e){an=!!e}function rl(){return{hoverScale:To,selectionDimOpacity:Un,selectionDimEnabled:Hn,tileCompactness:Ao,titleWrapMode:Ra,titleHoverWidthMultiplier:Lo,titleHoverTextPortion:No,obsidianLinksEnabled:Mo,obsidianLinkMode:pi,obsidianVaultName:Bo,autoIdFromNameEnabled:uo,seriesNavDoubleClickWaitMs:Fn,showSecondaryLinks:In,stripParentheticalNames:fi,centerItems:Et,showReusedInMap:an,theme:mi,colorPresets:en,depColor:na,revdepColor:oa,linkThickness:hi}}function Ga(e,{refreshObsidianLinks:t}={}){return Cc(e,{applyTileHoverScale:Vo,persistTileHoverScale:Xs,applySelectionDimEnabled:jo,persistSelectionDimEnabled:el,applySelectionDimOpacity:Do,persistSelectionDimOpacity:Qs,applyTileCompactness:Uo,persistTileCompactness:nl,applyTitleWrapMode:Wo,persistTitleWrapMode:al,applyTitleHoverWidthMultiplier:Ho,persistTitleHoverWidthMultiplier:ol,applyTitleHoverTextPortion:Fo,persistTitleHoverTextPortion:il,applyObsidianLinksEnabled:Ko,persistObsidianLinksEnabled:dl,applyObsidianLinkMode:Jo,persistObsidianLinkMode:cl,applyObsidianVaultName:Yo,persistObsidianVaultName:ul,applyAutoIdFromNameEnabled:zo,persistAutoIdFromNameEnabled:tl,applySeriesNavDoubleClickWait:Go,persistSeriesNavDoubleClickWait:ll,localBackend:tt,ui:_e,refreshObsidianLinks:t,scheduleOverlaySync:Wn,selection:W,select:Mt,clearStyles:ma,drawLinks:Tn,applyReusedHighlights:rr,setShowSecondaryLinks:Ud,setShowReusedInMap:Hd,applyDepColor:Ha,persistDepColor:Da,applyRevdepColor:Fa,persistRevdepColor:Ua,applyLinkThickness:wi,persistLinkThickness:Wa,applyStripParentheticalNames:qo,persistStripParentheticalNames:Ja,applyTheme:Oa,setColorPresets:Oo,applyCenterItems:$o,persistCenterItems:Fs,current:rl()})}const sl=()=>({version:1,exportedAt:new Date().toISOString(),settings:_c(rl(),{localBackend:tt})}),Fd=e=>{const t=Pa(e);return Ga(t||{})};typeof window<"u"&&(window.__blockscapeSettingsBridge={exportPayload:sl,applyPayload:Fd});function ll(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Os,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function Wd(){if(typeof window>"u"||!window.localStorage)return Go(gi);try{const e=window.localStorage.getItem(Os);if(!e)return Go(gi);const t=parseInt(e,10);return Go(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Go(gi)}}function jd(e){return e===qi?qi:Ba}function Jo(e){return pi=jd(e),pi}function cl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(vs,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function zd(){if(typeof window>"u"||!window.localStorage)return Jo(Yi);try{const e=window.localStorage.getItem(vs);return Jo(e||Yi)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Jo(Yi)}}function Ko(e){return Mo=!!e,Mo}function Gd(e){const t=(e??"").toString();return t.replace(/\s*\([^)]*\)\s*$/,"").trim()||t.trim()}function Si(e){const t=(e&&typeof e=="object"?e.name||e.id:e)||"";return fi?Gd(t):t}function Jd(){if(_&&(_.querySelectorAll(".tile .name").forEach(e=>{var a;const t=e.closest(".tile"),n=(a=t==null?void 0:t.dataset)==null?void 0:a.id,o=n?Zo(n):null,i=o!=null&&o.item?Si(o.item):Si(n);e.textContent=i}),ve&&or(ve.value||""),W)){const e=Zo(W);e!=null&&e.item&&re&&(re.textContent=Si(e.item))}}function qo(e){return fi=!!e,Jd(),fi}function Ja(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Cs,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist strip parentheses",t)}}function Kd(){if(typeof window>"u"||!window.localStorage)return qo(Xi);try{const e=window.localStorage.getItem(Cs);if(e==null)return qo(Xi);const t=qo(e==="1"||e==="true");return Ja(t),t}catch(e){return console.warn("[Blockscape] failed to read strip parentheses",e),qo(Xi)}}function dl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ws,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function qd(){if(typeof window>"u"||!window.localStorage)return Ko(!1);try{const e=window.localStorage.getItem(ws);return e==null?Ko(!1):Ko(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Ko(!1)}}function Yo(e){return Bo=(e??"").toString().trim(),Bo}function ul(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ys,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Yd(){if(typeof window>"u"||!window.localStorage)return Yo("");try{const e=window.localStorage.getItem(ys);return Yo(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Yo("")}}function Zd(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Xd(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function mo(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function Qd(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||ra(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=Vn(e,{seriesName:o,fallbackTitle:o})||kn(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=kn(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,mo(e,s),!0}function Ka(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>Ka(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${Ka(e[o])}`).join(",")}}`}function pl(e){try{return Ka(e)}catch{return""}}function aa(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=pl(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=pl(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const eu=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category (cycles item.stage in Center view)."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function Rn(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=tn(a).replace(/\./g,"-");e.id=s||`model-${po()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function tu(e){var s,c;const t=u=>{const g=(u??"").toString().trim();if(!g)return{base:"",suffix:null};const h=g.match(/^(.*?)-(\d+)$/);return{base:h?h[1]:g,suffix:h?Number.parseInt(h[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const u of n){if(u!=null&&u.isCategoryView)continue;const g=t(((c=u==null?void 0:u.data)==null?void 0:c.id)??(u==null?void 0:u.id)??"");if(g.base){i=g.base;break}}i||(i=tn(Vn(e)||qa(e)||Qe(e,"model")));let a=0;return n.forEach(u=>{var h;if(u!=null&&u.isCategoryView)return;const g=t(((h=u==null?void 0:u.data)==null?void 0:h.id)??(u==null?void 0:u.id)??"");g.base===i&&Number.isFinite(g.suffix)&&g.suffix>a&&(a=g.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function nu(e){return JSON.parse(JSON.stringify(e))}function Qe(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function ra(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=kt(e);return a?`${a} series`:t}return Qe(e,t)}function kt(e){var i;const t=Vn(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function qa(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function ou(e){return e?e.toString().replace(/-series$/i,""):null}function Ya(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<p.length;n++){const o=(kt(p[n])||"").toLowerCase(),i=(qa(p[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function fl(e){var c;if(e<0||e>=p.length||!m)return!0;const t=p[e],n=(m.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Rn(o,{titleHint:Qe(t),idHint:kt(t)});const i=aa(t.data),a=aa(o);if(i===a)return!0;t.data=o;const s=Gn(t);return s>=0&&((c=t.apicurioVersions)!=null&&c[s])&&(t.apicurioVersions[s].data=o),!0}function ml(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function Zo(e){if(y<0||!e)return null;const t=p[y].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function iu(e,t){const n=Zo(e);return n?(t?n.item.color=t:delete n.item.color,Vt(),Bt(),Mt(e),!0):!1}function au(e){if(y<0||!e)return!1;const t=p[y].data,o=((t==null?void 0:t.categories)||[]).find(a=>a.id===e);if(!o)return!1;let i=!1;return(o.items||[]).forEach(a=>{bi(a.stage)!=null&&(delete a.stage,i=!0)}),i?(Vt(),Bt(),W&&Mt(W),!0):!1}function ru(e,t){if(!e||!t||y<0)return!1;const n=Zo(e);if(!n)return!1;const o=bi(n.item.stage),i=o??(t>0?Co:Qi),a=Qi-Co+1,s=((i-Co+t)%a+a)%a,c=Co+s;return n.item.stage=c,Vt(),Bt(),Mt(e),!0}function su(e,t){const n=ml(t);let o=tn(e||"item");if(!n.has(o))return o;const i=()=>po().slice(0,4);for(;n.has(o);)o=`${tn(e||"item")}-${i()}`;return o}function lu(e="category",t){const n=(t==null?void 0:t.categories)||[],o=tn(e||"category"),i=c=>n.some(u=>u.id===c);let a=o||`category-${po()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const ho=yc({findItemAndCategoryById:Zo,collectAllItemIds:ml,updateItemReferences:vc,loadActiveIntoEditor:Vt,rebuildFromActive:Bt,select:e=>Mt(e),onSelectionRenamed:(e,t)=>{var n;W===e&&(W=t,nn()),((n=St==null?void 0:St.item)==null?void 0:n.id)===e&&(St.item.id=t)},makeSlug:tn,isAutoIdFromNameEnabled:()=>uo});function cu({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=N=>{if(a.fields.errorEl){if(!N){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=N}},c=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},u=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var N,P;(N=a.fields.titleInput)==null||N.focus(),(P=a.fields.titleInput)==null||P.select()}))},g=({force:N}={})=>{var ee,Ne;if(!uo||!a.autoSyncEnabled||!((ee=a.fields)!=null&&ee.idInput)||!((Ne=a.fields)!=null&&Ne.titleInput)||!N&&a.idManuallyEdited)return;const P=tn(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=P},h=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const N=a.modelData.categories||[],P=N.find(Ce=>Ce.id===a.categoryId);if(!P)throw new Error("Category not found.");const ee=(a.fields.idInput.value||"").trim();if(!ee)throw new Error("ID is required.");const Ne=(a.fields.titleInput.value||"").trim();if(N.some(Ce=>Ce.id===ee&&Ce.id!==P.id))throw new Error("Another category already uses that ID.");const ke=P.id;return P.id=ee,P.title=Ne||P.id,ke!==ee&&typeof i=="function"&&i(ke,ee),t(),n(),o(ee,{scrollIntoView:!0}),!0},S=()=>{try{return h(),c(),!0}catch(N){return console.warn("[CategoryEditor] save failed",N),s((N==null?void 0:N.message)||"Unable to save category."),!1}},$=()=>{if(a.wrapper)return a.wrapper;const N=document.createElement("div");N.className="item-editor-modal category-editor-modal",N.hidden=!0,N.setAttribute("role","dialog"),N.setAttribute("aria-modal","true");const P=document.createElement("div");P.className="item-editor-modal__backdrop",N.appendChild(P);const ee=document.createElement("div");ee.className="item-editor",N.appendChild(ee);const Ne=document.createElement("div");Ne.className="item-editor__header";const ht=document.createElement("h2");ht.className="item-editor__title",ht.textContent="Edit category";const ke=document.createElement("button");ke.type="button",ke.className="item-editor__close",ke.setAttribute("aria-label","Close category editor"),ke.textContent="×",Ne.appendChild(ht),Ne.appendChild(ke),ee.appendChild(Ne);const Ce=document.createElement("form");Ce.className="item-editor__form",ee.appendChild(Ce);const rt=document.createElement("div");rt.className="item-editor__meta",rt.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',Ce.appendChild(rt);const Ge=document.createElement("div");Ge.className="item-editor__error",Ge.hidden=!0,Ce.appendChild(Ge);const Dt=(dn,et,ni)=>{const un=document.createElement("label");un.className="item-editor__field";const wo=document.createElement("span");if(wo.className="item-editor__label",wo.textContent=dn,un.appendChild(wo),et.classList.add("item-editor__control"),un.appendChild(et),ni){const gn=document.createElement("div");gn.className="item-editor__hint",gn.textContent=ni,un.appendChild(gn)}return un},Zt=document.createElement("input");Zt.type="text",Ce.appendChild(Dt("Title",Zt,"Display label shown in the map."));const Ut=document.createElement("input");Ut.type="text",Ut.required=!0,Ce.appendChild(Dt("ID",Ut,"Unique identifier for this category (used in URLs and references)."));const xe=document.createElement("div");xe.className="item-editor__checkbox";const Rt=document.createElement("label");Rt.className="item-editor__checkbox-row";const An=document.createElement("input");An.type="checkbox";const qn=document.createElement("span");qn.textContent="Sync ID while editing title";const $t=document.createElement("div");$t.className="item-editor__hint",$t.textContent="Turn off to keep typing titles without changing the ID.",Rt.append(An,qn),xe.append(Rt,$t),Ce.appendChild(xe);const zt=document.createElement("div");zt.className="item-editor__actions";const ln=document.createElement("button");ln.type="submit",ln.className="item-editor__action item-editor__action--primary",ln.textContent="Save";const cn=document.createElement("button");return cn.type="button",cn.className="item-editor__action",cn.textContent="Cancel",zt.appendChild(ln),zt.appendChild(cn),Ce.appendChild(zt),Ce.addEventListener("submit",dn=>{dn.preventDefault(),S()}),cn.addEventListener("click",c),ke.addEventListener("click",c),P.addEventListener("click",c),Ut.addEventListener("input",()=>{a.idManuallyEdited=!0}),Zt.addEventListener("input",()=>g()),An.addEventListener("change",()=>{a.autoSyncEnabled=!!An.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,g({force:!0}))}),N.addEventListener("keydown",dn=>{dn.key==="Escape"&&(dn.preventDefault(),c())}),document.body.appendChild(N),a.wrapper=N,a.fields={titleInput:Zt,idInput:Ut,errorEl:Ge,metaLabel:rt.querySelector(".item-editor__meta-value"),syncCheckbox:An},N};return{open:N=>{if(!N||!$())return!1;const ee=e(),ht=((ee==null?void 0:ee.categories)||[]).find(Ce=>Ce.id===N);if(!ht)return!1;a.categoryId=ht.id,a.modelData=ee,a.idManuallyEdited=!1;const ke=!!uo;return a.autoSyncEnabled=ke,a.fields.metaLabel.textContent=ht.title||ht.id||"Category",a.fields.titleInput.value=ht.title||ht.id||"",a.fields.idInput.value=ht.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!ke,!a.fields.idInput.value&&ke&&g({force:!0}),s(""),u(),!0},hide:c,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const du=cu({getActiveModelData:()=>{var e;return(e=p[y])==null?void 0:e.data},loadActiveIntoEditor:Vt,rebuildFromActive:Bt,selectCategory:(e,t={})=>Jn(e,t),onCategoryRenamed:(e,t)=>{Xe===e&&(Xe=t,nn())}}),{handleTileContextMenu:uu,hidePreview:go,handleDocumentClick:pu,handleWindowResize:fu,handleWindowScroll:mu,updateColorPresets:Xo}=Ic({menuEl:document.getElementById("tileContextMenu"),previewEl:Z,previewTitleEl:re,previewBodyEl:fe,previewActionsEl:st,previewCloseEl:Fe,escapeHtml:Ii,onEditItem:e=>ho.open(e),onChangeColor:(e,t)=>iu(e,t),selectItem:e=>Mt(e),colorPresets:en});function sa(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||Qe(e);return Jt(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function hu({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=tn(`${e||"blank"}-${za()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),Rn(o,{titleHint:t,idHint:n}),o}function gu(){const t=`Blank series ${za()}`,n=kn(t,"blank-series"),o=hu({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return mo(i,n),Jt(i,{seriesName:t,fallbackTitle:t}),i}function bu(){const e=gu(),t=$n(e,{versionLabel:"blank"});return Ot(t),ud({origin:"new-blank"}),ca(),fn("Blank series created. Add categories and tiles to start.",2600),t}function $n(e,{versionLabel:t,createdOn:n}={}){var u,g,h;if(e!=null&&e.isSeries||((u=e==null?void 0:e.apicurioVersions)==null?void 0:u.length)>1){const S=e.title||Qe(e);Jt(e,{seriesName:S,fallbackTitle:S}),da(e)}const o=kt(e);if(!o)return sa(e,{versionLabel:t||"1",createdOn:n}),p.push(e),p.length-1;const i=p.findIndex(S=>kt(S)===o);if(i===-1)return sa(e,{versionLabel:t||"1",createdOn:n}),p.push(e),p.length-1;const a=p[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(h=(g=a.apicurioVersions)==null?void 0:g[0])==null?void 0:h.createdOn}],a.apicurioActiveVersionIndex=0;const S=a.title||Qe(a);Jt(a,{seriesName:S,fallbackTitle:S})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=Qe(e)||a.title,a.isSeries=!0;const c=a.title||Qe(a);return Jt(a,{seriesName:c,fallbackTitle:c}),i}function hl({versionLabel:e}={}){var c;if(y<0||!p[y])throw new Error("Load or select a model before creating a version.");const t=p[y];sa(t,{versionLabel:"1"});const n=tu(t);let o;try{o=nu(t.data)}catch(u){throw console.warn("[Blockscape] failed to clone active model for versioning",u),new Error("Could not copy the current model.")}n&&(o.id=n),Rn(o,{titleHint:Qe(t),idHint:kt(t)||Vn(t)});const a={version:e||String((((c=t.apicurioVersions)==null?void 0:c.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||Qe(t);return Jt(t,{seriesName:s,fallbackTitle:s}),y}function Za(){const e=y>=0&&p[y]?p[y]:null,t=kt(e);document.title=t?`${t}-blockscape`:ct}function la(e){if(!e)return null;da(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||Qe(e);return Jt(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var u;const s=((i==null?void 0:i.version)??"").toString().trim(),c=(((u=i==null?void 0:i.data)==null?void 0:u.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(ea)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:c}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function wu(){const e=p[y],t=la(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function gl(e="shortcut",t=!1){const n=m.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=p[y],i=t?la(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,c=Vn(o),u=kt(o),g=c||u||Qe(o,"blockscape"),h=a?"-series":"",S=`${tn(g)}${h}.bs`;return Hs(S,s),console.log(`[Blockscape] saved JSON (${e}):`,S),!0}const vu=Gt.palette.letter,yu=Gt.palette.letterFallback;function bl(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return vu[n]||yu}function Su(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?Gt.color.ink:Gt.color.white}function Eu(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function Xa(){if(sn)return;sn=document.createElement("div"),sn.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",d=document.createElement("span"),d.className="series-nav-notice__text",sn.appendChild(e),sn.appendChild(d),document.body.appendChild(sn)}function Qa(){v&&(clearTimeout(v),v=null),sn&&sn.classList.remove("is-visible"),d&&(d.textContent="")}function Qo(){Cn=null,jt&&(clearTimeout(jt),jt=null),Qa()}function er(){xn=null,rn&&(clearTimeout(rn),rn=null),Qa()}function ku(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function Iu(e,t,n){Xa(),Cn={id:e,targetVersionIndex:t},jt&&clearTimeout(jt),jt=setTimeout(()=>{jt=null,Qo()},Fn);const o=ku(n,t);fn(`Click again to open ${o} in this series.`,Fn)}function _u(e,t){Xa(),xn={id:e,targetIndex:t},rn&&clearTimeout(rn),rn=setTimeout(()=>{rn=null,er()},Fn);const n=ra(p[t]);fn(`Click again to open "${n}".`,Fn)}function fn(e,t=hn,n=null){if(Xa(),d.textContent="",d.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,d.appendChild(o),d.appendChild(i)}sn.classList.add("is-visible"),v&&clearTimeout(v),v=setTimeout(()=>Qa(),t)}function Cu(){le&&(le.innerHTML="",eu.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const c=document.createElement("span");c.className="shortcut-help__or",c.textContent="or",n.appendChild(c)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((c,u)=>{if(u>0){const h=document.createElement("span");h.className="shortcut-help__sep",h.textContent="+",s.appendChild(h)}const g=document.createElement("kbd");g.className="shortcut-help__key",g.textContent=c,s.appendChild(g)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),le.appendChild(t)}),lo=!0)}function xu(){return!!Se&&Se.hidden===!1}function Tu(){if(!Se)return;lo||Cu(),_n=document.activeElement,Se.hidden=!1,Se.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Se.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function tr(){if(!Se||Se.hidden)return;Se.hidden=!0,Se.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=_n;e!=null&&e.focus?e.focus({preventScroll:!0}):Me!=null&&Me.focus&&Me.focus({preventScroll:!0})}function Au(){if(!Y)return;Y.hidden=!1,Y.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Y.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function ca(){!Y||Y.hidden||(Y.hidden=!0,Y.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),he!=null&&he.focus&&he.focus({preventScroll:!0}))}function Lu(){return window.visualViewport?{width:window.visualViewport.width,height:window.visualViewport.height}:{width:window.innerWidth,height:window.innerHeight}}function wl(){if(!G)return;const{width:e,height:t}=Lu();e===Ke&&t===Be||(Ke=e,Be=t,G.setAttribute("width",e),G.setAttribute("height",t),G.setAttribute("viewBox",`0 0 ${e} ${t}`))}let nr=!1;function Wn(){nr||(nr=!0,requestAnimationFrame(()=>{nr=!1,wl(),pa(),Tn()}))}let vl=!1;function yl(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function Nu(e){const t=yl(e);if(!t.length){_.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}_.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(c=>o.includes(c)||i.includes(c));n.style.opacity=a?"1":"0.2"})}function Mu(e){const t=yl(e);if(!t.length)return[];const n=[];return p.forEach((o,i)=>{var g;const a=ra(o),s=kt(o)||"",c=`${a} ${s}`.toLowerCase();t.every(h=>c.includes(h))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((g=o.data)==null?void 0:g.categories)?o.data.categories:[]).forEach(h=>{const S=(h.title||h.id||"").toString();(h.items||[]).forEach($=>{const A=Si($),N=($.name||$.id||"").toString(),P=`${N} ${$.id||""} ${S}`.toLowerCase();t.every(ee=>P.includes(ee))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:$.id,itemName:N,itemDisplayName:A,categoryTitle:S})})})}),n.slice(0,ft)}function Sl(e){if(!ce)return;ce.innerHTML="";const t=(e||"").toString();if(!t.trim()){ce.hidden=!0;return}if(!p.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",ce.appendChild(o),ce.hidden=!1;return}const n=Mu(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",ce.appendChild(o),ce.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===y&&(!o.itemId||W===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemDisplayName||o.itemName||o.itemId||"Item",a.appendChild(s);const c=document.createElement("span");c.className="search-result__badge",c.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(c);const u=document.createElement("div");u.className="search-result__meta";const g=document.createElement("span");if(g.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,u.appendChild(g),o.type==="item"&&o.itemId){const h=document.createElement("span");h.textContent=`Item ID: ${o.itemId}`,u.appendChild(h)}else if(o.type==="model"){const h=document.createElement("span");h.textContent="Matches model title",u.appendChild(h)}i.appendChild(a),i.appendChild(u),ce.appendChild(i)}),ce.hidden=!1}function or(e){Nu(e||""),Sl(e||"")}function Bu(e){!e||!Number.isInteger(e.modelIndex)||(Ot(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(y!==e.modelIndex)return;const t=(n=gt.get(e.itemId))==null?void 0:n.el;t&&(Mt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function Ot(e){var t;if(go(),Qo(),St=null,pn=null,Xe=null,pt=null,e<0||e>=p.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(V=!0,y=e,console.log("[Blockscape] active model:",Qe(p[e]),"(index",e+" )"),typeof(tt==null?void 0:tt.highlightSource)=="function"){const n=((t=p[e])==null?void 0:t.sourcePath)||null;tt.highlightSource(n)}Za(),jn(),Vt(),Bt(),ve&&or(ve.value||""),tt.updateActiveSavePlaceholder(),_t.updateAvailability(),ja()}function jn(){if(J.innerHTML="",!p.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",J.appendChild(e);return}p.forEach((e,t)=>{var S;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===y?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===y?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=ra(e),i.appendChild(a);const s=ou(qa(e)||kt(e));if(s){const $=document.createElement("span");$.className="model-nav-id",$.textContent=s,i.appendChild($)}const c=Array.isArray((S=e.data)==null?void 0:S.categories)?e.data.categories:[],u=c.reduce(($,A)=>$+(A.items||[]).length,0),g=document.createElement("span");g.className="model-nav-meta";const h=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";g.textContent=`${c.length} cat · ${u} items${h}`,o.appendChild(i),o.appendChild(g),n.appendChild(o),J.appendChild(n)}),_t.updateAvailability()}function Vt(){if(y<0){m.value="",R&&(R.disabled=!0);return}const e=p[y];m.value=JSON.stringify(e.data,null,2),R&&(R.disabled=!la(e))}function Ru(e){try{return JSON.parse(e)}catch{return null}}function El(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function $u(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,c)=>{const u=s==null?void 0:s.data;if(!u||!Array.isArray(u.categories))return;const g=Qe(u,`Map ${c+1}`),h=(u.id??"").toString().trim()||tn(g||`map-${c+1}`),S=tn(h||g||`map-${c+1}`);u.categories.forEach($=>{const A=(($==null?void 0:$.id)??"").toString().trim();if(!A)return;n.has(A)||n.set(A,{catTitle:$.title||A,sources:[]});const N=n.get(A);!N.catTitle&&($.title||A)&&(N.catTitle=$.title||A),N.sources.push({category:$,mapId:h,mapTitle:g,mapSlug:S,versionIndex:c})})});const o=Vn(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||Qe(e,"Series"),a=[];return n.forEach((s,c)=>{var $;if(((($=s.sources)==null?void 0:$.length)||0)<2)return;const u=s.catTitle||c,g=new Set,h=s.sources.map(A=>{var ht;let P=A.mapSlug||tn(A.mapTitle||A.mapId)||`map-${A.versionIndex+1}`;g.has(P)&&(P=`${P}-${A.versionIndex+1}`),g.add(P);const ee=new Map,Ne=(((ht=A.category)==null?void 0:ht.items)||[]).map((ke,Ce)=>{const rt=((ke==null?void 0:ke.id)??"").toString().trim()||`item-${Ce+1}`,Ge=`${P}-${rt}`;ee.set(rt,Ge);const Dt={...ke,id:Ge};return Dt.deps=Array.isArray(ke==null?void 0:ke.deps)?[...ke.deps]:[],Dt});return Ne.forEach(ke=>{ke.deps=(ke.deps||[]).map(Ce=>ee.get(Ce)).filter(Boolean)}),{id:P,title:A.mapTitle||A.mapId||`Map ${A.versionIndex+1}`,items:Ne}}),S={id:tn(`${c}-category-view`),title:u,abstract:`Items from "${u}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:h};o&&(S.seriesId=o),Rn(S,{titleHint:u,idHint:`${o||"series"}-${c}`}),a.push({version:`${ea}${c}`,data:S,isCategoryView:!0,categoryViewKey:c})}),a}function kl(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${ea}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function da(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=kl(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(c=>!(c!=null&&c.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Gn(e),e.apicurioVersions.length-1));const c=e.apicurioVersions[e.apicurioActiveVersionIndex];return c!=null&&c.data&&(e.data=c.data),e}const o=$u({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(c=>kl(c)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function Pu(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((h,S)=>!h||typeof h!="object"?null:(Rn(h,{titleHint:`${t} #${S+1}`}),{obj:h,idx:S})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let c=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const u={id:po(),title:c,data:a,apicurioVersions:i.map(({obj:h,idx:S})=>({version:String(S+1),data:h})),apicurioActiveVersionIndex:0,isSeries:!0},g=Jt(u,{seriesName:c,fallbackTitle:c});return g&&(u.id=g),da(u),[u]}function Il(e,t="Pasted",n={}){return Array.isArray(e)?Pu(e,t,n):!e||typeof e!="object"?[]:(Rn(e,{titleHint:`${t} #1`}),[{id:po(),title:e.title||`${t} #1`,data:e}])}function zn(e,t="Pasted",n={}){const a=(El(typeof e=="string"?e:"")||"").replace(/^\uFEFF/,"").replace(/\u0000/g,"").trim();if(!a)return[];const s=Ru(a);if(s){let u=n;if(Array.isArray(s)&&n.promptForSeriesName){const h=Xd(s,t),S=Zd(h);u={...n,promptForSeriesName:!1,seriesTitleOverride:S||h}}const g=Il(s,t,u);if(g.length)return g}return a.split(/^\s*(?:---|%%%)\s*$/m).map(u=>u.trim()).filter(Boolean).map((u,g)=>{const h=JSON.parse(u);return Rn(h,{titleHint:`${t} #${g+1}`}),{id:po(),title:h.title||`${t} #${g+1}`,data:h}})}function Ou(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function bo(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!Ou(e)}function Vu(e){if(!e)return!1;const n=(El(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function _l(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(it)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(it)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(it)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=zn(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let o=null;return n.forEach(i=>{const a=$n(i,{versionLabel:"editor"});o==null&&(o=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:o,count:n.length}}function Cl(e="storage"){const t=_l();return!t||typeof t.index!="number"?!1:(Ot(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Du(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=Yc(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=Il(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const c=s.isSeries?o.title||s.title:null,u=$n({...s,apicurioArtifactName:c||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=u)}),a}async function Uu(){const e=pd();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await yi())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await Ys(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(tt==null?void 0:tt.highlightSource)=="function"&&tt.highlightSource(t);let s=a.firstIndex;if(n){const c=Ya(n);c!==-1&&(s=c)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function Hu(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await sr(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function Fu(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const c=new Set(s.deps||[]);t.set(s.id,c),c.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function Wu(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=bl(e,t),c=Su(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=c,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function Gn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function xl(e){const t=Gn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Tl(e,t="active"){return Vn(e)||kt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function ju(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,c;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((c=n==null?void 0:n.data)==null?void 0:c.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function zu(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(tn(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,c]of t.entries())if(s.toLowerCase()===a)return c}return null}const Al=new WeakMap;function Gu(e,t){var Ge;if(!((Ge=e==null?void 0:e.apicurioVersions)!=null&&Ge[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=aa(o),a=Al.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,c=160,u=document.createElement("canvas");u.width=s,u.height=c;const g=u.getContext("2d"),h=Po("--color-surface-ghost")||Gt.color.surfaceGhost,S=Po("--color-border-muted")||Gt.color.borderMuted;g.fillStyle=h,g.fillRect(0,0,s,c),g.strokeStyle=S,g.strokeRect(.5,.5,s-1,c-1);const $=8,A=8,N=4,P=Array.isArray(o==null?void 0:o.categories)?o.categories:[],ee=Math.max(P.length,1),Ne=s-N*2,ht=N*3,ke=ee>1?Math.min(ht,Ne/(ee-1)):0,Ce=ee>1?(s-ke*(ee-1))/2:s/2;P.forEach((Dt,Zt)=>{const Ut=Ce+Zt*ke,xe=Array.isArray(Dt.items)?Dt.items:[],Rt=Math.max(xe.length,1),An=c-$-A-N*2,qn=Rt>1?Math.min(N*3,An/(Rt-1)):0;xe.forEach(($t,zt)=>{const ln=c-A-N-zt*qn;g.beginPath(),g.arc(Ut,ln,N,0,Math.PI*2);const cn=bl($t.name||$t.id||"",$t.color);g.fillStyle=cn,g.strokeStyle="rgba(15,23,42,0.25)",g.fill(),g.stroke()})});const rt=u.toDataURL("image/png");return Al.set(n,{fingerprint:i,dataUrl:rt}),rt}function ua(e,t){var c;if(Qo(),e<0||e>=p.length)return!1;const n=p[e];if(!((c=n==null?void 0:n.apicurioVersions)!=null&&c.length)||!fl(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,V=!0,W=null,Wt=null,nn(),Vt(),Bt(),!0):!1}function ir(e){var o;if(!e||y<0)return!1;const t=p[y];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=Gn(t);return n===-1?!1:ua(y,n+e)}function Ju(e,t){if(Qo(),e<0||e>=p.length)return!1;const n=p[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!fl(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=Gn(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const c=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(c==null?void 0:c.data)||n.data,n.isSeries=n.apicurioVersions.length>1,Ot(e),!0}function Ku(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,l.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||kt(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var Ne;const P=p[y];!((Ne=P==null?void 0:P.apicurioVersions)!=null&&Ne.length)||!Qd(P)||(jn(),Vt(),Bt())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=Gn(e),s=xl(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const c=document.createElement("div");c.className="version-nav__controls";const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Previous",u.addEventListener("click",()=>ir(-1));const g=document.createElement("button");g.type="button",g.className="version-nav__button",g.textContent="Next",g.addEventListener("click",()=>ir(1)),c.appendChild(u),c.appendChild(g),n.appendChild(c);const h=document.createElement("div");h.className="version-nav__thumbs",e.apicurioVersions.forEach((P,ee)=>{var Zt,Ut;const Ne=document.createElement("button");Ne.type="button",Ne.className="version-nav__thumb",P!=null&&P.isCategoryView&&Ne.classList.add("version-nav__thumb--category"),ee===a&&Ne.classList.add("is-active");const ht=Gu(e,ee);if(ht){const xe=document.createElement("img");xe.src=ht,xe.alt=`Version ${ee+1}`,Ne.appendChild(xe)}const ke=document.createElement("div");ke.className="version-nav__thumb-label";const Ce=document.createElement("span");Ce.className="version-nav__thumb-label-text";const rt=(((Zt=P==null?void 0:P.data)==null?void 0:Zt.id)??(P==null?void 0:P.id)??"").toString().trim();let Ge=rt||(P!=null&&P.version?`v${P.version}`:`${ee+1}`),Dt=rt||Ge;if(P!=null&&P.isCategoryView){const xe=((Ut=P.data)==null?void 0:Ut.title)||P.categoryViewKey||Ge||"Category";Ge=xe,Dt=`Category view: ${xe}`,Ne.dataset.computed="true"}if(Ce.textContent=Ge,ke.title=Dt,ke.appendChild(Ce),Ne.appendChild(ke),np(ke,Ce),e.apicurioVersions.length>1&&!(P!=null&&P.isCategoryView)){const xe=document.createElement("span");xe.className="version-nav__thumb-remove",xe.title=`Remove ${Ge} from this series`,xe.setAttribute("aria-label",`Remove ${Ge} from this series`),xe.setAttribute("role","button"),xe.tabIndex=-1,xe.textContent="×",xe.addEventListener("click",Rt=>{Rt.stopPropagation(),Rt.preventDefault(),window.confirm(`Remove ${Ge} from this series?`)&&Ju(y,ee)}),Ne.appendChild(xe)}Ne.addEventListener("click",()=>ua(y,ee)),ip(Ne,P),h.appendChild(Ne)});const S=document.createElement("button");S.type="button",S.className="version-nav__thumb version-nav__thumb--add",S.title="Create a new version from this map",S.addEventListener("click",()=>{try{const P=hl({versionLabel:"manual"});Ot(P)}catch(P){alert((P==null?void 0:P.message)||"Unable to create a new version right now.")}});const $=document.createElement("span");$.className="version-nav__thumb-add-icon",$.textContent="+",S.appendChild($),h.appendChild(S),n.appendChild(h);const A=Tl(e,"active"),N=K.get(A);return typeof N=="number"&&!Number.isNaN(N)&&requestAnimationFrame(()=>{h.scrollLeft=N}),h.addEventListener("scroll",()=>{K.set(A,h.scrollLeft)}),n}function Ei(){var Xl,Ql;if(!de)return;const e=y>=0&&p[y]?p[y]:null,t=_&&_.querySelector?_.querySelector(".version-nav__thumbs"):null;if(t&&e){const f=Tl(e,y);K.set(f,t.scrollLeft)}Kn(),Array.isArray(de.m.categories)||(de.m.categories=[]),console.log("[Blockscape] rendering categories=",de.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!de.m.abstract,"- value:",de.m.abstract?de.m.abstract.substring(0,50)+"...":"none"),_.innerHTML="",gt.clear(),Mn.clear(),Ee=[],sa(p[y],{versionLabel:"1"});const n=Ku(p[y]);n&&_.appendChild(n),wl();const i=(()=>{var q,Ye,Qt;const f=document.createElement("div");f.className="blockscape-model-meta";const B=document.createElement("div");B.className="blockscape-model-title",B.textContent=de.m.title&&de.m.title.trim()||Qe(p[y]),f.appendChild(B),((q=p[y])!=null&&q.isSeries||(Qt=(Ye=p[y])==null?void 0:Ye.apicurioVersions)!=null&&Qt.length)&&Jt(p[y],{seriesName:p[y].title||de.m.title||Qe(p[y])});const F=xl(p[y]),Te=Vn(p[y]),pe=(de.m.id??"").toString().trim(),De=document.createElement("div");De.className="blockscape-model-meta__details";const Oe=(He,Ht)=>{if(!Ht)return;const En=document.createElement("div");En.className="blockscape-model-id";const yo=document.createElement("span");yo.className="blockscape-model-id__label",yo.textContent=He;const So=document.createElement("span");So.className="blockscape-model-id__value",So.textContent=Ht,En.append(yo,So),De.appendChild(En)};return Oe("Series ID",Te),Oe("Model ID",pe),Oe("No. in series",F),De.childElementCount&&f.appendChild(De),f})();l.showModelMeta!==!1&&_.appendChild(i.cloneNode(!0));const s=document.createElement("div");s.className="blockscape-tabs";const c=document.createElement("div");c.className="blockscape-tabrow";const u=document.createElement("div");u.className="blockscape-tablist",u.setAttribute("role","tablist"),c.appendChild(u);const g=document.createElement("div");g.className="blockscape-tabactions",c.appendChild(g),s.appendChild(c);const h=document.createElement("div");h.className="blockscape-tabpanels",s.appendChild(h);const S=document.createElement("div"),$=document.createElement("div"),A=document.createElement("div"),N=document.createElement("div"),P=()=>{const f=document.createElement("div");f.className="blockscape-map-legend";const B=document.createElement("div");return B.className="blockscape-legend",B.setAttribute("role","presentation"),B.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,f.appendChild(B),f};let ee="";const Ne=ju(p[y]),ht=Gn(p[y]),ke=((Ql=(Xl=p[y])==null?void 0:Xl.apicurioVersions)==null?void 0:Ql[ht])||null,Ce=Kt=!!(ke!=null&&ke.isCategoryView||((ke==null?void 0:ke.version)||"").startsWith(ea));L=null,k="";const rt=(f,B)=>{!f||!B||(f.title=f.title?`${f.title}
${B}`:B)},Ge=[{id:"map",label:"Map",panel:S},{id:"abstract",label:"Info",panel:$},{id:"source",label:"Settings",panel:A},{id:"apicurio",label:"Apicurio",panel:N}],Dt=typeof _t.isEnabled=="function"?_t.isEnabled():!1,Zt=f=>{if(!G)return;const B=f==="map";G.hidden=!B,B?(pa(),Tn()):G.innerHTML=""};Ge.forEach((f,B)=>{const F=document.createElement("button");F.type="button",F.id=`tab-${f.id}`,F.className="blockscape-tab"+(B===0?" is-active":""),F.setAttribute("role","tab"),F.setAttribute("aria-controls",`panel-${f.id}`),F.setAttribute("aria-selected",B===0?"true":"false"),F.textContent=f.label,f.id==="apicurio"&&!Dt&&(F.hidden=!0,F.tabIndex=-1,F.setAttribute("aria-hidden","true"),F.style.display="none"),f.button=F,u.appendChild(F),f.panel.id=`panel-${f.id}`,f.panel.classList.add("blockscape-tabpanel"),f.panel.setAttribute("role","tabpanel"),f.panel.setAttribute("aria-labelledby",F.id),f.panel.hidden=B!==0,B===0&&f.panel.classList.add("is-active"),h.appendChild(f.panel)});const Ut=f=>{Dn=f,Ge.forEach(B=>{const F=B.id===f;B.button.classList.toggle("is-active",F),B.button.setAttribute("aria-selected",F?"true":"false"),B.panel.classList.toggle("is-active",F),B.panel.hidden=!F}),Zt(f)},xe=Ge.find(f=>f.id==="apicurio"),Rt=f=>{if(!xe||!xe.button||!xe.panel)return;const B=!!f;if(xe.button.hidden=!B,xe.button.tabIndex=B?0:-1,xe.button.setAttribute("aria-hidden",B?"false":"true"),xe.button.style.display=B?"":"none",B){const F=Dn==="apicurio";xe.button.classList.toggle("is-active",F),xe.button.setAttribute("aria-selected",F?"true":"false"),xe.panel.classList.toggle("is-active",F),xe.panel.hidden=!F}else{const F=xe.panel.classList.contains("is-active");if(xe.button.classList.remove("is-active"),xe.button.setAttribute("aria-selected","false"),xe.panel.classList.remove("is-active"),xe.panel.hidden=!0,F){const Te=Ge.find(pe=>pe.id!=="apicurio");Te&&Ut(Te.id)}}Ie&&(Ie.checked=B)};Ge.forEach(f=>{f.button.addEventListener("click",()=>{Kn(),Ut(f.id)}),f.id==="abstract"&&(L=f.button,f.button.addEventListener("mouseenter",()=>_i(f.button,ee,{offset:12})),f.button.addEventListener("mouseleave",Kn),f.button.addEventListener("focus",()=>_i(f.button,ee,{offset:12})),f.button.addEventListener("blur",Kn))});const qn=(f=>{const B=Ge.find(Te=>Te.id===Dn);if(B&&(B.id!=="apicurio"||f))return B.id;const F=Ge.find(Te=>Te.id!=="apicurio"||f);return(F==null?void 0:F.id)||Ge[0].id})(Dt);Ut(qn),Rt(Dt),typeof _t.onEnabledChange=="function"&&_t.onEnabledChange(Rt),_.appendChild(s),S.appendChild(P());const $t=document.createElement("div");$t.className="blockscape-render";const zt=document.createElement("div");zt.className="stage-guides",zt.hidden=!Et,zt.setAttribute("aria-hidden","true");const ln=document.createElement("div");ln.className="stage-guide-labels",["Genesis / Inception","Custom","Product / Rental","Service / Commodity"].forEach(f=>{const B=document.createElement("span");B.className="stage-guide-labels__item",B.textContent=f,ln.appendChild(B)}),zt.appendChild(ln),$t.appendChild(zt),$a=zt,S.appendChild($t);const cn=document.createElement("div");if(cn.className="blockscape-abstract-panel",$.appendChild(i.cloneNode(!0)),de.m.abstract){console.log("[Blockscape] Rendering abstract content");const f=document.createElement("div");f.className="blockscape-abstract",f.innerHTML=de.m.abstract,kp(f),cn.appendChild(f),ee=f.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const f=document.createElement("div");f.className="blockscape-abstract-placeholder",f.textContent="No abstract has been provided for this model.",cn.appendChild(f),ee=f.outerHTML}k=ee,$.appendChild(cn);const dn=document.createElement("div");dn.className="blockscape-source-panel";const et=document.createElement("div");et.className="blockscape-settings-panel";const ni=f=>{_e.themeToggle&&(_e.themeToggle.checked=f),_e.tabThemeToggle&&(_e.tabThemeToggle.checked=f)},un=f=>{ni(f),Oa(f?co:xo)},wo=f=>{_e.tabCenterToggle&&(_e.tabCenterToggle.checked=f)},gn=f=>{const B=$o(f);wo(B),Fs(B)},lr=f=>{_e.secondaryLinksToggle&&(_e.secondaryLinksToggle.checked=f),_e.tabSecondaryLinksToggle&&(_e.tabSecondaryLinksToggle.checked=f)},Ci=f=>{const B=!!f;lr(B),In=B,W?Mt(W):(ma(),Tn())},xi=({id:f,label:B,checked:F,onChange:Te})=>{const pe=document.createElement("label");pe.className="blockscape-tab-toggle",pe.setAttribute("for",f);const De=document.createElement("input");De.type="checkbox",De.id=f,De.checked=F,typeof Te=="function"&&De.addEventListener("change",()=>Te(De.checked));const Oe=document.createElement("span");return Oe.className="blockscape-tab-toggle__label",Oe.textContent=B,pe.append(De,Oe),{row:pe,input:De}},oi=document.createElement("p");oi.className="blockscape-settings-panel__title",oi.textContent="Feature toggles",et.appendChild(oi);const Ti=document.createElement("label");Ti.className="settings-toggle";const no=document.createElement("input");no.type="checkbox",no.checked=mi===co;const Ai=document.createElement("span");Ai.className="settings-toggle__text";const ii=document.createElement("span");ii.className="settings-toggle__label",ii.textContent="Dark mode";const I=document.createElement("span");I.className="settings-toggle__hint",I.textContent="Switch Blockscape UI to dark colors.",Ai.append(ii,I),Ti.append(no,Ai),no.addEventListener("change",()=>{un(no.checked)}),et.appendChild(Ti),_e.themeToggle=no;const{row:H,input:ne}=xi({id:"tabToggleTheme",label:"Dark mode",checked:mi===co,onChange:f=>un(f)});g.appendChild(H),_e.tabThemeToggle=ne;const{row:be,input:nt}=xi({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:In,onChange:f=>Ci(f)});g.appendChild(be),_e.tabSecondaryLinksToggle=nt;const{row:qe,input:oe}=xi({id:"tabToggleCenterItems",label:"Wardley",checked:Et,onChange:f=>gn(f)});g.appendChild(qe),_e.tabCenterToggle=oe;const Pe=document.createElement("div");Pe.className="settings-actions";const yt=document.createElement("input");yt.type="file",yt.accept="application/json",yt.hidden=!0;const mn=document.createElement("button");mn.type="button",mn.className="pf-v5-c-button pf-m-secondary",mn.textContent="Load settings",mn.addEventListener("click",()=>yt.click()),yt.addEventListener("change",async()=>{var B,F;const f=(B=yt.files)==null?void 0:B[0];if(f)try{const Te=await f.text(),pe=JSON.parse(Te),De=(pe==null?void 0:pe.settings)||pe,q=((F=Ga(De||{},{refreshObsidianLinks:ha}).applied)==null?void 0:F.length)||0;fn(q?`Loaded ${q} setting${q===1?"":"s"} from ${f.name}.`:`No matching settings found in ${f.name}.`,2200)}catch(Te){console.warn("[Blockscape] failed to load settings.json",Te),fn("Invalid settings file.",2400)}finally{yt.value=""}});const on=document.createElement("button");on.type="button",on.className="pf-v5-c-button pf-m-tertiary",on.textContent="Download settings",on.addEventListener("click",async()=>{const f=sl();if(typeof window<"u"&&typeof window.__blockscapeSettingsSaveToFile=="function")try{await window.__blockscapeSettingsSaveToFile(f)?fn("Settings saved to ~/.blockscape/settings.json.",2e3):fn("Settings save failed. Check logs.",2400)}catch(B){console.warn("[Blockscape] settings save failed",B),fn("Settings save failed. Check logs.",2400)}else Hs("settings.json",JSON.stringify(f,null,2)),fn("Settings downloaded.",2e3)}),Pe.append(mn,on,yt),et.appendChild(Pe);const Yn=document.createElement("div");Yn.className="color-presets";const cr=document.createElement("div");cr.className="settings-text__label",cr.textContent="Color presets";const dr=document.createElement("div");dr.className="settings-text__hint",dr.textContent="Shown in tile context menu for quick coloring.",Yn.append(cr,dr);const Li=document.createElement("div");Li.className="color-presets__list";const ur=document.createElement("div");ur.className="color-presets__add";const ai=document.createElement("input");ai.type="text",ai.placeholder="Name",ai.className="settings-text__input";const Ni=document.createElement("input");Ni.type="color",Ni.value="#2563eb",Ni.className="settings-color-input";const Mi=document.createElement("button");Mi.type="button",Mi.className="pf-v5-c-button pf-m-primary",Mi.textContent="Add preset",Mi.addEventListener("click",()=>{const f=ai.value.trim()||"Custom",B=Ni.value,F=[...en,{name:f,value:B}];Oo(F),Xo(en),ai.value=""}),ur.append(ai,Ni,Mi),Yn.append(Li,ur),et.appendChild(Yn),_e.colorPresetList=Li,Ro=()=>{Li.innerHTML="",en.forEach((f,B)=>{const F=document.createElement("div");F.className="color-presets__row";const Te=document.createElement("input");Te.type="text",Te.className="settings-text__input",Te.value=f.name||"",Te.placeholder="Name",Te.addEventListener("input",()=>{const Oe=[...en];Oe[B]={...Oe[B],name:Te.value},Oo(Oe),Xo(en)});const pe=document.createElement("input");pe.type="color",pe.className="settings-color-input",pe.value=f.value,pe.addEventListener("input",()=>{const Oe=[...en];Oe[B]={...Oe[B],value:pe.value},Oo(Oe),Xo(en)});const De=document.createElement("button");De.type="button",De.className="pf-v5-c-button pf-m-plain",De.textContent="✕",De.title="Remove preset",De.addEventListener("click",()=>{const Oe=en.filter((q,Ye)=>Ye!==B);Oo(Oe),Xo(en),Ro()}),F.append(Te,pe,De),Li.appendChild(F)})},Ro();const pr=document.createElement("div");pr.className="settings-text";const fr=document.createElement("div");fr.className="settings-text__label",fr.textContent="Link colors";const mr=document.createElement("div");mr.className="settings-text__hint",mr.textContent="Adjust the colors used when highlighting enables/dependents.";const hr=document.createElement("div");hr.className="settings-color-rows";const jl=({id:f,label:B,hint:F,value:Te,onChange:pe})=>{const De=document.createElement("label");De.className="settings-color-row",De.setAttribute("for",f);const Oe=document.createElement("span");if(Oe.className="settings-color-row__label",Oe.textContent=B,F){const Ye=document.createElement("span");Ye.className="settings-color-row__hint",Ye.textContent=F,Oe.appendChild(Ye)}const q=document.createElement("input");if(q.type="color",q.id=f,q.className="settings-color-input",q.value=Te,typeof pe=="function"){const Ye=()=>pe(q.value);q.addEventListener("input",Ye),q.addEventListener("change",Ye)}return De.append(Oe,q),hr.appendChild(De),q};_e.depColorInput=jl({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:na,onChange:f=>{const B=Ha(f);Da(B)}}),_e.revdepColorInput=jl({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:oa,onChange:f=>{const B=Fa(f);Ua(B)}}),pr.append(fr,mr,hr),et.appendChild(pr);const gr=document.createElement("div");gr.className="settings-text";const br=document.createElement("div");br.className="settings-text__text";const wr=document.createElement("div");wr.className="settings-text__label",wr.textContent="Link thickness";const vr=document.createElement("div");vr.className="settings-text__hint",vr.textContent="Adjust stroke width for enables/dependents lines.",br.append(wr,vr);const vo=document.createElement("select");vo.id="linkThickness",vo.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:f,label:B})=>{const F=document.createElement("option");F.value=f,F.textContent=B,f===hi&&(F.selected=!0),vo.appendChild(F)}),vo.addEventListener("change",()=>{const f=wi(vo.value);Wa(f)});const yr=document.createElement("div");yr.className="settings-text__row",yr.append(br,vo),gr.appendChild(yr),et.appendChild(gr),_e.linkThicknessInput=vo;const Zn=({id:f,label:B,hint:F,checked:Te,className:pe="",onChange:De})=>{const Oe=document.createElement("label");Oe.className=["settings-toggle",pe].filter(Boolean).join(" ");const q=document.createElement("input");q.type="checkbox",q.id=f,q.checked=Te;const Ye=document.createElement("span");Ye.className="settings-toggle__text";const Qt=document.createElement("span");if(Qt.className="settings-toggle__label",Qt.textContent=B,Ye.appendChild(Qt),F){const He=document.createElement("span");He.className="settings-toggle__hint",He.textContent=F,Ye.appendChild(He)}return Oe.appendChild(q),Oe.appendChild(Ye),typeof De=="function"&&q.addEventListener("change",()=>De(q.checked)),{row:Oe,input:q}},ha=()=>{_.querySelectorAll(".tile").forEach(f=>{const B=f.dataset.id,F=Zo(B);if(!(F!=null&&F.item))return;const Te=$l(F.item.external),pe=Rl(F.item,{externalMeta:Te,seriesIdLookup:Ne});Pl(f,pe)})},{row:xp,input:Tp}=Zn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:In,className:"map-controls__toggle",onChange:f=>Ci(f)});et.appendChild(xp),_e.secondaryLinksToggle=Tp;const{row:Ap,input:Lp}=Zn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:an,className:"map-controls__toggle",onChange:f=>{an=f,rr()}});et.appendChild(Ap),_e.reusedToggle=Lp;const{row:Np,input:Mp}=Zn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:uo,className:"map-controls__toggle",onChange:f=>{const B=zo(f);tl(B)}});et.appendChild(Np),_e.autoIdToggle=Mp;const Sr=[],{row:Bp,input:Rp}=Zn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:Mo,className:"map-controls__toggle",onChange:f=>{const B=Ko(f);dl(B),Sr.forEach(F=>{F.disabled=!B}),ha()}});if(et.appendChild(Bp),_e.obsidianToggle=Rp,typeof(tt==null?void 0:tt.isAvailable)=="function"&&tt.isAvailable()&&typeof(tt==null?void 0:tt.getAutoReloadConfig)=="function"){const{enabled:f,intervalMs:B}=tt.getAutoReloadConfig();let F=null;const{row:Te,input:pe}=Zn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:f,className:"map-controls__toggle",onChange:Ht=>{tt.setAutoReloadEnabled(Ht),F&&(F.disabled=!Ht)}});et.appendChild(Te),_e.autoReloadToggle=pe;const De=Ht=>`${(Ht/1e3).toFixed(2)}s`,Oe=document.createElement("label");Oe.className="settings-slider",Oe.setAttribute("for","autoReloadInterval");const q=document.createElement("div");q.className="settings-slider__text";const Ye=document.createElement("span");Ye.className="settings-slider__label",Ye.textContent="Auto-reload interval";const Qt=document.createElement("span");Qt.className="settings-slider__hint",Qt.textContent="Adjust how often to poll for file changes.",q.append(Ye,Qt);const He=document.createElement("span");He.className="settings-slider__value",He.textContent=De(B),F=document.createElement("input"),F.type="range",F.id="autoReloadInterval",F.className="settings-slider__input",F.min=String(ks),F.max=String(Is),F.step="100",F.value=String(B),F.disabled=!f,F.setAttribute("aria-label","Set auto-reload polling interval"),F.addEventListener("input",()=>{const Ht=tt.setAutoReloadInterval(parseInt(F.value,10));He.textContent=De(Ht)}),Oe.append(q,He,F),et.appendChild(Oe),_e.autoReloadInput=F,_e.autoReloadValue=He}const Er=document.createElement("div");Er.className="settings-radio";const kr=document.createElement("div");kr.className="settings-radio__label",kr.textContent="Obsidian link format";const Ir=document.createElement("div");Ir.className="settings-radio__hint",Ir.textContent="Use the tile title or id when building Obsidian links.";const _r=document.createElement("div");_r.className="settings-radio__options";const zl=(f,B)=>{const F=document.createElement("label");F.className="settings-radio__option";const Te=document.createElement("input");Te.type="radio",Te.name="obsidianLinkMode",Te.value=f,Te.checked=pi===f,Te.disabled=!Mo,Te.addEventListener("change",()=>{if(!Te.checked)return;const De=Jo(f);cl(De),ha()});const pe=document.createElement("span");pe.textContent=B,F.append(Te,pe),Sr.push(Te),_r.appendChild(F)};zl(Ba,"Use title"),zl(qi,"Use id"),Er.append(kr,_r,Ir),et.appendChild(Er),_e.obsidianModeInputs=Sr;const{row:$p,input:Pp}=Zn({id:"toggleStripParentheses",label:"Hide parentheses in names",hint:"Display item names without trailing text in parentheses.",checked:fi,className:"map-controls__toggle",onChange:f=>{const B=qo(f);Ja(B)}});et.appendChild($p),_e.stripParentheticalToggle=Pp;const ga=document.createElement("label");ga.className="settings-text",ga.setAttribute("for","obsidianVaultInput");const Cr=document.createElement("div");Cr.className="settings-text__text";const xr=document.createElement("span");xr.className="settings-text__label",xr.textContent="Obsidian vault";const Tr=document.createElement("span");Tr.className="settings-text__hint",Tr.textContent="Optional. Set the vault name to avoid duplicates.",Cr.append(xr,Tr);const Xn=document.createElement("input");Xn.type="text",Xn.id="obsidianVaultInput",Xn.className="settings-text__input",Xn.placeholder="Vault name",Xn.value=Bo,Xn.addEventListener("input",()=>{const f=Yo(Xn.value);ul(f),ha()}),ga.append(Cr,Xn),et.appendChild(ga),_e.obsidianVaultInput=Xn;const Ar=document.createElement("p");Ar.className="settings-note",Ar.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',et.appendChild(Ar);const Gl=f=>`${(f/1e3).toFixed(1)}s`,ba=document.createElement("label");ba.className="settings-slider",ba.setAttribute("for","seriesNavDoubleClickWait");const Lr=document.createElement("div");Lr.className="settings-slider__text";const Nr=document.createElement("span");Nr.className="settings-slider__label",Nr.textContent="Series double-click wait";const Mr=document.createElement("span");Mr.className="settings-slider__hint",Mr.textContent="Time window to double-click into another map version.",Lr.append(Nr,Mr);const Bi=document.createElement("span");Bi.className="settings-slider__value",Bi.textContent=Gl(Fn);const bn=document.createElement("input");bn.type="range",bn.id="seriesNavDoubleClickWait",bn.className="settings-slider__input",bn.min=String(Vs),bn.max=String(Ds),bn.step="50",bn.value=String(Fn),bn.setAttribute("aria-label","Adjust double-click wait for series navigation"),bn.addEventListener("input",()=>{const f=Go(parseInt(bn.value,10));Bi.textContent=Gl(f),ll(f)}),ba.append(Lr,Bi,bn),et.appendChild(ba),_e.seriesNavInput=bn,_e.seriesNavValue=Bi;const Jl=f=>`${Math.round((f-1)*100)}%`,wa=document.createElement("label");wa.className="settings-slider",wa.setAttribute("for","hoverScaleSlider");const Br=document.createElement("div");Br.className="settings-slider__text";const Rr=document.createElement("span");Rr.className="settings-slider__label",Rr.textContent="Hover zoom";const $r=document.createElement("span");$r.className="settings-slider__hint",$r.textContent="Expand tiles on hover to see more detail.",Br.append(Rr,$r);const Ri=document.createElement("span");Ri.className="settings-slider__value",Ri.textContent=Jl(To);const wn=document.createElement("input");wn.type="range",wn.id="hoverScaleSlider",wn.className="settings-slider__input",wn.min=String(bt),wn.max=String(Ve),wn.step="0.1",wn.value=String(To),wn.setAttribute("aria-label","Adjust hover zoom"),wn.addEventListener("input",()=>{const f=Vo(parseFloat(wn.value));Ri.textContent=Jl(f),Xs(f),W&&Wn()}),wa.append(Br,Ri,wn),et.appendChild(wa),_e.hoverScaleInput=wn,_e.hoverScaleValue=Ri;let Xt=null,oo=null;const Pr=f=>{const B=Math.round((1-f)*100);return B===0?"Off":`${B}% dim`},{row:Op,input:Vp}=Zn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Hn,className:"map-controls__toggle",onChange:f=>{const B=jo(f);el(B),Xt&&(Xt.disabled=!B),oo&&(oo.textContent=Pr(B?Un:1))}});et.appendChild(Op),_e.selectionDimToggle=Vp;const va=document.createElement("label");va.className="settings-slider",va.setAttribute("for","selectionDimmingSlider");const Or=document.createElement("div");Or.className="settings-slider__text";const Vr=document.createElement("span");Vr.className="settings-slider__label",Vr.textContent="Dimming strength";const Dr=document.createElement("span");Dr.className="settings-slider__hint",Dr.textContent="Adjust how much unrelated tiles fade when dimming is on.",Or.append(Vr,Dr),oo=document.createElement("span"),oo.className="settings-slider__value",oo.textContent=Pr(Hn?Un:1),Xt=document.createElement("input"),Xt.type="range",Xt.id="selectionDimmingSlider",Xt.className="settings-slider__input",Xt.min=String(At),Xt.max=String(vt),Xt.step="0.05",Xt.value=String(Un),Xt.disabled=!Hn,Xt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Xt.addEventListener("input",()=>{const f=Do(parseFloat(Xt.value));oo.textContent=Pr(f),Qs(f)}),va.append(Or,oo,Xt),et.appendChild(va),_e.selectionDimInput=Xt,_e.selectionDimValue=oo;const Kl=f=>f===1?"Default":`${Math.round(f*100)}%`,ya=document.createElement("label");ya.className="settings-slider",ya.setAttribute("for","tileCompactnessSlider");const Ur=document.createElement("div");Ur.className="settings-slider__text";const Hr=document.createElement("span");Hr.className="settings-slider__label",Hr.textContent="Tile compactness";const Fr=document.createElement("span");Fr.className="settings-slider__hint",Fr.textContent="Adjust padding, gap, and logo size for tiles.",Ur.append(Hr,Fr);const $i=document.createElement("span");$i.className="settings-slider__value",$i.textContent=Kl(Ao);const vn=document.createElement("input");vn.type="range",vn.id="tileCompactnessSlider",vn.className="settings-slider__input",vn.min=String(gs),vn.max=String(bs),vn.step="0.05",vn.value=String(Ao),vn.setAttribute("aria-label","Adjust tile compactness"),vn.addEventListener("input",()=>{const f=Uo(parseFloat(vn.value));$i.textContent=Kl(f),nl(f),W&&Wn()}),ya.append(Ur,$i,vn),et.appendChild(ya),_e.tileCompactnessInput=vn,_e.tileCompactnessValue=$i;const{row:Dp,input:Up}=Zn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:Ra!=="nowrap",className:"map-controls__toggle",onChange:f=>{const B=f?"wrap":"nowrap";Wo(B),al(B)}});et.appendChild(Dp),_e.titleWrapInput=Up;const ql=f=>`${Math.round((f-1)*100)}% extra`,Sa=document.createElement("label");Sa.className="settings-slider",Sa.setAttribute("for","titleHoverWidthSlider");const Wr=document.createElement("div");Wr.className="settings-slider__text";const jr=document.createElement("span");jr.className="settings-slider__label",jr.textContent="Title width on hover";const zr=document.createElement("span");zr.className="settings-slider__hint",zr.textContent="Give titles more room horizontally when zoomed.",Wr.append(jr,zr);const Pi=document.createElement("span");Pi.className="settings-slider__value",Pi.textContent=ql(Lo);const yn=document.createElement("input");yn.type="range",yn.id="titleHoverWidthSlider",yn.className="settings-slider__input",yn.min=String(us),yn.max=String(ps),yn.step="0.05",yn.value=String(Lo),yn.setAttribute("aria-label","Adjust title width boost on hover"),yn.addEventListener("input",()=>{const f=Ho(parseFloat(yn.value));Pi.textContent=ql(f),ol(f)}),Sa.append(Wr,Pi,yn),et.appendChild(Sa),_e.titleWidthInput=yn,_e.titleWidthValue=Pi;const Yl=f=>`${Math.round(f*100)}% of hover zoom`,Ea=document.createElement("label");Ea.className="settings-slider",Ea.setAttribute("for","titleZoomPortionSlider");const Gr=document.createElement("div");Gr.className="settings-slider__text";const Jr=document.createElement("span");Jr.className="settings-slider__label",Jr.textContent="Title zoom influence";const Kr=document.createElement("span");Kr.className="settings-slider__hint",Kr.textContent="How much the title scales relative to tile hover zoom.",Gr.append(Jr,Kr);const Oi=document.createElement("span");Oi.className="settings-slider__value",Oi.textContent=Yl(No);const Sn=document.createElement("input");Sn.type="range",Sn.id="titleZoomPortionSlider",Sn.className="settings-slider__input",Sn.min=String(fs),Sn.max=String(ms),Sn.step="0.05",Sn.value=String(No),Sn.setAttribute("aria-label","Adjust how much titles scale on hover"),Sn.addEventListener("input",()=>{const f=Fo(parseFloat(Sn.value));Oi.textContent=Yl(f),il(f)}),Ea.append(Gr,Oi,Sn),et.appendChild(Ea),_e.titleZoomInput=Sn,_e.titleZoomValue=Oi;const Hp=typeof _t.isEnabled=="function"?_t.isEnabled():!1,{row:Fp,input:Wp}=Zn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:Hp,className:"apicurio-toggle",onChange:f=>{typeof _t.setEnabled=="function"&&_t.setEnabled(f)}});if(Ie=Wp,et.appendChild(Fp),dn.appendChild(et),T)T.hidden=!1,T.classList.remove("pf-v5-c-page__main-section"),dn.appendChild(T);else{const f=document.createElement("p");f.className="muted",f.textContent="Source editor unavailable.",dn.appendChild(f)}A.appendChild(dn),_t.mount(N);let Zl=0;de.m.categories.forEach(f=>{const B=document.createElement("section");B.className="category",B.dataset.cat=f.id;const F=Ce?zu(f,Ne):null,Te=(f.items||[]).some(q=>bi(q.stage)),pe=document.createElement("div");pe.className="cat-head",pe.dataset.cat=f.id,pe.tabIndex=0,Ce&&Number.isInteger(F)?(pe.dataset.seriesVersionIndex=String(F),pe.title="Open this category's map in the series",pe.classList.add("cat-head--series-link")):pe.title="Select category",pe.innerHTML=`<div class="cat-title">${Ii(f.title||f.id)}</div>
                          ${Te?`<span class="cat-stage-indicator" title="Contains staged items">Stage</span>
                                 <button type="button" class="cat-stage-clear" title="Clear all stages in this category" aria-label="Clear all stages">×</button>`:""}
                          <div class="muted cat-count">${(f.items||[]).length} items</div>`,pe.addEventListener("click",()=>{var Ht;const q=pe.dataset.seriesVersionIndex!=null?parseInt(pe.dataset.seriesVersionIndex,10):null,Ye=p[y],Qt=Ye?Gn(Ye):-1;Ce&&((Ht=Ye==null?void 0:Ye.apicurioVersions)==null?void 0:Ht.length)>1&&Number.isInteger(q)&&q!==Qt&&ua(y,q)||Jn(f.id)}),pe.addEventListener("keydown",q=>{(q.key==="Enter"||q.key===" ")&&(q.preventDefault(),pe.click())});const De=pe.querySelector(".cat-stage-clear");De&&De.addEventListener("click",q=>{q.preventDefault(),q.stopPropagation(),au(f.id)&&fn("Cleared stages for this category.",1400)}),pe.addEventListener("focus",()=>Jn(f.id,{scrollIntoView:!1})),B.appendChild(pe);const Oe=document.createElement("div");if(Oe.className="grid"+(Et?" is-centered":""),B.appendChild(Oe),(f.items||[]).forEach(q=>{Zl+=1;const Ye=$l(q.external),Qt=Rl(q,{externalMeta:Ye,seriesIdLookup:Ne}),He=document.createElement("div");if(He.className=Ye.isExternal?"tile external":"tile",He.tabIndex=0,He.dataset.id=q.id,He.dataset.globalIndex=String(Zl),Ye.url&&(He.dataset.externalUrl=Ye.url),!Ce){let Ln=null;if(Ne.has(q.id)&&(Ln=Ne.get(q.id)),Number.isInteger(Ln)){He.dataset.seriesVersionIndex=String(Ln),He.classList.add("tile--series-link");const jp=Ln===ht?"Current map in this series":`Open version ${Ln+1} in this series`;rt(He,jp)}}Qt&&(He.dataset.obsidianUrl=Qt);const Ht=bi(q.stage);if(Ht&&(He.dataset.stage=String(Ht),Et&&(He.style.gridColumn=String(Ht))),!Ce){const Ln=Ya(q.id);Ln!==-1&&Ln!==y&&(He.classList.add("tile--series-link"),He.dataset.navTargetIndex=String(Ln))}const En=document.createElement("img");En.className="logo",q.logo?(En.src=q.logo,En.alt=q.name||q.id):(En.alt="",En.style.opacity=1,En.src=Wu(q.name||q.id,q.color));const yo=document.createElement("div");yo.className="name",yo.textContent=Si(q);const So=document.createElement("div");So.className="tile-id",So.textContent=q.id||"";let Vi=null;Ht&&(Vi=document.createElement("div"),Vi.className="tile-stage",Vi.textContent=String(Ht));const qr=document.createElement("div");qr.className="badge",qr.textContent="reused";let io=null;Ce||(io=document.createElement("button"),io.type="button",io.className="tile-delete",io.setAttribute("aria-label",`Delete ${q.name||q.id}`),io.textContent="×",io.addEventListener("click",Ln=>{Ln.stopPropagation(),yp(q.id)})),Ye.url&&He.appendChild(tp(Ye.url)),Pl(He,Qt),io&&He.appendChild(io),He.appendChild(En),He.appendChild(yo),He.appendChild(So),Vi&&He.appendChild(Vi),He.appendChild(qr),Oe.appendChild(He),gt.set(q.id,{el:He,catId:f.id,rect:null})}),$t.appendChild(B),Mn.set(f.id,{el:B,headEl:pe}),!Ce){const q=document.createElement("button");q.type="button",q.className="tile-add",q.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',q.hidden=Et,q.tabIndex=Et?-1:0,q.setAttribute("aria-hidden",Et?"true":"false"),q.addEventListener("click",()=>lp(f.id)),Oe.appendChild(q)}});let Pn=null;Ce||(Pn=document.createElement("button"),Pn.type="button",Pn.className="category-add",Pn.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',Pn.addEventListener("click",()=>Vl()),$t.appendChild(Pn)),Pn&&Et&&(Pn.hidden=!0,Pn.tabIndex=-1,Pn.setAttribute("aria-hidden","true")),Ws(),rr(),qu(),pa(),Tn(),ei(),ap()}function qu(){if(_.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var A;if(typeof n.button=="number"&&n.button!==0)return;go();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,c=p[y],u=c?Gn(c):-1,g=((A=c==null?void 0:c.apicurioVersions)==null?void 0:A.length)>1&&Number.isInteger(i)&&i!==u,h=Number.isInteger(s)&&s!==y&&s>=0&&s<p.length,S=Cn&&Cn.id===o&&Cn.targetVersionIndex===i,$=xn&&xn.id===o&&xn.targetIndex===s;if(Cn&&!S&&Qo(),xn&&!$&&er(),g)if(S){if(Qo(),ua(y,i))return}else Iu(o,i,c);else if(h){if($){er(),Ot(s);return}_u(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&fn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),W===o&&!(g&&S)&&!(h&&$)){ti();return}Mt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):Ya(o);i!==-1&&i!==y&&Ot(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{W&&Wn()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),!vl){vl=!0;const e=()=>{Wn()};window.addEventListener("resize",Wn),window.addEventListener("blockscape:zoom",e),window.addEventListener("scroll",Wn,{passive:!0}),window.addEventListener("resize",Ol),window.visualViewport&&(window.visualViewport.addEventListener("resize",Wn),window.visualViewport.addEventListener("scroll",Wn,{passive:!0})),document.addEventListener("click",t=>{var s,c,u;if(!W&&!Xe||typeof t.button=="number"&&t.button!==0)return;const n=t.target,o=(s=n==null?void 0:n.closest)==null?void 0:s.call(n,".tile"),i=(c=n==null?void 0:n.closest)==null?void 0:c.call(n,".cat-head"),a=(u=n==null?void 0:n.closest)==null?void 0:u.call(n,".tile-context-menu");o||i||a||ti()})}document.getElementById("clear").onclick=()=>ti()}function pa(){gt.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function Ll(e,{includeSecondary:t=In}={}){if(!e||!de)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(de.fwd.get(e)||[]),o=new Set(de.rev.get(e)||[]),i=new Set,a=new Set,s=[],c=new Set,u=(g,h,S,$)=>{if(!g||!h)return;const A=`${g}->${h}:${S}:${$}`;c.has(A)||(c.add(A),s.push({from:g,to:h,type:S,depth:$}))};return n.forEach(g=>u(e,g,"dep",1)),o.forEach(g=>u(e,g,"revdep",1)),t&&new Set([...n,...o]).forEach(h=>{(de.fwd.get(h)||new Set).forEach(A=>{const N=A===e;N||i.add(A),N||u(h,A,"dep",2)}),(de.rev.get(h)||new Set).forEach(A=>{const N=A===e;N||a.add(A),N||u(h,A,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function fa(e,t){const n=gt.get(e);n&&n.el.classList.add(t)}function Mt(e){var c,u,g;if(!e)return;Xe=null,W=e,pt=null,Wt=Ll(e),nn(),ma(),ei();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=Wt;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=gt.get(e);a&&a.el.classList.add("selected"),t.forEach(h=>fa(h,"dep")),n.forEach(h=>fa(h,"revdep")),o.forEach(h=>{!t.has(h)&&h!==e&&fa(h,"dep-indirect")}),i.forEach(h=>{!n.has(h)&&!t.has(h)&&h!==e&&fa(h,"revdep-indirect")}),Tn();const s=(g=(u=(c=gt.get(e))==null?void 0:c.el)==null?void 0:u.dataset)==null?void 0:g.externalUrl;s&&fn("This item has link to",hn,s),ja()}function Jn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,c;if(!((s=de==null?void 0:de.m)!=null&&s.categories)||!e)return!1;const i=(de.m.categories||[]).find(u=>u.id===e);if(!i)return!1;go(),ar(),n||(pt=null),Xe=i.id,nn(),ei();const a=Mn.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(c=a.headEl)==null||c.focus({preventScroll:!0})),!0}function ei(){if(Mn.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!Xe)return;const e=Mn.get(Xe);if(!(e!=null&&e.el)){Xe=null,pt=null,nn();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function ki(){if(Xe)return Xe;const e=W?gt.get(W):null;return e!=null&&e.catId?e.catId:null}function Yu(e){var a,s,c,u;if(!((s=(a=de==null?void 0:de.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=de.m.categories,n=ki();let o=t.findIndex(g=>g.id===n);if(o===-1){const g=((c=t.find(h=>(h.items||[]).length))==null?void 0:c.id)||((u=t[0])==null?void 0:u.id);return g?Jn(g):!1}const i=o+e;return i<0||i>=t.length?!1:Jn(t[i].id)}function ar(){W=null,Wt=null,ma(),Tn(),ja({itemId:null})}function Zu(){Xe=null,pt=null,ei()}function ti(){ar(),Zu(),pt=null,nn()}function ma(){_.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function rr(){de!=null&&de.reusedLocal&&de.reusedLocal.forEach(e=>{const t=gt.get(e);if(!t)return;t.el.classList.toggle("reused",an);const n=t.el.querySelector(".badge");n&&(n.style.display=an?"inline-block":"none")})}function Tn(){for(;G.firstChild;)G.removeChild(G.firstChild);if(!W||G.hidden)return;Wt=Ll(W);const e=Wt,{primary:t,secondary:n}=ad();e.edges.forEach(o=>{var P,ee;const i=(P=gt.get(o.from))==null?void 0:P.rect,a=(ee=gt.get(o.to))==null?void 0:ee.rect;if(!i||!a)return;const s=Nl(i),c=Nl(a),u=Bl(Ml(i,c)||s,i,$s)||s,g=Bl(Ml(a,s)||c,a,$s)||c,h=document.createElementNS("http://www.w3.org/2000/svg","path"),S=(u.x+g.x)/2,$=u.y,A=(u.x+g.x)/2,N=g.y;h.setAttribute("d",`M ${u.x},${u.y} C ${S},${$} ${A},${N} ${g.x},${g.y}`),h.setAttribute("fill","none"),h.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),h.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),h.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&h.setAttribute("stroke-dasharray","4 3"),h.setAttribute("vector-effect","non-scaling-stroke"),G.appendChild(h)})}function Nl(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Ml(e,t){if(!e||!t)return null;const n=e.left+e.width/2,o=e.top+e.height/2,i=t.x-n,a=t.y-o;if(i===0&&a===0)return{x:n,y:o};const s=e.width/2,c=e.height/2,u=[];i!==0&&u.push((i>0?s:-s)/i),a!==0&&u.push((a>0?c:-c)/a);const g=Math.min(...u.filter(S=>S>0)),h=Number.isFinite(g)?g:0;return{x:n+i*h,y:o+a*h}}function Bl(e,t,n=0){if(!e||!t||n<=0)return e;const o=t.left+t.width/2,i=t.top+t.height/2,a=o-e.x,s=i-e.y,c=Math.hypot(a,s);if(!c)return e;const u=Math.min(n,c/2)/c;return{x:e.x+a*u,y:e.y+s*u}}function Ii(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Xu(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),Bo&&o.set("vault",Bo),`obsidian://advanced-uri?${o.toString()}`}function Qu(e){return e?pi===qi?e.id??e.name??"":e.name??e.id??"":""}function Rl(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!Mo||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=Qu(e);return Xu(o)}function $l(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function ep(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),li(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function tp(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),li(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Pl(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(ep(t))}function Ol(){Ue||(Ue=requestAnimationFrame(()=>{Ue=null,Ee=Ee.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),Ee.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function np(e,t){!e||!t||(Ee.push({labelEl:e,textEl:t}),Ol())}function op(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${Ii(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${Ii(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function _i(e,t,{offset:n=8}={}){!te||!e||!t||(te.innerHTML=t,te.hidden=!1,te.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=te.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let c=o.left+o.width/2-i.width/2+a,u=o.top-i.height-n+s;c<a+n&&(c=a+n);const g=a+window.innerWidth-i.width-n;c>g&&(c=g),u<s+n&&(u=o.bottom+n+s),te.style.left=`${c}px`,te.style.top=`${u}px`,te.classList.add("is-visible")}))}function Kn(){M&&(clearTimeout(M),M=null),te&&(te.classList.remove("is-visible"),te.setAttribute("aria-hidden","true"),te.hidden=!0)}function ip(e,t){if(!e)return;const n=Qe((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=op(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{ue=e,_i(e,`<div class="version-nav__tooltip-title">${Ii(n)}</div>`,{offset:10})},c=()=>{a(),i=setTimeout(()=>{ue===e&&_i(e,o,{offset:10})},$e)},u=()=>{s(),c()},g=()=>{ue!==e&&s(),c()},h=()=>{a(),ue===e&&(ue=null,Kn())};e.addEventListener("mouseenter",u),e.addEventListener("focus",u),e.addEventListener("pointermove",g),e.addEventListener("mouseleave",h),e.addEventListener("blur",h),e.addEventListener("click",h)}function ap(){V&&(V=!1,!(!L||!k)&&(Kn(),_i(L,k,{offset:12}),M=setTimeout(()=>{Kn(),rp()},1e3)))}function rp(){L&&(Q&&(clearTimeout(Q),Q=null),L.classList.add("blockscape-tab--twinkle"),Q=setTimeout(()=>{L.classList.remove("blockscape-tab--twinkle"),Q=null},1400))}window.addEventListener("scroll",Kn,!0),window.addEventListener("resize",Kn),Me&&Me.addEventListener("click",()=>{Tu()}),he&&he.addEventListener("click",()=>{Au()}),ot&&ot.addEventListener("click",()=>{try{Eu(),bu()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),mt&&mt.addEventListener("click",tr),O&&O.addEventListener("click",tr),x&&x.addEventListener("click",ca),X&&X.addEventListener("click",ca),_&&_.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");Kt||!t||!_.contains(t)||uu(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||pu(e)}),We&&We.addEventListener("click",()=>{gl("button")}),z&&z.addEventListener("click",()=>{if(y<0){alert("Load or select a model before creating a version.");return}try{const e=hl({versionLabel:"map edit"});Ot(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),je&&je.addEventListener("click",async()=>{var a;if(y<0||!p[y]){alert("Select or load a model before sharing.");return}const e={title:Qe(p[y],"Shared Model"),data:p[y].data};let t;try{t=qc(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),D&&D.addEventListener("click",()=>{const e=(m.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};W&&(n.selectedItemId=W),localStorage.setItem(it,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";W&&(t=`editor.html?selected=${encodeURIComponent(W)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==it||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||Cl("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===Nt&&Cl("message")})),document.addEventListener("keydown",e=>{var o,i,a,s,c,u,g,h,S,$;if(xu()){e.key==="Escape"&&(e.preventDefault(),tr());return}if(!(Y!=null&&Y.hidden)&&e.key==="Escape"){e.preventDefault(),ca();return}if((o=ho==null?void 0:ho.isOpen)==null?void 0:o.call(ho))return;const n=Kt;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const A=p[y],N=((i=A==null?void 0:A.apicurioVersions)==null?void 0:i.length)>1;gl("shortcut",N);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!bo())return;if(gp()){e.preventDefault();return}}if(e.key==="Escape"){let A=!1;Z&&!Z.hidden&&(go(),A=!0),(W||Xe)&&(ti(),A=!0),A&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!bo())return;const A=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if(Et&&e.shiftKey&&W&&!e.ctrlKey&&!e.metaKey&&ru(W,A)){e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&!e.shiftKey){ir(A)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(Xe&&!e.shiftKey){e.preventDefault();return}e.shiftKey?dp(A)&&e.preventDefault():up(A)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!bo())return;const A=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){hp(A)&&e.preventDefault();return}if(e.altKey)return;if(Xe&&!W&&!e.shiftKey){if(fp(A)){e.preventDefault();return}if(Yu(A)){e.preventDefault();return}}e.shiftKey?mp(A)&&e.preventDefault():pp(A)&&e.preventDefault()}if(e.key==="Delete"){if(n||!bo()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const A=Xe?vp():!1,N=A?!0:Dl();(A||N)&&e.preventDefault()}if(e.key==="F2"){if(n||!bo())return;const A=Xe&&!W&&Xe||!W&&((u=(c=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:c.dataset)==null?void 0:u.cat)||null;if(A&&!W&&cp(A)){e.preventDefault();return}const N=W||(($=(S=(h=(g=e.target)==null?void 0:g.closest)==null?void 0:h.call(g,".tile"))==null?void 0:S.dataset)==null?void 0:$.id);N&&ho.open(N)&&e.preventDefault()}if(e.key==="Insert"){if(n||!bo()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Vl()&&e.preventDefault()}}),window.addEventListener("resize",()=>{fu()}),window.addEventListener("scroll",()=>mu(),!0);function sp(e,t,n){if(y<0)return;const i=p[y].data.categories||[],a=i.find(h=>(h.items||[]).some(S=>S.id===e)),s=i.find(h=>h.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const c=a.items.findIndex(h=>h.id===e);if(c===-1)return;const[u]=a.items.splice(c,1);let g=s.items.length;if(t){const h=s.items.findIndex(S=>S.id===t);h!==-1&&(g=h)}s.items.splice(g,0,u),Vt(),Bt()}function lp(e){if(y<0||!e)return;const t=p[y].data,o=(t.categories||[]).find(u=>u.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:su(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),Vt(),Bt(),go(),Mt(s.id);const c=gt.get(s.id);c!=null&&c.el&&c.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Vl(){if(y<0)return!1;const e=p[y].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=lu(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),Xe=n,W=null,Wt=null,pt=null,Vt(),Bt(),Jn(n),console.log("[Blockscape] added category",n),!0}function cp(e=ki()){if(y<0||!e)return!1;const t=du.open(e);return t&&(W=null,Wt=null,nn()),t}function dp(e){if(!W||y<0||!e)return!1;const n=p[y].data.categories||[],o=gt.get(W);let i=null;if(o!=null&&o.catId&&(i=n.find(u=>u.id===o.catId)),i||(i=n.find(u=>(u.items||[]).some(g=>g.id===W))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(u=>u.id===W);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[c]=i.items.splice(a,1);return i.items.splice(s,0,c),Vt(),Bt(),Ei(),Mt(W),!0}function up(e){if(!de||!de.m||!e)return!1;const t=de.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(g=>(g.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!W){const u=n();return u?(Mt(u.item.id),!0):!1}const o=gt.get(W);let i=null;if(o!=null&&o.catId&&(i=t.find(u=>u.id===o.catId)),i||(i=t.find(u=>(u.items||[]).some(g=>g.id===W))),!i){const u=n();return u?(Mt(u.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(u=>u.id===W);if(s===-1)return!1;const c=s+e;return c<0||c>=a.length?!1:(Mt(a[c].id),!0)}function pp(e){if(!de||!de.m||!e)return!1;const t=de.m.categories||[];if(!t.length)return!1;const n=ki();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(W){const c=(t[o].items||[]).findIndex(u=>u.id===W);pt={catId:a.id,position:c===-1?0:c}}else pt=null;return Jn(a.id,{preserveEntryHint:!0})}function fp(e){var a;if(!Xe||!((a=de==null?void 0:de.m)!=null&&a.categories)||!e)return!1;const n=(de.m.categories||[]).find(s=>s.id===Xe);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(pt==null?void 0:pt.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,pt.position||0))),pt=null,Mt(o[i].id),!0}function mp(e){if(!W||y<0||!e)return!1;const n=p[y].data.categories||[];if(!n.length)return!1;const o=gt.get(W);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(S=>S.id===o.catId)),i===-1&&(i=n.findIndex(S=>(S.items||[]).some($=>$.id===W))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],c=n[a];if(!c)return!1;s.items=s.items||[],c.items=c.items||[];const u=s.items.findIndex(S=>S.id===W);if(u===-1)return!1;const g=Math.min(c.items.length,Math.max(0,u)),h=g<c.items.length?c.items[g].id:null;return sp(W,h,c.id),Ei(),Mt(W),!0}function hp(e){if(y<0||!e)return!1;const n=p[y].data.categories||[];if(!n.length)return!1;const o=ki();if(!o)return!1;const i=n.findIndex(c=>c.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),Xe=s.id,ar(),pt=null,nn(),Vt(),Bt(),ei(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function gp(){if(y<0)return!1;const e=p[y],t=kt(e)||(e?e.id:null),n=[];if(St&&t===St.modelId&&n.push({...St,type:"item"}),pn&&t===pn.modelId&&n.push({...pn,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(wp(o))return!0}else if(o.type==="item"&&bp(o))return!0;return!1}function bp(e){const t=p[y],n=kt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(c=>c.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),St=null,go(),W=null,Wt=null,nn(),Vt(),Bt(),Ei(),Mt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function wp(e){const t=p[y],n=kt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),pn=null,W=null,Wt=null,Xe=e.category.id,pt=null,nn(),Vt(),Bt(),ei(),Jn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function Dl(){if(!W||y<0)return!1;const t=p[y].data.categories||[];if(!t.length)return!1;const n=gt.get(W);let o=null;if(n!=null&&n.catId&&(o=t.find(g=>g.id===n.catId)),o||(o=t.find(g=>(g.items||[]).some(h=>h.id===W))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(g=>g.id===W);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=p[y];St={item:a,categoryId:o.id,index:i,modelId:kt(s)||(s?s.id:null),ts:Date.now()};const u=(()=>{var h;if(o.items.length){const S=Math.min(i,o.items.length-1);return((h=o.items[S])==null?void 0:h.id)||null}const g=t.findIndex(S=>S.id===o.id);if(g===-1)return null;for(let S=g+1;S<t.length;S++){const $=t[S].items||[];if($.length)return $[0].id}for(let S=g-1;S>=0;S--){const $=t[S].items||[];if($.length)return $[0].id}return null})();return go(),W=null,Wt=null,pt=null,nn(),Vt(),Bt(),Ei(),u?Mt(u):ti(),console.log("[Blockscape] removed item",a.id),!0}function vp(){var c,u;const e=ki();if(!e||y<0)return!1;const n=p[y].data.categories||[];if(!n.length)return!1;const o=n.findIndex(g=>g.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=p[y];pn={category:i,index:o,modelId:kt(a)||(a?a.id:null),ts:Date.now()},Xe=null,W=null,Wt=null,pt=null,nn(),Vt(),Bt();const s=((c=n[o])==null?void 0:c.id)||((u=n[o-1])==null?void 0:u.id)||null;return s?Jn(s):ti(),console.log("[Blockscape] removed category",i.id),!0}function yp(e){if(!e)return!1;const t=W;W=e;const n=Dl();return n||(W=t,nn()),n}ie&&ie.addEventListener("click",async()=>{const e=m.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await Zs(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),R&&R.addEventListener("click",async()=>{const e=wu();if(!e){alert("No series available to copy. Create another version first.");return}await Zs(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),me&&me.addEventListener("click",async()=>{try{const e=await vd();if(!e){alert("Clipboard is empty.");return}m.value=e,m.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await yi(),t=zn(m.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=$n(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),y===-1&&n!=null?Ot(n):jn(),e&&await Ul(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(y<0){alert("No active model selected.");return}try{const t=JSON.parse(m.value);if(Rn(t,{titleHint:Qe(p[y]),idHint:kt(p[y])||Qe(p[y])}),p[y].data=t,p[y].title=t.title||p[y].title,p[y].isSeries||((e=p[y].apicurioVersions)==null?void 0:e.length)>1){const n=p[y].title||Qe(p[y]);Jt(p[y],{seriesName:n,fallbackTitle:n})}Za(),console.log("[Blockscape] replaced active model:",Qe(p[y])),Bt(),_t.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=zn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((c,u)=>{var P;const g=(((P=c.data)==null?void 0:P.title)??"").toString().trim(),h=s.length>1?`${o.name} #${u+1}`:o.name,S=`${a} series`,$=c.isSeries?S:null;let A={...c};if(c.isSeries){const ee=$||g||c.title||h||"unknown";A.title=ee;const Ne=kn(ee||"unknown");mo(A,Ne),Jt(A,{seriesName:ee,fallbackTitle:"unknown"}),A.apicurioArtifactName=A.apicurioArtifactName||ee}else A.title=g||h;const N=$n({...A,apicurioArtifactName:A.apicurioArtifactName||$||A.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=N)})}y===-1&&n!=null?Ot(n):jn()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",Sp);async function Sp(e){var a;if(!bo())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Vu(t))return;let n=[];try{const s=await yi();n=zn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,c)=>{const u=$n(s,{versionLabel:n.length>1?`paste #${c+1}`:"paste"});o==null&&(o=u),i.push(u)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&Ot(o),await yi()&&await Ul(i,{origin:"clipboard"})}async function Ul(e,{origin:t="clipboard"}={}){if(!await yi()||typeof(tt==null?void 0:tt.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter($=>{const A=p[$];return A&&!A.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=p[o[0]],s=Id(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const c=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(c==null)return;const u=fo(c);if(!u){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const g=await Ed(),h=[];for(let $=0;$<o.length;$++){const A=o.length===1?u:Sd(u,$+1),N=kd(A,g);if(!N){alert("Could not find a unique filename to save.");return}g.add(N),h.push(N)}let S=null;for(let $=0;$<o.length;$++){const A=o[$],N=h[$],P=p[A];if(!P)continue;o.length===1&&_d(P,N);const ee=await tt.saveModelByIndex(A,N,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(ee!=null&&ee.ok)){alert(`Local auto-save failed: ${(ee==null?void 0:ee.error)||"unknown error"}`);return}S==null&&(S=N)}S&&(ia(S),dd(S,{origin:t})),await tt.refresh(),jn(),fn(`Saved ${o.length} ${i}.`,2500)}J.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&Ot(n)}),document.getElementById("removeModel").onclick=()=>{if(y<0)return;const e=Qe(p[y]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",Qe(p[y])),p.splice(y,1),!p.length){y=-1,de=null,_.innerHTML="",G.innerHTML="",m.value="",jn(),Za();return}const n=Math.min(y,p.length-1);Ot(n)},ve&&(ve.addEventListener("input",e=>{or(e.target.value||"")}),ve.addEventListener("focus",()=>{ve.value&&ve.value.trim()&&Sl(ve.value)})),ce&&ce.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;Bu({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!ce||ce.hidden)return;const t=e.target;ce.contains(t)||ve&&(t===ve||ve.contains(t))||(ce.hidden=!0)}),document.addEventListener("click",e=>{var o,i,a;const t=(i=(o=e.target)==null?void 0:o.closest)==null?void 0:i.call(o,"a[href]");if(!t||(a=t.classList)!=null&&a.contains("blockscape-gist-link")||t.hasAttribute("download"))return;const n=t.getAttribute("href");Ec(n)&&(e.preventDefault(),e.stopPropagation(),li(kc(n)))}),C&&se&&j&&C.addEventListener("submit",async e=>{e.preventDefault();const t=se.value.trim();if(!t){alert("Please enter a URL"),se.focus();return}const n=await sr(t);if(typeof n=="number"){Ot(n),se.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!se||!t)return;let n=null;se.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=se.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function Bt(){if(!(y<0))try{da(p[y]),de=Fu(p[y].data),Ei()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Ep(){const e=["Kubernetes.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>Ki?Ki.endsWith("/")?`${Ki}${n}`:`${Ki}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=zn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(c=>{let u={...c};if(c.isSeries){const g=`${a} series`;u={...c,title:g,apicurioArtifactName:g};const h=kn(g||"unknown");mo(u,h),Jt(u,{seriesName:g,fallbackTitle:"unknown"})}$n(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}jn()}async function Hl(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function kp(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>Ip(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");Wl(i)&&Fl(o,i)})}function Ip(e){var c,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(c=e.parentNode)==null?void 0:c.closest)!=null&&u.call(c,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:g,index:h})=>{h>s&&a.appendChild(document.createTextNode(t.slice(s,h))),a.appendChild(_p(g)),s=h+g.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function _p(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Wl(e)&&Fl(t,e),t}function Fl(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Cp(n,t,e)))}async function Cp(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await sr(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Wl(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function sr(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Hl(e),o=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=zn(t,o)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let a=null;return i.forEach((s,c)=>{var A;const u=(((A=s.data)==null?void 0:A.title)??"").toString().trim(),g=i.length>1?`${o} #${c+1}`:o,h=s.isSeries?`${o} series`:null;let S={...s};if(s.isSeries){const N=h||u||S.title||g;S={...s,title:N,apicurioArtifactName:N||s.apicurioArtifactName};const P=kn(N||"unknown");mo(S,P),Jt(S,{seriesName:N||h||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:P,url:e,baseName:o,seriesTitle:N})}const $=$n({...S,title:u||S.title||g,apicurioArtifactName:S.apicurioArtifactName||h||s.apicurioArtifactName},{versionLabel:o});a==null&&(a=$)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,o),y===-1&&a!=null?Ot(a):jn(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=zn(n,"Blockscape");if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(A=>{const N=$n(A,{versionLabel:"seed"});i==null&&(i=N)}),await Xc(),!await Us&&l.autoLoadFromDir&&await Ep();const s=await Uu(),c=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,u=await Hu(),g=_l(),h=g==null?void 0:g.index,S=Du(),$=typeof c=="number"?c:typeof u=="number"?u:typeof S=="number"?S:typeof h=="number"?h:i??0;Ot($),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===$&&requestAnimationFrame(()=>{var N;if(y!==s.modelIndex)return;const A=(N=gt.get(s.itemId))==null?void 0:N.el;A&&(Mt(s.itemId),A.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),A.focus({preventScroll:!0}))})})()}const Ac=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function Lc(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function Nc(r){return Ac(Lc())}const Mc=`${Nc()}documentation/`;function Bc(r){let l;return{c(){l=U("div"),l.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Open the <a href="${Mc}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,b(l,"id","shortcutHelp"),b(l,"class","shortcut-help"),l.hidden=!0,b(l,"aria-hidden","true"),b(l,"role","dialog"),b(l,"aria-modal","true"),b(l,"aria-labelledby","shortcutHelpTitle")},m(m,T){Pt(m,l,T)},p:Ft,i:Ft,o:Ft,d(m){m&&xt(l)}}}class Rc extends Gi{constructor(l){super(),zi(this,l,null,Bc,Di,{})}}const $c=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
        * optional \`stage\`: integer 1–4 for Wardley maps only (1=genesis, 2=custom, 3=product, 4=commodity/service). Include only when the user explicitly asks for a Wardley model/series.
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping. Only include the \`stage\` field when explicitly asked for a Wardley map/series.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function ls(r){let l,m,T,_,G,te,J,Z;return{c(){l=U("div"),m=U("div"),T=U("a"),_=Ui("Open Blockscape GPT"),G=ae(),te=U("div"),te.textContent="Paste the copied prompt into that chat.",J=ae(),Z=U("div"),Z.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',b(T,"href",Oc),b(T,"target","_blank"),b(T,"rel","noreferrer"),b(te,"class","new-panel__hint"),b(m,"class","new-panel__link"),b(Z,"class","new-panel__link new-panel__link--disabled"),b(l,"class","new-panel__links")},m(C,se){Pt(C,l,se),E(l,m),E(m,T),E(T,_),E(m,G),E(m,te),E(l,J),E(l,Z)},p:Ft,d(C){C&&xt(l)}}}function cs(r){let l,m,T,_,G,te;return{c(){l=U("div"),m=U("div"),m.textContent="Generated prompt",T=ae(),_=U("textarea"),b(m,"class","new-panel__prompt-label"),b(_,"class","pf-v5-c-form-control new-panel__textarea"),b(_,"rows","4"),_.readOnly=!0,b(l,"class","new-panel__prompt")},m(J,Z){Pt(J,l,Z),E(l,m),E(l,T),E(l,_),so(_,r[4]),G||(te=Nn(_,"input",r[12]),G=!0)},p(J,Z){Z&16&&so(_,J[4])},d(J){J&&xt(l),G=!1,te()}}}function Pc(r){let l,m,T,_,G,te,J,Z,C,se,j,re,fe,st,Fe,We,je,z,D,ie,R,me,Me,he,ot,Se,le,mt,O,Y,x,X,ve,ce,ye,Ae,ge,Re,w,dt,ut,lt,Lt,It,Le,it,Nt,Je=r[2]==="gpt"&&ls(),ct=r[4]&&r[5]&&cs(r);return Le=oc(r[10][0]),{c(){l=U("div"),m=U("div"),T=ae(),_=U("div"),G=U("div"),G.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',te=ae(),J=U("form"),Z=U("div"),C=U("label"),C.textContent="Domain",se=ae(),j=U("p"),j.textContent="Describe what you want to create a map for.",re=ae(),fe=U("textarea"),st=ae(),Fe=U("div"),We=U("label"),je=U("input"),z=ae(),D=U("span"),D.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,ie=ae(),R=U("fieldset"),me=U("legend"),me.textContent="Target",Me=ae(),he=U("p"),he.textContent="Choose where you plan to use the prompt.",ot=ae(),Se=U("label"),le=U("input"),mt=ae(),O=U("div"),O.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',Y=ae(),x=U("label"),X=U("input"),ve=ae(),ce=U("div"),ce.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',ye=ae(),Ae=U("div"),ge=U("button"),ge.textContent="Copy prompt",Re=ae(),w=U("button"),w.textContent="New blank",dt=ae(),ut=U("div"),lt=Ui(r[3]),Lt=ae(),Je&&Je.c(),It=ae(),ct&&ct.c(),b(m,"id","newPanelBackdrop"),b(m,"class","shortcut-help__backdrop"),b(G,"class","shortcut-help__header"),b(C,"for","newDomain"),b(j,"class","new-panel__hint"),b(fe,"id","newDomain"),b(fe,"class","pf-v5-c-form-control new-panel__textarea"),b(fe,"rows","4"),fe.required=!0,b(fe,"placeholder","Ex: Companies building open-source geospatial tools"),b(Z,"class","new-panel__field"),b(je,"id","seriesToggle"),b(je,"type","checkbox"),b(We,"class","new-panel__toggle"),b(We,"for","seriesToggle"),b(Fe,"class","new-panel__field"),b(he,"class","new-panel__hint"),b(le,"type","radio"),b(le,"name","target"),le.__value="gpt",so(le,le.__value),b(Se,"class","new-panel__option"),b(X,"type","radio"),b(X,"name","target"),X.__value="plain",so(X,X.__value),b(x,"class","new-panel__option"),b(R,"class","new-panel__field"),b(ge,"class","pf-v5-c-button pf-m-primary"),b(ge,"type","submit"),b(w,"id","newBlankButton"),b(w,"class","pf-v5-c-button pf-m-secondary"),b(w,"type","button"),b(w,"title","Start from an empty map"),b(ut,"class","new-panel__status"),b(ut,"aria-live","polite"),b(Ae,"class","new-panel__actions"),b(J,"class","shortcut-help__list new-panel__form"),b(_,"class","shortcut-help__panel"),b(_,"tabindex","-1"),b(l,"id","newPanel"),b(l,"class","shortcut-help"),l.hidden=!0,b(l,"aria-hidden","true"),b(l,"role","dialog"),b(l,"aria-modal","true"),b(l,"aria-labelledby","newPanelTitle"),Le.p(le,X)},m(Ke,Be){Pt(Ke,l,Be),E(l,m),E(l,T),E(l,_),E(_,G),E(_,te),E(_,J),E(J,Z),E(Z,C),E(Z,se),E(Z,j),E(Z,re),E(Z,fe),so(fe,r[0]),E(J,st),E(J,Fe),E(Fe,We),E(We,je),je.checked=r[1],E(We,z),E(We,D),E(J,ie),E(J,R),E(R,me),E(R,Me),E(R,he),E(R,ot),E(R,Se),E(Se,le),le.checked=le.__value===r[2],E(Se,mt),E(Se,O),E(R,Y),E(R,x),E(x,X),X.checked=X.__value===r[2],E(x,ve),E(x,ce),E(J,ye),E(J,Ae),E(Ae,ge),E(Ae,Re),E(Ae,w),E(Ae,dt),E(Ae,ut),E(ut,lt),E(J,Lt),Je&&Je.m(J,null),E(J,It),ct&&ct.m(J,null),it||(Nt=[Nn(fe,"input",r[7]),Nn(je,"change",r[8]),Nn(le,"change",r[9]),Nn(X,"change",r[11]),Nn(J,"submit",nc(r[6]))],it=!0)},p(Ke,[Be]){Be&1&&so(fe,Ke[0]),Be&2&&(je.checked=Ke[1]),Be&4&&(le.checked=le.__value===Ke[2]),Be&4&&(X.checked=X.__value===Ke[2]),Be&8&&Qr(lt,Ke[3]),Ke[2]==="gpt"?Je?Je.p(Ke,Be):(Je=ls(),Je.c(),Je.m(J,It)):Je&&(Je.d(1),Je=null),Ke[4]&&Ke[5]?ct?ct.p(Ke,Be):(ct=cs(Ke),ct.c(),ct.m(J,null)):ct&&(ct.d(1),ct=null)},i:Ft,o:Ft,d(Ke){Ke&&xt(l),Je&&Je.d(),ct&&ct.d(),Le.r(),it=!1,Eo(Nt)}}}const Oc="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function Vc(r,l,m){let T="",_=!1,G="gpt",te="",J="",Z=!1;const C=()=>{var z;return typeof navigator<"u"&&!!((z=navigator.clipboard)!=null&&z.writeText)};function se(z){const D=z||"[DOMAIN]",ie=_?"series":"map",me=$c.replaceAll("[DOMAIN NAME]",D).replaceAll("[DOMAIN]",D).replaceAll("[map|series]",ie).split(`
`),Me=`Generate a **blockscape ${ie}** for the domain of ${D}.`,he=me.findIndex(Se=>Se.toLowerCase().includes("generate a **blockscape value")||Se.toLowerCase().includes("generate a blockscape [map|series]")||Se.toLowerCase().startsWith("generate a blockscape"));he>=0?me[he]=Me:me.unshift(Me);const ot=_?`

User requested a series (return an array of models).`:"";return`${me.join(`
`).trim()}${ot}`}async function j(z){z.preventDefault();const D=T.trim();if(m(3,te=""),m(5,Z=G!=="gpt"),!D){m(3,te="Add a domain to generate a prompt."),m(4,J="");return}if(G==="gpt"?m(4,J=`${_?"Create a series":"Create a map"} for ${D}`):(m(4,J=se(D)),m(5,Z=!0)),!C()){m(3,te="Clipboard access is unavailable. Copy the prompt below."),m(5,Z=!0);return}try{await navigator.clipboard.writeText(J),m(3,te=G==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),G==="gpt"&&m(5,Z=!1)}catch(R){console.warn("[Blockscape] clipboard write failed",R),m(3,te="Copy failed. Use the prompt below."),m(5,Z=!0)}}const re=[[]];function fe(){T=this.value,m(0,T)}function st(){_=this.checked,m(1,_)}function Fe(){G=this.__value,m(2,G)}function We(){G=this.__value,m(2,G)}function je(){J=this.value,m(4,J)}return[T,_,G,te,J,Z,j,fe,st,Fe,re,We,je]}class Dc extends Gi{constructor(l){super(),zi(this,l,Vc,Pc,Di,{})}}const{document:ds}=tc;function Uc(r){let l,m,T,_,G,te,J,Z,C,se,j,re,fe,st,Fe,We,je,z,D,ie,R,me,Me,he,ot,Se,le,mt,O,Y,x,X,ve,ce,ye,Ae,ge,Re,w,dt,ut,lt,Lt,It,Le,it,Nt,Je,ct,Ke,Be,p,y,_t,de,gt,Mn,W,Xe,Wt,pt,In,Kt,an,Dn,St,pn,lo,_n,hn,Cn,jt,xn,rn,sn,d,v,M,L,k,V,Q,K,Ie,ue,Ee=`<script id="seed" type="application/json">${r[5]}<\/script>`,Ue,ft,$e,Ct,Tt,bt,Ve,at,qt,ze,At,vt,wt,Yt,Bn;return ze=new Rc({}),vt=new Dc({}),{c(){l=U("link"),m=ae(),T=U("div"),_=U("header"),G=U("div"),te=U("div"),J=U("div"),Z=U("div"),Z.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',C=ae(),se=U("div"),j=U("div"),re=U("button"),fe=U("span"),fe.textContent="Advanced",st=ae(),Fe=U("span"),Fe.textContent="▾",je=ae(),z=U("button"),z.textContent="New",D=ae(),ie=U("label"),ie.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',R=ae(),me=U("div"),Me=U("span"),Me.textContent="Zoom",he=ae(),ot=U("button"),ot.textContent="-",Se=ae(),le=U("button"),mt=Ui(r[1]),O=ae(),Y=U("button"),Y.textContent="+",x=ae(),X=U("button"),X.textContent="Share",ve=ae(),ce=U("button"),ce.textContent="Help",ye=ae(),Ae=U("div"),ge=U("div"),ge.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',Re=ae(),w=U("form"),w.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',dt=ae(),ut=U("button"),ut.textContent="Edit",Le=ae(),it=U("a"),it.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',Je=ae(),ct=U("main"),Ke=U("div"),Be=U("aside"),p=U("div"),p.textContent="Models",y=ae(),_t=U("ul"),de=ae(),gt=U("div"),gt.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',Mn=ae(),W=U("section"),Xe=U("div"),Xe.innerHTML='<div class="sidebar-heading">Local files</div> <button id="toggleServerSidebar" class="pf-v5-c-button pf-m-tertiary" type="button" aria-pressed="false" hidden="">Wide menu</button>',Wt=ae(),pt=U("p"),pt.textContent="Checking for local server…",In=ae(),Kt=U("div"),an=U("label"),an.textContent="Blockscape files under ~/blockscape",Dn=ae(),St=U("div"),pn=U("label"),pn.textContent="Folder",lo=ae(),_n=U("select"),hn=U("option"),hn.textContent="Root (~/blockscape)",Cn=ae(),jt=U("select"),xn=ae(),rn=U("div"),rn.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button> <button id="deleteLocalFile" class="pf-v5-c-button pf-m-danger" type="button">Delete</button>',sn=ae(),d=U("div"),d.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',M=ae(),L=U("div"),L.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,stage?:1-4,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,k=ae(),V=U("footer"),Q=U("div"),Q.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',Ie=ae(),ue=new ac(!1),Ue=ae(),ft=Xr("svg"),$e=ae(),Ct=U("div"),Tt=ae(),bt=U("div"),Ve=ae(),at=U("div"),at.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',qt=ae(),xa(ze.$$.fragment),At=ae(),xa(vt.$$.fragment),ds.title="Blockscape — simple landscape-style tiles",b(l,"rel","icon"),b(l,"type","image/svg+xml"),b(l,"href","./favicon.svg"),b(Z,"class","blockscape-brand"),b(fe,"class","blockscape-toolbar__toggle-label"),b(Fe,"class","blockscape-toolbar__toggle-icon"),b(Fe,"aria-hidden","true"),b(re,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),b(re,"type","button"),b(re,"aria-expanded",r[0]),b(re,"aria-controls","blockscapeHeaderExtras"),b(re,"aria-label",We=r[0]?"Hide advanced tools":"Show advanced tools"),b(z,"id","newPanelButton"),b(z,"class","pf-v5-c-button pf-m-primary"),b(z,"type","button"),b(z,"title","Create something new"),b(ie,"class","pf-v5-c-button pf-m-primary blockscape-file"),b(Me,"class","blockscape-zoom__label"),b(ot,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),b(ot,"type","button"),b(ot,"title","Zoom out (Ctrl -)"),b(le,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__reset"),b(le,"type","button"),b(le,"title","Reset zoom (Ctrl 0)"),b(Y,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),b(Y,"type","button"),b(Y,"title","Zoom in (Ctrl +)"),b(me,"class","blockscape-zoom"),b(me,"role","group"),b(me,"aria-label","Zoom controls"),b(X,"id","shareModel"),b(X,"class","pf-v5-c-button pf-m-secondary"),b(X,"type","button"),b(X,"title","Copy a shareable URL for this model"),b(ce,"id","helpButton"),b(ce,"class","pf-v5-c-button pf-m-primary"),b(ce,"type","button"),b(ce,"title","Show keyboard shortcuts"),b(j,"class","blockscape-toolbar__primary"),b(ge,"class","blockscape-search"),b(w,"id","urlForm"),b(w,"class","blockscape-url-form"),b(w,"autocomplete","on"),w.noValidate=!0,b(ut,"id","openInEditor"),b(ut,"class","pf-v5-c-button pf-m-secondary"),b(ut,"type","button"),b(ut,"title","Open current JSON in the editor"),b(Ae,"id","blockscapeHeaderExtras"),b(Ae,"class","blockscape-toolbar__extras"),Ae.hidden=lt=!r[0],b(Ae,"aria-hidden",Lt=!r[0]),b(se,"class","blockscape-toolbar__controls"),b(se,"data-expanded",It=r[0]?"true":"false"),b(it,"href","https://github.com/pwright/blockscape"),b(it,"target","_blank"),b(it,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),b(it,"title","View on GitHub"),b(it,"aria-label","View Blockscape on GitHub"),b(J,"class","blockscape-toolbar"),b(te,"class","pf-v5-c-masthead__content"),b(G,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),b(_,"class","pf-v5-c-page__header"),_.hidden=Nt=!r[4],b(p,"class","sidebar-heading"),b(_t,"id","modelList"),b(_t,"class","model-nav-list"),b(gt,"class","model-actions"),b(Xe,"class","local-backend__header"),b(pt,"id","localBackendStatus"),b(pt,"class","local-backend__status muted"),b(an,"class","sr-only"),b(an,"for","localFileList"),b(pn,"for","localDirSelect"),hn.__value="",so(hn,hn.__value),b(_n,"id","localDirSelect"),b(_n,"class","pf-v5-c-form-control"),b(_n,"aria-label","Folder filter"),b(St,"class","local-backend__dir"),b(jt,"id","localFileList"),b(jt,"class","pf-v5-c-form-control"),b(jt,"size","12"),jt.multiple=!0,b(jt,"aria-label","Blockscape files on local server"),b(rn,"class","local-backend__actions"),b(Kt,"class","local-backend__list"),b(d,"class","local-backend__save"),b(W,"id","localBackendPanel"),b(W,"class","local-backend"),W.hidden=!0,b(Be,"class","blockscape-sidebar"),b(Be,"aria-label","Models"),Be.hidden=v=!r[3],b(L,"class","blockscape-main"),b(Ke,"class","blockscape-content"),b(ct,"class","pf-v5-c-page__main"),b(Q,"class","blockscape-footer__inner"),b(V,"class","pf-v5-c-page__footer blockscape-footer"),V.hidden=K=!r[2],b(T,"class","pf-v5-c-page"),ue.a=Ue,b(ft,"id","overlay"),b(ft,"class","svg-layer"),b(Ct,"id","tabTooltip"),b(Ct,"class","blockscape-tab-tooltip"),Ct.hidden=!0,b(Ct,"aria-hidden","true"),b(bt,"id","tileContextMenu"),b(bt,"class","tile-context-menu"),bt.hidden=!0,b(bt,"aria-hidden","true"),b(at,"id","itemPreview"),b(at,"class","item-preview"),at.hidden=!0,b(at,"aria-hidden","true")},m(we,Ze){E(ds.head,l),Pt(we,m,Ze),Pt(we,T,Ze),E(T,_),E(_,G),E(G,te),E(te,J),E(J,Z),E(J,C),E(J,se),E(se,j),E(j,re),E(re,fe),E(re,st),E(re,Fe),E(j,je),E(j,z),E(j,D),E(j,ie),E(j,R),E(j,me),E(me,Me),E(me,he),E(me,ot),E(me,Se),E(me,le),E(le,mt),E(me,O),E(me,Y),E(j,x),E(j,X),E(j,ve),E(j,ce),E(se,ye),E(se,Ae),E(Ae,ge),E(Ae,Re),E(Ae,w),E(Ae,dt),E(Ae,ut),E(J,Le),E(J,it),E(T,Je),E(T,ct),E(ct,Ke),E(Ke,Be),E(Be,p),E(Be,y),E(Be,_t),E(Be,de),E(Be,gt),E(Be,Mn),E(Be,W),E(W,Xe),E(W,Wt),E(W,pt),E(W,In),E(W,Kt),E(Kt,an),E(Kt,Dn),E(Kt,St),E(St,pn),E(St,lo),E(St,_n),E(_n,hn),E(Kt,Cn),E(Kt,jt),E(Kt,xn),E(Kt,rn),E(W,sn),E(W,d),E(Ke,M),E(Ke,L),E(T,k),E(T,V),E(V,Q),Pt(we,Ie,Ze),ue.m(Ee,we,Ze),Pt(we,Ue,Ze),Pt(we,ft,Ze),Pt(we,$e,Ze),Pt(we,Ct,Ze),Pt(we,Tt,Ze),Pt(we,bt,Ze),Pt(we,Ve,Ze),Pt(we,at,Ze),Pt(we,qt,Ze),Wi(ze,we,Ze),Pt(we,At,Ze),Wi(vt,we,Ze),wt=!0,Yt||(Bn=[Nn(re,"click",r[6]),Nn(ot,"click",r[8]),Nn(le,"click",r[9]),Nn(Y,"click",r[7])],Yt=!0)},p(we,[Ze]){(!wt||Ze&1)&&b(re,"aria-expanded",we[0]),(!wt||Ze&1&&We!==(We=we[0]?"Hide advanced tools":"Show advanced tools"))&&b(re,"aria-label",We),(!wt||Ze&2)&&Qr(mt,we[1]),(!wt||Ze&1&&lt!==(lt=!we[0]))&&(Ae.hidden=lt),(!wt||Ze&1&&Lt!==(Lt=!we[0]))&&b(Ae,"aria-hidden",Lt),(!wt||Ze&1&&It!==(It=we[0]?"true":"false"))&&b(se,"data-expanded",It),(!wt||Ze&16&&Nt!==(Nt=!we[4]))&&(_.hidden=Nt),(!wt||Ze&8&&v!==(v=!we[3]))&&(Be.hidden=v),(!wt||Ze&4&&K!==(K=!we[2]))&&(V.hidden=K)},i(we){wt||(Fi(ze.$$.fragment,we),Fi(vt.$$.fragment,we),wt=!0)},o(we){Ca(ze.$$.fragment,we),Ca(vt.$$.fragment,we),wt=!1},d(we){we&&(xt(m),xt(T),xt(Ie),ue.d(),xt(Ue),xt(ft),xt($e),xt(Ct),xt(Tt),xt(bt),xt(Ve),xt(at),xt(qt),xt(At)),xt(l),ji(ze,we),ji(vt,we),Yt=!1,Eo(Bn)}}}function Hc(r,l,m){let T,_,G,te,{seed:J}=l,{features:Z={}}=l;const se=J?JSON.stringify(J,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let j=!1;const re=[{label:"S",value:.9},{label:"M",value:1},{label:"L",value:1.15}];let fe=1;const st=()=>{if(m(0,j=!j),!j){const D=document.getElementById("search");D&&D.value&&(D.value="",D.dispatchEvent(new Event("input",{bubbles:!0})))}},Fe=()=>{const D=re[fe].value;document.documentElement.style.setProperty("--blockscape-scale",String(D)),window.dispatchEvent(new CustomEvent("blockscape:zoom",{detail:{scale:D}}))},We=()=>{m(12,fe=Math.min(re.length-1,fe+1)),Fe()},je=()=>{m(12,fe=Math.max(0,fe-1)),Fe()},z=()=>{m(12,fe=1),Fe()};return sc(()=>{Tc(Z),Fe();const D=ie=>{if(!(!ie.ctrlKey&&!ie.metaKey)){if(ie.key==="="||ie.key==="+"){We(),ie.preventDefault();return}if(ie.key==="-"||ie.key==="_"){je(),ie.preventDefault();return}ie.key==="0"&&(z(),ie.preventDefault())}};return window.addEventListener("keydown",D),()=>window.removeEventListener("keydown",D)}),r.$$set=D=>{"seed"in D&&m(10,J=D.seed),"features"in D&&m(11,Z=D.features)},r.$$.update=()=>{r.$$.dirty&2048&&m(4,T=Z.showHeader!==!1),r.$$.dirty&2048&&m(3,_=Z.showSidebar!==!1),r.$$.dirty&2048&&m(2,G=Z.showFooter!==!1),r.$$.dirty&4096&&m(1,te=`${Math.round(re[fe].value*100)}%`)},[j,te,G,_,T,se,st,We,je,z,J,Z,fe]}class Fc extends Gi{constructor(l){super(),zi(this,l,Hc,Uc,Di,{seed:10,features:11})}}function Wc(r){let l,m;return l=new Fc({props:{seed:r[0],features:r[1]}}),{c(){xa(l.$$.fragment)},m(T,_){Wi(l,T,_),m=!0},p(T,[_]){const G={};_&1&&(G.seed=T[0]),_&2&&(G.features=T[1]),l.$set(G)},i(T){m||(Fi(l.$$.fragment,T),m=!0)},o(T){Ca(l.$$.fragment,T),m=!1},d(T){ji(l,T)}}}function jc(r,l,m){let{seed:T}=l,{features:_={}}=l;return r.$$set=G=>{"seed"in G&&m(0,T=G.seed),"features"in G&&m(1,_=G.features)},[T,_]}class zc extends Gi{constructor(l){super(),zi(this,l,jc,Wc,Di,{seed:0,features:1})}}return zc}();
