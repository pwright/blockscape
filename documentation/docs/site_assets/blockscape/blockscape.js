var Blockscape=function(){"use strict";var zu=Object.defineProperty;var Ju=(Ln,Nt,Zn)=>Nt in Ln?zu(Ln,Nt,{enumerable:!0,configurable:!0,writable:!0,value:Zn}):Ln[Nt]=Zn;var Xn=(Ln,Nt,Zn)=>Ju(Ln,typeof Nt!="symbol"?Nt+"":Nt,Zn);var Ln=typeof document<"u"?document.currentScript:null;function Nt(){}function Zn(r){return r()}function xr(){return Object.create(null)}function Zo(r){r.forEach(Zn)}function Ar(r){return typeof r=="function"}function _i(r,l){return r!=r?l==l:r!==l||r&&typeof r=="object"||typeof r=="function"}function vl(r){return Object.keys(r).length===0}const yl=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function _(r,l){r.appendChild(l)}function It(r,l,f){r.insertBefore(l,f||null)}function gt(r){r.parentNode&&r.parentNode.removeChild(r)}function H(r){return document.createElement(r)}function Tr(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function Ci(r){return document.createTextNode(r)}function ce(){return Ci(" ")}function Qn(r,l,f,A){return r.addEventListener(l,f,A),()=>r.removeEventListener(l,f,A)}function El(r){return function(l){return l.preventDefault(),r.call(this,l)}}function b(r,l,f){f==null?r.removeAttribute(l):r.getAttribute(l)!==f&&r.setAttribute(l,f)}function Sl(r){let l;return{p(...f){l=f,l.forEach(A=>r.push(A))},r(){l.forEach(f=>r.splice(r.indexOf(f),1))}}}function kl(r){return Array.from(r.childNodes)}function Lr(r,l){l=""+l,r.data!==l&&(r.data=l)}function eo(r,l){r.value=l??""}class Il{constructor(l=!1){Xn(this,"is_svg",!1);Xn(this,"e");Xn(this,"n");Xn(this,"t");Xn(this,"a");this.is_svg=l,this.e=this.n=null}c(l){this.h(l)}m(l,f,A=null){this.e||(this.is_svg?this.e=Tr(f.nodeName):this.e=H(f.nodeType===11?"TEMPLATE":f.nodeName),this.t=f.tagName!=="TEMPLATE"?f:f.content,this.c(l)),this.i(A)}h(l){this.e.innerHTML=l,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(l){for(let f=0;f<this.n.length;f+=1)It(this.t,this.n[f],l)}p(l){this.d(),this.h(l),this.i(this.a)}d(){this.n.forEach(gt)}}let Qo;function ei(r){Qo=r}function _l(){if(!Qo)throw new Error("Function called outside component initialization");return Qo}function Cl(r){_l().$$.on_mount.push(r)}const bo=[],Nr=[];let wo=[];const Mr=[],xl=Promise.resolve();let sa=!1;function Al(){sa||(sa=!0,xl.then(Br))}function la(r){wo.push(r)}const ca=new Set;let vo=0;function Br(){if(vo!==0)return;const r=Qo;do{try{for(;vo<bo.length;){const l=bo[vo];vo++,ei(l),Tl(l.$$)}}catch(l){throw bo.length=0,vo=0,l}for(ei(null),bo.length=0,vo=0;Nr.length;)Nr.pop()();for(let l=0;l<wo.length;l+=1){const f=wo[l];ca.has(f)||(ca.add(f),f())}wo.length=0}while(bo.length);for(;Mr.length;)Mr.pop()();sa=!1,ca.clear(),ei(r)}function Tl(r){if(r.fragment!==null){r.update(),Zo(r.before_update);const l=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,l),r.after_update.forEach(la)}}function Ll(r){const l=[],f=[];wo.forEach(A=>r.indexOf(A)===-1?l.push(A):f.push(A)),f.forEach(A=>A()),wo=l}const xi=new Set;let Nl;function Ai(r,l){r&&r.i&&(xi.delete(r),r.i(l))}function da(r,l,f,A){if(r&&r.o){if(xi.has(r))return;xi.add(r),Nl.c.push(()=>{xi.delete(r)}),r.o(l)}}function ua(r){r&&r.c()}function Ti(r,l,f){const{fragment:A,after_update:C}=r.$$;A&&A.m(l,f),la(()=>{const F=r.$$.on_mount.map(Zn).filter(Ar);r.$$.on_destroy?r.$$.on_destroy.push(...F):Zo(F),r.$$.on_mount=[]}),C.forEach(la)}function Li(r,l){const f=r.$$;f.fragment!==null&&(Ll(f.after_update),Zo(f.on_destroy),f.fragment&&f.fragment.d(l),f.on_destroy=f.fragment=null,f.ctx=[])}function Ml(r,l){r.$$.dirty[0]===-1&&(bo.push(r),Al(),r.$$.dirty.fill(0)),r.$$.dirty[l/31|0]|=1<<l%31}function Ni(r,l,f,A,C,F,Q=null,z=[-1]){const te=Qo;ei(r);const x=r.$$={fragment:null,ctx:[],props:F,update:Nt,not_equal:C,bound:xr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(te?te.$$.context:[])),callbacks:xr(),dirty:z,skip_bound:!1,root:l.target||te.$$.root};Q&&Q(x.root);let ae=!1;if(x.ctx=f?f(r,l.props||{},(W,ie,...Le)=>{const Xe=Le.length?Le[0]:ie;return x.ctx&&C(x.ctx[W],x.ctx[W]=Xe)&&(!x.skip_bound&&x.bound[W]&&x.bound[W](Xe),ae&&Ml(r,W)),ie}):[],x.update(),ae=!0,Zo(x.before_update),x.fragment=A?A(x.ctx):!1,l.target){if(l.hydrate){const W=kl(l.target);x.fragment&&x.fragment.l(W),W.forEach(gt)}else x.fragment&&x.fragment.c();l.intro&&Ai(r.$$.fragment),Ti(r,l.target,l.anchor),Br()}ei(te)}class Mi{constructor(){Xn(this,"$$");Xn(this,"$$set")}$destroy(){Li(this,1),this.$destroy=Nt}$on(l,f){if(!Ar(f))return Nt;const A=this.$$.callbacks[l]||(this.$$.callbacks[l]=[]);return A.push(f),()=>{const C=A.indexOf(f);C!==-1&&A.splice(C,1)}}$set(l){this.$$set&&!vl(l)&&(this.$$.skip_bound=!0,this.$$set(l),this.$$.skip_bound=!1)}}const Bl="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Bl);const $r="blockscape:apicurioConfig",pa="http://localhost:8080/apis/registry/v3",Bi="bs",Rr="-series",fa=!1,ma=!1;function $l({models:r,getActiveIndex:l,setActive:f,ensureModelMetadata:A,ensureSeriesId:C,getModelId:F,getSeriesId:Q,getModelTitle:z,computeJsonFingerprint:te,uid:x}){let ae=null,W=null,ie=null,Le=null,Xe=null,Ze=null,qe=null,He=null,J=null,Y=null;const pe=new Set,R={baseUrl:pa,groupId:Bi,authToken:"",enabled:fa,useSemver:ma},Ae=new Map,Pe=new Map;function de(d){return(d||"").toString().trim().replace(/\/+$/,"")}function rt(d){return`${(d||"").toString().trim()||Bi}${Rr}`}function fe(){return!!(R.baseUrl&&R.groupId)}function Se(){return R.enabled!==!1}function Me(){pe.forEach(d=>{try{d(Se())}catch(v){console.warn("[Blockscape] failed to run Apicurio enabled listener",v)}})}function D(d){return typeof d=="function"&&pe.add(d),()=>pe.delete(d)}function Z(){ie&&(ie.value=R.baseUrl||""),Le&&(Le.value=R.groupId||""),Xe&&(Xe.value=R.authToken||""),Ze&&(Ze.checked=Se()),qe&&(qe.checked=!!R.useSemver)}function k(d="",v="muted"){He&&(He.textContent=d||"",He.classList.remove("is-error","is-success"),v==="error"?He.classList.add("is-error"):v==="success"&&He.classList.add("is-success"))}function ee(d){if(!Y||(Y.innerHTML="",!d))return;const v=document.createElement("p");v.className="apicurio-hint",v.textContent=d,Y.appendChild(v)}function me(d){Ae.clear(),Pe.clear(),ee(d)}function ge(){const d=l(),v=Se(),M=fe(),N=d>=0?r[d]:null,S=!!(N!=null&&N.apicurioVersions&&N.apicurioVersions.length>1);if(ae){const O=ae.dataset.loading==="true",X=v&&M&&d>=0&&!!ft(r[d]);ae.disabled=!v||O||!X,v?O||(ae.textContent="Push to Apicurio"):ae.textContent="Enable Apicurio to push"}if(J){const O=J.dataset.loading==="true",X=v&&M&&S&&!!ft(N);J.disabled=!X||O,J.hidden=!S,v?O||(J.textContent="Push series"):J.textContent="Enable Apicurio to push series"}if(W){const O=W.dataset.loading==="true",X=v&&M;W.disabled=!X||O,O||(v?M?W.textContent="List artifacts":W.textContent="Enter details to list":W.textContent="Enable Apicurio to list")}}function be(){Z(),Se()?fe()?(k("Apicurio push is ready when a model is selected.","muted"),Ae.size||ee("Click “List artifacts” to browse the current group.")):(k("Enter Apicurio connection details to enable push.","muted"),me("Enter registry details to browse artifacts.")):(k("Apicurio integration is off. Enable it to allow pushes.","muted"),me("Apicurio integration is disabled.")),ge()}function Fe(){if(window!=null&&window.localStorage)try{localStorage.setItem($r,JSON.stringify(R))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function m(){let d={};if(window!=null&&window.localStorage)try{const O=localStorage.getItem($r);if(O){const X=JSON.parse(O);X&&typeof X=="object"&&(d=X)}}catch(O){console.warn("[Blockscape] failed to restore Apicurio settings",O)}const v=de(d.baseUrl??pa),M=(d.groupId??Bi).toString().trim();let N=fa,S=ma;typeof d.enabled=="boolean"?N=d.enabled:typeof d.enabled=="string"&&(N=d.enabled==="true"),typeof d.useSemver=="boolean"?S=d.useSemver:typeof d.useSemver=="string"&&(S=d.useSemver==="true"),R.baseUrl=v||pa,R.groupId=M||Bi,R.authToken=(d.authToken??"").toString().trim(),R.enabled=N,R.useSemver=S,be(),Me()}function ke(){const d={Accept:"application/json"},v=(R.authToken||"").trim();return v&&(d.Authorization=/\s/.test(v)?v:`Bearer ${v}`),d}function Qe(d,v,{title:M,description:N,version:S}={}){const O={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:v},metadata:{properties:{}}}};S&&(O.firstVersion.version=S),M&&(O.name=M),N&&(O.description=N);try{const X=JSON.parse(v),q=X==null?void 0:X.seriesId;q&&typeof q=="string"&&(O.firstVersion.metadata.properties.seriesId=q)}catch{}return O}function ut(d,{version:v}={}){const M={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const N=JSON.parse(d),S=N==null?void 0:N.seriesId;S&&typeof S=="string"&&(M.metadata.properties.seriesId=S)}catch{}return v&&(M.version=v),M}function st(d){if(d==null)return null;const v=String(d).trim();if(!v)return null;const M=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(v);if(M)return{major:Number(M[1]),minor:Number(M[2]),patch:Number(M[3])};const N=/^v?(\d+)$/.exec(v);return N?{major:Number(N[1]),minor:0,patch:0}:null}function pt(d){return`${d.major}.${d.minor}.${d.patch}`}function Be(d,v){return!d&&!v?0:d?v?d.major!==v.major?d.major-v.major:d.minor!==v.minor?d.minor-v.minor:d.patch-v.patch:1:-1}function lt(d=[]){let v=null;if(d.forEach(N=>{const S=st((N==null?void 0:N.version)??N);S&&(!v||Be(S,v)>0)&&(v=S)}),!v)return"1.0.0";const M={...v,patch:v.patch+1};return pt(M)}function ft(d,{seriesName:v,fallbackTitle:M}={}){var O;if(!d)return null;const N=v||d.title||d.apicurioArtifactName||z(d),S=M||N;if(typeof C=="function"&&(d.isSeries||((O=d.apicurioVersions)==null?void 0:O.length)>1)&&C(d,{seriesName:N,fallbackTitle:S}),typeof Q=="function"){const X=Q(d,{seriesName:N,fallbackTitle:S});if(X)return X}return F(d)}function bt(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function E(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function w(d=[]){if(!Array.isArray(d)||!d.length)return null;const v=[...d].filter(Boolean);return v.sort((M,N)=>{const S=M!=null&&M.createdOn?new Date(M.createdOn).getTime():0,O=N!=null&&N.createdOn?new Date(N.createdOn).getTime():0;if(S!==O)return O-S;const X=Number(M==null?void 0:M.version),q=Number(N==null?void 0:N.version),Ee=Number.isFinite(X),ve=Number.isFinite(q);if(Ee&&ve&&X!==q)return q-X;const ue=String((M==null?void 0:M.version)??"");return String((N==null?void 0:N.version)??"").localeCompare(ue,void 0,{numeric:!0})}),v[0]||null}function $e(d){if(!d)return d;let v=d;if(!Array.isArray(d==null?void 0:d.categories)){const N=d==null?void 0:d.content;if(typeof N=="string")try{v=JSON.parse(N)}catch(S){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",S)}else N&&typeof N=="object"&&(v=N)}return v}async function g(d,v,M){const N=encodeURIComponent(v),S=encodeURIComponent(M),O=`${d}/groups/${N}/artifacts/${S}`,X=ke();X.Accept="application/json";const q=await fetch(O,{method:"GET",headers:X});if(!q.ok){let Ee=q.statusText||"Unknown error";try{const ve=await q.text();ve&&(Ee=ve.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${q.status}): ${Ee}`)}return q.json()}async function he(d,v,M){const N=encodeURIComponent(v),S=encodeURIComponent(M),O=`${d}/groups/${N}/artifacts/${S}/versions?limit=50&order=desc`,X=ke();X.Accept="application/json";const q=await fetch(O,{method:"GET",headers:X});if(!q.ok){let ve=q.statusText||"Unknown error";try{const ue=await q.text();ue&&(ve=ue.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${q.status}): ${ve}`)}const Ee=await q.json();return E(Ee).filter(ve=>ve&&ve.version!=null)}async function Ft(d,v,M,N="latest"){const S=encodeURIComponent(v),O=encodeURIComponent(M),X=encodeURIComponent(N||"latest"),q=`${d}/groups/${S}/artifacts/${O}/versions/${X}/content`,Ee=ke();Ee.Accept="application/json, application/*+json, */*;q=0.8";const ve=await fetch(q,{method:"GET",headers:Ee});if(!ve.ok){let et=ve.statusText||"Unknown error";try{const Re=await ve.text();Re&&(et=Re.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${ve.status}): ${et}`)}const ue=await ve.text();let ze=null;try{ze=JSON.parse(ue)}catch{throw new Error("Artifact content is not valid JSON.")}return $e(ze)}async function G(d,v,M,N="latest"){const S=await Ft(d,v,M,N);return{data:S,fingerprint:te(S)}}async function Ke(d,v,M){try{const S=await he(d,v,M);if(S!=null&&S.length){Pe.set(M,S);const O=w(S);if((O==null?void 0:O.version)!=null)return O.version}}catch(S){console.warn("[Blockscape] compare-version: unable to fetch versions list",S)}try{const S=await g(d,v,M);if((S==null?void 0:S.version)!=null)return S.version}catch(S){console.warn("[Blockscape] compare-version: unable to fetch metadata",S)}const N=Pe.get(M);if(N&&N.length){const S=w(N);if((S==null?void 0:S.version)!=null)return S.version}return"latest"}async function it(d,v,M,N){if(!R.useSemver)return null;if(!N)return"1.0.0";try{const S=await he(d,v,M);return lt(S)}catch(S){throw new Error(`Unable to compute next semantic version: ${S.message}`)}}function at(d=document){ae=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),J=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),W=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),ie=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),Le=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),Xe=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),Ze=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),qe=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),He=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),Y=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function yn(){R.baseUrl=de((ie==null?void 0:ie.value)??R.baseUrl),R.groupId=((Le==null?void 0:Le.value)??"").trim(),R.authToken=((Xe==null?void 0:Xe.value)??"").trim(),Fe(),be()}function en(d){R.enabled=d!==!1,Fe(),be(),Me()}function tn(){en(Ze?Ze.checked:fa)}function Jn(){R.useSemver=qe?qe.checked:ma,Fe(),be()}function Et(){[ie,Le,Xe].forEach(d=>{d&&d.addEventListener("input",yn)}),ae&&ae.addEventListener("click",()=>{Pt()}),J&&J.addEventListener("click",()=>{En()}),Ze&&Ze.addEventListener("change",tn),qe&&qe.addEventListener("change",Jn),W&&W.addEventListener("click",on),Y&&Y.addEventListener("click",d=>{const v=d.target.closest("[data-artifact-version]");if(v){d.stopPropagation();const S=v.dataset.artifactId,O=v.dataset.artifactVersion;S&&O&&Zt(S,O);return}const M=d.target.closest("[data-artifact-load-all]");if(M){d.stopPropagation(),M.dataset.artifactId&&Sn();return}const N=d.target.closest("[data-artifact-trigger]");if(N){const S=N.dataset.artifactId;if(!S)return;nn(S)}})}function Wt(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function no(d){if(!d)return;d.innerHTML="";const v=Wt();d.appendChild(v),at(d),Et(),be()}function cn(d){if(!Y)return;if(Y.innerHTML="",!d.length){ee("No artifacts found in this group.");return}const v=S=>{const O=document.createElement("section");O.className="apicurio-artifact-section";const X=document.createElement("h3");X.textContent=S,O.appendChild(X);const q=document.createElement("ul");return q.className="apicurio-artifact-list",O.appendChild(q),{section:O,list:q}},M=v("Series artifacts"),N=v("Artifacts");d.forEach(S=>{if(!(S!=null&&S.artifactId))return;const X=S._groupId&&S._groupId.endsWith(Rr)?M.list:N.list,q=document.createElement("li"),Ee=document.createElement("button");Ee.type="button",Ee.className="apicurio-artifact",Ee.dataset.artifactId=S.artifactId,Ee.dataset.artifactTrigger="toggle";const ve=document.createElement("span");ve.className="apicurio-artifact-title",ve.textContent=S.artifactId,Ee.appendChild(ve);const ue=[];if(S.name&&ue.push(S.name),S.version!=null&&ue.push(`v${S.version}`),S.type&&ue.push(S.type),S._groupId&&ue.push(S._groupId),ue.length){const Re=document.createElement("span");Re.className="apicurio-artifact-meta",Re.textContent=ue.join(" • "),Ee.appendChild(Re)}if(S.description){const Re=document.createElement("span");Re.className="apicurio-artifact-meta",Re.textContent=S.description,Ee.appendChild(Re)}q.appendChild(Ee);const ze=document.createElement("div");ze.className="apicurio-version-list",ze.dataset.versionPanel=S.artifactId,ze.hidden=!0;const et=document.createElement("p");et.className="apicurio-hint",et.textContent="Click to load the latest or open versions.",ze.appendChild(et),q.appendChild(ze),X.appendChild(q)}),M.list.children.length&&Y.appendChild(M.section),N.list.children.length&&Y.appendChild(N.section)}function Kn(d){return Y?Y.querySelector(`[data-version-panel="${d}"]`):null}function Ot(d,v){if(!d||(d.innerHTML="",!v))return;const M=document.createElement("p");M.className="apicurio-hint",M.textContent=v,d.appendChild(M)}function dn(d,v){const M=Kn(d);if(M){if(M.innerHTML="",!v.length){Ot(M,"No versions found for this artifact.");return}v.forEach(N=>{const S=document.createElement("button");S.type="button",S.className="apicurio-version-button",S.dataset.artifactId=d,S.dataset.artifactVersion=N.version;const O=[`Version ${N.version}`];if(N.createdOn){const X=new Date(N.createdOn);isNaN(X)||O.push(X.toISOString().slice(0,10))}S.textContent=O.join(" — "),M.appendChild(S)})}}async function nn(d){const v=Kn(d);if(!v)return;if(v.dataset.open==="true"){v.hidden=!0,v.dataset.open="false";return}if(v.hidden=!1,v.dataset.open="true",v.dataset.loaded!=="true"){if(!fe()){Ot(v,"Enter registry details first.");return}Ot(v,"Loading versions…");try{const N=de(R.baseUrl),S=Ae.get(d),O=R.groupId.trim(),X=(S==null?void 0:S._groupId)||O,q=await he(N,X,d);Pe.set(d,q),v.dataset.loaded="true",dn(d,q)}catch(N){console.error("[Blockscape] failed to load versions",N),Ot(v,`Unable to fetch versions: ${N.message}`)}}}function Xt(d,v){var N;const M=r.findIndex(S=>S.apicurioArtifactId===d);if(M!==-1){const S=r[M].id;r[M]={...v,id:S||v.id},((N=r[M].apicurioVersions)==null?void 0:N.length)>1&&(r[M].isSeries=!0),f(M)}else r.push(v),f(r.length-1)}async function jt(d,v,M,N){const S=encodeURIComponent(v),O=encodeURIComponent(M),X=`${d}/groups/${S}/artifacts/${O}`;try{const q=await fetch(X,{method:"GET",headers:N});if(q.status===404)return!1;if(q.ok)return!0;throw q.status===401||q.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${q.status} while checking the artifact.`)}catch(q){throw q instanceof TypeError?new Error("Network error while contacting Apicurio registry."):q}}async function Pt(){var X;if(!ae||ae.dataset.loading==="true")return;if(!Se()){k("Apicurio integration is off. Enable it first.","error");return}if(!fe()){k("Enter the registry base URL and group ID before pushing.","error");return}const d=l();if(d<0||!r[d]){k("No active model to push.","error");return}const v=ft(r[d],{fallbackTitle:z(r[d])});if(!v){k("Active model needs an id before pushing.","error");return}const M=de(R.baseUrl),N=R.groupId.trim(),S=JSON.stringify(r[d].data,null,2),O=ke();ae.dataset.loading="true",ae.textContent="Pushing…",ae.disabled=!0,k("Pushing to Apicurio…","muted");try{const q=await jt(M,N,v,O),Ee=te(r[d].data);if(q)try{const ct=await Ke(M,N,v),{data:_t,fingerprint:St}=await G(M,N,v,ct);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",ct),console.log("local fingerprint",Ee),console.log("registry fingerprint",St),console.log("local payload",r[d].data),console.log("registry payload",_t),console.groupEnd(),Ee&&St&&Ee===St){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){k("Push cancelled (content matches the latest registry version).","muted");return}k("Pushing identical content by user choice.","muted")}else St?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):k("Unable to compare with registry content (skipping confirmation).","muted")}catch(ct){console.warn("[Blockscape] unable to compare registry content before push",ct),k("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const ve=R.useSemver?await it(M,N,v,q):null;if(R.useSemver&&!ve)throw new Error("Semantic versioning is enabled but no version could be computed.");const ue=encodeURIComponent(N),ze=encodeURIComponent(v),et=q?`${M}/groups/${ue}/artifacts/${ze}/versions`:`${M}/groups/${ue}/artifacts`,Re={...O,"Content-Type":"application/json"};ve&&(Re["X-Registry-Version"]=ve,k(`Pushing to Apicurio as version ${ve}…`,"muted"));const wt=q?ut(S,{version:ve}):Qe(v,S,{title:z(r[d]),description:(X=r[d].data)==null?void 0:X.abstract,version:ve}),Ye=await fetch(et,{method:"POST",headers:Re,body:JSON.stringify(wt)});if(!Ye.ok){let ct=Ye.statusText||"Unknown error";try{const _t=await Ye.text();_t&&(ct=_t.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Ye.status}): ${ct}`)}let vt=null;try{vt=await Ye.json()}catch{vt=null}const De=(vt==null?void 0:vt.version)||(vt==null?void 0:vt.globalId)||"",ne=q?"Updated":"Created",Oe=De?` (version ${De})`:"";k(`${ne} ${v}${Oe}`,"success")}catch(q){console.error("[Blockscape] Apicurio push failed",q),k(`Apicurio push failed: ${q.message}`,"error")}finally{ae.dataset.loading="false",ge()}}async function En(){var ve,ue;if(!J||J.dataset.loading==="true")return;if(!Se()){k("Apicurio integration is off. Enable it first.","error");return}if(!fe()){k("Enter the registry base URL and group ID before pushing.","error");return}const d=l(),v=d>=0?r[d]:null;if(!v||!v.apicurioVersions||v.apicurioVersions.length<2){k("Series push requires a model with multiple versions.","error");return}const M=ft(v,{seriesName:v.title||v.apicurioArtifactName||z(v)});if(!M){k("Active series needs an id before pushing.","error");return}typeof C=="function"&&C(v,{seriesName:v.title||v.apicurioArtifactName||z(v)});const N=de(R.baseUrl),S=R.groupId.trim(),O=v.apicurioVersions.map(ze=>ze.data),X=JSON.stringify(O,null,2),q=ke(),Ee=rt(S);J.dataset.loading="true",J.textContent="Pushing…",J.disabled=!0,k("Pushing series to Apicurio…","muted");try{const ze=await jt(N,Ee,M,q),et=te(O);if(ze)try{const un=await Ke(N,Ee,M),{data:Cn,fingerprint:oo}=await G(N,Ee,M,un);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",un),console.log("local fingerprint",et),console.log("registry fingerprint",oo),console.log("local payload (series)",O),console.log("registry payload",Cn),console.groupEnd(),et&&oo&&et===oo){if(!window.confirm("The current registry version matches this series. Push anyway?")){k("Series push cancelled (content matches latest).","muted");return}k("Pushing identical series by user choice.","muted")}else oo?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):k("Unable to compare with registry content (skipping confirmation).","muted")}catch(un){console.warn("[Blockscape] unable to compare registry content before series push",un),k("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const Re=R.useSemver?await it(N,Ee,M,ze):null;if(R.useSemver&&!Re)throw new Error("Semantic versioning is enabled but no version could be computed.");const wt=encodeURIComponent(Ee),Ye=encodeURIComponent(M),vt=ze?`${N}/groups/${wt}/artifacts/${Ye}/versions`:`${N}/groups/${wt}/artifacts`,De={...q,"Content-Type":"application/json"};Re&&(De["X-Registry-Version"]=Re,k(`Pushing series to Apicurio as version ${Re}…`,"muted"));const ne=ze?ut(X,{version:Re}):Qe(M,X,{title:v.apicurioArtifactName||((ve=v.data)==null?void 0:ve.title)||M,description:(ue=v.data)==null?void 0:ue.abstract,version:Re}),Oe=await fetch(vt,{method:"POST",headers:De,body:JSON.stringify(ne)});if(!Oe.ok){let un=Oe.statusText||"Unknown error";try{const Cn=await Oe.text();Cn&&(un=Cn.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${Oe.status}): ${un}`)}let ct=null;try{ct=await Oe.json()}catch{ct=null}const _t=(ct==null?void 0:ct.version)||(ct==null?void 0:ct.globalId)||"",St=ze?"Updated":"Created",_n=_t?` (version ${_t})`:"";k(`${St} ${M} series${_n}`,"success")}catch(ze){console.error("[Blockscape] Apicurio series push failed",ze),k(`Apicurio series push failed: ${ze.message}`,"error")}finally{J.dataset.loading="false",ge()}}async function on(){if(!W||W.dataset.loading==="true")return;if(!Se()){k("Enable Apicurio integration to list artifacts.","error");return}if(!fe()){k("Enter registry base URL and group ID before listing.","error");return}const d=de(R.baseUrl),v=R.groupId.trim(),M=rt(v),N=[{groupId:v,label:"base"},{groupId:M,label:"series"}];W.dataset.loading="true",W.textContent="Listing…",W.disabled=!0,k("Listing artifacts…","muted"),ee("Contacting registry…");try{const S=ke();S.Accept="application/json";const O=[];for(const q of N){const Ee=encodeURIComponent(q.groupId),ve=`${d}/groups/${Ee}/artifacts?limit=50&offset=0`,ue=await fetch(ve,{method:"GET",headers:S});if(!ue.ok){let Re=ue.statusText||"Unknown error";try{const wt=await ue.text();wt&&(Re=wt.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${q.groupId} (${ue.status}): ${Re}`);continue}const ze=await ue.json(),et=bt(ze).filter(Re=>Re&&Re.artifactId);et.forEach(Re=>{Re&&(Re._groupId=q.groupId)}),O.push(...et)}Ae.clear(),Pe.clear(),O.forEach(q=>{q!=null&&q.artifactId&&Ae.set(q.artifactId,q)}),cn(O);const X=O.length;k(X?`Found ${X} artifact${X===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",X?"success":"muted")}catch(S){console.error("[Blockscape] failed to list artifacts",S),me("Unable to list artifacts."),k(`Listing failed: ${S.message}`,"error")}finally{W.dataset.loading="false",ge()}}async function Zt(d,v=null){var ze,et,Re,wt,Ye,vt;if(!d)return;if(!Se()){k("Enable Apicurio integration to load artifacts.","error");return}if(!fe()){k("Enter registry connection details before loading artifacts.","error");return}const M=de(R.baseUrl),N=R.groupId.trim(),S=d&&((ze=Ae.get(d))==null?void 0:ze._groupId)||N;let O=Ae.get(d);const X=async()=>{try{const De=await g(M,S,d);return De!=null&&De.artifactId&&Ae.set(d,De),De}catch(De){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",De),De}};if(!O)try{O=await X()}catch(De){k(`Failed to fetch artifact metadata: ${De.message}`,"error");return}const q=Pe.get(d)||[];let Ee="latest",ve="latest";if(v)Ee=v,ve=v;else{if(!O||O.version==null)try{O=await X()}catch(De){k(`Failed to fetch artifact metadata: ${De.message}`,"error");return}Ee=(O==null?void 0:O.version)||"latest",ve=(O==null?void 0:O.version)||"latest"}const ue=q.find(De=>String(De.version)===String(Ee));(ue==null?void 0:ue.version)!=null&&(ve=ue.version),k(`Loading artifact ${d}…`,"muted");try{const De=await Ft(M,S,d,Ee),ne=Ae.get(d)||O||{},Oe=Array.isArray(De);let ct=null;if(Oe){const _t=De.map((_n,un)=>(A(_n,{titleHint:ne.name||d,idHint:d}),{version:String(un+1),data:_n,createdOn:(ue==null?void 0:ue.createdOn)||ne.createdOn}));ct={id:x(),title:((Re=(et=_t[0])==null?void 0:et.data)==null?void 0:Re.title)||ne.name||d,data:(wt=_t[0])==null?void 0:wt.data,apicurioArtifactId:d,apicurioArtifactName:ne.name||"",apicurioVersions:_t,apicurioActiveVersionIndex:0,isSeries:!0};const St=((Ye=ne==null?void 0:ne.properties)==null?void 0:Ye.seriesId)||d;typeof C=="function"&&C(ct,{seriesName:St,fallbackTitle:St}),k(`Loaded series artifact ${d}.`,"success")}else{A(De,{titleHint:ne.name||d,idHint:d});const _t={version:ve,data:De,createdOn:(ue==null?void 0:ue.createdOn)||ne.createdOn};ct={id:x(),title:De.title||ne.name||d,data:De,apicurioArtifactId:d,apicurioArtifactName:ne.name||"",apicurioVersions:[_t],apicurioActiveVersionIndex:0};const St=(vt=ne==null?void 0:ne.properties)==null?void 0:vt.seriesId;St&&typeof C=="function"&&C(ct,{seriesName:St,fallbackTitle:St});const _n=ve?` (version ${ve})`:"";k(`Loaded artifact ${d}${_n}.`,"success")}Xt(d,ct)}catch(De){console.error("[Blockscape] failed to load artifact",De),k(`Failed to load artifact: ${De.message}`,"error")}}async function Sn(d){}return{hydrateConfig:m,mount:no,updateAvailability:ge,isEnabled:Se,setEnabled:en,onEnabledChange:D}}const $t={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function jn(r,l){if(typeof r!="function")throw new Error(`[itemEditor] expected ${l} to be a function`)}function Rl(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}function Ol(r,{excludeId:l}={}){if(!r)return[];const f=r.split(/[\s,]+/).map(C=>C.trim()).filter(Boolean),A=[];return f.forEach(C=>{l&&C===l||A.includes(C)||A.push(C)}),A}function Pl(r,l,f){if(!l||!f||l===f)return;((r==null?void 0:r.categories)||[]).forEach(C=>{(C.items||[]).forEach(F=>{Array.isArray(F.deps)&&(F.deps=F.deps.map(Q=>Q===l?f:Q))})})}function Vl({findItemAndCategoryById:r,collectAllItemIds:l,updateItemReferences:f,loadActiveIntoEditor:A,rebuildFromActive:C,select:F,onSelectionRenamed:Q,makeSlug:z=Rl,isAutoIdFromNameEnabled:te=()=>!0}={}){jn(r,"findItemAndCategoryById"),jn(l,"collectAllItemIds"),jn(f,"updateItemReferences"),jn(A,"loadActiveIntoEditor"),jn(C,"rebuildFromActive"),jn(F,"select"),jn(z,"makeSlug"),jn(te,"isAutoIdFromNameEnabled");const x={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function ae(J){if(x.fields.errorEl){if(!J){x.fields.errorEl.hidden=!0,x.fields.errorEl.textContent="";return}x.fields.errorEl.hidden=!1,x.fields.errorEl.textContent=J}}function W(){x.wrapper&&(x.wrapper.hidden=!0,x.wrapper.setAttribute("aria-hidden","true"),ae(""),x.categoryId=null,x.itemId=null,x.modelData=null,document.body.classList.remove("item-editor-open"))}function ie(){x.wrapper&&(x.wrapper.hidden=!1,x.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var J,Y;(J=x.fields.nameInput)==null||J.focus(),(Y=x.fields.nameInput)==null||Y.select()}))}function Le({force:J}={}){var pe,R;if(!((pe=x.fields)!=null&&pe.idInput)||!((R=x.fields)!=null&&R.nameInput)||!x.autoSyncEnabled||!te()||!J&&x.autoIdManuallyEdited)return;const Y=z(x.fields.nameInput.value||x.itemId||"item");x.fields.idInput.value=Y}function Xe(J){var Se;if(!x.modelData||!x.categoryId||!x.itemId)throw new Error("No item loaded.");const pe=(((Se=x.modelData)==null?void 0:Se.categories)||[]).find(Me=>Me.id===x.categoryId);if(!pe)throw new Error("Category not found.");pe.items=pe.items||[];const R=pe.items.find(Me=>Me.id===x.itemId);if(!R)throw new Error("Item not found.");const Ae=(J.id||"").trim();if(!Ae)throw new Error("ID is required.");const Pe=l(x.modelData);if(Ae!==R.id&&Pe.has(Ae))throw new Error("Another item already uses that ID.");R.id=Ae;const de=(J.name||"").trim();R.name=de||R.id;const rt=(J.logo||"").trim();if(rt?R.logo=rt:delete R.logo,J.externalFlag&&!J.external)R.external=!0;else{const Me=(J.external??"").toString().trim();Me?R.external=Me:delete R.external}const fe=(J.color||"").trim();return fe?R.color=fe:delete R.color,R.deps=Array.isArray(J.deps)?J.deps:[],R.id!==J.originalId&&typeof Q=="function"&&Q(J.originalId,R.id),f(x.modelData,J.originalId,R.id),A(),C(),F(R.id),R.id}function Ze(){if(!x.fields||!x.fields.idInput)return!1;const J=(x.fields.idInput.value||"").trim(),Y={originalId:x.itemId,id:J,name:x.fields.nameInput.value||"",logo:x.fields.logoInput.value||"",external:x.fields.externalInput.value||"",externalFlag:x.fields.externalFlagInput.checked,color:x.fields.colorInput.value||"",deps:Ol(x.fields.depsInput.value,{excludeId:J})};try{return Xe(Y),W(),!0}catch(pe){return console.warn("[itemEditor] item edit failed",pe),ae((pe==null?void 0:pe.message)||"Unable to save item."),!1}}function qe(){if(x.wrapper)return x.wrapper;const J=document.createElement("div");J.className="item-editor-modal",J.hidden=!0,J.setAttribute("role","dialog"),J.setAttribute("aria-modal","true");const Y=document.createElement("div");Y.className="item-editor-modal__backdrop",J.appendChild(Y);const pe=document.createElement("div");pe.className="item-editor",J.appendChild(pe);const R=document.createElement("div");R.className="item-editor__header";const Ae=document.createElement("h2");Ae.className="item-editor__title",Ae.textContent="Edit item";const Pe=document.createElement("button");Pe.type="button",Pe.className="item-editor__close",Pe.setAttribute("aria-label","Close item editor"),Pe.textContent="×",R.appendChild(Ae),R.appendChild(Pe),pe.appendChild(R);const de=document.createElement("form");de.className="item-editor__form",pe.appendChild(de);const rt=document.createElement("div");rt.className="item-editor__meta",rt.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',de.appendChild(rt);const fe=document.createElement("div");fe.className="item-editor__error",fe.hidden=!0,de.appendChild(fe);const Se=(E,w,$e)=>{const g=document.createElement("label");g.className="item-editor__field";const he=document.createElement("span");if(he.className="item-editor__label",he.textContent=E,g.appendChild(he),w.classList.add("item-editor__control"),g.appendChild(w),$e){const Ft=document.createElement("div");Ft.className="item-editor__hint",Ft.textContent=$e,g.appendChild(Ft)}return g},Me=document.createElement("input");Me.type="text",Me.required=!0,de.appendChild(Se("ID",Me,"Unique identifier used for dependencies."));const D=document.createElement("input");D.type="text",de.appendChild(Se("Name",D,"Visible label shown on the tile."));const Z=document.createElement("input");Z.type="url",Z.inputMode="url",Z.placeholder="https://…",de.appendChild(Se("Logo URL",Z,"Optional image URL."));const k=document.createElement("input");k.type="url",k.inputMode="url",k.placeholder="https://…",de.appendChild(Se("External link",k,"Shown with ↗ icon and in preview."));const ee=document.createElement("div");ee.className="item-editor__checkbox";const me=document.createElement("label");me.className="item-editor__checkbox-row";const ge=document.createElement("input");ge.type="checkbox";const be=document.createElement("span");be.textContent="Mark as external without link";const Fe=document.createElement("div");Fe.className="item-editor__hint",Fe.textContent="Keeps dashed border even without a URL.",me.appendChild(ge),me.appendChild(be),ee.appendChild(me),ee.appendChild(Fe),de.appendChild(ee);const m=document.createElement("input");m.type="text",m.placeholder=$t.color.primary,de.appendChild(Se("Color",m,"Optional badge color (hex or CSS color)."));const ke=document.createElement("textarea");ke.rows=2,ke.placeholder="Comma or space separated ids",de.appendChild(Se("Dependencies",ke,"Use item IDs, separated by commas or spaces."));const Qe=document.createElement("div");Qe.className="item-editor__checkbox";const ut=document.createElement("label");ut.className="item-editor__checkbox-row";const st=document.createElement("input");st.type="checkbox";const pt=document.createElement("span");pt.textContent="Sync ID while editing name";const Be=document.createElement("div");Be.className="item-editor__hint",Be.textContent="Turn off to keep typing names without changing the ID.",ut.appendChild(st),ut.appendChild(pt),Qe.appendChild(ut),Qe.appendChild(Be),de.appendChild(Qe);const lt=document.createElement("div");lt.className="item-editor__actions";const ft=document.createElement("button");ft.type="button",ft.className="pf-v5-c-button pf-m-tertiary",ft.textContent="Cancel";const bt=document.createElement("button");return bt.type="submit",bt.className="pf-v5-c-button pf-m-primary",bt.textContent="Save",lt.appendChild(ft),lt.appendChild(bt),de.appendChild(lt),x.wrapper=J,x.fields={idInput:Me,nameInput:D,logoInput:Z,externalInput:k,externalFlagInput:ge,colorInput:m,depsInput:ke,syncCheckbox:st,categoryValue:rt.querySelector(".item-editor__meta-value"),errorEl:fe},ft.addEventListener("click",W),Pe.addEventListener("click",W),Y.addEventListener("click",W),Me.addEventListener("input",()=>{x.autoIdManuallyEdited=!0}),D.addEventListener("input",Le),st.addEventListener("change",()=>{x.autoSyncEnabled=!!st.checked,x.autoSyncEnabled&&(x.autoIdManuallyEdited=!1,Le({force:!0}))}),de.addEventListener("submit",E=>{E.preventDefault(),Ze()}),document.addEventListener("keydown",E=>{E.key==="Escape"&&!J.hidden&&(E.preventDefault(),E.stopPropagation(),W())}),document.body.appendChild(J),J}function He(J){const Y=r(J);if(!Y)return!1;qe(),x.categoryId=Y.category.id,x.itemId=Y.item.id,x.modelData=Y.modelData,x.autoIdManuallyEdited=!1;const pe=!!te();return x.autoSyncEnabled=pe,x.fields.categoryValue.textContent=Y.category.title||Y.category.id,x.fields.idInput.value=Y.item.id||"",x.fields.nameInput.value=Y.item.name||"",x.fields.logoInput.value=Y.item.logo||"",x.fields.externalInput.value=typeof Y.item.external=="string"?Y.item.external:"",x.fields.externalFlagInput.checked=Y.item.external===!0,x.fields.colorInput.value=Y.item.color||"",x.fields.depsInput.value=Array.isArray(Y.item.deps)?Y.item.deps.join(", "):"",x.fields.syncCheckbox.checked=x.autoSyncEnabled,x.fields.syncCheckbox.disabled=!pe,!x.fields.idInput.value&&pe&&Le({force:!0}),ae(""),F(Y.item.id),ie(),!0}return{open:He,hide:W,isOpen:()=>!!x.wrapper&&!x.wrapper.hidden}}function Dl({menuEl:r,previewEl:l,previewTitleEl:f,previewBodyEl:A,previewActionsEl:C,previewCloseEl:F,escapeHtml:Q,onEditItem:z,onChangeColor:te,selectItem:x,colorPresets:ae=[]}={}){const W=r||(()=>{const D=document.createElement("div");return D.className="tile-context-menu",D.hidden=!0,D.setAttribute("aria-hidden","true"),document.body.appendChild(D),D})();let ie={x:0,y:0},Le=0,Xe=Array.isArray(ae)?ae:[];function Ze(){W&&(W.classList.remove("is-open"),W.hidden=!0,W.setAttribute("aria-hidden","true"),W.innerHTML="")}function qe(D=[]){C&&(C.innerHTML="",D.forEach(Z=>{const k=document.createElement("button");k.type="button",k.className="item-preview__action",k.textContent=Z.label||"Action",Z.title&&(k.title=Z.title),k.addEventListener("click",ee=>{ee.stopPropagation(),typeof Z.onClick=="function"&&Z.onClick(ee)}),C.appendChild(k)}),C.hidden=D.length===0)}function He(){Ze(),l&&(l.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),l.setAttribute("aria-hidden","true"),l.hidden=!0,qe([]))}function J(D,Z){l&&(ie={x:D,y:Z},l.hidden=!1,l.setAttribute("aria-hidden","false"),l.classList.add("is-visible"),Y(D,Z))}function Y(D,Z){if(!l)return;const k=12;l.style.left=`${D+k}px`,l.style.top=`${Z+k}px`;const ee=l.getBoundingClientRect();let me=ee.left,ge=ee.top;ee.right>window.innerWidth-k&&(me=Math.max(k,window.innerWidth-ee.width-k)),ee.bottom>window.innerHeight-k&&(ge=Math.max(k,window.innerHeight-ee.height-k)),l.style.left=`${me}px`,l.style.top=`${ge}px`}function pe(D,Z){var be;if(!D)return null;const k=D.dataset.id,ee=((be=D.querySelector(".name"))==null?void 0:be.textContent)||k||"Preview",me=k?`${k}.html`:"",ge=me?`items/${me}`:"";return{id:k,displayName:ee,filename:me,filepath:ge,externalUrl:D.dataset.externalUrl||"",obsidianUrl:D.dataset.obsidianUrl||"",anchorX:(Z==null?void 0:Z.clientX)??0,anchorY:(Z==null?void 0:Z.clientY)??0}}function R(D,Z){const k=document.createElement("button");return k.type="button",k.className="tile-context-menu__item",k.textContent=D,k.addEventListener("click",()=>{Ze(),typeof Z=="function"&&Z()}),k}function Ae(D){if(!W)return;W.innerHTML="";const Z=document.createElement("div");Z.className="tile-context-menu__list",Z.appendChild(R("File view",()=>de(D))),typeof z=="function"&&Z.appendChild(R("Edit",()=>z(D.id))),typeof te=="function"&&D.id&&Xe.forEach(k=>{if(!(k!=null&&k.value))return;const ee=k.name||k.value;Z.appendChild(R(`Set color: ${ee}`,()=>te(D.id,k.value)))}),W.appendChild(Z)}function Pe(D,Z){if(!W)return;const k=4;W.style.left=`${D+k}px`,W.style.top=`${Z+k}px`,W.hidden=!1,W.setAttribute("aria-hidden","false"),W.classList.add("is-open");const ee=W.getBoundingClientRect();let me=ee.left,ge=ee.top;ee.right>window.innerWidth-k&&(me=Math.max(k,window.innerWidth-ee.width-k)),ee.bottom>window.innerHeight-k&&(ge=Math.max(k,window.innerHeight-ee.height-k)),W.style.left=`${me}px`,W.style.top=`${ge}px`}async function de(D){if(!l||!f||!A||!D)return;const Z=++Le,k=[];if(typeof z=="function"&&D.id&&k.push({label:"Edit",title:"Edit this item",onClick:()=>{He(),z(D.id)}}),D.externalUrl&&k.push({label:"Open link ↗",title:D.externalUrl,onClick:()=>window.open(D.externalUrl,"_blank","noopener")}),D.obsidianUrl&&k.push({label:"Open in Obsidian",title:D.obsidianUrl,onClick:()=>window.open(D.obsidianUrl,"_blank","noopener")}),qe(k),D.id&&typeof x=="function"&&x(D.id),f.textContent=D.displayName,A.innerHTML='<div class="item-preview__status">Loading…</div>',l.classList.remove("item-preview--has-frame"),l.classList.add("item-preview--expanded"),J(D.anchorX,D.anchorY),!D.filepath){A.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',Y(ie.x,ie.y);return}try{const ee=await fetch(D.filepath,{cache:"no-cache"});if(!ee.ok)throw new Error(`HTTP ${ee.status}`);const me=await ee.text();if(Z!==Le)return;if(!me.trim()){const Fe=Q?Q(D.filename):D.filename;A.innerHTML=`<div class="item-preview__status">No content in <code>${Fe}</code>.</div>`,Y(ie.x,ie.y);return}const be=document.createElement("iframe");be.className="item-preview__frame",be.title=`${D.displayName} details`,be.srcdoc=me,A.innerHTML="",A.appendChild(be),l.classList.add("item-preview--has-frame"),Y(ie.x,ie.y)}catch(ee){if(Z!==Le)return;const me=Q?Q(D.displayName):D.displayName;A.innerHTML=`<div class="item-preview__status">No preview available for <strong>${me}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${D.filepath}`,ee),Y(ie.x,ie.y)}}function rt(D,Z){if(!Z)return;D.preventDefault(),D.stopPropagation();const k=pe(Z,D);!k||!k.id||(typeof x=="function"&&x(k.id),Ae(k),Pe(D.clientX,D.clientY))}function fe(D){const Z=D==null?void 0:D.target,k=W&&!W.hidden&&W.contains(Z),ee=l&&!l.hidden&&l.contains(Z);!k&&!ee&&He()}function Se(){!l||l.hidden||Y(ie.x,ie.y)}function Me(){He()}return F&&F.addEventListener("click",He),{handleTileContextMenu:rt,hidePreview:He,hideMenu:Ze,handleDocumentClick:fe,handleWindowResize:Se,handleWindowScroll:Me,updateColorPresets:D=>{Xe=Array.isArray(D)?D:[]}}}function Or(r,l="series"){return(r||l).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||l}function vn(r,l="series"){const f=Or(r,l).replace(/\./g,"-");return f.replace(/-series$/i,"").replace(/-+$/,"")||f||Or(l,"series")}function Pr(r,{seriesName:l,fallbackTitle:f="unknown"}={}){var z,te;const C=[r==null?void 0:r.seriesId,(z=r==null?void 0:r.data)==null?void 0:z.seriesId,r==null?void 0:r.apicurioArtifactId,l,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(te=r==null?void 0:r.data)==null?void 0:te.title,f].map(x=>(x??"").toString().trim()),F=C.findIndex(Boolean),Q=F!==-1?C[F]:"";return Q?(console.log("[Series] deriveSeriesId: picked base",{base:Q,sourceIndex:F,candidates:C}),vn(Q,f)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:f}),null)}function Rt(r,{seriesName:l,fallbackTitle:f="unknown"}={}){if(!r||typeof r!="object")return null;const A=Pr(r,{seriesName:l,fallbackTitle:f});return A?(r.seriesId=A,r.apicurioArtifactId||(r.apicurioArtifactId=A),A):null}function Nn(r,l={}){var C,F;if(!r)return null;const f=r.isSeries||((C=r.apicurioVersions)==null?void 0:C.length)>1||r.seriesId||((F=r.data)==null?void 0:F.seriesId)||r.apicurioArtifactId;if(!f&&!l.force)return null;const A=Pr(r,l);return A||(f?vn(l.fallbackTitle||"unknown"):null)}const Vr={selectionDimOpacity:.2,selectionDimEnabled:!0},zn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,l=!0)=>{const f=Math.round((1-r)*100);return l?f===0?"Off":`${f}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function to(r){return r===!0||r==="true"||r===1||r==="1"}function Ul(r,{localBackend:l}={}){const f=l&&typeof l.getAutoReloadConfig=="function"&&l.getAutoReloadConfig(),A={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness};return f&&(A.autoReloadEnabled=!!f.enabled,A.autoReloadIntervalMs=f.intervalMs),A}function Hl(r={},l){var bt,E,w,$e;if(!r||typeof r!="object")return{applied:[]};const f=[],{applyTheme:A,applyTileHoverScale:C,persistTileHoverScale:F,applySelectionDimEnabled:Q,persistSelectionDimEnabled:z,applySelectionDimOpacity:te,persistSelectionDimOpacity:x,applyTileCompactness:ae,persistTileCompactness:W,applyTitleWrapMode:ie,persistTitleWrapMode:Le,applyTitleHoverWidthMultiplier:Xe,persistTitleHoverWidthMultiplier:Ze,applyTitleHoverTextPortion:qe,persistTitleHoverTextPortion:He,applyLinkThickness:J,persistLinkThickness:Y,applyDepColor:pe,persistDepColor:R,applyRevdepColor:Ae,persistRevdepColor:Pe,applyObsidianLinksEnabled:de,persistObsidianLinksEnabled:rt,applyObsidianLinkMode:fe,persistObsidianLinkMode:Se,applyObsidianVaultName:Me,persistObsidianVaultName:D,applyAutoIdFromNameEnabled:Z,persistAutoIdFromNameEnabled:k,applySeriesNavDoubleClickWait:ee,persistSeriesNavDoubleClickWait:me,applyCenterItems:ge,persistCenterItems:be,localBackend:Fe,ui:m,refreshObsidianLinks:ke,scheduleOverlaySync:Qe,selection:ut,select:st,clearStyles:pt,drawLinks:Be,applyReusedHighlights:lt,current:ft}=l;if(r.theme){const he=((A==null?void 0:A(r.theme))||r.theme)==="dark";(bt=l.ui)!=null&&bt.themeToggle&&(l.ui.themeToggle.checked=he),(E=l.ui)!=null&&E.tabThemeToggle&&(l.ui.tabThemeToggle.checked=he),f.push("theme")}if(r.hoverScale!=null){const g=C(parseFloat(r.hoverScale));F(g),m!=null&&m.hoverScaleInput&&(m.hoverScaleInput.value=String(g)),m!=null&&m.hoverScaleValue&&(m.hoverScaleValue.textContent=zn.hoverScale(g)),ut&&Qe(),f.push("hoverScale")}if(r.selectionDimEnabled!=null){const g=Q(to(r.selectionDimEnabled));z(g),m!=null&&m.selectionDimToggle&&(m.selectionDimToggle.checked=g),m!=null&&m.selectionDimInput&&(m.selectionDimInput.disabled=!g),m!=null&&m.selectionDimValue&&(m.selectionDimValue.textContent=zn.selectionDimming(ft.selectionDimOpacity??Vr.selectionDimOpacity,g)),f.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const g=te(parseFloat(r.selectionDimOpacity));x(g),m!=null&&m.selectionDimInput&&(m.selectionDimInput.value=String(g)),m!=null&&m.selectionDimValue&&(m.selectionDimValue.textContent=zn.selectionDimming(g,ft.selectionDimEnabled??Vr.selectionDimEnabled)),f.push("selectionDimOpacity")}if(r.tileCompactness!=null){const g=ae(parseFloat(r.tileCompactness));W(g),m!=null&&m.tileCompactnessInput&&(m.tileCompactnessInput.value=String(g)),m!=null&&m.tileCompactnessValue&&(m.tileCompactnessValue.textContent=zn.compactness(g)),ut&&Qe(),f.push("tileCompactness")}if(r.titleWrapMode){const g=ie(r.titleWrapMode);Le(g),m!=null&&m.titleWrapInput&&(m.titleWrapInput.checked=g!=="nowrap"),f.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const g=Xe(parseFloat(r.titleHoverWidthMultiplier));Ze(g),m!=null&&m.titleWidthInput&&(m.titleWidthInput.value=String(g)),m!=null&&m.titleWidthValue&&(m.titleWidthValue.textContent=zn.titleWidth(g)),f.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const g=qe(parseFloat(r.titleHoverTextPortion));He(g),m!=null&&m.titleZoomInput&&(m.titleZoomInput.value=String(g)),m!=null&&m.titleZoomValue&&(m.titleZoomValue.textContent=zn.titleZoomPortion(g)),f.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const g=de(to(r.obsidianLinksEnabled));rt(g),m!=null&&m.obsidianToggle&&(m.obsidianToggle.checked=g),(w=m==null?void 0:m.obsidianModeInputs)==null||w.forEach(he=>{he.disabled=!g}),m!=null&&m.obsidianVaultInput&&(m.obsidianVaultInput.disabled=!g),ke==null||ke(),f.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const g=fe(r.obsidianLinkMode);Se(g),($e=m==null?void 0:m.obsidianModeInputs)==null||$e.forEach(he=>{he.checked=he.value===g}),ke==null||ke(),f.push("obsidianLinkMode")}if(r.obsidianVault!=null){const g=Me(r.obsidianVault);D(g),m!=null&&m.obsidianVaultInput&&(m.obsidianVaultInput.value=g),ke==null||ke(),f.push("obsidianVault")}if(r.colorPresets&&(typeof l.setColorPresets=="function"&&l.setColorPresets(r.colorPresets),f.push("colorPresets")),r.linkThickness){const g=J==null?void 0:J(r.linkThickness);g&&(Y==null||Y(g),m!=null&&m.linkThicknessInput&&(m.linkThicknessInput.value=g),f.push("linkThickness"))}if(r.depColor){const g=pe==null?void 0:pe(r.depColor);g&&(R==null||R(g),m!=null&&m.depColorInput&&(m.depColorInput.value=g),f.push("depColor"))}if(r.revdepColor){const g=Ae==null?void 0:Ae(r.revdepColor);g&&(Pe==null||Pe(g),m!=null&&m.revdepColorInput&&(m.revdepColorInput.value=g),f.push("revdepColor"))}if(r.autoIdFromName!=null){const g=Z(to(r.autoIdFromName));k(g),m!=null&&m.autoIdToggle&&(m.autoIdToggle.checked=g),f.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const g=ee(parseInt(r.seriesNavDoubleClickMs,10));me(g),m!=null&&m.seriesNavInput&&(m.seriesNavInput.value=String(g)),m!=null&&m.seriesNavValue&&(m.seriesNavValue.textContent=zn.seriesNavWait(g)),f.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&Fe&&typeof Fe.setAutoReloadEnabled=="function"){const g=to(r.autoReloadEnabled);Fe.setAutoReloadEnabled(g),m!=null&&m.autoReloadToggle&&(m.autoReloadToggle.checked=g),m!=null&&m.autoReloadInput&&(m.autoReloadInput.disabled=!g),f.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&Fe&&typeof Fe.setAutoReloadInterval=="function"){const g=Fe.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));m!=null&&m.autoReloadInput&&(m.autoReloadInput.value=String(g)),m!=null&&m.autoReloadValue&&(m.autoReloadValue.textContent=zn.autoReloadInterval(g)),f.push("autoReloadIntervalMs")}if(r.centerItems!=null){const g=ge==null?void 0:ge(to(r.centerItems));be==null||be(g),m!=null&&m.tabCenterToggle&&(m.tabCenterToggle.checked=g),f.push("centerItems")}if(r.showSecondaryLinks!=null){const g=to(r.showSecondaryLinks);typeof l.setShowSecondaryLinks=="function"?l.setShowSecondaryLinks(g):l.showSecondaryLinks=g,m!=null&&m.secondaryLinksToggle&&(m.secondaryLinksToggle.checked=g),m!=null&&m.tabSecondaryLinksToggle&&(m.tabSecondaryLinksToggle.checked=g),ut?st(ut):(pt(),Be()),f.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const g=to(r.showReusedInMap);typeof l.setShowReusedInMap=="function"?l.setShowReusedInMap(g):l.showReusedInMap=g,m!=null&&m.reusedToggle&&(m.reusedToggle.checked=g),lt==null||lt(),f.push("showReusedInMap")}return{applied:f}}function Fl(r,l){const f=new Blob([l],{type:"application/json"}),A=URL.createObjectURL(f),C=document.createElement("a");C.href=A,C.download=r,C.click(),URL.revokeObjectURL(A)}const $i=typeof{url:Ln&&Ln.tagName.toUpperCase()==="SCRIPT"&&Ln.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function Wl(r={}){console.log("[Blockscape] init");const l={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},f=document.getElementById("jsonBox"),A=document.querySelector(".blockscape-json-panel"),C=document.getElementById("app"),F=document.getElementById("overlay"),Q=document.getElementById("tabTooltip"),z=document.getElementById("modelList"),te=document.getElementById("itemPreview"),x=document.getElementById("urlForm"),ae=document.getElementById("urlInput"),W=document.getElementById("loadUrl"),ie=te.querySelector(".item-preview__title"),Le=te.querySelector(".item-preview__body"),Xe=te.querySelector(".item-preview__actions"),Ze=te.querySelector(".item-preview__close"),qe=document.getElementById("downloadJson"),He=document.getElementById("shareModel"),J=document.getElementById("createVersion"),Y=document.getElementById("openInEditor"),pe=document.getElementById("copyJson"),R=document.getElementById("copySeries"),Ae=document.getElementById("pasteJson"),Pe=document.getElementById("helpButton"),de=document.getElementById("newPanelButton"),rt=document.getElementById("newBlankButton"),fe=document.getElementById("shortcutHelp"),Se=document.getElementById("shortcutHelpList"),Me=document.getElementById("shortcutHelpClose"),D=document.getElementById("shortcutHelpBackdrop"),Z=document.getElementById("newPanel"),k=document.getElementById("newPanelClose"),ee=document.getElementById("newPanelBackdrop"),me=document.getElementById("search"),ge=document.getElementById("searchResults"),be=document.getElementById("localBackendPanel"),Fe=document.getElementById("localBackendStatus"),m=document.getElementById("localFileList"),ke=document.getElementById("localDirSelect"),Qe=document.getElementById("refreshLocalFiles"),ut=document.getElementById("loadLocalFile"),st=document.getElementById("saveLocalFile"),pt=document.getElementById("saveLocalFileAs"),Be=document.getElementById("localSavePath"),lt="blockscape:editorPayload",ft="blockscape:editorTransfer",bt=document.title;be&&(be.hidden=!0),!l.localBackend&&be&&(be.hidden=!0),l.fileOpen||(ut&&(ut.hidden=!0),ke&&(ke.hidden=!0),Qe&&(Qe.hidden=!0),m&&(m.hidden=!0)),l.fileSave||(st&&(st.hidden=!0),pt&&(pt.hidden=!0),Be&&(Be.hidden=!0)),f.value=document.getElementById("seed").textContent.trim();let E=[],w=-1;const $e=$l({models:E,getActiveIndex:()=>w,setActive:Ct,ensureModelMetadata:xn,getModelId:mt,getSeriesId:Nn,ensureSeriesId:Rt,getModelTitle:Je,computeJsonFingerprint:Wi,uid:ro});let g=null,he=new Map,Ft=new Map,G=null,Ke=null,it=null,at=null,yn=!0,en=!1,tn=!1,Jn="map",Et=null,Wt=null,no=!1,cn=null;const Kn=2e3;let Ot=null,dn=null,nn=null,Xt=null,jt=null,Pt=null,En=null,on=null,Zt=null,Sn="",d=!1,v=null;const M=new Map;let N=null,S=null,O=[],X=null;const q=30,Ee=1e3,ve="blockscape:hoverScale",ue=1.5,ze=1,et=2.5,Re="blockscape:selectionDimOpacity",wt="blockscape:selectionDimEnabled",Ye=.2,vt=.05,De=1,ne="blockscape:titleWrap",Oe="blockscape:titleHoverWidth",ct="blockscape:titleHoverTextPortion",_t="wrap",St=1.3,_n=1,un=1.6,Cn=.25,oo=0,ha=.6,Fr="blockscape:tileCompactness",ti=1,Wr=.75,jr=1.25,zr="blockscape:obsidianLinksEnabled",Jr="blockscape:obsidianLinkMode",Kr="blockscape:obsidianVault",ga="title",Ri="id",Oi=ga,Gr="blockscape:autoReloadEnabled",qr="blockscape:autoReloadIntervalMs",ni=1e3,Yr=500,Xr=1e4,Zr="blockscape:autoIdFromName",Pi=!0,Qr="blockscape:colorPresets",es="blockscape:centerItems",ts="blockscape:theme",yo="light",io="dark",Vi="cat:",Di=!1,ns="blockscape:depColor",os="blockscape:revdepColor",is="blockscape:linkThickness",as={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let Eo=ue,Mn=Ye,Bn=!0,So=ti,ba=_t,ko=St,Io=Cn,_o=!1,oi=Oi,Co="",ao=Pi,ii=yo,zt=[],an=Di,Ui="",Hi="",ai="m",xo=null;const rs="blockscape:seriesNavDoubleClickMs",ri=900,ss=300,ls=4e3;let $n=ri;const Ce={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null},sc={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:ni}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},Ge=l.localBackend?xc():sc,cs=l.localBackend?Ge.detect():Promise.resolve(!1);$e.hydrateConfig(),wa(mc()),Lo(Sc(),{silent:!0}),bc(),wc(),Ec(),Uc(),Hc(),jc(),Kc(),zc(),Jc(),Xc(),ed(),Qc(),td(),Fc(),Wc(),gc(),Kt();function ro(){return Math.random().toString(36).slice(2,10)}function lc(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function cc(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function dc(e){return lc(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function uc(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),cc(t)}const ds=(e,t)=>Fl(e,t);function us(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function pc(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await rl(i),s=JSON.parse(a),c=us(s);if(c)return c}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function fc(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];l.initialSettings&&t.push({type:"inline",snapshot:l.initialSettings}),l.initialSettingsUrl&&t.push({type:"url",url:l.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?us(o.snapshot):await pc(o.url);if(!i)continue;const a=As(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function mc(){if(typeof window>"u"||!window.localStorage)return yo;try{return window.localStorage.getItem(ts)===io?io:yo}catch{return yo}}function hc(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ts,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function wa(e){const t=e===io?io:yo;return ii=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),hc(t),ii}function ps(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(es,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function Ao(e){return an=!!e,C&&(C.classList.toggle("is-center-mode",an),C.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",an)}),C.querySelectorAll(".tile-add").forEach(t=>{t.hidden=an,t.tabIndex=an?-1:0,t.setAttribute("aria-hidden",an?"true":"false")})),g&&(Yi(),kn()),an}function gc(){if(typeof window>"u"||!window.localStorage)return Ao(Di);try{const e=window.localStorage.getItem(es);return e==null?Ao(Di):Ao(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),Ao(Di)}}function To(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function fs(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function va(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function ms(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=To(i[1]);if(a)return va(a,n);if(t){const s=To(t);if(s)return va(s,n)}}return va(o,n)}function hs(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function ya(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ns,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function Ea(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(os,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function Sa(e){const t=ms(e,{fallbackVar:"--color-primary",fallbackColor:$t.color.primary});return Ui=t,fs("--blockscape-dep",t),F&&kn(),Ui}function ka(e){const t=ms(e,{fallbackVar:"--color-danger",fallbackColor:$t.blockscape.revdep});return Hi=t,fs("--blockscape-revdep",t),F&&kn(),Hi}function bc(){const e=hs(ns),t=Sa(e||To("--blockscape-dep")||$t.color.primary);return ya(t),t}function wc(){const e=hs(os),t=ka(e||To("--blockscape-revdep")||$t.blockscape.revdep);return Ea(t),t}function vc(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function yc(){return as[ai]||as.m}function si(e){return ai=vc(e),kn(),ai}function Ia(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(is,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function Ec(){if(typeof window>"u"||!window.localStorage)return si("m");try{const e=window.localStorage.getItem(is),t=si(e||"m");return Ia(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),si("m")}}function gs(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return li();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:li()}function li(){return[{name:"Black",value:$t.color.ink},{name:"White",value:$t.color.white},{name:"Red",value:$t.blockscape.revdep},{name:"Green",value:$t.color.success}]}function Sc(){if(typeof window>"u"||!window.localStorage)return li();try{const e=window.localStorage.getItem(Qr);if(!e)return li();const t=JSON.parse(e);return gs(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),li()}}function kc(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Qr,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function Lo(e,{silent:t=!1}={}){return zt=gs(e),kc(zt),!t&&typeof Wo=="function"&&Wo(zt),xo==null||xo(),zt}function Ic(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function Fi(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=so(e);if(!o)return;const i=E[w],a=so(i==null?void 0:i.sourcePath),s=t??(a&&a===o?mt(i):null),c=n??(a&&a===o?G:null),u=o.split("/").filter(Boolean).map(T=>encodeURIComponent(T)),h=s?encodeURIComponent(s):null,y=c?encodeURIComponent(c):null;try{const T=new URL(window.location.href),P=new URLSearchParams(T.search);P.delete("load"),P.delete("share");const L=["","server",...u,...h?[h]:[],...y?[y]:[]].join("/").replace(/\/+/g,"/");T.pathname=L,T.search=P.toString()?`?${P.toString()}`:"",T.hash="",window.history.replaceState({},document.title,T.toString())}catch(T){console.warn("[Blockscape] failed to update URL for server path",T)}}function _c(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(U=>U.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex(U=>U.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),c=i.slice(a+1),u=U=>{try{return decodeURIComponent(U)}catch{return U}},h=s.map(u),y=c.map(u),T=h.join("/"),P=so(T);if(!P)return null;const L=y[0]?y[0].trim():null,B=y[1]?y[1].trim():null;return{path:P,modelId:L||null,itemId:B||null}}function _a({itemId:e}={}){const t=E[w];t!=null&&t.sourcePath&&Fi(t.sourcePath,{modelId:mt(t),itemId:e===void 0?G:e})}function Cc(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function xc(){const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(I,j={}){console.log("[Blockscape][local-backend]",I,{...e(),...j})}if(Cc())return t("Disabled on github.io host"),be&&(be.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!Ic()||!be||!Fe)return t("Opt-in flag missing or panel unavailable"),be&&(be.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!be||!Fe)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],c="",u=new Map,h=U(),y=Ne(),T=null,P=!1;const L=new Set;function B(){return L.size>0}function U(){if(typeof window>"u"||!window.localStorage)return!0;try{const I=window.localStorage.getItem(Gr);return I==null?!0:I==="true"}catch{return!0}}function re(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Gr,I?"true":"false")}catch(j){console.warn("[Blockscape] auto-reload: failed to persist",j)}}function Ne(){if(typeof window>"u"||!window.localStorage)return ni;try{const I=window.localStorage.getItem(qr);if(!I)return ni;const j=parseInt(I,10);return Ie(j)}catch{return ni}}function dt(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(qr,String(I))}catch(j){console.warn("[Blockscape] auto-reload: failed to persist interval",j)}}function Ie(I){return Number.isFinite(I)?Math.min(Xr,Math.max(Yr,I)):ni}function Te(I){if(!I)return"";const j=I.split("/").filter(Boolean);return j.pop(),j.join("/")}function ot(I,{error:j=!1}={}){Fe.textContent=I,Fe.style.color=j?$t.color.dangerStrong:"",t("Status",{text:I,error:j})}function We(I){return so(I)}function xt(I){const j=Ji(I);return j?{payload:j,isSeries:!0}:{payload:I==null?void 0:I.data,isSeries:!1}}function Dt(){var j;if(w>=0&&((j=E[w])!=null&&j.sourcePath))return E[w].sourcePath;if(w<0)return"blockscape.bs";const I=Je(E[w])||"blockscape";return`${vn(I,"blockscape")}.bs`}function At(){var I;Be&&(Be.placeholder=Dt(),(I=E[w])!=null&&I.sourcePath&&(Be.value=E[w].sourcePath))}function _e(){if(!ke)return;ke.innerHTML="";const I=document.createElement("option");I.value="",I.textContent="All (~/blockscape)",ke.appendChild(I),s.forEach(se=>{const le=document.createElement("option");le.value=se,le.textContent=se||"(root)",ke.appendChild(le)});const j=s.includes(c)?c:"";ke.value=j,c=j}function kt(){if(!m)return;m.innerHTML="";const I=c?a.filter(j=>j.path.startsWith(`${c}/`)):a;if(!I.length){const j=document.createElement("option");j.disabled=!0,j.textContent="No .bs files found yet",m.appendChild(j),m.disabled=!0;return}m.disabled=!1,I.forEach(j=>{const se=document.createElement("option");se.value=j.path;const le=j.mtimeMs?new Date(j.mtimeMs).toLocaleString():"";se.textContent=le?`${j.path} · ${le}`:j.path,m.appendChild(se)}),i&&Array.from(m.options).forEach(j=>{j.value===i&&(j.selected=!0)}),!m.value&&m.options.length&&(m.options[0].selected=!0)}function In(I){if(!o||!m||!I||!a.find(tt=>tt.path===I))return;const se=Te(I);se!==c&&(c=se,_e()),kt(),Array.from(m.options).forEach(tt=>{tt.selected=tt.value===I});const le=Array.from(m.options).find(tt=>tt.value===I);le!=null&&le.scrollIntoView&&le.scrollIntoView({block:"nearest"}),Be&&(Be.value=I)}function Hn(){T&&(clearInterval(T),T=null)}function Tt(){Hn(),!(!o||!h||B())&&(T=setInterval(Tn,y))}function Qt(I){if(!I)return;const j=L.size;L.add(I),L.size!==j&&(t("Auto-reload paused",{reason:I}),Tt())}function Gt(I){if(!I)return;L.delete(I)&&(t("Auto-reload resumed",{reason:I}),Tt())}async function Ue(I){const j=E.findIndex(se=>se.sourcePath===I);if(j!==-1)try{const se=await fetch(`/api/file?path=${encodeURIComponent(I)}`,{cache:"no-store"});if(!se.ok)throw new Error(`HTTP ${se.status}`);const le=await se.json(),tt=JSON.stringify(le.data??le,null,2),Lt=Pn(tt,I,{seriesTitleOverride:`${I} series`});if(!Lt.length)return;const we=Lt[0];if(we.sourcePath=I,xn(we,{titleHint:Je(E[j]),idHint:mt(E[j])}),we.isSeries){const nt=we.title||Je(we)||Je(E[j]),yt=vn(nt||"unknown");lo(we,yt),Rt(we,{seriesName:nt||"unknown",fallbackTitle:"unknown"})}E[j]={...E[j],...we,title:we.title||Je(we),data:we.data,sourcePath:I},j===w?(Vt(),Bt()):On(),console.log("[Blockscape] auto-reloaded model from",I)}catch(se){console.warn("[Blockscape] auto-reload failed for",I,se)}}async function Tn(){if(!(!o||!h||B()||P)){P=!0;try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);const se=((await I.json()).files||[]).slice().sort((we,nt)=>{const yt=(we==null?void 0:we.mtimeMs)||0,sn=(nt==null?void 0:nt.mtimeMs)||0;return yt===sn?(we.path||"").localeCompare(nt.path||""):sn-yt}),le=new Map;se.forEach(we=>le.set(we.path,we.mtimeMs||0));const tt=E.map((we,nt)=>({path:we.sourcePath,idx:nt})).filter(we=>we.path);for(const we of tt){const nt=u.get(we.path)||0;(le.get(we.path)||0)>nt&&await Ue(we.path)}a=se;const Lt=new Set;a.forEach(we=>Lt.add(Te(we.path))),s=Array.from(Lt).filter(we=>we!=="").sort(),u=le,_e(),kt()}catch(I){console.warn("[Blockscape] auto-reload check failed",I)}finally{P=!1}}}function fo(I){h=!!I,re(h),Tt()}function Go(I){return y=Ie(I),dt(y),Tt(),y}function rn(I){o=!1,a=[],u=new Map,Hn(),kt(),be.hidden=!0,I&&ot(I,{error:!0}),t("Panel hidden",{message:I})}async function mo({silent:I=!1}={}){try{t("Health check start");const j=await fetch("/api/health",{cache:"no-store"});if(!j.ok)throw new Error(`HTTP ${j.status}`);const se=await j.json();if(o=!!(se!=null&&se.ok),!o)throw new Error("Health check failed");return be.hidden=!1,I||ot(se.root?`Local server ready (root: ${se.root})`:"Local server ready"),t("Health check ok",{payload:se}),!0}catch(j){return I||console.log("[Blockscape] local backend health failed",j),rn("Local server unavailable"),!1}}async function pn(){if(o&&m){ot("Loading files…");try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);a=((await I.json()).files||[]).slice().sort((le,tt)=>{const Lt=(le==null?void 0:le.mtimeMs)||0,we=(tt==null?void 0:tt.mtimeMs)||0;return Lt===we?(le.path||"").localeCompare(tt.path||""):we-Lt});const se=new Set;a.forEach(le=>{se.add(Te(le.path))}),s=Array.from(se).filter(le=>le!=="").sort(),c&&!se.has(c)&&(c=""),!c&&i&&(c=Te(i)),u=new Map(a.map(le=>[le.path,le.mtimeMs||0])),_e(),kt(),ot(a.length?`Browsing ${a.length} file(s) in ~/blockscape`:"No .bs files in ~/blockscape yet")}catch(I){console.warn("[Blockscape] local backend refresh failed",I),rn("Local server unavailable")}}}async function mi(){o=!1,rn(),ot("Checking for local server…");try{return t("Detect start"),await mo()?(At(),await pn(),Tt(),!0):!1}catch(I){return o=!1,console.log("[Blockscape] local backend not detected",I),t("Detect failed",{err:I}),!1}}async function qo(){if(!o||!m)return;const I=Array.from(m.selectedOptions||[]).map(se=>se.value).filter(Boolean).sort((se,le)=>se.localeCompare(le));if(!I.length){alert("Select one or more files to load from ~/blockscape.");return}let j=null;for(const se of I)try{ot(`Loading ${se}…`);const le=await bs(se);j==null&&(j=(le==null?void 0:le.firstIndex)??null),i=se,Fi(se)}catch(le){console.error("[Blockscape] failed to load from local server",le),alert(`Local load failed for ${se}: ${le.message}`)}j!=null&&Ct(j),ot(`Loaded ${I.length} file(s)`),kt()}async function Yo(I,{statusPrefix:j="Saved to",updateInput:se=!0}={}){if(!o)return;if(w<0){alert("No active model to save.");return}const le=E[w],{payload:tt,isSeries:Lt}=xt(le);if(!tt){alert("No model data to save.");return}const we=We(I);if(!we){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const nt=JSON.stringify(tt,null,2);ot(`Saving ${Lt?"series":"map"} to ${we}…`);const sn=await fetch(`/api/file?path=${encodeURIComponent(we)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:nt});if(!sn.ok)throw new Error(`HTTP ${sn.status}`);const qt=await sn.json();i=qt.path||we,le.sourcePath=qt.path||we,se&&Be&&(Be.value=qt.path||we),Fi(qt.path||we),ot(`${j} ${qt.path||we}`),await pn()}catch(nt){console.error("[Blockscape] local save failed",nt),alert(`Local save failed: ${nt.message}`),rn("Local server unavailable")}}async function Gn(){var j;const I=We(Be==null?void 0:Be.value)||We((j=E[w])==null?void 0:j.sourcePath)||Dt();if(!I){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Yo(I,{statusPrefix:"Saved to"})}async function hi(){var le;if(!o)return;if(w<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const I=We((le=E[w])==null?void 0:le.sourcePath)||Dt(),j=window.prompt("Save active map as (under ~/blockscape):",I);if(j==null)return;const se=We(j);if(!se){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Yo(se,{statusPrefix:"Saved to"})}async function gi(I,j,{refreshAfter:se=!0,statusPrefix:le="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(I)||I<0)return{ok:!1,error:"Invalid model index"};const tt=E[I],{payload:Lt,isSeries:we}=xt(tt);if(!Lt)return{ok:!1,error:"Model has no data"};const nt=We(j)||We(tt==null?void 0:tt.sourcePath)||Dt();if(!nt)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const yt=JSON.stringify(Lt,null,2);ot(`Saving ${we?"series":"map"} to ${nt}…`);const qt=await fetch(`/api/file?path=${encodeURIComponent(nt)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:yt});if(!qt.ok)throw new Error(`HTTP ${qt.status}`);const Fn=await qt.json();return i=Fn.path||nt,tt.sourcePath=Fn.path||nt,I===w&&At(),ot(`${le} ${Fn.path||nt}`),se&&await pn(),{ok:!0,path:Fn.path||nt}}catch(yt){return console.error("[Blockscape] local save failed",yt),rn("Local server unavailable"),{ok:!1,error:yt.message}}}if(Qe&&(Qe.onclick=()=>pn()),ut&&(ut.onclick=()=>qo()),st&&(st.onclick=()=>Gn()),pt&&(pt.onclick=()=>hi()),m&&Be&&(m.addEventListener("change",()=>{const I=Array.from(m.selectedOptions||[])[0];I!=null&&I.value&&(Be.value=I.value)}),m.addEventListener("dblclick",()=>{qo()})),ke&&ke.addEventListener("change",()=>{c=ke.value||"",kt()}),be){const I="local-files-panel-focus",j="local-files-panel-pointer";let se=!1,le=!1;be.addEventListener("focusin",()=>{se||(se=!0,Qt(I))}),be.addEventListener("focusout",tt=>{if(!se)return;const Lt=tt.relatedTarget;Lt&&be.contains(Lt)||(se=!1,Gt(I))}),be.addEventListener("pointerenter",()=>{le||(le=!0,Qt(j))}),be.addEventListener("pointerleave",()=>{le&&(le=!1,Gt(j))})}return{detect:mi,refresh:pn,updateActiveSavePlaceholder:At,isAvailable:()=>o,highlightSource:In,saveModelByIndex:gi,getAutoReloadConfig:()=>({enabled:h,intervalMs:y,available:o}),setAutoReloadEnabled:fo,setAutoReloadInterval:Go}}async function bs(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=Pn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let c=null;return s.forEach((u,h)=>{if(u.sourcePath=e,u.isSeries&&!u.title){const P=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");u.title=P}const y=An(u,{versionLabel:s.length>1?`${t} #${h+1}`:t});c==null&&(c=y)}),{firstIndex:c,total:s.length}}async function ws(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function Ac(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Jt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function so(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function Tc(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Lc(e,t){const n=so(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function Ca(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function ci(){try{await cs}catch{}return typeof(Ge==null?void 0:Ge.isAvailable)=="function"?Ge.isAvailable():!1}async function Nc(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Mc(e,t){const n=so(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const c=`${a}-${s}.bs`,u=[...o,c].filter(Boolean).join("/");if(!t.has(u))return u}return null}function Bc(e,t="clipboard"){const n=Je(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=Jt(n),i=Ca();return`${o}-${i}.bs`}function $c(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=Tc(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=vn(n||"unknown");return lo(e,o),Rt(e,{seriesName:n,fallbackTitle:n}),!0}function Rc(e){return Number.isFinite(e)?Math.min(et,Math.max(ze,e)):ue}function Kt(){if(!C)return;const e=!!G||!!Ke;C.classList.toggle("blockscape-has-selection",e),C.classList.toggle("blockscape-has-item-selection",!!G)}function No(e){return Eo=Rc(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",Eo),Eo}function Oc(e){return Number.isFinite(e)?Math.min(De,Math.max(vt,e)):Ye}function Mo(e){Mn=Oc(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Mn);const t=Bn?Mn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Mn}function Pc(e){return Number.isFinite(e)?Math.min(jr,Math.max(Wr,e)):ti}function Bo(e){return So=Pc(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",So),So}function Vc(e){return Number.isFinite(e)?Math.min(un,Math.max(_n,e)):St}function $o(e){return ko=Vc(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",ko),ko}function Dc(e){return Number.isFinite(e)?Math.min(ha,Math.max(oo,e)):Cn}function Ro(e){return Io=Dc(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Io),Io}function Oo(e){const t=e==="nowrap"?"nowrap":"wrap";ba=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function vs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ve,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function Uc(){if(typeof window>"u"||!window.localStorage)return No(ue);try{const e=window.localStorage.getItem(ve);if(!e)return No(ue);const t=parseFloat(e);return No(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),No(ue)}}function ys(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Re,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function Hc(){if(typeof window>"u"||!window.localStorage)return Mo(Ye);try{const e=window.localStorage.getItem(Re);if(!e)return Mo(Ye);const t=parseFloat(e);return Mo(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Mo(Ye)}}function Po(e){Bn=!!e;const t=Bn?Mn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),C&&C.classList.toggle("blockscape-dimming-disabled",!Bn),Bn}function Es(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(wt,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function Fc(){if(typeof window>"u"||!window.localStorage)return Po(!0);try{const e=window.localStorage.getItem(wt);return e==null?Po(!0):Po(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),Po(!0)}}function Vo(e){return ao=!!e,ao}function Ss(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Zr,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function Wc(){if(typeof window>"u"||!window.localStorage)return Vo(Pi);try{const e=window.localStorage.getItem(Zr);return e==null?Vo(Pi):Vo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Vo(Pi)}}function ks(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Fr,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function jc(){if(typeof window>"u"||!window.localStorage)return Bo(ti);try{const e=window.localStorage.getItem(Fr);if(!e)return Bo(ti);const t=parseFloat(e);return Bo(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Bo(ti)}}function Is(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Oe,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function zc(){if(typeof window>"u"||!window.localStorage)return $o(St);try{const e=window.localStorage.getItem(Oe);if(!e)return $o(St);const t=parseFloat(e);return $o(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),$o(St)}}function _s(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ct,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function Jc(){if(typeof window>"u"||!window.localStorage)return Ro(Cn);try{const e=window.localStorage.getItem(ct);if(!e)return Ro(Cn);const t=parseFloat(e);return Ro(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Ro(Cn)}}function Cs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ne,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function Kc(){if(typeof window>"u"||!window.localStorage)return Oo(_t);try{const e=window.localStorage.getItem(ne);return Oo(e||_t)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Oo(_t)}}function Gc(e){return Number.isFinite(e)?Math.min(ls,Math.max(ss,e)):ri}function Do(e){return $n=Gc(e),$n}function qc(e){yn=!!e}function Yc(e){tn=!!e}function xs(){return{hoverScale:Eo,selectionDimOpacity:Mn,selectionDimEnabled:Bn,tileCompactness:So,titleWrapMode:ba,titleHoverWidthMultiplier:ko,titleHoverTextPortion:Io,obsidianLinksEnabled:_o,obsidianLinkMode:oi,obsidianVaultName:Co,autoIdFromNameEnabled:ao,seriesNavDoubleClickWaitMs:$n,showSecondaryLinks:yn,centerItems:an,showReusedInMap:tn,theme:ii,colorPresets:zt,depColor:Ui,revdepColor:Hi,linkThickness:ai}}function As(e,{refreshObsidianLinks:t}={}){return Hl(e,{applyTileHoverScale:No,persistTileHoverScale:vs,applySelectionDimEnabled:Po,persistSelectionDimEnabled:Es,applySelectionDimOpacity:Mo,persistSelectionDimOpacity:ys,applyTileCompactness:Bo,persistTileCompactness:ks,applyTitleWrapMode:Oo,persistTitleWrapMode:Cs,applyTitleHoverWidthMultiplier:$o,persistTitleHoverWidthMultiplier:Is,applyTitleHoverTextPortion:Ro,persistTitleHoverTextPortion:_s,applyObsidianLinksEnabled:Ho,persistObsidianLinksEnabled:Ns,applyObsidianLinkMode:Uo,persistObsidianLinkMode:Ls,applyObsidianVaultName:Fo,persistObsidianVaultName:Ms,applyAutoIdFromNameEnabled:Vo,persistAutoIdFromNameEnabled:Ss,applySeriesNavDoubleClickWait:Do,persistSeriesNavDoubleClickWait:Ts,localBackend:Ge,ui:Ce,refreshObsidianLinks:t,scheduleOverlaySync:zo,selection:G,select:Mt,clearStyles:Zi,drawLinks:kn,applyReusedHighlights:Da,setShowSecondaryLinks:qc,setShowReusedInMap:Yc,applyDepColor:Sa,persistDepColor:ya,applyRevdepColor:ka,persistRevdepColor:Ea,applyLinkThickness:si,persistLinkThickness:Ia,applyTheme:wa,setColorPresets:Lo,applyCenterItems:Ao,persistCenterItems:ps,current:xs()})}function Ts(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(rs,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function Xc(){if(typeof window>"u"||!window.localStorage)return Do(ri);try{const e=window.localStorage.getItem(rs);if(!e)return Do(ri);const t=parseInt(e,10);return Do(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Do(ri)}}function Zc(e){return e===Ri?Ri:ga}function Uo(e){return oi=Zc(e),oi}function Ls(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Jr,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function Qc(){if(typeof window>"u"||!window.localStorage)return Uo(Oi);try{const e=window.localStorage.getItem(Jr);return Uo(e||Oi)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Uo(Oi)}}function Ho(e){return _o=!!e,_o}function Ns(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(zr,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function ed(){if(typeof window>"u"||!window.localStorage)return Ho(!1);try{const e=window.localStorage.getItem(zr);return e==null?Ho(!1):Ho(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Ho(!1)}}function Fo(e){return Co=(e??"").toString().trim(),Co}function Ms(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Kr,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function td(){if(typeof window>"u"||!window.localStorage)return Fo("");try{const e=window.localStorage.getItem(Kr);return Fo(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Fo("")}}function nd(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function od(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function lo(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function id(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||ji(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=Nn(e,{seriesName:o,fallbackTitle:o})||vn(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=vn(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,lo(e,s),!0}function xa(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>xa(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${xa(e[o])}`).join(",")}}`}function Bs(e){try{return xa(e)}catch{return""}}function Wi(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=Bs(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=Bs(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const ad=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function xn(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=Jt(a).replace(/\./g,"-");e.id=s||`model-${ro()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function rd(e){var s,c;const t=u=>{const h=(u??"").toString().trim();if(!h)return{base:"",suffix:null};const y=h.match(/^(.*?)-(\d+)$/);return{base:y?y[1]:h,suffix:y?Number.parseInt(y[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const u of n){if(u!=null&&u.isCategoryView)continue;const h=t(((c=u==null?void 0:u.data)==null?void 0:c.id)??(u==null?void 0:u.id)??"");if(h.base){i=h.base;break}}i||(i=Jt(Nn(e)||Aa(e)||Je(e,"model")));let a=0;return n.forEach(u=>{var y;if(u!=null&&u.isCategoryView)return;const h=t(((y=u==null?void 0:u.data)==null?void 0:y.id)??(u==null?void 0:u.id)??"");h.base===i&&Number.isFinite(h.suffix)&&h.suffix>a&&(a=h.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function sd(e){return JSON.parse(JSON.stringify(e))}function Je(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function ji(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=mt(e);return a?`${a} series`:t}return Je(e,t)}function mt(e){var i;const t=Nn(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function Aa(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function ld(e){return e?e.toString().replace(/-series$/i,""):null}function Ta(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<E.length;n++){const o=(mt(E[n])||"").toLowerCase(),i=(Aa(E[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function $s(e){var c;if(e<0||e>=E.length||!f)return!0;const t=E[e],n=(f.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}xn(o,{titleHint:Je(t),idHint:mt(t)});const i=Wi(t.data),a=Wi(o);if(i===a)return!0;t.data=o;const s=Vn(t);return s>=0&&((c=t.apicurioVersions)!=null&&c[s])&&(t.apicurioVersions[s].data=o),!0}function Rs(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function La(e){if(w<0||!e)return null;const t=E[w].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function cd(e,t){const n=La(e);return n?(t?n.item.color=t:delete n.item.color,Vt(),Bt(),Mt(e),!0):!1}function dd(e,t){const n=Rs(t);let o=Jt(e||"item");if(!n.has(o))return o;const i=()=>ro().slice(0,4);for(;n.has(o);)o=`${Jt(e||"item")}-${i()}`;return o}function ud(e="category",t){const n=(t==null?void 0:t.categories)||[],o=Jt(e||"category"),i=c=>n.some(u=>u.id===c);let a=o||`category-${ro()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const co=Vl({findItemAndCategoryById:La,collectAllItemIds:Rs,updateItemReferences:Pl,loadActiveIntoEditor:Vt,rebuildFromActive:Bt,select:e=>Mt(e),onSelectionRenamed:(e,t)=>{var n;G===e&&(G=t,Kt()),((n=Et==null?void 0:Et.item)==null?void 0:n.id)===e&&(Et.item.id=t)},makeSlug:Jt,isAutoIdFromNameEnabled:()=>ao});function pd({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=B=>{if(a.fields.errorEl){if(!B){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=B}},c=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},u=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var B,U;(B=a.fields.titleInput)==null||B.focus(),(U=a.fields.titleInput)==null||U.select()}))},h=({force:B}={})=>{var re,Ne;if(!ao||!a.autoSyncEnabled||!((re=a.fields)!=null&&re.idInput)||!((Ne=a.fields)!=null&&Ne.titleInput)||!B&&a.idManuallyEdited)return;const U=Jt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=U},y=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const B=a.modelData.categories||[],U=B.find(Te=>Te.id===a.categoryId);if(!U)throw new Error("Category not found.");const re=(a.fields.idInput.value||"").trim();if(!re)throw new Error("ID is required.");const Ne=(a.fields.titleInput.value||"").trim();if(B.some(Te=>Te.id===re&&Te.id!==U.id))throw new Error("Another category already uses that ID.");const Ie=U.id;return U.id=re,U.title=Ne||U.id,Ie!==re&&typeof i=="function"&&i(Ie,re),t(),n(),o(re,{scrollIntoView:!0}),!0},T=()=>{try{return y(),c(),!0}catch(B){return console.warn("[CategoryEditor] save failed",B),s((B==null?void 0:B.message)||"Unable to save category."),!1}},P=()=>{if(a.wrapper)return a.wrapper;const B=document.createElement("div");B.className="item-editor-modal category-editor-modal",B.hidden=!0,B.setAttribute("role","dialog"),B.setAttribute("aria-modal","true");const U=document.createElement("div");U.className="item-editor-modal__backdrop",B.appendChild(U);const re=document.createElement("div");re.className="item-editor",B.appendChild(re);const Ne=document.createElement("div");Ne.className="item-editor__header";const dt=document.createElement("h2");dt.className="item-editor__title",dt.textContent="Edit category";const Ie=document.createElement("button");Ie.type="button",Ie.className="item-editor__close",Ie.setAttribute("aria-label","Close category editor"),Ie.textContent="×",Ne.appendChild(dt),Ne.appendChild(Ie),re.appendChild(Ne);const Te=document.createElement("form");Te.className="item-editor__form",re.appendChild(Te);const ot=document.createElement("div");ot.className="item-editor__meta",ot.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',Te.appendChild(ot);const We=document.createElement("div");We.className="item-editor__error",We.hidden=!0,Te.appendChild(We);const xt=(Tn,fo,Go)=>{const rn=document.createElement("label");rn.className="item-editor__field";const mo=document.createElement("span");if(mo.className="item-editor__label",mo.textContent=Tn,rn.appendChild(mo),fo.classList.add("item-editor__control"),rn.appendChild(fo),Go){const pn=document.createElement("div");pn.className="item-editor__hint",pn.textContent=Go,rn.appendChild(pn)}return rn},Dt=document.createElement("input");Dt.type="text",Te.appendChild(xt("Title",Dt,"Display label shown in the map."));const At=document.createElement("input");At.type="text",At.required=!0,Te.appendChild(xt("ID",At,"Unique identifier for this category (used in URLs and references)."));const _e=document.createElement("div");_e.className="item-editor__checkbox";const kt=document.createElement("label");kt.className="item-editor__checkbox-row";const In=document.createElement("input");In.type="checkbox";const Hn=document.createElement("span");Hn.textContent="Sync ID while editing title";const Tt=document.createElement("div");Tt.className="item-editor__hint",Tt.textContent="Turn off to keep typing titles without changing the ID.",kt.append(In,Hn),_e.append(kt,Tt),Te.appendChild(_e);const Qt=document.createElement("div");Qt.className="item-editor__actions";const Gt=document.createElement("button");Gt.type="submit",Gt.className="item-editor__action item-editor__action--primary",Gt.textContent="Save";const Ue=document.createElement("button");return Ue.type="button",Ue.className="item-editor__action",Ue.textContent="Cancel",Qt.appendChild(Gt),Qt.appendChild(Ue),Te.appendChild(Qt),Te.addEventListener("submit",Tn=>{Tn.preventDefault(),T()}),Ue.addEventListener("click",c),Ie.addEventListener("click",c),U.addEventListener("click",c),At.addEventListener("input",()=>{a.idManuallyEdited=!0}),Dt.addEventListener("input",()=>h()),In.addEventListener("change",()=>{a.autoSyncEnabled=!!In.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,h({force:!0}))}),B.addEventListener("keydown",Tn=>{Tn.key==="Escape"&&(Tn.preventDefault(),c())}),document.body.appendChild(B),a.wrapper=B,a.fields={titleInput:Dt,idInput:At,errorEl:We,metaLabel:ot.querySelector(".item-editor__meta-value"),syncCheckbox:In},B};return{open:B=>{if(!B||!P())return!1;const re=e(),dt=((re==null?void 0:re.categories)||[]).find(Te=>Te.id===B);if(!dt)return!1;a.categoryId=dt.id,a.modelData=re,a.idManuallyEdited=!1;const Ie=!!ao;return a.autoSyncEnabled=Ie,a.fields.metaLabel.textContent=dt.title||dt.id||"Category",a.fields.titleInput.value=dt.title||dt.id||"",a.fields.idInput.value=dt.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!Ie,!a.fields.idInput.value&&Ie&&h({force:!0}),s(""),u(),!0},hide:c,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const fd=pd({getActiveModelData:()=>{var e;return(e=E[w])==null?void 0:e.data},loadActiveIntoEditor:Vt,rebuildFromActive:Bt,selectCategory:(e,t={})=>Dn(e,t),onCategoryRenamed:(e,t)=>{Ke===e&&(Ke=t,Kt())}}),{handleTileContextMenu:md,hidePreview:uo,handleDocumentClick:hd,handleWindowResize:gd,handleWindowScroll:bd,updateColorPresets:Wo}=Dl({menuEl:document.getElementById("tileContextMenu"),previewEl:te,previewTitleEl:ie,previewBodyEl:Le,previewActionsEl:Xe,previewCloseEl:Ze,escapeHtml:pi,onEditItem:e=>co.open(e),onChangeColor:(e,t)=>cd(e,t),selectItem:e=>Mt(e),colorPresets:zt});function zi(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||Je(e);return Rt(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function wd({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=Jt(`${e||"blank"}-${Ca()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),xn(o,{titleHint:t,idHint:n}),o}function vd(){const t=`Blank series ${Ca()}`,n=vn(t,"blank-series"),o=wd({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return lo(i,n),Rt(i,{seriesName:t,fallbackTitle:t}),i}function yd(){const e=vd(),t=An(e,{versionLabel:"blank"});return Ct(t),Ki(),Rn("Blank series created. Add categories and tiles to start.",2600),t}function An(e,{versionLabel:t,createdOn:n}={}){var u,h,y;if(e!=null&&e.isSeries||((u=e==null?void 0:e.apicurioVersions)==null?void 0:u.length)>1){const T=e.title||Je(e);Rt(e,{seriesName:T,fallbackTitle:T}),Gi(e)}const o=mt(e);if(!o)return zi(e,{versionLabel:t||"1",createdOn:n}),E.push(e),E.length-1;const i=E.findIndex(T=>mt(T)===o);if(i===-1)return zi(e,{versionLabel:t||"1",createdOn:n}),E.push(e),E.length-1;const a=E[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(y=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:y.createdOn}],a.apicurioActiveVersionIndex=0;const T=a.title||Je(a);Rt(a,{seriesName:T,fallbackTitle:T})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=Je(e)||a.title,a.isSeries=!0;const c=a.title||Je(a);return Rt(a,{seriesName:c,fallbackTitle:c}),i}function Os({versionLabel:e}={}){var c;if(w<0||!E[w])throw new Error("Load or select a model before creating a version.");const t=E[w];zi(t,{versionLabel:"1"});const n=rd(t);let o;try{o=sd(t.data)}catch(u){throw console.warn("[Blockscape] failed to clone active model for versioning",u),new Error("Could not copy the current model.")}n&&(o.id=n),xn(o,{titleHint:Je(t),idHint:mt(t)||Nn(t)});const a={version:e||String((((c=t.apicurioVersions)==null?void 0:c.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||Je(t);return Rt(t,{seriesName:s,fallbackTitle:s}),w}function Na(){const e=w>=0&&E[w]?E[w]:null,t=mt(e);document.title=t?`${t}-blockscape`:bt}function Ji(e){if(!e)return null;Gi(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||Je(e);return Rt(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var u;const s=((i==null?void 0:i.version)??"").toString().trim(),c=(((u=i==null?void 0:i.data)==null?void 0:u.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(Vi)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:c}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function Ed(){const e=E[w],t=Ji(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function Ps(e="shortcut",t=!1){const n=f.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=E[w],i=t?Ji(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,c=Nn(o),u=mt(o),h=c||u||Je(o,"blockscape"),y=a?"-series":"",T=`${Jt(h)}${y}.bs`;return ds(T,s),console.log(`[Blockscape] saved JSON (${e}):`,T),!0}const Sd=$t.palette.letter,kd=$t.palette.letterFallback;function Vs(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Sd[n]||kd}function Id(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?$t.color.ink:$t.color.white}function _d(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function Ma(){if(jt)return;jt=document.createElement("div"),jt.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",Pt=document.createElement("span"),Pt.className="series-nav-notice__text",jt.appendChild(e),jt.appendChild(Pt),document.body.appendChild(jt)}function Ba(){En&&(clearTimeout(En),En=null),jt&&jt.classList.remove("is-visible"),Pt&&(Pt.textContent="")}function jo(){Ot=null,dn&&(clearTimeout(dn),dn=null),Ba()}function $a(){nn=null,Xt&&(clearTimeout(Xt),Xt=null),Ba()}function Cd(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function xd(e,t,n){Ma(),Ot={id:e,targetVersionIndex:t},dn&&clearTimeout(dn),dn=setTimeout(()=>{dn=null,jo()},$n);const o=Cd(n,t);Rn(`Click again to open ${o} in this series.`,$n)}function Ad(e,t){Ma(),nn={id:e,targetIndex:t},Xt&&clearTimeout(Xt),Xt=setTimeout(()=>{Xt=null,$a()},$n);const n=ji(E[t]);Rn(`Click again to open "${n}".`,$n)}function Rn(e,t=Kn,n=null){if(Ma(),Pt.textContent="",Pt.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,Pt.appendChild(o),Pt.appendChild(i)}jt.classList.add("is-visible"),En&&clearTimeout(En),En=setTimeout(()=>Ba(),t)}function Td(){Se&&(Se.innerHTML="",ad.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const c=document.createElement("span");c.className="shortcut-help__or",c.textContent="or",n.appendChild(c)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((c,u)=>{if(u>0){const y=document.createElement("span");y.className="shortcut-help__sep",y.textContent="+",s.appendChild(y)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=c,s.appendChild(h)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),Se.appendChild(t)}),no=!0)}function Ld(){return!!fe&&fe.hidden===!1}function Nd(){if(!fe)return;no||Td(),cn=document.activeElement,fe.hidden=!1,fe.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=fe.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ra(){if(!fe||fe.hidden)return;fe.hidden=!0,fe.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=cn;e!=null&&e.focus?e.focus({preventScroll:!0}):Pe!=null&&Pe.focus&&Pe.focus({preventScroll:!0})}function Md(){if(!Z)return;Z.hidden=!1,Z.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Z.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ki(){!Z||Z.hidden||(Z.hidden=!0,Z.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),de!=null&&de.focus&&de.focus({preventScroll:!0}))}let Oa=!1;function zo(){Oa||(Oa=!0,requestAnimationFrame(()=>{Oa=!1,Yi(),kn()}))}let Ds=!1;function Us(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function Bd(e){const t=Us(e);if(!t.length){C.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}C.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(c=>o.includes(c)||i.includes(c));n.style.opacity=a?"1":"0.2"})}function $d(e){const t=Us(e);if(!t.length)return[];const n=[];return E.forEach((o,i)=>{var h;const a=ji(o),s=mt(o)||"",c=`${a} ${s}`.toLowerCase();t.every(y=>c.includes(y))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((h=o.data)==null?void 0:h.categories)?o.data.categories:[]).forEach(y=>{const T=(y.title||y.id||"").toString();(y.items||[]).forEach(P=>{const L=(P.name||P.id||"").toString(),B=`${L} ${P.id||""} ${T}`.toLowerCase();t.every(U=>B.includes(U))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:P.id,itemName:L,categoryTitle:T})})})}),n.slice(0,q)}function Hs(e){if(!ge)return;ge.innerHTML="";const t=(e||"").toString();if(!t.trim()){ge.hidden=!0;return}if(!E.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",ge.appendChild(o),ge.hidden=!1;return}const n=$d(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",ge.appendChild(o),ge.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===w&&(!o.itemId||G===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemName||o.itemId||"Item",a.appendChild(s);const c=document.createElement("span");c.className="search-result__badge",c.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(c);const u=document.createElement("div");u.className="search-result__meta";const h=document.createElement("span");if(h.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,u.appendChild(h),o.type==="item"&&o.itemId){const y=document.createElement("span");y.textContent=`Item ID: ${o.itemId}`,u.appendChild(y)}else if(o.type==="model"){const y=document.createElement("span");y.textContent="Matches model title",u.appendChild(y)}i.appendChild(a),i.appendChild(u),ge.appendChild(i)}),ge.hidden=!1}function Fs(e){Bd(e||""),Hs(e||"")}function Rd(e){!e||!Number.isInteger(e.modelIndex)||(Ct(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(w!==e.modelIndex)return;const t=(n=he.get(e.itemId))==null?void 0:n.el;t&&(Mt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function Ct(e){var t;if(uo(),jo(),Et=null,Wt=null,Ke=null,at=null,e<0||e>=E.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(d=!0,w=e,console.log("[Blockscape] active model:",Je(E[e]),"(index",e+" )"),typeof(Ge==null?void 0:Ge.highlightSource)=="function"){const n=((t=E[e])==null?void 0:t.sourcePath)||null;Ge.highlightSource(n)}Na(),On(),Vt(),Bt(),me&&Fs(me.value||""),Ge.updateActiveSavePlaceholder(),$e.updateAvailability(),_a()}function On(){if(z.innerHTML="",!E.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",z.appendChild(e);return}E.forEach((e,t)=>{var T;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===w?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===w?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=ji(e),i.appendChild(a);const s=ld(Aa(e)||mt(e));if(s){const P=document.createElement("span");P.className="model-nav-id",P.textContent=s,i.appendChild(P)}const c=Array.isArray((T=e.data)==null?void 0:T.categories)?e.data.categories:[],u=c.reduce((P,L)=>P+(L.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const y=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";h.textContent=`${c.length} cat · ${u} items${y}`,o.appendChild(i),o.appendChild(h),n.appendChild(o),z.appendChild(n)}),$e.updateAvailability()}function Vt(){if(w<0){f.value="",R&&(R.disabled=!0);return}const e=E[w];f.value=JSON.stringify(e.data,null,2),R&&(R.disabled=!Ji(e))}function Od(e){try{return JSON.parse(e)}catch{return null}}function Ws(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function Pd(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,c)=>{const u=s==null?void 0:s.data;if(!u||!Array.isArray(u.categories))return;const h=Je(u,`Map ${c+1}`),y=(u.id??"").toString().trim()||Jt(h||`map-${c+1}`),T=Jt(y||h||`map-${c+1}`);u.categories.forEach(P=>{const L=((P==null?void 0:P.id)??"").toString().trim();if(!L)return;n.has(L)||n.set(L,{catTitle:P.title||L,sources:[]});const B=n.get(L);!B.catTitle&&(P.title||L)&&(B.catTitle=P.title||L),B.sources.push({category:P,mapId:y,mapTitle:h,mapSlug:T,versionIndex:c})})});const o=Nn(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||Je(e,"Series"),a=[];return n.forEach((s,c)=>{var P;if((((P=s.sources)==null?void 0:P.length)||0)<2)return;const u=s.catTitle||c,h=new Set,y=s.sources.map(L=>{var dt;let U=L.mapSlug||Jt(L.mapTitle||L.mapId)||`map-${L.versionIndex+1}`;h.has(U)&&(U=`${U}-${L.versionIndex+1}`),h.add(U);const re=new Map,Ne=(((dt=L.category)==null?void 0:dt.items)||[]).map((Ie,Te)=>{const ot=((Ie==null?void 0:Ie.id)??"").toString().trim()||`item-${Te+1}`,We=`${U}-${ot}`;re.set(ot,We);const xt={...Ie,id:We};return xt.deps=Array.isArray(Ie==null?void 0:Ie.deps)?[...Ie.deps]:[],xt});return Ne.forEach(Ie=>{Ie.deps=(Ie.deps||[]).map(Te=>re.get(Te)).filter(Boolean)}),{id:U,title:L.mapTitle||L.mapId||`Map ${L.versionIndex+1}`,items:Ne}}),T={id:Jt(`${c}-category-view`),title:u,abstract:`Items from "${u}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:y};o&&(T.seriesId=o),xn(T,{titleHint:u,idHint:`${o||"series"}-${c}`}),a.push({version:`${Vi}${c}`,data:T,isCategoryView:!0,categoryViewKey:c})}),a}function js(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${Vi}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function Gi(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=js(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(c=>!(c!=null&&c.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Vn(e),e.apicurioVersions.length-1));const c=e.apicurioVersions[e.apicurioActiveVersionIndex];return c!=null&&c.data&&(e.data=c.data),e}const o=Pd({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(c=>js(c)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function Vd(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((y,T)=>!y||typeof y!="object"?null:(xn(y,{titleHint:`${t} #${T+1}`}),{obj:y,idx:T})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let c=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const u={id:ro(),title:c,data:a,apicurioVersions:i.map(({obj:y,idx:T})=>({version:String(T+1),data:y})),apicurioActiveVersionIndex:0,isSeries:!0},h=Rt(u,{seriesName:c,fallbackTitle:c});return h&&(u.id=h),Gi(u),[u]}function zs(e,t="Pasted",n={}){return Array.isArray(e)?Vd(e,t,n):!e||typeof e!="object"?[]:(xn(e,{titleHint:`${t} #1`}),[{id:ro(),title:e.title||`${t} #1`,data:e}])}function Pn(e,t="Pasted",n={}){const i=(Ws(typeof e=="string"?e:"")||"").trim();if(!i)return[];const a=Od(i);if(a){let c=n;if(Array.isArray(a)&&n.promptForSeriesName){const h=od(a,t),y=nd(h);c={...n,promptForSeriesName:!1,seriesTitleOverride:y||h}}const u=zs(a,t,c);if(u.length)return u}return i.split(/^\s*(?:---|%%%)\s*$/m).map(c=>c.trim()).filter(Boolean).map((c,u)=>{const h=JSON.parse(c);return xn(h,{titleHint:`${t} #${u+1}`}),{id:ro(),title:h.title||`${t} #${u+1}`,data:h}})}function Dd(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function po(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!Dd(e)}function Ud(e){if(!e)return!1;const n=(Ws(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function Js(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(lt)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(lt)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(lt)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=Pn(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let o=null;return n.forEach(i=>{const a=An(i,{versionLabel:"editor"});o==null&&(o=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:o,count:n.length}}function Ks(e="storage"){const t=Js();return!t||typeof t.index!="number"?!1:(Ct(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Hd(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=uc(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=zs(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const c=s.isSeries?o.title||s.title:null,u=An({...s,apicurioArtifactName:c||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=u)}),a}async function Fd(){const e=_c();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await ci())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await bs(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(Ge==null?void 0:Ge.highlightSource)=="function"&&Ge.highlightSource(t);let s=a.firstIndex;if(n){const c=Ta(n);c!==-1&&(s=c)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function Wd(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await Ua(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function jd(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const c=new Set(s.deps||[]);t.set(s.id,c),c.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function zd(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=Vs(e,t),c=Id(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=c,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function Vn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Gs(e){const t=Vn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function qs(e,t="active"){return Nn(e)||mt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function Jd(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,c;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((c=n==null?void 0:n.data)==null?void 0:c.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function Kd(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(Jt(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,c]of t.entries())if(s.toLowerCase()===a)return c}return null}const Ys=new WeakMap;function Gd(e,t){var We;if(!((We=e==null?void 0:e.apicurioVersions)!=null&&We[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=Wi(o),a=Ys.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,c=160,u=document.createElement("canvas");u.width=s,u.height=c;const h=u.getContext("2d"),y=To("--color-surface-ghost")||$t.color.surfaceGhost,T=To("--color-border-muted")||$t.color.borderMuted;h.fillStyle=y,h.fillRect(0,0,s,c),h.strokeStyle=T,h.strokeRect(.5,.5,s-1,c-1);const P=8,L=8,B=4,U=Array.isArray(o==null?void 0:o.categories)?o.categories:[],re=Math.max(U.length,1),Ne=s-B*2,dt=B*3,Ie=re>1?Math.min(dt,Ne/(re-1)):0,Te=re>1?(s-Ie*(re-1))/2:s/2;U.forEach((xt,Dt)=>{const At=Te+Dt*Ie,_e=Array.isArray(xt.items)?xt.items:[],kt=Math.max(_e.length,1),In=c-P-L-B*2,Hn=kt>1?Math.min(B*3,In/(kt-1)):0;_e.forEach((Tt,Qt)=>{const Gt=c-L-B-Qt*Hn;h.beginPath(),h.arc(At,Gt,B,0,Math.PI*2);const Ue=Vs(Tt.name||Tt.id||"",Tt.color);h.fillStyle=Ue,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const ot=u.toDataURL("image/png");return Ys.set(n,{fingerprint:i,dataUrl:ot}),ot}function qi(e,t){var c;if(jo(),e<0||e>=E.length)return!1;const n=E[e];if(!((c=n==null?void 0:n.apicurioVersions)!=null&&c.length)||!$s(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,d=!0,G=null,it=null,Kt(),Vt(),Bt(),!0):!1}function Pa(e){var o;if(!e||w<0)return!1;const t=E[w];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=Vn(t);return n===-1?!1:qi(w,n+e)}function qd(e,t){if(jo(),e<0||e>=E.length)return!1;const n=E[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!$s(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=Vn(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const c=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(c==null?void 0:c.data)||n.data,n.isSeries=n.apicurioVersions.length>1,Ct(e),!0}function Yd(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,l.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||mt(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var Ne;const U=E[w];!((Ne=U==null?void 0:U.apicurioVersions)!=null&&Ne.length)||!id(U)||(On(),Vt(),Bt())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=Vn(e),s=Gs(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const c=document.createElement("div");c.className="version-nav__controls";const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Previous",u.addEventListener("click",()=>Pa(-1));const h=document.createElement("button");h.type="button",h.className="version-nav__button",h.textContent="Next",h.addEventListener("click",()=>Pa(1)),c.appendChild(u),c.appendChild(h),n.appendChild(c);const y=document.createElement("div");y.className="version-nav__thumbs",e.apicurioVersions.forEach((U,re)=>{var Dt,At;const Ne=document.createElement("button");Ne.type="button",Ne.className="version-nav__thumb",U!=null&&U.isCategoryView&&Ne.classList.add("version-nav__thumb--category"),re===a&&Ne.classList.add("is-active");const dt=Gd(e,re);if(dt){const _e=document.createElement("img");_e.src=dt,_e.alt=`Version ${re+1}`,Ne.appendChild(_e)}const Ie=document.createElement("div");Ie.className="version-nav__thumb-label";const Te=document.createElement("span");Te.className="version-nav__thumb-label-text";const ot=(((Dt=U==null?void 0:U.data)==null?void 0:Dt.id)??(U==null?void 0:U.id)??"").toString().trim();let We=ot||(U!=null&&U.version?`v${U.version}`:`${re+1}`),xt=ot||We;if(U!=null&&U.isCategoryView){const _e=((At=U.data)==null?void 0:At.title)||U.categoryViewKey||We||"Category";We=_e,xt=`Category view: ${_e}`,Ne.dataset.computed="true"}if(Te.textContent=We,Ie.title=xt,Ie.appendChild(Te),Ne.appendChild(Ie),iu(Ie,Te),e.apicurioVersions.length>1&&!(U!=null&&U.isCategoryView)){const _e=document.createElement("span");_e.className="version-nav__thumb-remove",_e.title=`Remove ${We} from this series`,_e.setAttribute("aria-label",`Remove ${We} from this series`),_e.setAttribute("role","button"),_e.tabIndex=-1,_e.textContent="×",_e.addEventListener("click",kt=>{kt.stopPropagation(),kt.preventDefault(),window.confirm(`Remove ${We} from this series?`)&&qd(w,re)}),Ne.appendChild(_e)}Ne.addEventListener("click",()=>qi(w,re)),ru(Ne,U),y.appendChild(Ne)});const T=document.createElement("button");T.type="button",T.className="version-nav__thumb version-nav__thumb--add",T.title="Create a new version from this map",T.addEventListener("click",()=>{try{const U=Os({versionLabel:"manual"});Ct(U)}catch(U){alert((U==null?void 0:U.message)||"Unable to create a new version right now.")}});const P=document.createElement("span");P.className="version-nav__thumb-add-icon",P.textContent="+",T.appendChild(P),y.appendChild(T),n.appendChild(y);const L=qs(e,"active"),B=M.get(L);return typeof B=="number"&&!Number.isNaN(B)&&requestAnimationFrame(()=>{y.scrollLeft=B}),y.addEventListener("scroll",()=>{M.set(L,y.scrollLeft)}),n}function di(){var bl,wl;if(!g)return;const e=w>=0&&E[w]?E[w]:null,t=C&&C.querySelector?C.querySelector(".version-nav__thumbs"):null;if(t&&e){const p=qs(e,w);M.set(p,t.scrollLeft)}Un(),Array.isArray(g.m.categories)||(g.m.categories=[]),console.log("[Blockscape] rendering categories=",g.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!g.m.abstract,"- value:",g.m.abstract?g.m.abstract.substring(0,50)+"...":"none"),C.innerHTML="",he.clear(),Ft.clear(),O=[],zi(E[w],{versionLabel:"1"});const n=Yd(E[w]);n&&C.appendChild(n),F.setAttribute("width",window.innerWidth),F.setAttribute("height",window.innerHeight);const i=(()=>{var je,xe,ht;const p=document.createElement("div");p.className="blockscape-model-meta";const $=document.createElement("div");$.className="blockscape-model-title",$.textContent=g.m.title&&g.m.title.trim()||Je(E[w]),p.appendChild($),((je=E[w])!=null&&je.isSeries||(ht=(xe=E[w])==null?void 0:xe.apicurioVersions)!=null&&ht.length)&&Rt(E[w],{seriesName:E[w].title||g.m.title||Je(E[w])});const V=Gs(E[w]),oe=Nn(E[w]),Ve=(g.m.id??"").toString().trim(),K=document.createElement("div");K.className="blockscape-model-meta__details";const ye=(Ht,ln)=>{if(!ln)return;const go=document.createElement("div");go.className="blockscape-model-id";const wn=document.createElement("span");wn.className="blockscape-model-id__label",wn.textContent=Ht;const Yt=document.createElement("span");Yt.className="blockscape-model-id__value",Yt.textContent=ln,go.append(wn,Yt),K.appendChild(go)};return ye("Series ID",oe),ye("Model ID",Ve),ye("No. in series",V),K.childElementCount&&p.appendChild(K),p})();l.showModelMeta!==!1&&C.appendChild(i.cloneNode(!0));const s=document.createElement("div");s.className="blockscape-tabs";const c=document.createElement("div");c.className="blockscape-tabrow";const u=document.createElement("div");u.className="blockscape-tablist",u.setAttribute("role","tablist"),c.appendChild(u);const h=document.createElement("div");h.className="blockscape-tabactions",c.appendChild(h),s.appendChild(c);const y=document.createElement("div");y.className="blockscape-tabpanels",s.appendChild(y);const T=document.createElement("div"),P=document.createElement("div"),L=document.createElement("div"),B=document.createElement("div"),U=()=>{const p=document.createElement("div");p.className="blockscape-map-legend";const $=document.createElement("div");return $.className="blockscape-legend",$.setAttribute("role","presentation"),$.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,p.appendChild($),p};let re="";const Ne=Jd(E[w]),dt=Vn(E[w]),Ie=((wl=(bl=E[w])==null?void 0:bl.apicurioVersions)==null?void 0:wl[dt])||null,Te=en=!!(Ie!=null&&Ie.isCategoryView||((Ie==null?void 0:Ie.version)||"").startsWith(Vi));Zt=null,Sn="";const ot=(p,$)=>{!p||!$||(p.title=p.title?`${p.title}
${$}`:$)},We=[{id:"map",label:"Map",panel:T},{id:"abstract",label:"Info",panel:P},{id:"source",label:"Settings",panel:L},{id:"apicurio",label:"Apicurio",panel:B}],xt=typeof $e.isEnabled=="function"?$e.isEnabled():!1,Dt=p=>{if(!F)return;const $=p==="map";F.hidden=!$,$?(Yi(),kn()):F.innerHTML=""};We.forEach((p,$)=>{const V=document.createElement("button");V.type="button",V.id=`tab-${p.id}`,V.className="blockscape-tab"+($===0?" is-active":""),V.setAttribute("role","tab"),V.setAttribute("aria-controls",`panel-${p.id}`),V.setAttribute("aria-selected",$===0?"true":"false"),V.textContent=p.label,p.id==="apicurio"&&!xt&&(V.hidden=!0,V.tabIndex=-1,V.setAttribute("aria-hidden","true"),V.style.display="none"),p.button=V,u.appendChild(V),p.panel.id=`panel-${p.id}`,p.panel.classList.add("blockscape-tabpanel"),p.panel.setAttribute("role","tabpanel"),p.panel.setAttribute("aria-labelledby",V.id),p.panel.hidden=$!==0,$===0&&p.panel.classList.add("is-active"),y.appendChild(p.panel)});const At=p=>{Jn=p,We.forEach($=>{const V=$.id===p;$.button.classList.toggle("is-active",V),$.button.setAttribute("aria-selected",V?"true":"false"),$.panel.classList.toggle("is-active",V),$.panel.hidden=!V}),Dt(p)},_e=We.find(p=>p.id==="apicurio"),kt=p=>{if(!_e||!_e.button||!_e.panel)return;const $=!!p;if(_e.button.hidden=!$,_e.button.tabIndex=$?0:-1,_e.button.setAttribute("aria-hidden",$?"false":"true"),_e.button.style.display=$?"":"none",$){const V=Jn==="apicurio";_e.button.classList.toggle("is-active",V),_e.button.setAttribute("aria-selected",V?"true":"false"),_e.panel.classList.toggle("is-active",V),_e.panel.hidden=!V}else{const V=_e.panel.classList.contains("is-active");if(_e.button.classList.remove("is-active"),_e.button.setAttribute("aria-selected","false"),_e.panel.classList.remove("is-active"),_e.panel.hidden=!0,V){const oe=We.find(Ve=>Ve.id!=="apicurio");oe&&At(oe.id)}}N&&(N.checked=$)};We.forEach(p=>{p.button.addEventListener("click",()=>{Un(),At(p.id)}),p.id==="abstract"&&(Zt=p.button,p.button.addEventListener("mouseenter",()=>fi(p.button,re,{offset:12})),p.button.addEventListener("mouseleave",Un),p.button.addEventListener("focus",()=>fi(p.button,re,{offset:12})),p.button.addEventListener("blur",Un))});const Hn=(p=>{const $=We.find(oe=>oe.id===Jn);if($&&($.id!=="apicurio"||p))return $.id;const V=We.find(oe=>oe.id!=="apicurio"||p);return(V==null?void 0:V.id)||We[0].id})(xt);At(Hn),kt(xt),typeof $e.onEnabledChange=="function"&&$e.onEnabledChange(kt),C.appendChild(s),T.appendChild(U());const Tt=document.createElement("div");Tt.className="blockscape-render",T.appendChild(Tt);const Qt=document.createElement("div");if(Qt.className="blockscape-abstract-panel",P.appendChild(i.cloneNode(!0)),g.m.abstract){console.log("[Blockscape] Rendering abstract content");const p=document.createElement("div");p.className="blockscape-abstract",p.innerHTML=g.m.abstract,_u(p),Qt.appendChild(p),re=p.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const p=document.createElement("div");p.className="blockscape-abstract-placeholder",p.textContent="No abstract has been provided for this model.",Qt.appendChild(p),re=p.outerHTML}Sn=re,P.appendChild(Qt);const Gt=document.createElement("div");Gt.className="blockscape-source-panel";const Ue=document.createElement("div");Ue.className="blockscape-settings-panel";const Tn=p=>{Ce.themeToggle&&(Ce.themeToggle.checked=p),Ce.tabThemeToggle&&(Ce.tabThemeToggle.checked=p)},fo=p=>{Tn(p),wa(p?io:yo)},Go=p=>{Ce.tabCenterToggle&&(Ce.tabCenterToggle.checked=p)},rn=p=>{const $=Ao(p);Go($),ps($)},mo=p=>{Ce.secondaryLinksToggle&&(Ce.secondaryLinksToggle.checked=p),Ce.tabSecondaryLinksToggle&&(Ce.tabSecondaryLinksToggle.checked=p)},pn=p=>{const $=!!p;mo($),yn=$,G?Mt(G):(Zi(),kn())},mi=({id:p,label:$,checked:V,onChange:oe})=>{const Ve=document.createElement("label");Ve.className="blockscape-tab-toggle",Ve.setAttribute("for",p);const K=document.createElement("input");K.type="checkbox",K.id=p,K.checked=V,typeof oe=="function"&&K.addEventListener("change",()=>oe(K.checked));const ye=document.createElement("span");return ye.className="blockscape-tab-toggle__label",ye.textContent=$,Ve.append(K,ye),{row:Ve,input:K}},qo=document.createElement("p");qo.className="blockscape-settings-panel__title",qo.textContent="Feature toggles",Ue.appendChild(qo);const Yo=document.createElement("label");Yo.className="settings-toggle";const Gn=document.createElement("input");Gn.type="checkbox",Gn.checked=ii===io;const hi=document.createElement("span");hi.className="settings-toggle__text";const gi=document.createElement("span");gi.className="settings-toggle__label",gi.textContent="Dark mode";const I=document.createElement("span");I.className="settings-toggle__hint",I.textContent="Switch Blockscape UI to dark colors.",hi.append(gi,I),Yo.append(Gn,hi),Gn.addEventListener("change",()=>{fo(Gn.checked)}),Ue.appendChild(Yo),Ce.themeToggle=Gn;const{row:j,input:se}=mi({id:"tabToggleTheme",label:"Dark mode",checked:ii===io,onChange:p=>fo(p)});h.appendChild(j),Ce.tabThemeToggle=se;const{row:le,input:tt}=mi({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:yn,onChange:p=>pn(p)});h.appendChild(le),Ce.tabSecondaryLinksToggle=tt;const{row:Lt,input:we}=mi({id:"tabToggleCenterItems",label:"Center",checked:an,onChange:p=>rn(p)});h.appendChild(Lt),Ce.tabCenterToggle=we;const nt=document.createElement("div");nt.className="settings-actions";const yt=document.createElement("input");yt.type="file",yt.accept="application/json",yt.hidden=!0;const sn=document.createElement("button");sn.type="button",sn.className="pf-v5-c-button pf-m-secondary",sn.textContent="Load settings",sn.addEventListener("click",()=>yt.click()),yt.addEventListener("change",async()=>{var $,V;const p=($=yt.files)==null?void 0:$[0];if(p)try{const oe=await p.text(),Ve=JSON.parse(oe),K=(Ve==null?void 0:Ve.settings)||Ve,je=((V=As(K||{},{refreshObsidianLinks:Qi}).applied)==null?void 0:V.length)||0;Rn(je?`Loaded ${je} setting${je===1?"":"s"} from ${p.name}.`:`No matching settings found in ${p.name}.`,2200)}catch(oe){console.warn("[Blockscape] failed to load settings.json",oe),Rn("Invalid settings file.",2400)}finally{yt.value=""}});const qt=document.createElement("button");qt.type="button",qt.className="pf-v5-c-button pf-m-tertiary",qt.textContent="Download settings",qt.addEventListener("click",()=>{const p={version:1,exportedAt:new Date().toISOString(),settings:Ul(xs(),{localBackend:Ge})};ds("settings.json",JSON.stringify(p,null,2)),Rn("Settings downloaded.",2e3)}),nt.append(sn,qt,yt),Ue.appendChild(nt);const Fn=document.createElement("div");Fn.className="color-presets";const Ha=document.createElement("div");Ha.className="settings-text__label",Ha.textContent="Color presets";const Fa=document.createElement("div");Fa.className="settings-text__hint",Fa.textContent="Shown in tile context menu for quick coloring.",Fn.append(Ha,Fa);const bi=document.createElement("div");bi.className="color-presets__list";const Wa=document.createElement("div");Wa.className="color-presets__add";const Xo=document.createElement("input");Xo.type="text",Xo.placeholder="Name",Xo.className="settings-text__input";const wi=document.createElement("input");wi.type="color",wi.value="#2563eb",wi.className="settings-color-input";const vi=document.createElement("button");vi.type="button",vi.className="pf-v5-c-button pf-m-primary",vi.textContent="Add preset",vi.addEventListener("click",()=>{const p=Xo.value.trim()||"Custom",$=wi.value,V=[...zt,{name:p,value:$}];Lo(V),Wo(zt),Xo.value=""}),Wa.append(Xo,wi,vi),Fn.append(bi,Wa),Ue.appendChild(Fn),Ce.colorPresetList=bi,xo=()=>{bi.innerHTML="",zt.forEach((p,$)=>{const V=document.createElement("div");V.className="color-presets__row";const oe=document.createElement("input");oe.type="text",oe.className="settings-text__input",oe.value=p.name||"",oe.placeholder="Name",oe.addEventListener("input",()=>{const ye=[...zt];ye[$]={...ye[$],name:oe.value},Lo(ye),Wo(zt)});const Ve=document.createElement("input");Ve.type="color",Ve.className="settings-color-input",Ve.value=p.value,Ve.addEventListener("input",()=>{const ye=[...zt];ye[$]={...ye[$],value:Ve.value},Lo(ye),Wo(zt)});const K=document.createElement("button");K.type="button",K.className="pf-v5-c-button pf-m-plain",K.textContent="✕",K.title="Remove preset",K.addEventListener("click",()=>{const ye=zt.filter((je,xe)=>xe!==$);Lo(ye),Wo(zt),xo()}),V.append(oe,Ve,K),bi.appendChild(V)})},xo();const ja=document.createElement("div");ja.className="settings-text";const za=document.createElement("div");za.className="settings-text__label",za.textContent="Link colors";const Ja=document.createElement("div");Ja.className="settings-text__hint",Ja.textContent="Adjust the colors used when highlighting enables/dependents.";const Ka=document.createElement("div");Ka.className="settings-color-rows";const cl=({id:p,label:$,hint:V,value:oe,onChange:Ve})=>{const K=document.createElement("label");K.className="settings-color-row",K.setAttribute("for",p);const ye=document.createElement("span");if(ye.className="settings-color-row__label",ye.textContent=$,V){const xe=document.createElement("span");xe.className="settings-color-row__hint",xe.textContent=V,ye.appendChild(xe)}const je=document.createElement("input");if(je.type="color",je.id=p,je.className="settings-color-input",je.value=oe,typeof Ve=="function"){const xe=()=>Ve(je.value);je.addEventListener("input",xe),je.addEventListener("change",xe)}return K.append(ye,je),Ka.appendChild(K),je};Ce.depColorInput=cl({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:Ui,onChange:p=>{const $=Sa(p);ya($)}}),Ce.revdepColorInput=cl({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:Hi,onChange:p=>{const $=ka(p);Ea($)}}),ja.append(za,Ja,Ka),Ue.appendChild(ja);const Ga=document.createElement("div");Ga.className="settings-text";const qa=document.createElement("div");qa.className="settings-text__text";const Ya=document.createElement("div");Ya.className="settings-text__label",Ya.textContent="Link thickness";const Xa=document.createElement("div");Xa.className="settings-text__hint",Xa.textContent="Adjust stroke width for enables/dependents lines.",qa.append(Ya,Xa);const ho=document.createElement("select");ho.id="linkThickness",ho.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:p,label:$})=>{const V=document.createElement("option");V.value=p,V.textContent=$,p===ai&&(V.selected=!0),ho.appendChild(V)}),ho.addEventListener("change",()=>{const p=si(ho.value);Ia(p)});const Za=document.createElement("div");Za.className="settings-text__row",Za.append(qa,ho),Ga.appendChild(Za),Ue.appendChild(Ga),Ce.linkThicknessInput=ho;const qn=({id:p,label:$,hint:V,checked:oe,className:Ve="",onChange:K})=>{const ye=document.createElement("label");ye.className=["settings-toggle",Ve].filter(Boolean).join(" ");const je=document.createElement("input");je.type="checkbox",je.id=p,je.checked=oe;const xe=document.createElement("span");xe.className="settings-toggle__text";const ht=document.createElement("span");if(ht.className="settings-toggle__label",ht.textContent=$,xe.appendChild(ht),V){const Ht=document.createElement("span");Ht.className="settings-toggle__hint",Ht.textContent=V,xe.appendChild(Ht)}return ye.appendChild(je),ye.appendChild(xe),typeof K=="function"&&je.addEventListener("change",()=>K(je.checked)),{row:ye,input:je}},Qi=()=>{C.querySelectorAll(".tile").forEach(p=>{const $=p.dataset.id,V=La($);if(!(V!=null&&V.item))return;const oe=el(V.item.external),Ve=Qs(V.item,{externalMeta:oe,seriesIdLookup:Ne});tl(p,Ve)})},{row:Tu,input:Lu}=qn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:yn,className:"map-controls__toggle",onChange:p=>pn(p)});Ue.appendChild(Tu),Ce.secondaryLinksToggle=Lu;const{row:Nu,input:Mu}=qn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:tn,className:"map-controls__toggle",onChange:p=>{tn=p,Da()}});Ue.appendChild(Nu),Ce.reusedToggle=Mu;const{row:Bu,input:$u}=qn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:ao,className:"map-controls__toggle",onChange:p=>{const $=Vo(p);Ss($)}});Ue.appendChild(Bu),Ce.autoIdToggle=$u;const Qa=[],{row:Ru,input:Ou}=qn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:_o,className:"map-controls__toggle",onChange:p=>{const $=Ho(p);Ns($),Qa.forEach(V=>{V.disabled=!$}),Qi()}});if(Ue.appendChild(Ru),Ce.obsidianToggle=Ou,typeof(Ge==null?void 0:Ge.isAvailable)=="function"&&Ge.isAvailable()&&typeof(Ge==null?void 0:Ge.getAutoReloadConfig)=="function"){const{enabled:p,intervalMs:$}=Ge.getAutoReloadConfig();let V=null;const{row:oe,input:Ve}=qn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:p,className:"map-controls__toggle",onChange:ln=>{Ge.setAutoReloadEnabled(ln),V&&(V.disabled=!ln)}});Ue.appendChild(oe),Ce.autoReloadToggle=Ve;const K=ln=>`${(ln/1e3).toFixed(2)}s`,ye=document.createElement("label");ye.className="settings-slider",ye.setAttribute("for","autoReloadInterval");const je=document.createElement("div");je.className="settings-slider__text";const xe=document.createElement("span");xe.className="settings-slider__label",xe.textContent="Auto-reload interval";const ht=document.createElement("span");ht.className="settings-slider__hint",ht.textContent="Adjust how often to poll for file changes.",je.append(xe,ht);const Ht=document.createElement("span");Ht.className="settings-slider__value",Ht.textContent=K($),V=document.createElement("input"),V.type="range",V.id="autoReloadInterval",V.className="settings-slider__input",V.min=String(Yr),V.max=String(Xr),V.step="100",V.value=String($),V.disabled=!p,V.setAttribute("aria-label","Set auto-reload polling interval"),V.addEventListener("input",()=>{const ln=Ge.setAutoReloadInterval(parseInt(V.value,10));Ht.textContent=K(ln)}),ye.append(je,Ht,V),Ue.appendChild(ye),Ce.autoReloadInput=V,Ce.autoReloadValue=Ht}const er=document.createElement("div");er.className="settings-radio";const tr=document.createElement("div");tr.className="settings-radio__label",tr.textContent="Obsidian link format";const nr=document.createElement("div");nr.className="settings-radio__hint",nr.textContent="Use the tile title or id when building Obsidian links.";const or=document.createElement("div");or.className="settings-radio__options";const dl=(p,$)=>{const V=document.createElement("label");V.className="settings-radio__option";const oe=document.createElement("input");oe.type="radio",oe.name="obsidianLinkMode",oe.value=p,oe.checked=oi===p,oe.disabled=!_o,oe.addEventListener("change",()=>{if(!oe.checked)return;const K=Uo(p);Ls(K),Qi()});const Ve=document.createElement("span");Ve.textContent=$,V.append(oe,Ve),Qa.push(oe),or.appendChild(V)};dl(ga,"Use title"),dl(Ri,"Use id"),er.append(tr,or,nr),Ue.appendChild(er),Ce.obsidianModeInputs=Qa;const ea=document.createElement("label");ea.className="settings-text",ea.setAttribute("for","obsidianVaultInput");const ir=document.createElement("div");ir.className="settings-text__text";const ar=document.createElement("span");ar.className="settings-text__label",ar.textContent="Obsidian vault";const rr=document.createElement("span");rr.className="settings-text__hint",rr.textContent="Optional. Set the vault name to avoid duplicates.",ir.append(ar,rr);const Wn=document.createElement("input");Wn.type="text",Wn.id="obsidianVaultInput",Wn.className="settings-text__input",Wn.placeholder="Vault name",Wn.value=Co,Wn.addEventListener("input",()=>{const p=Fo(Wn.value);Ms(p),Qi()}),ea.append(ir,Wn),Ue.appendChild(ea),Ce.obsidianVaultInput=Wn;const sr=document.createElement("p");sr.className="settings-note",sr.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',Ue.appendChild(sr);const ul=p=>`${(p/1e3).toFixed(1)}s`,ta=document.createElement("label");ta.className="settings-slider",ta.setAttribute("for","seriesNavDoubleClickWait");const lr=document.createElement("div");lr.className="settings-slider__text";const cr=document.createElement("span");cr.className="settings-slider__label",cr.textContent="Series double-click wait";const dr=document.createElement("span");dr.className="settings-slider__hint",dr.textContent="Time window to double-click into another map version.",lr.append(cr,dr);const yi=document.createElement("span");yi.className="settings-slider__value",yi.textContent=ul($n);const fn=document.createElement("input");fn.type="range",fn.id="seriesNavDoubleClickWait",fn.className="settings-slider__input",fn.min=String(ss),fn.max=String(ls),fn.step="50",fn.value=String($n),fn.setAttribute("aria-label","Adjust double-click wait for series navigation"),fn.addEventListener("input",()=>{const p=Do(parseInt(fn.value,10));yi.textContent=ul(p),Ts(p)}),ta.append(lr,yi,fn),Ue.appendChild(ta),Ce.seriesNavInput=fn,Ce.seriesNavValue=yi;const pl=p=>`${Math.round((p-1)*100)}%`,na=document.createElement("label");na.className="settings-slider",na.setAttribute("for","hoverScaleSlider");const ur=document.createElement("div");ur.className="settings-slider__text";const pr=document.createElement("span");pr.className="settings-slider__label",pr.textContent="Hover zoom";const fr=document.createElement("span");fr.className="settings-slider__hint",fr.textContent="Expand tiles on hover to see more detail.",ur.append(pr,fr);const Ei=document.createElement("span");Ei.className="settings-slider__value",Ei.textContent=pl(Eo);const mn=document.createElement("input");mn.type="range",mn.id="hoverScaleSlider",mn.className="settings-slider__input",mn.min=String(ze),mn.max=String(et),mn.step="0.1",mn.value=String(Eo),mn.setAttribute("aria-label","Adjust hover zoom"),mn.addEventListener("input",()=>{const p=No(parseFloat(mn.value));Ei.textContent=pl(p),vs(p),G&&zo()}),na.append(ur,Ei,mn),Ue.appendChild(na),Ce.hoverScaleInput=mn,Ce.hoverScaleValue=Ei;let Ut=null,Yn=null;const mr=p=>{const $=Math.round((1-p)*100);return $===0?"Off":`${$}% dim`},{row:Pu,input:Vu}=qn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Bn,className:"map-controls__toggle",onChange:p=>{const $=Po(p);Es($),Ut&&(Ut.disabled=!$),Yn&&(Yn.textContent=mr($?Mn:1))}});Ue.appendChild(Pu),Ce.selectionDimToggle=Vu;const oa=document.createElement("label");oa.className="settings-slider",oa.setAttribute("for","selectionDimmingSlider");const hr=document.createElement("div");hr.className="settings-slider__text";const gr=document.createElement("span");gr.className="settings-slider__label",gr.textContent="Dimming strength";const br=document.createElement("span");br.className="settings-slider__hint",br.textContent="Adjust how much unrelated tiles fade when dimming is on.",hr.append(gr,br),Yn=document.createElement("span"),Yn.className="settings-slider__value",Yn.textContent=mr(Bn?Mn:1),Ut=document.createElement("input"),Ut.type="range",Ut.id="selectionDimmingSlider",Ut.className="settings-slider__input",Ut.min=String(vt),Ut.max=String(De),Ut.step="0.05",Ut.value=String(Mn),Ut.disabled=!Bn,Ut.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Ut.addEventListener("input",()=>{const p=Mo(parseFloat(Ut.value));Yn.textContent=mr(p),ys(p)}),oa.append(hr,Yn,Ut),Ue.appendChild(oa),Ce.selectionDimInput=Ut,Ce.selectionDimValue=Yn;const fl=p=>p===1?"Default":`${Math.round(p*100)}%`,ia=document.createElement("label");ia.className="settings-slider",ia.setAttribute("for","tileCompactnessSlider");const wr=document.createElement("div");wr.className="settings-slider__text";const vr=document.createElement("span");vr.className="settings-slider__label",vr.textContent="Tile compactness";const yr=document.createElement("span");yr.className="settings-slider__hint",yr.textContent="Adjust padding, gap, and logo size for tiles.",wr.append(vr,yr);const Si=document.createElement("span");Si.className="settings-slider__value",Si.textContent=fl(So);const hn=document.createElement("input");hn.type="range",hn.id="tileCompactnessSlider",hn.className="settings-slider__input",hn.min=String(Wr),hn.max=String(jr),hn.step="0.05",hn.value=String(So),hn.setAttribute("aria-label","Adjust tile compactness"),hn.addEventListener("input",()=>{const p=Bo(parseFloat(hn.value));Si.textContent=fl(p),ks(p),G&&zo()}),ia.append(wr,Si,hn),Ue.appendChild(ia),Ce.tileCompactnessInput=hn,Ce.tileCompactnessValue=Si;const{row:Du,input:Uu}=qn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:ba!=="nowrap",className:"map-controls__toggle",onChange:p=>{const $=p?"wrap":"nowrap";Oo($),Cs($)}});Ue.appendChild(Du),Ce.titleWrapInput=Uu;const ml=p=>`${Math.round((p-1)*100)}% extra`,aa=document.createElement("label");aa.className="settings-slider",aa.setAttribute("for","titleHoverWidthSlider");const Er=document.createElement("div");Er.className="settings-slider__text";const Sr=document.createElement("span");Sr.className="settings-slider__label",Sr.textContent="Title width on hover";const kr=document.createElement("span");kr.className="settings-slider__hint",kr.textContent="Give titles more room horizontally when zoomed.",Er.append(Sr,kr);const ki=document.createElement("span");ki.className="settings-slider__value",ki.textContent=ml(ko);const gn=document.createElement("input");gn.type="range",gn.id="titleHoverWidthSlider",gn.className="settings-slider__input",gn.min=String(_n),gn.max=String(un),gn.step="0.05",gn.value=String(ko),gn.setAttribute("aria-label","Adjust title width boost on hover"),gn.addEventListener("input",()=>{const p=$o(parseFloat(gn.value));ki.textContent=ml(p),Is(p)}),aa.append(Er,ki,gn),Ue.appendChild(aa),Ce.titleWidthInput=gn,Ce.titleWidthValue=ki;const hl=p=>`${Math.round(p*100)}% of hover zoom`,ra=document.createElement("label");ra.className="settings-slider",ra.setAttribute("for","titleZoomPortionSlider");const Ir=document.createElement("div");Ir.className="settings-slider__text";const _r=document.createElement("span");_r.className="settings-slider__label",_r.textContent="Title zoom influence";const Cr=document.createElement("span");Cr.className="settings-slider__hint",Cr.textContent="How much the title scales relative to tile hover zoom.",Ir.append(_r,Cr);const Ii=document.createElement("span");Ii.className="settings-slider__value",Ii.textContent=hl(Io);const bn=document.createElement("input");bn.type="range",bn.id="titleZoomPortionSlider",bn.className="settings-slider__input",bn.min=String(oo),bn.max=String(ha),bn.step="0.05",bn.value=String(Io),bn.setAttribute("aria-label","Adjust how much titles scale on hover"),bn.addEventListener("input",()=>{const p=Ro(parseFloat(bn.value));Ii.textContent=hl(p),_s(p)}),ra.append(Ir,Ii,bn),Ue.appendChild(ra),Ce.titleZoomInput=bn,Ce.titleZoomValue=Ii;const Hu=typeof $e.isEnabled=="function"?$e.isEnabled():!1,{row:Fu,input:Wu}=qn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:Hu,className:"apicurio-toggle",onChange:p=>{typeof $e.setEnabled=="function"&&$e.setEnabled(p)}});if(N=Wu,Ue.appendChild(Fu),Gt.appendChild(Ue),A)A.hidden=!1,A.classList.remove("pf-v5-c-page__main-section"),Gt.appendChild(A);else{const p=document.createElement("p");p.className="muted",p.textContent="Source editor unavailable.",Gt.appendChild(p)}L.appendChild(Gt),$e.mount(B);let gl=0;if(g.m.categories.forEach(p=>{const $=document.createElement("section");$.className="category",$.dataset.cat=p.id;const V=Te?Kd(p,Ne):null,oe=document.createElement("div");oe.className="cat-head",oe.dataset.cat=p.id,oe.tabIndex=0,Te&&Number.isInteger(V)?(oe.dataset.seriesVersionIndex=String(V),oe.title="Open this category's map in the series",oe.classList.add("cat-head--series-link")):oe.title="Select category",oe.innerHTML=`<div class="cat-title">${pi(p.title||p.id)}</div>
                          <div class="muted cat-count">${(p.items||[]).length} items</div>`,oe.addEventListener("click",()=>{var ht;const K=oe.dataset.seriesVersionIndex!=null?parseInt(oe.dataset.seriesVersionIndex,10):null,ye=E[w],je=ye?Vn(ye):-1;Te&&((ht=ye==null?void 0:ye.apicurioVersions)==null?void 0:ht.length)>1&&Number.isInteger(K)&&K!==je&&qi(w,K)||Dn(p.id)}),oe.addEventListener("keydown",K=>{(K.key==="Enter"||K.key===" ")&&(K.preventDefault(),oe.click())}),oe.addEventListener("focus",()=>Dn(p.id,{scrollIntoView:!1})),$.appendChild(oe);const Ve=document.createElement("div");if(Ve.className="grid"+(an?" is-centered":""),$.appendChild(Ve),(p.items||[]).forEach(K=>{gl+=1;const ye=el(K.external),je=Qs(K,{externalMeta:ye,seriesIdLookup:Ne}),xe=document.createElement("div");if(xe.className=ye.isExternal?"tile external":"tile",xe.tabIndex=0,xe.dataset.id=K.id,xe.dataset.globalIndex=String(gl),ye.url&&(xe.dataset.externalUrl=ye.url),!Te){let Yt=null;if(Ne.has(K.id)&&(Yt=Ne.get(K.id)),Number.isInteger(Yt)){xe.dataset.seriesVersionIndex=String(Yt),xe.classList.add("tile--series-link");const ju=Yt===dt?"Current map in this series":`Open version ${Yt+1} in this series`;ot(xe,ju)}}if(je&&(xe.dataset.obsidianUrl=je),!Te){const Yt=Ta(K.id);Yt!==-1&&Yt!==w&&(xe.classList.add("tile--series-link"),xe.dataset.navTargetIndex=String(Yt))}const ht=document.createElement("img");ht.className="logo",K.logo?(ht.src=K.logo,ht.alt=K.name||K.id):(ht.alt="",ht.style.opacity=1,ht.src=zd(K.name||K.id,K.color));const Ht=document.createElement("div");Ht.className="name",Ht.textContent=K.name||K.id;const ln=document.createElement("div");ln.className="tile-id",ln.textContent=K.id||"";const go=document.createElement("div");go.className="badge",go.textContent="reused";let wn=null;Te||(wn=document.createElement("button"),wn.type="button",wn.className="tile-delete",wn.setAttribute("aria-label",`Delete ${K.name||K.id}`),wn.textContent="×",wn.addEventListener("click",Yt=>{Yt.stopPropagation(),Su(K.id)})),ye.url&&xe.appendChild(ou(ye.url)),tl(xe,je),wn&&xe.appendChild(wn),xe.appendChild(ht),xe.appendChild(Ht),xe.appendChild(ln),xe.appendChild(go),Ve.appendChild(xe),he.set(K.id,{el:xe,catId:p.id,rect:null})}),Tt.appendChild($),Ft.set(p.id,{el:$,headEl:oe}),!Te){const K=document.createElement("button");K.type="button",K.className="tile-add",K.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',K.hidden=an,K.tabIndex=an?-1:0,K.setAttribute("aria-hidden",an?"true":"false"),K.addEventListener("click",()=>du(p.id)),Ve.appendChild(K)}}),!Te){const p=document.createElement("button");p.type="button",p.className="category-add",p.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',p.addEventListener("click",()=>ol()),Tt.appendChild(p)}Da(),Xd(),Yi(),kn(),Jo(),su()}function Xd(){C.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var L;if(typeof n.button=="number"&&n.button!==0)return;uo();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,c=E[w],u=c?Vn(c):-1,h=((L=c==null?void 0:c.apicurioVersions)==null?void 0:L.length)>1&&Number.isInteger(i)&&i!==u,y=Number.isInteger(s)&&s!==w&&s>=0&&s<E.length,T=Ot&&Ot.id===o&&Ot.targetVersionIndex===i,P=nn&&nn.id===o&&nn.targetIndex===s;if(Ot&&!T&&jo(),nn&&!P&&$a(),h)if(T){if(jo(),qi(w,i))return}else xd(o,i,c);else if(y){if(P){$a(),Ct(s);return}Ad(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&Rn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),G===o&&!(h&&T)&&!(y&&P)){Ko();return}Mt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):Ta(o);i!==-1&&i!==w&&Ct(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{G&&zo()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),Ds||(Ds=!0,window.addEventListener("resize",zo),window.addEventListener("scroll",zo,{passive:!0}),window.addEventListener("resize",nl),document.addEventListener("click",e=>{var a,s,c;if(!G&&!Ke||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),o=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),i=(c=t==null?void 0:t.closest)==null?void 0:c.call(t,".tile-context-menu");n||o||i||Ko()})),document.getElementById("clear").onclick=()=>Ko()}function Yi(){he.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function Xs(e,{includeSecondary:t=yn}={}){if(!e||!g)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(g.fwd.get(e)||[]),o=new Set(g.rev.get(e)||[]),i=new Set,a=new Set,s=[],c=new Set,u=(h,y,T,P)=>{if(!h||!y)return;const L=`${h}->${y}:${T}:${P}`;c.has(L)||(c.add(L),s.push({from:h,to:y,type:T,depth:P}))};return n.forEach(h=>u(e,h,"dep",1)),o.forEach(h=>u(e,h,"revdep",1)),t&&new Set([...n,...o]).forEach(y=>{(g.fwd.get(y)||new Set).forEach(L=>{const B=L===e;B||i.add(L),B||u(y,L,"dep",2)}),(g.rev.get(y)||new Set).forEach(L=>{const B=L===e;B||a.add(L),B||u(y,L,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function Xi(e,t){const n=he.get(e);n&&n.el.classList.add(t)}function Mt(e){var c,u,h;if(!e)return;Ke=null,G=e,at=null,it=Xs(e),Kt(),Zi(),Jo();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=it;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=he.get(e);a&&a.el.classList.add("selected"),t.forEach(y=>Xi(y,"dep")),n.forEach(y=>Xi(y,"revdep")),o.forEach(y=>{!t.has(y)&&y!==e&&Xi(y,"dep-indirect")}),i.forEach(y=>{!n.has(y)&&!t.has(y)&&y!==e&&Xi(y,"revdep-indirect")}),kn();const s=(h=(u=(c=he.get(e))==null?void 0:c.el)==null?void 0:u.dataset)==null?void 0:h.externalUrl;s&&Rn("This item has link to",Kn,s),_a()}function Dn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,c;if(!((s=g==null?void 0:g.m)!=null&&s.categories)||!e)return!1;const i=(g.m.categories||[]).find(u=>u.id===e);if(!i)return!1;uo(),Va(),n||(at=null),Ke=i.id,Kt(),Jo();const a=Ft.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(c=a.headEl)==null||c.focus({preventScroll:!0})),!0}function Jo(){if(Ft.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!Ke)return;const e=Ft.get(Ke);if(!(e!=null&&e.el)){Ke=null,at=null,Kt();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function ui(){if(Ke)return Ke;const e=G?he.get(G):null;return e!=null&&e.catId?e.catId:null}function Zd(e){var a,s,c,u;if(!((s=(a=g==null?void 0:g.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=g.m.categories,n=ui();let o=t.findIndex(h=>h.id===n);if(o===-1){const h=((c=t.find(y=>(y.items||[]).length))==null?void 0:c.id)||((u=t[0])==null?void 0:u.id);return h?Dn(h):!1}const i=o+e;return i<0||i>=t.length?!1:Dn(t[i].id)}function Va(){G=null,it=null,Zi(),kn(),_a({itemId:null})}function Qd(){Ke=null,at=null,Jo()}function Ko(){Va(),Qd(),at=null,Kt()}function Zi(){C.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function Da(){g!=null&&g.reusedLocal&&g.reusedLocal.forEach(e=>{const t=he.get(e);if(!t)return;t.el.classList.toggle("reused",tn);const n=t.el.querySelector(".badge");n&&(n.style.display=tn?"inline-block":"none")})}function kn(){for(;F.firstChild;)F.removeChild(F.firstChild);if(!G||F.hidden)return;it=Xs(G);const e=it,{primary:t,secondary:n}=yc();e.edges.forEach(o=>{var L,B;const i=(L=he.get(o.from))==null?void 0:L.rect,a=(B=he.get(o.to))==null?void 0:B.rect;if(!i||!a)return;const s=Zs(i),c=Zs(a),u=document.createElementNS("http://www.w3.org/2000/svg","path"),h=(s.x+c.x)/2,y=s.y,T=(s.x+c.x)/2,P=c.y;u.setAttribute("d",`M ${s.x},${s.y} C ${h},${y} ${T},${P} ${c.x},${c.y}`),u.setAttribute("fill","none"),u.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),u.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),u.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&u.setAttribute("stroke-dasharray","4 3"),u.setAttribute("vector-effect","non-scaling-stroke"),F.appendChild(u)})}function Zs(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function pi(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function eu(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),Co&&o.set("vault",Co),`obsidian://advanced-uri?${o.toString()}`}function tu(e){return e?oi===Ri?e.id??e.name??"":e.name??e.id??"":""}function Qs(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!_o||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=tu(e);return eu(o)}function el(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function nu(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function ou(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function tl(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(nu(t))}function nl(){X||(X=requestAnimationFrame(()=>{X=null,O=O.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),O.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function iu(e,t){!e||!t||(O.push({labelEl:e,textEl:t}),nl())}function au(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${pi(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${pi(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function fi(e,t,{offset:n=8}={}){!Q||!e||!t||(Q.innerHTML=t,Q.hidden=!1,Q.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=Q.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let c=o.left+o.width/2-i.width/2+a,u=o.top-i.height-n+s;c<a+n&&(c=a+n);const h=a+window.innerWidth-i.width-n;c>h&&(c=h),u<s+n&&(u=o.bottom+n+s),Q.style.left=`${c}px`,Q.style.top=`${u}px`,Q.classList.add("is-visible")}))}function Un(){on&&(clearTimeout(on),on=null),Q&&(Q.classList.remove("is-visible"),Q.setAttribute("aria-hidden","true"),Q.hidden=!0)}function ru(e,t){if(!e)return;const n=Je((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=au(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{S=e,fi(e,`<div class="version-nav__tooltip-title">${pi(n)}</div>`,{offset:10})},c=()=>{a(),i=setTimeout(()=>{S===e&&fi(e,o,{offset:10})},Ee)},u=()=>{s(),c()},h=()=>{S!==e&&s(),c()},y=()=>{a(),S===e&&(S=null,Un())};e.addEventListener("mouseenter",u),e.addEventListener("focus",u),e.addEventListener("pointermove",h),e.addEventListener("mouseleave",y),e.addEventListener("blur",y),e.addEventListener("click",y)}function su(){d&&(d=!1,!(!Zt||!Sn)&&(Un(),fi(Zt,Sn,{offset:12}),on=setTimeout(()=>{Un(),lu()},1e3)))}function lu(){Zt&&(v&&(clearTimeout(v),v=null),Zt.classList.add("blockscape-tab--twinkle"),v=setTimeout(()=>{Zt.classList.remove("blockscape-tab--twinkle"),v=null},1400))}window.addEventListener("scroll",Un,!0),window.addEventListener("resize",Un),Pe&&Pe.addEventListener("click",()=>{Nd()}),de&&de.addEventListener("click",()=>{Md()}),rt&&rt.addEventListener("click",()=>{try{_d(),yd()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),Me&&Me.addEventListener("click",Ra),D&&D.addEventListener("click",Ra),k&&k.addEventListener("click",Ki),ee&&ee.addEventListener("click",Ki),C&&C.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");en||!t||!C.contains(t)||md(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||hd(e)}),qe&&qe.addEventListener("click",()=>{Ps("button")}),J&&J.addEventListener("click",()=>{if(w<0){alert("Load or select a model before creating a version.");return}try{const e=Os({versionLabel:"map edit"});Ct(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),He&&He.addEventListener("click",async()=>{var a;if(w<0||!E[w]){alert("Select or load a model before sharing.");return}const e={title:Je(E[w],"Shared Model"),data:E[w].data};let t;try{t=dc(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),Y&&Y.addEventListener("click",()=>{const e=(f.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};G&&(n.selectedItemId=G),localStorage.setItem(lt,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";G&&(t=`editor.html?selected=${encodeURIComponent(G)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==lt||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||Ks("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===ft&&Ks("message")})),document.addEventListener("keydown",e=>{var o,i,a,s,c,u,h,y,T,P;if(Ld()){e.key==="Escape"&&(e.preventDefault(),Ra());return}if(!(Z!=null&&Z.hidden)&&e.key==="Escape"){e.preventDefault(),Ki();return}if((o=co==null?void 0:co.isOpen)==null?void 0:o.call(co))return;const n=en;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const L=E[w],B=((i=L==null?void 0:L.apicurioVersions)==null?void 0:i.length)>1;Ps("shortcut",B);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!po())return;if(wu()){e.preventDefault();return}}if(e.key==="Escape"){let L=!1;te&&!te.hidden&&(uo(),L=!0),(G||Ke)&&(Ko(),L=!0),L&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!po())return;const L=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if((e.ctrlKey||e.metaKey)&&!e.shiftKey){Pa(L)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(Ke&&!e.shiftKey){e.preventDefault();return}e.shiftKey?pu(L)&&e.preventDefault():fu(L)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!po())return;const L=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){bu(L)&&e.preventDefault();return}if(e.altKey)return;if(Ke&&!G&&!e.shiftKey){if(hu(L)){e.preventDefault();return}if(Zd(L)){e.preventDefault();return}}e.shiftKey?gu(L)&&e.preventDefault():mu(L)&&e.preventDefault()}if(e.key==="Delete"){if(n||!po()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const L=Ke?Eu():!1,B=L?!0:il();(L||B)&&e.preventDefault()}if(e.key==="F2"){if(n||!po())return;const L=Ke&&!G&&Ke||!G&&((u=(c=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:c.dataset)==null?void 0:u.cat)||null;if(L&&!G&&uu(L)){e.preventDefault();return}const B=G||((P=(T=(y=(h=e.target)==null?void 0:h.closest)==null?void 0:y.call(h,".tile"))==null?void 0:T.dataset)==null?void 0:P.id);B&&co.open(B)&&e.preventDefault()}if(e.key==="Insert"){if(n||!po()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;ol()&&e.preventDefault()}}),window.addEventListener("resize",()=>{gd()}),window.addEventListener("scroll",()=>bd(),!0);function cu(e,t,n){if(w<0)return;const i=E[w].data.categories||[],a=i.find(y=>(y.items||[]).some(T=>T.id===e)),s=i.find(y=>y.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const c=a.items.findIndex(y=>y.id===e);if(c===-1)return;const[u]=a.items.splice(c,1);let h=s.items.length;if(t){const y=s.items.findIndex(T=>T.id===t);y!==-1&&(h=y)}s.items.splice(h,0,u),Vt(),Bt()}function du(e){if(w<0||!e)return;const t=E[w].data,o=(t.categories||[]).find(u=>u.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:dd(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),Vt(),Bt(),uo(),Mt(s.id);const c=he.get(s.id);c!=null&&c.el&&c.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function ol(){if(w<0)return!1;const e=E[w].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=ud(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),Ke=n,G=null,it=null,at=null,Vt(),Bt(),Dn(n),console.log("[Blockscape] added category",n),!0}function uu(e=ui()){if(w<0||!e)return!1;const t=fd.open(e);return t&&(G=null,it=null,Kt()),t}function pu(e){if(!G||w<0||!e)return!1;const n=E[w].data.categories||[],o=he.get(G);let i=null;if(o!=null&&o.catId&&(i=n.find(u=>u.id===o.catId)),i||(i=n.find(u=>(u.items||[]).some(h=>h.id===G))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(u=>u.id===G);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[c]=i.items.splice(a,1);return i.items.splice(s,0,c),Vt(),Bt(),di(),Mt(G),!0}function fu(e){if(!g||!g.m||!e)return!1;const t=g.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(h=>(h.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!G){const u=n();return u?(Mt(u.item.id),!0):!1}const o=he.get(G);let i=null;if(o!=null&&o.catId&&(i=t.find(u=>u.id===o.catId)),i||(i=t.find(u=>(u.items||[]).some(h=>h.id===G))),!i){const u=n();return u?(Mt(u.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(u=>u.id===G);if(s===-1)return!1;const c=s+e;return c<0||c>=a.length?!1:(Mt(a[c].id),!0)}function mu(e){if(!g||!g.m||!e)return!1;const t=g.m.categories||[];if(!t.length)return!1;const n=ui();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(G){const c=(t[o].items||[]).findIndex(u=>u.id===G);at={catId:a.id,position:c===-1?0:c}}else at=null;return Dn(a.id,{preserveEntryHint:!0})}function hu(e){var a;if(!Ke||!((a=g==null?void 0:g.m)!=null&&a.categories)||!e)return!1;const n=(g.m.categories||[]).find(s=>s.id===Ke);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(at==null?void 0:at.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,at.position||0))),at=null,Mt(o[i].id),!0}function gu(e){if(!G||w<0||!e)return!1;const n=E[w].data.categories||[];if(!n.length)return!1;const o=he.get(G);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(T=>T.id===o.catId)),i===-1&&(i=n.findIndex(T=>(T.items||[]).some(P=>P.id===G))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],c=n[a];if(!c)return!1;s.items=s.items||[],c.items=c.items||[];const u=s.items.findIndex(T=>T.id===G);if(u===-1)return!1;const h=Math.min(c.items.length,Math.max(0,u)),y=h<c.items.length?c.items[h].id:null;return cu(G,y,c.id),di(),Mt(G),!0}function bu(e){if(w<0||!e)return!1;const n=E[w].data.categories||[];if(!n.length)return!1;const o=ui();if(!o)return!1;const i=n.findIndex(c=>c.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),Ke=s.id,Va(),at=null,Kt(),Vt(),Bt(),Jo(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function wu(){if(w<0)return!1;const e=E[w],t=mt(e)||(e?e.id:null),n=[];if(Et&&t===Et.modelId&&n.push({...Et,type:"item"}),Wt&&t===Wt.modelId&&n.push({...Wt,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(yu(o))return!0}else if(o.type==="item"&&vu(o))return!0;return!1}function vu(e){const t=E[w],n=mt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(c=>c.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),Et=null,uo(),G=null,it=null,Kt(),Vt(),Bt(),di(),Mt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function yu(e){const t=E[w],n=mt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),Wt=null,G=null,it=null,Ke=e.category.id,at=null,Kt(),Vt(),Bt(),Jo(),Dn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function il(){if(!G||w<0)return!1;const t=E[w].data.categories||[];if(!t.length)return!1;const n=he.get(G);let o=null;if(n!=null&&n.catId&&(o=t.find(h=>h.id===n.catId)),o||(o=t.find(h=>(h.items||[]).some(y=>y.id===G))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(h=>h.id===G);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=E[w];Et={item:a,categoryId:o.id,index:i,modelId:mt(s)||(s?s.id:null),ts:Date.now()};const u=(()=>{var y;if(o.items.length){const T=Math.min(i,o.items.length-1);return((y=o.items[T])==null?void 0:y.id)||null}const h=t.findIndex(T=>T.id===o.id);if(h===-1)return null;for(let T=h+1;T<t.length;T++){const P=t[T].items||[];if(P.length)return P[0].id}for(let T=h-1;T>=0;T--){const P=t[T].items||[];if(P.length)return P[0].id}return null})();return uo(),G=null,it=null,at=null,Kt(),Vt(),Bt(),di(),u?Mt(u):Ko(),console.log("[Blockscape] removed item",a.id),!0}function Eu(){var c,u;const e=ui();if(!e||w<0)return!1;const n=E[w].data.categories||[];if(!n.length)return!1;const o=n.findIndex(h=>h.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=E[w];Wt={category:i,index:o,modelId:mt(a)||(a?a.id:null),ts:Date.now()},Ke=null,G=null,it=null,at=null,Kt(),Vt(),Bt();const s=((c=n[o])==null?void 0:c.id)||((u=n[o-1])==null?void 0:u.id)||null;return s?Dn(s):Ko(),console.log("[Blockscape] removed category",i.id),!0}function Su(e){if(!e)return!1;const t=G;G=e;const n=il();return n||(G=t,Kt()),n}pe&&pe.addEventListener("click",async()=>{const e=f.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await ws(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),R&&R.addEventListener("click",async()=>{const e=Ed();if(!e){alert("No series available to copy. Create another version first.");return}await ws(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),Ae&&Ae.addEventListener("click",async()=>{try{const e=await Ac();if(!e){alert("Clipboard is empty.");return}f.value=e,f.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await ci(),t=Pn(f.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=An(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),w===-1&&n!=null?Ct(n):On(),e&&await al(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(w<0){alert("No active model selected.");return}try{const t=JSON.parse(f.value);if(xn(t,{titleHint:Je(E[w]),idHint:mt(E[w])||Je(E[w])}),E[w].data=t,E[w].title=t.title||E[w].title,E[w].isSeries||((e=E[w].apicurioVersions)==null?void 0:e.length)>1){const n=E[w].title||Je(E[w]);Rt(E[w],{seriesName:n,fallbackTitle:n})}Na(),console.log("[Blockscape] replaced active model:",Je(E[w])),Bt(),$e.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=Pn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((c,u)=>{var U;const h=(((U=c.data)==null?void 0:U.title)??"").toString().trim(),y=s.length>1?`${o.name} #${u+1}`:o.name,T=`${a} series`,P=c.isSeries?T:null;let L={...c};if(c.isSeries){const re=P||h||c.title||y||"unknown";L.title=re;const Ne=vn(re||"unknown");lo(L,Ne),Rt(L,{seriesName:re,fallbackTitle:"unknown"}),L.apicurioArtifactName=L.apicurioArtifactName||re}else L.title=h||y;const B=An({...L,apicurioArtifactName:L.apicurioArtifactName||P||L.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=B)})}w===-1&&n!=null?Ct(n):On()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",ku);async function ku(e){var a;if(!po())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Ud(t))return;let n=[];try{const s=await ci();n=Pn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,c)=>{const u=An(s,{versionLabel:n.length>1?`paste #${c+1}`:"paste"});o==null&&(o=u),i.push(u)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&Ct(o),await ci()&&await al(i,{origin:"clipboard"})}async function al(e,{origin:t="clipboard"}={}){if(!await ci()||typeof(Ge==null?void 0:Ge.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter(P=>{const L=E[P];return L&&!L.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=E[o[0]],s=Bc(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const c=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(c==null)return;const u=so(c);if(!u){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const h=await Nc(),y=[];for(let P=0;P<o.length;P++){const L=o.length===1?u:Lc(u,P+1),B=Mc(L,h);if(!B){alert("Could not find a unique filename to save.");return}h.add(B),y.push(B)}let T=null;for(let P=0;P<o.length;P++){const L=o[P],B=y[P],U=E[L];if(!U)continue;o.length===1&&$c(U,B);const re=await Ge.saveModelByIndex(L,B,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(re!=null&&re.ok)){alert(`Local auto-save failed: ${(re==null?void 0:re.error)||"unknown error"}`);return}T==null&&(T=B)}T&&Fi(T),await Ge.refresh(),On(),Rn(`Saved ${o.length} ${i}.`,2500)}z.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&Ct(n)}),document.getElementById("removeModel").onclick=()=>{if(w<0)return;const e=Je(E[w]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",Je(E[w])),E.splice(w,1),!E.length){w=-1,g=null,C.innerHTML="",F.innerHTML="",f.value="",On(),Na();return}const n=Math.min(w,E.length-1);Ct(n)},me&&(me.addEventListener("input",e=>{Fs(e.target.value||"")}),me.addEventListener("focus",()=>{me.value&&me.value.trim()&&Hs(me.value)})),ge&&ge.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;Rd({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!ge||ge.hidden)return;const t=e.target;ge.contains(t)||me&&(t===me||me.contains(t))||(ge.hidden=!0)}),x&&ae&&W&&x.addEventListener("submit",async e=>{e.preventDefault();const t=ae.value.trim();if(!t){alert("Please enter a URL"),ae.focus();return}const n=await Ua(t);if(typeof n=="number"){Ct(n),ae.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!ae||!t)return;let n=null;ae.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=ae.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function Bt(){if(!(w<0))try{Gi(E[w]),g=jd(E[w].data),di()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Iu(){const e=["comms.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>$i?$i.endsWith("/")?`${$i}${n}`:`${$i}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=Pn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(c=>{let u={...c};if(c.isSeries){const h=`${a} series`;u={...c,title:h,apicurioArtifactName:h};const y=vn(h||"unknown");lo(u,y),Rt(u,{seriesName:h,fallbackTitle:"unknown"})}An(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}On()}async function rl(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function _u(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>Cu(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");ll(i)&&sl(o,i)})}function Cu(e){var c,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(c=e.parentNode)==null?void 0:c.closest)!=null&&u.call(c,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:h,index:y})=>{y>s&&a.appendChild(document.createTextNode(t.slice(s,y))),a.appendChild(xu(h)),s=y+h.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function xu(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",ll(e)&&sl(t,e),t}function sl(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Au(n,t,e)))}async function Au(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await Ua(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function ll(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function Ua(e){try{console.log("[Blockscape] loading from URL:",e);const t=await rl(e),o=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=Pn(t,o)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let a=null;return i.forEach((s,c)=>{var L;const u=(((L=s.data)==null?void 0:L.title)??"").toString().trim(),h=i.length>1?`${o} #${c+1}`:o,y=s.isSeries?`${o} series`:null;let T={...s};if(s.isSeries){const B=y||u||T.title||h;T={...s,title:B,apicurioArtifactName:B||s.apicurioArtifactName};const U=vn(B||"unknown");lo(T,U),Rt(T,{seriesName:B||y||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:U,url:e,baseName:o,seriesTitle:B})}const P=An({...T,title:u||T.title||h,apicurioArtifactName:T.apicurioArtifactName||y||s.apicurioArtifactName},{versionLabel:o});a==null&&(a=P)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,o),w===-1&&a!=null?Ct(a):On(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=Pn(n,"Blockscape");if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(L=>{const B=An(L,{versionLabel:"seed"});i==null&&(i=B)}),await fc(),!await cs&&l.autoLoadFromDir&&await Iu();const s=await Fd(),c=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,u=await Wd(),h=Js(),y=h==null?void 0:h.index,T=Hd(),P=typeof c=="number"?c:typeof u=="number"?u:typeof T=="number"?T:typeof y=="number"?y:i??0;Ct(P),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===P&&requestAnimationFrame(()=>{var B;if(w!==s.modelIndex)return;const L=(B=he.get(s.itemId))==null?void 0:B.el;L&&(Mt(s.itemId),L.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),L.focus({preventScroll:!0}))})})()}const jl=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function zl(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function Jl(r){return jl(zl())}const Kl=`${Jl()}documentation/`;function Gl(r){let l;return{c(){l=H("div"),l.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Open the <a href="${Kl}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,b(l,"id","shortcutHelp"),b(l,"class","shortcut-help"),l.hidden=!0,b(l,"aria-hidden","true"),b(l,"role","dialog"),b(l,"aria-modal","true"),b(l,"aria-labelledby","shortcutHelpTitle")},m(f,A){It(f,l,A)},p:Nt,i:Nt,o:Nt,d(f){f&&gt(l)}}}class ql extends Mi{constructor(l){super(),Ni(this,l,null,Gl,_i,{})}}const Yl=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping, but do not add extra fields for it.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function Dr(r){let l,f,A,C,F,Q,z,te;return{c(){l=H("div"),f=H("div"),A=H("a"),C=Ci("Open Blockscape GPT"),F=ce(),Q=H("div"),Q.textContent="Paste the copied prompt into that chat.",z=ce(),te=H("div"),te.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',b(A,"href",Zl),b(A,"target","_blank"),b(A,"rel","noreferrer"),b(Q,"class","new-panel__hint"),b(f,"class","new-panel__link"),b(te,"class","new-panel__link new-panel__link--disabled"),b(l,"class","new-panel__links")},m(x,ae){It(x,l,ae),_(l,f),_(f,A),_(A,C),_(f,F),_(f,Q),_(l,z),_(l,te)},p:Nt,d(x){x&&gt(l)}}}function Ur(r){let l,f,A,C,F,Q;return{c(){l=H("div"),f=H("div"),f.textContent="Generated prompt",A=ce(),C=H("textarea"),b(f,"class","new-panel__prompt-label"),b(C,"class","pf-v5-c-form-control new-panel__textarea"),b(C,"rows","4"),C.readOnly=!0,b(l,"class","new-panel__prompt")},m(z,te){It(z,l,te),_(l,f),_(l,A),_(l,C),eo(C,r[4]),F||(Q=Qn(C,"input",r[12]),F=!0)},p(z,te){te&16&&eo(C,z[4])},d(z){z&&gt(l),F=!1,Q()}}}function Xl(r){let l,f,A,C,F,Q,z,te,x,ae,W,ie,Le,Xe,Ze,qe,He,J,Y,pe,R,Ae,Pe,de,rt,fe,Se,Me,D,Z,k,ee,me,ge,be,Fe,m,ke,Qe,ut,st,pt,Be,lt,ft,bt,E,w=r[2]==="gpt"&&Dr(),$e=r[4]&&r[5]&&Ur(r);return ft=Sl(r[10][0]),{c(){l=H("div"),f=H("div"),A=ce(),C=H("div"),F=H("div"),F.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',Q=ce(),z=H("form"),te=H("div"),x=H("label"),x.textContent="Domain",ae=ce(),W=H("p"),W.textContent="Describe what you want to create a map for.",ie=ce(),Le=H("textarea"),Xe=ce(),Ze=H("div"),qe=H("label"),He=H("input"),J=ce(),Y=H("span"),Y.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,pe=ce(),R=H("fieldset"),Ae=H("legend"),Ae.textContent="Target",Pe=ce(),de=H("p"),de.textContent="Choose where you plan to use the prompt.",rt=ce(),fe=H("label"),Se=H("input"),Me=ce(),D=H("div"),D.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',Z=ce(),k=H("label"),ee=H("input"),me=ce(),ge=H("div"),ge.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',be=ce(),Fe=H("div"),m=H("button"),m.textContent="Copy prompt",ke=ce(),Qe=H("button"),Qe.textContent="New blank",ut=ce(),st=H("div"),pt=Ci(r[3]),Be=ce(),w&&w.c(),lt=ce(),$e&&$e.c(),b(f,"id","newPanelBackdrop"),b(f,"class","shortcut-help__backdrop"),b(F,"class","shortcut-help__header"),b(x,"for","newDomain"),b(W,"class","new-panel__hint"),b(Le,"id","newDomain"),b(Le,"class","pf-v5-c-form-control new-panel__textarea"),b(Le,"rows","4"),Le.required=!0,b(Le,"placeholder","Ex: Companies building open-source geospatial tools"),b(te,"class","new-panel__field"),b(He,"id","seriesToggle"),b(He,"type","checkbox"),b(qe,"class","new-panel__toggle"),b(qe,"for","seriesToggle"),b(Ze,"class","new-panel__field"),b(de,"class","new-panel__hint"),b(Se,"type","radio"),b(Se,"name","target"),Se.__value="gpt",eo(Se,Se.__value),b(fe,"class","new-panel__option"),b(ee,"type","radio"),b(ee,"name","target"),ee.__value="plain",eo(ee,ee.__value),b(k,"class","new-panel__option"),b(R,"class","new-panel__field"),b(m,"class","pf-v5-c-button pf-m-primary"),b(m,"type","submit"),b(Qe,"id","newBlankButton"),b(Qe,"class","pf-v5-c-button pf-m-secondary"),b(Qe,"type","button"),b(Qe,"title","Start from an empty map"),b(st,"class","new-panel__status"),b(st,"aria-live","polite"),b(Fe,"class","new-panel__actions"),b(z,"class","shortcut-help__list new-panel__form"),b(C,"class","shortcut-help__panel"),b(C,"tabindex","-1"),b(l,"id","newPanel"),b(l,"class","shortcut-help"),l.hidden=!0,b(l,"aria-hidden","true"),b(l,"role","dialog"),b(l,"aria-modal","true"),b(l,"aria-labelledby","newPanelTitle"),ft.p(Se,ee)},m(g,he){It(g,l,he),_(l,f),_(l,A),_(l,C),_(C,F),_(C,Q),_(C,z),_(z,te),_(te,x),_(te,ae),_(te,W),_(te,ie),_(te,Le),eo(Le,r[0]),_(z,Xe),_(z,Ze),_(Ze,qe),_(qe,He),He.checked=r[1],_(qe,J),_(qe,Y),_(z,pe),_(z,R),_(R,Ae),_(R,Pe),_(R,de),_(R,rt),_(R,fe),_(fe,Se),Se.checked=Se.__value===r[2],_(fe,Me),_(fe,D),_(R,Z),_(R,k),_(k,ee),ee.checked=ee.__value===r[2],_(k,me),_(k,ge),_(z,be),_(z,Fe),_(Fe,m),_(Fe,ke),_(Fe,Qe),_(Fe,ut),_(Fe,st),_(st,pt),_(z,Be),w&&w.m(z,null),_(z,lt),$e&&$e.m(z,null),bt||(E=[Qn(Le,"input",r[7]),Qn(He,"change",r[8]),Qn(Se,"change",r[9]),Qn(ee,"change",r[11]),Qn(z,"submit",El(r[6]))],bt=!0)},p(g,[he]){he&1&&eo(Le,g[0]),he&2&&(He.checked=g[1]),he&4&&(Se.checked=Se.__value===g[2]),he&4&&(ee.checked=ee.__value===g[2]),he&8&&Lr(pt,g[3]),g[2]==="gpt"?w?w.p(g,he):(w=Dr(),w.c(),w.m(z,lt)):w&&(w.d(1),w=null),g[4]&&g[5]?$e?$e.p(g,he):($e=Ur(g),$e.c(),$e.m(z,null)):$e&&($e.d(1),$e=null)},i:Nt,o:Nt,d(g){g&&gt(l),w&&w.d(),$e&&$e.d(),ft.r(),bt=!1,Zo(E)}}}const Zl="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function Ql(r,l,f){let A="",C=!1,F="gpt",Q="",z="",te=!1;const x=()=>{var J;return typeof navigator<"u"&&!!((J=navigator.clipboard)!=null&&J.writeText)};function ae(J){const Y=J||"[DOMAIN]",pe=C?"series":"map",Ae=Yl.replaceAll("[DOMAIN NAME]",Y).replaceAll("[DOMAIN]",Y).replaceAll("[map|series]",pe).split(`
`),Pe=`Generate a **blockscape ${pe}** for the domain of ${Y}.`,de=Ae.findIndex(fe=>fe.toLowerCase().includes("generate a **blockscape value")||fe.toLowerCase().includes("generate a blockscape [map|series]")||fe.toLowerCase().startsWith("generate a blockscape"));de>=0?Ae[de]=Pe:Ae.unshift(Pe);const rt=C?`

User requested a series (return an array of models).`:"";return`${Ae.join(`
`).trim()}${rt}`}async function W(J){J.preventDefault();const Y=A.trim();if(f(3,Q=""),f(5,te=F!=="gpt"),!Y){f(3,Q="Add a domain to generate a prompt."),f(4,z="");return}if(F==="gpt"?f(4,z=`${C?"Create a series":"Create a map"} for ${Y}`):(f(4,z=ae(Y)),f(5,te=!0)),!x()){f(3,Q="Clipboard access is unavailable. Copy the prompt below."),f(5,te=!0);return}try{await navigator.clipboard.writeText(z),f(3,Q=F==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),F==="gpt"&&f(5,te=!1)}catch(R){console.warn("[Blockscape] clipboard write failed",R),f(3,Q="Copy failed. Use the prompt below."),f(5,te=!0)}}const ie=[[]];function Le(){A=this.value,f(0,A)}function Xe(){C=this.checked,f(1,C)}function Ze(){F=this.__value,f(2,F)}function qe(){F=this.__value,f(2,F)}function He(){z=this.value,f(4,z)}return[A,C,F,Q,z,te,W,Le,Xe,Ze,ie,qe,He]}class ec extends Mi{constructor(l){super(),Ni(this,l,Ql,Xl,_i,{})}}const{document:Hr}=yl;function tc(r){let l,f,A,C,F,Q,z,te,x,ae,W,ie,Le,Xe=r[0]?"Hide tools":"Show tools",Ze,qe,He,J,Y,pe,R,Ae,Pe,de,rt,fe,Se,Me,D,Z,k,ee,me,ge,be,Fe,m,ke,Qe,ut,st,pt,Be,lt,ft,bt,E,w,$e,g,he,Ft,G,Ke,it,at,yn,en,tn,Jn,Et,Wt,no,cn,Kn,Ot,dn,nn,Xt,jt,Pt,En,on,Zt,Sn,d,v,M=`<script id="seed" type="application/json">${r[4]}<\/script>`,N,S,O,X,q,Ee,ve,ue,ze,et,Re,wt,Ye,vt,De;return et=new ql({}),wt=new ec({}),{c(){l=H("link"),f=ce(),A=H("div"),C=H("header"),F=H("div"),Q=H("div"),z=H("div"),te=H("div"),te.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',x=ce(),ae=H("div"),W=H("div"),ie=H("button"),Le=H("span"),Ze=Ci(Xe),qe=ce(),He=H("span"),He.textContent="▾",Y=ce(),pe=H("button"),pe.textContent="New",R=ce(),Ae=H("label"),Ae.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',Pe=ce(),de=H("button"),de.textContent="Share",rt=ce(),fe=H("button"),fe.textContent="Help",Se=ce(),Me=H("div"),D=H("div"),D.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',Z=ce(),k=H("form"),k.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',ee=ce(),me=H("button"),me.textContent="Edit",m=ce(),ke=H("a"),ke.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',ut=ce(),st=H("main"),pt=H("div"),Be=H("aside"),lt=H("div"),lt.textContent="Models",ft=ce(),bt=H("ul"),E=ce(),w=H("div"),w.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',$e=ce(),g=H("section"),he=H("div"),he.textContent="Local files",Ft=ce(),G=H("p"),G.textContent="Checking for local server…",Ke=ce(),it=H("div"),at=H("label"),at.textContent="Blockscape files under ~/blockscape",yn=ce(),en=H("div"),tn=H("label"),tn.textContent="Folder",Jn=ce(),Et=H("select"),Wt=H("option"),Wt.textContent="All (~/blockscape)",no=ce(),cn=H("select"),Kn=ce(),Ot=H("div"),Ot.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button>',dn=ce(),nn=H("div"),nn.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',jt=ce(),Pt=H("div"),Pt.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,En=ce(),on=H("footer"),Zt=H("div"),Zt.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',d=ce(),v=new Il(!1),N=ce(),S=Tr("svg"),O=ce(),X=H("div"),q=ce(),Ee=H("div"),ve=ce(),ue=H("div"),ue.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',ze=ce(),ua(et.$$.fragment),Re=ce(),ua(wt.$$.fragment),Hr.title="Blockscape — simple landscape-style tiles",b(l,"rel","icon"),b(l,"type","image/svg+xml"),b(l,"href","./favicon.svg"),b(te,"class","blockscape-brand"),b(Le,"class","blockscape-toolbar__toggle-label"),b(He,"class","blockscape-toolbar__toggle-icon"),b(He,"aria-hidden","true"),b(ie,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),b(ie,"type","button"),b(ie,"aria-expanded",r[0]),b(ie,"aria-controls","blockscapeHeaderExtras"),b(ie,"aria-label",J=r[0]?"Hide tools":"Show tools"),b(pe,"id","newPanelButton"),b(pe,"class","pf-v5-c-button pf-m-primary"),b(pe,"type","button"),b(pe,"title","Create something new"),b(Ae,"class","pf-v5-c-button pf-m-primary blockscape-file"),b(de,"id","shareModel"),b(de,"class","pf-v5-c-button pf-m-secondary"),b(de,"type","button"),b(de,"title","Copy a shareable URL for this model"),b(fe,"id","helpButton"),b(fe,"class","pf-v5-c-button pf-m-primary"),b(fe,"type","button"),b(fe,"title","Show keyboard shortcuts"),b(W,"class","blockscape-toolbar__primary"),b(D,"class","blockscape-search"),b(k,"id","urlForm"),b(k,"class","blockscape-url-form"),b(k,"autocomplete","on"),k.noValidate=!0,b(me,"id","openInEditor"),b(me,"class","pf-v5-c-button pf-m-secondary"),b(me,"type","button"),b(me,"title","Open current JSON in the editor"),b(Me,"id","blockscapeHeaderExtras"),b(Me,"class","blockscape-toolbar__extras"),Me.hidden=ge=!r[0],b(Me,"aria-hidden",be=!r[0]),b(ae,"class","blockscape-toolbar__controls"),b(ae,"data-expanded",Fe=r[0]?"true":"false"),b(ke,"href","https://github.com/pwright/blockscape"),b(ke,"target","_blank"),b(ke,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),b(ke,"title","View on GitHub"),b(ke,"aria-label","View Blockscape on GitHub"),b(z,"class","blockscape-toolbar"),b(Q,"class","pf-v5-c-masthead__content"),b(F,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),b(C,"class","pf-v5-c-page__header"),C.hidden=Qe=!r[3],b(lt,"class","sidebar-heading"),b(bt,"id","modelList"),b(bt,"class","model-nav-list"),b(w,"class","model-actions"),b(he,"class","sidebar-heading"),b(G,"id","localBackendStatus"),b(G,"class","local-backend__status muted"),b(at,"class","sr-only"),b(at,"for","localFileList"),b(tn,"for","localDirSelect"),Wt.__value="",eo(Wt,Wt.__value),b(Et,"id","localDirSelect"),b(Et,"class","pf-v5-c-form-control"),b(Et,"aria-label","Folder filter"),b(en,"class","local-backend__dir"),b(cn,"id","localFileList"),b(cn,"class","pf-v5-c-form-control"),b(cn,"size","12"),cn.multiple=!0,b(cn,"aria-label","Blockscape files on local server"),b(Ot,"class","local-backend__actions"),b(it,"class","local-backend__list"),b(nn,"class","local-backend__save"),b(g,"id","localBackendPanel"),b(g,"class","local-backend"),g.hidden=!0,b(Be,"class","blockscape-sidebar"),b(Be,"aria-label","Models"),Be.hidden=Xt=!r[2],b(Pt,"class","blockscape-main"),b(pt,"class","blockscape-content"),b(st,"class","pf-v5-c-page__main"),b(Zt,"class","blockscape-footer__inner"),b(on,"class","pf-v5-c-page__footer blockscape-footer"),on.hidden=Sn=!r[1],b(A,"class","pf-v5-c-page"),v.a=N,b(S,"id","overlay"),b(S,"class","svg-layer"),b(X,"id","tabTooltip"),b(X,"class","blockscape-tab-tooltip"),X.hidden=!0,b(X,"aria-hidden","true"),b(Ee,"id","tileContextMenu"),b(Ee,"class","tile-context-menu"),Ee.hidden=!0,b(Ee,"aria-hidden","true"),b(ue,"id","itemPreview"),b(ue,"class","item-preview"),ue.hidden=!0,b(ue,"aria-hidden","true")},m(ne,Oe){_(Hr.head,l),It(ne,f,Oe),It(ne,A,Oe),_(A,C),_(C,F),_(F,Q),_(Q,z),_(z,te),_(z,x),_(z,ae),_(ae,W),_(W,ie),_(ie,Le),_(Le,Ze),_(ie,qe),_(ie,He),_(W,Y),_(W,pe),_(W,R),_(W,Ae),_(W,Pe),_(W,de),_(W,rt),_(W,fe),_(ae,Se),_(ae,Me),_(Me,D),_(Me,Z),_(Me,k),_(Me,ee),_(Me,me),_(z,m),_(z,ke),_(A,ut),_(A,st),_(st,pt),_(pt,Be),_(Be,lt),_(Be,ft),_(Be,bt),_(Be,E),_(Be,w),_(Be,$e),_(Be,g),_(g,he),_(g,Ft),_(g,G),_(g,Ke),_(g,it),_(it,at),_(it,yn),_(it,en),_(en,tn),_(en,Jn),_(en,Et),_(Et,Wt),_(it,no),_(it,cn),_(it,Kn),_(it,Ot),_(g,dn),_(g,nn),_(pt,jt),_(pt,Pt),_(A,En),_(A,on),_(on,Zt),It(ne,d,Oe),v.m(M,ne,Oe),It(ne,N,Oe),It(ne,S,Oe),It(ne,O,Oe),It(ne,X,Oe),It(ne,q,Oe),It(ne,Ee,Oe),It(ne,ve,Oe),It(ne,ue,Oe),It(ne,ze,Oe),Ti(et,ne,Oe),It(ne,Re,Oe),Ti(wt,ne,Oe),Ye=!0,vt||(De=Qn(ie,"click",r[5]),vt=!0)},p(ne,[Oe]){(!Ye||Oe&1)&&Xe!==(Xe=ne[0]?"Hide tools":"Show tools")&&Lr(Ze,Xe),(!Ye||Oe&1)&&b(ie,"aria-expanded",ne[0]),(!Ye||Oe&1&&J!==(J=ne[0]?"Hide tools":"Show tools"))&&b(ie,"aria-label",J),(!Ye||Oe&1&&ge!==(ge=!ne[0]))&&(Me.hidden=ge),(!Ye||Oe&1&&be!==(be=!ne[0]))&&b(Me,"aria-hidden",be),(!Ye||Oe&1&&Fe!==(Fe=ne[0]?"true":"false"))&&b(ae,"data-expanded",Fe),(!Ye||Oe&8&&Qe!==(Qe=!ne[3]))&&(C.hidden=Qe),(!Ye||Oe&4&&Xt!==(Xt=!ne[2]))&&(Be.hidden=Xt),(!Ye||Oe&2&&Sn!==(Sn=!ne[1]))&&(on.hidden=Sn)},i(ne){Ye||(Ai(et.$$.fragment,ne),Ai(wt.$$.fragment,ne),Ye=!0)},o(ne){da(et.$$.fragment,ne),da(wt.$$.fragment,ne),Ye=!1},d(ne){ne&&(gt(f),gt(A),gt(d),v.d(),gt(N),gt(S),gt(O),gt(X),gt(q),gt(Ee),gt(ve),gt(ue),gt(ze),gt(Re)),gt(l),Li(et,ne),Li(wt,ne),vt=!1,De()}}}function nc(r,l,f){let A,C,F,{seed:Q}=l,{features:z={}}=l;const x=Q?JSON.stringify(Q,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let ae=!1;const W=()=>{if(f(0,ae=!ae),!ae){const ie=document.getElementById("search");ie&&ie.value&&(ie.value="",ie.dispatchEvent(new Event("input",{bubbles:!0})))}};return Cl(()=>{Wl(z)}),r.$$set=ie=>{"seed"in ie&&f(6,Q=ie.seed),"features"in ie&&f(7,z=ie.features)},r.$$.update=()=>{r.$$.dirty&128&&f(3,A=z.showHeader!==!1),r.$$.dirty&128&&f(2,C=z.showSidebar!==!1),r.$$.dirty&128&&f(1,F=z.showFooter!==!1)},[ae,F,C,A,x,W,Q,z]}class oc extends Mi{constructor(l){super(),Ni(this,l,nc,tc,_i,{seed:6,features:7})}}function ic(r){let l,f;return l=new oc({props:{seed:r[0],features:r[1]}}),{c(){ua(l.$$.fragment)},m(A,C){Ti(l,A,C),f=!0},p(A,[C]){const F={};C&1&&(F.seed=A[0]),C&2&&(F.features=A[1]),l.$set(F)},i(A){f||(Ai(l.$$.fragment,A),f=!0)},o(A){da(l.$$.fragment,A),f=!1},d(A){Li(l,A)}}}function ac(r,l,f){let{seed:A}=l,{features:C={}}=l;return r.$$set=F=>{"seed"in F&&f(0,A=F.seed),"features"in F&&f(1,C=F.features)},[A,C]}class rc extends Mi{constructor(l){super(),Ni(this,l,ac,ic,_i,{seed:0,features:1})}}return rc}();
