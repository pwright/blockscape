var Blockscape=function(){"use strict";var mp=Object.defineProperty;var hp=(Bn,$t,to)=>$t in Bn?mp(Bn,$t,{enumerable:!0,configurable:!0,writable:!0,value:to}):Bn[$t]=to;var eo=(Bn,$t,to)=>hp(Bn,typeof $t!="symbol"?$t+"":$t,to);var Bn=typeof document<"u"?document.currentScript:null;function $t(){}function to(r){return r()}function Ur(){return Object.create(null)}function ti(r){r.forEach(to)}function Hr(r){return typeof r=="function"}function Li(r,c){return r!=r?c==c:r!==c||r&&typeof r=="object"||typeof r=="function"}function Vl(r){return Object.keys(r).length===0}const Dl=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function A(r,c){r.appendChild(c)}function kt(r,c,f){r.insertBefore(c,f||null)}function gt(r){r.parentNode&&r.parentNode.removeChild(r)}function F(r){return document.createElement(r)}function Fr(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function ha(r){return document.createTextNode(r)}function ue(){return ha(" ")}function no(r,c,f,T){return r.addEventListener(c,f,T),()=>r.removeEventListener(c,f,T)}function Ul(r){return function(c){return c.preventDefault(),r.call(this,c)}}function w(r,c,f){f==null?r.removeAttribute(c):r.getAttribute(c)!==f&&r.setAttribute(c,f)}function Hl(r){let c;return{p(...f){c=f,c.forEach(T=>r.push(T))},r(){c.forEach(f=>r.splice(r.indexOf(f),1))}}}function Fl(r){return Array.from(r.childNodes)}function Wl(r,c){c=""+c,r.data!==c&&(r.data=c)}function oo(r,c){r.value=c??""}class jl{constructor(c=!1){eo(this,"is_svg",!1);eo(this,"e");eo(this,"n");eo(this,"t");eo(this,"a");this.is_svg=c,this.e=this.n=null}c(c){this.h(c)}m(c,f,T=null){this.e||(this.is_svg?this.e=Fr(f.nodeName):this.e=F(f.nodeType===11?"TEMPLATE":f.nodeName),this.t=f.tagName!=="TEMPLATE"?f:f.content,this.c(c)),this.i(T)}h(c){this.e.innerHTML=c,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(c){for(let f=0;f<this.n.length;f+=1)kt(this.t,this.n[f],c)}p(c){this.d(),this.h(c),this.i(this.a)}d(){this.n.forEach(gt)}}let ni;function oi(r){ni=r}function zl(){if(!ni)throw new Error("Function called outside component initialization");return ni}function Gl(r){zl().$$.on_mount.push(r)}const yo=[],Wr=[];let Eo=[];const jr=[],Jl=Promise.resolve();let ga=!1;function Kl(){ga||(ga=!0,Jl.then(zr))}function ba(r){Eo.push(r)}const wa=new Set;let So=0;function zr(){if(So!==0)return;const r=ni;do{try{for(;So<yo.length;){const c=yo[So];So++,oi(c),ql(c.$$)}}catch(c){throw yo.length=0,So=0,c}for(oi(null),yo.length=0,So=0;Wr.length;)Wr.pop()();for(let c=0;c<Eo.length;c+=1){const f=Eo[c];wa.has(f)||(wa.add(f),f())}Eo.length=0}while(yo.length);for(;jr.length;)jr.pop()();ga=!1,wa.clear(),oi(r)}function ql(r){if(r.fragment!==null){r.update(),ti(r.before_update);const c=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,c),r.after_update.forEach(ba)}}function Yl(r){const c=[],f=[];Eo.forEach(T=>r.indexOf(T)===-1?c.push(T):f.push(T)),f.forEach(T=>T()),Eo=c}const Mi=new Set;let Xl;function Bi(r,c){r&&r.i&&(Mi.delete(r),r.i(c))}function va(r,c,f,T){if(r&&r.o){if(Mi.has(r))return;Mi.add(r),Xl.c.push(()=>{Mi.delete(r)}),r.o(c)}}function ya(r){r&&r.c()}function $i(r,c,f){const{fragment:T,after_update:C}=r.$$;T&&T.m(c,f),ba(()=>{const j=r.$$.on_mount.map(to).filter(Hr);r.$$.on_destroy?r.$$.on_destroy.push(...j):ti(j),r.$$.on_mount=[]}),C.forEach(ba)}function Ri(r,c){const f=r.$$;f.fragment!==null&&(Yl(f.after_update),ti(f.on_destroy),f.fragment&&f.fragment.d(c),f.on_destroy=f.fragment=null,f.ctx=[])}function Zl(r,c){r.$$.dirty[0]===-1&&(yo.push(r),Kl(),r.$$.dirty.fill(0)),r.$$.dirty[c/31|0]|=1<<c%31}function Oi(r,c,f,T,C,j,Q=null,J=[-1]){const ne=ni;oi(r);const x=r.$$={fragment:null,ctx:[],props:j,update:$t,not_equal:C,bound:Ur(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(c.context||(ne?ne.$$.context:[])),callbacks:Ur(),dirty:J,skip_bound:!1,root:c.target||ne.$$.root};Q&&Q(x.root);let re=!1;if(x.ctx=f?f(r,c.props||{},(G,ie,...Me)=>{const Qe=Me.length?Me[0]:ie;return x.ctx&&C(x.ctx[G],x.ctx[G]=Qe)&&(!x.skip_bound&&x.bound[G]&&x.bound[G](Qe),re&&Zl(r,G)),ie}):[],x.update(),re=!0,ti(x.before_update),x.fragment=T?T(x.ctx):!1,c.target){if(c.hydrate){const G=Fl(c.target);x.fragment&&x.fragment.l(G),G.forEach(gt)}else x.fragment&&x.fragment.c();c.intro&&Bi(r.$$.fragment),$i(r,c.target,c.anchor),zr()}oi(ne)}class Pi{constructor(){eo(this,"$$");eo(this,"$$set")}$destroy(){Ri(this,1),this.$destroy=$t}$on(c,f){if(!Hr(f))return $t;const T=this.$$.callbacks[c]||(this.$$.callbacks[c]=[]);return T.push(f),()=>{const C=T.indexOf(f);C!==-1&&T.splice(C,1)}}$set(c){this.$$set&&!Vl(c)&&(this.$$.skip_bound=!0,this.$$set(c),this.$$.skip_bound=!1)}}const Ql="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Ql);const Gr="blockscape:apicurioConfig",Ea="http://localhost:8080/apis/registry/v3",Vi="bs",Jr="-series",Sa=!1,ka=!1;function ec({models:r,getActiveIndex:c,setActive:f,ensureModelMetadata:T,ensureSeriesId:C,getModelId:j,getSeriesId:Q,getModelTitle:J,computeJsonFingerprint:ne,uid:x}){let re=null,G=null,ie=null,Me=null,Qe=null,qe=null,je=null,ze=null,W=null,q=null;const ve=new Set,R={baseUrl:Ea,groupId:Vi,authToken:"",enabled:Sa,useSemver:ka},Ie=new Map,Oe=new Map;function ce(d){return(d||"").toString().trim().replace(/\/+$/,"")}function at(d){return`${(d||"").toString().trim()||Vi}${Jr}`}function se(){return!!(R.baseUrl&&R.groupId)}function ge(){return R.enabled!==!1}function lt(){ve.forEach(d=>{try{d(ge())}catch(v){console.warn("[Blockscape] failed to run Apicurio enabled listener",v)}})}function O(d){return typeof d=="function"&&ve.add(d),()=>ve.delete(d)}function Z(){ie&&(ie.value=R.baseUrl||""),Me&&(Me.value=R.groupId||""),Qe&&(Qe.value=R.authToken||""),qe&&(qe.checked=ge()),je&&(je.checked=!!R.useSemver)}function I(d="",v="muted"){ze&&(ze.textContent=d||"",ze.classList.remove("is-error","is-success"),v==="error"?ze.classList.add("is-error"):v==="success"&&ze.classList.add("is-success"))}function ee(d){if(!q||(q.innerHTML="",!d))return;const v=document.createElement("p");v.className="apicurio-hint",v.textContent=d,q.appendChild(v)}function Se(d){Ie.clear(),Oe.clear(),ee(d)}function be(){const d=c(),v=ge(),M=se(),B=d>=0?r[d]:null,E=!!(B!=null&&B.apicurioVersions&&B.apicurioVersions.length>1);if(re){const D=re.dataset.loading==="true",X=v&&M&&d>=0&&!!ft(r[d]);re.disabled=!v||D||!X,v?D||(re.textContent="Push to Apicurio"):re.textContent="Enable Apicurio to push"}if(W){const D=W.dataset.loading==="true",X=v&&M&&E&&!!ft(B);W.disabled=!X||D,W.hidden=!E,v?D||(W.textContent="Push series"):W.textContent="Enable Apicurio to push series"}if(G){const D=G.dataset.loading==="true",X=v&&M;G.disabled=!X||D,D||(v?M?G.textContent="List artifacts":G.textContent="Enter details to list":G.textContent="Enable Apicurio to list")}}function ke(){Z(),ge()?se()?(I("Apicurio push is ready when a model is selected.","muted"),Ie.size||ee("Click “List artifacts” to browse the current group.")):(I("Enter Apicurio connection details to enable push.","muted"),Se("Enter registry details to browse artifacts.")):(I("Apicurio integration is off. Enable it to allow pushes.","muted"),Se("Apicurio integration is disabled.")),be()}function $e(){if(window!=null&&window.localStorage)try{localStorage.setItem(Gr,JSON.stringify(R))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function g(){let d={};if(window!=null&&window.localStorage)try{const D=localStorage.getItem(Gr);if(D){const X=JSON.parse(D);X&&typeof X=="object"&&(d=X)}}catch(D){console.warn("[Blockscape] failed to restore Apicurio settings",D)}const v=ce(d.baseUrl??Ea),M=(d.groupId??Vi).toString().trim();let B=Sa,E=ka;typeof d.enabled=="boolean"?B=d.enabled:typeof d.enabled=="string"&&(B=d.enabled==="true"),typeof d.useSemver=="boolean"?E=d.useSemver:typeof d.useSemver=="string"&&(E=d.useSemver==="true"),R.baseUrl=v||Ea,R.groupId=M||Vi,R.authToken=(d.authToken??"").toString().trim(),R.enabled=B,R.useSemver=E,ke(),lt()}function Te(){const d={Accept:"application/json"},v=(R.authToken||"").trim();return v&&(d.Authorization=/\s/.test(v)?v:`Bearer ${v}`),d}function Ye(d,v,{title:M,description:B,version:E}={}){const D={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:v},metadata:{properties:{}}}};E&&(D.firstVersion.version=E),M&&(D.name=M),B&&(D.description=B);try{const X=JSON.parse(v),Y=X==null?void 0:X.seriesId;Y&&typeof Y=="string"&&(D.firstVersion.metadata.properties.seriesId=Y)}catch{}return D}function et(d,{version:v}={}){const M={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const B=JSON.parse(d),E=B==null?void 0:B.seriesId;E&&typeof E=="string"&&(M.metadata.properties.seriesId=E)}catch{}return v&&(M.version=v),M}function We(d){if(d==null)return null;const v=String(d).trim();if(!v)return null;const M=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(v);if(M)return{major:Number(M[1]),minor:Number(M[2]),patch:Number(M[3])};const B=/^v?(\d+)$/.exec(v);return B?{major:Number(B[1]),minor:0,patch:0}:null}function dt(d){return`${d.major}.${d.minor}.${d.patch}`}function tt(d,v){return!d&&!v?0:d?v?d.major!==v.major?d.major-v.major:d.minor!==v.minor?d.minor-v.minor:d.patch-v.patch:1:-1}function ct(d=[]){let v=null;if(d.forEach(B=>{const E=We((B==null?void 0:B.version)??B);E&&(!v||tt(E,v)>0)&&(v=E)}),!v)return"1.0.0";const M={...v,patch:v.patch+1};return dt(M)}function ft(d,{seriesName:v,fallbackTitle:M}={}){var D;if(!d)return null;const B=v||d.title||d.apicurioArtifactName||J(d),E=M||B;if(typeof C=="function"&&(d.isSeries||((D=d.apicurioVersions)==null?void 0:D.length)>1)&&C(d,{seriesName:B,fallbackTitle:E}),typeof Q=="function"){const X=Q(d,{seriesName:B,fallbackTitle:E});if(X)return X}return j(d)}function mt(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function k(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function b(d=[]){if(!Array.isArray(d)||!d.length)return null;const v=[...d].filter(Boolean);return v.sort((M,B)=>{const E=M!=null&&M.createdOn?new Date(M.createdOn).getTime():0,D=B!=null&&B.createdOn?new Date(B.createdOn).getTime():0;if(E!==D)return D-E;const X=Number(M==null?void 0:M.version),Y=Number(B==null?void 0:B.version),ye=Number.isFinite(X),Ee=Number.isFinite(Y);if(ye&&Ee&&X!==Y)return Y-X;const me=String((M==null?void 0:M.version)??"");return String((B==null?void 0:B.version)??"").localeCompare(me,void 0,{numeric:!0})}),v[0]||null}function Ne(d){if(!d)return d;let v=d;if(!Array.isArray(d==null?void 0:d.categories)){const B=d==null?void 0:d.content;if(typeof B=="string")try{v=JSON.parse(B)}catch(E){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",E)}else B&&typeof B=="object"&&(v=B)}return v}async function y(d,v,M){const B=encodeURIComponent(v),E=encodeURIComponent(M),D=`${d}/groups/${B}/artifacts/${E}`,X=Te();X.Accept="application/json";const Y=await fetch(D,{method:"GET",headers:X});if(!Y.ok){let ye=Y.statusText||"Unknown error";try{const Ee=await Y.text();Ee&&(ye=Ee.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${Y.status}): ${ye}`)}return Y.json()}async function pe(d,v,M){const B=encodeURIComponent(v),E=encodeURIComponent(M),D=`${d}/groups/${B}/artifacts/${E}/versions?limit=50&order=desc`,X=Te();X.Accept="application/json";const Y=await fetch(D,{method:"GET",headers:X});if(!Y.ok){let Ee=Y.statusText||"Unknown error";try{const me=await Y.text();me&&(Ee=me.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${Y.status}): ${Ee}`)}const ye=await Y.json();return k(ye).filter(Ee=>Ee&&Ee.version!=null)}async function jt(d,v,M,B="latest"){const E=encodeURIComponent(v),D=encodeURIComponent(M),X=encodeURIComponent(B||"latest"),Y=`${d}/groups/${E}/artifacts/${D}/versions/${X}/content`,ye=Te();ye.Accept="application/json, application/*+json, */*;q=0.8";const Ee=await fetch(Y,{method:"GET",headers:ye});if(!Ee.ok){let Xe=Ee.statusText||"Unknown error";try{const he=await Ee.text();he&&(Xe=he.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${Ee.status}): ${Xe}`)}const me=await Ee.text();let He=null;try{He=JSON.parse(me)}catch{throw new Error("Artifact content is not valid JSON.")}return Ne(He)}async function H(d,v,M,B="latest"){const E=await jt(d,v,M,B);return{data:E,fingerprint:ne(E)}}async function Ue(d,v,M){try{const E=await pe(d,v,M);if(E!=null&&E.length){Oe.set(M,E);const D=b(E);if((D==null?void 0:D.version)!=null)return D.version}}catch(E){console.warn("[Blockscape] compare-version: unable to fetch versions list",E)}try{const E=await y(d,v,M);if((E==null?void 0:E.version)!=null)return E.version}catch(E){console.warn("[Blockscape] compare-version: unable to fetch metadata",E)}const B=Oe.get(M);if(B&&B.length){const E=b(B);if((E==null?void 0:E.version)!=null)return E.version}return"latest"}async function It(d,v,M,B){if(!R.useSemver)return null;if(!B)return"1.0.0";try{const E=await pe(d,v,M);return ct(E)}catch(E){throw new Error(`Unable to compute next semantic version: ${E.message}`)}}function nt(d=document){re=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),W=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),G=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),ie=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),Me=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),Qe=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),qe=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),je=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),ze=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),q=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function nn(){R.baseUrl=ce((ie==null?void 0:ie.value)??R.baseUrl),R.groupId=((Me==null?void 0:Me.value)??"").trim(),R.authToken=((Qe==null?void 0:Qe.value)??"").trim(),$e(),ke()}function Rn(d){R.enabled=d!==!1,$e(),ke(),lt()}function zt(){Rn(qe?qe.checked:Sa)}function ln(){R.useSemver=je?je.checked:ka,$e(),ke()}function Gt(){[ie,Me,Qe].forEach(d=>{d&&d.addEventListener("input",nn)}),re&&re.addEventListener("click",()=>{Ct()}),W&&W.addEventListener("click",()=>{on()}),qe&&qe.addEventListener("change",zt),je&&je.addEventListener("change",ln),G&&G.addEventListener("click",vn),q&&q.addEventListener("click",d=>{const v=d.target.closest("[data-artifact-version]");if(v){d.stopPropagation();const E=v.dataset.artifactId,D=v.dataset.artifactVersion;E&&D&&an(E,D);return}const M=d.target.closest("[data-artifact-load-all]");if(M){d.stopPropagation(),M.dataset.artifactId&&yn();return}const B=d.target.closest("[data-artifact-trigger]");if(B){const E=B.dataset.artifactId;if(!E)return;wn(E)}})}function Vt(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function ao(d){if(!d)return;d.innerHTML="";const v=Vt();d.appendChild(v),nt(d),Gt(),ke()}function On(d){if(!q)return;if(q.innerHTML="",!d.length){ee("No artifacts found in this group.");return}const v=E=>{const D=document.createElement("section");D.className="apicurio-artifact-section";const X=document.createElement("h3");X.textContent=E,D.appendChild(X);const Y=document.createElement("ul");return Y.className="apicurio-artifact-list",D.appendChild(Y),{section:D,list:Y}},M=v("Series artifacts"),B=v("Artifacts");d.forEach(E=>{if(!(E!=null&&E.artifactId))return;const X=E._groupId&&E._groupId.endsWith(Jr)?M.list:B.list,Y=document.createElement("li"),ye=document.createElement("button");ye.type="button",ye.className="apicurio-artifact",ye.dataset.artifactId=E.artifactId,ye.dataset.artifactTrigger="toggle";const Ee=document.createElement("span");Ee.className="apicurio-artifact-title",Ee.textContent=E.artifactId,ye.appendChild(Ee);const me=[];if(E.name&&me.push(E.name),E.version!=null&&me.push(`v${E.version}`),E.type&&me.push(E.type),E._groupId&&me.push(E._groupId),me.length){const he=document.createElement("span");he.className="apicurio-artifact-meta",he.textContent=me.join(" • "),ye.appendChild(he)}if(E.description){const he=document.createElement("span");he.className="apicurio-artifact-meta",he.textContent=E.description,ye.appendChild(he)}Y.appendChild(ye);const He=document.createElement("div");He.className="apicurio-version-list",He.dataset.versionPanel=E.artifactId,He.hidden=!0;const Xe=document.createElement("p");Xe.className="apicurio-hint",Xe.textContent="Click to load the latest or open versions.",He.appendChild(Xe),Y.appendChild(He),X.appendChild(Y)}),M.list.children.length&&q.appendChild(M.section),B.list.children.length&&q.appendChild(B.section)}function qn(d){return q?q.querySelector(`[data-version-panel="${d}"]`):null}function Dt(d,v){if(!d||(d.innerHTML="",!v))return;const M=document.createElement("p");M.className="apicurio-hint",M.textContent=v,d.appendChild(M)}function Xt(d,v){const M=qn(d);if(M){if(M.innerHTML="",!v.length){Dt(M,"No versions found for this artifact.");return}v.forEach(B=>{const E=document.createElement("button");E.type="button",E.className="apicurio-version-button",E.dataset.artifactId=d,E.dataset.artifactVersion=B.version;const D=[`Version ${B.version}`];if(B.createdOn){const X=new Date(B.createdOn);isNaN(X)||D.push(X.toISOString().slice(0,10))}E.textContent=D.join(" — "),M.appendChild(E)})}}async function wn(d){const v=qn(d);if(!v)return;if(v.dataset.open==="true"){v.hidden=!0,v.dataset.open="false";return}if(v.hidden=!1,v.dataset.open="true",v.dataset.loaded!=="true"){if(!se()){Dt(v,"Enter registry details first.");return}Dt(v,"Loading versions…");try{const B=ce(R.baseUrl),E=Ie.get(d),D=R.groupId.trim(),X=(E==null?void 0:E._groupId)||D,Y=await pe(B,X,d);Oe.set(d,Y),v.dataset.loaded="true",Xt(d,Y)}catch(B){console.error("[Blockscape] failed to load versions",B),Dt(v,`Unable to fetch versions: ${B.message}`)}}}function Zt(d,v){var B;const M=r.findIndex(E=>E.apicurioArtifactId===d);if(M!==-1){const E=r[M].id;r[M]={...v,id:E||v.id},((B=r[M].apicurioVersions)==null?void 0:B.length)>1&&(r[M].isSeries=!0),f(M)}else r.push(v),f(r.length-1)}async function Jt(d,v,M,B){const E=encodeURIComponent(v),D=encodeURIComponent(M),X=`${d}/groups/${E}/artifacts/${D}`;try{const Y=await fetch(X,{method:"GET",headers:B});if(Y.status===404)return!1;if(Y.ok)return!0;throw Y.status===401||Y.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${Y.status} while checking the artifact.`)}catch(Y){throw Y instanceof TypeError?new Error("Network error while contacting Apicurio registry."):Y}}async function Ct(){var X;if(!re||re.dataset.loading==="true")return;if(!ge()){I("Apicurio integration is off. Enable it first.","error");return}if(!se()){I("Enter the registry base URL and group ID before pushing.","error");return}const d=c();if(d<0||!r[d]){I("No active model to push.","error");return}const v=ft(r[d],{fallbackTitle:J(r[d])});if(!v){I("Active model needs an id before pushing.","error");return}const M=ce(R.baseUrl),B=R.groupId.trim(),E=JSON.stringify(r[d].data,null,2),D=Te();re.dataset.loading="true",re.textContent="Pushing…",re.disabled=!0,I("Pushing to Apicurio…","muted");try{const Y=await Jt(M,B,v,D),ye=ne(r[d].data);if(Y)try{const rt=await Ue(M,B,v),{data:_t,fingerprint:wt}=await H(M,B,v,rt);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",rt),console.log("local fingerprint",ye),console.log("registry fingerprint",wt),console.log("local payload",r[d].data),console.log("registry payload",_t),console.groupEnd(),ye&&wt&&ye===wt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){I("Push cancelled (content matches the latest registry version).","muted");return}I("Pushing identical content by user choice.","muted")}else wt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):I("Unable to compare with registry content (skipping confirmation).","muted")}catch(rt){console.warn("[Blockscape] unable to compare registry content before push",rt),I("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const Ee=R.useSemver?await It(M,B,v,Y):null;if(R.useSemver&&!Ee)throw new Error("Semantic versioning is enabled but no version could be computed.");const me=encodeURIComponent(B),He=encodeURIComponent(v),Xe=Y?`${M}/groups/${me}/artifacts/${He}/versions`:`${M}/groups/${me}/artifacts`,he={...D,"Content-Type":"application/json"};Ee&&(he["X-Registry-Version"]=Ee,I(`Pushing to Apicurio as version ${Ee}…`,"muted"));const Rt=Y?et(E,{version:Ee}):Ye(v,E,{title:J(r[d]),description:(X=r[d].data)==null?void 0:X.abstract,version:Ee}),bt=await fetch(Xe,{method:"POST",headers:he,body:JSON.stringify(Rt)});if(!bt.ok){let rt=bt.statusText||"Unknown error";try{const _t=await bt.text();_t&&(rt=_t.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${bt.status}): ${rt}`)}let de=null;try{de=await bt.json()}catch{de=null}const oe=(de==null?void 0:de.version)||(de==null?void 0:de.globalId)||"",ht=Y?"Updated":"Created",cn=oe?` (version ${oe})`:"";I(`${ht} ${v}${cn}`,"success")}catch(Y){console.error("[Blockscape] Apicurio push failed",Y),I(`Apicurio push failed: ${Y.message}`,"error")}finally{re.dataset.loading="false",be()}}async function on(){var Ee,me;if(!W||W.dataset.loading==="true")return;if(!ge()){I("Apicurio integration is off. Enable it first.","error");return}if(!se()){I("Enter the registry base URL and group ID before pushing.","error");return}const d=c(),v=d>=0?r[d]:null;if(!v||!v.apicurioVersions||v.apicurioVersions.length<2){I("Series push requires a model with multiple versions.","error");return}const M=ft(v,{seriesName:v.title||v.apicurioArtifactName||J(v)});if(!M){I("Active series needs an id before pushing.","error");return}typeof C=="function"&&C(v,{seriesName:v.title||v.apicurioArtifactName||J(v)});const B=ce(R.baseUrl),E=R.groupId.trim(),D=v.apicurioVersions.map(He=>He.data),X=JSON.stringify(D,null,2),Y=Te(),ye=at(E);W.dataset.loading="true",W.textContent="Pushing…",W.disabled=!0,I("Pushing series to Apicurio…","muted");try{const He=await Jt(B,ye,M,Y),Xe=ne(D);if(He)try{const dn=await Ue(B,ye,M),{data:xn,fingerprint:ro}=await H(B,ye,M,dn);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",dn),console.log("local fingerprint",Xe),console.log("registry fingerprint",ro),console.log("local payload (series)",D),console.log("registry payload",xn),console.groupEnd(),Xe&&ro&&Xe===ro){if(!window.confirm("The current registry version matches this series. Push anyway?")){I("Series push cancelled (content matches latest).","muted");return}I("Pushing identical series by user choice.","muted")}else ro?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):I("Unable to compare with registry content (skipping confirmation).","muted")}catch(dn){console.warn("[Blockscape] unable to compare registry content before series push",dn),I("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const he=R.useSemver?await It(B,ye,M,He):null;if(R.useSemver&&!he)throw new Error("Semantic versioning is enabled but no version could be computed.");const Rt=encodeURIComponent(ye),bt=encodeURIComponent(M),de=He?`${B}/groups/${Rt}/artifacts/${bt}/versions`:`${B}/groups/${Rt}/artifacts`,oe={...Y,"Content-Type":"application/json"};he&&(oe["X-Registry-Version"]=he,I(`Pushing series to Apicurio as version ${he}…`,"muted"));const ht=He?et(X,{version:he}):Ye(M,X,{title:v.apicurioArtifactName||((Ee=v.data)==null?void 0:Ee.title)||M,description:(me=v.data)==null?void 0:me.abstract,version:he}),cn=await fetch(de,{method:"POST",headers:oe,body:JSON.stringify(ht)});if(!cn.ok){let dn=cn.statusText||"Unknown error";try{const xn=await cn.text();xn&&(dn=xn.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${cn.status}): ${dn}`)}let rt=null;try{rt=await cn.json()}catch{rt=null}const _t=(rt==null?void 0:rt.version)||(rt==null?void 0:rt.globalId)||"",wt=He?"Updated":"Created",_n=_t?` (version ${_t})`:"";I(`${wt} ${M} series${_n}`,"success")}catch(He){console.error("[Blockscape] Apicurio series push failed",He),I(`Apicurio series push failed: ${He.message}`,"error")}finally{W.dataset.loading="false",be()}}async function vn(){if(!G||G.dataset.loading==="true")return;if(!ge()){I("Enable Apicurio integration to list artifacts.","error");return}if(!se()){I("Enter registry base URL and group ID before listing.","error");return}const d=ce(R.baseUrl),v=R.groupId.trim(),M=at(v),B=[{groupId:v,label:"base"},{groupId:M,label:"series"}];G.dataset.loading="true",G.textContent="Listing…",G.disabled=!0,I("Listing artifacts…","muted"),ee("Contacting registry…");try{const E=Te();E.Accept="application/json";const D=[];for(const Y of B){const ye=encodeURIComponent(Y.groupId),Ee=`${d}/groups/${ye}/artifacts?limit=50&offset=0`,me=await fetch(Ee,{method:"GET",headers:E});if(!me.ok){let he=me.statusText||"Unknown error";try{const Rt=await me.text();Rt&&(he=Rt.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${Y.groupId} (${me.status}): ${he}`);continue}const He=await me.json(),Xe=mt(He).filter(he=>he&&he.artifactId);Xe.forEach(he=>{he&&(he._groupId=Y.groupId)}),D.push(...Xe)}Ie.clear(),Oe.clear(),D.forEach(Y=>{Y!=null&&Y.artifactId&&Ie.set(Y.artifactId,Y)}),On(D);const X=D.length;I(X?`Found ${X} artifact${X===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",X?"success":"muted")}catch(E){console.error("[Blockscape] failed to list artifacts",E),Se("Unable to list artifacts."),I(`Listing failed: ${E.message}`,"error")}finally{G.dataset.loading="false",be()}}async function an(d,v=null){var He,Xe,he,Rt,bt,de;if(!d)return;if(!ge()){I("Enable Apicurio integration to load artifacts.","error");return}if(!se()){I("Enter registry connection details before loading artifacts.","error");return}const M=ce(R.baseUrl),B=R.groupId.trim(),E=d&&((He=Ie.get(d))==null?void 0:He._groupId)||B;let D=Ie.get(d);const X=async()=>{try{const oe=await y(M,E,d);return oe!=null&&oe.artifactId&&Ie.set(d,oe),oe}catch(oe){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",oe),oe}};if(!D)try{D=await X()}catch(oe){I(`Failed to fetch artifact metadata: ${oe.message}`,"error");return}const Y=Oe.get(d)||[];let ye="latest",Ee="latest";if(v)ye=v,Ee=v;else{if(!D||D.version==null)try{D=await X()}catch(oe){I(`Failed to fetch artifact metadata: ${oe.message}`,"error");return}ye=(D==null?void 0:D.version)||"latest",Ee=(D==null?void 0:D.version)||"latest"}const me=Y.find(oe=>String(oe.version)===String(ye));(me==null?void 0:me.version)!=null&&(Ee=me.version),I(`Loading artifact ${d}…`,"muted");try{const oe=await jt(M,E,d,ye),ht=Ie.get(d)||D||{},cn=Array.isArray(oe);let rt=null;if(cn){const _t=oe.map((_n,dn)=>(T(_n,{titleHint:ht.name||d,idHint:d}),{version:String(dn+1),data:_n,createdOn:(me==null?void 0:me.createdOn)||ht.createdOn}));rt={id:x(),title:((he=(Xe=_t[0])==null?void 0:Xe.data)==null?void 0:he.title)||ht.name||d,data:(Rt=_t[0])==null?void 0:Rt.data,apicurioArtifactId:d,apicurioArtifactName:ht.name||"",apicurioVersions:_t,apicurioActiveVersionIndex:0,isSeries:!0};const wt=((bt=ht==null?void 0:ht.properties)==null?void 0:bt.seriesId)||d;typeof C=="function"&&C(rt,{seriesName:wt,fallbackTitle:wt}),I(`Loaded series artifact ${d}.`,"success")}else{T(oe,{titleHint:ht.name||d,idHint:d});const _t={version:Ee,data:oe,createdOn:(me==null?void 0:me.createdOn)||ht.createdOn};rt={id:x(),title:oe.title||ht.name||d,data:oe,apicurioArtifactId:d,apicurioArtifactName:ht.name||"",apicurioVersions:[_t],apicurioActiveVersionIndex:0};const wt=(de=ht==null?void 0:ht.properties)==null?void 0:de.seriesId;wt&&typeof C=="function"&&C(rt,{seriesName:wt,fallbackTitle:wt});const _n=Ee?` (version ${Ee})`:"";I(`Loaded artifact ${d}${_n}.`,"success")}Zt(d,rt)}catch(oe){console.error("[Blockscape] failed to load artifact",oe),I(`Failed to load artifact: ${oe.message}`,"error")}}async function yn(d){}return{hydrateConfig:g,mount:ao,updateAvailability:be,isEnabled:ge,setEnabled:Rn,onEnabledChange:O}}const Ot={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Jn(r,c){if(typeof r!="function")throw new Error(`[itemEditor] expected ${c} to be a function`)}function tc(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}const Ia=1,Ca=4;function nc(r){if(r==null)return null;const c=Number(r);if(!Number.isFinite(c))return null;const f=Math.round(c);return f<Ia||f>Ca?null:f}function oc(r,{excludeId:c}={}){if(!r)return[];const f=r.split(/[\s,]+/).map(C=>C.trim()).filter(Boolean),T=[];return f.forEach(C=>{c&&C===c||T.includes(C)||T.push(C)}),T}function ic(r,c,f){if(!c||!f||c===f)return;((r==null?void 0:r.categories)||[]).forEach(C=>{(C.items||[]).forEach(j=>{Array.isArray(j.deps)&&(j.deps=j.deps.map(Q=>Q===c?f:Q))})})}function ac({findItemAndCategoryById:r,collectAllItemIds:c,updateItemReferences:f,loadActiveIntoEditor:T,rebuildFromActive:C,select:j,onSelectionRenamed:Q,makeSlug:J=tc,isAutoIdFromNameEnabled:ne=()=>!0}={}){Jn(r,"findItemAndCategoryById"),Jn(c,"collectAllItemIds"),Jn(f,"updateItemReferences"),Jn(T,"loadActiveIntoEditor"),Jn(C,"rebuildFromActive"),Jn(j,"select"),Jn(J,"makeSlug"),Jn(ne,"isAutoIdFromNameEnabled");const x={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function re(W){if(x.fields.errorEl){if(!W){x.fields.errorEl.hidden=!0,x.fields.errorEl.textContent="";return}x.fields.errorEl.hidden=!1,x.fields.errorEl.textContent=W}}function G(){x.wrapper&&(x.wrapper.hidden=!0,x.wrapper.setAttribute("aria-hidden","true"),re(""),x.categoryId=null,x.itemId=null,x.modelData=null,document.body.classList.remove("item-editor-open"))}function ie(){x.wrapper&&(x.wrapper.hidden=!1,x.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var W,q;(W=x.fields.nameInput)==null||W.focus(),(q=x.fields.nameInput)==null||q.select()}))}function Me({force:W}={}){var ve,R;if(!((ve=x.fields)!=null&&ve.idInput)||!((R=x.fields)!=null&&R.nameInput)||!x.autoSyncEnabled||!ne()||!W&&x.autoIdManuallyEdited)return;const q=J(x.fields.nameInput.value||x.itemId||"item");x.fields.idInput.value=q}function Qe(W){var lt;if(!x.modelData||!x.categoryId||!x.itemId)throw new Error("No item loaded.");const ve=(((lt=x.modelData)==null?void 0:lt.categories)||[]).find(O=>O.id===x.categoryId);if(!ve)throw new Error("Category not found.");ve.items=ve.items||[];const R=ve.items.find(O=>O.id===x.itemId);if(!R)throw new Error("Item not found.");const Ie=(W.id||"").trim();if(!Ie)throw new Error("ID is required.");const Oe=c(x.modelData);if(Ie!==R.id&&Oe.has(Ie))throw new Error("Another item already uses that ID.");R.id=Ie;const ce=(W.name||"").trim();R.name=ce||R.id;const at=(W.logo||"").trim();if(at?R.logo=at:delete R.logo,W.externalFlag&&!W.external)R.external=!0;else{const O=(W.external??"").toString().trim();O?R.external=O:delete R.external}const se=(W.color||"").trim();se?R.color=se:delete R.color;const ge=nc(W.stage);return ge!=null?R.stage=ge:delete R.stage,R.deps=Array.isArray(W.deps)?W.deps:[],R.id!==W.originalId&&typeof Q=="function"&&Q(W.originalId,R.id),f(x.modelData,W.originalId,R.id),T(),C(),j(R.id),R.id}function qe(){if(!x.fields||!x.fields.idInput)return!1;const W=(x.fields.idInput.value||"").trim(),q={originalId:x.itemId,id:W,name:x.fields.nameInput.value||"",logo:x.fields.logoInput.value||"",external:x.fields.externalInput.value||"",externalFlag:x.fields.externalFlagInput.checked,color:x.fields.colorInput.value||"",stage:x.fields.stageInput.value,deps:oc(x.fields.depsInput.value,{excludeId:W})};try{return Qe(q),G(),!0}catch(ve){return console.warn("[itemEditor] item edit failed",ve),re((ve==null?void 0:ve.message)||"Unable to save item."),!1}}function je(){if(x.wrapper)return x.wrapper;const W=document.createElement("div");W.className="item-editor-modal",W.hidden=!0,W.setAttribute("role","dialog"),W.setAttribute("aria-modal","true");const q=document.createElement("div");q.className="item-editor-modal__backdrop",W.appendChild(q);const ve=document.createElement("div");ve.className="item-editor",W.appendChild(ve);const R=document.createElement("div");R.className="item-editor__header";const Ie=document.createElement("h2");Ie.className="item-editor__title",Ie.textContent="Edit item";const Oe=document.createElement("button");Oe.type="button",Oe.className="item-editor__close",Oe.setAttribute("aria-label","Close item editor"),Oe.textContent="×",R.appendChild(Ie),R.appendChild(Oe),ve.appendChild(R);const ce=document.createElement("form");ce.className="item-editor__form",ve.appendChild(ce);const at=document.createElement("div");at.className="item-editor__meta",at.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',ce.appendChild(at);const se=document.createElement("div");se.className="item-editor__error",se.hidden=!0,ce.appendChild(se);const ge=(b,Ne,y)=>{const pe=document.createElement("label");pe.className="item-editor__field";const jt=document.createElement("span");if(jt.className="item-editor__label",jt.textContent=b,pe.appendChild(jt),Ne.classList.add("item-editor__control"),pe.appendChild(Ne),y){const H=document.createElement("div");H.className="item-editor__hint",H.textContent=y,pe.appendChild(H)}return pe},lt=document.createElement("input");lt.type="text",lt.required=!0,ce.appendChild(ge("ID",lt,"Unique identifier used for dependencies."));const O=document.createElement("input");O.type="text",ce.appendChild(ge("Name",O,"Visible label shown on the tile."));const Z=document.createElement("input");Z.type="url",Z.inputMode="url",Z.placeholder="https://…",ce.appendChild(ge("Logo URL",Z,"Optional image URL."));const I=document.createElement("input");I.type="url",I.inputMode="url",I.placeholder="https://…",ce.appendChild(ge("External link",I,"Shown with ↗ icon and in preview."));const ee=document.createElement("div");ee.className="item-editor__checkbox";const Se=document.createElement("label");Se.className="item-editor__checkbox-row";const be=document.createElement("input");be.type="checkbox";const ke=document.createElement("span");ke.textContent="Mark as external without link";const $e=document.createElement("div");$e.className="item-editor__hint",$e.textContent="Keeps dashed border even without a URL.",Se.appendChild(be),Se.appendChild(ke),ee.appendChild(Se),ee.appendChild($e),ce.appendChild(ee);const g=document.createElement("input");g.type="text",g.placeholder=Ot.color.primary,ce.appendChild(ge("Color",g,"Optional badge color (hex or CSS color)."));const Te=document.createElement("input");Te.type="number",Te.min=String(Ia),Te.max=String(Ca),Te.inputMode="numeric",Te.placeholder=`${Ia}-${Ca}`,ce.appendChild(ge("Stage",Te,"Optional 1 (far left) to 4 (far right) when Center view is on."));const Ye=document.createElement("textarea");Ye.rows=2,Ye.placeholder="Comma or space separated ids",ce.appendChild(ge("Dependencies",Ye,"Use item IDs, separated by commas or spaces."));const et=document.createElement("div");et.className="item-editor__checkbox";const We=document.createElement("label");We.className="item-editor__checkbox-row";const dt=document.createElement("input");dt.type="checkbox";const tt=document.createElement("span");tt.textContent="Sync ID while editing name";const ct=document.createElement("div");ct.className="item-editor__hint",ct.textContent="Turn off to keep typing names without changing the ID.",We.appendChild(dt),We.appendChild(tt),et.appendChild(We),et.appendChild(ct),ce.appendChild(et);const ft=document.createElement("div");ft.className="item-editor__actions";const mt=document.createElement("button");mt.type="button",mt.className="pf-v5-c-button pf-m-tertiary",mt.textContent="Cancel";const k=document.createElement("button");return k.type="submit",k.className="pf-v5-c-button pf-m-primary",k.textContent="Save",ft.appendChild(mt),ft.appendChild(k),ce.appendChild(ft),x.wrapper=W,x.fields={idInput:lt,nameInput:O,logoInput:Z,externalInput:I,externalFlagInput:be,colorInput:g,stageInput:Te,depsInput:Ye,syncCheckbox:dt,categoryValue:at.querySelector(".item-editor__meta-value"),errorEl:se},mt.addEventListener("click",G),Oe.addEventListener("click",G),q.addEventListener("click",G),lt.addEventListener("input",()=>{x.autoIdManuallyEdited=!0}),O.addEventListener("input",Me),dt.addEventListener("change",()=>{x.autoSyncEnabled=!!dt.checked,x.autoSyncEnabled&&(x.autoIdManuallyEdited=!1,Me({force:!0}))}),ce.addEventListener("submit",b=>{b.preventDefault(),qe()}),document.addEventListener("keydown",b=>{b.key==="Escape"&&!W.hidden&&(b.preventDefault(),b.stopPropagation(),G())}),document.body.appendChild(W),W}function ze(W){const q=r(W);if(!q)return!1;je(),x.categoryId=q.category.id,x.itemId=q.item.id,x.modelData=q.modelData,x.autoIdManuallyEdited=!1;const ve=!!ne();return x.autoSyncEnabled=ve,x.fields.categoryValue.textContent=q.category.title||q.category.id,x.fields.idInput.value=q.item.id||"",x.fields.nameInput.value=q.item.name||"",x.fields.logoInput.value=q.item.logo||"",x.fields.externalInput.value=typeof q.item.external=="string"?q.item.external:"",x.fields.externalFlagInput.checked=q.item.external===!0,x.fields.colorInput.value=q.item.color||"",x.fields.stageInput.value=q.item.stage??"",x.fields.depsInput.value=Array.isArray(q.item.deps)?q.item.deps.join(", "):"",x.fields.syncCheckbox.checked=x.autoSyncEnabled,x.fields.syncCheckbox.disabled=!ve,!x.fields.idInput.value&&ve&&Me({force:!0}),re(""),j(q.item.id),ie(),!0}return{open:ze,hide:G,isOpen:()=>!!x.wrapper&&!x.wrapper.hidden}}function rc({menuEl:r,previewEl:c,previewTitleEl:f,previewBodyEl:T,previewActionsEl:C,previewCloseEl:j,escapeHtml:Q,onEditItem:J,onChangeColor:ne,selectItem:x,colorPresets:re=[]}={}){const G=r||(()=>{const O=document.createElement("div");return O.className="tile-context-menu",O.hidden=!0,O.setAttribute("aria-hidden","true"),document.body.appendChild(O),O})();let ie={x:0,y:0},Me=0,Qe=Array.isArray(re)?re:[];function qe(){G&&(G.classList.remove("is-open"),G.hidden=!0,G.setAttribute("aria-hidden","true"),G.innerHTML="")}function je(O=[]){C&&(C.innerHTML="",O.forEach(Z=>{const I=document.createElement("button");I.type="button",I.className="item-preview__action",I.textContent=Z.label||"Action",Z.title&&(I.title=Z.title),I.addEventListener("click",ee=>{ee.stopPropagation(),typeof Z.onClick=="function"&&Z.onClick(ee)}),C.appendChild(I)}),C.hidden=O.length===0)}function ze(){qe(),c&&(c.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),c.setAttribute("aria-hidden","true"),c.hidden=!0,je([]))}function W(O,Z){c&&(ie={x:O,y:Z},c.hidden=!1,c.setAttribute("aria-hidden","false"),c.classList.add("is-visible"),q(O,Z))}function q(O,Z){if(!c)return;const I=12;c.style.left=`${O+I}px`,c.style.top=`${Z+I}px`;const ee=c.getBoundingClientRect();let Se=ee.left,be=ee.top;ee.right>window.innerWidth-I&&(Se=Math.max(I,window.innerWidth-ee.width-I)),ee.bottom>window.innerHeight-I&&(be=Math.max(I,window.innerHeight-ee.height-I)),c.style.left=`${Se}px`,c.style.top=`${be}px`}function ve(O,Z){var ke;if(!O)return null;const I=O.dataset.id,ee=((ke=O.querySelector(".name"))==null?void 0:ke.textContent)||I||"Preview",Se=I?`${I}.html`:"",be=Se?`items/${Se}`:"";return{id:I,displayName:ee,filename:Se,filepath:be,externalUrl:O.dataset.externalUrl||"",obsidianUrl:O.dataset.obsidianUrl||"",anchorX:(Z==null?void 0:Z.clientX)??0,anchorY:(Z==null?void 0:Z.clientY)??0}}function R(O,Z){const I=document.createElement("button");return I.type="button",I.className="tile-context-menu__item",I.textContent=O,I.addEventListener("click",()=>{qe(),typeof Z=="function"&&Z()}),I}function Ie(O){if(!G)return;G.innerHTML="";const Z=document.createElement("div");Z.className="tile-context-menu__list",Z.appendChild(R("File view",()=>ce(O))),typeof J=="function"&&Z.appendChild(R("Edit",()=>J(O.id))),typeof ne=="function"&&O.id&&Qe.forEach(I=>{if(!(I!=null&&I.value))return;const ee=I.name||I.value;Z.appendChild(R(`Set color: ${ee}`,()=>ne(O.id,I.value)))}),G.appendChild(Z)}function Oe(O,Z){if(!G)return;const I=4;G.style.left=`${O+I}px`,G.style.top=`${Z+I}px`,G.hidden=!1,G.setAttribute("aria-hidden","false"),G.classList.add("is-open");const ee=G.getBoundingClientRect();let Se=ee.left,be=ee.top;ee.right>window.innerWidth-I&&(Se=Math.max(I,window.innerWidth-ee.width-I)),ee.bottom>window.innerHeight-I&&(be=Math.max(I,window.innerHeight-ee.height-I)),G.style.left=`${Se}px`,G.style.top=`${be}px`}async function ce(O){if(!c||!f||!T||!O)return;const Z=++Me,I=[];if(typeof J=="function"&&O.id&&I.push({label:"Edit",title:"Edit this item",onClick:()=>{ze(),J(O.id)}}),O.externalUrl&&I.push({label:"Open link ↗",title:O.externalUrl,onClick:()=>window.open(O.externalUrl,"_blank","noopener")}),O.obsidianUrl&&I.push({label:"Open in Obsidian",title:O.obsidianUrl,onClick:()=>window.open(O.obsidianUrl,"_blank","noopener")}),je(I),O.id&&typeof x=="function"&&x(O.id),f.textContent=O.displayName,T.innerHTML='<div class="item-preview__status">Loading…</div>',c.classList.remove("item-preview--has-frame"),c.classList.add("item-preview--expanded"),W(O.anchorX,O.anchorY),!O.filepath){T.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',q(ie.x,ie.y);return}try{const ee=await fetch(O.filepath,{cache:"no-cache"});if(!ee.ok)throw new Error(`HTTP ${ee.status}`);const Se=await ee.text();if(Z!==Me)return;if(!Se.trim()){const $e=Q?Q(O.filename):O.filename;T.innerHTML=`<div class="item-preview__status">No content in <code>${$e}</code>.</div>`,q(ie.x,ie.y);return}const ke=document.createElement("iframe");ke.className="item-preview__frame",ke.title=`${O.displayName} details`,ke.srcdoc=Se,T.innerHTML="",T.appendChild(ke),c.classList.add("item-preview--has-frame"),q(ie.x,ie.y)}catch(ee){if(Z!==Me)return;const Se=Q?Q(O.displayName):O.displayName;T.innerHTML=`<div class="item-preview__status">No preview available for <strong>${Se}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${O.filepath}`,ee),q(ie.x,ie.y)}}function at(O,Z){if(!Z)return;O.preventDefault(),O.stopPropagation();const I=ve(Z,O);!I||!I.id||(typeof x=="function"&&x(I.id),Ie(I),Oe(O.clientX,O.clientY))}function se(O){const Z=O==null?void 0:O.target,I=G&&!G.hidden&&G.contains(Z),ee=c&&!c.hidden&&c.contains(Z);!I&&!ee&&ze()}function ge(){!c||c.hidden||q(ie.x,ie.y)}function lt(){ze()}return j&&j.addEventListener("click",ze),{handleTileContextMenu:at,hidePreview:ze,hideMenu:qe,handleDocumentClick:se,handleWindowResize:ge,handleWindowScroll:lt,updateColorPresets:O=>{Qe=Array.isArray(O)?O:[]}}}function Kr(r,c="series"){return(r||c).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||c}function bn(r,c="series"){const f=Kr(r,c).replace(/\./g,"-");return f.replace(/-series$/i,"").replace(/-+$/,"")||f||Kr(c,"series")}function qr(r,{seriesName:c,fallbackTitle:f="unknown"}={}){var J,ne;const C=[r==null?void 0:r.seriesId,(J=r==null?void 0:r.data)==null?void 0:J.seriesId,r==null?void 0:r.apicurioArtifactId,c,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(ne=r==null?void 0:r.data)==null?void 0:ne.title,f].map(x=>(x??"").toString().trim()),j=C.findIndex(Boolean),Q=j!==-1?C[j]:"";return Q?(console.log("[Series] deriveSeriesId: picked base",{base:Q,sourceIndex:j,candidates:C}),bn(Q,f)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:f}),null)}function Pt(r,{seriesName:c,fallbackTitle:f="unknown"}={}){if(!r||typeof r!="object")return null;const T=qr(r,{seriesName:c,fallbackTitle:f});return T?(r.seriesId=T,r.apicurioArtifactId||(r.apicurioArtifactId=T),T):null}function $n(r,c={}){var C,j;if(!r)return null;const f=r.isSeries||((C=r.apicurioVersions)==null?void 0:C.length)>1||r.seriesId||((j=r.data)==null?void 0:j.seriesId)||r.apicurioArtifactId;if(!f&&!c.force)return null;const T=qr(r,c);return T||(f?bn(c.fallbackTitle||"unknown"):null)}const Yr={selectionDimOpacity:.2,selectionDimEnabled:!0},Kn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,c=!0)=>{const f=Math.round((1-r)*100);return c?f===0?"Off":`${f}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function io(r){return r===!0||r==="true"||r===1||r==="1"}function sc(r,{localBackend:c}={}){const f=c&&typeof c.getAutoReloadConfig=="function"&&c.getAutoReloadConfig(),T={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness};return f&&(T.autoReloadEnabled=!!f.enabled,T.autoReloadIntervalMs=f.intervalMs),T}function lc(r={},c){var mt,k,b,Ne;if(!r||typeof r!="object")return{applied:[]};const f=[],{applyTheme:T,applyTileHoverScale:C,persistTileHoverScale:j,applySelectionDimEnabled:Q,persistSelectionDimEnabled:J,applySelectionDimOpacity:ne,persistSelectionDimOpacity:x,applyTileCompactness:re,persistTileCompactness:G,applyTitleWrapMode:ie,persistTitleWrapMode:Me,applyTitleHoverWidthMultiplier:Qe,persistTitleHoverWidthMultiplier:qe,applyTitleHoverTextPortion:je,persistTitleHoverTextPortion:ze,applyLinkThickness:W,persistLinkThickness:q,applyDepColor:ve,persistDepColor:R,applyRevdepColor:Ie,persistRevdepColor:Oe,applyObsidianLinksEnabled:ce,persistObsidianLinksEnabled:at,applyObsidianLinkMode:se,persistObsidianLinkMode:ge,applyObsidianVaultName:lt,persistObsidianVaultName:O,applyAutoIdFromNameEnabled:Z,persistAutoIdFromNameEnabled:I,applySeriesNavDoubleClickWait:ee,persistSeriesNavDoubleClickWait:Se,applyCenterItems:be,persistCenterItems:ke,localBackend:$e,ui:g,refreshObsidianLinks:Te,scheduleOverlaySync:Ye,selection:et,select:We,clearStyles:dt,drawLinks:tt,applyReusedHighlights:ct,current:ft}=c;if(r.theme){const pe=((T==null?void 0:T(r.theme))||r.theme)==="dark";(mt=c.ui)!=null&&mt.themeToggle&&(c.ui.themeToggle.checked=pe),(k=c.ui)!=null&&k.tabThemeToggle&&(c.ui.tabThemeToggle.checked=pe),f.push("theme")}if(r.hoverScale!=null){const y=C(parseFloat(r.hoverScale));j(y),g!=null&&g.hoverScaleInput&&(g.hoverScaleInput.value=String(y)),g!=null&&g.hoverScaleValue&&(g.hoverScaleValue.textContent=Kn.hoverScale(y)),et&&Ye(),f.push("hoverScale")}if(r.selectionDimEnabled!=null){const y=Q(io(r.selectionDimEnabled));J(y),g!=null&&g.selectionDimToggle&&(g.selectionDimToggle.checked=y),g!=null&&g.selectionDimInput&&(g.selectionDimInput.disabled=!y),g!=null&&g.selectionDimValue&&(g.selectionDimValue.textContent=Kn.selectionDimming(ft.selectionDimOpacity??Yr.selectionDimOpacity,y)),f.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const y=ne(parseFloat(r.selectionDimOpacity));x(y),g!=null&&g.selectionDimInput&&(g.selectionDimInput.value=String(y)),g!=null&&g.selectionDimValue&&(g.selectionDimValue.textContent=Kn.selectionDimming(y,ft.selectionDimEnabled??Yr.selectionDimEnabled)),f.push("selectionDimOpacity")}if(r.tileCompactness!=null){const y=re(parseFloat(r.tileCompactness));G(y),g!=null&&g.tileCompactnessInput&&(g.tileCompactnessInput.value=String(y)),g!=null&&g.tileCompactnessValue&&(g.tileCompactnessValue.textContent=Kn.compactness(y)),et&&Ye(),f.push("tileCompactness")}if(r.titleWrapMode){const y=ie(r.titleWrapMode);Me(y),g!=null&&g.titleWrapInput&&(g.titleWrapInput.checked=y!=="nowrap"),f.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const y=Qe(parseFloat(r.titleHoverWidthMultiplier));qe(y),g!=null&&g.titleWidthInput&&(g.titleWidthInput.value=String(y)),g!=null&&g.titleWidthValue&&(g.titleWidthValue.textContent=Kn.titleWidth(y)),f.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const y=je(parseFloat(r.titleHoverTextPortion));ze(y),g!=null&&g.titleZoomInput&&(g.titleZoomInput.value=String(y)),g!=null&&g.titleZoomValue&&(g.titleZoomValue.textContent=Kn.titleZoomPortion(y)),f.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const y=ce(io(r.obsidianLinksEnabled));at(y),g!=null&&g.obsidianToggle&&(g.obsidianToggle.checked=y),(b=g==null?void 0:g.obsidianModeInputs)==null||b.forEach(pe=>{pe.disabled=!y}),g!=null&&g.obsidianVaultInput&&(g.obsidianVaultInput.disabled=!y),Te==null||Te(),f.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const y=se(r.obsidianLinkMode);ge(y),(Ne=g==null?void 0:g.obsidianModeInputs)==null||Ne.forEach(pe=>{pe.checked=pe.value===y}),Te==null||Te(),f.push("obsidianLinkMode")}if(r.obsidianVault!=null){const y=lt(r.obsidianVault);O(y),g!=null&&g.obsidianVaultInput&&(g.obsidianVaultInput.value=y),Te==null||Te(),f.push("obsidianVault")}if(r.colorPresets&&(typeof c.setColorPresets=="function"&&c.setColorPresets(r.colorPresets),f.push("colorPresets")),r.linkThickness){const y=W==null?void 0:W(r.linkThickness);y&&(q==null||q(y),g!=null&&g.linkThicknessInput&&(g.linkThicknessInput.value=y),f.push("linkThickness"))}if(r.depColor){const y=ve==null?void 0:ve(r.depColor);y&&(R==null||R(y),g!=null&&g.depColorInput&&(g.depColorInput.value=y),f.push("depColor"))}if(r.revdepColor){const y=Ie==null?void 0:Ie(r.revdepColor);y&&(Oe==null||Oe(y),g!=null&&g.revdepColorInput&&(g.revdepColorInput.value=y),f.push("revdepColor"))}if(r.autoIdFromName!=null){const y=Z(io(r.autoIdFromName));I(y),g!=null&&g.autoIdToggle&&(g.autoIdToggle.checked=y),f.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const y=ee(parseInt(r.seriesNavDoubleClickMs,10));Se(y),g!=null&&g.seriesNavInput&&(g.seriesNavInput.value=String(y)),g!=null&&g.seriesNavValue&&(g.seriesNavValue.textContent=Kn.seriesNavWait(y)),f.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&$e&&typeof $e.setAutoReloadEnabled=="function"){const y=io(r.autoReloadEnabled);$e.setAutoReloadEnabled(y),g!=null&&g.autoReloadToggle&&(g.autoReloadToggle.checked=y),g!=null&&g.autoReloadInput&&(g.autoReloadInput.disabled=!y),f.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&$e&&typeof $e.setAutoReloadInterval=="function"){const y=$e.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));g!=null&&g.autoReloadInput&&(g.autoReloadInput.value=String(y)),g!=null&&g.autoReloadValue&&(g.autoReloadValue.textContent=Kn.autoReloadInterval(y)),f.push("autoReloadIntervalMs")}if(r.centerItems!=null){const y=be==null?void 0:be(io(r.centerItems));ke==null||ke(y),g!=null&&g.tabCenterToggle&&(g.tabCenterToggle.checked=y),f.push("centerItems")}if(r.showSecondaryLinks!=null){const y=io(r.showSecondaryLinks);typeof c.setShowSecondaryLinks=="function"?c.setShowSecondaryLinks(y):c.showSecondaryLinks=y,g!=null&&g.secondaryLinksToggle&&(g.secondaryLinksToggle.checked=y),g!=null&&g.tabSecondaryLinksToggle&&(g.tabSecondaryLinksToggle.checked=y),et?We(et):(dt(),tt()),f.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const y=io(r.showReusedInMap);typeof c.setShowReusedInMap=="function"?c.setShowReusedInMap(y):c.showReusedInMap=y,g!=null&&g.reusedToggle&&(g.reusedToggle.checked=y),ct==null||ct(),f.push("showReusedInMap")}return{applied:f}}function cc(r,c){const f=new Blob([c],{type:"application/json"}),T=URL.createObjectURL(f),C=document.createElement("a");C.href=T,C.download=r,C.click(),URL.revokeObjectURL(T)}const Di=typeof{url:Bn&&Bn.tagName.toUpperCase()==="SCRIPT"&&Bn.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function dc(r={}){console.log("[Blockscape] init");const c={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},f=document.getElementById("jsonBox"),T=document.querySelector(".blockscape-json-panel"),C=document.getElementById("app"),j=document.getElementById("overlay"),Q=document.getElementById("tabTooltip"),J=document.getElementById("modelList"),ne=document.getElementById("itemPreview"),x=document.getElementById("urlForm"),re=document.getElementById("urlInput"),G=document.getElementById("loadUrl"),ie=ne.querySelector(".item-preview__title"),Me=ne.querySelector(".item-preview__body"),Qe=ne.querySelector(".item-preview__actions"),qe=ne.querySelector(".item-preview__close"),je=document.getElementById("downloadJson"),ze=document.getElementById("shareModel"),W=document.getElementById("createVersion"),q=document.getElementById("openInEditor"),ve=document.getElementById("copyJson"),R=document.getElementById("copySeries"),Ie=document.getElementById("pasteJson"),Oe=document.getElementById("helpButton"),ce=document.getElementById("newPanelButton"),at=document.getElementById("newBlankButton"),se=document.getElementById("shortcutHelp"),ge=document.getElementById("shortcutHelpList"),lt=document.getElementById("shortcutHelpClose"),O=document.getElementById("shortcutHelpBackdrop"),Z=document.getElementById("newPanel"),I=document.getElementById("newPanelClose"),ee=document.getElementById("newPanelBackdrop"),Se=document.getElementById("search"),be=document.getElementById("searchResults"),ke=document.getElementById("localBackendPanel"),$e=document.getElementById("localBackendStatus"),g=document.getElementById("localFileList"),Te=document.getElementById("localDirSelect"),Ye=document.getElementById("refreshLocalFiles"),et=document.getElementById("loadLocalFile"),We=document.getElementById("saveLocalFile"),dt=document.getElementById("saveLocalFileAs"),tt=document.getElementById("localSavePath"),ct="blockscape:editorPayload",ft="blockscape:editorTransfer",mt=document.title;ke&&(ke.hidden=!0),!c.localBackend&&ke&&(ke.hidden=!0),c.fileOpen||(et&&(et.hidden=!0),Te&&(Te.hidden=!0),Ye&&(Ye.hidden=!0),g&&(g.hidden=!0)),c.fileSave||(We&&(We.hidden=!0),dt&&(dt.hidden=!0),tt&&(tt.hidden=!0)),f.value=document.getElementById("seed").textContent.trim();let k=[],b=-1;const Ne=ec({models:k,getActiveIndex:()=>b,setActive:xt,ensureModelMetadata:An,getModelId:pt,getSeriesId:$n,ensureSeriesId:Pt,getModelTitle:Ge,computeJsonFingerprint:qi,uid:co});let y=null,pe=new Map,jt=new Map,H=null,Ue=null,It=null,nt=null,nn=!0,Rn=!1,zt=!1,ln="map",Gt=null,Vt=null,ao=!1,On=null;const qn=2e3;let Dt=null,Xt=null,wn=null,Zt=null,Jt=null,Ct=null,on=null,vn=null,an=null,yn="",d=!1,v=null;const M=new Map;let B=null,E=null,D=[],X=null;const Y=30,ye=1e3,Ee="blockscape:hoverScale",me=1.5,He=1,Xe=2.5,he="blockscape:selectionDimOpacity",Rt="blockscape:selectionDimEnabled",bt=.2,de=.05,oe=1,ht="blockscape:titleWrap",cn="blockscape:titleHoverWidth",rt="blockscape:titleHoverTextPortion",_t="wrap",wt=1.3,_n=1,dn=1.6,xn=.25,ro=0,_a=.6,es="blockscape:tileCompactness",ii=1,ts=.75,ns=1.25,os="blockscape:obsidianLinksEnabled",is="blockscape:obsidianLinkMode",as="blockscape:obsidianVault",xa="title",Ui="id",Hi=xa,rs="blockscape:autoReloadEnabled",ss="blockscape:autoReloadIntervalMs",ai=1e3,ls=500,cs=1e4,ds="blockscape:autoIdFromName",Fi=!0,us="blockscape:colorPresets",ps="blockscape:centerItems",fs="blockscape:theme",ms=4,ko=1,Wi=4,hs="0.2rem",Io="light",so="dark",ji="cat:",zi=!1,gs="blockscape:depColor",bs="blockscape:revdepColor",ws="blockscape:linkThickness",vs=6,ys={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let Co=me,Pn=bt,Vn=!0,_o=ii,Aa=_t,xo=wt,Ao=xn,To=!1,ri=Hi,No="",lo=Fi,si=Io,Kt=[],ut=zi,Gi="",Ji="",li="m",Lo=null,Ta=null;const Es="blockscape:seriesNavDoubleClickMs",ci=900,Ss=300,ks=4e3;let Dn=ci;const Ae={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null},Ac={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:ai}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},Je=c.localBackend?Kc():Ac,Is=c.localBackend?Je.detect():Promise.resolve(!1);Ne.hydrateConfig(),Na(Rc()),$o(Wc(),{silent:!0}),Vc(),Dc(),Fc(),sd(),ld(),ud(),md(),pd(),fd(),wd(),Ed(),yd(),Sd(),cd(),dd(),Pc(),Yt();function co(){return Math.random().toString(36).slice(2,10)}function Tc(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function Nc(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function Lc(e){return Tc(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Mc(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Nc(t)}const Cs=(e,t)=>cc(e,t);function _s(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function Bc(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await Cl(i),s=JSON.parse(a),l=_s(s);if(l)return l}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function $c(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];c.initialSettings&&t.push({type:"inline",snapshot:c.initialSettings}),c.initialSettingsUrl&&t.push({type:"url",url:c.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?_s(o.snapshot):await Bc(o.url);if(!i)continue;const a=zs(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function Rc(){if(typeof window>"u"||!window.localStorage)return Io;try{return window.localStorage.getItem(fs)===so?so:Io}catch{return Io}}function Oc(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(fs,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function Na(e){const t=e===so?so:Io;return si=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),Oc(t),si}function xs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ps,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function Mo(e){return ut=!!e,C&&(C.classList.toggle("is-center-mode",ut),C.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",ut)}),C.querySelectorAll(".tile-add").forEach(t=>{t.hidden=ut,t.tabIndex=ut?-1:0,t.setAttribute("aria-hidden",ut?"true":"false")}),C.querySelectorAll(".category-add").forEach(t=>{t.hidden=ut,t.tabIndex=ut?-1:0,t.setAttribute("aria-hidden",ut?"true":"false")})),Ts(),As(),y&&(oa(),En()),ut}function Pc(){if(typeof window>"u"||!window.localStorage)return Mo(zi);try{const e=window.localStorage.getItem(ps);return e==null?Mo(zi):Mo(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),Mo(zi)}}function di(e){if(e==null)return null;const t=Number(e);if(!Number.isFinite(t))return null;const n=Math.round(t);return n<ko||n>Wi?null:n}function As(){if(!C)return;const e=`repeat(${ms}, minmax(var(--blockscape-tile), 1fr))`;C.querySelectorAll(".grid").forEach(t=>{const n=Array.from(t.querySelectorAll(".tile[data-stage]")).map((m,S)=>({tile:m,stage:di(m.dataset.stage),order:S})),o=n.some(m=>m.stage),i=ut&&o;i?(t.style.gridTemplateColumns=e,t.style.gridAutoFlow="row",t.style.justifyContent="space-between",t.style.justifyItems="start",t.style.columnGap=hs,t.style.rowGap=hs):(t.style.removeProperty("grid-template-columns"),t.style.removeProperty("grid-auto-flow"),t.style.removeProperty("justify-content"),t.style.removeProperty("justify-items"),t.style.removeProperty("column-gap"),t.style.removeProperty("row-gap"));const a=m=>{m.style.removeProperty("grid-column"),m.style.removeProperty("grid-row")};if(t.querySelectorAll(".tile").forEach(a),!i)return;const s=n.filter(m=>m.stage).sort((m,S)=>m.stage!==S.stage?m.stage-S.stage:m.order-S.order),l=(m,S,P)=>{if(S.has(m)&&S.get(m)===P)return{col:m,needsNewRow:!0};const N=ms-1;for(let L=0;L<=N;L+=1){const V=[];m-L>=ko&&V.push(m-L),L!==0&&m+L<=Wi&&V.push(m+L);for(const te of V)if(!S.has(te))return{col:te,needsNewRow:!1}}return{col:null,needsNewRow:!1}};let u=1,h=new Map;s.forEach(({tile:m,stage:S})=>{let P=l(S,h,S);P.needsNewRow&&(u+=1,h=new Map,P=l(S,h,S)),P.col!=null&&(h.set(P.col,S),m.style.gridColumn=String(P.col),m.style.gridRow=String(u))})}),Ts()}function Ts(){Ta&&(Ta.hidden=!ut)}function Bo(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Ns(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function La(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function Ls(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=Bo(i[1]);if(a)return La(a,n);if(t){const s=Bo(t);if(s)return La(s,n)}}return La(o,n)}function Ms(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function Ma(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(gs,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function Ba(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(bs,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function $a(e){const t=Ls(e,{fallbackVar:"--color-primary",fallbackColor:Ot.color.primary});return Gi=t,Ns("--blockscape-dep",t),j&&En(),Gi}function Ra(e){const t=Ls(e,{fallbackVar:"--color-danger",fallbackColor:Ot.blockscape.revdep});return Ji=t,Ns("--blockscape-revdep",t),j&&En(),Ji}function Vc(){const e=Ms(gs),t=$a(e||Bo("--blockscape-dep")||Ot.color.primary);return Ma(t),t}function Dc(){const e=Ms(bs),t=Ra(e||Bo("--blockscape-revdep")||Ot.blockscape.revdep);return Ba(t),t}function Uc(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function Hc(){return ys[li]||ys.m}function ui(e){return li=Uc(e),En(),li}function Oa(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ws,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function Fc(){if(typeof window>"u"||!window.localStorage)return ui("m");try{const e=window.localStorage.getItem(ws),t=ui(e||"m");return Oa(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),ui("m")}}function Bs(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return pi();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:pi()}function pi(){return[{name:"Black",value:Ot.color.ink},{name:"White",value:Ot.color.white},{name:"Red",value:Ot.blockscape.revdep},{name:"Green",value:Ot.color.success}]}function Wc(){if(typeof window>"u"||!window.localStorage)return pi();try{const e=window.localStorage.getItem(us);if(!e)return pi();const t=JSON.parse(e);return Bs(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),pi()}}function jc(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(us,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function $o(e,{silent:t=!1}={}){return Kt=Bs(e),jc(Kt),!t&&typeof Jo=="function"&&Jo(Kt),Lo==null||Lo(),Kt}function zc(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function Ki(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=uo(e);if(!o)return;const i=k[b],a=uo(i==null?void 0:i.sourcePath),s=t??(a&&a===o?pt(i):null),l=n??(a&&a===o?H:null),u=o.split("/").filter(Boolean).map(S=>encodeURIComponent(S)),h=s?encodeURIComponent(s):null,m=l?encodeURIComponent(l):null;try{const S=new URL(window.location.href),P=new URLSearchParams(S.search);P.delete("load"),P.delete("share");const N=["","server",...u,...h?[h]:[],...m?[m]:[]].join("/").replace(/\/+/g,"/");S.pathname=N,S.search=P.toString()?`?${P.toString()}`:"",S.hash="",window.history.replaceState({},document.title,S.toString())}catch(S){console.warn("[Blockscape] failed to update URL for server path",S)}}function Gc(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(V=>V.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex(V=>V.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),l=i.slice(a+1),u=V=>{try{return decodeURIComponent(V)}catch{return V}},h=s.map(u),m=l.map(u),S=h.join("/"),P=uo(S);if(!P)return null;const N=m[0]?m[0].trim():null,L=m[1]?m[1].trim():null;return{path:P,modelId:N||null,itemId:L||null}}function Pa({itemId:e}={}){const t=k[b];t!=null&&t.sourcePath&&Ki(t.sourcePath,{modelId:pt(t),itemId:e===void 0?H:e})}function Jc(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function Kc(){const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(_,z={}){console.log("[Blockscape][local-backend]",_,{...e(),...z})}if(Jc())return t("Disabled on github.io host"),ke&&(ke.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!zc()||!ke||!$e)return t("Opt-in flag missing or panel unavailable"),ke&&(ke.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!ke||!$e)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],l="",u=new Map,h=V(),m=Be(),S=null,P=!1;const N=new Set;function L(){return N.size>0}function V(){if(typeof window>"u"||!window.localStorage)return!0;try{const _=window.localStorage.getItem(rs);return _==null?!0:_==="true"}catch{return!0}}function te(_){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(rs,_?"true":"false")}catch(z){console.warn("[Blockscape] auto-reload: failed to persist",z)}}function Be(){if(typeof window>"u"||!window.localStorage)return ai;try{const _=window.localStorage.getItem(ss);if(!_)return ai;const z=parseInt(_,10);return Ce(z)}catch{return ai}}function st(_){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ss,String(_))}catch(z){console.warn("[Blockscape] auto-reload: failed to persist interval",z)}}function Ce(_){return Number.isFinite(_)?Math.min(cs,Math.max(ls,_)):ai}function Le(_){if(!_)return"";const z=_.split("/").filter(Boolean);return z.pop(),z.join("/")}function ot(_,{error:z=!1}={}){$e.textContent=_,$e.style.color=z?Ot.color.dangerStrong:"",t("Status",{text:_,error:z})}function De(_){return uo(_)}function Tt(_){const z=Qi(_);return z?{payload:z,isSeries:!0}:{payload:_==null?void 0:_.data,isSeries:!1}}function Ut(){var z;if(b>=0&&((z=k[b])!=null&&z.sourcePath))return k[b].sourcePath;if(b<0)return"blockscape.bs";const _=Ge(k[b])||"blockscape";return`${bn(_,"blockscape")}.bs`}function Nt(){var _;tt&&(tt.placeholder=Ut(),(_=k[b])!=null&&_.sourcePath&&(tt.value=k[b].sourcePath))}function _e(){if(!Te)return;Te.innerHTML="";const _=document.createElement("option");_.value="",_.textContent="All (~/blockscape)",Te.appendChild(_),s.forEach(ae=>{const le=document.createElement("option");le.value=ae,le.textContent=ae||"(root)",Te.appendChild(le)});const z=s.includes(l)?l:"";Te.value=z,l=z}function Et(){if(!g)return;g.innerHTML="";const _=l?a.filter(z=>z.path.startsWith(`${l}/`)):a;if(!_.length){const z=document.createElement("option");z.disabled=!0,z.textContent="No .bs files found yet",g.appendChild(z),g.disabled=!0;return}g.disabled=!1,_.forEach(z=>{const ae=document.createElement("option");ae.value=z.path;const le=z.mtimeMs?new Date(z.mtimeMs).toLocaleString():"";ae.textContent=le?`${z.path} · ${le}`:z.path,g.appendChild(ae)}),i&&Array.from(g.options).forEach(z=>{z.value===i&&(z.selected=!0)}),!g.value&&g.options.length&&(g.options[0].selected=!0)}function Sn(_){if(!o||!g||!_||!a.find(Ze=>Ze.path===_))return;const ae=Le(_);ae!==l&&(l=ae,_e()),Et(),Array.from(g.options).forEach(Ze=>{Ze.selected=Ze.value===_});const le=Array.from(g.options).find(Ze=>Ze.value===_);le!=null&&le.scrollIntoView&&le.scrollIntoView({block:"nearest"}),tt&&(tt.value=_)}function zn(){S&&(clearInterval(S),S=null)}function St(){zn(),!(!o||!h||L())&&(S=setInterval(en,m))}function Ht(_){if(!_)return;const z=N.size;N.add(_),N.size!==z&&(t("Auto-reload paused",{reason:_}),St())}function rn(_){if(!_)return;N.delete(_)&&(t("Auto-reload resumed",{reason:_}),St())}async function Qt(_){const z=k.findIndex(ae=>ae.sourcePath===_);if(z!==-1)try{const ae=await fetch(`/api/file?path=${encodeURIComponent(_)}`,{cache:"no-store"});if(!ae.ok)throw new Error(`HTTP ${ae.status}`);const le=await ae.json(),Ze=JSON.stringify(le.data??le,null,2),Lt=Hn(Ze,_,{seriesTitleOverride:`${_} series`});if(!Lt.length)return;const we=Lt[0];if(we.sourcePath=_,An(we,{titleHint:Ge(k[z]),idHint:pt(k[z])}),we.isSeries){const it=we.title||Ge(we)||Ge(k[z]),sn=bn(it||"unknown");po(we,sn),Pt(we,{seriesName:it||"unknown",fallbackTitle:"unknown"})}k[z]={...k[z],...we,title:we.title||Ge(we),data:we.data,sourcePath:_},z===b?(At(),yt()):Un(),console.log("[Blockscape] auto-reloaded model from",_)}catch(ae){console.warn("[Blockscape] auto-reload failed for",_,ae)}}async function en(){if(!(!o||!h||L()||P)){P=!0;try{const _=await fetch("/api/files",{cache:"no-store"});if(!_.ok)throw new Error(`HTTP ${_.status}`);const ae=((await _.json()).files||[]).slice().sort((we,it)=>{const sn=(we==null?void 0:we.mtimeMs)||0,In=(it==null?void 0:it.mtimeMs)||0;return sn===In?(we.path||"").localeCompare(it.path||""):In-sn}),le=new Map;ae.forEach(we=>le.set(we.path,we.mtimeMs||0));const Ze=k.map((we,it)=>({path:we.sourcePath,idx:it})).filter(we=>we.path);for(const we of Ze){const it=u.get(we.path)||0;(le.get(we.path)||0)>it&&await Qt(we.path)}a=ae;const Lt=new Set;a.forEach(we=>Lt.add(Le(we.path))),s=Array.from(Lt).filter(we=>we!=="").sort(),u=le,_e(),Et()}catch(_){console.warn("[Blockscape] auto-reload check failed",_)}finally{P=!1}}}function Ke(_){h=!!_,te(h),St()}function Zo(_){return m=Ce(_),st(m),St(),m}function tn(_){o=!1,a=[],u=new Map,zn(),Et(),ke.hidden=!0,_&&ot(_,{error:!0}),t("Panel hidden",{message:_})}async function go({silent:_=!1}={}){try{t("Health check start");const z=await fetch("/api/health",{cache:"no-store"});if(!z.ok)throw new Error(`HTTP ${z.status}`);const ae=await z.json();if(o=!!(ae!=null&&ae.ok),!o)throw new Error("Health check failed");return ke.hidden=!1,_||ot(ae.root?`Local server ready (root: ${ae.root})`:"Local server ready"),t("Health check ok",{payload:ae}),!0}catch(z){return _||console.log("[Blockscape] local backend health failed",z),tn("Local server unavailable"),!1}}async function kn(){if(o&&g){ot("Loading files…");try{const _=await fetch("/api/files",{cache:"no-store"});if(!_.ok)throw new Error(`HTTP ${_.status}`);a=((await _.json()).files||[]).slice().sort((le,Ze)=>{const Lt=(le==null?void 0:le.mtimeMs)||0,we=(Ze==null?void 0:Ze.mtimeMs)||0;return Lt===we?(le.path||"").localeCompare(Ze.path||""):we-Lt});const ae=new Set;a.forEach(le=>{ae.add(Le(le.path))}),s=Array.from(ae).filter(le=>le!=="").sort(),l&&!ae.has(l)&&(l=""),!l&&i&&(l=Le(i)),u=new Map(a.map(le=>[le.path,le.mtimeMs||0])),_e(),Et(),ot(a.length?`Browsing ${a.length} file(s) in ~/blockscape`:"No .bs files in ~/blockscape yet")}catch(_){console.warn("[Blockscape] local backend refresh failed",_),tn("Local server unavailable")}}}async function Za(){o=!1,tn(),ot("Checking for local server…");try{return t("Detect start"),await go()?(Nt(),await kn(),St(),!0):!1}catch(_){return o=!1,console.log("[Blockscape] local backend not detected",_),t("Detect failed",{err:_}),!1}}async function wi(){if(!o||!g)return;const _=Array.from(g.selectedOptions||[]).map(ae=>ae.value).filter(Boolean).sort((ae,le)=>ae.localeCompare(le));if(!_.length){alert("Select one or more files to load from ~/blockscape.");return}let z=null;for(const ae of _)try{ot(`Loading ${ae}…`);const le=await $s(ae);z==null&&(z=(le==null?void 0:le.firstIndex)??null),i=ae,Ki(ae)}catch(le){console.error("[Blockscape] failed to load from local server",le),alert(`Local load failed for ${ae}: ${le.message}`)}z!=null&&xt(z),ot(`Loaded ${_.length} file(s)`),Et()}async function Qo(_,{statusPrefix:z="Saved to",updateInput:ae=!0}={}){if(!o)return;if(b<0){alert("No active model to save.");return}const le=k[b],{payload:Ze,isSeries:Lt}=Tt(le);if(!Ze){alert("No model data to save.");return}const we=De(_);if(!we){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const it=JSON.stringify(Ze,null,2);ot(`Saving ${Lt?"series":"map"} to ${we}…`);const In=await fetch(`/api/file?path=${encodeURIComponent(we)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:it});if(!In.ok)throw new Error(`HTTP ${In.status}`);const Mt=await In.json();i=Mt.path||we,le.sourcePath=Mt.path||we,ae&&tt&&(tt.value=Mt.path||we),Ki(Mt.path||we),ot(`${z} ${Mt.path||we}`),await kn()}catch(it){console.error("[Blockscape] local save failed",it),alert(`Local save failed: ${it.message}`),tn("Local server unavailable")}}async function vi(){var z;const _=De(tt==null?void 0:tt.value)||De((z=k[b])==null?void 0:z.sourcePath)||Ut();if(!_){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Qo(_,{statusPrefix:"Saved to"})}async function yi(){var le;if(!o)return;if(b<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const _=De((le=k[b])==null?void 0:le.sourcePath)||Ut(),z=window.prompt("Save active map as (under ~/blockscape):",_);if(z==null)return;const ae=De(z);if(!ae){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Qo(ae,{statusPrefix:"Saved to"})}async function Yn(_,z,{refreshAfter:ae=!0,statusPrefix:le="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(_)||_<0)return{ok:!1,error:"Invalid model index"};const Ze=k[_],{payload:Lt,isSeries:we}=Tt(Ze);if(!Lt)return{ok:!1,error:"Model has no data"};const it=De(z)||De(Ze==null?void 0:Ze.sourcePath)||Ut();if(!it)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const sn=JSON.stringify(Lt,null,2);ot(`Saving ${we?"series":"map"} to ${it}…`);const Mt=await fetch(`/api/file?path=${encodeURIComponent(it)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:sn});if(!Mt.ok)throw new Error(`HTTP ${Mt.status}`);const Ln=await Mt.json();return i=Ln.path||it,Ze.sourcePath=Ln.path||it,_===b&&Nt(),ot(`${le} ${Ln.path||it}`),ae&&await kn(),{ok:!0,path:Ln.path||it}}catch(sn){return console.error("[Blockscape] local save failed",sn),tn("Local server unavailable"),{ok:!1,error:sn.message}}}if(Ye&&(Ye.onclick=()=>kn()),et&&(et.onclick=()=>wi()),We&&(We.onclick=()=>vi()),dt&&(dt.onclick=()=>yi()),g&&tt&&(g.addEventListener("change",()=>{const _=Array.from(g.selectedOptions||[])[0];_!=null&&_.value&&(tt.value=_.value)}),g.addEventListener("dblclick",()=>{wi()})),Te&&Te.addEventListener("change",()=>{l=Te.value||"",Et()}),ke){const _="local-files-panel-focus",z="local-files-panel-pointer";let ae=!1,le=!1;ke.addEventListener("focusin",()=>{ae||(ae=!0,Ht(_))}),ke.addEventListener("focusout",Ze=>{if(!ae)return;const Lt=Ze.relatedTarget;Lt&&ke.contains(Lt)||(ae=!1,rn(_))}),ke.addEventListener("pointerenter",()=>{le||(le=!0,Ht(z))}),ke.addEventListener("pointerleave",()=>{le&&(le=!1,rn(z))})}return{detect:Za,refresh:kn,updateActiveSavePlaceholder:Nt,isAvailable:()=>o,highlightSource:Sn,saveModelByIndex:Yn,getAutoReloadConfig:()=>({enabled:h,intervalMs:m,available:o}),setAutoReloadEnabled:Ke,setAutoReloadInterval:Zo}}async function $s(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=Hn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let l=null;return s.forEach((u,h)=>{if(u.sourcePath=e,u.isSeries&&!u.title){const P=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");u.title=P}const m=Tn(u,{versionLabel:s.length>1?`${t} #${h+1}`:t});l==null&&(l=m)}),{firstIndex:l,total:s.length}}async function Rs(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function qc(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function qt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function uo(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function Yc(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Xc(e,t){const n=uo(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function Va(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function fi(){try{await Is}catch{}return typeof(Je==null?void 0:Je.isAvailable)=="function"?Je.isAvailable():!1}async function Zc(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Qc(e,t){const n=uo(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const l=`${a}-${s}.bs`,u=[...o,l].filter(Boolean).join("/");if(!t.has(u))return u}return null}function ed(e,t="clipboard"){const n=Ge(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=qt(n),i=Va();return`${o}-${i}.bs`}function td(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=Yc(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=bn(n||"unknown");return po(e,o),Pt(e,{seriesName:n,fallbackTitle:n}),!0}function nd(e){return Number.isFinite(e)?Math.min(Xe,Math.max(He,e)):me}function Yt(){if(!C)return;const e=!!H||!!Ue;C.classList.toggle("blockscape-has-selection",e),C.classList.toggle("blockscape-has-item-selection",!!H)}function Ro(e){return Co=nd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",Co),Co}function od(e){return Number.isFinite(e)?Math.min(oe,Math.max(de,e)):bt}function Oo(e){Pn=od(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Pn);const t=Vn?Pn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Pn}function id(e){return Number.isFinite(e)?Math.min(ns,Math.max(ts,e)):ii}function Po(e){return _o=id(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",_o),_o}function ad(e){return Number.isFinite(e)?Math.min(dn,Math.max(_n,e)):wt}function Vo(e){return xo=ad(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",xo),xo}function rd(e){return Number.isFinite(e)?Math.min(_a,Math.max(ro,e)):xn}function Do(e){return Ao=rd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Ao),Ao}function Uo(e){const t=e==="nowrap"?"nowrap":"wrap";Aa=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function Os(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ee,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function sd(){if(typeof window>"u"||!window.localStorage)return Ro(me);try{const e=window.localStorage.getItem(Ee);if(!e)return Ro(me);const t=parseFloat(e);return Ro(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Ro(me)}}function Ps(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(he,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function ld(){if(typeof window>"u"||!window.localStorage)return Oo(bt);try{const e=window.localStorage.getItem(he);if(!e)return Oo(bt);const t=parseFloat(e);return Oo(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Oo(bt)}}function Ho(e){Vn=!!e;const t=Vn?Pn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),C&&C.classList.toggle("blockscape-dimming-disabled",!Vn),Vn}function Vs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Rt,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function cd(){if(typeof window>"u"||!window.localStorage)return Ho(!0);try{const e=window.localStorage.getItem(Rt);return e==null?Ho(!0):Ho(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),Ho(!0)}}function Fo(e){return lo=!!e,lo}function Ds(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ds,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function dd(){if(typeof window>"u"||!window.localStorage)return Fo(Fi);try{const e=window.localStorage.getItem(ds);return e==null?Fo(Fi):Fo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Fo(Fi)}}function Us(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(es,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function ud(){if(typeof window>"u"||!window.localStorage)return Po(ii);try{const e=window.localStorage.getItem(es);if(!e)return Po(ii);const t=parseFloat(e);return Po(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Po(ii)}}function Hs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(cn,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function pd(){if(typeof window>"u"||!window.localStorage)return Vo(wt);try{const e=window.localStorage.getItem(cn);if(!e)return Vo(wt);const t=parseFloat(e);return Vo(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Vo(wt)}}function Fs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(rt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function fd(){if(typeof window>"u"||!window.localStorage)return Do(xn);try{const e=window.localStorage.getItem(rt);if(!e)return Do(xn);const t=parseFloat(e);return Do(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Do(xn)}}function Ws(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ht,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function md(){if(typeof window>"u"||!window.localStorage)return Uo(_t);try{const e=window.localStorage.getItem(ht);return Uo(e||_t)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Uo(_t)}}function hd(e){return Number.isFinite(e)?Math.min(ks,Math.max(Ss,e)):ci}function Wo(e){return Dn=hd(e),Dn}function gd(e){nn=!!e}function bd(e){zt=!!e}function js(){return{hoverScale:Co,selectionDimOpacity:Pn,selectionDimEnabled:Vn,tileCompactness:_o,titleWrapMode:Aa,titleHoverWidthMultiplier:xo,titleHoverTextPortion:Ao,obsidianLinksEnabled:To,obsidianLinkMode:ri,obsidianVaultName:No,autoIdFromNameEnabled:lo,seriesNavDoubleClickWaitMs:Dn,showSecondaryLinks:nn,centerItems:ut,showReusedInMap:zt,theme:si,colorPresets:Kt,depColor:Gi,revdepColor:Ji,linkThickness:li}}function zs(e,{refreshObsidianLinks:t}={}){return lc(e,{applyTileHoverScale:Ro,persistTileHoverScale:Os,applySelectionDimEnabled:Ho,persistSelectionDimEnabled:Vs,applySelectionDimOpacity:Oo,persistSelectionDimOpacity:Ps,applyTileCompactness:Po,persistTileCompactness:Us,applyTitleWrapMode:Uo,persistTitleWrapMode:Ws,applyTitleHoverWidthMultiplier:Vo,persistTitleHoverWidthMultiplier:Hs,applyTitleHoverTextPortion:Do,persistTitleHoverTextPortion:Fs,applyObsidianLinksEnabled:zo,persistObsidianLinksEnabled:Ks,applyObsidianLinkMode:jo,persistObsidianLinkMode:Js,applyObsidianVaultName:Go,persistObsidianVaultName:qs,applyAutoIdFromNameEnabled:Fo,persistAutoIdFromNameEnabled:Ds,applySeriesNavDoubleClickWait:Wo,persistSeriesNavDoubleClickWait:Gs,localBackend:Je,ui:Ae,refreshObsidianLinks:t,scheduleOverlaySync:qo,selection:H,select:vt,clearStyles:aa,drawLinks:En,applyReusedHighlights:Ya,setShowSecondaryLinks:gd,setShowReusedInMap:bd,applyDepColor:$a,persistDepColor:Ma,applyRevdepColor:Ra,persistRevdepColor:Ba,applyLinkThickness:ui,persistLinkThickness:Oa,applyTheme:Na,setColorPresets:$o,applyCenterItems:Mo,persistCenterItems:xs,current:js()})}function Gs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Es,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function wd(){if(typeof window>"u"||!window.localStorage)return Wo(ci);try{const e=window.localStorage.getItem(Es);if(!e)return Wo(ci);const t=parseInt(e,10);return Wo(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Wo(ci)}}function vd(e){return e===Ui?Ui:xa}function jo(e){return ri=vd(e),ri}function Js(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(is,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function yd(){if(typeof window>"u"||!window.localStorage)return jo(Hi);try{const e=window.localStorage.getItem(is);return jo(e||Hi)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),jo(Hi)}}function zo(e){return To=!!e,To}function Ks(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(os,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function Ed(){if(typeof window>"u"||!window.localStorage)return zo(!1);try{const e=window.localStorage.getItem(os);return e==null?zo(!1):zo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),zo(!1)}}function Go(e){return No=(e??"").toString().trim(),No}function qs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(as,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Sd(){if(typeof window>"u"||!window.localStorage)return Go("");try{const e=window.localStorage.getItem(as);return Go(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Go("")}}function kd(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Id(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function po(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function Cd(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||Yi(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=$n(e,{seriesName:o,fallbackTitle:o})||bn(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=bn(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,po(e,s),!0}function Da(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>Da(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${Da(e[o])}`).join(",")}}`}function Ys(e){try{return Da(e)}catch{return""}}function qi(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=Ys(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=Ys(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const _d=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category (cycles item.stage in Center view)."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function An(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=qt(a).replace(/\./g,"-");e.id=s||`model-${co()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function xd(e){var s,l;const t=u=>{const h=(u??"").toString().trim();if(!h)return{base:"",suffix:null};const m=h.match(/^(.*?)-(\d+)$/);return{base:m?m[1]:h,suffix:m?Number.parseInt(m[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const u of n){if(u!=null&&u.isCategoryView)continue;const h=t(((l=u==null?void 0:u.data)==null?void 0:l.id)??(u==null?void 0:u.id)??"");if(h.base){i=h.base;break}}i||(i=qt($n(e)||Ua(e)||Ge(e,"model")));let a=0;return n.forEach(u=>{var m;if(u!=null&&u.isCategoryView)return;const h=t(((m=u==null?void 0:u.data)==null?void 0:m.id)??(u==null?void 0:u.id)??"");h.base===i&&Number.isFinite(h.suffix)&&h.suffix>a&&(a=h.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function Ad(e){return JSON.parse(JSON.stringify(e))}function Ge(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function Yi(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=pt(e);return a?`${a} series`:t}return Ge(e,t)}function pt(e){var i;const t=$n(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function Ua(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function Td(e){return e?e.toString().replace(/-series$/i,""):null}function Ha(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<k.length;n++){const o=(pt(k[n])||"").toLowerCase(),i=(Ua(k[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function Xs(e){var l;if(e<0||e>=k.length||!f)return!0;const t=k[e],n=(f.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}An(o,{titleHint:Ge(t),idHint:pt(t)});const i=qi(t.data),a=qi(o);if(i===a)return!0;t.data=o;const s=Fn(t);return s>=0&&((l=t.apicurioVersions)!=null&&l[s])&&(t.apicurioVersions[s].data=o),!0}function Zs(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function Xi(e){if(b<0||!e)return null;const t=k[b].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function Nd(e,t){const n=Xi(e);return n?(t?n.item.color=t:delete n.item.color,At(),yt(),vt(e),!0):!1}function Ld(e){if(b<0||!e)return!1;const t=k[b].data,o=((t==null?void 0:t.categories)||[]).find(a=>a.id===e);if(!o)return!1;let i=!1;return(o.items||[]).forEach(a=>{di(a.stage)!=null&&(delete a.stage,i=!0)}),i?(At(),yt(),H&&vt(H),!0):!1}function Md(e,t){if(!e||!t||b<0)return!1;const n=Xi(e);if(!n)return!1;const o=di(n.item.stage),i=o??(t>0?ko:Wi),a=Wi-ko+1,s=((i-ko+t)%a+a)%a,l=ko+s;return n.item.stage=l,At(),yt(),vt(e),!0}function Bd(e,t){const n=Zs(t);let o=qt(e||"item");if(!n.has(o))return o;const i=()=>co().slice(0,4);for(;n.has(o);)o=`${qt(e||"item")}-${i()}`;return o}function $d(e="category",t){const n=(t==null?void 0:t.categories)||[],o=qt(e||"category"),i=l=>n.some(u=>u.id===l);let a=o||`category-${co()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const fo=ac({findItemAndCategoryById:Xi,collectAllItemIds:Zs,updateItemReferences:ic,loadActiveIntoEditor:At,rebuildFromActive:yt,select:e=>vt(e),onSelectionRenamed:(e,t)=>{var n;H===e&&(H=t,Yt()),((n=Gt==null?void 0:Gt.item)==null?void 0:n.id)===e&&(Gt.item.id=t)},makeSlug:qt,isAutoIdFromNameEnabled:()=>lo});function Rd({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=L=>{if(a.fields.errorEl){if(!L){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=L}},l=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},u=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var L,V;(L=a.fields.titleInput)==null||L.focus(),(V=a.fields.titleInput)==null||V.select()}))},h=({force:L}={})=>{var te,Be;if(!lo||!a.autoSyncEnabled||!((te=a.fields)!=null&&te.idInput)||!((Be=a.fields)!=null&&Be.titleInput)||!L&&a.idManuallyEdited)return;const V=qt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=V},m=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const L=a.modelData.categories||[],V=L.find(Le=>Le.id===a.categoryId);if(!V)throw new Error("Category not found.");const te=(a.fields.idInput.value||"").trim();if(!te)throw new Error("ID is required.");const Be=(a.fields.titleInput.value||"").trim();if(L.some(Le=>Le.id===te&&Le.id!==V.id))throw new Error("Another category already uses that ID.");const Ce=V.id;return V.id=te,V.title=Be||V.id,Ce!==te&&typeof i=="function"&&i(Ce,te),t(),n(),o(te,{scrollIntoView:!0}),!0},S=()=>{try{return m(),l(),!0}catch(L){return console.warn("[CategoryEditor] save failed",L),s((L==null?void 0:L.message)||"Unable to save category."),!1}},P=()=>{if(a.wrapper)return a.wrapper;const L=document.createElement("div");L.className="item-editor-modal category-editor-modal",L.hidden=!0,L.setAttribute("role","dialog"),L.setAttribute("aria-modal","true");const V=document.createElement("div");V.className="item-editor-modal__backdrop",L.appendChild(V);const te=document.createElement("div");te.className="item-editor",L.appendChild(te);const Be=document.createElement("div");Be.className="item-editor__header";const st=document.createElement("h2");st.className="item-editor__title",st.textContent="Edit category";const Ce=document.createElement("button");Ce.type="button",Ce.className="item-editor__close",Ce.setAttribute("aria-label","Close category editor"),Ce.textContent="×",Be.appendChild(st),Be.appendChild(Ce),te.appendChild(Be);const Le=document.createElement("form");Le.className="item-editor__form",te.appendChild(Le);const ot=document.createElement("div");ot.className="item-editor__meta",ot.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',Le.appendChild(ot);const De=document.createElement("div");De.className="item-editor__error",De.hidden=!0,Le.appendChild(De);const Tt=(en,Ke,Zo)=>{const tn=document.createElement("label");tn.className="item-editor__field";const go=document.createElement("span");if(go.className="item-editor__label",go.textContent=en,tn.appendChild(go),Ke.classList.add("item-editor__control"),tn.appendChild(Ke),Zo){const kn=document.createElement("div");kn.className="item-editor__hint",kn.textContent=Zo,tn.appendChild(kn)}return tn},Ut=document.createElement("input");Ut.type="text",Le.appendChild(Tt("Title",Ut,"Display label shown in the map."));const Nt=document.createElement("input");Nt.type="text",Nt.required=!0,Le.appendChild(Tt("ID",Nt,"Unique identifier for this category (used in URLs and references)."));const _e=document.createElement("div");_e.className="item-editor__checkbox";const Et=document.createElement("label");Et.className="item-editor__checkbox-row";const Sn=document.createElement("input");Sn.type="checkbox";const zn=document.createElement("span");zn.textContent="Sync ID while editing title";const St=document.createElement("div");St.className="item-editor__hint",St.textContent="Turn off to keep typing titles without changing the ID.",Et.append(Sn,zn),_e.append(Et,St),Le.appendChild(_e);const Ht=document.createElement("div");Ht.className="item-editor__actions";const rn=document.createElement("button");rn.type="submit",rn.className="item-editor__action item-editor__action--primary",rn.textContent="Save";const Qt=document.createElement("button");return Qt.type="button",Qt.className="item-editor__action",Qt.textContent="Cancel",Ht.appendChild(rn),Ht.appendChild(Qt),Le.appendChild(Ht),Le.addEventListener("submit",en=>{en.preventDefault(),S()}),Qt.addEventListener("click",l),Ce.addEventListener("click",l),V.addEventListener("click",l),Nt.addEventListener("input",()=>{a.idManuallyEdited=!0}),Ut.addEventListener("input",()=>h()),Sn.addEventListener("change",()=>{a.autoSyncEnabled=!!Sn.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,h({force:!0}))}),L.addEventListener("keydown",en=>{en.key==="Escape"&&(en.preventDefault(),l())}),document.body.appendChild(L),a.wrapper=L,a.fields={titleInput:Ut,idInput:Nt,errorEl:De,metaLabel:ot.querySelector(".item-editor__meta-value"),syncCheckbox:Sn},L};return{open:L=>{if(!L||!P())return!1;const te=e(),st=((te==null?void 0:te.categories)||[]).find(Le=>Le.id===L);if(!st)return!1;a.categoryId=st.id,a.modelData=te,a.idManuallyEdited=!1;const Ce=!!lo;return a.autoSyncEnabled=Ce,a.fields.metaLabel.textContent=st.title||st.id||"Category",a.fields.titleInput.value=st.title||st.id||"",a.fields.idInput.value=st.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!Ce,!a.fields.idInput.value&&Ce&&h({force:!0}),s(""),u(),!0},hide:l,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const Od=Rd({getActiveModelData:()=>{var e;return(e=k[b])==null?void 0:e.data},loadActiveIntoEditor:At,rebuildFromActive:yt,selectCategory:(e,t={})=>Wn(e,t),onCategoryRenamed:(e,t)=>{Ue===e&&(Ue=t,Yt())}}),{handleTileContextMenu:Pd,hidePreview:mo,handleDocumentClick:Vd,handleWindowResize:Dd,handleWindowScroll:Ud,updateColorPresets:Jo}=rc({menuEl:document.getElementById("tileContextMenu"),previewEl:ne,previewTitleEl:ie,previewBodyEl:Me,previewActionsEl:Qe,previewCloseEl:qe,escapeHtml:gi,onEditItem:e=>fo.open(e),onChangeColor:(e,t)=>Nd(e,t),selectItem:e=>vt(e),colorPresets:Kt});function Zi(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||Ge(e);return Pt(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function Hd({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=qt(`${e||"blank"}-${Va()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),An(o,{titleHint:t,idHint:n}),o}function Fd(){const t=`Blank series ${Va()}`,n=bn(t,"blank-series"),o=Hd({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return po(i,n),Pt(i,{seriesName:t,fallbackTitle:t}),i}function Wd(){const e=Fd(),t=Tn(e,{versionLabel:"blank"});return xt(t),ea(),Nn("Blank series created. Add categories and tiles to start.",2600),t}function Tn(e,{versionLabel:t,createdOn:n}={}){var u,h,m;if(e!=null&&e.isSeries||((u=e==null?void 0:e.apicurioVersions)==null?void 0:u.length)>1){const S=e.title||Ge(e);Pt(e,{seriesName:S,fallbackTitle:S}),ta(e)}const o=pt(e);if(!o)return Zi(e,{versionLabel:t||"1",createdOn:n}),k.push(e),k.length-1;const i=k.findIndex(S=>pt(S)===o);if(i===-1)return Zi(e,{versionLabel:t||"1",createdOn:n}),k.push(e),k.length-1;const a=k[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(m=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:m.createdOn}],a.apicurioActiveVersionIndex=0;const S=a.title||Ge(a);Pt(a,{seriesName:S,fallbackTitle:S})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=Ge(e)||a.title,a.isSeries=!0;const l=a.title||Ge(a);return Pt(a,{seriesName:l,fallbackTitle:l}),i}function Qs({versionLabel:e}={}){var l;if(b<0||!k[b])throw new Error("Load or select a model before creating a version.");const t=k[b];Zi(t,{versionLabel:"1"});const n=xd(t);let o;try{o=Ad(t.data)}catch(u){throw console.warn("[Blockscape] failed to clone active model for versioning",u),new Error("Could not copy the current model.")}n&&(o.id=n),An(o,{titleHint:Ge(t),idHint:pt(t)||$n(t)});const a={version:e||String((((l=t.apicurioVersions)==null?void 0:l.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||Ge(t);return Pt(t,{seriesName:s,fallbackTitle:s}),b}function Fa(){const e=b>=0&&k[b]?k[b]:null,t=pt(e);document.title=t?`${t}-blockscape`:mt}function Qi(e){if(!e)return null;ta(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||Ge(e);return Pt(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var u;const s=((i==null?void 0:i.version)??"").toString().trim(),l=(((u=i==null?void 0:i.data)==null?void 0:u.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(ji)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:l}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function jd(){const e=k[b],t=Qi(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function el(e="shortcut",t=!1){const n=f.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=k[b],i=t?Qi(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,l=$n(o),u=pt(o),h=l||u||Ge(o,"blockscape"),m=a?"-series":"",S=`${qt(h)}${m}.bs`;return Cs(S,s),console.log(`[Blockscape] saved JSON (${e}):`,S),!0}const zd=Ot.palette.letter,Gd=Ot.palette.letterFallback;function tl(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return zd[n]||Gd}function Jd(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?Ot.color.ink:Ot.color.white}function Kd(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function Wa(){if(Jt)return;Jt=document.createElement("div"),Jt.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",Ct=document.createElement("span"),Ct.className="series-nav-notice__text",Jt.appendChild(e),Jt.appendChild(Ct),document.body.appendChild(Jt)}function ja(){on&&(clearTimeout(on),on=null),Jt&&Jt.classList.remove("is-visible"),Ct&&(Ct.textContent="")}function Ko(){Dt=null,Xt&&(clearTimeout(Xt),Xt=null),ja()}function za(){wn=null,Zt&&(clearTimeout(Zt),Zt=null),ja()}function qd(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function Yd(e,t,n){Wa(),Dt={id:e,targetVersionIndex:t},Xt&&clearTimeout(Xt),Xt=setTimeout(()=>{Xt=null,Ko()},Dn);const o=qd(n,t);Nn(`Click again to open ${o} in this series.`,Dn)}function Xd(e,t){Wa(),wn={id:e,targetIndex:t},Zt&&clearTimeout(Zt),Zt=setTimeout(()=>{Zt=null,za()},Dn);const n=Yi(k[t]);Nn(`Click again to open "${n}".`,Dn)}function Nn(e,t=qn,n=null){if(Wa(),Ct.textContent="",Ct.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,Ct.appendChild(o),Ct.appendChild(i)}Jt.classList.add("is-visible"),on&&clearTimeout(on),on=setTimeout(()=>ja(),t)}function Zd(){ge&&(ge.innerHTML="",_d.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const l=document.createElement("span");l.className="shortcut-help__or",l.textContent="or",n.appendChild(l)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((l,u)=>{if(u>0){const m=document.createElement("span");m.className="shortcut-help__sep",m.textContent="+",s.appendChild(m)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=l,s.appendChild(h)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),ge.appendChild(t)}),ao=!0)}function Qd(){return!!se&&se.hidden===!1}function eu(){if(!se)return;ao||Zd(),On=document.activeElement,se.hidden=!1,se.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=se.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ga(){if(!se||se.hidden)return;se.hidden=!0,se.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=On;e!=null&&e.focus?e.focus({preventScroll:!0}):Oe!=null&&Oe.focus&&Oe.focus({preventScroll:!0})}function tu(){if(!Z)return;Z.hidden=!1,Z.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Z.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function ea(){!Z||Z.hidden||(Z.hidden=!0,Z.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),ce!=null&&ce.focus&&ce.focus({preventScroll:!0}))}let Ja=!1;function qo(){Ja||(Ja=!0,requestAnimationFrame(()=>{Ja=!1,oa(),En()}))}let nl=!1;function ol(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function nu(e){const t=ol(e);if(!t.length){C.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}C.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(l=>o.includes(l)||i.includes(l));n.style.opacity=a?"1":"0.2"})}function ou(e){const t=ol(e);if(!t.length)return[];const n=[];return k.forEach((o,i)=>{var h;const a=Yi(o),s=pt(o)||"",l=`${a} ${s}`.toLowerCase();t.every(m=>l.includes(m))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((h=o.data)==null?void 0:h.categories)?o.data.categories:[]).forEach(m=>{const S=(m.title||m.id||"").toString();(m.items||[]).forEach(P=>{const N=(P.name||P.id||"").toString(),L=`${N} ${P.id||""} ${S}`.toLowerCase();t.every(V=>L.includes(V))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:P.id,itemName:N,categoryTitle:S})})})}),n.slice(0,Y)}function il(e){if(!be)return;be.innerHTML="";const t=(e||"").toString();if(!t.trim()){be.hidden=!0;return}if(!k.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",be.appendChild(o),be.hidden=!1;return}const n=ou(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",be.appendChild(o),be.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===b&&(!o.itemId||H===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemName||o.itemId||"Item",a.appendChild(s);const l=document.createElement("span");l.className="search-result__badge",l.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(l);const u=document.createElement("div");u.className="search-result__meta";const h=document.createElement("span");if(h.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,u.appendChild(h),o.type==="item"&&o.itemId){const m=document.createElement("span");m.textContent=`Item ID: ${o.itemId}`,u.appendChild(m)}else if(o.type==="model"){const m=document.createElement("span");m.textContent="Matches model title",u.appendChild(m)}i.appendChild(a),i.appendChild(u),be.appendChild(i)}),be.hidden=!1}function al(e){nu(e||""),il(e||"")}function iu(e){!e||!Number.isInteger(e.modelIndex)||(xt(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(b!==e.modelIndex)return;const t=(n=pe.get(e.itemId))==null?void 0:n.el;t&&(vt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function xt(e){var t;if(mo(),Ko(),Gt=null,Vt=null,Ue=null,nt=null,e<0||e>=k.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(d=!0,b=e,console.log("[Blockscape] active model:",Ge(k[e]),"(index",e+" )"),typeof(Je==null?void 0:Je.highlightSource)=="function"){const n=((t=k[e])==null?void 0:t.sourcePath)||null;Je.highlightSource(n)}Fa(),Un(),At(),yt(),Se&&al(Se.value||""),Je.updateActiveSavePlaceholder(),Ne.updateAvailability(),Pa()}function Un(){if(J.innerHTML="",!k.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",J.appendChild(e);return}k.forEach((e,t)=>{var S;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===b?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===b?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=Yi(e),i.appendChild(a);const s=Td(Ua(e)||pt(e));if(s){const P=document.createElement("span");P.className="model-nav-id",P.textContent=s,i.appendChild(P)}const l=Array.isArray((S=e.data)==null?void 0:S.categories)?e.data.categories:[],u=l.reduce((P,N)=>P+(N.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const m=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";h.textContent=`${l.length} cat · ${u} items${m}`,o.appendChild(i),o.appendChild(h),n.appendChild(o),J.appendChild(n)}),Ne.updateAvailability()}function At(){if(b<0){f.value="",R&&(R.disabled=!0);return}const e=k[b];f.value=JSON.stringify(e.data,null,2),R&&(R.disabled=!Qi(e))}function au(e){try{return JSON.parse(e)}catch{return null}}function rl(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function ru(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,l)=>{const u=s==null?void 0:s.data;if(!u||!Array.isArray(u.categories))return;const h=Ge(u,`Map ${l+1}`),m=(u.id??"").toString().trim()||qt(h||`map-${l+1}`),S=qt(m||h||`map-${l+1}`);u.categories.forEach(P=>{const N=((P==null?void 0:P.id)??"").toString().trim();if(!N)return;n.has(N)||n.set(N,{catTitle:P.title||N,sources:[]});const L=n.get(N);!L.catTitle&&(P.title||N)&&(L.catTitle=P.title||N),L.sources.push({category:P,mapId:m,mapTitle:h,mapSlug:S,versionIndex:l})})});const o=$n(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||Ge(e,"Series"),a=[];return n.forEach((s,l)=>{var P;if((((P=s.sources)==null?void 0:P.length)||0)<2)return;const u=s.catTitle||l,h=new Set,m=s.sources.map(N=>{var st;let V=N.mapSlug||qt(N.mapTitle||N.mapId)||`map-${N.versionIndex+1}`;h.has(V)&&(V=`${V}-${N.versionIndex+1}`),h.add(V);const te=new Map,Be=(((st=N.category)==null?void 0:st.items)||[]).map((Ce,Le)=>{const ot=((Ce==null?void 0:Ce.id)??"").toString().trim()||`item-${Le+1}`,De=`${V}-${ot}`;te.set(ot,De);const Tt={...Ce,id:De};return Tt.deps=Array.isArray(Ce==null?void 0:Ce.deps)?[...Ce.deps]:[],Tt});return Be.forEach(Ce=>{Ce.deps=(Ce.deps||[]).map(Le=>te.get(Le)).filter(Boolean)}),{id:V,title:N.mapTitle||N.mapId||`Map ${N.versionIndex+1}`,items:Be}}),S={id:qt(`${l}-category-view`),title:u,abstract:`Items from "${u}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:m};o&&(S.seriesId=o),An(S,{titleHint:u,idHint:`${o||"series"}-${l}`}),a.push({version:`${ji}${l}`,data:S,isCategoryView:!0,categoryViewKey:l})}),a}function sl(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${ji}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function ta(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=sl(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(l=>!(l!=null&&l.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Fn(e),e.apicurioVersions.length-1));const l=e.apicurioVersions[e.apicurioActiveVersionIndex];return l!=null&&l.data&&(e.data=l.data),e}const o=ru({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(l=>sl(l)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function su(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((m,S)=>!m||typeof m!="object"?null:(An(m,{titleHint:`${t} #${S+1}`}),{obj:m,idx:S})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let l=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const u={id:co(),title:l,data:a,apicurioVersions:i.map(({obj:m,idx:S})=>({version:String(S+1),data:m})),apicurioActiveVersionIndex:0,isSeries:!0},h=Pt(u,{seriesName:l,fallbackTitle:l});return h&&(u.id=h),ta(u),[u]}function ll(e,t="Pasted",n={}){return Array.isArray(e)?su(e,t,n):!e||typeof e!="object"?[]:(An(e,{titleHint:`${t} #1`}),[{id:co(),title:e.title||`${t} #1`,data:e}])}function Hn(e,t="Pasted",n={}){const i=(rl(typeof e=="string"?e:"")||"").trim();if(!i)return[];const a=au(i);if(a){let l=n;if(Array.isArray(a)&&n.promptForSeriesName){const h=Id(a,t),m=kd(h);l={...n,promptForSeriesName:!1,seriesTitleOverride:m||h}}const u=ll(a,t,l);if(u.length)return u}return i.split(/^\s*(?:---|%%%)\s*$/m).map(l=>l.trim()).filter(Boolean).map((l,u)=>{const h=JSON.parse(l);return An(h,{titleHint:`${t} #${u+1}`}),{id:co(),title:h.title||`${t} #${u+1}`,data:h}})}function lu(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function ho(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!lu(e)}function cu(e){if(!e)return!1;const n=(rl(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function cl(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(ct)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(ct)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(ct)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=Hn(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let o=null;return n.forEach(i=>{const a=Tn(i,{versionLabel:"editor"});o==null&&(o=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:o,count:n.length}}function dl(e="storage"){const t=cl();return!t||typeof t.index!="number"?!1:(xt(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function du(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=Mc(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=ll(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const l=s.isSeries?o.title||s.title:null,u=Tn({...s,apicurioArtifactName:l||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=u)}),a}async function uu(){const e=Gc();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await fi())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await $s(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(Je==null?void 0:Je.highlightSource)=="function"&&Je.highlightSource(t);let s=a.firstIndex;if(n){const l=Ha(n);l!==-1&&(s=l)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function pu(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await Xa(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function fu(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const l=new Set(s.deps||[]);t.set(s.id,l),l.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function mu(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=tl(e,t),l=Jd(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=l,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function Fn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function ul(e){const t=Fn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function pl(e,t="active"){return $n(e)||pt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function hu(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,l;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((l=n==null?void 0:n.data)==null?void 0:l.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function gu(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(qt(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,l]of t.entries())if(s.toLowerCase()===a)return l}return null}const fl=new WeakMap;function bu(e,t){var De;if(!((De=e==null?void 0:e.apicurioVersions)!=null&&De[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=qi(o),a=fl.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,l=160,u=document.createElement("canvas");u.width=s,u.height=l;const h=u.getContext("2d"),m=Bo("--color-surface-ghost")||Ot.color.surfaceGhost,S=Bo("--color-border-muted")||Ot.color.borderMuted;h.fillStyle=m,h.fillRect(0,0,s,l),h.strokeStyle=S,h.strokeRect(.5,.5,s-1,l-1);const P=8,N=8,L=4,V=Array.isArray(o==null?void 0:o.categories)?o.categories:[],te=Math.max(V.length,1),Be=s-L*2,st=L*3,Ce=te>1?Math.min(st,Be/(te-1)):0,Le=te>1?(s-Ce*(te-1))/2:s/2;V.forEach((Tt,Ut)=>{const Nt=Le+Ut*Ce,_e=Array.isArray(Tt.items)?Tt.items:[],Et=Math.max(_e.length,1),Sn=l-P-N-L*2,zn=Et>1?Math.min(L*3,Sn/(Et-1)):0;_e.forEach((St,Ht)=>{const rn=l-N-L-Ht*zn;h.beginPath(),h.arc(Nt,rn,L,0,Math.PI*2);const Qt=tl(St.name||St.id||"",St.color);h.fillStyle=Qt,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const ot=u.toDataURL("image/png");return fl.set(n,{fingerprint:i,dataUrl:ot}),ot}function na(e,t){var l;if(Ko(),e<0||e>=k.length)return!1;const n=k[e];if(!((l=n==null?void 0:n.apicurioVersions)!=null&&l.length)||!Xs(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,d=!0,H=null,It=null,Yt(),At(),yt(),!0):!1}function Ka(e){var o;if(!e||b<0)return!1;const t=k[b];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=Fn(t);return n===-1?!1:na(b,n+e)}function wu(e,t){if(Ko(),e<0||e>=k.length)return!1;const n=k[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!Xs(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=Fn(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const l=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(l==null?void 0:l.data)||n.data,n.isSeries=n.apicurioVersions.length>1,xt(e),!0}function vu(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,c.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||pt(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var Be;const V=k[b];!((Be=V==null?void 0:V.apicurioVersions)!=null&&Be.length)||!Cd(V)||(Un(),At(),yt())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=Fn(e),s=ul(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const l=document.createElement("div");l.className="version-nav__controls";const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Previous",u.addEventListener("click",()=>Ka(-1));const h=document.createElement("button");h.type="button",h.className="version-nav__button",h.textContent="Next",h.addEventListener("click",()=>Ka(1)),l.appendChild(u),l.appendChild(h),n.appendChild(l);const m=document.createElement("div");m.className="version-nav__thumbs",e.apicurioVersions.forEach((V,te)=>{var Ut,Nt;const Be=document.createElement("button");Be.type="button",Be.className="version-nav__thumb",V!=null&&V.isCategoryView&&Be.classList.add("version-nav__thumb--category"),te===a&&Be.classList.add("is-active");const st=bu(e,te);if(st){const _e=document.createElement("img");_e.src=st,_e.alt=`Version ${te+1}`,Be.appendChild(_e)}const Ce=document.createElement("div");Ce.className="version-nav__thumb-label";const Le=document.createElement("span");Le.className="version-nav__thumb-label-text";const ot=(((Ut=V==null?void 0:V.data)==null?void 0:Ut.id)??(V==null?void 0:V.id)??"").toString().trim();let De=ot||(V!=null&&V.version?`v${V.version}`:`${te+1}`),Tt=ot||De;if(V!=null&&V.isCategoryView){const _e=((Nt=V.data)==null?void 0:Nt.title)||V.categoryViewKey||De||"Category";De=_e,Tt=`Category view: ${_e}`,Be.dataset.computed="true"}if(Le.textContent=De,Ce.title=Tt,Ce.appendChild(Le),Be.appendChild(Ce),xu(Ce,Le),e.apicurioVersions.length>1&&!(V!=null&&V.isCategoryView)){const _e=document.createElement("span");_e.className="version-nav__thumb-remove",_e.title=`Remove ${De} from this series`,_e.setAttribute("aria-label",`Remove ${De} from this series`),_e.setAttribute("role","button"),_e.tabIndex=-1,_e.textContent="×",_e.addEventListener("click",Et=>{Et.stopPropagation(),Et.preventDefault(),window.confirm(`Remove ${De} from this series?`)&&wu(b,te)}),Be.appendChild(_e)}Be.addEventListener("click",()=>na(b,te)),Tu(Be,V),m.appendChild(Be)});const S=document.createElement("button");S.type="button",S.className="version-nav__thumb version-nav__thumb--add",S.title="Create a new version from this map",S.addEventListener("click",()=>{try{const V=Qs({versionLabel:"manual"});xt(V)}catch(V){alert((V==null?void 0:V.message)||"Unable to create a new version right now.")}});const P=document.createElement("span");P.className="version-nav__thumb-add-icon",P.textContent="+",S.appendChild(P),m.appendChild(S),n.appendChild(m);const N=pl(e,"active"),L=M.get(N);return typeof L=="number"&&!Number.isNaN(L)&&requestAnimationFrame(()=>{m.scrollLeft=L}),m.addEventListener("scroll",()=>{M.set(N,m.scrollLeft)}),n}function mi(){var Ol,Pl;if(!y)return;const e=b>=0&&k[b]?k[b]:null,t=C&&C.querySelector?C.querySelector(".version-nav__thumbs"):null;if(t&&e){const p=pl(e,b);M.set(p,t.scrollLeft)}jn(),Array.isArray(y.m.categories)||(y.m.categories=[]),console.log("[Blockscape] rendering categories=",y.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!y.m.abstract,"- value:",y.m.abstract?y.m.abstract.substring(0,50)+"...":"none"),C.innerHTML="",pe.clear(),jt.clear(),D=[],Zi(k[b],{versionLabel:"1"});const n=vu(k[b]);n&&C.appendChild(n),j.setAttribute("width",window.innerWidth),j.setAttribute("height",window.innerHeight);const i=(()=>{var K,Fe,Wt;const p=document.createElement("div");p.className="blockscape-model-meta";const $=document.createElement("div");$.className="blockscape-model-title",$.textContent=y.m.title&&y.m.title.trim()||Ge(k[b]),p.appendChild($),((K=k[b])!=null&&K.isSeries||(Wt=(Fe=k[b])==null?void 0:Fe.apicurioVersions)!=null&&Wt.length)&&Pt(k[b],{seriesName:k[b].title||y.m.title||Ge(k[b])});const U=ul(k[b]),xe=$n(k[b]),fe=(y.m.id??"").toString().trim(),Pe=document.createElement("div");Pe.className="blockscape-model-meta__details";const Re=(Ve,Bt)=>{if(!Bt)return;const gn=document.createElement("div");gn.className="blockscape-model-id";const wo=document.createElement("span");wo.className="blockscape-model-id__label",wo.textContent=Ve;const vo=document.createElement("span");vo.className="blockscape-model-id__value",vo.textContent=Bt,gn.append(wo,vo),Pe.appendChild(gn)};return Re("Series ID",xe),Re("Model ID",fe),Re("No. in series",U),Pe.childElementCount&&p.appendChild(Pe),p})();c.showModelMeta!==!1&&C.appendChild(i.cloneNode(!0));const s=document.createElement("div");s.className="blockscape-tabs";const l=document.createElement("div");l.className="blockscape-tabrow";const u=document.createElement("div");u.className="blockscape-tablist",u.setAttribute("role","tablist"),l.appendChild(u);const h=document.createElement("div");h.className="blockscape-tabactions",l.appendChild(h),s.appendChild(l);const m=document.createElement("div");m.className="blockscape-tabpanels",s.appendChild(m);const S=document.createElement("div"),P=document.createElement("div"),N=document.createElement("div"),L=document.createElement("div"),V=()=>{const p=document.createElement("div");p.className="blockscape-map-legend";const $=document.createElement("div");return $.className="blockscape-legend",$.setAttribute("role","presentation"),$.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,p.appendChild($),p};let te="";const Be=hu(k[b]),st=Fn(k[b]),Ce=((Pl=(Ol=k[b])==null?void 0:Ol.apicurioVersions)==null?void 0:Pl[st])||null,Le=Rn=!!(Ce!=null&&Ce.isCategoryView||((Ce==null?void 0:Ce.version)||"").startsWith(ji));an=null,yn="";const ot=(p,$)=>{!p||!$||(p.title=p.title?`${p.title}
${$}`:$)},De=[{id:"map",label:"Map",panel:S},{id:"abstract",label:"Info",panel:P},{id:"source",label:"Settings",panel:N},{id:"apicurio",label:"Apicurio",panel:L}],Tt=typeof Ne.isEnabled=="function"?Ne.isEnabled():!1,Ut=p=>{if(!j)return;const $=p==="map";j.hidden=!$,$?(oa(),En()):j.innerHTML=""};De.forEach((p,$)=>{const U=document.createElement("button");U.type="button",U.id=`tab-${p.id}`,U.className="blockscape-tab"+($===0?" is-active":""),U.setAttribute("role","tab"),U.setAttribute("aria-controls",`panel-${p.id}`),U.setAttribute("aria-selected",$===0?"true":"false"),U.textContent=p.label,p.id==="apicurio"&&!Tt&&(U.hidden=!0,U.tabIndex=-1,U.setAttribute("aria-hidden","true"),U.style.display="none"),p.button=U,u.appendChild(U),p.panel.id=`panel-${p.id}`,p.panel.classList.add("blockscape-tabpanel"),p.panel.setAttribute("role","tabpanel"),p.panel.setAttribute("aria-labelledby",U.id),p.panel.hidden=$!==0,$===0&&p.panel.classList.add("is-active"),m.appendChild(p.panel)});const Nt=p=>{ln=p,De.forEach($=>{const U=$.id===p;$.button.classList.toggle("is-active",U),$.button.setAttribute("aria-selected",U?"true":"false"),$.panel.classList.toggle("is-active",U),$.panel.hidden=!U}),Ut(p)},_e=De.find(p=>p.id==="apicurio"),Et=p=>{if(!_e||!_e.button||!_e.panel)return;const $=!!p;if(_e.button.hidden=!$,_e.button.tabIndex=$?0:-1,_e.button.setAttribute("aria-hidden",$?"false":"true"),_e.button.style.display=$?"":"none",$){const U=ln==="apicurio";_e.button.classList.toggle("is-active",U),_e.button.setAttribute("aria-selected",U?"true":"false"),_e.panel.classList.toggle("is-active",U),_e.panel.hidden=!U}else{const U=_e.panel.classList.contains("is-active");if(_e.button.classList.remove("is-active"),_e.button.setAttribute("aria-selected","false"),_e.panel.classList.remove("is-active"),_e.panel.hidden=!0,U){const xe=De.find(fe=>fe.id!=="apicurio");xe&&Nt(xe.id)}}B&&(B.checked=$)};De.forEach(p=>{p.button.addEventListener("click",()=>{jn(),Nt(p.id)}),p.id==="abstract"&&(an=p.button,p.button.addEventListener("mouseenter",()=>bi(p.button,te,{offset:12})),p.button.addEventListener("mouseleave",jn),p.button.addEventListener("focus",()=>bi(p.button,te,{offset:12})),p.button.addEventListener("blur",jn))});const zn=(p=>{const $=De.find(xe=>xe.id===ln);if($&&($.id!=="apicurio"||p))return $.id;const U=De.find(xe=>xe.id!=="apicurio"||p);return(U==null?void 0:U.id)||De[0].id})(Tt);Nt(zn),Et(Tt),typeof Ne.onEnabledChange=="function"&&Ne.onEnabledChange(Et),C.appendChild(s),S.appendChild(V());const St=document.createElement("div");St.className="blockscape-render";const Ht=document.createElement("div");Ht.className="stage-guides",Ht.hidden=!ut,Ht.setAttribute("aria-hidden","true");const rn=document.createElement("div");rn.className="stage-guide-labels",["Genesis / Inception","Custom","Product / Rental","Service / Commodity"].forEach(p=>{const $=document.createElement("span");$.className="stage-guide-labels__item",$.textContent=p,rn.appendChild($)}),Ht.appendChild(rn),St.appendChild(Ht),Ta=Ht,S.appendChild(St);const Qt=document.createElement("div");if(Qt.className="blockscape-abstract-panel",P.appendChild(i.cloneNode(!0)),y.m.abstract){console.log("[Blockscape] Rendering abstract content");const p=document.createElement("div");p.className="blockscape-abstract",p.innerHTML=y.m.abstract,Ku(p),Qt.appendChild(p),te=p.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const p=document.createElement("div");p.className="blockscape-abstract-placeholder",p.textContent="No abstract has been provided for this model.",Qt.appendChild(p),te=p.outerHTML}yn=te,P.appendChild(Qt);const en=document.createElement("div");en.className="blockscape-source-panel";const Ke=document.createElement("div");Ke.className="blockscape-settings-panel";const Zo=p=>{Ae.themeToggle&&(Ae.themeToggle.checked=p),Ae.tabThemeToggle&&(Ae.tabThemeToggle.checked=p)},tn=p=>{Zo(p),Na(p?so:Io)},go=p=>{Ae.tabCenterToggle&&(Ae.tabCenterToggle.checked=p)},kn=p=>{const $=Mo(p);go($),xs($)},Za=p=>{Ae.secondaryLinksToggle&&(Ae.secondaryLinksToggle.checked=p),Ae.tabSecondaryLinksToggle&&(Ae.tabSecondaryLinksToggle.checked=p)},wi=p=>{const $=!!p;Za($),nn=$,H?vt(H):(aa(),En())},Qo=({id:p,label:$,checked:U,onChange:xe})=>{const fe=document.createElement("label");fe.className="blockscape-tab-toggle",fe.setAttribute("for",p);const Pe=document.createElement("input");Pe.type="checkbox",Pe.id=p,Pe.checked=U,typeof xe=="function"&&Pe.addEventListener("change",()=>xe(Pe.checked));const Re=document.createElement("span");return Re.className="blockscape-tab-toggle__label",Re.textContent=$,fe.append(Pe,Re),{row:fe,input:Pe}},vi=document.createElement("p");vi.className="blockscape-settings-panel__title",vi.textContent="Feature toggles",Ke.appendChild(vi);const yi=document.createElement("label");yi.className="settings-toggle";const Yn=document.createElement("input");Yn.type="checkbox",Yn.checked=si===so;const _=document.createElement("span");_.className="settings-toggle__text";const z=document.createElement("span");z.className="settings-toggle__label",z.textContent="Dark mode";const ae=document.createElement("span");ae.className="settings-toggle__hint",ae.textContent="Switch Blockscape UI to dark colors.",_.append(z,ae),yi.append(Yn,_),Yn.addEventListener("change",()=>{tn(Yn.checked)}),Ke.appendChild(yi),Ae.themeToggle=Yn;const{row:le,input:Ze}=Qo({id:"tabToggleTheme",label:"Dark mode",checked:si===so,onChange:p=>tn(p)});h.appendChild(le),Ae.tabThemeToggle=Ze;const{row:Lt,input:we}=Qo({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:nn,onChange:p=>wi(p)});h.appendChild(Lt),Ae.tabSecondaryLinksToggle=we;const{row:it,input:sn}=Qo({id:"tabToggleCenterItems",label:"Wardley",checked:ut,onChange:p=>kn(p)});h.appendChild(it),Ae.tabCenterToggle=sn;const In=document.createElement("div");In.className="settings-actions";const Mt=document.createElement("input");Mt.type="file",Mt.accept="application/json",Mt.hidden=!0;const Ln=document.createElement("button");Ln.type="button",Ln.className="pf-v5-c-button pf-m-secondary",Ln.textContent="Load settings",Ln.addEventListener("click",()=>Mt.click()),Mt.addEventListener("change",async()=>{var $,U;const p=($=Mt.files)==null?void 0:$[0];if(p)try{const xe=await p.text(),fe=JSON.parse(xe),Pe=(fe==null?void 0:fe.settings)||fe,K=((U=zs(Pe||{},{refreshObsidianLinks:sa}).applied)==null?void 0:U.length)||0;Nn(K?`Loaded ${K} setting${K===1?"":"s"} from ${p.name}.`:`No matching settings found in ${p.name}.`,2200)}catch(xe){console.warn("[Blockscape] failed to load settings.json",xe),Nn("Invalid settings file.",2400)}finally{Mt.value=""}});const Ei=document.createElement("button");Ei.type="button",Ei.className="pf-v5-c-button pf-m-tertiary",Ei.textContent="Download settings",Ei.addEventListener("click",()=>{const p={version:1,exportedAt:new Date().toISOString(),settings:sc(js(),{localBackend:Je})};Cs("settings.json",JSON.stringify(p,null,2)),Nn("Settings downloaded.",2e3)}),In.append(Ln,Ei,Mt),Ke.appendChild(In);const ra=document.createElement("div");ra.className="color-presets";const Qa=document.createElement("div");Qa.className="settings-text__label",Qa.textContent="Color presets";const er=document.createElement("div");er.className="settings-text__hint",er.textContent="Shown in tile context menu for quick coloring.",ra.append(Qa,er);const Si=document.createElement("div");Si.className="color-presets__list";const tr=document.createElement("div");tr.className="color-presets__add";const ei=document.createElement("input");ei.type="text",ei.placeholder="Name",ei.className="settings-text__input";const ki=document.createElement("input");ki.type="color",ki.value="#2563eb",ki.className="settings-color-input";const Ii=document.createElement("button");Ii.type="button",Ii.className="pf-v5-c-button pf-m-primary",Ii.textContent="Add preset",Ii.addEventListener("click",()=>{const p=ei.value.trim()||"Custom",$=ki.value,U=[...Kt,{name:p,value:$}];$o(U),Jo(Kt),ei.value=""}),tr.append(ei,ki,Ii),ra.append(Si,tr),Ke.appendChild(ra),Ae.colorPresetList=Si,Lo=()=>{Si.innerHTML="",Kt.forEach((p,$)=>{const U=document.createElement("div");U.className="color-presets__row";const xe=document.createElement("input");xe.type="text",xe.className="settings-text__input",xe.value=p.name||"",xe.placeholder="Name",xe.addEventListener("input",()=>{const Re=[...Kt];Re[$]={...Re[$],name:xe.value},$o(Re),Jo(Kt)});const fe=document.createElement("input");fe.type="color",fe.className="settings-color-input",fe.value=p.value,fe.addEventListener("input",()=>{const Re=[...Kt];Re[$]={...Re[$],value:fe.value},$o(Re),Jo(Kt)});const Pe=document.createElement("button");Pe.type="button",Pe.className="pf-v5-c-button pf-m-plain",Pe.textContent="✕",Pe.title="Remove preset",Pe.addEventListener("click",()=>{const Re=Kt.filter((K,Fe)=>Fe!==$);$o(Re),Jo(Kt),Lo()}),U.append(xe,fe,Pe),Si.appendChild(U)})},Lo();const nr=document.createElement("div");nr.className="settings-text";const or=document.createElement("div");or.className="settings-text__label",or.textContent="Link colors";const ir=document.createElement("div");ir.className="settings-text__hint",ir.textContent="Adjust the colors used when highlighting enables/dependents.";const ar=document.createElement("div");ar.className="settings-color-rows";const Al=({id:p,label:$,hint:U,value:xe,onChange:fe})=>{const Pe=document.createElement("label");Pe.className="settings-color-row",Pe.setAttribute("for",p);const Re=document.createElement("span");if(Re.className="settings-color-row__label",Re.textContent=$,U){const Fe=document.createElement("span");Fe.className="settings-color-row__hint",Fe.textContent=U,Re.appendChild(Fe)}const K=document.createElement("input");if(K.type="color",K.id=p,K.className="settings-color-input",K.value=xe,typeof fe=="function"){const Fe=()=>fe(K.value);K.addEventListener("input",Fe),K.addEventListener("change",Fe)}return Pe.append(Re,K),ar.appendChild(Pe),K};Ae.depColorInput=Al({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:Gi,onChange:p=>{const $=$a(p);Ma($)}}),Ae.revdepColorInput=Al({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:Ji,onChange:p=>{const $=Ra(p);Ba($)}}),nr.append(or,ir,ar),Ke.appendChild(nr);const rr=document.createElement("div");rr.className="settings-text";const sr=document.createElement("div");sr.className="settings-text__text";const lr=document.createElement("div");lr.className="settings-text__label",lr.textContent="Link thickness";const cr=document.createElement("div");cr.className="settings-text__hint",cr.textContent="Adjust stroke width for enables/dependents lines.",sr.append(lr,cr);const bo=document.createElement("select");bo.id="linkThickness",bo.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:p,label:$})=>{const U=document.createElement("option");U.value=p,U.textContent=$,p===li&&(U.selected=!0),bo.appendChild(U)}),bo.addEventListener("change",()=>{const p=ui(bo.value);Oa(p)});const dr=document.createElement("div");dr.className="settings-text__row",dr.append(sr,bo),rr.appendChild(dr),Ke.appendChild(rr),Ae.linkThicknessInput=bo;const Xn=({id:p,label:$,hint:U,checked:xe,className:fe="",onChange:Pe})=>{const Re=document.createElement("label");Re.className=["settings-toggle",fe].filter(Boolean).join(" ");const K=document.createElement("input");K.type="checkbox",K.id=p,K.checked=xe;const Fe=document.createElement("span");Fe.className="settings-toggle__text";const Wt=document.createElement("span");if(Wt.className="settings-toggle__label",Wt.textContent=$,Fe.appendChild(Wt),U){const Ve=document.createElement("span");Ve.className="settings-toggle__hint",Ve.textContent=U,Fe.appendChild(Ve)}return Re.appendChild(K),Re.appendChild(Fe),typeof Pe=="function"&&K.addEventListener("change",()=>Pe(K.checked)),{row:Re,input:K}},sa=()=>{C.querySelectorAll(".tile").forEach(p=>{const $=p.dataset.id,U=Xi($);if(!(U!=null&&U.item))return;const xe=vl(U.item.external),fe=wl(U.item,{externalMeta:xe,seriesIdLookup:Be});yl(p,fe)})},{row:Zu,input:Qu}=Xn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:nn,className:"map-controls__toggle",onChange:p=>wi(p)});Ke.appendChild(Zu),Ae.secondaryLinksToggle=Qu;const{row:ep,input:tp}=Xn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:zt,className:"map-controls__toggle",onChange:p=>{zt=p,Ya()}});Ke.appendChild(ep),Ae.reusedToggle=tp;const{row:np,input:op}=Xn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:lo,className:"map-controls__toggle",onChange:p=>{const $=Fo(p);Ds($)}});Ke.appendChild(np),Ae.autoIdToggle=op;const ur=[],{row:ip,input:ap}=Xn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:To,className:"map-controls__toggle",onChange:p=>{const $=zo(p);Ks($),ur.forEach(U=>{U.disabled=!$}),sa()}});if(Ke.appendChild(ip),Ae.obsidianToggle=ap,typeof(Je==null?void 0:Je.isAvailable)=="function"&&Je.isAvailable()&&typeof(Je==null?void 0:Je.getAutoReloadConfig)=="function"){const{enabled:p,intervalMs:$}=Je.getAutoReloadConfig();let U=null;const{row:xe,input:fe}=Xn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:p,className:"map-controls__toggle",onChange:Bt=>{Je.setAutoReloadEnabled(Bt),U&&(U.disabled=!Bt)}});Ke.appendChild(xe),Ae.autoReloadToggle=fe;const Pe=Bt=>`${(Bt/1e3).toFixed(2)}s`,Re=document.createElement("label");Re.className="settings-slider",Re.setAttribute("for","autoReloadInterval");const K=document.createElement("div");K.className="settings-slider__text";const Fe=document.createElement("span");Fe.className="settings-slider__label",Fe.textContent="Auto-reload interval";const Wt=document.createElement("span");Wt.className="settings-slider__hint",Wt.textContent="Adjust how often to poll for file changes.",K.append(Fe,Wt);const Ve=document.createElement("span");Ve.className="settings-slider__value",Ve.textContent=Pe($),U=document.createElement("input"),U.type="range",U.id="autoReloadInterval",U.className="settings-slider__input",U.min=String(ls),U.max=String(cs),U.step="100",U.value=String($),U.disabled=!p,U.setAttribute("aria-label","Set auto-reload polling interval"),U.addEventListener("input",()=>{const Bt=Je.setAutoReloadInterval(parseInt(U.value,10));Ve.textContent=Pe(Bt)}),Re.append(K,Ve,U),Ke.appendChild(Re),Ae.autoReloadInput=U,Ae.autoReloadValue=Ve}const pr=document.createElement("div");pr.className="settings-radio";const fr=document.createElement("div");fr.className="settings-radio__label",fr.textContent="Obsidian link format";const mr=document.createElement("div");mr.className="settings-radio__hint",mr.textContent="Use the tile title or id when building Obsidian links.";const hr=document.createElement("div");hr.className="settings-radio__options";const Tl=(p,$)=>{const U=document.createElement("label");U.className="settings-radio__option";const xe=document.createElement("input");xe.type="radio",xe.name="obsidianLinkMode",xe.value=p,xe.checked=ri===p,xe.disabled=!To,xe.addEventListener("change",()=>{if(!xe.checked)return;const Pe=jo(p);Js(Pe),sa()});const fe=document.createElement("span");fe.textContent=$,U.append(xe,fe),ur.push(xe),hr.appendChild(U)};Tl(xa,"Use title"),Tl(Ui,"Use id"),pr.append(fr,hr,mr),Ke.appendChild(pr),Ae.obsidianModeInputs=ur;const la=document.createElement("label");la.className="settings-text",la.setAttribute("for","obsidianVaultInput");const gr=document.createElement("div");gr.className="settings-text__text";const br=document.createElement("span");br.className="settings-text__label",br.textContent="Obsidian vault";const wr=document.createElement("span");wr.className="settings-text__hint",wr.textContent="Optional. Set the vault name to avoid duplicates.",gr.append(br,wr);const Gn=document.createElement("input");Gn.type="text",Gn.id="obsidianVaultInput",Gn.className="settings-text__input",Gn.placeholder="Vault name",Gn.value=No,Gn.addEventListener("input",()=>{const p=Go(Gn.value);qs(p),sa()}),la.append(gr,Gn),Ke.appendChild(la),Ae.obsidianVaultInput=Gn;const vr=document.createElement("p");vr.className="settings-note",vr.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',Ke.appendChild(vr);const Nl=p=>`${(p/1e3).toFixed(1)}s`,ca=document.createElement("label");ca.className="settings-slider",ca.setAttribute("for","seriesNavDoubleClickWait");const yr=document.createElement("div");yr.className="settings-slider__text";const Er=document.createElement("span");Er.className="settings-slider__label",Er.textContent="Series double-click wait";const Sr=document.createElement("span");Sr.className="settings-slider__hint",Sr.textContent="Time window to double-click into another map version.",yr.append(Er,Sr);const Ci=document.createElement("span");Ci.className="settings-slider__value",Ci.textContent=Nl(Dn);const un=document.createElement("input");un.type="range",un.id="seriesNavDoubleClickWait",un.className="settings-slider__input",un.min=String(Ss),un.max=String(ks),un.step="50",un.value=String(Dn),un.setAttribute("aria-label","Adjust double-click wait for series navigation"),un.addEventListener("input",()=>{const p=Wo(parseInt(un.value,10));Ci.textContent=Nl(p),Gs(p)}),ca.append(yr,Ci,un),Ke.appendChild(ca),Ae.seriesNavInput=un,Ae.seriesNavValue=Ci;const Ll=p=>`${Math.round((p-1)*100)}%`,da=document.createElement("label");da.className="settings-slider",da.setAttribute("for","hoverScaleSlider");const kr=document.createElement("div");kr.className="settings-slider__text";const Ir=document.createElement("span");Ir.className="settings-slider__label",Ir.textContent="Hover zoom";const Cr=document.createElement("span");Cr.className="settings-slider__hint",Cr.textContent="Expand tiles on hover to see more detail.",kr.append(Ir,Cr);const _i=document.createElement("span");_i.className="settings-slider__value",_i.textContent=Ll(Co);const pn=document.createElement("input");pn.type="range",pn.id="hoverScaleSlider",pn.className="settings-slider__input",pn.min=String(He),pn.max=String(Xe),pn.step="0.1",pn.value=String(Co),pn.setAttribute("aria-label","Adjust hover zoom"),pn.addEventListener("input",()=>{const p=Ro(parseFloat(pn.value));_i.textContent=Ll(p),Os(p),H&&qo()}),da.append(kr,_i,pn),Ke.appendChild(da),Ae.hoverScaleInput=pn,Ae.hoverScaleValue=_i;let Ft=null,Zn=null;const _r=p=>{const $=Math.round((1-p)*100);return $===0?"Off":`${$}% dim`},{row:rp,input:sp}=Xn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Vn,className:"map-controls__toggle",onChange:p=>{const $=Ho(p);Vs($),Ft&&(Ft.disabled=!$),Zn&&(Zn.textContent=_r($?Pn:1))}});Ke.appendChild(rp),Ae.selectionDimToggle=sp;const ua=document.createElement("label");ua.className="settings-slider",ua.setAttribute("for","selectionDimmingSlider");const xr=document.createElement("div");xr.className="settings-slider__text";const Ar=document.createElement("span");Ar.className="settings-slider__label",Ar.textContent="Dimming strength";const Tr=document.createElement("span");Tr.className="settings-slider__hint",Tr.textContent="Adjust how much unrelated tiles fade when dimming is on.",xr.append(Ar,Tr),Zn=document.createElement("span"),Zn.className="settings-slider__value",Zn.textContent=_r(Vn?Pn:1),Ft=document.createElement("input"),Ft.type="range",Ft.id="selectionDimmingSlider",Ft.className="settings-slider__input",Ft.min=String(de),Ft.max=String(oe),Ft.step="0.05",Ft.value=String(Pn),Ft.disabled=!Vn,Ft.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Ft.addEventListener("input",()=>{const p=Oo(parseFloat(Ft.value));Zn.textContent=_r(p),Ps(p)}),ua.append(xr,Zn,Ft),Ke.appendChild(ua),Ae.selectionDimInput=Ft,Ae.selectionDimValue=Zn;const Ml=p=>p===1?"Default":`${Math.round(p*100)}%`,pa=document.createElement("label");pa.className="settings-slider",pa.setAttribute("for","tileCompactnessSlider");const Nr=document.createElement("div");Nr.className="settings-slider__text";const Lr=document.createElement("span");Lr.className="settings-slider__label",Lr.textContent="Tile compactness";const Mr=document.createElement("span");Mr.className="settings-slider__hint",Mr.textContent="Adjust padding, gap, and logo size for tiles.",Nr.append(Lr,Mr);const xi=document.createElement("span");xi.className="settings-slider__value",xi.textContent=Ml(_o);const fn=document.createElement("input");fn.type="range",fn.id="tileCompactnessSlider",fn.className="settings-slider__input",fn.min=String(ts),fn.max=String(ns),fn.step="0.05",fn.value=String(_o),fn.setAttribute("aria-label","Adjust tile compactness"),fn.addEventListener("input",()=>{const p=Po(parseFloat(fn.value));xi.textContent=Ml(p),Us(p),H&&qo()}),pa.append(Nr,xi,fn),Ke.appendChild(pa),Ae.tileCompactnessInput=fn,Ae.tileCompactnessValue=xi;const{row:lp,input:cp}=Xn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:Aa!=="nowrap",className:"map-controls__toggle",onChange:p=>{const $=p?"wrap":"nowrap";Uo($),Ws($)}});Ke.appendChild(lp),Ae.titleWrapInput=cp;const Bl=p=>`${Math.round((p-1)*100)}% extra`,fa=document.createElement("label");fa.className="settings-slider",fa.setAttribute("for","titleHoverWidthSlider");const Br=document.createElement("div");Br.className="settings-slider__text";const $r=document.createElement("span");$r.className="settings-slider__label",$r.textContent="Title width on hover";const Rr=document.createElement("span");Rr.className="settings-slider__hint",Rr.textContent="Give titles more room horizontally when zoomed.",Br.append($r,Rr);const Ai=document.createElement("span");Ai.className="settings-slider__value",Ai.textContent=Bl(xo);const mn=document.createElement("input");mn.type="range",mn.id="titleHoverWidthSlider",mn.className="settings-slider__input",mn.min=String(_n),mn.max=String(dn),mn.step="0.05",mn.value=String(xo),mn.setAttribute("aria-label","Adjust title width boost on hover"),mn.addEventListener("input",()=>{const p=Vo(parseFloat(mn.value));Ai.textContent=Bl(p),Hs(p)}),fa.append(Br,Ai,mn),Ke.appendChild(fa),Ae.titleWidthInput=mn,Ae.titleWidthValue=Ai;const $l=p=>`${Math.round(p*100)}% of hover zoom`,ma=document.createElement("label");ma.className="settings-slider",ma.setAttribute("for","titleZoomPortionSlider");const Or=document.createElement("div");Or.className="settings-slider__text";const Pr=document.createElement("span");Pr.className="settings-slider__label",Pr.textContent="Title zoom influence";const Vr=document.createElement("span");Vr.className="settings-slider__hint",Vr.textContent="How much the title scales relative to tile hover zoom.",Or.append(Pr,Vr);const Ti=document.createElement("span");Ti.className="settings-slider__value",Ti.textContent=$l(Ao);const hn=document.createElement("input");hn.type="range",hn.id="titleZoomPortionSlider",hn.className="settings-slider__input",hn.min=String(ro),hn.max=String(_a),hn.step="0.05",hn.value=String(Ao),hn.setAttribute("aria-label","Adjust how much titles scale on hover"),hn.addEventListener("input",()=>{const p=Do(parseFloat(hn.value));Ti.textContent=$l(p),Fs(p)}),ma.append(Or,Ti,hn),Ke.appendChild(ma),Ae.titleZoomInput=hn,Ae.titleZoomValue=Ti;const dp=typeof Ne.isEnabled=="function"?Ne.isEnabled():!1,{row:up,input:pp}=Xn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:dp,className:"apicurio-toggle",onChange:p=>{typeof Ne.setEnabled=="function"&&Ne.setEnabled(p)}});if(B=pp,Ke.appendChild(up),en.appendChild(Ke),T)T.hidden=!1,T.classList.remove("pf-v5-c-page__main-section"),en.appendChild(T);else{const p=document.createElement("p");p.className="muted",p.textContent="Source editor unavailable.",en.appendChild(p)}N.appendChild(en),Ne.mount(L);let Rl=0;y.m.categories.forEach(p=>{const $=document.createElement("section");$.className="category",$.dataset.cat=p.id;const U=Le?gu(p,Be):null,xe=(p.items||[]).some(K=>di(K.stage)),fe=document.createElement("div");fe.className="cat-head",fe.dataset.cat=p.id,fe.tabIndex=0,Le&&Number.isInteger(U)?(fe.dataset.seriesVersionIndex=String(U),fe.title="Open this category's map in the series",fe.classList.add("cat-head--series-link")):fe.title="Select category",fe.innerHTML=`<div class="cat-title">${gi(p.title||p.id)}</div>
                          ${xe?`<span class="cat-stage-indicator" title="Contains staged items">Stage</span>
                                 <button type="button" class="cat-stage-clear" title="Clear all stages in this category" aria-label="Clear all stages">×</button>`:""}
                          <div class="muted cat-count">${(p.items||[]).length} items</div>`,fe.addEventListener("click",()=>{var Bt;const K=fe.dataset.seriesVersionIndex!=null?parseInt(fe.dataset.seriesVersionIndex,10):null,Fe=k[b],Wt=Fe?Fn(Fe):-1;Le&&((Bt=Fe==null?void 0:Fe.apicurioVersions)==null?void 0:Bt.length)>1&&Number.isInteger(K)&&K!==Wt&&na(b,K)||Wn(p.id)}),fe.addEventListener("keydown",K=>{(K.key==="Enter"||K.key===" ")&&(K.preventDefault(),fe.click())});const Pe=fe.querySelector(".cat-stage-clear");Pe&&Pe.addEventListener("click",K=>{K.preventDefault(),K.stopPropagation(),Ld(p.id)&&Nn("Cleared stages for this category.",1400)}),fe.addEventListener("focus",()=>Wn(p.id,{scrollIntoView:!1})),$.appendChild(fe);const Re=document.createElement("div");if(Re.className="grid"+(ut?" is-centered":""),$.appendChild(Re),(p.items||[]).forEach(K=>{Rl+=1;const Fe=vl(K.external),Wt=wl(K,{externalMeta:Fe,seriesIdLookup:Be}),Ve=document.createElement("div");if(Ve.className=Fe.isExternal?"tile external":"tile",Ve.tabIndex=0,Ve.dataset.id=K.id,Ve.dataset.globalIndex=String(Rl),Fe.url&&(Ve.dataset.externalUrl=Fe.url),!Le){let Cn=null;if(Be.has(K.id)&&(Cn=Be.get(K.id)),Number.isInteger(Cn)){Ve.dataset.seriesVersionIndex=String(Cn),Ve.classList.add("tile--series-link");const fp=Cn===st?"Current map in this series":`Open version ${Cn+1} in this series`;ot(Ve,fp)}}Wt&&(Ve.dataset.obsidianUrl=Wt);const Bt=di(K.stage);if(Bt&&(Ve.dataset.stage=String(Bt),ut&&(Ve.style.gridColumn=String(Bt))),!Le){const Cn=Ha(K.id);Cn!==-1&&Cn!==b&&(Ve.classList.add("tile--series-link"),Ve.dataset.navTargetIndex=String(Cn))}const gn=document.createElement("img");gn.className="logo",K.logo?(gn.src=K.logo,gn.alt=K.name||K.id):(gn.alt="",gn.style.opacity=1,gn.src=mu(K.name||K.id,K.color));const wo=document.createElement("div");wo.className="name",wo.textContent=K.name||K.id;const vo=document.createElement("div");vo.className="tile-id",vo.textContent=K.id||"";let Ni=null;Bt&&(Ni=document.createElement("div"),Ni.className="tile-stage",Ni.textContent=String(Bt));const Dr=document.createElement("div");Dr.className="badge",Dr.textContent="reused";let Qn=null;Le||(Qn=document.createElement("button"),Qn.type="button",Qn.className="tile-delete",Qn.setAttribute("aria-label",`Delete ${K.name||K.id}`),Qn.textContent="×",Qn.addEventListener("click",Cn=>{Cn.stopPropagation(),zu(K.id)})),Fe.url&&Ve.appendChild(_u(Fe.url)),yl(Ve,Wt),Qn&&Ve.appendChild(Qn),Ve.appendChild(gn),Ve.appendChild(wo),Ve.appendChild(vo),Ni&&Ve.appendChild(Ni),Ve.appendChild(Dr),Re.appendChild(Ve),pe.set(K.id,{el:Ve,catId:p.id,rect:null})}),St.appendChild($),jt.set(p.id,{el:$,headEl:fe}),!Le){const K=document.createElement("button");K.type="button",K.className="tile-add",K.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',K.hidden=ut,K.tabIndex=ut?-1:0,K.setAttribute("aria-hidden",ut?"true":"false"),K.addEventListener("click",()=>Bu(p.id)),Re.appendChild(K)}});let Mn=null;Le||(Mn=document.createElement("button"),Mn.type="button",Mn.className="category-add",Mn.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',Mn.addEventListener("click",()=>Sl()),St.appendChild(Mn)),Mn&&ut&&(Mn.hidden=!0,Mn.tabIndex=-1,Mn.setAttribute("aria-hidden","true")),As(),Ya(),yu(),oa(),En(),Yo(),Nu()}function yu(){C.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var N;if(typeof n.button=="number"&&n.button!==0)return;mo();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,l=k[b],u=l?Fn(l):-1,h=((N=l==null?void 0:l.apicurioVersions)==null?void 0:N.length)>1&&Number.isInteger(i)&&i!==u,m=Number.isInteger(s)&&s!==b&&s>=0&&s<k.length,S=Dt&&Dt.id===o&&Dt.targetVersionIndex===i,P=wn&&wn.id===o&&wn.targetIndex===s;if(Dt&&!S&&Ko(),wn&&!P&&za(),h)if(S){if(Ko(),na(b,i))return}else Yd(o,i,l);else if(m){if(P){za(),xt(s);return}Xd(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&Nn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),H===o&&!(h&&S)&&!(m&&P)){Xo();return}vt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):Ha(o);i!==-1&&i!==b&&xt(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{H&&qo()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),nl||(nl=!0,window.addEventListener("resize",qo),window.addEventListener("scroll",qo,{passive:!0}),window.addEventListener("resize",El),document.addEventListener("click",e=>{var a,s,l;if(!H&&!Ue||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),o=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),i=(l=t==null?void 0:t.closest)==null?void 0:l.call(t,".tile-context-menu");n||o||i||Xo()})),document.getElementById("clear").onclick=()=>Xo()}function oa(){pe.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function ml(e,{includeSecondary:t=nn}={}){if(!e||!y)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(y.fwd.get(e)||[]),o=new Set(y.rev.get(e)||[]),i=new Set,a=new Set,s=[],l=new Set,u=(h,m,S,P)=>{if(!h||!m)return;const N=`${h}->${m}:${S}:${P}`;l.has(N)||(l.add(N),s.push({from:h,to:m,type:S,depth:P}))};return n.forEach(h=>u(e,h,"dep",1)),o.forEach(h=>u(e,h,"revdep",1)),t&&new Set([...n,...o]).forEach(m=>{(y.fwd.get(m)||new Set).forEach(N=>{const L=N===e;L||i.add(N),L||u(m,N,"dep",2)}),(y.rev.get(m)||new Set).forEach(N=>{const L=N===e;L||a.add(N),L||u(m,N,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function ia(e,t){const n=pe.get(e);n&&n.el.classList.add(t)}function vt(e){var l,u,h;if(!e)return;Ue=null,H=e,nt=null,It=ml(e),Yt(),aa(),Yo();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=It;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=pe.get(e);a&&a.el.classList.add("selected"),t.forEach(m=>ia(m,"dep")),n.forEach(m=>ia(m,"revdep")),o.forEach(m=>{!t.has(m)&&m!==e&&ia(m,"dep-indirect")}),i.forEach(m=>{!n.has(m)&&!t.has(m)&&m!==e&&ia(m,"revdep-indirect")}),En();const s=(h=(u=(l=pe.get(e))==null?void 0:l.el)==null?void 0:u.dataset)==null?void 0:h.externalUrl;s&&Nn("This item has link to",qn,s),Pa()}function Wn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,l;if(!((s=y==null?void 0:y.m)!=null&&s.categories)||!e)return!1;const i=(y.m.categories||[]).find(u=>u.id===e);if(!i)return!1;mo(),qa(),n||(nt=null),Ue=i.id,Yt(),Yo();const a=jt.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(l=a.headEl)==null||l.focus({preventScroll:!0})),!0}function Yo(){if(jt.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!Ue)return;const e=jt.get(Ue);if(!(e!=null&&e.el)){Ue=null,nt=null,Yt();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function hi(){if(Ue)return Ue;const e=H?pe.get(H):null;return e!=null&&e.catId?e.catId:null}function Eu(e){var a,s,l,u;if(!((s=(a=y==null?void 0:y.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=y.m.categories,n=hi();let o=t.findIndex(h=>h.id===n);if(o===-1){const h=((l=t.find(m=>(m.items||[]).length))==null?void 0:l.id)||((u=t[0])==null?void 0:u.id);return h?Wn(h):!1}const i=o+e;return i<0||i>=t.length?!1:Wn(t[i].id)}function qa(){H=null,It=null,aa(),En(),Pa({itemId:null})}function Su(){Ue=null,nt=null,Yo()}function Xo(){qa(),Su(),nt=null,Yt()}function aa(){C.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function Ya(){y!=null&&y.reusedLocal&&y.reusedLocal.forEach(e=>{const t=pe.get(e);if(!t)return;t.el.classList.toggle("reused",zt);const n=t.el.querySelector(".badge");n&&(n.style.display=zt?"inline-block":"none")})}function En(){for(;j.firstChild;)j.removeChild(j.firstChild);if(!H||j.hidden)return;It=ml(H);const e=It,{primary:t,secondary:n}=Hc();e.edges.forEach(o=>{var V,te;const i=(V=pe.get(o.from))==null?void 0:V.rect,a=(te=pe.get(o.to))==null?void 0:te.rect;if(!i||!a)return;const s=hl(i),l=hl(a),u=bl(gl(i,l)||s,i,vs)||s,h=bl(gl(a,s)||l,a,vs)||l,m=document.createElementNS("http://www.w3.org/2000/svg","path"),S=(u.x+h.x)/2,P=u.y,N=(u.x+h.x)/2,L=h.y;m.setAttribute("d",`M ${u.x},${u.y} C ${S},${P} ${N},${L} ${h.x},${h.y}`),m.setAttribute("fill","none"),m.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),m.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),m.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&m.setAttribute("stroke-dasharray","4 3"),m.setAttribute("vector-effect","non-scaling-stroke"),j.appendChild(m)})}function hl(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function gl(e,t){if(!e||!t)return null;const n=e.left+e.width/2,o=e.top+e.height/2,i=t.x-n,a=t.y-o;if(i===0&&a===0)return{x:n,y:o};const s=e.width/2,l=e.height/2,u=[];i!==0&&u.push((i>0?s:-s)/i),a!==0&&u.push((a>0?l:-l)/a);const h=Math.min(...u.filter(S=>S>0)),m=Number.isFinite(h)?h:0;return{x:n+i*m,y:o+a*m}}function bl(e,t,n=0){if(!e||!t||n<=0)return e;const o=t.left+t.width/2,i=t.top+t.height/2,a=o-e.x,s=i-e.y,l=Math.hypot(a,s);if(!l)return e;const u=Math.min(n,l/2)/l;return{x:e.x+a*u,y:e.y+s*u}}function gi(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function ku(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),No&&o.set("vault",No),`obsidian://advanced-uri?${o.toString()}`}function Iu(e){return e?ri===Ui?e.id??e.name??"":e.name??e.id??"":""}function wl(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!To||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=Iu(e);return ku(o)}function vl(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Cu(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function _u(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function yl(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(Cu(t))}function El(){X||(X=requestAnimationFrame(()=>{X=null,D=D.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),D.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function xu(e,t){!e||!t||(D.push({labelEl:e,textEl:t}),El())}function Au(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${gi(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${gi(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function bi(e,t,{offset:n=8}={}){!Q||!e||!t||(Q.innerHTML=t,Q.hidden=!1,Q.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=Q.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let l=o.left+o.width/2-i.width/2+a,u=o.top-i.height-n+s;l<a+n&&(l=a+n);const h=a+window.innerWidth-i.width-n;l>h&&(l=h),u<s+n&&(u=o.bottom+n+s),Q.style.left=`${l}px`,Q.style.top=`${u}px`,Q.classList.add("is-visible")}))}function jn(){vn&&(clearTimeout(vn),vn=null),Q&&(Q.classList.remove("is-visible"),Q.setAttribute("aria-hidden","true"),Q.hidden=!0)}function Tu(e,t){if(!e)return;const n=Ge((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=Au(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{E=e,bi(e,`<div class="version-nav__tooltip-title">${gi(n)}</div>`,{offset:10})},l=()=>{a(),i=setTimeout(()=>{E===e&&bi(e,o,{offset:10})},ye)},u=()=>{s(),l()},h=()=>{E!==e&&s(),l()},m=()=>{a(),E===e&&(E=null,jn())};e.addEventListener("mouseenter",u),e.addEventListener("focus",u),e.addEventListener("pointermove",h),e.addEventListener("mouseleave",m),e.addEventListener("blur",m),e.addEventListener("click",m)}function Nu(){d&&(d=!1,!(!an||!yn)&&(jn(),bi(an,yn,{offset:12}),vn=setTimeout(()=>{jn(),Lu()},1e3)))}function Lu(){an&&(v&&(clearTimeout(v),v=null),an.classList.add("blockscape-tab--twinkle"),v=setTimeout(()=>{an.classList.remove("blockscape-tab--twinkle"),v=null},1400))}window.addEventListener("scroll",jn,!0),window.addEventListener("resize",jn),Oe&&Oe.addEventListener("click",()=>{eu()}),ce&&ce.addEventListener("click",()=>{tu()}),at&&at.addEventListener("click",()=>{try{Kd(),Wd()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),lt&&lt.addEventListener("click",Ga),O&&O.addEventListener("click",Ga),I&&I.addEventListener("click",ea),ee&&ee.addEventListener("click",ea),C&&C.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");Rn||!t||!C.contains(t)||Pd(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||Vd(e)}),je&&je.addEventListener("click",()=>{el("button")}),W&&W.addEventListener("click",()=>{if(b<0){alert("Load or select a model before creating a version.");return}try{const e=Qs({versionLabel:"map edit"});xt(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),ze&&ze.addEventListener("click",async()=>{var a;if(b<0||!k[b]){alert("Select or load a model before sharing.");return}const e={title:Ge(k[b],"Shared Model"),data:k[b].data};let t;try{t=Lc(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),q&&q.addEventListener("click",()=>{const e=(f.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};H&&(n.selectedItemId=H),localStorage.setItem(ct,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";H&&(t=`editor.html?selected=${encodeURIComponent(H)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==ct||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||dl("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===ft&&dl("message")})),document.addEventListener("keydown",e=>{var o,i,a,s,l,u,h,m,S,P;if(Qd()){e.key==="Escape"&&(e.preventDefault(),Ga());return}if(!(Z!=null&&Z.hidden)&&e.key==="Escape"){e.preventDefault(),ea();return}if((o=fo==null?void 0:fo.isOpen)==null?void 0:o.call(fo))return;const n=Rn;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const N=k[b],L=((i=N==null?void 0:N.apicurioVersions)==null?void 0:i.length)>1;el("shortcut",L);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!ho())return;if(Hu()){e.preventDefault();return}}if(e.key==="Escape"){let N=!1;ne&&!ne.hidden&&(mo(),N=!0),(H||Ue)&&(Xo(),N=!0),N&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!ho())return;const N=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if(ut&&e.shiftKey&&H&&!e.ctrlKey&&!e.metaKey&&Md(H,N)){e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&!e.shiftKey){Ka(N)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(Ue&&!e.shiftKey){e.preventDefault();return}e.shiftKey?Ru(N)&&e.preventDefault():Ou(N)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!ho())return;const N=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){Uu(N)&&e.preventDefault();return}if(e.altKey)return;if(Ue&&!H&&!e.shiftKey){if(Vu(N)){e.preventDefault();return}if(Eu(N)){e.preventDefault();return}}e.shiftKey?Du(N)&&e.preventDefault():Pu(N)&&e.preventDefault()}if(e.key==="Delete"){if(n||!ho()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const N=Ue?ju():!1,L=N?!0:kl();(N||L)&&e.preventDefault()}if(e.key==="F2"){if(n||!ho())return;const N=Ue&&!H&&Ue||!H&&((u=(l=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:l.dataset)==null?void 0:u.cat)||null;if(N&&!H&&$u(N)){e.preventDefault();return}const L=H||((P=(S=(m=(h=e.target)==null?void 0:h.closest)==null?void 0:m.call(h,".tile"))==null?void 0:S.dataset)==null?void 0:P.id);L&&fo.open(L)&&e.preventDefault()}if(e.key==="Insert"){if(n||!ho()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Sl()&&e.preventDefault()}}),window.addEventListener("resize",()=>{Dd()}),window.addEventListener("scroll",()=>Ud(),!0);function Mu(e,t,n){if(b<0)return;const i=k[b].data.categories||[],a=i.find(m=>(m.items||[]).some(S=>S.id===e)),s=i.find(m=>m.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const l=a.items.findIndex(m=>m.id===e);if(l===-1)return;const[u]=a.items.splice(l,1);let h=s.items.length;if(t){const m=s.items.findIndex(S=>S.id===t);m!==-1&&(h=m)}s.items.splice(h,0,u),At(),yt()}function Bu(e){if(b<0||!e)return;const t=k[b].data,o=(t.categories||[]).find(u=>u.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:Bd(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),At(),yt(),mo(),vt(s.id);const l=pe.get(s.id);l!=null&&l.el&&l.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Sl(){if(b<0)return!1;const e=k[b].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=$d(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),Ue=n,H=null,It=null,nt=null,At(),yt(),Wn(n),console.log("[Blockscape] added category",n),!0}function $u(e=hi()){if(b<0||!e)return!1;const t=Od.open(e);return t&&(H=null,It=null,Yt()),t}function Ru(e){if(!H||b<0||!e)return!1;const n=k[b].data.categories||[],o=pe.get(H);let i=null;if(o!=null&&o.catId&&(i=n.find(u=>u.id===o.catId)),i||(i=n.find(u=>(u.items||[]).some(h=>h.id===H))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(u=>u.id===H);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[l]=i.items.splice(a,1);return i.items.splice(s,0,l),At(),yt(),mi(),vt(H),!0}function Ou(e){if(!y||!y.m||!e)return!1;const t=y.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(h=>(h.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!H){const u=n();return u?(vt(u.item.id),!0):!1}const o=pe.get(H);let i=null;if(o!=null&&o.catId&&(i=t.find(u=>u.id===o.catId)),i||(i=t.find(u=>(u.items||[]).some(h=>h.id===H))),!i){const u=n();return u?(vt(u.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(u=>u.id===H);if(s===-1)return!1;const l=s+e;return l<0||l>=a.length?!1:(vt(a[l].id),!0)}function Pu(e){if(!y||!y.m||!e)return!1;const t=y.m.categories||[];if(!t.length)return!1;const n=hi();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(H){const l=(t[o].items||[]).findIndex(u=>u.id===H);nt={catId:a.id,position:l===-1?0:l}}else nt=null;return Wn(a.id,{preserveEntryHint:!0})}function Vu(e){var a;if(!Ue||!((a=y==null?void 0:y.m)!=null&&a.categories)||!e)return!1;const n=(y.m.categories||[]).find(s=>s.id===Ue);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(nt==null?void 0:nt.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,nt.position||0))),nt=null,vt(o[i].id),!0}function Du(e){if(!H||b<0||!e)return!1;const n=k[b].data.categories||[];if(!n.length)return!1;const o=pe.get(H);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(S=>S.id===o.catId)),i===-1&&(i=n.findIndex(S=>(S.items||[]).some(P=>P.id===H))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],l=n[a];if(!l)return!1;s.items=s.items||[],l.items=l.items||[];const u=s.items.findIndex(S=>S.id===H);if(u===-1)return!1;const h=Math.min(l.items.length,Math.max(0,u)),m=h<l.items.length?l.items[h].id:null;return Mu(H,m,l.id),mi(),vt(H),!0}function Uu(e){if(b<0||!e)return!1;const n=k[b].data.categories||[];if(!n.length)return!1;const o=hi();if(!o)return!1;const i=n.findIndex(l=>l.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),Ue=s.id,qa(),nt=null,Yt(),At(),yt(),Yo(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function Hu(){if(b<0)return!1;const e=k[b],t=pt(e)||(e?e.id:null),n=[];if(Gt&&t===Gt.modelId&&n.push({...Gt,type:"item"}),Vt&&t===Vt.modelId&&n.push({...Vt,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(Wu(o))return!0}else if(o.type==="item"&&Fu(o))return!0;return!1}function Fu(e){const t=k[b],n=pt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(l=>l.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),Gt=null,mo(),H=null,It=null,Yt(),At(),yt(),mi(),vt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function Wu(e){const t=k[b],n=pt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),Vt=null,H=null,It=null,Ue=e.category.id,nt=null,Yt(),At(),yt(),Yo(),Wn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function kl(){if(!H||b<0)return!1;const t=k[b].data.categories||[];if(!t.length)return!1;const n=pe.get(H);let o=null;if(n!=null&&n.catId&&(o=t.find(h=>h.id===n.catId)),o||(o=t.find(h=>(h.items||[]).some(m=>m.id===H))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(h=>h.id===H);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=k[b];Gt={item:a,categoryId:o.id,index:i,modelId:pt(s)||(s?s.id:null),ts:Date.now()};const u=(()=>{var m;if(o.items.length){const S=Math.min(i,o.items.length-1);return((m=o.items[S])==null?void 0:m.id)||null}const h=t.findIndex(S=>S.id===o.id);if(h===-1)return null;for(let S=h+1;S<t.length;S++){const P=t[S].items||[];if(P.length)return P[0].id}for(let S=h-1;S>=0;S--){const P=t[S].items||[];if(P.length)return P[0].id}return null})();return mo(),H=null,It=null,nt=null,Yt(),At(),yt(),mi(),u?vt(u):Xo(),console.log("[Blockscape] removed item",a.id),!0}function ju(){var l,u;const e=hi();if(!e||b<0)return!1;const n=k[b].data.categories||[];if(!n.length)return!1;const o=n.findIndex(h=>h.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=k[b];Vt={category:i,index:o,modelId:pt(a)||(a?a.id:null),ts:Date.now()},Ue=null,H=null,It=null,nt=null,Yt(),At(),yt();const s=((l=n[o])==null?void 0:l.id)||((u=n[o-1])==null?void 0:u.id)||null;return s?Wn(s):Xo(),console.log("[Blockscape] removed category",i.id),!0}function zu(e){if(!e)return!1;const t=H;H=e;const n=kl();return n||(H=t,Yt()),n}ve&&ve.addEventListener("click",async()=>{const e=f.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await Rs(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),R&&R.addEventListener("click",async()=>{const e=jd();if(!e){alert("No series available to copy. Create another version first.");return}await Rs(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),Ie&&Ie.addEventListener("click",async()=>{try{const e=await qc();if(!e){alert("Clipboard is empty.");return}f.value=e,f.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await fi(),t=Hn(f.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=Tn(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),b===-1&&n!=null?xt(n):Un(),e&&await Il(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(b<0){alert("No active model selected.");return}try{const t=JSON.parse(f.value);if(An(t,{titleHint:Ge(k[b]),idHint:pt(k[b])||Ge(k[b])}),k[b].data=t,k[b].title=t.title||k[b].title,k[b].isSeries||((e=k[b].apicurioVersions)==null?void 0:e.length)>1){const n=k[b].title||Ge(k[b]);Pt(k[b],{seriesName:n,fallbackTitle:n})}Fa(),console.log("[Blockscape] replaced active model:",Ge(k[b])),yt(),Ne.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=Hn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((l,u)=>{var V;const h=(((V=l.data)==null?void 0:V.title)??"").toString().trim(),m=s.length>1?`${o.name} #${u+1}`:o.name,S=`${a} series`,P=l.isSeries?S:null;let N={...l};if(l.isSeries){const te=P||h||l.title||m||"unknown";N.title=te;const Be=bn(te||"unknown");po(N,Be),Pt(N,{seriesName:te,fallbackTitle:"unknown"}),N.apicurioArtifactName=N.apicurioArtifactName||te}else N.title=h||m;const L=Tn({...N,apicurioArtifactName:N.apicurioArtifactName||P||N.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=L)})}b===-1&&n!=null?xt(n):Un()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",Gu);async function Gu(e){var a;if(!ho())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!cu(t))return;let n=[];try{const s=await fi();n=Hn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,l)=>{const u=Tn(s,{versionLabel:n.length>1?`paste #${l+1}`:"paste"});o==null&&(o=u),i.push(u)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&xt(o),await fi()&&await Il(i,{origin:"clipboard"})}async function Il(e,{origin:t="clipboard"}={}){if(!await fi()||typeof(Je==null?void 0:Je.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter(P=>{const N=k[P];return N&&!N.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=k[o[0]],s=ed(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const l=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(l==null)return;const u=uo(l);if(!u){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const h=await Zc(),m=[];for(let P=0;P<o.length;P++){const N=o.length===1?u:Xc(u,P+1),L=Qc(N,h);if(!L){alert("Could not find a unique filename to save.");return}h.add(L),m.push(L)}let S=null;for(let P=0;P<o.length;P++){const N=o[P],L=m[P],V=k[N];if(!V)continue;o.length===1&&td(V,L);const te=await Je.saveModelByIndex(N,L,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(te!=null&&te.ok)){alert(`Local auto-save failed: ${(te==null?void 0:te.error)||"unknown error"}`);return}S==null&&(S=L)}S&&Ki(S),await Je.refresh(),Un(),Nn(`Saved ${o.length} ${i}.`,2500)}J.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&xt(n)}),document.getElementById("removeModel").onclick=()=>{if(b<0)return;const e=Ge(k[b]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",Ge(k[b])),k.splice(b,1),!k.length){b=-1,y=null,C.innerHTML="",j.innerHTML="",f.value="",Un(),Fa();return}const n=Math.min(b,k.length-1);xt(n)},Se&&(Se.addEventListener("input",e=>{al(e.target.value||"")}),Se.addEventListener("focus",()=>{Se.value&&Se.value.trim()&&il(Se.value)})),be&&be.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;iu({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!be||be.hidden)return;const t=e.target;be.contains(t)||Se&&(t===Se||Se.contains(t))||(be.hidden=!0)}),x&&re&&G&&x.addEventListener("submit",async e=>{e.preventDefault();const t=re.value.trim();if(!t){alert("Please enter a URL"),re.focus();return}const n=await Xa(t);if(typeof n=="number"){xt(n),re.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!re||!t)return;let n=null;re.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=re.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function yt(){if(!(b<0))try{ta(k[b]),y=fu(k[b].data),mi()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Ju(){const e=["comms.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>Di?Di.endsWith("/")?`${Di}${n}`:`${Di}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=Hn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(l=>{let u={...l};if(l.isSeries){const h=`${a} series`;u={...l,title:h,apicurioArtifactName:h};const m=bn(h||"unknown");po(u,m),Pt(u,{seriesName:h,fallbackTitle:"unknown"})}Tn(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}Un()}async function Cl(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function Ku(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>qu(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");xl(i)&&_l(o,i)})}function qu(e){var l,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(l=e.parentNode)==null?void 0:l.closest)!=null&&u.call(l,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:h,index:m})=>{m>s&&a.appendChild(document.createTextNode(t.slice(s,m))),a.appendChild(Yu(h)),s=m+h.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function Yu(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",xl(e)&&_l(t,e),t}function _l(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Xu(n,t,e)))}async function Xu(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await Xa(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function xl(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function Xa(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Cl(e),o=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=Hn(t,o)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let a=null;return i.forEach((s,l)=>{var N;const u=(((N=s.data)==null?void 0:N.title)??"").toString().trim(),h=i.length>1?`${o} #${l+1}`:o,m=s.isSeries?`${o} series`:null;let S={...s};if(s.isSeries){const L=m||u||S.title||h;S={...s,title:L,apicurioArtifactName:L||s.apicurioArtifactName};const V=bn(L||"unknown");po(S,V),Pt(S,{seriesName:L||m||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:V,url:e,baseName:o,seriesTitle:L})}const P=Tn({...S,title:u||S.title||h,apicurioArtifactName:S.apicurioArtifactName||m||s.apicurioArtifactName},{versionLabel:o});a==null&&(a=P)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,o),b===-1&&a!=null?xt(a):Un(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=Hn(n,"Blockscape");if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(N=>{const L=Tn(N,{versionLabel:"seed"});i==null&&(i=L)}),await $c(),!await Is&&c.autoLoadFromDir&&await Ju();const s=await uu(),l=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,u=await pu(),h=cl(),m=h==null?void 0:h.index,S=du(),P=typeof l=="number"?l:typeof u=="number"?u:typeof S=="number"?S:typeof m=="number"?m:i??0;xt(P),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===P&&requestAnimationFrame(()=>{var L;if(b!==s.modelIndex)return;const N=(L=pe.get(s.itemId))==null?void 0:L.el;N&&(vt(s.itemId),N.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),N.focus({preventScroll:!0}))})})()}const uc=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function pc(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function fc(r){return uc(pc())}const mc=`${fc()}documentation/`;function hc(r){let c;return{c(){c=F("div"),c.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Open the <a href="${mc}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,w(c,"id","shortcutHelp"),w(c,"class","shortcut-help"),c.hidden=!0,w(c,"aria-hidden","true"),w(c,"role","dialog"),w(c,"aria-modal","true"),w(c,"aria-labelledby","shortcutHelpTitle")},m(f,T){kt(f,c,T)},p:$t,i:$t,o:$t,d(f){f&&gt(c)}}}class gc extends Pi{constructor(c){super(),Oi(this,c,null,hc,Li,{})}}const bc=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
        * optional \`stage\`: integer 1–4 for Wardley maps only (1=genesis, 2=custom, 3=product, 4=commodity/service). Include only when the user explicitly asks for a Wardley model/series.
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping. Only include the \`stage\` field when explicitly asked for a Wardley map/series.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function Xr(r){let c,f,T,C,j,Q,J,ne;return{c(){c=F("div"),f=F("div"),T=F("a"),C=ha("Open Blockscape GPT"),j=ue(),Q=F("div"),Q.textContent="Paste the copied prompt into that chat.",J=ue(),ne=F("div"),ne.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',w(T,"href",vc),w(T,"target","_blank"),w(T,"rel","noreferrer"),w(Q,"class","new-panel__hint"),w(f,"class","new-panel__link"),w(ne,"class","new-panel__link new-panel__link--disabled"),w(c,"class","new-panel__links")},m(x,re){kt(x,c,re),A(c,f),A(f,T),A(T,C),A(f,j),A(f,Q),A(c,J),A(c,ne)},p:$t,d(x){x&&gt(c)}}}function Zr(r){let c,f,T,C,j,Q;return{c(){c=F("div"),f=F("div"),f.textContent="Generated prompt",T=ue(),C=F("textarea"),w(f,"class","new-panel__prompt-label"),w(C,"class","pf-v5-c-form-control new-panel__textarea"),w(C,"rows","4"),C.readOnly=!0,w(c,"class","new-panel__prompt")},m(J,ne){kt(J,c,ne),A(c,f),A(c,T),A(c,C),oo(C,r[4]),j||(Q=no(C,"input",r[12]),j=!0)},p(J,ne){ne&16&&oo(C,J[4])},d(J){J&&gt(c),j=!1,Q()}}}function wc(r){let c,f,T,C,j,Q,J,ne,x,re,G,ie,Me,Qe,qe,je,ze,W,q,ve,R,Ie,Oe,ce,at,se,ge,lt,O,Z,I,ee,Se,be,ke,$e,g,Te,Ye,et,We,dt,tt,ct,ft,mt,k,b=r[2]==="gpt"&&Xr(),Ne=r[4]&&r[5]&&Zr(r);return ft=Hl(r[10][0]),{c(){c=F("div"),f=F("div"),T=ue(),C=F("div"),j=F("div"),j.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',Q=ue(),J=F("form"),ne=F("div"),x=F("label"),x.textContent="Domain",re=ue(),G=F("p"),G.textContent="Describe what you want to create a map for.",ie=ue(),Me=F("textarea"),Qe=ue(),qe=F("div"),je=F("label"),ze=F("input"),W=ue(),q=F("span"),q.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,ve=ue(),R=F("fieldset"),Ie=F("legend"),Ie.textContent="Target",Oe=ue(),ce=F("p"),ce.textContent="Choose where you plan to use the prompt.",at=ue(),se=F("label"),ge=F("input"),lt=ue(),O=F("div"),O.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',Z=ue(),I=F("label"),ee=F("input"),Se=ue(),be=F("div"),be.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',ke=ue(),$e=F("div"),g=F("button"),g.textContent="Copy prompt",Te=ue(),Ye=F("button"),Ye.textContent="New blank",et=ue(),We=F("div"),dt=ha(r[3]),tt=ue(),b&&b.c(),ct=ue(),Ne&&Ne.c(),w(f,"id","newPanelBackdrop"),w(f,"class","shortcut-help__backdrop"),w(j,"class","shortcut-help__header"),w(x,"for","newDomain"),w(G,"class","new-panel__hint"),w(Me,"id","newDomain"),w(Me,"class","pf-v5-c-form-control new-panel__textarea"),w(Me,"rows","4"),Me.required=!0,w(Me,"placeholder","Ex: Companies building open-source geospatial tools"),w(ne,"class","new-panel__field"),w(ze,"id","seriesToggle"),w(ze,"type","checkbox"),w(je,"class","new-panel__toggle"),w(je,"for","seriesToggle"),w(qe,"class","new-panel__field"),w(ce,"class","new-panel__hint"),w(ge,"type","radio"),w(ge,"name","target"),ge.__value="gpt",oo(ge,ge.__value),w(se,"class","new-panel__option"),w(ee,"type","radio"),w(ee,"name","target"),ee.__value="plain",oo(ee,ee.__value),w(I,"class","new-panel__option"),w(R,"class","new-panel__field"),w(g,"class","pf-v5-c-button pf-m-primary"),w(g,"type","submit"),w(Ye,"id","newBlankButton"),w(Ye,"class","pf-v5-c-button pf-m-secondary"),w(Ye,"type","button"),w(Ye,"title","Start from an empty map"),w(We,"class","new-panel__status"),w(We,"aria-live","polite"),w($e,"class","new-panel__actions"),w(J,"class","shortcut-help__list new-panel__form"),w(C,"class","shortcut-help__panel"),w(C,"tabindex","-1"),w(c,"id","newPanel"),w(c,"class","shortcut-help"),c.hidden=!0,w(c,"aria-hidden","true"),w(c,"role","dialog"),w(c,"aria-modal","true"),w(c,"aria-labelledby","newPanelTitle"),ft.p(ge,ee)},m(y,pe){kt(y,c,pe),A(c,f),A(c,T),A(c,C),A(C,j),A(C,Q),A(C,J),A(J,ne),A(ne,x),A(ne,re),A(ne,G),A(ne,ie),A(ne,Me),oo(Me,r[0]),A(J,Qe),A(J,qe),A(qe,je),A(je,ze),ze.checked=r[1],A(je,W),A(je,q),A(J,ve),A(J,R),A(R,Ie),A(R,Oe),A(R,ce),A(R,at),A(R,se),A(se,ge),ge.checked=ge.__value===r[2],A(se,lt),A(se,O),A(R,Z),A(R,I),A(I,ee),ee.checked=ee.__value===r[2],A(I,Se),A(I,be),A(J,ke),A(J,$e),A($e,g),A($e,Te),A($e,Ye),A($e,et),A($e,We),A(We,dt),A(J,tt),b&&b.m(J,null),A(J,ct),Ne&&Ne.m(J,null),mt||(k=[no(Me,"input",r[7]),no(ze,"change",r[8]),no(ge,"change",r[9]),no(ee,"change",r[11]),no(J,"submit",Ul(r[6]))],mt=!0)},p(y,[pe]){pe&1&&oo(Me,y[0]),pe&2&&(ze.checked=y[1]),pe&4&&(ge.checked=ge.__value===y[2]),pe&4&&(ee.checked=ee.__value===y[2]),pe&8&&Wl(dt,y[3]),y[2]==="gpt"?b?b.p(y,pe):(b=Xr(),b.c(),b.m(J,ct)):b&&(b.d(1),b=null),y[4]&&y[5]?Ne?Ne.p(y,pe):(Ne=Zr(y),Ne.c(),Ne.m(J,null)):Ne&&(Ne.d(1),Ne=null)},i:$t,o:$t,d(y){y&&gt(c),b&&b.d(),Ne&&Ne.d(),ft.r(),mt=!1,ti(k)}}}const vc="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function yc(r,c,f){let T="",C=!1,j="gpt",Q="",J="",ne=!1;const x=()=>{var W;return typeof navigator<"u"&&!!((W=navigator.clipboard)!=null&&W.writeText)};function re(W){const q=W||"[DOMAIN]",ve=C?"series":"map",Ie=bc.replaceAll("[DOMAIN NAME]",q).replaceAll("[DOMAIN]",q).replaceAll("[map|series]",ve).split(`
`),Oe=`Generate a **blockscape ${ve}** for the domain of ${q}.`,ce=Ie.findIndex(se=>se.toLowerCase().includes("generate a **blockscape value")||se.toLowerCase().includes("generate a blockscape [map|series]")||se.toLowerCase().startsWith("generate a blockscape"));ce>=0?Ie[ce]=Oe:Ie.unshift(Oe);const at=C?`

User requested a series (return an array of models).`:"";return`${Ie.join(`
`).trim()}${at}`}async function G(W){W.preventDefault();const q=T.trim();if(f(3,Q=""),f(5,ne=j!=="gpt"),!q){f(3,Q="Add a domain to generate a prompt."),f(4,J="");return}if(j==="gpt"?f(4,J=`${C?"Create a series":"Create a map"} for ${q}`):(f(4,J=re(q)),f(5,ne=!0)),!x()){f(3,Q="Clipboard access is unavailable. Copy the prompt below."),f(5,ne=!0);return}try{await navigator.clipboard.writeText(J),f(3,Q=j==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),j==="gpt"&&f(5,ne=!1)}catch(R){console.warn("[Blockscape] clipboard write failed",R),f(3,Q="Copy failed. Use the prompt below."),f(5,ne=!0)}}const ie=[[]];function Me(){T=this.value,f(0,T)}function Qe(){C=this.checked,f(1,C)}function qe(){j=this.__value,f(2,j)}function je(){j=this.__value,f(2,j)}function ze(){J=this.value,f(4,J)}return[T,C,j,Q,J,ne,G,Me,Qe,qe,ie,je,ze]}class Ec extends Pi{constructor(c){super(),Oi(this,c,yc,wc,Li,{})}}const{document:Qr}=Dl;function Sc(r){let c,f,T,C,j,Q,J,ne,x,re,G,ie,Me,Qe,qe,je,ze,W,q,ve,R,Ie,Oe,ce,at,se,ge,lt,O,Z,I,ee,Se,be,ke,$e,g,Te,Ye,et,We,dt,tt,ct,ft,mt,k,b,Ne,y,pe,jt,H,Ue,It,nt,nn,Rn,zt,ln,Gt,Vt,ao,On,qn,Dt,Xt,wn,Zt,Jt,Ct,on,vn,an,yn,d=`<script id="seed" type="application/json">${r[4]}<\/script>`,v,M,B,E,D,X,Y,ye,Ee,me,He,Xe,he,Rt,bt;return me=new gc({}),Xe=new Ec({}),{c(){c=F("link"),f=ue(),T=F("div"),C=F("header"),j=F("div"),Q=F("div"),J=F("div"),ne=F("div"),ne.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',x=ue(),re=F("div"),G=F("div"),ie=F("button"),Me=F("span"),Me.textContent="Advanced",Qe=ue(),qe=F("span"),qe.textContent="▾",ze=ue(),W=F("button"),W.textContent="New",q=ue(),ve=F("label"),ve.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',R=ue(),Ie=F("button"),Ie.textContent="Share",Oe=ue(),ce=F("button"),ce.textContent="Help",at=ue(),se=F("div"),ge=F("div"),ge.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',lt=ue(),O=F("form"),O.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',Z=ue(),I=F("button"),I.textContent="Edit",ke=ue(),$e=F("a"),$e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',Te=ue(),Ye=F("main"),et=F("div"),We=F("aside"),dt=F("div"),dt.textContent="Models",tt=ue(),ct=F("ul"),ft=ue(),mt=F("div"),mt.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',k=ue(),b=F("section"),Ne=F("div"),Ne.textContent="Local files",y=ue(),pe=F("p"),pe.textContent="Checking for local server…",jt=ue(),H=F("div"),Ue=F("label"),Ue.textContent="Blockscape files under ~/blockscape",It=ue(),nt=F("div"),nn=F("label"),nn.textContent="Folder",Rn=ue(),zt=F("select"),ln=F("option"),ln.textContent="All (~/blockscape)",Gt=ue(),Vt=F("select"),ao=ue(),On=F("div"),On.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button>',qn=ue(),Dt=F("div"),Dt.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',wn=ue(),Zt=F("div"),Zt.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,stage?:1-4,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,Jt=ue(),Ct=F("footer"),on=F("div"),on.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',an=ue(),yn=new jl(!1),v=ue(),M=Fr("svg"),B=ue(),E=F("div"),D=ue(),X=F("div"),Y=ue(),ye=F("div"),ye.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',Ee=ue(),ya(me.$$.fragment),He=ue(),ya(Xe.$$.fragment),Qr.title="Blockscape — simple landscape-style tiles",w(c,"rel","icon"),w(c,"type","image/svg+xml"),w(c,"href","./favicon.svg"),w(ne,"class","blockscape-brand"),w(Me,"class","blockscape-toolbar__toggle-label"),w(qe,"class","blockscape-toolbar__toggle-icon"),w(qe,"aria-hidden","true"),w(ie,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),w(ie,"type","button"),w(ie,"aria-expanded",r[0]),w(ie,"aria-controls","blockscapeHeaderExtras"),w(ie,"aria-label",je=r[0]?"Hide advanced tools":"Show advanced tools"),w(W,"id","newPanelButton"),w(W,"class","pf-v5-c-button pf-m-primary"),w(W,"type","button"),w(W,"title","Create something new"),w(ve,"class","pf-v5-c-button pf-m-primary blockscape-file"),w(Ie,"id","shareModel"),w(Ie,"class","pf-v5-c-button pf-m-secondary"),w(Ie,"type","button"),w(Ie,"title","Copy a shareable URL for this model"),w(ce,"id","helpButton"),w(ce,"class","pf-v5-c-button pf-m-primary"),w(ce,"type","button"),w(ce,"title","Show keyboard shortcuts"),w(G,"class","blockscape-toolbar__primary"),w(ge,"class","blockscape-search"),w(O,"id","urlForm"),w(O,"class","blockscape-url-form"),w(O,"autocomplete","on"),O.noValidate=!0,w(I,"id","openInEditor"),w(I,"class","pf-v5-c-button pf-m-secondary"),w(I,"type","button"),w(I,"title","Open current JSON in the editor"),w(se,"id","blockscapeHeaderExtras"),w(se,"class","blockscape-toolbar__extras"),se.hidden=ee=!r[0],w(se,"aria-hidden",Se=!r[0]),w(re,"class","blockscape-toolbar__controls"),w(re,"data-expanded",be=r[0]?"true":"false"),w($e,"href","https://github.com/pwright/blockscape"),w($e,"target","_blank"),w($e,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),w($e,"title","View on GitHub"),w($e,"aria-label","View Blockscape on GitHub"),w(J,"class","blockscape-toolbar"),w(Q,"class","pf-v5-c-masthead__content"),w(j,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),w(C,"class","pf-v5-c-page__header"),C.hidden=g=!r[3],w(dt,"class","sidebar-heading"),w(ct,"id","modelList"),w(ct,"class","model-nav-list"),w(mt,"class","model-actions"),w(Ne,"class","sidebar-heading"),w(pe,"id","localBackendStatus"),w(pe,"class","local-backend__status muted"),w(Ue,"class","sr-only"),w(Ue,"for","localFileList"),w(nn,"for","localDirSelect"),ln.__value="",oo(ln,ln.__value),w(zt,"id","localDirSelect"),w(zt,"class","pf-v5-c-form-control"),w(zt,"aria-label","Folder filter"),w(nt,"class","local-backend__dir"),w(Vt,"id","localFileList"),w(Vt,"class","pf-v5-c-form-control"),w(Vt,"size","12"),Vt.multiple=!0,w(Vt,"aria-label","Blockscape files on local server"),w(On,"class","local-backend__actions"),w(H,"class","local-backend__list"),w(Dt,"class","local-backend__save"),w(b,"id","localBackendPanel"),w(b,"class","local-backend"),b.hidden=!0,w(We,"class","blockscape-sidebar"),w(We,"aria-label","Models"),We.hidden=Xt=!r[2],w(Zt,"class","blockscape-main"),w(et,"class","blockscape-content"),w(Ye,"class","pf-v5-c-page__main"),w(on,"class","blockscape-footer__inner"),w(Ct,"class","pf-v5-c-page__footer blockscape-footer"),Ct.hidden=vn=!r[1],w(T,"class","pf-v5-c-page"),yn.a=v,w(M,"id","overlay"),w(M,"class","svg-layer"),w(E,"id","tabTooltip"),w(E,"class","blockscape-tab-tooltip"),E.hidden=!0,w(E,"aria-hidden","true"),w(X,"id","tileContextMenu"),w(X,"class","tile-context-menu"),X.hidden=!0,w(X,"aria-hidden","true"),w(ye,"id","itemPreview"),w(ye,"class","item-preview"),ye.hidden=!0,w(ye,"aria-hidden","true")},m(de,oe){A(Qr.head,c),kt(de,f,oe),kt(de,T,oe),A(T,C),A(C,j),A(j,Q),A(Q,J),A(J,ne),A(J,x),A(J,re),A(re,G),A(G,ie),A(ie,Me),A(ie,Qe),A(ie,qe),A(G,ze),A(G,W),A(G,q),A(G,ve),A(G,R),A(G,Ie),A(G,Oe),A(G,ce),A(re,at),A(re,se),A(se,ge),A(se,lt),A(se,O),A(se,Z),A(se,I),A(J,ke),A(J,$e),A(T,Te),A(T,Ye),A(Ye,et),A(et,We),A(We,dt),A(We,tt),A(We,ct),A(We,ft),A(We,mt),A(We,k),A(We,b),A(b,Ne),A(b,y),A(b,pe),A(b,jt),A(b,H),A(H,Ue),A(H,It),A(H,nt),A(nt,nn),A(nt,Rn),A(nt,zt),A(zt,ln),A(H,Gt),A(H,Vt),A(H,ao),A(H,On),A(b,qn),A(b,Dt),A(et,wn),A(et,Zt),A(T,Jt),A(T,Ct),A(Ct,on),kt(de,an,oe),yn.m(d,de,oe),kt(de,v,oe),kt(de,M,oe),kt(de,B,oe),kt(de,E,oe),kt(de,D,oe),kt(de,X,oe),kt(de,Y,oe),kt(de,ye,oe),kt(de,Ee,oe),$i(me,de,oe),kt(de,He,oe),$i(Xe,de,oe),he=!0,Rt||(bt=no(ie,"click",r[5]),Rt=!0)},p(de,[oe]){(!he||oe&1)&&w(ie,"aria-expanded",de[0]),(!he||oe&1&&je!==(je=de[0]?"Hide advanced tools":"Show advanced tools"))&&w(ie,"aria-label",je),(!he||oe&1&&ee!==(ee=!de[0]))&&(se.hidden=ee),(!he||oe&1&&Se!==(Se=!de[0]))&&w(se,"aria-hidden",Se),(!he||oe&1&&be!==(be=de[0]?"true":"false"))&&w(re,"data-expanded",be),(!he||oe&8&&g!==(g=!de[3]))&&(C.hidden=g),(!he||oe&4&&Xt!==(Xt=!de[2]))&&(We.hidden=Xt),(!he||oe&2&&vn!==(vn=!de[1]))&&(Ct.hidden=vn)},i(de){he||(Bi(me.$$.fragment,de),Bi(Xe.$$.fragment,de),he=!0)},o(de){va(me.$$.fragment,de),va(Xe.$$.fragment,de),he=!1},d(de){de&&(gt(f),gt(T),gt(an),yn.d(),gt(v),gt(M),gt(B),gt(E),gt(D),gt(X),gt(Y),gt(ye),gt(Ee),gt(He)),gt(c),Ri(me,de),Ri(Xe,de),Rt=!1,bt()}}}function kc(r,c,f){let T,C,j,{seed:Q}=c,{features:J={}}=c;const x=Q?JSON.stringify(Q,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let re=!1;const G=()=>{if(f(0,re=!re),!re){const ie=document.getElementById("search");ie&&ie.value&&(ie.value="",ie.dispatchEvent(new Event("input",{bubbles:!0})))}};return Gl(()=>{dc(J)}),r.$$set=ie=>{"seed"in ie&&f(6,Q=ie.seed),"features"in ie&&f(7,J=ie.features)},r.$$.update=()=>{r.$$.dirty&128&&f(3,T=J.showHeader!==!1),r.$$.dirty&128&&f(2,C=J.showSidebar!==!1),r.$$.dirty&128&&f(1,j=J.showFooter!==!1)},[re,j,C,T,x,G,Q,J]}class Ic extends Pi{constructor(c){super(),Oi(this,c,kc,Sc,Li,{seed:6,features:7})}}function Cc(r){let c,f;return c=new Ic({props:{seed:r[0],features:r[1]}}),{c(){ya(c.$$.fragment)},m(T,C){$i(c,T,C),f=!0},p(T,[C]){const j={};C&1&&(j.seed=T[0]),C&2&&(j.features=T[1]),c.$set(j)},i(T){f||(Bi(c.$$.fragment,T),f=!0)},o(T){va(c.$$.fragment,T),f=!1},d(T){Ri(c,T)}}}function _c(r,c,f){let{seed:T}=c,{features:C={}}=c;return r.$$set=j=>{"seed"in j&&f(0,T=j.seed),"features"in j&&f(1,C=j.features)},[T,C]}class xc extends Pi{constructor(c){super(),Oi(this,c,_c,Cc,Li,{seed:0,features:1})}}return xc}();
