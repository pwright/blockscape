var Blockscape=function(){"use strict";var nf=Object.defineProperty;var of=($n,Vt,ro)=>Vt in $n?nf($n,Vt,{enumerable:!0,configurable:!0,writable:!0,value:ro}):$n[Vt]=ro;var ao=($n,Vt,ro)=>of($n,typeof Vt!="symbol"?Vt+"":Vt,ro);var $n=typeof document<"u"?document.currentScript:null;function Vt(){}function ro(r){return r()}function os(){return Object.create(null)}function _o(r){r.forEach(ro)}function is(r){return typeof r=="function"}function Ui(r,c){return r!=r?c==c:r!==c||r&&typeof r=="object"||typeof r=="function"}function tc(r){return Object.keys(r).length===0}const nc=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function k(r,c){r.appendChild(c)}function Mt(r,c,f){r.insertBefore(c,f||null)}function kt(r){r.parentNode&&r.parentNode.removeChild(r)}function W(r){return document.createElement(r)}function as(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function Hi(r){return document.createTextNode(r)}function le(){return Hi(" ")}function Ln(r,c,f,T){return r.addEventListener(c,f,T),()=>r.removeEventListener(c,f,T)}function oc(r){return function(c){return c.preventDefault(),r.call(this,c)}}function b(r,c,f){f==null?r.removeAttribute(c):r.getAttribute(c)!==f&&r.setAttribute(c,f)}function ic(r){let c;return{p(...f){c=f,c.forEach(T=>r.push(T))},r(){c.forEach(f=>r.splice(r.indexOf(f),1))}}}function ac(r){return Array.from(r.childNodes)}function rs(r,c){c=""+c,r.data!==c&&(r.data=c)}function so(r,c){r.value=c??""}class rc{constructor(c=!1){ao(this,"is_svg",!1);ao(this,"e");ao(this,"n");ao(this,"t");ao(this,"a");this.is_svg=c,this.e=this.n=null}c(c){this.h(c)}m(c,f,T=null){this.e||(this.is_svg?this.e=as(f.nodeName):this.e=W(f.nodeType===11?"TEMPLATE":f.nodeName),this.t=f.tagName!=="TEMPLATE"?f:f.content,this.c(c)),this.i(T)}h(c){this.e.innerHTML=c,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(c){for(let f=0;f<this.n.length;f+=1)Mt(this.t,this.n[f],c)}p(c){this.d(),this.h(c),this.i(this.a)}d(){this.n.forEach(kt)}}let ci;function di(r){ci=r}function sc(){if(!ci)throw new Error("Function called outside component initialization");return ci}function lc(r){sc().$$.on_mount.push(r)}const xo=[],ss=[];let To=[];const ls=[],cc=Promise.resolve();let xa=!1;function dc(){xa||(xa=!0,cc.then(cs))}function Ta(r){To.push(r)}const Aa=new Set;let Ao=0;function cs(){if(Ao!==0)return;const r=ci;do{try{for(;Ao<xo.length;){const c=xo[Ao];Ao++,di(c),uc(c.$$)}}catch(c){throw xo.length=0,Ao=0,c}for(di(null),xo.length=0,Ao=0;ss.length;)ss.pop()();for(let c=0;c<To.length;c+=1){const f=To[c];Aa.has(f)||(Aa.add(f),f())}To.length=0}while(xo.length);for(;ls.length;)ls.pop()();xa=!1,Aa.clear(),di(r)}function uc(r){if(r.fragment!==null){r.update(),_o(r.before_update);const c=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,c),r.after_update.forEach(Ta)}}function pc(r){const c=[],f=[];To.forEach(T=>r.indexOf(T)===-1?c.push(T):f.push(T)),f.forEach(T=>T()),To=c}const Fi=new Set;let fc;function Wi(r,c){r&&r.i&&(Fi.delete(r),r.i(c))}function La(r,c,f,T){if(r&&r.o){if(Fi.has(r))return;Fi.add(r),fc.c.push(()=>{Fi.delete(r)}),r.o(c)}}function Na(r){r&&r.c()}function ji(r,c,f){const{fragment:T,after_update:C}=r.$$;T&&T.m(c,f),Ta(()=>{const G=r.$$.on_mount.map(ro).filter(is);r.$$.on_destroy?r.$$.on_destroy.push(...G):_o(G),r.$$.on_mount=[]}),C.forEach(Ta)}function zi(r,c){const f=r.$$;f.fragment!==null&&(pc(f.after_update),_o(f.on_destroy),f.fragment&&f.fragment.d(c),f.on_destroy=f.fragment=null,f.ctx=[])}function mc(r,c){r.$$.dirty[0]===-1&&(xo.push(r),dc(),r.$$.dirty.fill(0)),r.$$.dirty[c/31|0]|=1<<c%31}function Gi(r,c,f,T,C,G,oe=null,Z=[-1]){const ee=ci;di(r);const _=r.$$={fragment:null,ctx:[],props:G,update:Vt,not_equal:C,bound:os(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(c.context||(ee?ee.$$.context:[])),callbacks:os(),dirty:Z,skip_bound:!1,root:c.target||ee.$$.root};oe&&oe(_.root);let pe=!1;if(_.ctx=f?f(r,c.props||{},(j,ce,...ge)=>{const rt=ge.length?ge[0]:ce;return _.ctx&&C(_.ctx[j],_.ctx[j]=rt)&&(!_.skip_bound&&_.bound[j]&&_.bound[j](rt),pe&&mc(r,j)),ce}):[],_.update(),pe=!0,_o(_.before_update),_.fragment=T?T(_.ctx):!1,c.target){if(c.hydrate){const j=ac(c.target);_.fragment&&_.fragment.l(j),j.forEach(kt)}else _.fragment&&_.fragment.c();c.intro&&Wi(r.$$.fragment),ji(r,c.target,c.anchor),cs()}di(ee)}class Ki{constructor(){ao(this,"$$");ao(this,"$$set")}$destroy(){zi(this,1),this.$destroy=Vt}$on(c,f){if(!is(f))return Vt;const T=this.$$.callbacks[c]||(this.$$.callbacks[c]=[]);return T.push(f),()=>{const C=T.indexOf(f);C!==-1&&T.splice(C,1)}}$set(c){this.$$set&&!tc(c)&&(this.$$.skip_bound=!0,this.$$set(c),this.$$.skip_bound=!1)}}const hc="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(hc);const ds="blockscape:apicurioConfig",Ma="http://localhost:8080/apis/registry/v3",Ji="bs",us="-series",Ba=!1,Pa=!1;function gc({models:r,getActiveIndex:c,setActive:f,ensureModelMetadata:T,ensureSeriesId:C,getModelId:G,getSeriesId:oe,getModelTitle:Z,computeJsonFingerprint:ee,uid:_}){let pe=null,j=null,ce=null,ge=null,rt=null,We=null,je=null,ze=null,z=null,H=null;const ie=new Set,D={baseUrl:Ma,groupId:Ji,authToken:"",enabled:Ba,useSemver:Pa},de=new Map,Ae=new Map;function _e(d){return(d||"").toString().trim().replace(/\/+$/,"")}function Be(d){return`${(d||"").toString().trim()||Ji}${us}`}function $e(){return!!(D.baseUrl&&D.groupId)}function be(){return D.enabled!==!1}function ht(){ie.forEach(d=>{try{d(be())}catch(v){console.warn("[Blockscape] failed to run Apicurio enabled listener",v)}})}function R(d){return typeof d=="function"&&ie.add(d),()=>ie.delete(d)}function ae(){ce&&(ce.value=D.baseUrl||""),ge&&(ge.value=D.groupId||""),rt&&(rt.value=D.authToken||""),We&&(We.checked=be()),je&&(je.checked=!!D.useSemver)}function x(d="",v="muted"){ze&&(ze.textContent=d||"",ze.classList.remove("is-error","is-success"),v==="error"?ze.classList.add("is-error"):v==="success"&&ze.classList.add("is-success"))}function J(d){if(!H||(H.innerHTML="",!d))return;const v=document.createElement("p");v.className="apicurio-hint",v.textContent=d,H.appendChild(v)}function Se(d){de.clear(),Ae.clear(),J(d)}function ue(){const d=c(),v=be(),B=$e(),N=d>=0?r[d]:null,E=!!(N!=null&&N.apicurioVersions&&N.apicurioVersions.length>1);if(pe){const U=pe.dataset.loading==="true",te=v&&B&&d>=0&&!!bt(r[d]);pe.disabled=!v||U||!te,v?U||(pe.textContent="Push to Apicurio"):pe.textContent="Enable Apicurio to push"}if(z){const U=z.dataset.loading==="true",te=v&&B&&E&&!!bt(N);z.disabled=!te||U,z.hidden=!E,v?U||(z.textContent="Push series"):z.textContent="Enable Apicurio to push series"}if(j){const U=j.dataset.loading==="true",te=v&&B;j.disabled=!te||U,U||(v?B?j.textContent="List artifacts":j.textContent="Enter details to list":j.textContent="Enable Apicurio to list")}}function Qe(){ae(),be()?$e()?(x("Apicurio push is ready when a model is selected.","muted"),de.size||J("Click “List artifacts” to browse the current group.")):(x("Enter Apicurio connection details to enable push.","muted"),Se("Enter registry details to browse artifacts.")):(x("Apicurio integration is off. Enable it to allow pushes.","muted"),Se("Apicurio integration is disabled.")),ue()}function re(){if(window!=null&&window.localStorage)try{localStorage.setItem(ds,JSON.stringify(D))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function Ye(){let d={};if(window!=null&&window.localStorage)try{const U=localStorage.getItem(ds);if(U){const te=JSON.parse(U);te&&typeof te=="object"&&(d=te)}}catch(U){console.warn("[Blockscape] failed to restore Apicurio settings",U)}const v=_e(d.baseUrl??Ma),B=(d.groupId??Ji).toString().trim();let N=Ba,E=Pa;typeof d.enabled=="boolean"?N=d.enabled:typeof d.enabled=="string"&&(N=d.enabled==="true"),typeof d.useSemver=="boolean"?E=d.useSemver:typeof d.useSemver=="string"&&(E=d.useSemver==="true"),D.baseUrl=v||Ma,D.groupId=B||Ji,D.authToken=(d.authToken??"").toString().trim(),D.enabled=N,D.useSemver=E,Qe(),ht()}function ft(){const d={Accept:"application/json"},v=(D.authToken||"").trim();return v&&(d.Authorization=/\s/.test(v)?v:`Bearer ${v}`),d}function st(d,v,{title:B,description:N,version:E}={}){const U={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:v},metadata:{properties:{}}}};E&&(U.firstVersion.version=E),B&&(U.name=B),N&&(U.description=N);try{const te=JSON.parse(v),X=te==null?void 0:te.seriesId;X&&typeof X=="string"&&(U.firstVersion.metadata.properties.seriesId=X)}catch{}return U}function pt(d,{version:v}={}){const B={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const N=JSON.parse(d),E=N==null?void 0:N.seriesId;E&&typeof E=="string"&&(B.metadata.properties.seriesId=E)}catch{}return v&&(B.version=v),B}function w(d){if(d==null)return null;const v=String(d).trim();if(!v)return null;const B=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(v);if(B)return{major:Number(B[1]),minor:Number(B[2]),patch:Number(B[3])};const N=/^v?(\d+)$/.exec(v);return N?{major:Number(N[1]),minor:0,patch:0}:null}function et(d){return`${d.major}.${d.minor}.${d.patch}`}function Bt(d,v){return!d&&!v?0:d?v?d.major!==v.major?d.major-v.major:d.minor!==v.minor?d.minor-v.minor:d.patch-v.patch:1:-1}function Ie(d=[]){let v=null;if(d.forEach(N=>{const E=w((N==null?void 0:N.version)??N);E&&(!v||Bt(E,v)>0)&&(v=E)}),!v)return"1.0.0";const B={...v,patch:v.patch+1};return et(B)}function bt(d,{seriesName:v,fallbackTitle:B}={}){var U;if(!d)return null;const N=v||d.title||d.apicurioArtifactName||Z(d),E=B||N;if(typeof C=="function"&&(d.isSeries||((U=d.apicurioVersions)==null?void 0:U.length)>1)&&C(d,{seriesName:N,fallbackTitle:E}),typeof oe=="function"){const te=oe(d,{seriesName:N,fallbackTitle:E});if(te)return te}return G(d)}function Pt(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function S(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function g(d=[]){if(!Array.isArray(d)||!d.length)return null;const v=[...d].filter(Boolean);return v.sort((B,N)=>{const E=B!=null&&B.createdOn?new Date(B.createdOn).getTime():0,U=N!=null&&N.createdOn?new Date(N.createdOn).getTime():0;if(E!==U)return U-E;const te=Number(B==null?void 0:B.version),X=Number(N==null?void 0:N.version),Le=Number.isFinite(te),Ee=Number.isFinite(X);if(Le&&Ee&&te!==X)return X-te;const ve=String((B==null?void 0:B.version)??"");return String((N==null?void 0:N.version)??"").localeCompare(ve,void 0,{numeric:!0})}),v[0]||null}function he(d){if(!d)return d;let v=d;if(!Array.isArray(d==null?void 0:d.categories)){const N=d==null?void 0:d.content;if(typeof N=="string")try{v=JSON.parse(N)}catch(E){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",E)}else N&&typeof N=="object"&&(v=N)}return v}async function q(d,v,B){const N=encodeURIComponent(v),E=encodeURIComponent(B),U=`${d}/groups/${N}/artifacts/${E}`,te=ft();te.Accept="application/json";const X=await fetch(U,{method:"GET",headers:te});if(!X.ok){let Le=X.statusText||"Unknown error";try{const Ee=await X.text();Ee&&(Le=Ee.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${X.status}): ${Le}`)}return X.json()}async function xe(d,v,B){const N=encodeURIComponent(v),E=encodeURIComponent(B),U=`${d}/groups/${N}/artifacts/${E}/versions?limit=50&order=desc`,te=ft();te.Accept="application/json";const X=await fetch(U,{method:"GET",headers:te});if(!X.ok){let Ee=X.statusText||"Unknown error";try{const ve=await X.text();ve&&(Ee=ve.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${X.status}): ${Ee}`)}const Le=await X.json();return S(Le).filter(Ee=>Ee&&Ee.version!=null)}async function It(d,v,B,N="latest"){const E=encodeURIComponent(v),U=encodeURIComponent(B),te=encodeURIComponent(N||"latest"),X=`${d}/groups/${E}/artifacts/${U}/versions/${te}/content`,Le=ft();Le.Accept="application/json, application/*+json, */*;q=0.8";const Ee=await fetch(X,{method:"GET",headers:Le});if(!Ee.ok){let lt=Ee.statusText||"Unknown error";try{const Ne=await Ee.text();Ne&&(lt=Ne.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${Ee.status}): ${lt}`)}const ve=await Ee.text();let Ke=null;try{Ke=JSON.parse(ve)}catch{throw new Error("Artifact content is not valid JSON.")}return he(Ke)}async function K(d,v,B,N="latest"){const E=await It(d,v,B,N);return{data:E,fingerprint:ee(E)}}async function A(d,v,B){try{const E=await xe(d,v,B);if(E!=null&&E.length){Ae.set(B,E);const U=g(E);if((U==null?void 0:U.version)!=null)return U.version}}catch(E){console.warn("[Blockscape] compare-version: unable to fetch versions list",E)}try{const E=await q(d,v,B);if((E==null?void 0:E.version)!=null)return E.version}catch(E){console.warn("[Blockscape] compare-version: unable to fetch metadata",E)}const N=Ae.get(B);if(N&&N.length){const E=g(N);if((E==null?void 0:E.version)!=null)return E.version}return"latest"}async function mt(d,v,B,N){if(!D.useSemver)return null;if(!N)return"1.0.0";try{const E=await xe(d,v,B);return Ie(E)}catch(E){throw new Error(`Unable to compute next semantic version: ${E.message}`)}}function Je(d=document){pe=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),z=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),j=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),ce=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),ge=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),rt=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),We=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),je=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),ze=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),H=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function cn(){D.baseUrl=_e((ce==null?void 0:ce.value)??D.baseUrl),D.groupId=((ge==null?void 0:ge.value)??"").trim(),D.authToken=((rt==null?void 0:rt.value)??"").trim(),re(),Qe()}function On(d){D.enabled=d!==!1,re(),Qe(),ht()}function en(){On(We?We.checked:Ba)}function Xn(){D.useSemver=je?je.checked:Pa,re(),Qe()}function wt(){[ce,ge,rt].forEach(d=>{d&&d.addEventListener("input",cn)}),pe&&pe.addEventListener("click",()=>{on()}),z&&z.addEventListener("click",()=>{dn()}),We&&We.addEventListener("change",en),je&&je.addEventListener("change",Xn),j&&j.addEventListener("click",Vn),H&&H.addEventListener("click",d=>{const v=d.target.closest("[data-artifact-version]");if(v){d.stopPropagation();const E=v.dataset.artifactId,U=v.dataset.artifactVersion;E&&U&&an(E,U);return}const B=d.target.closest("[data-artifact-load-all]");if(B){d.stopPropagation(),B.dataset.artifactId&&xn();return}const N=d.target.closest("[data-artifact-trigger]");if(N){const E=N.dataset.artifactId;if(!E)return;Jt(E)}})}function tn(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function lo(d){if(!d)return;d.innerHTML="";const v=tn();d.appendChild(v),Je(d),wt(),Qe()}function _n(d){if(!H)return;if(H.innerHTML="",!d.length){J("No artifacts found in this group.");return}const v=E=>{const U=document.createElement("section");U.className="apicurio-artifact-section";const te=document.createElement("h3");te.textContent=E,U.appendChild(te);const X=document.createElement("ul");return X.className="apicurio-artifact-list",U.appendChild(X),{section:U,list:X}},B=v("Series artifacts"),N=v("Artifacts");d.forEach(E=>{if(!(E!=null&&E.artifactId))return;const te=E._groupId&&E._groupId.endsWith(us)?B.list:N.list,X=document.createElement("li"),Le=document.createElement("button");Le.type="button",Le.className="apicurio-artifact",Le.dataset.artifactId=E.artifactId,Le.dataset.artifactTrigger="toggle";const Ee=document.createElement("span");Ee.className="apicurio-artifact-title",Ee.textContent=E.artifactId,Le.appendChild(Ee);const ve=[];if(E.name&&ve.push(E.name),E.version!=null&&ve.push(`v${E.version}`),E.type&&ve.push(E.type),E._groupId&&ve.push(E._groupId),ve.length){const Ne=document.createElement("span");Ne.className="apicurio-artifact-meta",Ne.textContent=ve.join(" • "),Le.appendChild(Ne)}if(E.description){const Ne=document.createElement("span");Ne.className="apicurio-artifact-meta",Ne.textContent=E.description,Le.appendChild(Ne)}X.appendChild(Le);const Ke=document.createElement("div");Ke.className="apicurio-version-list",Ke.dataset.versionPanel=E.artifactId,Ke.hidden=!0;const lt=document.createElement("p");lt.className="apicurio-hint",lt.textContent="Click to load the latest or open versions.",Ke.appendChild(lt),X.appendChild(Ke),te.appendChild(X)}),B.list.children.length&&H.appendChild(B.section),N.list.children.length&&H.appendChild(N.section)}function Nn(d){return H?H.querySelector(`[data-version-panel="${d}"]`):null}function nn(d,v){if(!d||(d.innerHTML="",!v))return;const B=document.createElement("p");B.className="apicurio-hint",B.textContent=v,d.appendChild(B)}function Wt(d,v){const B=Nn(d);if(B){if(B.innerHTML="",!v.length){nn(B,"No versions found for this artifact.");return}v.forEach(N=>{const E=document.createElement("button");E.type="button",E.className="apicurio-version-button",E.dataset.artifactId=d,E.dataset.artifactVersion=N.version;const U=[`Version ${N.version}`];if(N.createdOn){const te=new Date(N.createdOn);isNaN(te)||U.push(te.toISOString().slice(0,10))}E.textContent=U.join(" — "),B.appendChild(E)})}}async function Jt(d){const v=Nn(d);if(!v)return;if(v.dataset.open==="true"){v.hidden=!0,v.dataset.open="false";return}if(v.hidden=!1,v.dataset.open="true",v.dataset.loaded!=="true"){if(!$e()){nn(v,"Enter registry details first.");return}nn(v,"Loading versions…");try{const N=_e(D.baseUrl),E=de.get(d),U=D.groupId.trim(),te=(E==null?void 0:E._groupId)||U,X=await xe(N,te,d);Ae.set(d,X),v.dataset.loaded="true",Wt(d,X)}catch(N){console.error("[Blockscape] failed to load versions",N),nn(v,`Unable to fetch versions: ${N.message}`)}}}function hn(d,v){var N;const B=r.findIndex(E=>E.apicurioArtifactId===d);if(B!==-1){const E=r[B].id;r[B]={...v,id:E||v.id},((N=r[B].apicurioVersions)==null?void 0:N.length)>1&&(r[B].isSeries=!0),f(B)}else r.push(v),f(r.length-1)}async function Ct(d,v,B,N){const E=encodeURIComponent(v),U=encodeURIComponent(B),te=`${d}/groups/${E}/artifacts/${U}`;try{const X=await fetch(te,{method:"GET",headers:N});if(X.status===404)return!1;if(X.ok)return!0;throw X.status===401||X.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${X.status} while checking the artifact.`)}catch(X){throw X instanceof TypeError?new Error("Network error while contacting Apicurio registry."):X}}async function on(){var te;if(!pe||pe.dataset.loading==="true")return;if(!be()){x("Apicurio integration is off. Enable it first.","error");return}if(!$e()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=c();if(d<0||!r[d]){x("No active model to push.","error");return}const v=bt(r[d],{fallbackTitle:Z(r[d])});if(!v){x("Active model needs an id before pushing.","error");return}const B=_e(D.baseUrl),N=D.groupId.trim(),E=JSON.stringify(r[d].data,null,2),U=ft();pe.dataset.loading="true",pe.textContent="Pushing…",pe.disabled=!0,x("Pushing to Apicurio…","muted");try{const X=await Ct(B,N,v,U),Le=ee(r[d].data);if(X)try{const Ze=await A(B,N,v),{data:Xe,fingerprint:vt}=await K(B,N,v,Ze);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",Ze),console.log("local fingerprint",Le),console.log("registry fingerprint",vt),console.log("local payload",r[d].data),console.log("registry payload",Xe),console.groupEnd(),Le&&vt&&Le===vt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){x("Push cancelled (content matches the latest registry version).","muted");return}x("Pushing identical content by user choice.","muted")}else vt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(Ze){console.warn("[Blockscape] unable to compare registry content before push",Ze),x("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const Ee=D.useSemver?await mt(B,N,v,X):null;if(D.useSemver&&!Ee)throw new Error("Semantic versioning is enabled but no version could be computed.");const ve=encodeURIComponent(N),Ke=encodeURIComponent(v),lt=X?`${B}/groups/${ve}/artifacts/${Ke}/versions`:`${B}/groups/${ve}/artifacts`,Ne={...U,"Content-Type":"application/json"};Ee&&(Ne["X-Registry-Version"]=Ee,x(`Pushing to Apicurio as version ${Ee}…`,"muted"));const Et=X?pt(E,{version:Ee}):st(v,E,{title:Z(r[d]),description:(te=r[d].data)==null?void 0:te.abstract,version:Ee}),_t=await fetch(lt,{method:"POST",headers:Ne,body:JSON.stringify(Et)});if(!_t.ok){let Ze=_t.statusText||"Unknown error";try{const Xe=await _t.text();Xe&&(Ze=Xe.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${_t.status}): ${Ze}`)}let gt=null;try{gt=await _t.json()}catch{gt=null}const Re=(gt==null?void 0:gt.version)||(gt==null?void 0:gt.globalId)||"",ut=X?"Updated":"Created",jt=Re?` (version ${Re})`:"";x(`${ut} ${v}${jt}`,"success")}catch(X){console.error("[Blockscape] Apicurio push failed",X),x(`Apicurio push failed: ${X.message}`,"error")}finally{pe.dataset.loading="false",ue()}}async function dn(){var Ee,ve;if(!z||z.dataset.loading==="true")return;if(!be()){x("Apicurio integration is off. Enable it first.","error");return}if(!$e()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=c(),v=d>=0?r[d]:null;if(!v||!v.apicurioVersions||v.apicurioVersions.length<2){x("Series push requires a model with multiple versions.","error");return}const B=bt(v,{seriesName:v.title||v.apicurioArtifactName||Z(v)});if(!B){x("Active series needs an id before pushing.","error");return}typeof C=="function"&&C(v,{seriesName:v.title||v.apicurioArtifactName||Z(v)});const N=_e(D.baseUrl),E=D.groupId.trim(),U=v.apicurioVersions.map(Ke=>Ke.data),te=JSON.stringify(U,null,2),X=ft(),Le=Be(E);z.dataset.loading="true",z.textContent="Pushing…",z.disabled=!0,x("Pushing series to Apicurio…","muted");try{const Ke=await Ct(N,Le,B,X),lt=ee(U);if(Ke)try{const we=await A(N,Le,B),{data:Oe,fingerprint:co}=await K(N,Le,B,we);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",we),console.log("local fingerprint",lt),console.log("registry fingerprint",co),console.log("local payload (series)",U),console.log("registry payload",Oe),console.groupEnd(),lt&&co&&lt===co){if(!window.confirm("The current registry version matches this series. Push anyway?")){x("Series push cancelled (content matches latest).","muted");return}x("Pushing identical series by user choice.","muted")}else co?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(we){console.warn("[Blockscape] unable to compare registry content before series push",we),x("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const Ne=D.useSemver?await mt(N,Le,B,Ke):null;if(D.useSemver&&!Ne)throw new Error("Semantic versioning is enabled but no version could be computed.");const Et=encodeURIComponent(Le),_t=encodeURIComponent(B),gt=Ke?`${N}/groups/${Et}/artifacts/${_t}/versions`:`${N}/groups/${Et}/artifacts`,Re={...X,"Content-Type":"application/json"};Ne&&(Re["X-Registry-Version"]=Ne,x(`Pushing series to Apicurio as version ${Ne}…`,"muted"));const ut=Ke?pt(te,{version:Ne}):st(B,te,{title:v.apicurioArtifactName||((Ee=v.data)==null?void 0:Ee.title)||B,description:(ve=v.data)==null?void 0:ve.abstract,version:Ne}),jt=await fetch(gt,{method:"POST",headers:Re,body:JSON.stringify(ut)});if(!jt.ok){let we=jt.statusText||"Unknown error";try{const Oe=await jt.text();Oe&&(we=Oe.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${jt.status}): ${we}`)}let Ze=null;try{Ze=await jt.json()}catch{Ze=null}const Xe=(Ze==null?void 0:Ze.version)||(Ze==null?void 0:Ze.globalId)||"",vt=Ke?"Updated":"Created",un=Xe?` (version ${Xe})`:"";x(`${vt} ${B} series${un}`,"success")}catch(Ke){console.error("[Blockscape] Apicurio series push failed",Ke),x(`Apicurio series push failed: ${Ke.message}`,"error")}finally{z.dataset.loading="false",ue()}}async function Vn(){if(!j||j.dataset.loading==="true")return;if(!be()){x("Enable Apicurio integration to list artifacts.","error");return}if(!$e()){x("Enter registry base URL and group ID before listing.","error");return}const d=_e(D.baseUrl),v=D.groupId.trim(),B=Be(v),N=[{groupId:v,label:"base"},{groupId:B,label:"series"}];j.dataset.loading="true",j.textContent="Listing…",j.disabled=!0,x("Listing artifacts…","muted"),J("Contacting registry…");try{const E=ft();E.Accept="application/json";const U=[];for(const X of N){const Le=encodeURIComponent(X.groupId),Ee=`${d}/groups/${Le}/artifacts?limit=50&offset=0`,ve=await fetch(Ee,{method:"GET",headers:E});if(!ve.ok){let Ne=ve.statusText||"Unknown error";try{const Et=await ve.text();Et&&(Ne=Et.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${X.groupId} (${ve.status}): ${Ne}`);continue}const Ke=await ve.json(),lt=Pt(Ke).filter(Ne=>Ne&&Ne.artifactId);lt.forEach(Ne=>{Ne&&(Ne._groupId=X.groupId)}),U.push(...lt)}de.clear(),Ae.clear(),U.forEach(X=>{X!=null&&X.artifactId&&de.set(X.artifactId,X)}),_n(U);const te=U.length;x(te?`Found ${te} artifact${te===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",te?"success":"muted")}catch(E){console.error("[Blockscape] failed to list artifacts",E),Se("Unable to list artifacts."),x(`Listing failed: ${E.message}`,"error")}finally{j.dataset.loading="false",ue()}}async function an(d,v=null){var Ke,lt,Ne,Et,_t,gt;if(!d)return;if(!be()){x("Enable Apicurio integration to load artifacts.","error");return}if(!$e()){x("Enter registry connection details before loading artifacts.","error");return}const B=_e(D.baseUrl),N=D.groupId.trim(),E=d&&((Ke=de.get(d))==null?void 0:Ke._groupId)||N;let U=de.get(d);const te=async()=>{try{const Re=await q(B,E,d);return Re!=null&&Re.artifactId&&de.set(d,Re),Re}catch(Re){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",Re),Re}};if(!U)try{U=await te()}catch(Re){x(`Failed to fetch artifact metadata: ${Re.message}`,"error");return}const X=Ae.get(d)||[];let Le="latest",Ee="latest";if(v)Le=v,Ee=v;else{if(!U||U.version==null)try{U=await te()}catch(Re){x(`Failed to fetch artifact metadata: ${Re.message}`,"error");return}Le=(U==null?void 0:U.version)||"latest",Ee=(U==null?void 0:U.version)||"latest"}const ve=X.find(Re=>String(Re.version)===String(Le));(ve==null?void 0:ve.version)!=null&&(Ee=ve.version),x(`Loading artifact ${d}…`,"muted");try{const Re=await It(B,E,d,Le),ut=de.get(d)||U||{},jt=Array.isArray(Re);let Ze=null;if(jt){const Xe=Re.map((un,we)=>(T(un,{titleHint:ut.name||d,idHint:d}),{version:String(we+1),data:un,createdOn:(ve==null?void 0:ve.createdOn)||ut.createdOn}));Ze={id:_(),title:((Ne=(lt=Xe[0])==null?void 0:lt.data)==null?void 0:Ne.title)||ut.name||d,data:(Et=Xe[0])==null?void 0:Et.data,apicurioArtifactId:d,apicurioArtifactName:ut.name||"",apicurioVersions:Xe,apicurioActiveVersionIndex:0,isSeries:!0};const vt=((_t=ut==null?void 0:ut.properties)==null?void 0:_t.seriesId)||d;typeof C=="function"&&C(Ze,{seriesName:vt,fallbackTitle:vt}),x(`Loaded series artifact ${d}.`,"success")}else{T(Re,{titleHint:ut.name||d,idHint:d});const Xe={version:Ee,data:Re,createdOn:(ve==null?void 0:ve.createdOn)||ut.createdOn};Ze={id:_(),title:Re.title||ut.name||d,data:Re,apicurioArtifactId:d,apicurioArtifactName:ut.name||"",apicurioVersions:[Xe],apicurioActiveVersionIndex:0};const vt=(gt=ut==null?void 0:ut.properties)==null?void 0:gt.seriesId;vt&&typeof C=="function"&&C(Ze,{seriesName:vt,fallbackTitle:vt});const un=Ee?` (version ${Ee})`:"";x(`Loaded artifact ${d}${un}.`,"success")}hn(d,Ze)}catch(Re){console.error("[Blockscape] failed to load artifact",Re),x(`Failed to load artifact: ${Re.message}`,"error")}}async function xn(d){}return{hydrateConfig:Ye,mount:lo,updateAvailability:ue,isEnabled:be,setEnabled:On,onEnabledChange:R}}const Ht={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function qn(r,c){if(typeof r!="function")throw new Error(`[itemEditor] expected ${c} to be a function`)}function bc(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}const $a=1,Ra=4;function wc(r){if(r==null)return null;const c=Number(r);if(!Number.isFinite(c))return null;const f=Math.round(c);return f<$a||f>Ra?null:f}function vc(r,{excludeId:c}={}){if(!r)return[];const f=r.split(/[\s,]+/).map(C=>C.trim()).filter(Boolean),T=[];return f.forEach(C=>{c&&C===c||T.includes(C)||T.push(C)}),T}function yc(r,c,f){if(!c||!f||c===f)return;((r==null?void 0:r.categories)||[]).forEach(C=>{(C.items||[]).forEach(G=>{Array.isArray(G.deps)&&(G.deps=G.deps.map(oe=>oe===c?f:oe))})})}function Sc({findItemAndCategoryById:r,collectAllItemIds:c,updateItemReferences:f,loadActiveIntoEditor:T,rebuildFromActive:C,select:G,onSelectionRenamed:oe,makeSlug:Z=bc,isAutoIdFromNameEnabled:ee=()=>!0}={}){qn(r,"findItemAndCategoryById"),qn(c,"collectAllItemIds"),qn(f,"updateItemReferences"),qn(T,"loadActiveIntoEditor"),qn(C,"rebuildFromActive"),qn(G,"select"),qn(Z,"makeSlug"),qn(ee,"isAutoIdFromNameEnabled");const _={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function pe(z){if(_.fields.errorEl){if(!z){_.fields.errorEl.hidden=!0,_.fields.errorEl.textContent="";return}_.fields.errorEl.hidden=!1,_.fields.errorEl.textContent=z}}function j(){_.wrapper&&(_.wrapper.hidden=!0,_.wrapper.setAttribute("aria-hidden","true"),pe(""),_.categoryId=null,_.itemId=null,_.modelData=null,document.body.classList.remove("item-editor-open"))}function ce(){_.wrapper&&(_.wrapper.hidden=!1,_.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var z,H;(z=_.fields.nameInput)==null||z.focus(),(H=_.fields.nameInput)==null||H.select()}))}function ge({force:z}={}){var ie,D;if(!((ie=_.fields)!=null&&ie.idInput)||!((D=_.fields)!=null&&D.nameInput)||!_.autoSyncEnabled||!ee()||!z&&_.autoIdManuallyEdited)return;const H=Z(_.fields.nameInput.value||_.itemId||"item");_.fields.idInput.value=H}function rt(z){var ht;if(!_.modelData||!_.categoryId||!_.itemId)throw new Error("No item loaded.");const ie=(((ht=_.modelData)==null?void 0:ht.categories)||[]).find(R=>R.id===_.categoryId);if(!ie)throw new Error("Category not found.");ie.items=ie.items||[];const D=ie.items.find(R=>R.id===_.itemId);if(!D)throw new Error("Item not found.");const de=(z.id||"").trim();if(!de)throw new Error("ID is required.");const Ae=c(_.modelData);if(de!==D.id&&Ae.has(de))throw new Error("Another item already uses that ID.");D.id=de;const _e=(z.name||"").trim();D.name=_e||D.id;const Be=(z.logo||"").trim();if(Be?D.logo=Be:delete D.logo,z.externalFlag&&!z.external)D.external=!0;else{const R=(z.external??"").toString().trim();R?D.external=R:delete D.external}const $e=(z.color||"").trim();$e?D.color=$e:delete D.color;const be=wc(z.stage);return be!=null?D.stage=be:delete D.stage,D.deps=Array.isArray(z.deps)?z.deps:[],D.id!==z.originalId&&typeof oe=="function"&&oe(z.originalId,D.id),f(_.modelData,z.originalId,D.id),T(),C(),G(D.id),D.id}function We(){if(!_.fields||!_.fields.idInput)return!1;const z=(_.fields.idInput.value||"").trim(),H={originalId:_.itemId,id:z,name:_.fields.nameInput.value||"",logo:_.fields.logoInput.value||"",external:_.fields.externalInput.value||"",externalFlag:_.fields.externalFlagInput.checked,color:_.fields.colorInput.value||"",stage:_.fields.stageInput.value,deps:vc(_.fields.depsInput.value,{excludeId:z})};try{return rt(H),j(),!0}catch(ie){return console.warn("[itemEditor] item edit failed",ie),pe((ie==null?void 0:ie.message)||"Unable to save item."),!1}}function je(){if(_.wrapper)return _.wrapper;const z=document.createElement("div");z.className="item-editor-modal",z.hidden=!0,z.setAttribute("role","dialog"),z.setAttribute("aria-modal","true");const H=document.createElement("div");H.className="item-editor-modal__backdrop",z.appendChild(H);const ie=document.createElement("div");ie.className="item-editor",z.appendChild(ie);const D=document.createElement("div");D.className="item-editor__header";const de=document.createElement("h2");de.className="item-editor__title",de.textContent="Edit item";const Ae=document.createElement("button");Ae.type="button",Ae.className="item-editor__close",Ae.setAttribute("aria-label","Close item editor"),Ae.textContent="×",D.appendChild(de),D.appendChild(Ae),ie.appendChild(D);const _e=document.createElement("form");_e.className="item-editor__form",ie.appendChild(_e);const Be=document.createElement("div");Be.className="item-editor__meta",Be.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',_e.appendChild(Be);const $e=document.createElement("div");$e.className="item-editor__error",$e.hidden=!0,_e.appendChild($e);const be=(g,he,q)=>{const xe=document.createElement("label");xe.className="item-editor__field";const It=document.createElement("span");if(It.className="item-editor__label",It.textContent=g,xe.appendChild(It),he.classList.add("item-editor__control"),xe.appendChild(he),q){const K=document.createElement("div");K.className="item-editor__hint",K.textContent=q,xe.appendChild(K)}return xe},ht=document.createElement("input");ht.type="text",ht.required=!0,_e.appendChild(be("ID",ht,"Unique identifier used for dependencies."));const R=document.createElement("input");R.type="text",_e.appendChild(be("Name",R,"Visible label shown on the tile."));const ae=document.createElement("input");ae.type="url",ae.inputMode="url",ae.placeholder="https://…",_e.appendChild(be("Logo URL",ae,"Optional image URL."));const x=document.createElement("input");x.type="url",x.inputMode="url",x.placeholder="https://…",_e.appendChild(be("External link",x,"Shown with ↗ icon and in preview."));const J=document.createElement("div");J.className="item-editor__checkbox";const Se=document.createElement("label");Se.className="item-editor__checkbox-row";const ue=document.createElement("input");ue.type="checkbox";const Qe=document.createElement("span");Qe.textContent="Mark as external without link";const re=document.createElement("div");re.className="item-editor__hint",re.textContent="Keeps dashed border even without a URL.",Se.appendChild(ue),Se.appendChild(Qe),J.appendChild(Se),J.appendChild(re),_e.appendChild(J);const Ye=document.createElement("input");Ye.type="text",Ye.placeholder=Ht.color.primary,_e.appendChild(be("Color",Ye,"Optional badge color (hex or CSS color)."));const ft=document.createElement("input");ft.type="number",ft.min=String($a),ft.max=String(Ra),ft.inputMode="numeric",ft.placeholder=`${$a}-${Ra}`,_e.appendChild(be("Stage",ft,"Optional 1 (far left) to 4 (far right) when Center view is on."));const st=document.createElement("textarea");st.rows=2,st.placeholder="Comma or space separated ids",_e.appendChild(be("Dependencies",st,"Use item IDs, separated by commas or spaces."));const pt=document.createElement("div");pt.className="item-editor__checkbox";const w=document.createElement("label");w.className="item-editor__checkbox-row";const et=document.createElement("input");et.type="checkbox";const Bt=document.createElement("span");Bt.textContent="Sync ID while editing name";const Ie=document.createElement("div");Ie.className="item-editor__hint",Ie.textContent="Turn off to keep typing names without changing the ID.",w.appendChild(et),w.appendChild(Bt),pt.appendChild(w),pt.appendChild(Ie),_e.appendChild(pt);const bt=document.createElement("div");bt.className="item-editor__actions";const Pt=document.createElement("button");Pt.type="button",Pt.className="pf-v5-c-button pf-m-tertiary",Pt.textContent="Cancel";const S=document.createElement("button");return S.type="submit",S.className="pf-v5-c-button pf-m-primary",S.textContent="Save",bt.appendChild(Pt),bt.appendChild(S),_e.appendChild(bt),_.wrapper=z,_.fields={idInput:ht,nameInput:R,logoInput:ae,externalInput:x,externalFlagInput:ue,colorInput:Ye,stageInput:ft,depsInput:st,syncCheckbox:et,categoryValue:Be.querySelector(".item-editor__meta-value"),errorEl:$e},Pt.addEventListener("click",j),Ae.addEventListener("click",j),H.addEventListener("click",j),ht.addEventListener("input",()=>{_.autoIdManuallyEdited=!0}),R.addEventListener("input",ge),et.addEventListener("change",()=>{_.autoSyncEnabled=!!et.checked,_.autoSyncEnabled&&(_.autoIdManuallyEdited=!1,ge({force:!0}))}),_e.addEventListener("submit",g=>{g.preventDefault(),We()}),document.addEventListener("keydown",g=>{g.key==="Escape"&&!z.hidden&&(g.preventDefault(),g.stopPropagation(),j())}),document.body.appendChild(z),z}function ze(z){const H=r(z);if(!H)return!1;je(),_.categoryId=H.category.id,_.itemId=H.item.id,_.modelData=H.modelData,_.autoIdManuallyEdited=!1;const ie=!!ee();return _.autoSyncEnabled=ie,_.fields.categoryValue.textContent=H.category.title||H.category.id,_.fields.idInput.value=H.item.id||"",_.fields.nameInput.value=H.item.name||"",_.fields.logoInput.value=H.item.logo||"",_.fields.externalInput.value=typeof H.item.external=="string"?H.item.external:"",_.fields.externalFlagInput.checked=H.item.external===!0,_.fields.colorInput.value=H.item.color||"",_.fields.stageInput.value=H.item.stage??"",_.fields.depsInput.value=Array.isArray(H.item.deps)?H.item.deps.join(", "):"",_.fields.syncCheckbox.checked=_.autoSyncEnabled,_.fields.syncCheckbox.disabled=!ie,!_.fields.idInput.value&&ie&&ge({force:!0}),pe(""),G(H.item.id),ce(),!0}return{open:ze,hide:j,isOpen:()=>!!_.wrapper&&!_.wrapper.hidden}}function Ec(){return typeof window<"u"&&window.Neutralino&&window.Neutralino.os&&typeof window.Neutralino.os.open=="function"}function ui(r){if(!r)return!1;if(Ec())try{return window.Neutralino.os.open(r),!0}catch(c){console.warn("[Blockscape] failed to open external url",r,c)}return window.open(r,"_blank","noopener"),!0}function kc(r){if(!r||r.startsWith("#")||/^javascript:/i.test(r))return!1;try{const c=new URL(r,window.location.href);return c.protocol==="http:"||c.protocol==="https:"?c.origin!==window.location.origin:!0}catch{return!1}}function Ic(r){try{return new URL(r,window.location.href).toString()}catch{return r}}function Cc({menuEl:r,previewEl:c,previewTitleEl:f,previewBodyEl:T,previewActionsEl:C,previewCloseEl:G,escapeHtml:oe,onEditItem:Z,onChangeColor:ee,selectItem:_,colorPresets:pe=[]}={}){const j=r||(()=>{const R=document.createElement("div");return R.className="tile-context-menu",R.hidden=!0,R.setAttribute("aria-hidden","true"),document.body.appendChild(R),R})();let ce={x:0,y:0},ge=0,rt=Array.isArray(pe)?pe:[];function We(){j&&(j.classList.remove("is-open"),j.hidden=!0,j.setAttribute("aria-hidden","true"),j.innerHTML="")}function je(R=[]){C&&(C.innerHTML="",R.forEach(ae=>{const x=document.createElement("button");x.type="button",x.className="item-preview__action",x.textContent=ae.label||"Action",ae.title&&(x.title=ae.title),x.addEventListener("click",J=>{J.stopPropagation(),typeof ae.onClick=="function"&&ae.onClick(J)}),C.appendChild(x)}),C.hidden=R.length===0)}function ze(){We(),c&&(c.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),c.setAttribute("aria-hidden","true"),c.hidden=!0,je([]))}function z(R,ae){c&&(ce={x:R,y:ae},c.hidden=!1,c.setAttribute("aria-hidden","false"),c.classList.add("is-visible"),H(R,ae))}function H(R,ae){if(!c)return;const x=12;c.style.left=`${R+x}px`,c.style.top=`${ae+x}px`;const J=c.getBoundingClientRect();let Se=J.left,ue=J.top;J.right>window.innerWidth-x&&(Se=Math.max(x,window.innerWidth-J.width-x)),J.bottom>window.innerHeight-x&&(ue=Math.max(x,window.innerHeight-J.height-x)),c.style.left=`${Se}px`,c.style.top=`${ue}px`}function ie(R,ae){var Qe;if(!R)return null;const x=R.dataset.id,J=((Qe=R.querySelector(".name"))==null?void 0:Qe.textContent)||x||"Preview",Se=x?`${x}.html`:"",ue=Se?`items/${Se}`:"";return{id:x,displayName:J,filename:Se,filepath:ue,externalUrl:R.dataset.externalUrl||"",obsidianUrl:R.dataset.obsidianUrl||"",anchorX:(ae==null?void 0:ae.clientX)??0,anchorY:(ae==null?void 0:ae.clientY)??0}}function D(R,ae){const x=document.createElement("button");return x.type="button",x.className="tile-context-menu__item",x.textContent=R,x.addEventListener("click",()=>{We(),typeof ae=="function"&&ae()}),x}function de(R){if(!j)return;j.innerHTML="";const ae=document.createElement("div");ae.className="tile-context-menu__list",ae.appendChild(D("File view",()=>_e(R))),typeof Z=="function"&&ae.appendChild(D("Edit",()=>Z(R.id))),typeof ee=="function"&&R.id&&rt.forEach(x=>{if(!(x!=null&&x.value))return;const J=x.name||x.value;ae.appendChild(D(`Set color: ${J}`,()=>ee(R.id,x.value)))}),j.appendChild(ae)}function Ae(R,ae){if(!j)return;const x=4;j.style.left=`${R+x}px`,j.style.top=`${ae+x}px`,j.hidden=!1,j.setAttribute("aria-hidden","false"),j.classList.add("is-open");const J=j.getBoundingClientRect();let Se=J.left,ue=J.top;J.right>window.innerWidth-x&&(Se=Math.max(x,window.innerWidth-J.width-x)),J.bottom>window.innerHeight-x&&(ue=Math.max(x,window.innerHeight-J.height-x)),j.style.left=`${Se}px`,j.style.top=`${ue}px`}async function _e(R){if(!c||!f||!T||!R)return;const ae=++ge,x=[];if(typeof Z=="function"&&R.id&&x.push({label:"Edit",title:"Edit this item",onClick:()=>{ze(),Z(R.id)}}),R.externalUrl&&x.push({label:"Open link ↗",title:R.externalUrl,onClick:()=>ui(R.externalUrl)}),R.obsidianUrl&&x.push({label:"Open in Obsidian",title:R.obsidianUrl,onClick:()=>ui(R.obsidianUrl)}),je(x),R.id&&typeof _=="function"&&_(R.id),f.textContent=R.displayName,T.innerHTML='<div class="item-preview__status">Loading…</div>',c.classList.remove("item-preview--has-frame"),c.classList.add("item-preview--expanded"),z(R.anchorX,R.anchorY),!R.filepath){T.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',H(ce.x,ce.y);return}try{const J=await fetch(R.filepath,{cache:"no-cache"});if(!J.ok)throw new Error(`HTTP ${J.status}`);const Se=await J.text();if(ae!==ge)return;if(!Se.trim()){const re=oe?oe(R.filename):R.filename;T.innerHTML=`<div class="item-preview__status">No content in <code>${re}</code>.</div>`,H(ce.x,ce.y);return}const Qe=document.createElement("iframe");Qe.className="item-preview__frame",Qe.title=`${R.displayName} details`,Qe.srcdoc=Se,T.innerHTML="",T.appendChild(Qe),c.classList.add("item-preview--has-frame"),H(ce.x,ce.y)}catch(J){if(ae!==ge)return;const Se=oe?oe(R.displayName):R.displayName;T.innerHTML=`<div class="item-preview__status">No preview available for <strong>${Se}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${R.filepath}`,J),H(ce.x,ce.y)}}function Be(R,ae){if(!ae)return;R.preventDefault(),R.stopPropagation();const x=ie(ae,R);!x||!x.id||(typeof _=="function"&&_(x.id),de(x),Ae(R.clientX,R.clientY))}function $e(R){const ae=R==null?void 0:R.target,x=j&&!j.hidden&&j.contains(ae),J=c&&!c.hidden&&c.contains(ae);!x&&!J&&ze()}function be(){!c||c.hidden||H(ce.x,ce.y)}function ht(){ze()}return G&&G.addEventListener("click",ze),{handleTileContextMenu:Be,hidePreview:ze,hideMenu:We,handleDocumentClick:$e,handleWindowResize:be,handleWindowScroll:ht,updateColorPresets:R=>{rt=Array.isArray(R)?R:[]}}}function ps(r,c="series"){return(r||c).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||c}function Cn(r,c="series"){const f=ps(r,c).replace(/\./g,"-");return f.replace(/-series$/i,"").replace(/-+$/,"")||f||ps(c,"series")}function fs(r,{seriesName:c,fallbackTitle:f="unknown"}={}){var Z,ee;const C=[r==null?void 0:r.seriesId,(Z=r==null?void 0:r.data)==null?void 0:Z.seriesId,r==null?void 0:r.apicurioArtifactId,c,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(ee=r==null?void 0:r.data)==null?void 0:ee.title,f].map(_=>(_??"").toString().trim()),G=C.findIndex(Boolean),oe=G!==-1?C[G]:"";return oe?(console.log("[Series] deriveSeriesId: picked base",{base:oe,sourceIndex:G,candidates:C}),Cn(oe,f)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:f}),null)}function Ft(r,{seriesName:c,fallbackTitle:f="unknown"}={}){if(!r||typeof r!="object")return null;const T=fs(r,{seriesName:c,fallbackTitle:f});return T?(r.seriesId=T,r.apicurioArtifactId||(r.apicurioArtifactId=T),T):null}function Rn(r,c={}){var C,G;if(!r)return null;const f=r.isSeries||((C=r.apicurioVersions)==null?void 0:C.length)>1||r.seriesId||((G=r.data)==null?void 0:G.seriesId)||r.apicurioArtifactId;if(!f&&!c.force)return null;const T=fs(r,c);return T||(f?Cn(c.fallbackTitle||"unknown"):null)}const ms={selectionDimOpacity:.2,selectionDimEnabled:!0},Yn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,c=!0)=>{const f=Math.round((1-r)*100);return c?f===0?"Off":`${f}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function Zn(r){return r===!0||r==="true"||r===1||r==="1"}function _c(r,{localBackend:c}={}){const f=c&&typeof c.getAutoReloadConfig=="function"&&c.getAutoReloadConfig(),T={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness,stripParentheticalNames:r.stripParentheticalNames};return f&&(T.autoReloadEnabled=!!f.enabled,T.autoReloadIntervalMs=f.intervalMs),T}function xc(r={},c){var q,xe,It,K;if(!r||typeof r!="object")return{applied:[]};const f=[],{applyTheme:T,applyTileHoverScale:C,persistTileHoverScale:G,applySelectionDimEnabled:oe,persistSelectionDimEnabled:Z,applySelectionDimOpacity:ee,persistSelectionDimOpacity:_,applyTileCompactness:pe,persistTileCompactness:j,applyTitleWrapMode:ce,persistTitleWrapMode:ge,applyTitleHoverWidthMultiplier:rt,persistTitleHoverWidthMultiplier:We,applyTitleHoverTextPortion:je,persistTitleHoverTextPortion:ze,applyLinkThickness:z,persistLinkThickness:H,applyDepColor:ie,persistDepColor:D,applyRevdepColor:de,persistRevdepColor:Ae,applyObsidianLinksEnabled:_e,persistObsidianLinksEnabled:Be,applyObsidianLinkMode:$e,persistObsidianLinkMode:be,applyObsidianVaultName:ht,persistObsidianVaultName:R,applyAutoIdFromNameEnabled:ae,persistAutoIdFromNameEnabled:x,applySeriesNavDoubleClickWait:J,persistSeriesNavDoubleClickWait:Se,applyCenterItems:ue,persistCenterItems:Qe,applyStripParentheticalNames:re,persistStripParentheticalNames:Ye,applyShowSeriesPanel:ft,persistShowSeriesPanel:st,localBackend:pt,ui:w,refreshObsidianLinks:et,scheduleOverlaySync:Bt,selection:Ie,select:bt,clearStyles:Pt,drawLinks:S,applyReusedHighlights:g,current:he}=c;if(r.theme){const mt=((T==null?void 0:T(r.theme))||r.theme)==="dark";(q=c.ui)!=null&&q.themeToggle&&(c.ui.themeToggle.checked=mt),(xe=c.ui)!=null&&xe.tabThemeToggle&&(c.ui.tabThemeToggle.checked=mt),f.push("theme")}if(r.hoverScale!=null){const A=C(parseFloat(r.hoverScale));G(A),w!=null&&w.hoverScaleInput&&(w.hoverScaleInput.value=String(A)),w!=null&&w.hoverScaleValue&&(w.hoverScaleValue.textContent=Yn.hoverScale(A)),Ie&&Bt(),f.push("hoverScale")}if(r.selectionDimEnabled!=null){const A=oe(Zn(r.selectionDimEnabled));Z(A),w!=null&&w.selectionDimToggle&&(w.selectionDimToggle.checked=A),w!=null&&w.selectionDimInput&&(w.selectionDimInput.disabled=!A),w!=null&&w.selectionDimValue&&(w.selectionDimValue.textContent=Yn.selectionDimming(he.selectionDimOpacity??ms.selectionDimOpacity,A)),f.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const A=ee(parseFloat(r.selectionDimOpacity));_(A),w!=null&&w.selectionDimInput&&(w.selectionDimInput.value=String(A)),w!=null&&w.selectionDimValue&&(w.selectionDimValue.textContent=Yn.selectionDimming(A,he.selectionDimEnabled??ms.selectionDimEnabled)),f.push("selectionDimOpacity")}if(r.tileCompactness!=null){const A=pe(parseFloat(r.tileCompactness));j(A),w!=null&&w.tileCompactnessInput&&(w.tileCompactnessInput.value=String(A)),w!=null&&w.tileCompactnessValue&&(w.tileCompactnessValue.textContent=Yn.compactness(A)),Ie&&Bt(),f.push("tileCompactness")}if(r.titleWrapMode){const A=ce(r.titleWrapMode);ge(A),w!=null&&w.titleWrapInput&&(w.titleWrapInput.checked=A!=="nowrap"),f.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const A=rt(parseFloat(r.titleHoverWidthMultiplier));We(A),w!=null&&w.titleWidthInput&&(w.titleWidthInput.value=String(A)),w!=null&&w.titleWidthValue&&(w.titleWidthValue.textContent=Yn.titleWidth(A)),f.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const A=je(parseFloat(r.titleHoverTextPortion));ze(A),w!=null&&w.titleZoomInput&&(w.titleZoomInput.value=String(A)),w!=null&&w.titleZoomValue&&(w.titleZoomValue.textContent=Yn.titleZoomPortion(A)),f.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const A=_e(Zn(r.obsidianLinksEnabled));Be(A),w!=null&&w.obsidianToggle&&(w.obsidianToggle.checked=A),(It=w==null?void 0:w.obsidianModeInputs)==null||It.forEach(mt=>{mt.disabled=!A}),w!=null&&w.obsidianVaultInput&&(w.obsidianVaultInput.disabled=!A),et==null||et(),f.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const A=$e(r.obsidianLinkMode);be(A),(K=w==null?void 0:w.obsidianModeInputs)==null||K.forEach(mt=>{mt.checked=mt.value===A}),et==null||et(),f.push("obsidianLinkMode")}if(r.obsidianVault!=null){const A=ht(r.obsidianVault);R(A),w!=null&&w.obsidianVaultInput&&(w.obsidianVaultInput.value=A),et==null||et(),f.push("obsidianVault")}if(r.colorPresets&&(typeof c.setColorPresets=="function"&&c.setColorPresets(r.colorPresets),f.push("colorPresets")),r.linkThickness){const A=z==null?void 0:z(r.linkThickness);A&&(H==null||H(A),w!=null&&w.linkThicknessInput&&(w.linkThicknessInput.value=A),f.push("linkThickness"))}if(r.stripParentheticalNames!=null){const A=re==null?void 0:re(Zn(r.stripParentheticalNames));Ye==null||Ye(A),w!=null&&w.stripParentheticalToggle&&(w.stripParentheticalToggle.checked=A),f.push("stripParentheticalNames")}if(r.depColor){const A=ie==null?void 0:ie(r.depColor);A&&(D==null||D(A),w!=null&&w.depColorInput&&(w.depColorInput.value=A),f.push("depColor"))}if(r.revdepColor){const A=de==null?void 0:de(r.revdepColor);A&&(Ae==null||Ae(A),w!=null&&w.revdepColorInput&&(w.revdepColorInput.value=A),f.push("revdepColor"))}if(r.autoIdFromName!=null){const A=ae(Zn(r.autoIdFromName));x(A),w!=null&&w.autoIdToggle&&(w.autoIdToggle.checked=A),f.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const A=J(parseInt(r.seriesNavDoubleClickMs,10));Se(A),w!=null&&w.seriesNavInput&&(w.seriesNavInput.value=String(A)),w!=null&&w.seriesNavValue&&(w.seriesNavValue.textContent=Yn.seriesNavWait(A)),f.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&pt&&typeof pt.setAutoReloadEnabled=="function"){const A=Zn(r.autoReloadEnabled);pt.setAutoReloadEnabled(A),w!=null&&w.autoReloadToggle&&(w.autoReloadToggle.checked=A),w!=null&&w.autoReloadInput&&(w.autoReloadInput.disabled=!A),f.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&pt&&typeof pt.setAutoReloadInterval=="function"){const A=pt.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));w!=null&&w.autoReloadInput&&(w.autoReloadInput.value=String(A)),w!=null&&w.autoReloadValue&&(w.autoReloadValue.textContent=Yn.autoReloadInterval(A)),f.push("autoReloadIntervalMs")}if(r.centerItems!=null){const A=ue==null?void 0:ue(Zn(r.centerItems));Qe==null||Qe(A),w!=null&&w.tabCenterToggle&&(w.tabCenterToggle.checked=A),f.push("centerItems")}if(r.showSecondaryLinks!=null){const A=Zn(r.showSecondaryLinks);typeof c.setShowSecondaryLinks=="function"?c.setShowSecondaryLinks(A):c.showSecondaryLinks=A,w!=null&&w.secondaryLinksToggle&&(w.secondaryLinksToggle.checked=A),w!=null&&w.tabSecondaryLinksToggle&&(w.tabSecondaryLinksToggle.checked=A),Ie?bt(Ie):(Pt(),S()),f.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const A=Zn(r.showReusedInMap);typeof c.setShowReusedInMap=="function"?c.setShowReusedInMap(A):c.showReusedInMap=A,w!=null&&w.reusedToggle&&(w.reusedToggle.checked=A),g==null||g(),f.push("showReusedInMap")}return{applied:f}}function Tc(r,c){const f=new Blob([c],{type:"application/json"}),T=URL.createObjectURL(f),C=document.createElement("a");C.href=T,C.download=r,C.click(),URL.revokeObjectURL(T)}const qi=typeof{url:$n&&$n.tagName.toUpperCase()==="SCRIPT"&&$n.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function Ac(r={}){console.log("[Blockscape] init");const c={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},f=document.getElementById("jsonBox"),T=document.querySelector(".blockscape-json-panel"),C=document.getElementById("app"),G=document.getElementById("overlay"),oe=document.getElementById("tabTooltip"),Z=document.getElementById("modelList"),ee=document.getElementById("itemPreview"),_=document.getElementById("urlForm"),pe=document.getElementById("urlInput"),j=document.getElementById("loadUrl"),ce=ee.querySelector(".item-preview__title"),ge=ee.querySelector(".item-preview__body"),rt=ee.querySelector(".item-preview__actions"),We=ee.querySelector(".item-preview__close"),je=document.getElementById("downloadJson"),ze=document.getElementById("shareModel"),z=document.getElementById("createVersion"),H=document.getElementById("copyJson"),ie=document.getElementById("copySeries"),D=document.getElementById("pasteJson"),de=document.getElementById("helpButton"),Ae=document.getElementById("newPanelButton"),_e=document.getElementById("newBlankButton"),Be=document.getElementById("shortcutHelp"),$e=document.getElementById("shortcutHelpList"),be=document.getElementById("shortcutHelpClose"),ht=document.getElementById("shortcutHelpBackdrop"),R=document.getElementById("newPanel"),ae=document.getElementById("newPanelClose"),x=document.getElementById("newPanelBackdrop"),J=document.getElementById("search"),Se=document.getElementById("searchResults"),ue=document.getElementById("localBackendPanel"),Qe=document.getElementById("localBackendStatus"),re=document.getElementById("localFileList"),Ye=document.getElementById("localDirSelect"),ft=document.getElementById("refreshLocalFiles"),st=document.getElementById("loadLocalFile"),pt=document.getElementById("deleteLocalFile"),w=document.getElementById("toggleServerSidebar"),et=document.getElementById("saveLocalFile"),Bt=document.getElementById("saveLocalFileAs"),Ie=document.getElementById("localSavePath"),bt="blockscape:serverSidebarWide",Pt=document.title;ue&&(ue.hidden=!0),!c.localBackend&&ue&&(ue.hidden=!0),c.fileOpen||(st&&(st.hidden=!0),Ye&&(Ye.hidden=!0),ft&&(ft.hidden=!0),pt&&(pt.hidden=!0),re&&(re.hidden=!0)),c.fileSave||(et&&(et.hidden=!0),Bt&&(Bt.hidden=!0),Ie&&(Ie.hidden=!0)),f.value=document.getElementById("seed").textContent.trim();let S=[],g=-1;const he=gc({models:S,getActiveIndex:()=>g,setActive:Dt,ensureModelMetadata:Mn,getModelId:St,getSeriesId:Rn,ensureSeriesId:Ft,getModelTitle:qe,computeJsonFingerprint:ra,uid:fo});let q=null,xe=new Map,It=new Map,K=null,A=null,mt=null,Je=null,cn=!0,On=!1,en=!1,Xn="map",wt=null,tn=null,lo=!1,_n=null;const Nn=2e3;let nn=null,Wt=null,Jt=null,hn=null,Ct=null,on=null,dn=null,Vn=null,an=null,xn="",d=!1,v=null;const B=new Map;let N=null,E=null,U=[],te=null;const X=30,Le=1e3,Ee="blockscape:hoverScale",ve=1.5,Ke=1,lt=2.5,Ne="blockscape:selectionDimOpacity",Et="blockscape:selectionDimEnabled",_t=.2,gt=.05,Re=1,ut="blockscape:titleWrap",jt="blockscape:titleHoverWidth",Ze="blockscape:titleHoverTextPortion",Xe="wrap",vt=1.3,un=1,we=1.6,Oe=.25,co=0,Oa=.6,ws="blockscape:tileCompactness",pi=1,vs=.75,ys=1.25,Ss="blockscape:obsidianLinksEnabled",Es="blockscape:obsidianLinkMode",ks="blockscape:obsidianVault",Va="title",Yi="id",Zi=Va,Is="blockscape:autoReloadEnabled",Cs="blockscape:autoReloadIntervalMs",fi=1e3,_s=500,xs=1e4,Ts="blockscape:autoIdFromName",Xi=!0,As="blockscape:stripParentheticalNames",Qi=!0,Ls="blockscape:colorPresets",Ns="blockscape:centerItems",Ms="blockscape:theme",Bs=4,Lo=1,ea=4,Ps="0.2rem",No="light",uo="dark",ta="cat:",na=!1,$s="blockscape:depColor",Rs="blockscape:revdepColor",Os="blockscape:linkThickness",Vs=6,Ds={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let Mo=ve,Dn=_t,Un=!0,Bo=pi,Da=Xe,Po=vt,$o=Oe,Ro=!1,mi=Zi,Oo="",po=Xi,hi=Qi,gi=No,qt=[],yt=na,oa="",ia="",bi="m",Vo=null,Ua=null;const Us="blockscape:seriesNavDoubleClickMs",wi=900,Hs=300,Fs=4e3;let Hn=wi,Qn=!0;const ye={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSeriesPanelToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null,stripParentheticalToggle:null};let Do=null;const Kc={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:fi}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},tt=c.localBackend?vd():Kc,Ws=c.localBackend?tt.detect():Promise.resolve(!1);he.hydrateConfig(),Fa(ed()),Fo(ld(),{silent:!0}),od(),id(),sd(),Md(),Bd(),Rd(),Dd(),Od(),Vd(),jd(),Yd(),Gd(),Zd(),Pd(),$d(),qd(),nd(),Zt();function fo(){return Math.random().toString(36).slice(2,10)}function Jc(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function qc(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function Yc(e){return Jc(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Zc(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),qc(t)}const js=(e,t)=>Tc(e,t);function Ha(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function Xc(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await Fl(i),s=JSON.parse(a),l=Ha(s);if(l)return l}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function Qc(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];c.initialSettings&&t.push({type:"inline",snapshot:c.initialSettings}),c.initialSettingsUrl&&t.push({type:"url",url:c.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?Ha(o.snapshot):await Xc(o.url);if(!i)continue;const a=Za(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function ed(){if(typeof window>"u"||!window.localStorage)return No;try{return window.localStorage.getItem(Ms)===uo?uo:No}catch{return No}}function td(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ms,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function Fa(e){const t=e===uo?uo:No;return gi=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),td(t),gi}function zs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ns,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function Uo(e){return yt=!!e,C&&(C.classList.toggle("is-center-mode",yt),C.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",yt)}),C.querySelectorAll(".tile-add").forEach(t=>{t.hidden=yt,t.tabIndex=yt?-1:0,t.setAttribute("aria-hidden",yt?"true":"false")}),C.querySelectorAll(".category-add").forEach(t=>{t.hidden=yt,t.tabIndex=yt?-1:0,t.setAttribute("aria-hidden",yt?"true":"false")})),Ks(),Gs(),q&&(fa(),Tn()),yt}function nd(){if(typeof window>"u"||!window.localStorage)return Uo(na);try{const e=window.localStorage.getItem(Ns);return e==null?Uo(na):Uo(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),Uo(na)}}function vi(e){if(e==null)return null;const t=Number(e);if(!Number.isFinite(t))return null;const n=Math.round(t);return n<Lo||n>ea?null:n}function Gs(){if(!C)return;const e=`repeat(${Bs}, minmax(var(--blockscape-tile), 1fr))`;C.querySelectorAll(".grid").forEach(t=>{const n=Array.from(t.querySelectorAll(".tile[data-stage]")).map((m,y)=>({tile:m,stage:vi(m.dataset.stage),order:y})),o=n.some(m=>m.stage),i=yt&&o;i?(t.style.gridTemplateColumns=e,t.style.gridAutoFlow="row",t.style.justifyContent="space-between",t.style.justifyItems="start",t.style.columnGap=Ps,t.style.rowGap=Ps):(t.style.removeProperty("grid-template-columns"),t.style.removeProperty("grid-auto-flow"),t.style.removeProperty("justify-content"),t.style.removeProperty("justify-items"),t.style.removeProperty("column-gap"),t.style.removeProperty("row-gap"));const a=m=>{m.style.removeProperty("grid-column"),m.style.removeProperty("grid-row")};if(t.querySelectorAll(".tile").forEach(a),!i)return;const s=n.filter(m=>m.stage).sort((m,y)=>m.stage!==y.stage?m.stage-y.stage:m.order-y.order),l=(m,y,P)=>{if(y.has(m)&&y.get(m)===P)return{col:m,needsNewRow:!0};const M=Bs-1;for(let $=0;$<=M;$+=1){const O=[];m-$>=Lo&&O.push(m-$),$!==0&&m+$<=ea&&O.push(m+$);for(const Q of O)if(!y.has(Q))return{col:Q,needsNewRow:!1}}return{col:null,needsNewRow:!1}};let u=1,h=new Map;s.forEach(({tile:m,stage:y})=>{let P=l(y,h,y);P.needsNewRow&&(u+=1,h=new Map,P=l(y,h,y)),P.col!=null&&(h.set(P.col,y),m.style.gridColumn=String(P.col),m.style.gridRow=String(u))})}),Ks()}function Ks(){Ua&&(Ua.hidden=!yt)}function Ho(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Js(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function Wa(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function qs(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=Ho(i[1]);if(a)return Wa(a,n);if(t){const s=Ho(t);if(s)return Wa(s,n)}}return Wa(o,n)}function Ys(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function ja(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem($s,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function za(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Rs,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function Ga(e){const t=qs(e,{fallbackVar:"--color-primary",fallbackColor:Ht.color.primary});return oa=t,Js("--blockscape-dep",t),G&&Tn(),oa}function Ka(e){const t=qs(e,{fallbackVar:"--color-danger",fallbackColor:Ht.blockscape.revdep});return ia=t,Js("--blockscape-revdep",t),G&&Tn(),ia}function od(){const e=Ys($s),t=Ga(e||Ho("--blockscape-dep")||Ht.color.primary);return ja(t),t}function id(){const e=Ys(Rs),t=Ka(e||Ho("--blockscape-revdep")||Ht.blockscape.revdep);return za(t),t}function ad(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function rd(){return Ds[bi]||Ds.m}function yi(e){return bi=ad(e),Tn(),bi}function Ja(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Os,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function sd(){if(typeof window>"u"||!window.localStorage)return yi("m");try{const e=window.localStorage.getItem(Os),t=yi(e||"m");return Ja(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),yi("m")}}function Zs(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return Si();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:Si()}function Si(){return[{name:"Black",value:Ht.color.ink},{name:"White",value:Ht.color.white},{name:"Red",value:Ht.blockscape.revdep},{name:"Green",value:Ht.color.success}]}function ld(){if(typeof window>"u"||!window.localStorage)return Si();try{const e=window.localStorage.getItem(Ls);if(!e)return Si();const t=JSON.parse(e);return Zs(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),Si()}}function cd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ls,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function Fo(e,{silent:t=!1}={}){return qt=Zs(e),cd(qt),!t&&typeof oi=="function"&&oi(qt),Vo==null||Vo(),qt}function dd(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function aa(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=mo(e);if(!o)return;const i=S[g],a=mo(i==null?void 0:i.sourcePath),s=t??(a&&a===o?St(i):null),l=n??(a&&a===o?K:null),u=o.split("/").filter(Boolean).map(y=>encodeURIComponent(y)),h=s?encodeURIComponent(s):null,m=l?encodeURIComponent(l):null;try{const y=new URL(window.location.href),P=new URLSearchParams(y.search);P.delete("load"),P.delete("share");const M=["","server",...u,...h?[h]:[],...m?[m]:[]].join("/").replace(/\/+/g,"/");y.pathname=M,y.search=P.toString()?`?${P.toString()}`:"",y.hash="",window.history.replaceState({},document.title,y.toString())}catch(y){console.warn("[Blockscape] failed to update URL for server path",y)}}function ud(e,{origin:t}={}){if(!(typeof window>"u"||!e))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-path",{detail:{path:e,origin:t}}))}catch(n){console.warn("[Blockscape] failed to notify local save path",n)}}function pd({origin:e}={}){if(!(typeof window>"u"))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-clear",{detail:{origin:e}}))}catch(t){console.warn("[Blockscape] failed to notify local save clear",t)}}function fd(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(O=>O.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex(O=>O.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),l=i.slice(a+1),u=O=>{try{return decodeURIComponent(O)}catch{return O}},h=s.map(u),m=l.map(u),y=h.join("/"),P=mo(y);if(!P)return null;const M=m[0]?m[0].trim():null,$=m[1]?m[1].trim():null;return{path:P,modelId:M||null,itemId:$||null}}function md(){if(!(typeof window>"u"||!window.location))try{const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(l=>l.toLowerCase()==="server");if(o===-1)return;const i=n.slice(0,o),a=new URLSearchParams(e.search);a.delete("load"),a.delete("share");const s=i.length?`/${i.join("/")}`:"/";e.pathname=s.replace(/\/+/g,"/"),e.search=a.toString()?`?${a.toString()}`:"",e.hash="",window.history.replaceState({},document.title,e.toString())}catch(e){console.warn("[Blockscape] failed to clear server path from URL",e)}}function qa({itemId:e}={}){const t=S[g];if(!(t!=null&&t.sourcePath)){md();return}aa(t.sourcePath,{modelId:St(t),itemId:e===void 0?K:e})}function hd(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function gd(){if(typeof window>"u"||!window.localStorage)return!0;try{const e=window.localStorage.getItem(bt);return e==null?!0:e==="true"}catch{return!0}}function bd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(bt,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist sidebar width",t)}}function Xs(e){var t;typeof document>"u"||((t=document.body)==null||t.classList.toggle("blockscape-server-sidebar-wide",!!e),w&&(w.setAttribute("aria-pressed",e?"true":"false"),w.textContent=e?"<":">",w.title=e?"Switch to thin menu":"Switch to wide menu"))}function wd(e){if(!w||(w.hidden=!e,!e))return;let t=gd();Xs(t),w.onclick=()=>{t=!t,bd(t),Xs(t)}}function vd(){var at;const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(I,F={}){console.log("[Blockscape][local-backend]",I,{...e(),...F})}if(hd())return t("Disabled on github.io host"),ue&&(ue.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};const n=dd();if(n&&typeof document<"u"&&((at=document.body)==null||at.classList.add("blockscape-server-mode")),wd(n),!n||!ue||!Qe)return t("Opt-in flag missing or panel unavailable"),ue&&(ue.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!ue||!Qe)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],l="",u=new Map,h=O(),m=Ve(),y=null,P=!1;const M=new Set;function $(){return M.size>0}function O(){if(typeof window>"u"||!window.localStorage)return!0;try{const I=window.localStorage.getItem(Is);return I==null?!0:I==="true"}catch{return!0}}function Q(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Is,I?"true":"false")}catch(F){console.warn("[Blockscape] auto-reload: failed to persist",F)}}function Ve(){if(typeof window>"u"||!window.localStorage)return fi;try{const I=window.localStorage.getItem(Cs);if(!I)return fi;const F=parseInt(I,10);return Ce(F)}catch{return fi}}function ct(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Cs,String(I))}catch(F){console.warn("[Blockscape] auto-reload: failed to persist interval",F)}}function Ce(I){return Number.isFinite(I)?Math.min(xs,Math.max(_s,I)):fi}function He(I){if(!I)return"";const F=I.split("/").filter(Boolean);return F.pop(),F.join("/")}function De(I,{error:F=!1}={}){Qe.textContent=I,Qe.style.color=F?Ht.color.dangerStrong:"",t("Status",{text:I,error:F})}function it(I){return mo(I)}function zt(I){const F=ca(I);return F?{payload:F,isSeries:!0}:{payload:I==null?void 0:I.data,isSeries:!1}}function $t(){var F;if(g>=0&&((F=S[g])!=null&&F.sourcePath))return S[g].sourcePath;if(g<0)return"blockscape.bs";const I=qe(S[g])||"blockscape";return`${Cn(I,"blockscape")}.bs`}function nt(){var F;if(!Ie)return;Ie.placeholder=$t();const I=(F=S[g])==null?void 0:F.sourcePath;if(I){Ie.value=I;return}Ie.value&&(Ie.value="")}function dt(){if(!Ye)return;Ye.innerHTML="";const I=document.createElement("option");I.value="",I.textContent="Root (~/blockscape)",Ye.appendChild(I),s.forEach(se=>{const ke=document.createElement("option");ke.value=se,ke.textContent=se||"(root)",Ye.appendChild(ke)});const F=s.includes(l)?l:"";Ye.value=F,l=F}function Ut(){if(!re)return;re.innerHTML="";const I=a.filter(F=>He(F.path)===l);if(!I.length){const F=document.createElement("option");F.disabled=!0,F.textContent="No .bs files found yet",re.appendChild(F),re.disabled=!0;return}re.disabled=!1,I.forEach(F=>{const se=document.createElement("option");se.value=F.path;const ke=F.mtimeMs?new Date(F.mtimeMs).toLocaleString():"";se.textContent=ke?`${F.path} · ${ke}`:F.path,re.appendChild(se)}),i&&Array.from(re.options).forEach(F=>{F.value===i&&(F.selected=!0)}),!re.value&&re.options.length&&(re.options[0].selected=!0)}function gn(I){if(!o||!re)return;if(!I){i="",Array.from(re.options).forEach(ot=>{ot.selected=!1}),Ie&&(Ie.value="");return}if(!a.find(ot=>ot.path===I))return;const se=He(I);se!==l&&(l=se,dt()),Ut(),Array.from(re.options).forEach(ot=>{ot.selected=ot.value===I});const ke=Array.from(re.options).find(ot=>ot.value===I);ke!=null&&ke.scrollIntoView&&ke.scrollIntoView({block:"nearest"}),Ie&&(Ie.value=I)}function fn(){y&&(clearInterval(y),y=null)}function Tt(){fn(),!(!o||!h||$())&&(y=setInterval(bn,m))}function rn(I){if(!I)return;const F=M.size;M.add(I),M.size!==F&&(t("Auto-reload paused",{reason:I}),Tt())}function Xt(I){if(!I)return;M.delete(I)&&(t("Auto-reload resumed",{reason:I}),Tt())}async function Qt(I){const F=S.findIndex(se=>se.sourcePath===I);if(F!==-1)try{const se=await fetch(`/api/file?path=${encodeURIComponent(I)}`,{cache:"no-store"});if(!se.ok)throw new Error(`HTTP ${se.status}`);const ke=await se.json(),ot=JSON.stringify(ke.data??ke,null,2),Ge=eo(ot,I,{seriesTitleOverride:`${I} series`});if(!Ge.length)return;const ne=Ge[0];if(ne.sourcePath=I,Mn(ne,{titleHint:qe(S[F]),idHint:St(S[F])}),ne.isSeries){const Pe=ne.title||qe(ne)||qe(S[F]),Rt=Cn(Pe||"unknown");ho(ne,Rt),Ft(ne,{seriesName:Pe||"unknown",fallbackTitle:"unknown"})}S[F]={...S[F],...ne,title:ne.title||qe(ne),data:ne.data,sourcePath:I},F===g?(At(),xt()):Bn(),console.log("[Blockscape] auto-reloaded model from",I)}catch(se){console.warn("[Blockscape] auto-reload failed for",I,se)}}async function bn(){if(!(!o||!h||$()||P)){P=!0;try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);const se=((await I.json()).files||[]).slice().sort((ne,Pe)=>{const Rt=(ne==null?void 0:ne.mtimeMs)||0,ln=(Pe==null?void 0:Pe.mtimeMs)||0;return Rt===ln?(ne.path||"").localeCompare(Pe.path||""):ln-Rt}),ke=new Map;se.forEach(ne=>ke.set(ne.path,ne.mtimeMs||0));const ot=S.map((ne,Pe)=>({path:ne.sourcePath,idx:Pe})).filter(ne=>ne.path);for(const ne of ot){const Pe=u.get(ne.path)||0;(ke.get(ne.path)||0)>Pe&&await Qt(ne.path)}a=se;const Ge=new Set;a.forEach(ne=>Ge.add(He(ne.path))),s=Array.from(Ge).filter(ne=>ne!=="").sort(),u=ke,dt(),Ut()}catch(I){console.warn("[Blockscape] auto-reload check failed",I)}finally{P=!1}}}function yo(I){h=!!I,Q(h),Tt()}function wn(I){return m=Ce(I),ct(m),Tt(),m}function Nt(I){o=!1,a=[],u=new Map,fn(),Ut(),ue.hidden=!0,I&&De(I,{error:!0}),t("Panel hidden",{message:I})}async function Gn({silent:I=!1}={}){try{t("Health check start");const F=await fetch("/api/health",{cache:"no-store"});if(!F.ok)throw new Error(`HTTP ${F.status}`);const se=await F.json();if(o=!!(se!=null&&se.ok),!o)throw new Error("Health check failed");return ue.hidden=!1,I||De(se.root?`Local server ready (root: ${se.root})`:"Local server ready"),t("Health check ok",{payload:se}),!0}catch(F){return I||console.log("[Blockscape] local backend health failed",F),Nt("Local server unavailable"),!1}}async function sn(){if(o&&re){De("Loading files…");try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);a=((await I.json()).files||[]).slice().sort((Ge,ne)=>{const Pe=(Ge==null?void 0:Ge.mtimeMs)||0,Rt=(ne==null?void 0:ne.mtimeMs)||0;return Pe===Rt?(Ge.path||"").localeCompare(ne.path||""):Rt-Pe});const se=new Set;a.forEach(Ge=>{se.add(He(Ge.path))}),s=Array.from(se).filter(Ge=>Ge!=="").sort(),l&&!se.has(l)&&(l=""),!l&&i&&(l=He(i)),u=new Map(a.map(Ge=>[Ge.path,Ge.mtimeMs||0])),dt(),Ut();const ke=a.filter(Ge=>He(Ge.path)===l).length,ot=l?`~/blockscape/${l}`:"~/blockscape";De(ke?`Browsing ${ke} file(s) in ${ot}`:`No .bs files in ${ot} yet`)}catch(I){console.warn("[Blockscape] local backend refresh failed",I),Nt("Local server unavailable")}}}async function si(){o=!1,Nt(),De("Checking for local server…");try{return t("Detect start"),await Gn()?(nt(),await sn(),Tt(),!0):!1}catch(I){return o=!1,console.log("[Blockscape] local backend not detected",I),t("Detect failed",{err:I}),!1}}async function ga(){if(!o||!re)return;const I=Array.from(re.selectedOptions||[]).map(se=>se.value).filter(Boolean).sort((se,ke)=>se.localeCompare(ke));if(!I.length){alert("Select one or more files to load from ~/blockscape.");return}let F=null;for(const se of I)try{De(`Loading ${se}…`);const ke=await Qs(se);F==null&&(F=(ke==null?void 0:ke.firstIndex)??null),i=se,aa(se)}catch(ke){console.error("[Blockscape] failed to load from local server",ke),alert(`Local load failed for ${se}: ${ke.message}`)}F!=null&&Dt(F),De(`Loaded ${I.length} file(s)`),Ut()}async function fr(){if(!o||!re)return;const I=Array.from(re.selectedOptions||[]).map(ne=>ne.value).filter(Boolean).sort((ne,Pe)=>ne.localeCompare(Pe));if(!I.length){alert("Select one or more files to delete from ~/blockscape.");return}const F=I.length,se=F===1?I[0]:`${F} file(s)`,ke=F===1?`Delete "${se}" from ~/blockscape? This cannot be undone.`:`Delete ${se} from ~/blockscape? This cannot be undone.`;if(!window.confirm(ke))return;const ot="local-files-delete";rn(ot);const Ge=[];try{De(`Deleting ${se}…`);for(const ne of I)try{const Pe=await fetch(`/api/file?path=${encodeURIComponent(ne)}`,{method:"DELETE"});if(!Pe.ok)throw new Error(`HTTP ${Pe.status}`);ne===i&&(i=""),(Ie==null?void 0:Ie.value)===ne&&(Ie.value="")}catch(Pe){Ge.push(ne),console.warn("[Blockscape] local delete failed",ne,Pe)}await sn(),Ge.length?De(`Deleted ${F-Ge.length} file(s), ${Ge.length} failed`,{error:!0}):De(`Deleted ${F} file(s)`)}finally{Xt(ot)}}async function Ti(I,{statusPrefix:F="Saved to",updateInput:se=!0}={}){if(!o)return;if(g<0){alert("No active model to save.");return}const ke=S[g],{payload:ot,isSeries:Ge}=zt(ke);if(!ot){alert("No model data to save.");return}const ne=it(I);if(!ne){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const Pe=JSON.stringify(ot,null,2);De(`Saving ${Ge?"series":"map"} to ${ne}…`);const ln=await fetch(`/api/file?path=${encodeURIComponent(ne)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:Pe});if(!ln.ok)throw new Error(`HTTP ${ln.status}`);const mn=await ln.json();i=mn.path||ne,ke.sourcePath=mn.path||ne,se&&Ie&&(Ie.value=mn.path||ne),aa(mn.path||ne),De(`${F} ${mn.path||ne}`),await sn()}catch(Pe){console.error("[Blockscape] local save failed",Pe),alert(`Local save failed: ${Pe.message}`),Nt("Local server unavailable")}}async function ba(){var F;const I=it(Ie==null?void 0:Ie.value)||it((F=S[g])==null?void 0:F.sourcePath)||$t();if(!I){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Ti(I,{statusPrefix:"Saved to"})}async function So(){var ke;if(!o)return;if(g<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const I=it((ke=S[g])==null?void 0:ke.sourcePath)||$t(),F=window.prompt("Save active map as (under ~/blockscape):",I);if(F==null)return;const se=it(F);if(!se){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Ti(se,{statusPrefix:"Saved to"})}async function Eo(I,F,{refreshAfter:se=!0,statusPrefix:ke="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(I)||I<0)return{ok:!1,error:"Invalid model index"};const ot=S[I],{payload:Ge,isSeries:ne}=zt(ot);if(!Ge)return{ok:!1,error:"Model has no data"};const Pe=it(F)||it(ot==null?void 0:ot.sourcePath)||$t();if(!Pe)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const Rt=JSON.stringify(Ge,null,2);De(`Saving ${ne?"series":"map"} to ${Pe}…`);const mn=await fetch(`/api/file?path=${encodeURIComponent(Pe)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:Rt});if(!mn.ok)throw new Error(`HTTP ${mn.status}`);const to=await mn.json();return i=to.path||Pe,ot.sourcePath=to.path||Pe,I===g&&nt(),De(`${ke} ${to.path||Pe}`),se&&await sn(),{ok:!0,path:to.path||Pe}}catch(Rt){return console.error("[Blockscape] local save failed",Rt),Nt("Local server unavailable"),{ok:!1,error:Rt.message}}}if(ft&&(ft.onclick=()=>sn()),st&&(st.onclick=()=>ga()),pt&&(pt.onclick=()=>fr()),et&&(et.onclick=()=>ba()),Bt&&(Bt.onclick=()=>So()),re&&Ie&&(re.addEventListener("change",()=>{const I=Array.from(re.selectedOptions||[])[0];I!=null&&I.value&&(Ie.value=I.value)}),re.addEventListener("dblclick",()=>{ga()})),Ye&&Ye.addEventListener("change",()=>{l=Ye.value||"",Ut()}),ue){const I="local-files-panel-focus",F="local-files-panel-pointer";let se=!1,ke=!1;ue.addEventListener("focusin",()=>{se||(se=!0,rn(I))}),ue.addEventListener("focusout",ot=>{if(!se)return;const Ge=ot.relatedTarget;Ge&&ue.contains(Ge)||(se=!1,Xt(I))}),ue.addEventListener("pointerenter",()=>{ke||(ke=!0,rn(F))}),ue.addEventListener("pointerleave",()=>{ke&&(ke=!1,Xt(F))})}return{detect:si,refresh:sn,updateActiveSavePlaceholder:nt,isAvailable:()=>o,highlightSource:gn,saveModelByIndex:Eo,getAutoReloadConfig:()=>({enabled:h,intervalMs:m,available:o}),setAutoReloadEnabled:yo,setAutoReloadInterval:wn}}async function Qs(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=eo(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let l=null;return s.forEach((u,h)=>{if(u.sourcePath=e,u.isSeries&&!u.title){const P=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");u.title=P}const m=Fn(u,{versionLabel:s.length>1?`${t} #${h+1}`:t});l==null&&(l=m)}),{firstIndex:l,total:s.length}}async function el(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function yd(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Yt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function mo(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function Sd(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Ed(e,t){const n=mo(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function Ya(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function Ei(){try{await Ws}catch{}return typeof(tt==null?void 0:tt.isAvailable)=="function"?tt.isAvailable():!1}async function kd(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Id(e,t){const n=mo(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const l=`${a}-${s}.bs`,u=[...o,l].filter(Boolean).join("/");if(!t.has(u))return u}return null}function Cd(e,t="clipboard"){const n=qe(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=Yt(n),i=Ya();return`${o}-${i}.bs`}function _d(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=Sd(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=Cn(n||"unknown");return ho(e,o),Ft(e,{seriesName:n,fallbackTitle:n}),!0}function xd(e){return Number.isFinite(e)?Math.min(lt,Math.max(Ke,e)):ve}function Zt(){if(!C)return;const e=!!K||!!A;C.classList.toggle("blockscape-has-selection",e),C.classList.toggle("blockscape-has-item-selection",!!K)}function Wo(e){return Mo=xd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",Mo),Mo}function Td(e){return Number.isFinite(e)?Math.min(Re,Math.max(gt,e)):_t}function jo(e){Dn=Td(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Dn);const t=Un?Dn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Dn}function Ad(e){return Number.isFinite(e)?Math.min(ys,Math.max(vs,e)):pi}function zo(e){return Bo=Ad(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",Bo),Bo}function Ld(e){return Number.isFinite(e)?Math.min(we,Math.max(un,e)):vt}function Go(e){return Po=Ld(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",Po),Po}function Nd(e){return Number.isFinite(e)?Math.min(Oa,Math.max(co,e)):Oe}function Ko(e){return $o=Nd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",$o),$o}function Jo(e){const t=e==="nowrap"?"nowrap":"wrap";Da=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function tl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ee,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function Md(){if(typeof window>"u"||!window.localStorage)return Wo(ve);try{const e=window.localStorage.getItem(Ee);if(!e)return Wo(ve);const t=parseFloat(e);return Wo(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Wo(ve)}}function nl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ne,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function Bd(){if(typeof window>"u"||!window.localStorage)return jo(_t);try{const e=window.localStorage.getItem(Ne);if(!e)return jo(_t);const t=parseFloat(e);return jo(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),jo(_t)}}function qo(e){Un=!!e;const t=Un?Dn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),C&&C.classList.toggle("blockscape-dimming-disabled",!Un),Un}function ol(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Et,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function Pd(){if(typeof window>"u"||!window.localStorage)return qo(!0);try{const e=window.localStorage.getItem(Et);return e==null?qo(!0):qo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),qo(!0)}}function Yo(e){return po=!!e,po}function il(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ts,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function $d(){if(typeof window>"u"||!window.localStorage)return Yo(Xi);try{const e=window.localStorage.getItem(Ts);return e==null?Yo(Xi):Yo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Yo(Xi)}}function al(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ws,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function Rd(){if(typeof window>"u"||!window.localStorage)return zo(pi);try{const e=window.localStorage.getItem(ws);if(!e)return zo(pi);const t=parseFloat(e);return zo(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),zo(pi)}}function rl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(jt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function Od(){if(typeof window>"u"||!window.localStorage)return Go(vt);try{const e=window.localStorage.getItem(jt);if(!e)return Go(vt);const t=parseFloat(e);return Go(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Go(vt)}}function sl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ze,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function Vd(){if(typeof window>"u"||!window.localStorage)return Ko(Oe);try{const e=window.localStorage.getItem(Ze);if(!e)return Ko(Oe);const t=parseFloat(e);return Ko(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Ko(Oe)}}function ll(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ut,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function Dd(){if(typeof window>"u"||!window.localStorage)return Jo(Xe);try{const e=window.localStorage.getItem(ut);return Jo(e||Xe)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Jo(Xe)}}function Ud(e){return Number.isFinite(e)?Math.min(Fs,Math.max(Hs,e)):wi}function Zo(e){return Hn=Ud(e),Hn}function Hd(e){cn=!!e}function Fd(e){en=!!e}function cl(e){return Qn=e!==!1,Do&&(Do.hidden=!Qn,Do.style.display=Qn?"":"none"),ye.tabSeriesPanelToggle&&(ye.tabSeriesPanelToggle.checked=Qn),Qn}function dl(){return{hoverScale:Mo,selectionDimOpacity:Dn,selectionDimEnabled:Un,tileCompactness:Bo,titleWrapMode:Da,titleHoverWidthMultiplier:Po,titleHoverTextPortion:$o,obsidianLinksEnabled:Ro,obsidianLinkMode:mi,obsidianVaultName:Oo,autoIdFromNameEnabled:po,seriesNavDoubleClickWaitMs:Hn,showSecondaryLinks:cn,stripParentheticalNames:hi,centerItems:yt,showReusedInMap:en,theme:gi,colorPresets:qt,depColor:oa,revdepColor:ia,linkThickness:bi}}function Za(e,{refreshObsidianLinks:t}={}){return xc(e,{applyTileHoverScale:Wo,persistTileHoverScale:tl,applySelectionDimEnabled:qo,persistSelectionDimEnabled:ol,applySelectionDimOpacity:jo,persistSelectionDimOpacity:nl,applyTileCompactness:zo,persistTileCompactness:al,applyTitleWrapMode:Jo,persistTitleWrapMode:ll,applyTitleHoverWidthMultiplier:Go,persistTitleHoverWidthMultiplier:rl,applyTitleHoverTextPortion:Ko,persistTitleHoverTextPortion:sl,applyObsidianLinksEnabled:Qo,persistObsidianLinksEnabled:ml,applyObsidianLinkMode:Xo,persistObsidianLinkMode:fl,applyObsidianVaultName:ti,persistObsidianVaultName:hl,applyAutoIdFromNameEnabled:Yo,persistAutoIdFromNameEnabled:il,applySeriesNavDoubleClickWait:Zo,persistSeriesNavDoubleClickWait:pl,localBackend:tt,ui:ye,refreshObsidianLinks:t,scheduleOverlaySync:wo,selection:K,select:Lt,clearStyles:ha,drawLinks:Tn,applyReusedHighlights:ur,setShowSecondaryLinks:Hd,setShowReusedInMap:Fd,applyDepColor:Ga,persistDepColor:ja,applyRevdepColor:Ka,persistRevdepColor:za,applyLinkThickness:yi,persistLinkThickness:Ja,applyStripParentheticalNames:ei,persistStripParentheticalNames:Xa,applyTheme:Fa,setColorPresets:Fo,applyCenterItems:Uo,persistCenterItems:zs,current:dl()})}const ul=()=>({version:1,exportedAt:new Date().toISOString(),settings:_c(dl(),{localBackend:tt})}),Wd=e=>{const t=Ha(e);return Za(t||{})};typeof window<"u"&&(window.__blockscapeSettingsBridge={exportPayload:ul,applyPayload:Wd});function pl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Us,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function jd(){if(typeof window>"u"||!window.localStorage)return Zo(wi);try{const e=window.localStorage.getItem(Us);if(!e)return Zo(wi);const t=parseInt(e,10);return Zo(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Zo(wi)}}function zd(e){return e===Yi?Yi:Va}function Xo(e){return mi=zd(e),mi}function fl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Es,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function Gd(){if(typeof window>"u"||!window.localStorage)return Xo(Zi);try{const e=window.localStorage.getItem(Es);return Xo(e||Zi)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Xo(Zi)}}function Qo(e){return Ro=!!e,Ro}function Kd(e){const t=(e??"").toString();return t.replace(/\s*\([^)]*\)\s*$/,"").trim()||t.trim()}function ki(e){const t=(e&&typeof e=="object"?e.name||e.id:e)||"";return hi?Kd(t):t}function Jd(){if(C&&(C.querySelectorAll(".tile .name").forEach(e=>{var a;const t=e.closest(".tile"),n=(a=t==null?void 0:t.dataset)==null?void 0:a.id,o=n?ni(n):null,i=o!=null&&o.item?ki(o.item):ki(n);e.textContent=i}),J&&lr(J.value||""),K)){const e=ni(K);e!=null&&e.item&&ce&&(ce.textContent=ki(e.item))}}function ei(e){return hi=!!e,Jd(),hi}function Xa(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(As,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist strip parentheses",t)}}function qd(){if(typeof window>"u"||!window.localStorage)return ei(Qi);try{const e=window.localStorage.getItem(As);if(e==null)return ei(Qi);const t=ei(e==="1"||e==="true");return Xa(t),t}catch(e){return console.warn("[Blockscape] failed to read strip parentheses",e),ei(Qi)}}function ml(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ss,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function Yd(){if(typeof window>"u"||!window.localStorage)return Qo(!1);try{const e=window.localStorage.getItem(Ss);return e==null?Qo(!1):Qo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Qo(!1)}}function ti(e){return Oo=(e??"").toString().trim(),Oo}function hl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ks,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Zd(){if(typeof window>"u"||!window.localStorage)return ti("");try{const e=window.localStorage.getItem(ks);return ti(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),ti("")}}function Xd(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Qd(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function ho(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function eu(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||sa(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=Rn(e,{seriesName:o,fallbackTitle:o})||Cn(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=Cn(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,ho(e,s),!0}function Qa(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>Qa(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${Qa(e[o])}`).join(",")}}`}function gl(e){try{return Qa(e)}catch{return""}}function ra(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=gl(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=gl(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const tu=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category (cycles item.stage in Center view)."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function Mn(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=Yt(a).replace(/\./g,"-");e.id=s||`model-${fo()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function nu(e){var s,l;const t=u=>{const h=(u??"").toString().trim();if(!h)return{base:"",suffix:null};const m=h.match(/^(.*?)-(\d+)$/);return{base:m?m[1]:h,suffix:m?Number.parseInt(m[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const u of n){if(u!=null&&u.isCategoryView)continue;const h=t(((l=u==null?void 0:u.data)==null?void 0:l.id)??(u==null?void 0:u.id)??"");if(h.base){i=h.base;break}}i||(i=Yt(Rn(e)||er(e)||qe(e,"model")));let a=0;return n.forEach(u=>{var m;if(u!=null&&u.isCategoryView)return;const h=t(((m=u==null?void 0:u.data)==null?void 0:m.id)??(u==null?void 0:u.id)??"");h.base===i&&Number.isFinite(h.suffix)&&h.suffix>a&&(a=h.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function ou(e){return JSON.parse(JSON.stringify(e))}function qe(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function sa(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=St(e);return a?`${a} series`:t}return qe(e,t)}function St(e){var i;const t=Rn(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function er(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function iu(e){return e?e.toString().replace(/-series$/i,""):null}function tr(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<S.length;n++){const o=(St(S[n])||"").toLowerCase(),i=(er(S[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function bl(e){var l;if(e<0||e>=S.length||!f)return!0;const t=S[e],n=(f.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Mn(o,{titleHint:qe(t),idHint:St(t)});const i=ra(t.data),a=ra(o);if(i===a)return!0;t.data=o;const s=Wn(t);return s>=0&&((l=t.apicurioVersions)!=null&&l[s])&&(t.apicurioVersions[s].data=o),!0}function wl(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function ni(e){if(g<0||!e)return null;const t=S[g].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function au(e,t){const n=ni(e);return n?(t?n.item.color=t:delete n.item.color,At(),xt(),Lt(e),!0):!1}function ru(e){if(g<0||!e)return!1;const t=S[g].data,o=((t==null?void 0:t.categories)||[]).find(a=>a.id===e);if(!o)return!1;let i=!1;return(o.items||[]).forEach(a=>{vi(a.stage)!=null&&(delete a.stage,i=!0)}),i?(At(),xt(),K&&Lt(K),!0):!1}function su(e,t){if(!e||!t||g<0)return!1;const n=ni(e);if(!n)return!1;const o=vi(n.item.stage),i=o??(t>0?Lo:ea),a=ea-Lo+1,s=((i-Lo+t)%a+a)%a,l=Lo+s;return n.item.stage=l,At(),xt(),Lt(e),!0}function lu(e,t){const n=wl(t);let o=Yt(e||"item");if(!n.has(o))return o;const i=()=>fo().slice(0,4);for(;n.has(o);)o=`${Yt(e||"item")}-${i()}`;return o}function cu(e="category",t){const n=(t==null?void 0:t.categories)||[],o=Yt(e||"category"),i=l=>n.some(u=>u.id===l);let a=o||`category-${fo()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const go=Sc({findItemAndCategoryById:ni,collectAllItemIds:wl,updateItemReferences:yc,loadActiveIntoEditor:At,rebuildFromActive:xt,select:e=>Lt(e),onSelectionRenamed:(e,t)=>{var n;K===e&&(K=t,Zt()),((n=wt==null?void 0:wt.item)==null?void 0:n.id)===e&&(wt.item.id=t)},makeSlug:Yt,isAutoIdFromNameEnabled:()=>po});function du({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=$=>{if(a.fields.errorEl){if(!$){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=$}},l=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},u=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var $,O;($=a.fields.titleInput)==null||$.focus(),(O=a.fields.titleInput)==null||O.select()}))},h=({force:$}={})=>{var Q,Ve;if(!po||!a.autoSyncEnabled||!((Q=a.fields)!=null&&Q.idInput)||!((Ve=a.fields)!=null&&Ve.titleInput)||!$&&a.idManuallyEdited)return;const O=Yt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=O},m=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const $=a.modelData.categories||[],O=$.find(He=>He.id===a.categoryId);if(!O)throw new Error("Category not found.");const Q=(a.fields.idInput.value||"").trim();if(!Q)throw new Error("ID is required.");const Ve=(a.fields.titleInput.value||"").trim();if($.some(He=>He.id===Q&&He.id!==O.id))throw new Error("Another category already uses that ID.");const Ce=O.id;return O.id=Q,O.title=Ve||O.id,Ce!==Q&&typeof i=="function"&&i(Ce,Q),t(),n(),o(Q,{scrollIntoView:!0}),!0},y=()=>{try{return m(),l(),!0}catch($){return console.warn("[CategoryEditor] save failed",$),s(($==null?void 0:$.message)||"Unable to save category."),!1}},P=()=>{if(a.wrapper)return a.wrapper;const $=document.createElement("div");$.className="item-editor-modal category-editor-modal",$.hidden=!0,$.setAttribute("role","dialog"),$.setAttribute("aria-modal","true");const O=document.createElement("div");O.className="item-editor-modal__backdrop",$.appendChild(O);const Q=document.createElement("div");Q.className="item-editor",$.appendChild(Q);const Ve=document.createElement("div");Ve.className="item-editor__header";const ct=document.createElement("h2");ct.className="item-editor__title",ct.textContent="Edit category";const Ce=document.createElement("button");Ce.type="button",Ce.className="item-editor__close",Ce.setAttribute("aria-label","Close category editor"),Ce.textContent="×",Ve.appendChild(ct),Ve.appendChild(Ce),Q.appendChild(Ve);const He=document.createElement("form");He.className="item-editor__form",Q.appendChild(He);const De=document.createElement("div");De.className="item-editor__meta",De.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',He.appendChild(De);const it=document.createElement("div");it.className="item-editor__error",it.hidden=!0,He.appendChild(it);const zt=(bn,yo,wn)=>{const Nt=document.createElement("label");Nt.className="item-editor__field";const Gn=document.createElement("span");if(Gn.className="item-editor__label",Gn.textContent=bn,Nt.appendChild(Gn),yo.classList.add("item-editor__control"),Nt.appendChild(yo),wn){const sn=document.createElement("div");sn.className="item-editor__hint",sn.textContent=wn,Nt.appendChild(sn)}return Nt},$t=document.createElement("input");$t.type="text",He.appendChild(zt("Title",$t,"Display label shown in the map."));const nt=document.createElement("input");nt.type="text",nt.required=!0,He.appendChild(zt("ID",nt,"Unique identifier for this category (used in URLs and references)."));const dt=document.createElement("div");dt.className="item-editor__checkbox";const Ut=document.createElement("label");Ut.className="item-editor__checkbox-row";const gn=document.createElement("input");gn.type="checkbox";const fn=document.createElement("span");fn.textContent="Sync ID while editing title";const Tt=document.createElement("div");Tt.className="item-editor__hint",Tt.textContent="Turn off to keep typing titles without changing the ID.",Ut.append(gn,fn),dt.append(Ut,Tt),He.appendChild(dt);const rn=document.createElement("div");rn.className="item-editor__actions";const Xt=document.createElement("button");Xt.type="submit",Xt.className="item-editor__action item-editor__action--primary",Xt.textContent="Save";const Qt=document.createElement("button");return Qt.type="button",Qt.className="item-editor__action",Qt.textContent="Cancel",rn.appendChild(Xt),rn.appendChild(Qt),He.appendChild(rn),He.addEventListener("submit",bn=>{bn.preventDefault(),y()}),Qt.addEventListener("click",l),Ce.addEventListener("click",l),O.addEventListener("click",l),nt.addEventListener("input",()=>{a.idManuallyEdited=!0}),$t.addEventListener("input",()=>h()),gn.addEventListener("change",()=>{a.autoSyncEnabled=!!gn.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,h({force:!0}))}),$.addEventListener("keydown",bn=>{bn.key==="Escape"&&(bn.preventDefault(),l())}),document.body.appendChild($),a.wrapper=$,a.fields={titleInput:$t,idInput:nt,errorEl:it,metaLabel:De.querySelector(".item-editor__meta-value"),syncCheckbox:gn},$};return{open:$=>{if(!$||!P())return!1;const Q=e(),ct=((Q==null?void 0:Q.categories)||[]).find(He=>He.id===$);if(!ct)return!1;a.categoryId=ct.id,a.modelData=Q,a.idManuallyEdited=!1;const Ce=!!po;return a.autoSyncEnabled=Ce,a.fields.metaLabel.textContent=ct.title||ct.id||"Category",a.fields.titleInput.value=ct.title||ct.id||"",a.fields.idInput.value=ct.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!Ce,!a.fields.idInput.value&&Ce&&h({force:!0}),s(""),u(),!0},hide:l,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const uu=du({getActiveModelData:()=>{var e;return(e=S[g])==null?void 0:e.data},loadActiveIntoEditor:At,rebuildFromActive:xt,selectCategory:(e,t={})=>jn(e,t),onCategoryRenamed:(e,t)=>{A===e&&(A=t,Zt())}}),{handleTileContextMenu:pu,hidePreview:bo,handleDocumentClick:fu,handleWindowResize:mu,handleWindowScroll:hu,updateColorPresets:oi}=Cc({menuEl:document.getElementById("tileContextMenu"),previewEl:ee,previewTitleEl:ce,previewBodyEl:ge,previewActionsEl:rt,previewCloseEl:We,escapeHtml:_i,onEditItem:e=>go.open(e),onChangeColor:(e,t)=>au(e,t),selectItem:e=>Lt(e),colorPresets:qt});function la(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||qe(e);return Ft(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function gu({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=Yt(`${e||"blank"}-${Ya()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),Mn(o,{titleHint:t,idHint:n}),o}function bu(){const t=`Blank series ${Ya()}`,n=Cn(t,"blank-series"),o=gu({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return ho(i,n),Ft(i,{seriesName:t,fallbackTitle:t}),i}function wu(){const e=bu(),t=Fn(e,{versionLabel:"blank"});return Dt(t),pd({origin:"new-blank"}),da(),pn("Blank series created. Add categories and tiles to start.",2600),t}function Fn(e,{versionLabel:t,createdOn:n}={}){var u,h,m;if(e!=null&&e.isSeries||((u=e==null?void 0:e.apicurioVersions)==null?void 0:u.length)>1){const y=e.title||qe(e);Ft(e,{seriesName:y,fallbackTitle:y}),ua(e)}const o=St(e);if(!o)return la(e,{versionLabel:t||"1",createdOn:n}),S.push(e),S.length-1;const i=S.findIndex(y=>St(y)===o);if(i===-1)return la(e,{versionLabel:t||"1",createdOn:n}),S.push(e),S.length-1;const a=S[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(m=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:m.createdOn}],a.apicurioActiveVersionIndex=0;const y=a.title||qe(a);Ft(a,{seriesName:y,fallbackTitle:y})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=qe(e)||a.title,a.isSeries=!0;const l=a.title||qe(a);return Ft(a,{seriesName:l,fallbackTitle:l}),i}function vl({versionLabel:e}={}){var l;if(g<0||!S[g])throw new Error("Load or select a model before creating a version.");const t=S[g];la(t,{versionLabel:"1"});const n=nu(t);let o;try{o=ou(t.data)}catch(u){throw console.warn("[Blockscape] failed to clone active model for versioning",u),new Error("Could not copy the current model.")}n&&(o.id=n),Mn(o,{titleHint:qe(t),idHint:St(t)||Rn(t)});const a={version:e||String((((l=t.apicurioVersions)==null?void 0:l.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||qe(t);return Ft(t,{seriesName:s,fallbackTitle:s}),g}function nr(){const e=g>=0&&S[g]?S[g]:null,t=St(e);document.title=t?`${t}-blockscape`:Pt}function ca(e){if(!e)return null;ua(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||qe(e);return Ft(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var u;const s=((i==null?void 0:i.version)??"").toString().trim(),l=(((u=i==null?void 0:i.data)==null?void 0:u.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(ta)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:l}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function vu(){const e=S[g],t=ca(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function yl(e="shortcut",t=!1){const n=f.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=S[g],i=t?ca(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,l=Rn(o),u=St(o),h=l||u||qe(o,"blockscape"),m=a?"-series":"",y=`${Yt(h)}${m}.bs`;return js(y,s),console.log(`[Blockscape] saved JSON (${e}):`,y),!0}const yu=Ht.palette.letter,Su=Ht.palette.letterFallback;function Sl(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return yu[n]||Su}function Eu(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?Ht.color.ink:Ht.color.white}function ku(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function or(){if(Ct)return;Ct=document.createElement("div"),Ct.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",on=document.createElement("span"),on.className="series-nav-notice__text",Ct.appendChild(e),Ct.appendChild(on),document.body.appendChild(Ct)}function ir(){dn&&(clearTimeout(dn),dn=null),Ct&&Ct.classList.remove("is-visible"),on&&(on.textContent="")}function ii(){nn=null,Wt&&(clearTimeout(Wt),Wt=null),ir()}function ar(){Jt=null,hn&&(clearTimeout(hn),hn=null),ir()}function Iu(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function Cu(e,t,n){or(),nn={id:e,targetVersionIndex:t},Wt&&clearTimeout(Wt),Wt=setTimeout(()=>{Wt=null,ii()},Hn);const o=Iu(n,t);pn(`Click again to open ${o} in this series.`,Hn)}function _u(e,t){or(),Jt={id:e,targetIndex:t},hn&&clearTimeout(hn),hn=setTimeout(()=>{hn=null,ar()},Hn);const n=sa(S[t]);pn(`Click again to open "${n}".`,Hn)}function pn(e,t=Nn,n=null){if(or(),on.textContent="",on.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,on.appendChild(o),on.appendChild(i)}Ct.classList.add("is-visible"),dn&&clearTimeout(dn),dn=setTimeout(()=>ir(),t)}function xu(){$e&&($e.innerHTML="",tu.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const l=document.createElement("span");l.className="shortcut-help__or",l.textContent="or",n.appendChild(l)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((l,u)=>{if(u>0){const m=document.createElement("span");m.className="shortcut-help__sep",m.textContent="+",s.appendChild(m)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=l,s.appendChild(h)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),$e.appendChild(t)}),lo=!0)}function Tu(){return!!Be&&Be.hidden===!1}function Au(){if(!Be)return;lo||xu(),_n=document.activeElement,Be.hidden=!1,Be.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Be.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function rr(){if(!Be||Be.hidden)return;Be.hidden=!0,Be.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=_n;e!=null&&e.focus?e.focus({preventScroll:!0}):de!=null&&de.focus&&de.focus({preventScroll:!0})}function Lu(){if(!R)return;R.hidden=!1,R.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=R.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function da(){!R||R.hidden||(R.hidden=!0,R.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),Ae!=null&&Ae.focus&&Ae.focus({preventScroll:!0}))}let sr=!1;function wo(){sr||(sr=!0,requestAnimationFrame(()=>{sr=!1,fa(),Tn()}))}let El=!1;function kl(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function Nu(e){const t=kl(e);if(!t.length){C.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}C.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(l=>o.includes(l)||i.includes(l));n.style.opacity=a?"1":"0.2"})}function Mu(e){const t=kl(e);if(!t.length)return[];const n=[];return S.forEach((o,i)=>{var h;const a=sa(o),s=St(o)||"",l=`${a} ${s}`.toLowerCase();t.every(m=>l.includes(m))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((h=o.data)==null?void 0:h.categories)?o.data.categories:[]).forEach(m=>{const y=(m.title||m.id||"").toString();(m.items||[]).forEach(P=>{const M=ki(P),$=(P.name||P.id||"").toString(),O=`${$} ${P.id||""} ${y}`.toLowerCase();t.every(Q=>O.includes(Q))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:P.id,itemName:$,itemDisplayName:M,categoryTitle:y})})})}),n.slice(0,X)}function Il(e){if(!Se)return;Se.innerHTML="";const t=(e||"").toString();if(!t.trim()){Se.hidden=!0;return}if(!S.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",Se.appendChild(o),Se.hidden=!1;return}const n=Mu(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",Se.appendChild(o),Se.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===g&&(!o.itemId||K===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemDisplayName||o.itemName||o.itemId||"Item",a.appendChild(s);const l=document.createElement("span");l.className="search-result__badge",l.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(l);const u=document.createElement("div");u.className="search-result__meta";const h=document.createElement("span");if(h.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,u.appendChild(h),o.type==="item"&&o.itemId){const m=document.createElement("span");m.textContent=`Item ID: ${o.itemId}`,u.appendChild(m)}else if(o.type==="model"){const m=document.createElement("span");m.textContent="Matches model title",u.appendChild(m)}i.appendChild(a),i.appendChild(u),Se.appendChild(i)}),Se.hidden=!1}function lr(e){Nu(e||""),Il(e||"")}function Bu(e){!e||!Number.isInteger(e.modelIndex)||(Dt(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(g!==e.modelIndex)return;const t=(n=xe.get(e.itemId))==null?void 0:n.el;t&&(Lt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function Dt(e){var t;if(bo(),ii(),wt=null,tn=null,A=null,Je=null,e<0||e>=S.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(d=!0,g=e,console.log("[Blockscape] active model:",qe(S[e]),"(index",e+" )"),typeof(tt==null?void 0:tt.highlightSource)=="function"){const n=((t=S[e])==null?void 0:t.sourcePath)||null;tt.highlightSource(n)}nr(),Bn(),At(),xt(),J&&lr(J.value||""),tt.updateActiveSavePlaceholder(),he.updateAvailability(),qa()}function Bn(){if(Z.innerHTML="",!S.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",Z.appendChild(e);return}S.forEach((e,t)=>{var y;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===g?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===g?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=sa(e),i.appendChild(a);const s=iu(er(e)||St(e));if(s){const P=document.createElement("span");P.className="model-nav-id",P.textContent=s,i.appendChild(P)}const l=Array.isArray((y=e.data)==null?void 0:y.categories)?e.data.categories:[],u=l.reduce((P,M)=>P+(M.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const m=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";h.textContent=`${l.length} cat · ${u} items${m}`,o.appendChild(i),o.appendChild(h),n.appendChild(o),Z.appendChild(n)}),he.updateAvailability()}function At(){if(g<0){f.value="",ie&&(ie.disabled=!0);return}const e=S[g];f.value=JSON.stringify(e.data,null,2),ie&&(ie.disabled=!ca(e))}function Pu(e){try{return JSON.parse(e)}catch{return null}}function Cl(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function $u(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,l)=>{const u=s==null?void 0:s.data;if(!u||!Array.isArray(u.categories))return;const h=qe(u,`Map ${l+1}`),m=(u.id??"").toString().trim()||Yt(h||`map-${l+1}`),y=Yt(m||h||`map-${l+1}`);u.categories.forEach(P=>{const M=((P==null?void 0:P.id)??"").toString().trim();if(!M)return;n.has(M)||n.set(M,{catTitle:P.title||M,sources:[]});const $=n.get(M);!$.catTitle&&(P.title||M)&&($.catTitle=P.title||M),$.sources.push({category:P,mapId:m,mapTitle:h,mapSlug:y,versionIndex:l})})});const o=Rn(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||qe(e,"Series"),a=[];return n.forEach((s,l)=>{var P;if((((P=s.sources)==null?void 0:P.length)||0)<2)return;const u=s.catTitle||l,h=new Set,m=s.sources.map(M=>{var ct;let O=M.mapSlug||Yt(M.mapTitle||M.mapId)||`map-${M.versionIndex+1}`;h.has(O)&&(O=`${O}-${M.versionIndex+1}`),h.add(O);const Q=new Map,Ve=(((ct=M.category)==null?void 0:ct.items)||[]).map((Ce,He)=>{const De=((Ce==null?void 0:Ce.id)??"").toString().trim()||`item-${He+1}`,it=`${O}-${De}`;Q.set(De,it);const zt={...Ce,id:it};return zt.deps=Array.isArray(Ce==null?void 0:Ce.deps)?[...Ce.deps]:[],zt});return Ve.forEach(Ce=>{Ce.deps=(Ce.deps||[]).map(He=>Q.get(He)).filter(Boolean)}),{id:O,title:M.mapTitle||M.mapId||`Map ${M.versionIndex+1}`,items:Ve}}),y={id:Yt(`${l}-category-view`),title:u,abstract:`Items from "${u}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:m};o&&(y.seriesId=o),Mn(y,{titleHint:u,idHint:`${o||"series"}-${l}`}),a.push({version:`${ta}${l}`,data:y,isCategoryView:!0,categoryViewKey:l})}),a}function _l(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${ta}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function ua(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=_l(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(l=>!(l!=null&&l.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Wn(e),e.apicurioVersions.length-1));const l=e.apicurioVersions[e.apicurioActiveVersionIndex];return l!=null&&l.data&&(e.data=l.data),e}const o=$u({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(l=>_l(l)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function Ru(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((m,y)=>!m||typeof m!="object"?null:(Mn(m,{titleHint:`${t} #${y+1}`}),{obj:m,idx:y})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let l=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const u={id:fo(),title:l,data:a,apicurioVersions:i.map(({obj:m,idx:y})=>({version:String(y+1),data:m})),apicurioActiveVersionIndex:0,isSeries:!0},h=Ft(u,{seriesName:l,fallbackTitle:l});return h&&(u.id=h),ua(u),[u]}function xl(e,t="Pasted",n={}){return Array.isArray(e)?Ru(e,t,n):!e||typeof e!="object"?[]:(Mn(e,{titleHint:`${t} #1`}),[{id:fo(),title:e.title||`${t} #1`,data:e}])}function eo(e,t="Pasted",n={}){const a=(Cl(typeof e=="string"?e:"")||"").replace(/^\uFEFF/,"").replace(/\u0000/g,"").trim();if(!a)return[];const s=Pu(a);if(s){let u=n;if(Array.isArray(s)&&n.promptForSeriesName){const m=Qd(s,t),y=Xd(m);u={...n,promptForSeriesName:!1,seriesTitleOverride:y||m}}const h=xl(s,t,u);if(h.length)return h}return a.split(/^\s*(?:---|%%%)\s*$/m).map(u=>u.trim()).filter(Boolean).map((u,h)=>{const m=JSON.parse(u);return Mn(m,{titleHint:`${t} #${h+1}`}),{id:fo(),title:m.title||`${t} #${h+1}`,data:m}})}function Ou(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function vo(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!Ou(e)}function Vu(e){if(!e)return!1;const n=(Cl(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function Du(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=Zc(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=xl(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const l=s.isSeries?o.title||s.title:null,u=Fn({...s,apicurioArtifactName:l||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=u)}),a}async function Uu(){const e=fd();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await Ei())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await Qs(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(tt==null?void 0:tt.highlightSource)=="function"&&tt.highlightSource(t);let s=a.firstIndex;if(n){const l=tr(n);l!==-1&&(s=l)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function Hu(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await pr(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function Fu(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const l=new Set(s.deps||[]);t.set(s.id,l),l.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function Wu(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=Sl(e,t),l=Eu(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=l,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function Wn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Tl(e){const t=Wn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Al(e,t="active"){return Rn(e)||St(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function ju(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,l;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((l=n==null?void 0:n.data)==null?void 0:l.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function zu(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(Yt(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,l]of t.entries())if(s.toLowerCase()===a)return l}return null}const Ll=new WeakMap;function Gu(e,t){var it;if(!((it=e==null?void 0:e.apicurioVersions)!=null&&it[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=ra(o),a=Ll.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,l=160,u=document.createElement("canvas");u.width=s,u.height=l;const h=u.getContext("2d"),m=Ho("--color-surface-ghost")||Ht.color.surfaceGhost,y=Ho("--color-border-muted")||Ht.color.borderMuted;h.fillStyle=m,h.fillRect(0,0,s,l),h.strokeStyle=y,h.strokeRect(.5,.5,s-1,l-1);const P=8,M=8,$=4,O=Array.isArray(o==null?void 0:o.categories)?o.categories:[],Q=Math.max(O.length,1),Ve=s-$*2,ct=$*3,Ce=Q>1?Math.min(ct,Ve/(Q-1)):0,He=Q>1?(s-Ce*(Q-1))/2:s/2;O.forEach((zt,$t)=>{const nt=He+$t*Ce,dt=Array.isArray(zt.items)?zt.items:[],Ut=Math.max(dt.length,1),gn=l-P-M-$*2,fn=Ut>1?Math.min($*3,gn/(Ut-1)):0;dt.forEach((Tt,rn)=>{const Xt=l-M-$-rn*fn;h.beginPath(),h.arc(nt,Xt,$,0,Math.PI*2);const Qt=Sl(Tt.name||Tt.id||"",Tt.color);h.fillStyle=Qt,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const De=u.toDataURL("image/png");return Ll.set(n,{fingerprint:i,dataUrl:De}),De}function pa(e,t){var l;if(ii(),e<0||e>=S.length)return!1;const n=S[e];if(!((l=n==null?void 0:n.apicurioVersions)!=null&&l.length)||!bl(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,d=!0,K=null,mt=null,Zt(),At(),xt(),!0):!1}function cr(e){var o;if(!e||g<0)return!1;const t=S[g];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=Wn(t);return n===-1?!1:pa(g,n+e)}function Ku(e,t){if(ii(),e<0||e>=S.length)return!1;const n=S[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!bl(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=Wn(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const l=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(l==null?void 0:l.data)||n.data,n.isSeries=n.apicurioVersions.length>1,Dt(e),!0}function Ju(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,c.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||St(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var Ve;const O=S[g];!((Ve=O==null?void 0:O.apicurioVersions)!=null&&Ve.length)||!eu(O)||(Bn(),At(),xt())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=Wn(e),s=Tl(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const l=document.createElement("div");l.className="version-nav__controls";const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Previous",u.addEventListener("click",()=>cr(-1));const h=document.createElement("button");h.type="button",h.className="version-nav__button",h.textContent="Next",h.addEventListener("click",()=>cr(1)),l.appendChild(u),l.appendChild(h),n.appendChild(l);const m=document.createElement("div");m.className="version-nav__thumbs",e.apicurioVersions.forEach((O,Q)=>{var $t,nt;const Ve=document.createElement("button");Ve.type="button",Ve.className="version-nav__thumb",O!=null&&O.isCategoryView&&Ve.classList.add("version-nav__thumb--category"),Q===a&&Ve.classList.add("is-active");const ct=Gu(e,Q);if(ct){const dt=document.createElement("img");dt.src=ct,dt.alt=`Version ${Q+1}`,Ve.appendChild(dt)}const Ce=document.createElement("div");Ce.className="version-nav__thumb-label";const He=document.createElement("span");He.className="version-nav__thumb-label-text";const De=((($t=O==null?void 0:O.data)==null?void 0:$t.id)??(O==null?void 0:O.id)??"").toString().trim();let it=De||(O!=null&&O.version?`v${O.version}`:`${Q+1}`),zt=De||it;if(O!=null&&O.isCategoryView){const dt=((nt=O.data)==null?void 0:nt.title)||O.categoryViewKey||it||"Category";it=dt,zt=`Category view: ${dt}`,Ve.dataset.computed="true"}if(He.textContent=it,Ce.title=zt,Ce.appendChild(He),Ve.appendChild(Ce),np(Ce,He),e.apicurioVersions.length>1&&!(O!=null&&O.isCategoryView)){const dt=document.createElement("span");dt.className="version-nav__thumb-remove",dt.title=`Remove ${it} from this series`,dt.setAttribute("aria-label",`Remove ${it} from this series`),dt.setAttribute("role","button"),dt.tabIndex=-1,dt.textContent="×",dt.addEventListener("click",Ut=>{Ut.stopPropagation(),Ut.preventDefault(),window.confirm(`Remove ${it} from this series?`)&&Ku(g,Q)}),Ve.appendChild(dt)}Ve.addEventListener("click",()=>pa(g,Q)),ip(Ve,O),m.appendChild(Ve)});const y=document.createElement("button");y.type="button",y.className="version-nav__thumb version-nav__thumb--add",y.title="Create a new version from this map",y.addEventListener("click",()=>{try{const O=vl({versionLabel:"manual"});Dt(O)}catch(O){alert((O==null?void 0:O.message)||"Unable to create a new version right now.")}});const P=document.createElement("span");P.className="version-nav__thumb-add-icon",P.textContent="+",y.appendChild(P),m.appendChild(y),n.appendChild(m);const M=Al(e,"active"),$=B.get(M);return typeof $=="number"&&!Number.isNaN($)&&requestAnimationFrame(()=>{m.scrollLeft=$}),m.addEventListener("scroll",()=>{B.set(M,m.scrollLeft)}),n}function Ii(){var Ql,ec;if(!q)return;const e=g>=0&&S[g]?S[g]:null,t=C&&C.querySelector?C.querySelector(".version-nav__thumbs"):null;if(t&&e){const p=Al(e,g);B.set(p,t.scrollLeft)}zn(),Array.isArray(q.m.categories)||(q.m.categories=[]),console.log("[Blockscape] rendering categories=",q.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!q.m.abstract,"- value:",q.m.abstract?q.m.abstract.substring(0,50)+"...":"none"),C.innerHTML="",xe.clear(),It.clear(),U=[],Qn=!0,ye.tabSeriesPanelToggle&&(ye.tabSeriesPanelToggle.checked=!0),la(S[g],{versionLabel:"1"}),Do=Ju(S[g]),Do&&(cl(Qn),C.appendChild(Do)),G.setAttribute("width",window.innerWidth),G.setAttribute("height",window.innerHeight);const o=(()=>{var Y,Ue,Kt;const p=document.createElement("div");p.className="blockscape-model-meta";const L=document.createElement("div");L.className="blockscape-model-title",L.textContent=q.m.title&&q.m.title.trim()||qe(S[g]),p.appendChild(L),((Y=S[g])!=null&&Y.isSeries||(Kt=(Ue=S[g])==null?void 0:Ue.apicurioVersions)!=null&&Kt.length)&&Ft(S[g],{seriesName:S[g].title||q.m.title||qe(S[g])});const V=Tl(S[g]),me=Rn(S[g]),fe=(q.m.id??"").toString().trim(),Me=document.createElement("div");Me.className="blockscape-model-meta__details";const Te=(Fe,Ot)=>{if(!Ot)return;const In=document.createElement("div");In.className="blockscape-model-id";const Io=document.createElement("span");Io.className="blockscape-model-id__label",Io.textContent=Fe;const Co=document.createElement("span");Co.className="blockscape-model-id__value",Co.textContent=Ot,In.append(Io,Co),Me.appendChild(In)};return Te("Series ID",me),Te("Model ID",fe),Te("No. in series",V),Me.childElementCount&&p.appendChild(Me),p})();c.showModelMeta!==!1&&C.appendChild(o.cloneNode(!0));const a=document.createElement("div");a.className="blockscape-tabs";const s=document.createElement("div");s.className="blockscape-tabrow";const l=document.createElement("div");l.className="blockscape-tablist",l.setAttribute("role","tablist"),s.appendChild(l);const u=document.createElement("div");u.className="blockscape-tabactions",s.appendChild(u),a.appendChild(s);const h=document.createElement("div");h.className="blockscape-tabpanels",a.appendChild(h);const m=document.createElement("div"),y=document.createElement("div"),P=document.createElement("div"),M=document.createElement("div"),$=()=>{const p=document.createElement("div");p.className="blockscape-map-legend";const L=document.createElement("div");return L.className="blockscape-legend",L.setAttribute("role","presentation"),L.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,p.appendChild(L),p};let O="";const Q=ju(S[g]),Ve=Wn(S[g]),ct=((ec=(Ql=S[g])==null?void 0:Ql.apicurioVersions)==null?void 0:ec[Ve])||null,Ce=On=!!(ct!=null&&ct.isCategoryView||((ct==null?void 0:ct.version)||"").startsWith(ta));an=null,xn="";const He=(p,L)=>{!p||!L||(p.title=p.title?`${p.title}
${L}`:L)},De=[{id:"map",label:"Map",panel:m},{id:"abstract",label:"Info",panel:y},{id:"source",label:"Settings",panel:P},{id:"apicurio",label:"Apicurio",panel:M}],it=typeof he.isEnabled=="function"?he.isEnabled():!1,zt=p=>{if(!G)return;const L=p==="map";G.hidden=!L,L?(fa(),Tn()):G.innerHTML=""};De.forEach((p,L)=>{const V=document.createElement("button");V.type="button",V.id=`tab-${p.id}`,V.className="blockscape-tab"+(L===0?" is-active":""),V.setAttribute("role","tab"),V.setAttribute("aria-controls",`panel-${p.id}`),V.setAttribute("aria-selected",L===0?"true":"false"),V.textContent=p.label,p.id==="apicurio"&&!it&&(V.hidden=!0,V.tabIndex=-1,V.setAttribute("aria-hidden","true"),V.style.display="none"),p.button=V,l.appendChild(V),p.panel.id=`panel-${p.id}`,p.panel.classList.add("blockscape-tabpanel"),p.panel.setAttribute("role","tabpanel"),p.panel.setAttribute("aria-labelledby",V.id),p.panel.hidden=L!==0,L===0&&p.panel.classList.add("is-active"),h.appendChild(p.panel)});const $t=p=>{Xn=p,De.forEach(L=>{const V=L.id===p;L.button.classList.toggle("is-active",V),L.button.setAttribute("aria-selected",V?"true":"false"),L.panel.classList.toggle("is-active",V),L.panel.hidden=!V}),zt(p)},nt=De.find(p=>p.id==="apicurio"),dt=p=>{if(!nt||!nt.button||!nt.panel)return;const L=!!p;if(nt.button.hidden=!L,nt.button.tabIndex=L?0:-1,nt.button.setAttribute("aria-hidden",L?"false":"true"),nt.button.style.display=L?"":"none",L){const V=Xn==="apicurio";nt.button.classList.toggle("is-active",V),nt.button.setAttribute("aria-selected",V?"true":"false"),nt.panel.classList.toggle("is-active",V),nt.panel.hidden=!V}else{const V=nt.panel.classList.contains("is-active");if(nt.button.classList.remove("is-active"),nt.button.setAttribute("aria-selected","false"),nt.panel.classList.remove("is-active"),nt.panel.hidden=!0,V){const me=De.find(fe=>fe.id!=="apicurio");me&&$t(me.id)}}N&&(N.checked=L)};De.forEach(p=>{p.button.addEventListener("click",()=>{zn(),$t(p.id)}),p.id==="abstract"&&(an=p.button,p.button.addEventListener("mouseenter",()=>xi(p.button,O,{offset:12})),p.button.addEventListener("mouseleave",zn),p.button.addEventListener("focus",()=>xi(p.button,O,{offset:12})),p.button.addEventListener("blur",zn))});const gn=(p=>{const L=De.find(me=>me.id===Xn);if(L&&(L.id!=="apicurio"||p))return L.id;const V=De.find(me=>me.id!=="apicurio"||p);return(V==null?void 0:V.id)||De[0].id})(it);$t(gn),dt(it),typeof he.onEnabledChange=="function"&&he.onEnabledChange(dt),C.appendChild(a),m.appendChild($());const fn=document.createElement("div");fn.className="blockscape-render";const Tt=document.createElement("div");Tt.className="stage-guides",Tt.hidden=!yt,Tt.setAttribute("aria-hidden","true");const rn=document.createElement("div");rn.className="stage-guide-labels",["Genesis / Inception","Custom","Product / Rental","Service / Commodity"].forEach(p=>{const L=document.createElement("span");L.className="stage-guide-labels__item",L.textContent=p,rn.appendChild(L)}),Tt.appendChild(rn),fn.appendChild(Tt),Ua=Tt,m.appendChild(fn);const Xt=document.createElement("div");Xt.className="blockscape-abstract-panel",y.appendChild(o.cloneNode(!0));const Qt=document.createElement("form");Qt.className="blockscape-info-form",Qt.noValidate=!0;const bn=document.createElement("div");bn.className="blockscape-info-fields";const yo=(p,L)=>{const V=document.createElement("label");V.className="blockscape-info-field";const me=document.createElement("span");return me.className="blockscape-info-label",me.textContent=p,V.append(me,L),V},wn=document.createElement("input");wn.type="text",wn.className="pf-v5-c-form-control",wn.placeholder="Title",wn.value=q.m.title&&q.m.title.toString()||qe(S[g],"");const Nt=document.createElement("textarea");Nt.className="pf-v5-c-form-control",Nt.rows=6,Nt.placeholder="Abstract (supports basic HTML)",Nt.value=q.m.abstract||"";const Gn=()=>{var Te,Y,Ue;if(g<0)return;const p=S[g],L=(wn.value||"").trim(),V=Nt.value||"";let me=!1;const fe=(((Te=p.data)==null?void 0:Te.title)||"").toString();L!==fe&&(p.data.title=L,!p.isSeries&&!((Y=p.apicurioVersions)!=null&&Y.length)&&(p.title=L),me=!0);const Me=((Ue=p.data)==null?void 0:Ue.abstract)||"";V!==Me&&(p.data.abstract=V,me=!0),me&&(Bn(),At(),xt())};wn.addEventListener("blur",Gn),Nt.addEventListener("blur",Gn),Qt.addEventListener("submit",p=>{p.preventDefault(),Gn()}),bn.append(yo("Title",wn),yo("Abstract",Nt));const sn=document.createElement("div");sn.className="blockscape-info-actions";const si=document.createElement("button");si.type="submit",si.className="pf-v5-c-button pf-m-primary",si.textContent="Update",sn.appendChild(si),Qt.append(bn,sn);const ga=p=>p?p.replace(/\n/g,"<br>"):"",fr=q.m.abstract||"",Ti=ga(fr),ba=!!Ti,So=document.createElement("div");So.className=ba?"blockscape-abstract":"blockscape-abstract-placeholder",So.innerHTML=ba?Ti:"No abstract has been provided for this model.",kp(So),Xt.appendChild(So),Xt.appendChild(Qt),O=So.outerHTML,xn=O,y.appendChild(Xt);const Eo=document.createElement("div");Eo.className="blockscape-source-panel";const at=document.createElement("div");at.className="blockscape-settings-panel";const I=p=>{ye.themeToggle&&(ye.themeToggle.checked=p),ye.tabThemeToggle&&(ye.tabThemeToggle.checked=p)},F=p=>{I(p),Fa(p?uo:No)},se=p=>{ye.tabCenterToggle&&(ye.tabCenterToggle.checked=p)},ke=p=>{const L=Uo(p);se(L),zs(L)},ot=p=>{ye.secondaryLinksToggle&&(ye.secondaryLinksToggle.checked=p),ye.tabSecondaryLinksToggle&&(ye.tabSecondaryLinksToggle.checked=p)},Ge=p=>{const L=!!p;ot(L),cn=L,K?Lt(K):(ha(),Tn())},ne=({id:p,label:L,checked:V,onChange:me})=>{const fe=document.createElement("label");fe.className="blockscape-tab-toggle",fe.setAttribute("for",p);const Me=document.createElement("input");Me.type="checkbox",Me.id=p,Me.checked=V,typeof me=="function"&&Me.addEventListener("change",()=>me(Me.checked));const Te=document.createElement("span");return Te.className="blockscape-tab-toggle__label",Te.textContent=L,fe.append(Me,Te),{row:fe,input:Me}},Pe=document.createElement("p");Pe.className="blockscape-settings-panel__title",Pe.textContent="Feature toggles",at.appendChild(Pe);const Rt=document.createElement("label");Rt.className="settings-toggle";const ln=document.createElement("input");ln.type="checkbox",ln.checked=gi===uo;const mn=document.createElement("span");mn.className="settings-toggle__text";const to=document.createElement("span");to.className="settings-toggle__label",to.textContent="Dark mode";const mr=document.createElement("span");mr.className="settings-toggle__hint",mr.textContent="Switch Blockscape UI to dark colors.",mn.append(to,mr),Rt.append(ln,mn),ln.addEventListener("change",()=>{F(ln.checked)}),at.appendChild(Rt),ye.themeToggle=ln;const{row:Lp,input:Np}=ne({id:"tabToggleTheme",label:"Dark mode",checked:gi===uo,onChange:p=>F(p)});u.appendChild(Lp),ye.tabThemeToggle=Np;const{row:Mp,input:Bp}=ne({id:"tabToggleSeriesPanel",label:"Series panel",checked:Qn,onChange:p=>cl(p)});u.appendChild(Mp),ye.tabSeriesPanelToggle=Bp;const{row:Pp,input:$p}=ne({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:cn,onChange:p=>Ge(p)});u.appendChild(Pp),ye.tabSecondaryLinksToggle=$p;const{row:Rp,input:Op}=ne({id:"tabToggleCenterItems",label:"Wardley",checked:yt,onChange:p=>ke(p)});u.appendChild(Rp),ye.tabCenterToggle=Op;const hr=document.createElement("div");hr.className="settings-actions";const no=document.createElement("input");no.type="file",no.accept="application/json",no.hidden=!0;const Ai=document.createElement("button");Ai.type="button",Ai.className="pf-v5-c-button pf-m-secondary",Ai.textContent="Load settings",Ai.addEventListener("click",()=>no.click()),no.addEventListener("change",async()=>{var L,V;const p=(L=no.files)==null?void 0:L[0];if(p)try{const me=await p.text(),fe=JSON.parse(me),Me=(fe==null?void 0:fe.settings)||fe,Y=((V=Za(Me||{},{refreshObsidianLinks:va}).applied)==null?void 0:V.length)||0;pn(Y?`Loaded ${Y} setting${Y===1?"":"s"} from ${p.name}.`:`No matching settings found in ${p.name}.`,2200)}catch(me){console.warn("[Blockscape] failed to load settings.json",me),pn("Invalid settings file.",2400)}finally{no.value=""}});const Li=document.createElement("button");Li.type="button",Li.className="pf-v5-c-button pf-m-tertiary",Li.textContent="Download settings",Li.addEventListener("click",async()=>{const p=ul();if(typeof window<"u"&&typeof window.__blockscapeSettingsSaveToFile=="function")try{await window.__blockscapeSettingsSaveToFile(p)?pn("Settings saved to ~/.blockscape/settings.json.",2e3):pn("Settings save failed. Check logs.",2400)}catch(L){console.warn("[Blockscape] settings save failed",L),pn("Settings save failed. Check logs.",2400)}else js("settings.json",JSON.stringify(p,null,2)),pn("Settings downloaded.",2e3)}),hr.append(Ai,Li,no),at.appendChild(hr);const wa=document.createElement("div");wa.className="color-presets";const gr=document.createElement("div");gr.className="settings-text__label",gr.textContent="Color presets";const br=document.createElement("div");br.className="settings-text__hint",br.textContent="Shown in tile context menu for quick coloring.",wa.append(gr,br);const Ni=document.createElement("div");Ni.className="color-presets__list";const wr=document.createElement("div");wr.className="color-presets__add";const li=document.createElement("input");li.type="text",li.placeholder="Name",li.className="settings-text__input";const Mi=document.createElement("input");Mi.type="color",Mi.value="#2563eb",Mi.className="settings-color-input";const Bi=document.createElement("button");Bi.type="button",Bi.className="pf-v5-c-button pf-m-primary",Bi.textContent="Add preset",Bi.addEventListener("click",()=>{const p=li.value.trim()||"Custom",L=Mi.value,V=[...qt,{name:p,value:L}];Fo(V),oi(qt),li.value=""}),wr.append(li,Mi,Bi),wa.append(Ni,wr),at.appendChild(wa),ye.colorPresetList=Ni,Vo=()=>{Ni.innerHTML="",qt.forEach((p,L)=>{const V=document.createElement("div");V.className="color-presets__row";const me=document.createElement("input");me.type="text",me.className="settings-text__input",me.value=p.name||"",me.placeholder="Name",me.addEventListener("input",()=>{const Te=[...qt];Te[L]={...Te[L],name:me.value},Fo(Te),oi(qt)});const fe=document.createElement("input");fe.type="color",fe.className="settings-color-input",fe.value=p.value,fe.addEventListener("input",()=>{const Te=[...qt];Te[L]={...Te[L],value:fe.value},Fo(Te),oi(qt)});const Me=document.createElement("button");Me.type="button",Me.className="pf-v5-c-button pf-m-plain",Me.textContent="✕",Me.title="Remove preset",Me.addEventListener("click",()=>{const Te=qt.filter((Y,Ue)=>Ue!==L);Fo(Te),oi(qt),Vo()}),V.append(me,fe,Me),Ni.appendChild(V)})},Vo();const vr=document.createElement("div");vr.className="settings-text";const yr=document.createElement("div");yr.className="settings-text__label",yr.textContent="Link colors";const Sr=document.createElement("div");Sr.className="settings-text__hint",Sr.textContent="Adjust the colors used when highlighting enables/dependents.";const Er=document.createElement("div");Er.className="settings-color-rows";const zl=({id:p,label:L,hint:V,value:me,onChange:fe})=>{const Me=document.createElement("label");Me.className="settings-color-row",Me.setAttribute("for",p);const Te=document.createElement("span");if(Te.className="settings-color-row__label",Te.textContent=L,V){const Ue=document.createElement("span");Ue.className="settings-color-row__hint",Ue.textContent=V,Te.appendChild(Ue)}const Y=document.createElement("input");if(Y.type="color",Y.id=p,Y.className="settings-color-input",Y.value=me,typeof fe=="function"){const Ue=()=>fe(Y.value);Y.addEventListener("input",Ue),Y.addEventListener("change",Ue)}return Me.append(Te,Y),Er.appendChild(Me),Y};ye.depColorInput=zl({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:oa,onChange:p=>{const L=Ga(p);ja(L)}}),ye.revdepColorInput=zl({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:ia,onChange:p=>{const L=Ka(p);za(L)}}),vr.append(yr,Sr,Er),at.appendChild(vr);const kr=document.createElement("div");kr.className="settings-text";const Ir=document.createElement("div");Ir.className="settings-text__text";const Cr=document.createElement("div");Cr.className="settings-text__label",Cr.textContent="Link thickness";const _r=document.createElement("div");_r.className="settings-text__hint",_r.textContent="Adjust stroke width for enables/dependents lines.",Ir.append(Cr,_r);const ko=document.createElement("select");ko.id="linkThickness",ko.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:p,label:L})=>{const V=document.createElement("option");V.value=p,V.textContent=L,p===bi&&(V.selected=!0),ko.appendChild(V)}),ko.addEventListener("change",()=>{const p=yi(ko.value);Ja(p)});const xr=document.createElement("div");xr.className="settings-text__row",xr.append(Ir,ko),kr.appendChild(xr),at.appendChild(kr),ye.linkThicknessInput=ko;const Kn=({id:p,label:L,hint:V,checked:me,className:fe="",onChange:Me})=>{const Te=document.createElement("label");Te.className=["settings-toggle",fe].filter(Boolean).join(" ");const Y=document.createElement("input");Y.type="checkbox",Y.id=p,Y.checked=me;const Ue=document.createElement("span");Ue.className="settings-toggle__text";const Kt=document.createElement("span");if(Kt.className="settings-toggle__label",Kt.textContent=L,Ue.appendChild(Kt),V){const Fe=document.createElement("span");Fe.className="settings-toggle__hint",Fe.textContent=V,Ue.appendChild(Fe)}return Te.appendChild(Y),Te.appendChild(Ue),typeof Me=="function"&&Y.addEventListener("change",()=>Me(Y.checked)),{row:Te,input:Y}},va=()=>{C.querySelectorAll(".tile").forEach(p=>{const L=p.dataset.id,V=ni(L);if(!(V!=null&&V.item))return;const me=Rl(V.item.external),fe=$l(V.item,{externalMeta:me,seriesIdLookup:Q});Ol(p,fe)})},{row:Vp,input:Dp}=Kn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:cn,className:"map-controls__toggle",onChange:p=>Ge(p)});at.appendChild(Vp),ye.secondaryLinksToggle=Dp;const{row:Up,input:Hp}=Kn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:en,className:"map-controls__toggle",onChange:p=>{en=p,ur()}});at.appendChild(Up),ye.reusedToggle=Hp;const{row:Fp,input:Wp}=Kn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:po,className:"map-controls__toggle",onChange:p=>{const L=Yo(p);il(L)}});at.appendChild(Fp),ye.autoIdToggle=Wp;const Tr=[],{row:jp,input:zp}=Kn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:Ro,className:"map-controls__toggle",onChange:p=>{const L=Qo(p);ml(L),Tr.forEach(V=>{V.disabled=!L}),va()}});if(at.appendChild(jp),ye.obsidianToggle=zp,typeof(tt==null?void 0:tt.isAvailable)=="function"&&tt.isAvailable()&&typeof(tt==null?void 0:tt.getAutoReloadConfig)=="function"){const{enabled:p,intervalMs:L}=tt.getAutoReloadConfig();let V=null;const{row:me,input:fe}=Kn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:p,className:"map-controls__toggle",onChange:Ot=>{tt.setAutoReloadEnabled(Ot),V&&(V.disabled=!Ot)}});at.appendChild(me),ye.autoReloadToggle=fe;const Me=Ot=>`${(Ot/1e3).toFixed(2)}s`,Te=document.createElement("label");Te.className="settings-slider",Te.setAttribute("for","autoReloadInterval");const Y=document.createElement("div");Y.className="settings-slider__text";const Ue=document.createElement("span");Ue.className="settings-slider__label",Ue.textContent="Auto-reload interval";const Kt=document.createElement("span");Kt.className="settings-slider__hint",Kt.textContent="Adjust how often to poll for file changes.",Y.append(Ue,Kt);const Fe=document.createElement("span");Fe.className="settings-slider__value",Fe.textContent=Me(L),V=document.createElement("input"),V.type="range",V.id="autoReloadInterval",V.className="settings-slider__input",V.min=String(_s),V.max=String(xs),V.step="100",V.value=String(L),V.disabled=!p,V.setAttribute("aria-label","Set auto-reload polling interval"),V.addEventListener("input",()=>{const Ot=tt.setAutoReloadInterval(parseInt(V.value,10));Fe.textContent=Me(Ot)}),Te.append(Y,Fe,V),at.appendChild(Te),ye.autoReloadInput=V,ye.autoReloadValue=Fe}const Ar=document.createElement("div");Ar.className="settings-radio";const Lr=document.createElement("div");Lr.className="settings-radio__label",Lr.textContent="Obsidian link format";const Nr=document.createElement("div");Nr.className="settings-radio__hint",Nr.textContent="Use the tile title or id when building Obsidian links.";const Mr=document.createElement("div");Mr.className="settings-radio__options";const Gl=(p,L)=>{const V=document.createElement("label");V.className="settings-radio__option";const me=document.createElement("input");me.type="radio",me.name="obsidianLinkMode",me.value=p,me.checked=mi===p,me.disabled=!Ro,me.addEventListener("change",()=>{if(!me.checked)return;const Me=Xo(p);fl(Me),va()});const fe=document.createElement("span");fe.textContent=L,V.append(me,fe),Tr.push(me),Mr.appendChild(V)};Gl(Va,"Use title"),Gl(Yi,"Use id"),Ar.append(Lr,Mr,Nr),at.appendChild(Ar),ye.obsidianModeInputs=Tr;const{row:Gp,input:Kp}=Kn({id:"toggleStripParentheses",label:"Hide parentheses in names",hint:"Display item names without trailing text in parentheses.",checked:hi,className:"map-controls__toggle",onChange:p=>{const L=ei(p);Xa(L)}});at.appendChild(Gp),ye.stripParentheticalToggle=Kp;const ya=document.createElement("label");ya.className="settings-text",ya.setAttribute("for","obsidianVaultInput");const Br=document.createElement("div");Br.className="settings-text__text";const Pr=document.createElement("span");Pr.className="settings-text__label",Pr.textContent="Obsidian vault";const $r=document.createElement("span");$r.className="settings-text__hint",$r.textContent="Optional. Set the vault name to avoid duplicates.",Br.append(Pr,$r);const Jn=document.createElement("input");Jn.type="text",Jn.id="obsidianVaultInput",Jn.className="settings-text__input",Jn.placeholder="Vault name",Jn.value=Oo,Jn.addEventListener("input",()=>{const p=ti(Jn.value);hl(p),va()}),ya.append(Br,Jn),at.appendChild(ya),ye.obsidianVaultInput=Jn;const Rr=document.createElement("p");Rr.className="settings-note",Rr.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',at.appendChild(Rr);const Kl=p=>`${(p/1e3).toFixed(1)}s`,Sa=document.createElement("label");Sa.className="settings-slider",Sa.setAttribute("for","seriesNavDoubleClickWait");const Or=document.createElement("div");Or.className="settings-slider__text";const Vr=document.createElement("span");Vr.className="settings-slider__label",Vr.textContent="Series double-click wait";const Dr=document.createElement("span");Dr.className="settings-slider__hint",Dr.textContent="Time window to double-click into another map version.",Or.append(Vr,Dr);const Pi=document.createElement("span");Pi.className="settings-slider__value",Pi.textContent=Kl(Hn);const vn=document.createElement("input");vn.type="range",vn.id="seriesNavDoubleClickWait",vn.className="settings-slider__input",vn.min=String(Hs),vn.max=String(Fs),vn.step="50",vn.value=String(Hn),vn.setAttribute("aria-label","Adjust double-click wait for series navigation"),vn.addEventListener("input",()=>{const p=Zo(parseInt(vn.value,10));Pi.textContent=Kl(p),pl(p)}),Sa.append(Or,Pi,vn),at.appendChild(Sa),ye.seriesNavInput=vn,ye.seriesNavValue=Pi;const Jl=p=>`${Math.round((p-1)*100)}%`,Ea=document.createElement("label");Ea.className="settings-slider",Ea.setAttribute("for","hoverScaleSlider");const Ur=document.createElement("div");Ur.className="settings-slider__text";const Hr=document.createElement("span");Hr.className="settings-slider__label",Hr.textContent="Hover zoom";const Fr=document.createElement("span");Fr.className="settings-slider__hint",Fr.textContent="Expand tiles on hover to see more detail.",Ur.append(Hr,Fr);const $i=document.createElement("span");$i.className="settings-slider__value",$i.textContent=Jl(Mo);const yn=document.createElement("input");yn.type="range",yn.id="hoverScaleSlider",yn.className="settings-slider__input",yn.min=String(Ke),yn.max=String(lt),yn.step="0.1",yn.value=String(Mo),yn.setAttribute("aria-label","Adjust hover zoom"),yn.addEventListener("input",()=>{const p=Wo(parseFloat(yn.value));$i.textContent=Jl(p),tl(p),K&&wo()}),Ea.append(Ur,$i,yn),at.appendChild(Ea),ye.hoverScaleInput=yn,ye.hoverScaleValue=$i;let Gt=null,oo=null;const Wr=p=>{const L=Math.round((1-p)*100);return L===0?"Off":`${L}% dim`},{row:Jp,input:qp}=Kn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Un,className:"map-controls__toggle",onChange:p=>{const L=qo(p);ol(L),Gt&&(Gt.disabled=!L),oo&&(oo.textContent=Wr(L?Dn:1))}});at.appendChild(Jp),ye.selectionDimToggle=qp;const ka=document.createElement("label");ka.className="settings-slider",ka.setAttribute("for","selectionDimmingSlider");const jr=document.createElement("div");jr.className="settings-slider__text";const zr=document.createElement("span");zr.className="settings-slider__label",zr.textContent="Dimming strength";const Gr=document.createElement("span");Gr.className="settings-slider__hint",Gr.textContent="Adjust how much unrelated tiles fade when dimming is on.",jr.append(zr,Gr),oo=document.createElement("span"),oo.className="settings-slider__value",oo.textContent=Wr(Un?Dn:1),Gt=document.createElement("input"),Gt.type="range",Gt.id="selectionDimmingSlider",Gt.className="settings-slider__input",Gt.min=String(gt),Gt.max=String(Re),Gt.step="0.05",Gt.value=String(Dn),Gt.disabled=!Un,Gt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Gt.addEventListener("input",()=>{const p=jo(parseFloat(Gt.value));oo.textContent=Wr(p),nl(p)}),ka.append(jr,oo,Gt),at.appendChild(ka),ye.selectionDimInput=Gt,ye.selectionDimValue=oo;const ql=p=>p===1?"Default":`${Math.round(p*100)}%`,Ia=document.createElement("label");Ia.className="settings-slider",Ia.setAttribute("for","tileCompactnessSlider");const Kr=document.createElement("div");Kr.className="settings-slider__text";const Jr=document.createElement("span");Jr.className="settings-slider__label",Jr.textContent="Tile compactness";const qr=document.createElement("span");qr.className="settings-slider__hint",qr.textContent="Adjust padding, gap, and logo size for tiles.",Kr.append(Jr,qr);const Ri=document.createElement("span");Ri.className="settings-slider__value",Ri.textContent=ql(Bo);const Sn=document.createElement("input");Sn.type="range",Sn.id="tileCompactnessSlider",Sn.className="settings-slider__input",Sn.min=String(vs),Sn.max=String(ys),Sn.step="0.05",Sn.value=String(Bo),Sn.setAttribute("aria-label","Adjust tile compactness"),Sn.addEventListener("input",()=>{const p=zo(parseFloat(Sn.value));Ri.textContent=ql(p),al(p),K&&wo()}),Ia.append(Kr,Ri,Sn),at.appendChild(Ia),ye.tileCompactnessInput=Sn,ye.tileCompactnessValue=Ri;const{row:Yp,input:Zp}=Kn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:Da!=="nowrap",className:"map-controls__toggle",onChange:p=>{const L=p?"wrap":"nowrap";Jo(L),ll(L)}});at.appendChild(Yp),ye.titleWrapInput=Zp;const Yl=p=>`${Math.round((p-1)*100)}% extra`,Ca=document.createElement("label");Ca.className="settings-slider",Ca.setAttribute("for","titleHoverWidthSlider");const Yr=document.createElement("div");Yr.className="settings-slider__text";const Zr=document.createElement("span");Zr.className="settings-slider__label",Zr.textContent="Title width on hover";const Xr=document.createElement("span");Xr.className="settings-slider__hint",Xr.textContent="Give titles more room horizontally when zoomed.",Yr.append(Zr,Xr);const Oi=document.createElement("span");Oi.className="settings-slider__value",Oi.textContent=Yl(Po);const En=document.createElement("input");En.type="range",En.id="titleHoverWidthSlider",En.className="settings-slider__input",En.min=String(un),En.max=String(we),En.step="0.05",En.value=String(Po),En.setAttribute("aria-label","Adjust title width boost on hover"),En.addEventListener("input",()=>{const p=Go(parseFloat(En.value));Oi.textContent=Yl(p),rl(p)}),Ca.append(Yr,Oi,En),at.appendChild(Ca),ye.titleWidthInput=En,ye.titleWidthValue=Oi;const Zl=p=>`${Math.round(p*100)}% of hover zoom`,_a=document.createElement("label");_a.className="settings-slider",_a.setAttribute("for","titleZoomPortionSlider");const Qr=document.createElement("div");Qr.className="settings-slider__text";const es=document.createElement("span");es.className="settings-slider__label",es.textContent="Title zoom influence";const ts=document.createElement("span");ts.className="settings-slider__hint",ts.textContent="How much the title scales relative to tile hover zoom.",Qr.append(es,ts);const Vi=document.createElement("span");Vi.className="settings-slider__value",Vi.textContent=Zl($o);const kn=document.createElement("input");kn.type="range",kn.id="titleZoomPortionSlider",kn.className="settings-slider__input",kn.min=String(co),kn.max=String(Oa),kn.step="0.05",kn.value=String($o),kn.setAttribute("aria-label","Adjust how much titles scale on hover"),kn.addEventListener("input",()=>{const p=Ko(parseFloat(kn.value));Vi.textContent=Zl(p),sl(p)}),_a.append(Qr,Vi,kn),at.appendChild(_a),ye.titleZoomInput=kn,ye.titleZoomValue=Vi;const Xp=typeof he.isEnabled=="function"?he.isEnabled():!1,{row:Qp,input:ef}=Kn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:Xp,className:"apicurio-toggle",onChange:p=>{typeof he.setEnabled=="function"&&he.setEnabled(p)}});if(N=ef,at.appendChild(Qp),Eo.appendChild(at),T)T.hidden=!1,T.classList.remove("pf-v5-c-page__main-section"),Eo.appendChild(T);else{const p=document.createElement("p");p.className="muted",p.textContent="Source editor unavailable.",Eo.appendChild(p)}P.appendChild(Eo),he.mount(M);let Xl=0;q.m.categories.forEach(p=>{const L=document.createElement("section");L.className="category",L.dataset.cat=p.id;const V=Ce?zu(p,Q):null,me=(p.items||[]).some(Y=>vi(Y.stage)),fe=document.createElement("div");fe.className="cat-head",fe.dataset.cat=p.id,fe.tabIndex=0,Ce&&Number.isInteger(V)?(fe.dataset.seriesVersionIndex=String(V),fe.title="Open this category's map in the series",fe.classList.add("cat-head--series-link")):fe.title="Select category",fe.innerHTML=`<div class="cat-title">${_i(p.title||p.id)}</div>
                          ${me?`<span class="cat-stage-indicator" title="Contains staged items">Stage</span>
                                 <button type="button" class="cat-stage-clear" title="Clear all stages in this category" aria-label="Clear all stages">×</button>`:""}
                          <div class="muted cat-count">${(p.items||[]).length} items</div>`,fe.addEventListener("click",()=>{var Ot;const Y=fe.dataset.seriesVersionIndex!=null?parseInt(fe.dataset.seriesVersionIndex,10):null,Ue=S[g],Kt=Ue?Wn(Ue):-1;Ce&&((Ot=Ue==null?void 0:Ue.apicurioVersions)==null?void 0:Ot.length)>1&&Number.isInteger(Y)&&Y!==Kt&&pa(g,Y)||jn(p.id)}),fe.addEventListener("keydown",Y=>{(Y.key==="Enter"||Y.key===" ")&&(Y.preventDefault(),fe.click())});const Me=fe.querySelector(".cat-stage-clear");Me&&Me.addEventListener("click",Y=>{Y.preventDefault(),Y.stopPropagation(),ru(p.id)&&pn("Cleared stages for this category.",1400)}),fe.addEventListener("focus",()=>jn(p.id,{scrollIntoView:!1})),L.appendChild(fe);const Te=document.createElement("div");if(Te.className="grid"+(yt?" is-centered":""),L.appendChild(Te),(p.items||[]).forEach(Y=>{Xl+=1;const Ue=Rl(Y.external),Kt=$l(Y,{externalMeta:Ue,seriesIdLookup:Q}),Fe=document.createElement("div");if(Fe.className=Ue.isExternal?"tile external":"tile",Fe.tabIndex=0,Fe.dataset.id=Y.id,Fe.dataset.globalIndex=String(Xl),Ue.url&&(Fe.dataset.externalUrl=Ue.url),!Ce){let An=null;if(Q.has(Y.id)&&(An=Q.get(Y.id)),Number.isInteger(An)){Fe.dataset.seriesVersionIndex=String(An),Fe.classList.add("tile--series-link");const tf=An===Ve?"Current map in this series":`Open version ${An+1} in this series`;He(Fe,tf)}}Kt&&(Fe.dataset.obsidianUrl=Kt);const Ot=vi(Y.stage);if(Ot&&(Fe.dataset.stage=String(Ot),yt&&(Fe.style.gridColumn=String(Ot))),!Ce){const An=tr(Y.id);An!==-1&&An!==g&&(Fe.classList.add("tile--series-link"),Fe.dataset.navTargetIndex=String(An))}const In=document.createElement("img");In.className="logo",Y.logo?(In.src=Y.logo,In.alt=Y.name||Y.id):(In.alt="",In.style.opacity=1,In.src=Wu(Y.name||Y.id,Y.color));const Io=document.createElement("div");Io.className="name",Io.textContent=ki(Y);const Co=document.createElement("div");Co.className="tile-id",Co.textContent=Y.id||"";let Di=null;Ot&&(Di=document.createElement("div"),Di.className="tile-stage",Di.textContent=String(Ot));const ns=document.createElement("div");ns.className="badge",ns.textContent="reused";let io=null;Ce||(io=document.createElement("button"),io.type="button",io.className="tile-delete",io.setAttribute("aria-label",`Delete ${Y.name||Y.id}`),io.textContent="×",io.addEventListener("click",An=>{An.stopPropagation(),yp(Y.id)})),Ue.url&&Fe.appendChild(tp(Ue.url)),Ol(Fe,Kt),io&&Fe.appendChild(io),Fe.appendChild(In),Fe.appendChild(Io),Fe.appendChild(Co),Di&&Fe.appendChild(Di),Fe.appendChild(ns),Te.appendChild(Fe),xe.set(Y.id,{el:Fe,catId:p.id,rect:null})}),fn.appendChild(L),It.set(p.id,{el:L,headEl:fe}),!Ce){const Y=document.createElement("button");Y.type="button",Y.className="tile-add",Y.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',Y.hidden=yt,Y.tabIndex=yt?-1:0,Y.setAttribute("aria-hidden",yt?"true":"false"),Y.addEventListener("click",()=>lp(p.id)),Te.appendChild(Y)}});let Pn=null;Ce||(Pn=document.createElement("button"),Pn.type="button",Pn.className="category-add",Pn.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',Pn.addEventListener("click",()=>Dl()),fn.appendChild(Pn)),Pn&&yt&&(Pn.hidden=!0,Pn.tabIndex=-1,Pn.setAttribute("aria-hidden","true")),Gs(),ur(),qu(),fa(),Tn(),ai(),ap()}function qu(){C.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var M;if(typeof n.button=="number"&&n.button!==0)return;bo();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,l=S[g],u=l?Wn(l):-1,h=((M=l==null?void 0:l.apicurioVersions)==null?void 0:M.length)>1&&Number.isInteger(i)&&i!==u,m=Number.isInteger(s)&&s!==g&&s>=0&&s<S.length,y=nn&&nn.id===o&&nn.targetVersionIndex===i,P=Jt&&Jt.id===o&&Jt.targetIndex===s;if(nn&&!y&&ii(),Jt&&!P&&ar(),h)if(y){if(ii(),pa(g,i))return}else Cu(o,i,l);else if(m){if(P){ar(),Dt(s);return}_u(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&pn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),K===o&&!(h&&y)&&!(m&&P)){ri();return}Lt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):tr(o);i!==-1&&i!==g&&Dt(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{K&&wo()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),El||(El=!0,window.addEventListener("resize",wo),window.addEventListener("blockscape:zoom",wo),window.addEventListener("scroll",wo,{passive:!0}),window.addEventListener("resize",Vl),document.addEventListener("click",e=>{var a,s,l;if(!K&&!A||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),o=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),i=(l=t==null?void 0:t.closest)==null?void 0:l.call(t,".tile-context-menu");n||o||i||ri()})),document.getElementById("clear").onclick=()=>ri()}function fa(){xe.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function Nl(e,{includeSecondary:t=cn}={}){if(!e||!q)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(q.fwd.get(e)||[]),o=new Set(q.rev.get(e)||[]),i=new Set,a=new Set,s=[],l=new Set,u=(h,m,y,P)=>{if(!h||!m)return;const M=`${h}->${m}:${y}:${P}`;l.has(M)||(l.add(M),s.push({from:h,to:m,type:y,depth:P}))};return n.forEach(h=>u(e,h,"dep",1)),o.forEach(h=>u(e,h,"revdep",1)),t&&new Set([...n,...o]).forEach(m=>{(q.fwd.get(m)||new Set).forEach(M=>{const $=M===e;$||i.add(M),$||u(m,M,"dep",2)}),(q.rev.get(m)||new Set).forEach(M=>{const $=M===e;$||a.add(M),$||u(m,M,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function ma(e,t){const n=xe.get(e);n&&n.el.classList.add(t)}function Lt(e){var l,u,h;if(!e)return;A=null,K=e,Je=null,mt=Nl(e),Zt(),ha(),ai();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=mt;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=xe.get(e);a&&a.el.classList.add("selected"),t.forEach(m=>ma(m,"dep")),n.forEach(m=>ma(m,"revdep")),o.forEach(m=>{!t.has(m)&&m!==e&&ma(m,"dep-indirect")}),i.forEach(m=>{!n.has(m)&&!t.has(m)&&m!==e&&ma(m,"revdep-indirect")}),Tn();const s=(h=(u=(l=xe.get(e))==null?void 0:l.el)==null?void 0:u.dataset)==null?void 0:h.externalUrl;s&&pn("This item has link to",Nn,s),qa()}function jn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,l;if(!((s=q==null?void 0:q.m)!=null&&s.categories)||!e)return!1;const i=(q.m.categories||[]).find(u=>u.id===e);if(!i)return!1;bo(),dr(),n||(Je=null),A=i.id,Zt(),ai();const a=It.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(l=a.headEl)==null||l.focus({preventScroll:!0})),!0}function ai(){if(It.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!A)return;const e=It.get(A);if(!(e!=null&&e.el)){A=null,Je=null,Zt();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function Ci(){if(A)return A;const e=K?xe.get(K):null;return e!=null&&e.catId?e.catId:null}function Yu(e){var a,s,l,u;if(!((s=(a=q==null?void 0:q.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=q.m.categories,n=Ci();let o=t.findIndex(h=>h.id===n);if(o===-1){const h=((l=t.find(m=>(m.items||[]).length))==null?void 0:l.id)||((u=t[0])==null?void 0:u.id);return h?jn(h):!1}const i=o+e;return i<0||i>=t.length?!1:jn(t[i].id)}function dr(){K=null,mt=null,ha(),Tn(),qa({itemId:null})}function Zu(){A=null,Je=null,ai()}function ri(){dr(),Zu(),Je=null,Zt()}function ha(){C.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function ur(){q!=null&&q.reusedLocal&&q.reusedLocal.forEach(e=>{const t=xe.get(e);if(!t)return;t.el.classList.toggle("reused",en);const n=t.el.querySelector(".badge");n&&(n.style.display=en?"inline-block":"none")})}function Tn(){for(;G.firstChild;)G.removeChild(G.firstChild);if(!K||G.hidden)return;mt=Nl(K);const e=mt,{primary:t,secondary:n}=rd();e.edges.forEach(o=>{var O,Q;const i=(O=xe.get(o.from))==null?void 0:O.rect,a=(Q=xe.get(o.to))==null?void 0:Q.rect;if(!i||!a)return;const s=Ml(i),l=Ml(a),u=Pl(Bl(i,l)||s,i,Vs)||s,h=Pl(Bl(a,s)||l,a,Vs)||l,m=document.createElementNS("http://www.w3.org/2000/svg","path"),y=(u.x+h.x)/2,P=u.y,M=(u.x+h.x)/2,$=h.y;m.setAttribute("d",`M ${u.x},${u.y} C ${y},${P} ${M},${$} ${h.x},${h.y}`),m.setAttribute("fill","none"),m.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),m.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),m.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&m.setAttribute("stroke-dasharray","4 3"),m.setAttribute("vector-effect","non-scaling-stroke"),G.appendChild(m)})}function Ml(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Bl(e,t){if(!e||!t)return null;const n=e.left+e.width/2,o=e.top+e.height/2,i=t.x-n,a=t.y-o;if(i===0&&a===0)return{x:n,y:o};const s=e.width/2,l=e.height/2,u=[];i!==0&&u.push((i>0?s:-s)/i),a!==0&&u.push((a>0?l:-l)/a);const h=Math.min(...u.filter(y=>y>0)),m=Number.isFinite(h)?h:0;return{x:n+i*m,y:o+a*m}}function Pl(e,t,n=0){if(!e||!t||n<=0)return e;const o=t.left+t.width/2,i=t.top+t.height/2,a=o-e.x,s=i-e.y,l=Math.hypot(a,s);if(!l)return e;const u=Math.min(n,l/2)/l;return{x:e.x+a*u,y:e.y+s*u}}function _i(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Xu(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),Oo&&o.set("vault",Oo),`obsidian://advanced-uri?${o.toString()}`}function Qu(e){return e?mi===Yi?e.id??e.name??"":e.name??e.id??"":""}function $l(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!Ro||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=Qu(e);return Xu(o)}function Rl(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function ep(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),ui(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function tp(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),ui(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Ol(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(ep(t))}function Vl(){te||(te=requestAnimationFrame(()=>{te=null,U=U.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),U.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function np(e,t){!e||!t||(U.push({labelEl:e,textEl:t}),Vl())}function op(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${_i(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${_i(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function xi(e,t,{offset:n=8}={}){!oe||!e||!t||(oe.innerHTML=t,oe.hidden=!1,oe.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=oe.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let l=o.left+o.width/2-i.width/2+a,u=o.top-i.height-n+s;l<a+n&&(l=a+n);const h=a+window.innerWidth-i.width-n;l>h&&(l=h),u<s+n&&(u=o.bottom+n+s),oe.style.left=`${l}px`,oe.style.top=`${u}px`,oe.classList.add("is-visible")}))}function zn(){Vn&&(clearTimeout(Vn),Vn=null),oe&&(oe.classList.remove("is-visible"),oe.setAttribute("aria-hidden","true"),oe.hidden=!0)}function ip(e,t){if(!e)return;const n=qe((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=op(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{E=e,xi(e,`<div class="version-nav__tooltip-title">${_i(n)}</div>`,{offset:10})},l=()=>{a(),i=setTimeout(()=>{E===e&&xi(e,o,{offset:10})},Le)},u=()=>{s(),l()},h=()=>{E!==e&&s(),l()},m=()=>{a(),E===e&&(E=null,zn())};e.addEventListener("mouseenter",u),e.addEventListener("focus",u),e.addEventListener("pointermove",h),e.addEventListener("mouseleave",m),e.addEventListener("blur",m),e.addEventListener("click",m)}function ap(){d&&(d=!1,!(!an||!xn)&&(zn(),xi(an,xn,{offset:12}),Vn=setTimeout(()=>{zn(),rp()},1e3)))}function rp(){an&&(v&&(clearTimeout(v),v=null),an.classList.add("blockscape-tab--twinkle"),v=setTimeout(()=>{an.classList.remove("blockscape-tab--twinkle"),v=null},1400))}window.addEventListener("scroll",zn,!0),window.addEventListener("resize",zn),de&&de.addEventListener("click",()=>{Au()}),Ae&&Ae.addEventListener("click",()=>{Lu()}),_e&&_e.addEventListener("click",()=>{try{ku(),wu()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),be&&be.addEventListener("click",rr),ht&&ht.addEventListener("click",rr),ae&&ae.addEventListener("click",da),x&&x.addEventListener("click",da),C&&C.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");On||!t||!C.contains(t)||pu(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||fu(e)}),je&&je.addEventListener("click",()=>{yl("button")}),z&&z.addEventListener("click",()=>{if(g<0){alert("Load or select a model before creating a version.");return}try{const e=vl({versionLabel:"map edit"});Dt(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),ze&&ze.addEventListener("click",async()=>{var a;if(g<0||!S[g]){alert("Select or load a model before sharing.");return}const e={title:qe(S[g],"Shared Model"),data:S[g].data};let t;try{t=Yc(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),document.addEventListener("keydown",e=>{var o,i,a,s,l,u,h,m,y,P;if(Tu()){e.key==="Escape"&&(e.preventDefault(),rr());return}if(!(R!=null&&R.hidden)&&e.key==="Escape"){e.preventDefault(),da();return}if((o=go==null?void 0:go.isOpen)==null?void 0:o.call(go))return;const n=On;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const M=S[g],$=((i=M==null?void 0:M.apicurioVersions)==null?void 0:i.length)>1;yl("shortcut",$);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!vo())return;if(gp()){e.preventDefault();return}}if(e.key==="Escape"){let M=!1;ee&&!ee.hidden&&(bo(),M=!0),(K||A)&&(ri(),M=!0),M&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!vo())return;const M=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if(yt&&e.shiftKey&&K&&!e.ctrlKey&&!e.metaKey&&su(K,M)){e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&!e.shiftKey){cr(M)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(A&&!e.shiftKey){e.preventDefault();return}e.shiftKey?dp(M)&&e.preventDefault():up(M)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!vo())return;const M=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){hp(M)&&e.preventDefault();return}if(e.altKey)return;if(A&&!K&&!e.shiftKey){if(fp(M)){e.preventDefault();return}if(Yu(M)){e.preventDefault();return}}e.shiftKey?mp(M)&&e.preventDefault():pp(M)&&e.preventDefault()}if(e.key==="Delete"){if(n||!vo()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const M=A?vp():!1,$=M?!0:Ul();(M||$)&&e.preventDefault()}if(e.key==="F2"){if(n||!vo())return;const M=A&&!K&&A||!K&&((u=(l=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:l.dataset)==null?void 0:u.cat)||null;if(M&&!K&&cp(M)){e.preventDefault();return}const $=K||((P=(y=(m=(h=e.target)==null?void 0:h.closest)==null?void 0:m.call(h,".tile"))==null?void 0:y.dataset)==null?void 0:P.id);$&&go.open($)&&e.preventDefault()}if(e.key==="Insert"){if(n||!vo()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Dl()&&e.preventDefault()}}),window.addEventListener("resize",()=>{mu()}),window.addEventListener("scroll",()=>hu(),!0);function sp(e,t,n){if(g<0)return;const i=S[g].data.categories||[],a=i.find(m=>(m.items||[]).some(y=>y.id===e)),s=i.find(m=>m.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const l=a.items.findIndex(m=>m.id===e);if(l===-1)return;const[u]=a.items.splice(l,1);let h=s.items.length;if(t){const m=s.items.findIndex(y=>y.id===t);m!==-1&&(h=m)}s.items.splice(h,0,u),At(),xt()}function lp(e){if(g<0||!e)return;const t=S[g].data,o=(t.categories||[]).find(u=>u.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:lu(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),At(),xt(),bo(),Lt(s.id);const l=xe.get(s.id);l!=null&&l.el&&l.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Dl(){if(g<0)return!1;const e=S[g].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=cu(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),A=n,K=null,mt=null,Je=null,At(),xt(),jn(n),console.log("[Blockscape] added category",n),!0}function cp(e=Ci()){if(g<0||!e)return!1;const t=uu.open(e);return t&&(K=null,mt=null,Zt()),t}function dp(e){if(!K||g<0||!e)return!1;const n=S[g].data.categories||[],o=xe.get(K);let i=null;if(o!=null&&o.catId&&(i=n.find(u=>u.id===o.catId)),i||(i=n.find(u=>(u.items||[]).some(h=>h.id===K))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(u=>u.id===K);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[l]=i.items.splice(a,1);return i.items.splice(s,0,l),At(),xt(),Ii(),Lt(K),!0}function up(e){if(!q||!q.m||!e)return!1;const t=q.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(h=>(h.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!K){const u=n();return u?(Lt(u.item.id),!0):!1}const o=xe.get(K);let i=null;if(o!=null&&o.catId&&(i=t.find(u=>u.id===o.catId)),i||(i=t.find(u=>(u.items||[]).some(h=>h.id===K))),!i){const u=n();return u?(Lt(u.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(u=>u.id===K);if(s===-1)return!1;const l=s+e;return l<0||l>=a.length?!1:(Lt(a[l].id),!0)}function pp(e){if(!q||!q.m||!e)return!1;const t=q.m.categories||[];if(!t.length)return!1;const n=Ci();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(K){const l=(t[o].items||[]).findIndex(u=>u.id===K);Je={catId:a.id,position:l===-1?0:l}}else Je=null;return jn(a.id,{preserveEntryHint:!0})}function fp(e){var a;if(!A||!((a=q==null?void 0:q.m)!=null&&a.categories)||!e)return!1;const n=(q.m.categories||[]).find(s=>s.id===A);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(Je==null?void 0:Je.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,Je.position||0))),Je=null,Lt(o[i].id),!0}function mp(e){if(!K||g<0||!e)return!1;const n=S[g].data.categories||[];if(!n.length)return!1;const o=xe.get(K);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(y=>y.id===o.catId)),i===-1&&(i=n.findIndex(y=>(y.items||[]).some(P=>P.id===K))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],l=n[a];if(!l)return!1;s.items=s.items||[],l.items=l.items||[];const u=s.items.findIndex(y=>y.id===K);if(u===-1)return!1;const h=Math.min(l.items.length,Math.max(0,u)),m=h<l.items.length?l.items[h].id:null;return sp(K,m,l.id),Ii(),Lt(K),!0}function hp(e){if(g<0||!e)return!1;const n=S[g].data.categories||[];if(!n.length)return!1;const o=Ci();if(!o)return!1;const i=n.findIndex(l=>l.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),A=s.id,dr(),Je=null,Zt(),At(),xt(),ai(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function gp(){if(g<0)return!1;const e=S[g],t=St(e)||(e?e.id:null),n=[];if(wt&&t===wt.modelId&&n.push({...wt,type:"item"}),tn&&t===tn.modelId&&n.push({...tn,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(wp(o))return!0}else if(o.type==="item"&&bp(o))return!0;return!1}function bp(e){const t=S[g],n=St(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(l=>l.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),wt=null,bo(),K=null,mt=null,Zt(),At(),xt(),Ii(),Lt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function wp(e){const t=S[g],n=St(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),tn=null,K=null,mt=null,A=e.category.id,Je=null,Zt(),At(),xt(),ai(),jn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function Ul(){if(!K||g<0)return!1;const t=S[g].data.categories||[];if(!t.length)return!1;const n=xe.get(K);let o=null;if(n!=null&&n.catId&&(o=t.find(h=>h.id===n.catId)),o||(o=t.find(h=>(h.items||[]).some(m=>m.id===K))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(h=>h.id===K);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=S[g];wt={item:a,categoryId:o.id,index:i,modelId:St(s)||(s?s.id:null),ts:Date.now()};const u=(()=>{var m;if(o.items.length){const y=Math.min(i,o.items.length-1);return((m=o.items[y])==null?void 0:m.id)||null}const h=t.findIndex(y=>y.id===o.id);if(h===-1)return null;for(let y=h+1;y<t.length;y++){const P=t[y].items||[];if(P.length)return P[0].id}for(let y=h-1;y>=0;y--){const P=t[y].items||[];if(P.length)return P[0].id}return null})();return bo(),K=null,mt=null,Je=null,Zt(),At(),xt(),Ii(),u?Lt(u):ri(),console.log("[Blockscape] removed item",a.id),!0}function vp(){var l,u;const e=Ci();if(!e||g<0)return!1;const n=S[g].data.categories||[];if(!n.length)return!1;const o=n.findIndex(h=>h.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=S[g];tn={category:i,index:o,modelId:St(a)||(a?a.id:null),ts:Date.now()},A=null,K=null,mt=null,Je=null,Zt(),At(),xt();const s=((l=n[o])==null?void 0:l.id)||((u=n[o-1])==null?void 0:u.id)||null;return s?jn(s):ri(),console.log("[Blockscape] removed category",i.id),!0}function yp(e){if(!e)return!1;const t=K;K=e;const n=Ul();return n||(K=t,Zt()),n}H&&H.addEventListener("click",async()=>{const e=f.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await el(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),ie&&ie.addEventListener("click",async()=>{const e=vu();if(!e){alert("No series available to copy. Create another version first.");return}await el(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),D&&D.addEventListener("click",async()=>{try{const e=await yd();if(!e){alert("Clipboard is empty.");return}f.value=e,f.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await Ei(),t=eo(f.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=Fn(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),g===-1&&n!=null?Dt(n):Bn(),e&&await Hl(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(g<0){alert("No active model selected.");return}try{const t=JSON.parse(f.value);if(Mn(t,{titleHint:qe(S[g]),idHint:St(S[g])||qe(S[g])}),S[g].data=t,S[g].title=t.title||S[g].title,S[g].isSeries||((e=S[g].apicurioVersions)==null?void 0:e.length)>1){const n=S[g].title||qe(S[g]);Ft(S[g],{seriesName:n,fallbackTitle:n})}nr(),console.log("[Blockscape] replaced active model:",qe(S[g])),xt(),he.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=eo(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((l,u)=>{var O;const h=(((O=l.data)==null?void 0:O.title)??"").toString().trim(),m=s.length>1?`${o.name} #${u+1}`:o.name,y=`${a} series`,P=l.isSeries?y:null;let M={...l};if(l.isSeries){const Q=P||h||l.title||m||"unknown";M.title=Q;const Ve=Cn(Q||"unknown");ho(M,Ve),Ft(M,{seriesName:Q,fallbackTitle:"unknown"}),M.apicurioArtifactName=M.apicurioArtifactName||Q}else M.title=h||m;const $=Fn({...M,apicurioArtifactName:M.apicurioArtifactName||P||M.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=$)})}g===-1&&n!=null?Dt(n):Bn()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",Sp);async function Sp(e){var a;if(!vo())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Vu(t))return;let n=[];try{const s=await Ei();n=eo(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,l)=>{const u=Fn(s,{versionLabel:n.length>1?`paste #${l+1}`:"paste"});o==null&&(o=u),i.push(u)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&Dt(o),await Ei()&&await Hl(i,{origin:"clipboard"})}async function Hl(e,{origin:t="clipboard"}={}){if(!await Ei()||typeof(tt==null?void 0:tt.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter(P=>{const M=S[P];return M&&!M.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=S[o[0]],s=Cd(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const l=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(l==null)return;const u=mo(l);if(!u){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const h=await kd(),m=[];for(let P=0;P<o.length;P++){const M=o.length===1?u:Ed(u,P+1),$=Id(M,h);if(!$){alert("Could not find a unique filename to save.");return}h.add($),m.push($)}let y=null;for(let P=0;P<o.length;P++){const M=o[P],$=m[P],O=S[M];if(!O)continue;o.length===1&&_d(O,$);const Q=await tt.saveModelByIndex(M,$,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(Q!=null&&Q.ok)){alert(`Local auto-save failed: ${(Q==null?void 0:Q.error)||"unknown error"}`);return}y==null&&(y=$)}y&&(aa(y),ud(y,{origin:t})),await tt.refresh(),Bn(),pn(`Saved ${o.length} ${i}.`,2500)}Z.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&Dt(n)}),document.getElementById("removeModel").onclick=()=>{if(g<0)return;const e=qe(S[g]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",qe(S[g])),S.splice(g,1),!S.length){g=-1,q=null,C.innerHTML="",G.innerHTML="",f.value="",Bn(),nr();return}const n=Math.min(g,S.length-1);Dt(n)},J&&(J.addEventListener("input",e=>{lr(e.target.value||"")}),J.addEventListener("focus",()=>{J.value&&J.value.trim()&&Il(J.value)})),Se&&Se.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;Bu({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!Se||Se.hidden)return;const t=e.target;Se.contains(t)||J&&(t===J||J.contains(t))||(Se.hidden=!0)}),document.addEventListener("click",e=>{var o,i,a;const t=(i=(o=e.target)==null?void 0:o.closest)==null?void 0:i.call(o,"a[href]");if(!t||(a=t.classList)!=null&&a.contains("blockscape-gist-link")||t.hasAttribute("download"))return;const n=t.getAttribute("href");kc(n)&&(e.preventDefault(),e.stopPropagation(),ui(Ic(n)))}),_&&pe&&j&&_.addEventListener("submit",async e=>{e.preventDefault();const t=pe.value.trim();if(!t){alert("Please enter a URL"),pe.focus();return}const n=await pr(t);if(typeof n=="number"){Dt(n),pe.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!pe||!t)return;let n=null;pe.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=pe.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function xt(){if(!(g<0))try{ua(S[g]),q=Fu(S[g].data),Ii()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Ep(){const e=["models.bs"],t=n=>qi?qi.endsWith("/")?`${qi}${n}`:`${qi}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=eo(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(l=>{let u={...l};if(l.isSeries){const h=`${a} series`;u={...l,title:h,apicurioArtifactName:h};const m=Cn(h||"unknown");ho(u,m),Ft(u,{seriesName:h,fallbackTitle:"unknown"})}Fn(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}Bn()}async function Fl(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function kp(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>Ip(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");jl(i)&&Wl(o,i)})}function Ip(e){var l,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(l=e.parentNode)==null?void 0:l.closest)!=null&&u.call(l,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:h,index:m})=>{m>s&&a.appendChild(document.createTextNode(t.slice(s,m))),a.appendChild(Cp(h)),s=m+h.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function Cp(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",jl(e)&&Wl(t,e),t}function Wl(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>_p(n,t,e)))}async function _p(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await pr(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function jl(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.github.com"||n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}function xp(e){if(!e)return null;const t=e.toString().trim();if(!t)return null;try{const n=new URL(t,window.location.href);if(n.hostname==="gist.github.com"){const o=Ap(n);if(o)return o.toString()}if(n.hostname==="gist.githubusercontent.com"){const o=Tp(n);if(o)return o.toString()}return n.toString()}catch{return t}}function Tp(e){try{const t=new URL(e.toString()),n=t.pathname.split("/").filter(Boolean);if(n.includes("raw"))return t;if(n.length>=2){const[o,i,...a]=n,s=a.join("/");return t.pathname=`/${o}/${i}/raw${s?`/${s}`:""}`,t}return t}catch{return null}}function Ap(e){try{const t=e.pathname.split("/").filter(Boolean);if(t.length<2)return e;const[n,o,...i]=t,a=i.find(h=>h.includes("."));let s=null;e.hash&&e.hash.startsWith("#file-")&&(s=e.hash.replace(/^#file-/,"").replace(/-/g,"."));const l=a||s||"";return new URL(`https://gist.githubusercontent.com/${n}/${o}/raw/${l}`)}catch{return e}}async function pr(e){try{const t=xp(e);console.log("[Blockscape] loading from URL:",{requested:e,resolved:t});const n=await Fl(t),i=((t||e||"").split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let a;try{a=eo(n,i)}catch(l){throw new Error(`Invalid JSON payload: ${l.message}`)}if(!a.length)throw new Error("No JSON objects found in response.");let s=null;return a.forEach((l,u)=>{var $;const h=((($=l.data)==null?void 0:$.title)??"").toString().trim(),m=a.length>1?`${i} #${u+1}`:i,y=l.isSeries?`${i} series`:null;let P={...l};if(l.isSeries){const O=y||h||P.title||m;P={...l,title:O,apicurioArtifactName:O||l.apicurioArtifactName};const Q=Cn(O||"unknown");ho(P,Q),Ft(P,{seriesName:O||y||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:Q,url:e,baseName:i,seriesTitle:O})}const M=Fn({...P,title:h||P.title||m,apicurioArtifactName:P.apicurioArtifactName||y||l.apicurioArtifactName},{versionLabel:i});s==null&&(s=M)}),console.log(`[Blockscape] loaded ${a.length} model(s) from URL:`,i),g===-1&&s!=null?Dt(s):Bn(),s}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=eo(n,"Blockscape");if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(y=>{const P=Fn(y,{versionLabel:"seed"});i==null&&(i=P)}),await Qc(),!await Ws&&c.autoLoadFromDir&&await Ep();const s=await Uu(),l=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,u=await Hu(),h=Du(),m=typeof l=="number"?l:typeof u=="number"?u:typeof h=="number"?h:i??0;Dt(m),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===m&&requestAnimationFrame(()=>{var P;if(g!==s.modelIndex)return;const y=(P=xe.get(s.itemId))==null?void 0:P.el;y&&(Lt(s.itemId),y.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),y.focus({preventScroll:!0}))})})()}const Lc=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function Nc(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function Mc(r){return Lc(Nc())}const Bc=`${Mc()}documentation/`;function Pc(r){let c;return{c(){c=W("div"),c.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Watch the <a href="https://youtube.com/playlist?list=PLZIp4-s83kaPj5m9VcGXTBhjaquc9fT15&amp;si=aaeXo5ga0D7Vb5LN">videos</a></li> <li>Open the <a href="${Bc}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,b(c,"id","shortcutHelp"),b(c,"class","shortcut-help"),c.hidden=!0,b(c,"aria-hidden","true"),b(c,"role","dialog"),b(c,"aria-modal","true"),b(c,"aria-labelledby","shortcutHelpTitle")},m(f,T){Mt(f,c,T)},p:Vt,i:Vt,o:Vt,d(f){f&&kt(c)}}}class $c extends Ki{constructor(c){super(),Gi(this,c,null,Pc,Ui,{})}}const Rc=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
        * optional \`stage\`: integer 1–4 for Wardley maps only (1=genesis, 2=custom, 3=product, 4=commodity/service). Include only when the user explicitly asks for a Wardley model/series.
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping. Only include the \`stage\` field when explicitly asked for a Wardley map/series.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function hs(r){let c,f,T,C,G,oe,Z,ee;return{c(){c=W("div"),f=W("div"),T=W("a"),C=Hi("Open Blockscape GPT"),G=le(),oe=W("div"),oe.textContent="Paste the copied prompt into that chat.",Z=le(),ee=W("div"),ee.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',b(T,"href",Vc),b(T,"target","_blank"),b(T,"rel","noreferrer"),b(oe,"class","new-panel__hint"),b(f,"class","new-panel__link"),b(ee,"class","new-panel__link new-panel__link--disabled"),b(c,"class","new-panel__links")},m(_,pe){Mt(_,c,pe),k(c,f),k(f,T),k(T,C),k(f,G),k(f,oe),k(c,Z),k(c,ee)},p:Vt,d(_){_&&kt(c)}}}function gs(r){let c,f,T,C,G,oe;return{c(){c=W("div"),f=W("div"),f.textContent="Generated prompt",T=le(),C=W("textarea"),b(f,"class","new-panel__prompt-label"),b(C,"class","pf-v5-c-form-control new-panel__textarea"),b(C,"rows","4"),C.readOnly=!0,b(c,"class","new-panel__prompt")},m(Z,ee){Mt(Z,c,ee),k(c,f),k(c,T),k(c,C),so(C,r[4]),G||(oe=Ln(C,"input",r[12]),G=!0)},p(Z,ee){ee&16&&so(C,Z[4])},d(Z){Z&&kt(c),G=!1,oe()}}}function Oc(r){let c,f,T,C,G,oe,Z,ee,_,pe,j,ce,ge,rt,We,je,ze,z,H,ie,D,de,Ae,_e,Be,$e,be,ht,R,ae,x,J,Se,ue,Qe,re,Ye,ft,st,pt,w,et,Bt,Ie,bt,Pt,S,g=r[2]==="gpt"&&hs(),he=r[4]&&r[5]&&gs(r);return bt=ic(r[10][0]),{c(){c=W("div"),f=W("div"),T=le(),C=W("div"),G=W("div"),G.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',oe=le(),Z=W("form"),ee=W("div"),_=W("label"),_.textContent="Domain",pe=le(),j=W("p"),j.textContent="Describe what you want to create a map for.",ce=le(),ge=W("textarea"),rt=le(),We=W("div"),je=W("label"),ze=W("input"),z=le(),H=W("span"),H.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,ie=le(),D=W("fieldset"),de=W("legend"),de.textContent="Target",Ae=le(),_e=W("p"),_e.textContent="Choose where you plan to use the prompt.",Be=le(),$e=W("label"),be=W("input"),ht=le(),R=W("div"),R.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',ae=le(),x=W("label"),J=W("input"),Se=le(),ue=W("div"),ue.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',Qe=le(),re=W("div"),Ye=W("button"),Ye.textContent="Copy prompt",ft=le(),st=W("button"),st.textContent="New blank",pt=le(),w=W("div"),et=Hi(r[3]),Bt=le(),g&&g.c(),Ie=le(),he&&he.c(),b(f,"id","newPanelBackdrop"),b(f,"class","shortcut-help__backdrop"),b(G,"class","shortcut-help__header"),b(_,"for","newDomain"),b(j,"class","new-panel__hint"),b(ge,"id","newDomain"),b(ge,"class","pf-v5-c-form-control new-panel__textarea"),b(ge,"rows","4"),ge.required=!0,b(ge,"placeholder","Ex: Companies building open-source geospatial tools"),b(ee,"class","new-panel__field"),b(ze,"id","seriesToggle"),b(ze,"type","checkbox"),b(je,"class","new-panel__toggle"),b(je,"for","seriesToggle"),b(We,"class","new-panel__field"),b(_e,"class","new-panel__hint"),b(be,"type","radio"),b(be,"name","target"),be.__value="gpt",so(be,be.__value),b($e,"class","new-panel__option"),b(J,"type","radio"),b(J,"name","target"),J.__value="plain",so(J,J.__value),b(x,"class","new-panel__option"),b(D,"class","new-panel__field"),b(Ye,"class","pf-v5-c-button pf-m-primary"),b(Ye,"type","submit"),b(st,"id","newBlankButton"),b(st,"class","pf-v5-c-button pf-m-secondary"),b(st,"type","button"),b(st,"title","Start from an empty map"),b(w,"class","new-panel__status"),b(w,"aria-live","polite"),b(re,"class","new-panel__actions"),b(Z,"class","shortcut-help__list new-panel__form"),b(C,"class","shortcut-help__panel"),b(C,"tabindex","-1"),b(c,"id","newPanel"),b(c,"class","shortcut-help"),c.hidden=!0,b(c,"aria-hidden","true"),b(c,"role","dialog"),b(c,"aria-modal","true"),b(c,"aria-labelledby","newPanelTitle"),bt.p(be,J)},m(q,xe){Mt(q,c,xe),k(c,f),k(c,T),k(c,C),k(C,G),k(C,oe),k(C,Z),k(Z,ee),k(ee,_),k(ee,pe),k(ee,j),k(ee,ce),k(ee,ge),so(ge,r[0]),k(Z,rt),k(Z,We),k(We,je),k(je,ze),ze.checked=r[1],k(je,z),k(je,H),k(Z,ie),k(Z,D),k(D,de),k(D,Ae),k(D,_e),k(D,Be),k(D,$e),k($e,be),be.checked=be.__value===r[2],k($e,ht),k($e,R),k(D,ae),k(D,x),k(x,J),J.checked=J.__value===r[2],k(x,Se),k(x,ue),k(Z,Qe),k(Z,re),k(re,Ye),k(re,ft),k(re,st),k(re,pt),k(re,w),k(w,et),k(Z,Bt),g&&g.m(Z,null),k(Z,Ie),he&&he.m(Z,null),Pt||(S=[Ln(ge,"input",r[7]),Ln(ze,"change",r[8]),Ln(be,"change",r[9]),Ln(J,"change",r[11]),Ln(Z,"submit",oc(r[6]))],Pt=!0)},p(q,[xe]){xe&1&&so(ge,q[0]),xe&2&&(ze.checked=q[1]),xe&4&&(be.checked=be.__value===q[2]),xe&4&&(J.checked=J.__value===q[2]),xe&8&&rs(et,q[3]),q[2]==="gpt"?g?g.p(q,xe):(g=hs(),g.c(),g.m(Z,Ie)):g&&(g.d(1),g=null),q[4]&&q[5]?he?he.p(q,xe):(he=gs(q),he.c(),he.m(Z,null)):he&&(he.d(1),he=null)},i:Vt,o:Vt,d(q){q&&kt(c),g&&g.d(),he&&he.d(),bt.r(),Pt=!1,_o(S)}}}const Vc="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function Dc(r,c,f){let T="",C=!1,G="gpt",oe="",Z="",ee=!1;const _=()=>{var z;return typeof navigator<"u"&&!!((z=navigator.clipboard)!=null&&z.writeText)};function pe(z){const H=z||"[DOMAIN]",ie=C?"series":"map",de=Rc.replaceAll("[DOMAIN NAME]",H).replaceAll("[DOMAIN]",H).replaceAll("[map|series]",ie).split(`
`),Ae=`Generate a **blockscape ${ie}** for the domain of ${H}.`,_e=de.findIndex($e=>$e.toLowerCase().includes("generate a **blockscape value")||$e.toLowerCase().includes("generate a blockscape [map|series]")||$e.toLowerCase().startsWith("generate a blockscape"));_e>=0?de[_e]=Ae:de.unshift(Ae);const Be=C?`

User requested a series (return an array of models).`:"";return`${de.join(`
`).trim()}${Be}`}async function j(z){z.preventDefault();const H=T.trim();if(f(3,oe=""),f(5,ee=G!=="gpt"),!H){f(3,oe="Add a domain to generate a prompt."),f(4,Z="");return}if(G==="gpt"?f(4,Z=`${C?"Create a series":"Create a map"} for ${H}`):(f(4,Z=pe(H)),f(5,ee=!0)),!_()){f(3,oe="Clipboard access is unavailable. Copy the prompt below."),f(5,ee=!0);return}try{await navigator.clipboard.writeText(Z),f(3,oe=G==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),G==="gpt"&&f(5,ee=!1)}catch(D){console.warn("[Blockscape] clipboard write failed",D),f(3,oe="Copy failed. Use the prompt below."),f(5,ee=!0)}}const ce=[[]];function ge(){T=this.value,f(0,T)}function rt(){C=this.checked,f(1,C)}function We(){G=this.__value,f(2,G)}function je(){G=this.__value,f(2,G)}function ze(){Z=this.value,f(4,Z)}return[T,C,G,oe,Z,ee,j,ge,rt,We,ce,je,ze]}class Uc extends Ki{constructor(c){super(),Gi(this,c,Dc,Oc,Ui,{})}}const{document:bs}=nc;function Hc(r){let c,f,T,C,G,oe,Z,ee,_,pe,j,ce,ge,rt,We,je,ze,z,H,ie,D,de,Ae,_e,Be,$e,be,ht,R,ae,x,J,Se,ue,Qe,re,Ye,ft,st,pt,w,et,Bt,Ie,bt,Pt,S,g,he,q,xe,It,K,A,mt,Je,cn,On,en,Xn,wt,tn,lo,_n,Nn,nn,Wt,Jt,hn,Ct,on,dn,Vn,an,xn,d,v,B,N,E,U,te,X,Le=`<script id="seed" type="application/json">${r[5]}<\/script>`,Ee,ve,Ke,lt,Ne,Et,_t,gt,Re,ut,jt,Ze,Xe,vt,un;return ut=new $c({}),Ze=new Uc({}),{c(){c=W("link"),f=le(),T=W("div"),C=W("header"),G=W("div"),oe=W("div"),Z=W("div"),ee=W("div"),ee.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',_=le(),pe=W("div"),j=W("div"),ce=W("button"),ge=W("span"),ge.textContent="Advanced",rt=le(),We=W("span"),We.textContent="▾",ze=le(),z=W("button"),z.textContent="New",H=le(),ie=W("label"),ie.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',D=le(),de=W("div"),Ae=W("span"),Ae.textContent="Zoom",_e=le(),Be=W("button"),Be.textContent="-",$e=le(),be=W("button"),ht=Hi(r[1]),R=le(),ae=W("button"),ae.textContent="+",x=le(),J=W("button"),J.textContent="Share",Se=le(),ue=W("button"),ue.textContent="Help",Qe=le(),re=W("div"),Ye=W("div"),Ye.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',ft=le(),st=W("form"),st.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',Bt=le(),Ie=W("a"),Ie.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',Pt=le(),S=W("main"),g=W("div"),he=W("aside"),q=W("div"),q.textContent="Models",xe=le(),It=W("ul"),K=le(),A=W("div"),A.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',mt=le(),Je=W("section"),cn=W("div"),cn.innerHTML='<div class="sidebar-heading">Local files</div> <button id="toggleServerSidebar" class="pf-v5-c-button pf-m-tertiary" type="button" aria-pressed="false" hidden="">Wide menu</button>',On=le(),en=W("p"),en.textContent="Checking for local server…",Xn=le(),wt=W("div"),tn=W("label"),tn.textContent="Blockscape files under ~/blockscape",lo=le(),_n=W("div"),Nn=W("label"),Nn.textContent="Folder",nn=le(),Wt=W("select"),Jt=W("option"),Jt.textContent="Root (~/blockscape)",hn=le(),Ct=W("select"),on=le(),dn=W("div"),dn.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button> <button id="deleteLocalFile" class="pf-v5-c-button pf-m-danger" type="button">Delete</button>',Vn=le(),an=W("div"),an.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',d=le(),v=W("div"),v.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,stage?:1-4,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,B=le(),N=W("footer"),E=W("div"),E.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',te=le(),X=new rc(!1),Ee=le(),ve=as("svg"),Ke=le(),lt=W("div"),Ne=le(),Et=W("div"),_t=le(),gt=W("div"),gt.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',Re=le(),Na(ut.$$.fragment),jt=le(),Na(Ze.$$.fragment),bs.title="Blockscape — simple landscape-style tiles",b(c,"rel","icon"),b(c,"type","image/svg+xml"),b(c,"href","./favicon.svg"),b(ee,"class","blockscape-brand"),b(ge,"class","blockscape-toolbar__toggle-label"),b(We,"class","blockscape-toolbar__toggle-icon"),b(We,"aria-hidden","true"),b(ce,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),b(ce,"type","button"),b(ce,"aria-expanded",r[0]),b(ce,"aria-controls","blockscapeHeaderExtras"),b(ce,"aria-label",je=r[0]?"Hide advanced tools":"Show advanced tools"),b(z,"id","newPanelButton"),b(z,"class","pf-v5-c-button pf-m-primary"),b(z,"type","button"),b(z,"title","Create something new"),b(ie,"class","pf-v5-c-button pf-m-primary blockscape-file"),b(Ae,"class","blockscape-zoom__label"),b(Be,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),b(Be,"type","button"),b(Be,"title","Zoom out (Ctrl -)"),b(be,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__reset"),b(be,"type","button"),b(be,"title","Reset zoom (Ctrl 0)"),b(ae,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),b(ae,"type","button"),b(ae,"title","Zoom in (Ctrl +)"),b(de,"class","blockscape-zoom"),b(de,"role","group"),b(de,"aria-label","Zoom controls"),b(J,"id","shareModel"),b(J,"class","pf-v5-c-button pf-m-secondary"),b(J,"type","button"),b(J,"title","Copy a shareable URL for this model"),b(ue,"id","helpButton"),b(ue,"class","pf-v5-c-button pf-m-primary"),b(ue,"type","button"),b(ue,"title","Show keyboard shortcuts"),b(j,"class","blockscape-toolbar__primary"),b(Ye,"class","blockscape-search"),b(st,"id","urlForm"),b(st,"class","blockscape-url-form"),b(st,"autocomplete","on"),st.noValidate=!0,b(re,"id","blockscapeHeaderExtras"),b(re,"class","blockscape-toolbar__extras"),re.hidden=pt=!r[0],b(re,"aria-hidden",w=!r[0]),b(pe,"class","blockscape-toolbar__controls"),b(pe,"data-expanded",et=r[0]?"true":"false"),b(Ie,"href","https://github.com/pwright/blockscape"),b(Ie,"target","_blank"),b(Ie,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),b(Ie,"title","View on GitHub"),b(Ie,"aria-label","View Blockscape on GitHub"),b(Z,"class","blockscape-toolbar"),b(oe,"class","pf-v5-c-masthead__content"),b(G,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),b(C,"class","pf-v5-c-page__header"),C.hidden=bt=!r[4],b(q,"class","sidebar-heading"),b(It,"id","modelList"),b(It,"class","model-nav-list"),b(A,"class","model-actions"),b(cn,"class","local-backend__header"),b(en,"id","localBackendStatus"),b(en,"class","local-backend__status muted"),b(tn,"class","sr-only"),b(tn,"for","localFileList"),b(Nn,"for","localDirSelect"),Jt.__value="",so(Jt,Jt.__value),b(Wt,"id","localDirSelect"),b(Wt,"class","pf-v5-c-form-control"),b(Wt,"aria-label","Folder filter"),b(_n,"class","local-backend__dir"),b(Ct,"id","localFileList"),b(Ct,"class","pf-v5-c-form-control"),b(Ct,"size","12"),Ct.multiple=!0,b(Ct,"aria-label","Blockscape files on local server"),b(dn,"class","local-backend__actions"),b(wt,"class","local-backend__list"),b(an,"class","local-backend__save"),b(Je,"id","localBackendPanel"),b(Je,"class","local-backend"),Je.hidden=!0,b(he,"class","blockscape-sidebar"),b(he,"aria-label","Models"),he.hidden=xn=!r[3],b(v,"class","blockscape-main"),b(g,"class","blockscape-content"),b(S,"class","pf-v5-c-page__main"),b(E,"class","blockscape-footer__inner"),b(N,"class","pf-v5-c-page__footer blockscape-footer"),N.hidden=U=!r[2],b(T,"class","pf-v5-c-page"),X.a=Ee,b(ve,"id","overlay"),b(ve,"class","svg-layer"),b(lt,"id","tabTooltip"),b(lt,"class","blockscape-tab-tooltip"),lt.hidden=!0,b(lt,"aria-hidden","true"),b(Et,"id","tileContextMenu"),b(Et,"class","tile-context-menu"),Et.hidden=!0,b(Et,"aria-hidden","true"),b(gt,"id","itemPreview"),b(gt,"class","item-preview"),gt.hidden=!0,b(gt,"aria-hidden","true")},m(we,Oe){k(bs.head,c),Mt(we,f,Oe),Mt(we,T,Oe),k(T,C),k(C,G),k(G,oe),k(oe,Z),k(Z,ee),k(Z,_),k(Z,pe),k(pe,j),k(j,ce),k(ce,ge),k(ce,rt),k(ce,We),k(j,ze),k(j,z),k(j,H),k(j,ie),k(j,D),k(j,de),k(de,Ae),k(de,_e),k(de,Be),k(de,$e),k(de,be),k(be,ht),k(de,R),k(de,ae),k(j,x),k(j,J),k(j,Se),k(j,ue),k(pe,Qe),k(pe,re),k(re,Ye),k(re,ft),k(re,st),k(Z,Bt),k(Z,Ie),k(T,Pt),k(T,S),k(S,g),k(g,he),k(he,q),k(he,xe),k(he,It),k(he,K),k(he,A),k(he,mt),k(he,Je),k(Je,cn),k(Je,On),k(Je,en),k(Je,Xn),k(Je,wt),k(wt,tn),k(wt,lo),k(wt,_n),k(_n,Nn),k(_n,nn),k(_n,Wt),k(Wt,Jt),k(wt,hn),k(wt,Ct),k(wt,on),k(wt,dn),k(Je,Vn),k(Je,an),k(g,d),k(g,v),k(T,B),k(T,N),k(N,E),Mt(we,te,Oe),X.m(Le,we,Oe),Mt(we,Ee,Oe),Mt(we,ve,Oe),Mt(we,Ke,Oe),Mt(we,lt,Oe),Mt(we,Ne,Oe),Mt(we,Et,Oe),Mt(we,_t,Oe),Mt(we,gt,Oe),Mt(we,Re,Oe),ji(ut,we,Oe),Mt(we,jt,Oe),ji(Ze,we,Oe),Xe=!0,vt||(un=[Ln(ce,"click",r[6]),Ln(Be,"click",r[8]),Ln(be,"click",r[9]),Ln(ae,"click",r[7])],vt=!0)},p(we,[Oe]){(!Xe||Oe&1)&&b(ce,"aria-expanded",we[0]),(!Xe||Oe&1&&je!==(je=we[0]?"Hide advanced tools":"Show advanced tools"))&&b(ce,"aria-label",je),(!Xe||Oe&2)&&rs(ht,we[1]),(!Xe||Oe&1&&pt!==(pt=!we[0]))&&(re.hidden=pt),(!Xe||Oe&1&&w!==(w=!we[0]))&&b(re,"aria-hidden",w),(!Xe||Oe&1&&et!==(et=we[0]?"true":"false"))&&b(pe,"data-expanded",et),(!Xe||Oe&16&&bt!==(bt=!we[4]))&&(C.hidden=bt),(!Xe||Oe&8&&xn!==(xn=!we[3]))&&(he.hidden=xn),(!Xe||Oe&4&&U!==(U=!we[2]))&&(N.hidden=U)},i(we){Xe||(Wi(ut.$$.fragment,we),Wi(Ze.$$.fragment,we),Xe=!0)},o(we){La(ut.$$.fragment,we),La(Ze.$$.fragment,we),Xe=!1},d(we){we&&(kt(f),kt(T),kt(te),X.d(),kt(Ee),kt(ve),kt(Ke),kt(lt),kt(Ne),kt(Et),kt(_t),kt(gt),kt(Re),kt(jt)),kt(c),zi(ut,we),zi(Ze,we),vt=!1,_o(un)}}}function Fc(r,c,f){let T,C,G,oe,{seed:Z}=c,{features:ee={}}=c;const pe=Z?JSON.stringify(Z,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let j=!1;const ce=[{label:"S",value:.9},{label:"M",value:1},{label:"L",value:1.15}];let ge=1;const rt=()=>{if(f(0,j=!j),!j){const H=document.getElementById("search");H&&H.value&&(H.value="",H.dispatchEvent(new Event("input",{bubbles:!0})))}},We=()=>{const H=ce[ge].value;document.documentElement.style.setProperty("--blockscape-scale",String(H)),window.dispatchEvent(new CustomEvent("blockscape:zoom",{detail:{scale:H}}))},je=()=>{f(12,ge=Math.min(ce.length-1,ge+1)),We()},ze=()=>{f(12,ge=Math.max(0,ge-1)),We()},z=()=>{f(12,ge=1),We()};return lc(()=>{Ac(ee),We();const H=ie=>{if(!(!ie.ctrlKey&&!ie.metaKey)){if(ie.key==="="||ie.key==="+"){je(),ie.preventDefault();return}if(ie.key==="-"||ie.key==="_"){ze(),ie.preventDefault();return}ie.key==="0"&&(z(),ie.preventDefault())}};return window.addEventListener("keydown",H),()=>window.removeEventListener("keydown",H)}),r.$$set=H=>{"seed"in H&&f(10,Z=H.seed),"features"in H&&f(11,ee=H.features)},r.$$.update=()=>{r.$$.dirty&2048&&f(4,T=ee.showHeader!==!1),r.$$.dirty&2048&&f(3,C=ee.showSidebar!==!1),r.$$.dirty&2048&&f(2,G=ee.showFooter!==!1),r.$$.dirty&4096&&f(1,oe=`${Math.round(ce[ge].value*100)}%`)},[j,oe,G,C,T,pe,rt,je,ze,z,Z,ee,ge]}class Wc extends Ki{constructor(c){super(),Gi(this,c,Fc,Hc,Ui,{seed:10,features:11})}}function jc(r){let c,f;return c=new Wc({props:{seed:r[0],features:r[1]}}),{c(){Na(c.$$.fragment)},m(T,C){ji(c,T,C),f=!0},p(T,[C]){const G={};C&1&&(G.seed=T[0]),C&2&&(G.features=T[1]),c.$set(G)},i(T){f||(Wi(c.$$.fragment,T),f=!0)},o(T){La(c.$$.fragment,T),f=!1},d(T){zi(c,T)}}}function zc(r,c,f){let{seed:T}=c,{features:C={}}=c;return r.$$set=G=>{"seed"in G&&f(0,T=G.seed),"features"in G&&f(1,C=G.features)},[T,C]}class Gc extends Ki{constructor(c){super(),Gi(this,c,zc,jc,Ui,{seed:0,features:1})}}return Gc}();
