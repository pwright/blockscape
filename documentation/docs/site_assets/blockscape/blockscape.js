var Blockscape=function(){"use strict";var zp=Object.defineProperty;var Gp=(Vn,Ht,ao)=>Ht in Vn?zp(Vn,Ht,{enumerable:!0,configurable:!0,writable:!0,value:ao}):Vn[Ht]=ao;var io=(Vn,Ht,ao)=>Gp(Vn,typeof Ht!="symbol"?Ht+"":Ht,ao);var Vn=typeof document<"u"?document.currentScript:null;function Ht(){}function ao(r){return r()}function Qr(){return Object.create(null)}function Io(r){r.forEach(ao)}function es(r){return typeof r=="function"}function Hi(r,l){return r!=r?l==l:r!==l||r&&typeof r=="object"||typeof r=="function"}function tc(r){return Object.keys(r).length===0}const nc=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function E(r,l){r.appendChild(l)}function Mt(r,l,f){r.insertBefore(l,f||null)}function _t(r){r.parentNode&&r.parentNode.removeChild(r)}function H(r){return document.createElement(r)}function ts(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function Fi(r){return document.createTextNode(r)}function se(){return Fi(" ")}function Bn(r,l,f,T){return r.addEventListener(l,f,T),()=>r.removeEventListener(l,f,T)}function oc(r){return function(l){return l.preventDefault(),r.call(this,l)}}function g(r,l,f){f==null?r.removeAttribute(l):r.getAttribute(l)!==f&&r.setAttribute(l,f)}function ic(r){let l;return{p(...f){l=f,l.forEach(T=>r.push(T))},r(){l.forEach(f=>r.splice(r.indexOf(f),1))}}}function ac(r){return Array.from(r.childNodes)}function ns(r,l){l=""+l,r.data!==l&&(r.data=l)}function ro(r,l){r.value=l??""}class rc{constructor(l=!1){io(this,"is_svg",!1);io(this,"e");io(this,"n");io(this,"t");io(this,"a");this.is_svg=l,this.e=this.n=null}c(l){this.h(l)}m(l,f,T=null){this.e||(this.is_svg?this.e=ts(f.nodeName):this.e=H(f.nodeType===11?"TEMPLATE":f.nodeName),this.t=f.tagName!=="TEMPLATE"?f:f.content,this.c(l)),this.i(T)}h(l){this.e.innerHTML=l,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(l){for(let f=0;f<this.n.length;f+=1)Mt(this.t,this.n[f],l)}p(l){this.d(),this.h(l),this.i(this.a)}d(){this.n.forEach(_t)}}let ci;function di(r){ci=r}function sc(){if(!ci)throw new Error("Function called outside component initialization");return ci}function lc(r){sc().$$.on_mount.push(r)}const _o=[],os=[];let Co=[];const is=[],cc=Promise.resolve();let xa=!1;function dc(){xa||(xa=!0,cc.then(as))}function Ta(r){Co.push(r)}const Aa=new Set;let xo=0;function as(){if(xo!==0)return;const r=ci;do{try{for(;xo<_o.length;){const l=_o[xo];xo++,di(l),uc(l.$$)}}catch(l){throw _o.length=0,xo=0,l}for(di(null),_o.length=0,xo=0;os.length;)os.pop()();for(let l=0;l<Co.length;l+=1){const f=Co[l];Aa.has(f)||(Aa.add(f),f())}Co.length=0}while(_o.length);for(;is.length;)is.pop()();xa=!1,Aa.clear(),di(r)}function uc(r){if(r.fragment!==null){r.update(),Io(r.before_update);const l=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,l),r.after_update.forEach(Ta)}}function pc(r){const l=[],f=[];Co.forEach(T=>r.indexOf(T)===-1?l.push(T):f.push(T)),f.forEach(T=>T()),Co=l}const Wi=new Set;let fc;function ji(r,l){r&&r.i&&(Wi.delete(r),r.i(l))}function La(r,l,f,T){if(r&&r.o){if(Wi.has(r))return;Wi.add(r),fc.c.push(()=>{Wi.delete(r)}),r.o(l)}}function Na(r){r&&r.c()}function zi(r,l,f){const{fragment:T,after_update:_}=r.$$;T&&T.m(l,f),Ta(()=>{const G=r.$$.on_mount.map(ao).filter(es);r.$$.on_destroy?r.$$.on_destroy.push(...G):Io(G),r.$$.on_mount=[]}),_.forEach(Ta)}function Gi(r,l){const f=r.$$;f.fragment!==null&&(pc(f.after_update),Io(f.on_destroy),f.fragment&&f.fragment.d(l),f.on_destroy=f.fragment=null,f.ctx=[])}function mc(r,l){r.$$.dirty[0]===-1&&(_o.push(r),dc(),r.$$.dirty.fill(0)),r.$$.dirty[l/31|0]|=1<<l%31}function Ji(r,l,f,T,_,G,ne=null,q=[-1]){const X=ci;di(r);const C=r.$$={fragment:null,ctx:[],props:G,update:Ht,not_equal:_,bound:Qr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(X?X.$$.context:[])),callbacks:Qr(),dirty:q,skip_bound:!1,root:l.target||X.$$.root};ne&&ne(C.root);let ce=!1;if(C.ctx=f?f(r,l.props||{},(j,le,...fe)=>{const rt=fe.length?fe[0]:le;return C.ctx&&_(C.ctx[j],C.ctx[j]=rt)&&(!C.skip_bound&&C.bound[j]&&C.bound[j](rt),ce&&mc(r,j)),le}):[],C.update(),ce=!0,Io(C.before_update),C.fragment=T?T(C.ctx):!1,l.target){if(l.hydrate){const j=ac(l.target);C.fragment&&C.fragment.l(j),j.forEach(_t)}else C.fragment&&C.fragment.c();l.intro&&ji(r.$$.fragment),zi(r,l.target,l.anchor),as()}di(X)}class Ki{constructor(){io(this,"$$");io(this,"$$set")}$destroy(){Gi(this,1),this.$destroy=Ht}$on(l,f){if(!es(f))return Ht;const T=this.$$.callbacks[l]||(this.$$.callbacks[l]=[]);return T.push(f),()=>{const _=T.indexOf(f);_!==-1&&T.splice(_,1)}}$set(l){this.$$set&&!tc(l)&&(this.$$.skip_bound=!0,this.$$set(l),this.$$.skip_bound=!1)}}const hc="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(hc);const rs="blockscape:apicurioConfig",Ma="http://localhost:8080/apis/registry/v3",qi="bs",ss="-series",Ba=!1,Pa=!1;function gc({models:r,getActiveIndex:l,setActive:f,ensureModelMetadata:T,ensureSeriesId:_,getModelId:G,getSeriesId:ne,getModelTitle:q,computeJsonFingerprint:X,uid:C}){let ce=null,j=null,le=null,fe=null,rt=null,He=null,Fe=null,We=null,z=null,U=null;const ae=new Set,R={baseUrl:Ma,groupId:qi,authToken:"",enabled:Ba,useSemver:Pa},me=new Map,Ne=new Map;function be(d){return(d||"").toString().trim().replace(/\/+$/,"")}function nt(d){return`${(d||"").toString().trim()||qi}${ss}`}function Ie(){return!!(R.baseUrl&&R.groupId)}function de(){return R.enabled!==!1}function ht(){ae.forEach(d=>{try{d(de())}catch(v){console.warn("[Blockscape] failed to run Apicurio enabled listener",v)}})}function V(d){return typeof d=="function"&&ae.add(d),()=>ae.delete(d)}function Z(){le&&(le.value=R.baseUrl||""),fe&&(fe.value=R.groupId||""),rt&&(rt.value=R.authToken||""),He&&(He.checked=de()),Fe&&(Fe.checked=!!R.useSemver)}function x(d="",v="muted"){We&&(We.textContent=d||"",We.classList.remove("is-error","is-success"),v==="error"?We.classList.add("is-error"):v==="success"&&We.classList.add("is-success"))}function Q(d){if(!U||(U.innerHTML="",!d))return;const v=document.createElement("p");v.className="apicurio-hint",v.textContent=d,U.appendChild(v)}function Se(d){me.clear(),Ne.clear(),Q(d)}function ue(){const d=l(),v=de(),B=Ie(),N=d>=0?r[d]:null,k=!!(N!=null&&N.apicurioVersions&&N.apicurioVersions.length>1);if(ce){const D=ce.dataset.loading==="true",ee=v&&B&&d>=0&&!!Ae(r[d]);ce.disabled=!v||D||!ee,v?D||(ce.textContent="Push to Apicurio"):ce.textContent="Enable Apicurio to push"}if(z){const D=z.dataset.loading==="true",ee=v&&B&&k&&!!Ae(N);z.disabled=!ee||D,z.hidden=!k,v?D||(z.textContent="Push series"):z.textContent="Enable Apicurio to push series"}if(j){const D=j.dataset.loading==="true",ee=v&&B;j.disabled=!ee||D,D||(v?B?j.textContent="List artifacts":j.textContent="Enter details to list":j.textContent="Enable Apicurio to list")}}function Ee(){Z(),de()?Ie()?(x("Apicurio push is ready when a model is selected.","muted"),me.size||Q("Click “List artifacts” to browse the current group.")):(x("Enter Apicurio connection details to enable push.","muted"),Se("Enter registry details to browse artifacts.")):(x("Apicurio integration is off. Enable it to allow pushes.","muted"),Se("Apicurio integration is disabled.")),ue()}function Te(){if(window!=null&&window.localStorage)try{localStorage.setItem(rs,JSON.stringify(R))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function we(){let d={};if(window!=null&&window.localStorage)try{const D=localStorage.getItem(rs);if(D){const ee=JSON.parse(D);ee&&typeof ee=="object"&&(d=ee)}}catch(D){console.warn("[Blockscape] failed to restore Apicurio settings",D)}const v=be(d.baseUrl??Ma),B=(d.groupId??qi).toString().trim();let N=Ba,k=Pa;typeof d.enabled=="boolean"?N=d.enabled:typeof d.enabled=="string"&&(N=d.enabled==="true"),typeof d.useSemver=="boolean"?k=d.useSemver:typeof d.useSemver=="string"&&(k=d.useSemver==="true"),R.baseUrl=v||Ma,R.groupId=B||qi,R.authToken=(d.authToken??"").toString().trim(),R.enabled=N,R.useSemver=k,Ee(),ht()}function Ye(){const d={Accept:"application/json"},v=(R.authToken||"").trim();return v&&(d.Authorization=/\s/.test(v)?v:`Bearer ${v}`),d}function st(d,v,{title:B,description:N,version:k}={}){const D={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:v},metadata:{properties:{}}}};k&&(D.firstVersion.version=k),B&&(D.name=B),N&&(D.description=N);try{const ee=JSON.parse(v),J=ee==null?void 0:ee.seriesId;J&&typeof J=="string"&&(D.firstVersion.metadata.properties.seriesId=J)}catch{}return D}function gt(d,{version:v}={}){const B={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const N=JSON.parse(d),k=N==null?void 0:N.seriesId;k&&typeof k=="string"&&(B.metadata.properties.seriesId=k)}catch{}return v&&(B.version=v),B}function b(d){if(d==null)return null;const v=String(d).trim();if(!v)return null;const B=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(v);if(B)return{major:Number(B[1]),minor:Number(B[2]),patch:Number(B[3])};const N=/^v?(\d+)$/.exec(v);return N?{major:Number(N[1]),minor:0,patch:0}:null}function ze(d){return`${d.major}.${d.minor}.${d.patch}`}function Ct(d,v){return!d&&!v?0:d?v?d.major!==v.major?d.major-v.major:d.minor!==v.minor?d.minor-v.minor:d.patch-v.patch:1:-1}function wt(d=[]){let v=null;if(d.forEach(N=>{const k=b((N==null?void 0:N.version)??N);k&&(!v||Ct(k,v)>0)&&(v=k)}),!v)return"1.0.0";const B={...v,patch:v.patch+1};return ze(B)}function Ae(d,{seriesName:v,fallbackTitle:B}={}){var D;if(!d)return null;const N=v||d.title||d.apicurioArtifactName||q(d),k=B||N;if(typeof _=="function"&&(d.isSeries||((D=d.apicurioVersions)==null?void 0:D.length)>1)&&_(d,{seriesName:N,fallbackTitle:k}),typeof ne=="function"){const ee=ne(d,{seriesName:N,fallbackTitle:k});if(ee)return ee}return G(d)}function ut(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function Bt(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function je(d=[]){if(!Array.isArray(d)||!d.length)return null;const v=[...d].filter(Boolean);return v.sort((B,N)=>{const k=B!=null&&B.createdOn?new Date(B.createdOn).getTime():0,D=N!=null&&N.createdOn?new Date(N.createdOn).getTime():0;if(k!==D)return D-k;const ee=Number(B==null?void 0:B.version),J=Number(N==null?void 0:N.version),ke=Number.isFinite(ee),he=Number.isFinite(J);if(ke&&he&&ee!==J)return J-ee;const Le=String((B==null?void 0:B.version)??"");return String((N==null?void 0:N.version)??"").localeCompare(Le,void 0,{numeric:!0})}),v[0]||null}function lt(d){if(!d)return d;let v=d;if(!Array.isArray(d==null?void 0:d.categories)){const N=d==null?void 0:d.content;if(typeof N=="string")try{v=JSON.parse(N)}catch(k){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",k)}else N&&typeof N=="object"&&(v=N)}return v}async function y(d,v,B){const N=encodeURIComponent(v),k=encodeURIComponent(B),D=`${d}/groups/${N}/artifacts/${k}`,ee=Ye();ee.Accept="application/json";const J=await fetch(D,{method:"GET",headers:ee});if(!J.ok){let ke=J.statusText||"Unknown error";try{const he=await J.text();he&&(ke=he.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${J.status}): ${ke}`)}return J.json()}async function w(d,v,B){const N=encodeURIComponent(v),k=encodeURIComponent(B),D=`${d}/groups/${N}/artifacts/${k}/versions?limit=50&order=desc`,ee=Ye();ee.Accept="application/json";const J=await fetch(D,{method:"GET",headers:ee});if(!J.ok){let he=J.statusText||"Unknown error";try{const Le=await J.text();Le&&(he=Le.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${J.status}): ${he}`)}const ke=await J.json();return Bt(ke).filter(he=>he&&he.version!=null)}async function pt(d,v,B,N="latest"){const k=encodeURIComponent(v),D=encodeURIComponent(B),ee=encodeURIComponent(N||"latest"),J=`${d}/groups/${k}/artifacts/${D}/versions/${ee}/content`,ke=Ye();ke.Accept="application/json, application/*+json, */*;q=0.8";const he=await fetch(J,{method:"GET",headers:ke});if(!he.ok){let mt=he.statusText||"Unknown error";try{const xe=await he.text();xe&&(mt=xe.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${he.status}): ${mt}`)}const Le=await he.text();let Ge=null;try{Ge=JSON.parse(Le)}catch{throw new Error("Artifact content is not valid JSON.")}return lt(Ge)}async function re(d,v,B,N="latest"){const k=await pt(d,v,B,N);return{data:k,fingerprint:X(k)}}async function M(d,v,B){try{const k=await w(d,v,B);if(k!=null&&k.length){Ne.set(B,k);const D=je(k);if((D==null?void 0:D.version)!=null)return D.version}}catch(k){console.warn("[Blockscape] compare-version: unable to fetch versions list",k)}try{const k=await y(d,v,B);if((k==null?void 0:k.version)!=null)return k.version}catch(k){console.warn("[Blockscape] compare-version: unable to fetch metadata",k)}const N=Ne.get(B);if(N&&N.length){const k=je(N);if((k==null?void 0:k.version)!=null)return k.version}return"latest"}async function At(d,v,B,N){if(!R.useSemver)return null;if(!N)return"1.0.0";try{const k=await w(d,v,B);return wt(k)}catch(k){throw new Error(`Unable to compute next semantic version: ${k.message}`)}}function K(d=document){ce=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),z=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),j=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),le=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),fe=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),rt=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),He=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),Fe=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),We=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),U=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function ot(){R.baseUrl=be((le==null?void 0:le.value)??R.baseUrl),R.groupId=((fe==null?void 0:fe.value)??"").trim(),R.authToken=((rt==null?void 0:rt.value)??"").trim(),Te(),Ee()}function ft(d){R.enabled=d!==!1,Te(),Ee(),ht()}function bt(){ft(He?He.checked:Ba)}function Cn(){R.useSemver=Fe?Fe.checked:Pa,Te(),Ee()}function xn(){[le,fe,rt].forEach(d=>{d&&d.addEventListener("input",ot)}),ce&&ce.addEventListener("click",()=>{An()}),z&&z.addEventListener("click",()=>{Wt()}),He&&He.addEventListener("change",bt),Fe&&Fe.addEventListener("change",Cn),j&&j.addEventListener("click",dn),U&&U.addEventListener("click",d=>{const v=d.target.closest("[data-artifact-version]");if(v){d.stopPropagation();const k=v.dataset.artifactId,D=v.dataset.artifactVersion;k&&D&&qt(k,D);return}const B=d.target.closest("[data-artifact-load-all]");if(B){d.stopPropagation(),B.dataset.artifactId&&Ln();return}const N=d.target.closest("[data-artifact-trigger]");if(N){const k=N.dataset.artifactId;if(!k)return;so(k)}})}function Tn(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function Kt(d){if(!d)return;d.innerHTML="";const v=Tn();d.appendChild(v),K(d),xn(),Ee()}function Pt(d){if(!U)return;if(U.innerHTML="",!d.length){Q("No artifacts found in this group.");return}const v=k=>{const D=document.createElement("section");D.className="apicurio-artifact-section";const ee=document.createElement("h3");ee.textContent=k,D.appendChild(ee);const J=document.createElement("ul");return J.className="apicurio-artifact-list",D.appendChild(J),{section:D,list:J}},B=v("Series artifacts"),N=v("Artifacts");d.forEach(k=>{if(!(k!=null&&k.artifactId))return;const ee=k._groupId&&k._groupId.endsWith(ss)?B.list:N.list,J=document.createElement("li"),ke=document.createElement("button");ke.type="button",ke.className="apicurio-artifact",ke.dataset.artifactId=k.artifactId,ke.dataset.artifactTrigger="toggle";const he=document.createElement("span");he.className="apicurio-artifact-title",he.textContent=k.artifactId,ke.appendChild(he);const Le=[];if(k.name&&Le.push(k.name),k.version!=null&&Le.push(`v${k.version}`),k.type&&Le.push(k.type),k._groupId&&Le.push(k._groupId),Le.length){const xe=document.createElement("span");xe.className="apicurio-artifact-meta",xe.textContent=Le.join(" • "),ke.appendChild(xe)}if(k.description){const xe=document.createElement("span");xe.className="apicurio-artifact-meta",xe.textContent=k.description,ke.appendChild(xe)}J.appendChild(ke);const Ge=document.createElement("div");Ge.className="apicurio-version-list",Ge.dataset.versionPanel=k.artifactId,Ge.hidden=!0;const mt=document.createElement("p");mt.className="apicurio-hint",mt.textContent="Click to load the latest or open versions.",Ge.appendChild(mt),J.appendChild(Ge),ee.appendChild(J)}),B.list.children.length&&U.appendChild(B.section),N.list.children.length&&U.appendChild(N.section)}function gn(d){return U?U.querySelector(`[data-version-panel="${d}"]`):null}function cn(d,v){if(!d||(d.innerHTML="",!v))return;const B=document.createElement("p");B.className="apicurio-hint",B.textContent=v,d.appendChild(B)}function Un(d,v){const B=gn(d);if(B){if(B.innerHTML="",!v.length){cn(B,"No versions found for this artifact.");return}v.forEach(N=>{const k=document.createElement("button");k.type="button",k.className="apicurio-version-button",k.dataset.artifactId=d,k.dataset.artifactVersion=N.version;const D=[`Version ${N.version}`];if(N.createdOn){const ee=new Date(N.createdOn);isNaN(ee)||D.push(ee.toISOString().slice(0,10))}k.textContent=D.join(" — "),B.appendChild(k)})}}async function so(d){const v=gn(d);if(!v)return;if(v.dataset.open==="true"){v.hidden=!0,v.dataset.open="false";return}if(v.hidden=!1,v.dataset.open="true",v.dataset.loaded!=="true"){if(!Ie()){cn(v,"Enter registry details first.");return}cn(v,"Loading versions…");try{const N=be(R.baseUrl),k=me.get(d),D=R.groupId.trim(),ee=(k==null?void 0:k._groupId)||D,J=await w(N,ee,d);Ne.set(d,J),v.dataset.loaded="true",Un(d,J)}catch(N){console.error("[Blockscape] failed to load versions",N),cn(v,`Unable to fetch versions: ${N.message}`)}}}function tn(d,v){var N;const B=r.findIndex(k=>k.apicurioArtifactId===d);if(B!==-1){const k=r[B].id;r[B]={...v,id:k||v.id},((N=r[B].apicurioVersions)==null?void 0:N.length)>1&&(r[B].isSeries=!0),f(B)}else r.push(v),f(r.length-1)}async function Ft(d,v,B,N){const k=encodeURIComponent(v),D=encodeURIComponent(B),ee=`${d}/groups/${k}/artifacts/${D}`;try{const J=await fetch(ee,{method:"GET",headers:N});if(J.status===404)return!1;if(J.ok)return!0;throw J.status===401||J.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${J.status} while checking the artifact.`)}catch(J){throw J instanceof TypeError?new Error("Network error while contacting Apicurio registry."):J}}async function An(){var ee;if(!ce||ce.dataset.loading==="true")return;if(!de()){x("Apicurio integration is off. Enable it first.","error");return}if(!Ie()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=l();if(d<0||!r[d]){x("No active model to push.","error");return}const v=Ae(r[d],{fallbackTitle:q(r[d])});if(!v){x("Active model needs an id before pushing.","error");return}const B=be(R.baseUrl),N=R.groupId.trim(),k=JSON.stringify(r[d].data,null,2),D=Ye();ce.dataset.loading="true",ce.textContent="Pushing…",ce.disabled=!0,x("Pushing to Apicurio…","muted");try{const J=await Ft(B,N,v,D),ke=X(r[d].data);if(J)try{const Ze=await M(B,N,v),{data:xt,fingerprint:St}=await re(B,N,v,Ze);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",Ze),console.log("local fingerprint",ke),console.log("registry fingerprint",St),console.log("local payload",r[d].data),console.log("registry payload",xt),console.groupEnd(),ke&&St&&ke===St){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){x("Push cancelled (content matches the latest registry version).","muted");return}x("Pushing identical content by user choice.","muted")}else St?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(Ze){console.warn("[Blockscape] unable to compare registry content before push",Ze),x("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const he=R.useSemver?await At(B,N,v,J):null;if(R.useSemver&&!he)throw new Error("Semantic versioning is enabled but no version could be computed.");const Le=encodeURIComponent(N),Ge=encodeURIComponent(v),mt=J?`${B}/groups/${Le}/artifacts/${Ge}/versions`:`${B}/groups/${Le}/artifacts`,xe={...D,"Content-Type":"application/json"};he&&(xe["X-Registry-Version"]=he,x(`Pushing to Apicurio as version ${he}…`,"muted"));const It=J?gt(k,{version:he}):st(v,k,{title:q(r[d]),description:(ee=r[d].data)==null?void 0:ee.abstract,version:he}),jt=await fetch(mt,{method:"POST",headers:xe,body:JSON.stringify(It)});if(!jt.ok){let Ze=jt.statusText||"Unknown error";try{const xt=await jt.text();xt&&(Ze=xt.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${jt.status}): ${Ze}`)}let vt=null;try{vt=await jt.json()}catch{vt=null}const Be=(vt==null?void 0:vt.version)||(vt==null?void 0:vt.globalId)||"",qe=J?"Updated":"Created",Yt=Be?` (version ${Be})`:"";x(`${qe} ${v}${Yt}`,"success")}catch(J){console.error("[Blockscape] Apicurio push failed",J),x(`Apicurio push failed: ${J.message}`,"error")}finally{ce.dataset.loading="false",ue()}}async function Wt(){var he,Le;if(!z||z.dataset.loading==="true")return;if(!de()){x("Apicurio integration is off. Enable it first.","error");return}if(!Ie()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=l(),v=d>=0?r[d]:null;if(!v||!v.apicurioVersions||v.apicurioVersions.length<2){x("Series push requires a model with multiple versions.","error");return}const B=Ae(v,{seriesName:v.title||v.apicurioArtifactName||q(v)});if(!B){x("Active series needs an id before pushing.","error");return}typeof _=="function"&&_(v,{seriesName:v.title||v.apicurioArtifactName||q(v)});const N=be(R.baseUrl),k=R.groupId.trim(),D=v.apicurioVersions.map(Ge=>Ge.data),ee=JSON.stringify(D,null,2),J=Ye(),ke=nt(k);z.dataset.loading="true",z.textContent="Pushing…",z.disabled=!0,x("Pushing series to Apicurio…","muted");try{const Ge=await Ft(N,ke,B,J),mt=X(D);if(Ge)try{const Rt=await M(N,ke,B),{data:pn,fingerprint:_e}=await re(N,ke,B,Rt);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",Rt),console.log("local fingerprint",mt),console.log("registry fingerprint",_e),console.log("local payload (series)",D),console.log("registry payload",pn),console.groupEnd(),mt&&_e&&mt===_e){if(!window.confirm("The current registry version matches this series. Push anyway?")){x("Series push cancelled (content matches latest).","muted");return}x("Pushing identical series by user choice.","muted")}else _e?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(Rt){console.warn("[Blockscape] unable to compare registry content before series push",Rt),x("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const xe=R.useSemver?await At(N,ke,B,Ge):null;if(R.useSemver&&!xe)throw new Error("Semantic versioning is enabled but no version could be computed.");const It=encodeURIComponent(ke),jt=encodeURIComponent(B),vt=Ge?`${N}/groups/${It}/artifacts/${jt}/versions`:`${N}/groups/${It}/artifacts`,Be={...J,"Content-Type":"application/json"};xe&&(Be["X-Registry-Version"]=xe,x(`Pushing series to Apicurio as version ${xe}…`,"muted"));const qe=Ge?gt(ee,{version:xe}):st(B,ee,{title:v.apicurioArtifactName||((he=v.data)==null?void 0:he.title)||B,description:(Le=v.data)==null?void 0:Le.abstract,version:xe}),Yt=await fetch(vt,{method:"POST",headers:Be,body:JSON.stringify(qe)});if(!Yt.ok){let Rt=Yt.statusText||"Unknown error";try{const pn=await Yt.text();pn&&(Rt=pn.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${Yt.status}): ${Rt}`)}let Ze=null;try{Ze=await Yt.json()}catch{Ze=null}const xt=(Ze==null?void 0:Ze.version)||(Ze==null?void 0:Ze.globalId)||"",St=Ge?"Updated":"Created",yt=xt?` (version ${xt})`:"";x(`${St} ${B} series${yt}`,"success")}catch(Ge){console.error("[Blockscape] Apicurio series push failed",Ge),x(`Apicurio series push failed: ${Ge.message}`,"error")}finally{z.dataset.loading="false",ue()}}async function dn(){if(!j||j.dataset.loading==="true")return;if(!de()){x("Enable Apicurio integration to list artifacts.","error");return}if(!Ie()){x("Enter registry base URL and group ID before listing.","error");return}const d=be(R.baseUrl),v=R.groupId.trim(),B=nt(v),N=[{groupId:v,label:"base"},{groupId:B,label:"series"}];j.dataset.loading="true",j.textContent="Listing…",j.disabled=!0,x("Listing artifacts…","muted"),Q("Contacting registry…");try{const k=Ye();k.Accept="application/json";const D=[];for(const J of N){const ke=encodeURIComponent(J.groupId),he=`${d}/groups/${ke}/artifacts?limit=50&offset=0`,Le=await fetch(he,{method:"GET",headers:k});if(!Le.ok){let xe=Le.statusText||"Unknown error";try{const It=await Le.text();It&&(xe=It.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${J.groupId} (${Le.status}): ${xe}`);continue}const Ge=await Le.json(),mt=ut(Ge).filter(xe=>xe&&xe.artifactId);mt.forEach(xe=>{xe&&(xe._groupId=J.groupId)}),D.push(...mt)}me.clear(),Ne.clear(),D.forEach(J=>{J!=null&&J.artifactId&&me.set(J.artifactId,J)}),Pt(D);const ee=D.length;x(ee?`Found ${ee} artifact${ee===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",ee?"success":"muted")}catch(k){console.error("[Blockscape] failed to list artifacts",k),Se("Unable to list artifacts."),x(`Listing failed: ${k.message}`,"error")}finally{j.dataset.loading="false",ue()}}async function qt(d,v=null){var Ge,mt,xe,It,jt,vt;if(!d)return;if(!de()){x("Enable Apicurio integration to load artifacts.","error");return}if(!Ie()){x("Enter registry connection details before loading artifacts.","error");return}const B=be(R.baseUrl),N=R.groupId.trim(),k=d&&((Ge=me.get(d))==null?void 0:Ge._groupId)||N;let D=me.get(d);const ee=async()=>{try{const Be=await y(B,k,d);return Be!=null&&Be.artifactId&&me.set(d,Be),Be}catch(Be){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",Be),Be}};if(!D)try{D=await ee()}catch(Be){x(`Failed to fetch artifact metadata: ${Be.message}`,"error");return}const J=Ne.get(d)||[];let ke="latest",he="latest";if(v)ke=v,he=v;else{if(!D||D.version==null)try{D=await ee()}catch(Be){x(`Failed to fetch artifact metadata: ${Be.message}`,"error");return}ke=(D==null?void 0:D.version)||"latest",he=(D==null?void 0:D.version)||"latest"}const Le=J.find(Be=>String(Be.version)===String(ke));(Le==null?void 0:Le.version)!=null&&(he=Le.version),x(`Loading artifact ${d}…`,"muted");try{const Be=await pt(B,k,d,ke),qe=me.get(d)||D||{},Yt=Array.isArray(Be);let Ze=null;if(Yt){const xt=Be.map((yt,Rt)=>(T(yt,{titleHint:qe.name||d,idHint:d}),{version:String(Rt+1),data:yt,createdOn:(Le==null?void 0:Le.createdOn)||qe.createdOn}));Ze={id:C(),title:((xe=(mt=xt[0])==null?void 0:mt.data)==null?void 0:xe.title)||qe.name||d,data:(It=xt[0])==null?void 0:It.data,apicurioArtifactId:d,apicurioArtifactName:qe.name||"",apicurioVersions:xt,apicurioActiveVersionIndex:0,isSeries:!0};const St=((jt=qe==null?void 0:qe.properties)==null?void 0:jt.seriesId)||d;typeof _=="function"&&_(Ze,{seriesName:St,fallbackTitle:St}),x(`Loaded series artifact ${d}.`,"success")}else{T(Be,{titleHint:qe.name||d,idHint:d});const xt={version:he,data:Be,createdOn:(Le==null?void 0:Le.createdOn)||qe.createdOn};Ze={id:C(),title:Be.title||qe.name||d,data:Be,apicurioArtifactId:d,apicurioArtifactName:qe.name||"",apicurioVersions:[xt],apicurioActiveVersionIndex:0};const St=(vt=qe==null?void 0:qe.properties)==null?void 0:vt.seriesId;St&&typeof _=="function"&&_(Ze,{seriesName:St,fallbackTitle:St});const yt=he?` (version ${he})`:"";x(`Loaded artifact ${d}${yt}.`,"success")}tn(d,Ze)}catch(Be){console.error("[Blockscape] failed to load artifact",Be),x(`Failed to load artifact: ${Be.message}`,"error")}}async function Ln(d){}return{hydrateConfig:we,mount:Kt,updateAvailability:ue,isEnabled:de,setEnabled:ft,onEnabledChange:V}}const Gt={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Zn(r,l){if(typeof r!="function")throw new Error(`[itemEditor] expected ${l} to be a function`)}function bc(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}const Ra=1,$a=4;function wc(r){if(r==null)return null;const l=Number(r);if(!Number.isFinite(l))return null;const f=Math.round(l);return f<Ra||f>$a?null:f}function vc(r,{excludeId:l}={}){if(!r)return[];const f=r.split(/[\s,]+/).map(_=>_.trim()).filter(Boolean),T=[];return f.forEach(_=>{l&&_===l||T.includes(_)||T.push(_)}),T}function yc(r,l,f){if(!l||!f||l===f)return;((r==null?void 0:r.categories)||[]).forEach(_=>{(_.items||[]).forEach(G=>{Array.isArray(G.deps)&&(G.deps=G.deps.map(ne=>ne===l?f:ne))})})}function Sc({findItemAndCategoryById:r,collectAllItemIds:l,updateItemReferences:f,loadActiveIntoEditor:T,rebuildFromActive:_,select:G,onSelectionRenamed:ne,makeSlug:q=bc,isAutoIdFromNameEnabled:X=()=>!0}={}){Zn(r,"findItemAndCategoryById"),Zn(l,"collectAllItemIds"),Zn(f,"updateItemReferences"),Zn(T,"loadActiveIntoEditor"),Zn(_,"rebuildFromActive"),Zn(G,"select"),Zn(q,"makeSlug"),Zn(X,"isAutoIdFromNameEnabled");const C={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function ce(z){if(C.fields.errorEl){if(!z){C.fields.errorEl.hidden=!0,C.fields.errorEl.textContent="";return}C.fields.errorEl.hidden=!1,C.fields.errorEl.textContent=z}}function j(){C.wrapper&&(C.wrapper.hidden=!0,C.wrapper.setAttribute("aria-hidden","true"),ce(""),C.categoryId=null,C.itemId=null,C.modelData=null,document.body.classList.remove("item-editor-open"))}function le(){C.wrapper&&(C.wrapper.hidden=!1,C.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var z,U;(z=C.fields.nameInput)==null||z.focus(),(U=C.fields.nameInput)==null||U.select()}))}function fe({force:z}={}){var ae,R;if(!((ae=C.fields)!=null&&ae.idInput)||!((R=C.fields)!=null&&R.nameInput)||!C.autoSyncEnabled||!X()||!z&&C.autoIdManuallyEdited)return;const U=q(C.fields.nameInput.value||C.itemId||"item");C.fields.idInput.value=U}function rt(z){var ht;if(!C.modelData||!C.categoryId||!C.itemId)throw new Error("No item loaded.");const ae=(((ht=C.modelData)==null?void 0:ht.categories)||[]).find(V=>V.id===C.categoryId);if(!ae)throw new Error("Category not found.");ae.items=ae.items||[];const R=ae.items.find(V=>V.id===C.itemId);if(!R)throw new Error("Item not found.");const me=(z.id||"").trim();if(!me)throw new Error("ID is required.");const Ne=l(C.modelData);if(me!==R.id&&Ne.has(me))throw new Error("Another item already uses that ID.");R.id=me;const be=(z.name||"").trim();R.name=be||R.id;const nt=(z.logo||"").trim();if(nt?R.logo=nt:delete R.logo,z.externalFlag&&!z.external)R.external=!0;else{const V=(z.external??"").toString().trim();V?R.external=V:delete R.external}const Ie=(z.color||"").trim();Ie?R.color=Ie:delete R.color;const de=wc(z.stage);return de!=null?R.stage=de:delete R.stage,R.deps=Array.isArray(z.deps)?z.deps:[],R.id!==z.originalId&&typeof ne=="function"&&ne(z.originalId,R.id),f(C.modelData,z.originalId,R.id),T(),_(),G(R.id),R.id}function He(){if(!C.fields||!C.fields.idInput)return!1;const z=(C.fields.idInput.value||"").trim(),U={originalId:C.itemId,id:z,name:C.fields.nameInput.value||"",logo:C.fields.logoInput.value||"",external:C.fields.externalInput.value||"",externalFlag:C.fields.externalFlagInput.checked,color:C.fields.colorInput.value||"",stage:C.fields.stageInput.value,deps:vc(C.fields.depsInput.value,{excludeId:z})};try{return rt(U),j(),!0}catch(ae){return console.warn("[itemEditor] item edit failed",ae),ce((ae==null?void 0:ae.message)||"Unable to save item."),!1}}function Fe(){if(C.wrapper)return C.wrapper;const z=document.createElement("div");z.className="item-editor-modal",z.hidden=!0,z.setAttribute("role","dialog"),z.setAttribute("aria-modal","true");const U=document.createElement("div");U.className="item-editor-modal__backdrop",z.appendChild(U);const ae=document.createElement("div");ae.className="item-editor",z.appendChild(ae);const R=document.createElement("div");R.className="item-editor__header";const me=document.createElement("h2");me.className="item-editor__title",me.textContent="Edit item";const Ne=document.createElement("button");Ne.type="button",Ne.className="item-editor__close",Ne.setAttribute("aria-label","Close item editor"),Ne.textContent="×",R.appendChild(me),R.appendChild(Ne),ae.appendChild(R);const be=document.createElement("form");be.className="item-editor__form",ae.appendChild(be);const nt=document.createElement("div");nt.className="item-editor__meta",nt.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',be.appendChild(nt);const Ie=document.createElement("div");Ie.className="item-editor__error",Ie.hidden=!0,be.appendChild(Ie);const de=(je,lt,y)=>{const w=document.createElement("label");w.className="item-editor__field";const pt=document.createElement("span");if(pt.className="item-editor__label",pt.textContent=je,w.appendChild(pt),lt.classList.add("item-editor__control"),w.appendChild(lt),y){const re=document.createElement("div");re.className="item-editor__hint",re.textContent=y,w.appendChild(re)}return w},ht=document.createElement("input");ht.type="text",ht.required=!0,be.appendChild(de("ID",ht,"Unique identifier used for dependencies."));const V=document.createElement("input");V.type="text",be.appendChild(de("Name",V,"Visible label shown on the tile."));const Z=document.createElement("input");Z.type="url",Z.inputMode="url",Z.placeholder="https://…",be.appendChild(de("Logo URL",Z,"Optional image URL."));const x=document.createElement("input");x.type="url",x.inputMode="url",x.placeholder="https://…",be.appendChild(de("External link",x,"Shown with ↗ icon and in preview."));const Q=document.createElement("div");Q.className="item-editor__checkbox";const Se=document.createElement("label");Se.className="item-editor__checkbox-row";const ue=document.createElement("input");ue.type="checkbox";const Ee=document.createElement("span");Ee.textContent="Mark as external without link";const Te=document.createElement("div");Te.className="item-editor__hint",Te.textContent="Keeps dashed border even without a URL.",Se.appendChild(ue),Se.appendChild(Ee),Q.appendChild(Se),Q.appendChild(Te),be.appendChild(Q);const we=document.createElement("input");we.type="text",we.placeholder=Gt.color.primary,be.appendChild(de("Color",we,"Optional badge color (hex or CSS color)."));const Ye=document.createElement("input");Ye.type="number",Ye.min=String(Ra),Ye.max=String($a),Ye.inputMode="numeric",Ye.placeholder=`${Ra}-${$a}`,be.appendChild(de("Stage",Ye,"Optional 1 (far left) to 4 (far right) when Center view is on."));const st=document.createElement("textarea");st.rows=2,st.placeholder="Comma or space separated ids",be.appendChild(de("Dependencies",st,"Use item IDs, separated by commas or spaces."));const gt=document.createElement("div");gt.className="item-editor__checkbox";const b=document.createElement("label");b.className="item-editor__checkbox-row";const ze=document.createElement("input");ze.type="checkbox";const Ct=document.createElement("span");Ct.textContent="Sync ID while editing name";const wt=document.createElement("div");wt.className="item-editor__hint",wt.textContent="Turn off to keep typing names without changing the ID.",b.appendChild(ze),b.appendChild(Ct),gt.appendChild(b),gt.appendChild(wt),be.appendChild(gt);const Ae=document.createElement("div");Ae.className="item-editor__actions";const ut=document.createElement("button");ut.type="button",ut.className="pf-v5-c-button pf-m-tertiary",ut.textContent="Cancel";const Bt=document.createElement("button");return Bt.type="submit",Bt.className="pf-v5-c-button pf-m-primary",Bt.textContent="Save",Ae.appendChild(ut),Ae.appendChild(Bt),be.appendChild(Ae),C.wrapper=z,C.fields={idInput:ht,nameInput:V,logoInput:Z,externalInput:x,externalFlagInput:ue,colorInput:we,stageInput:Ye,depsInput:st,syncCheckbox:ze,categoryValue:nt.querySelector(".item-editor__meta-value"),errorEl:Ie},ut.addEventListener("click",j),Ne.addEventListener("click",j),U.addEventListener("click",j),ht.addEventListener("input",()=>{C.autoIdManuallyEdited=!0}),V.addEventListener("input",fe),ze.addEventListener("change",()=>{C.autoSyncEnabled=!!ze.checked,C.autoSyncEnabled&&(C.autoIdManuallyEdited=!1,fe({force:!0}))}),be.addEventListener("submit",je=>{je.preventDefault(),He()}),document.addEventListener("keydown",je=>{je.key==="Escape"&&!z.hidden&&(je.preventDefault(),je.stopPropagation(),j())}),document.body.appendChild(z),z}function We(z){const U=r(z);if(!U)return!1;Fe(),C.categoryId=U.category.id,C.itemId=U.item.id,C.modelData=U.modelData,C.autoIdManuallyEdited=!1;const ae=!!X();return C.autoSyncEnabled=ae,C.fields.categoryValue.textContent=U.category.title||U.category.id,C.fields.idInput.value=U.item.id||"",C.fields.nameInput.value=U.item.name||"",C.fields.logoInput.value=U.item.logo||"",C.fields.externalInput.value=typeof U.item.external=="string"?U.item.external:"",C.fields.externalFlagInput.checked=U.item.external===!0,C.fields.colorInput.value=U.item.color||"",C.fields.stageInput.value=U.item.stage??"",C.fields.depsInput.value=Array.isArray(U.item.deps)?U.item.deps.join(", "):"",C.fields.syncCheckbox.checked=C.autoSyncEnabled,C.fields.syncCheckbox.disabled=!ae,!C.fields.idInput.value&&ae&&fe({force:!0}),ce(""),G(U.item.id),le(),!0}return{open:We,hide:j,isOpen:()=>!!C.wrapper&&!C.wrapper.hidden}}function Ec(){return typeof window<"u"&&window.Neutralino&&window.Neutralino.os&&typeof window.Neutralino.os.open=="function"}function ui(r){if(!r)return!1;if(Ec())try{return window.Neutralino.os.open(r),!0}catch(l){console.warn("[Blockscape] failed to open external url",r,l)}return window.open(r,"_blank","noopener"),!0}function kc(r){if(!r||r.startsWith("#")||/^javascript:/i.test(r))return!1;try{const l=new URL(r,window.location.href);return l.protocol==="http:"||l.protocol==="https:"?l.origin!==window.location.origin:!0}catch{return!1}}function Ic(r){try{return new URL(r,window.location.href).toString()}catch{return r}}function _c({menuEl:r,previewEl:l,previewTitleEl:f,previewBodyEl:T,previewActionsEl:_,previewCloseEl:G,escapeHtml:ne,onEditItem:q,onChangeColor:X,selectItem:C,colorPresets:ce=[]}={}){const j=r||(()=>{const V=document.createElement("div");return V.className="tile-context-menu",V.hidden=!0,V.setAttribute("aria-hidden","true"),document.body.appendChild(V),V})();let le={x:0,y:0},fe=0,rt=Array.isArray(ce)?ce:[];function He(){j&&(j.classList.remove("is-open"),j.hidden=!0,j.setAttribute("aria-hidden","true"),j.innerHTML="")}function Fe(V=[]){_&&(_.innerHTML="",V.forEach(Z=>{const x=document.createElement("button");x.type="button",x.className="item-preview__action",x.textContent=Z.label||"Action",Z.title&&(x.title=Z.title),x.addEventListener("click",Q=>{Q.stopPropagation(),typeof Z.onClick=="function"&&Z.onClick(Q)}),_.appendChild(x)}),_.hidden=V.length===0)}function We(){He(),l&&(l.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),l.setAttribute("aria-hidden","true"),l.hidden=!0,Fe([]))}function z(V,Z){l&&(le={x:V,y:Z},l.hidden=!1,l.setAttribute("aria-hidden","false"),l.classList.add("is-visible"),U(V,Z))}function U(V,Z){if(!l)return;const x=12;l.style.left=`${V+x}px`,l.style.top=`${Z+x}px`;const Q=l.getBoundingClientRect();let Se=Q.left,ue=Q.top;Q.right>window.innerWidth-x&&(Se=Math.max(x,window.innerWidth-Q.width-x)),Q.bottom>window.innerHeight-x&&(ue=Math.max(x,window.innerHeight-Q.height-x)),l.style.left=`${Se}px`,l.style.top=`${ue}px`}function ae(V,Z){var Ee;if(!V)return null;const x=V.dataset.id,Q=((Ee=V.querySelector(".name"))==null?void 0:Ee.textContent)||x||"Preview",Se=x?`${x}.html`:"",ue=Se?`items/${Se}`:"";return{id:x,displayName:Q,filename:Se,filepath:ue,externalUrl:V.dataset.externalUrl||"",obsidianUrl:V.dataset.obsidianUrl||"",anchorX:(Z==null?void 0:Z.clientX)??0,anchorY:(Z==null?void 0:Z.clientY)??0}}function R(V,Z){const x=document.createElement("button");return x.type="button",x.className="tile-context-menu__item",x.textContent=V,x.addEventListener("click",()=>{He(),typeof Z=="function"&&Z()}),x}function me(V){if(!j)return;j.innerHTML="";const Z=document.createElement("div");Z.className="tile-context-menu__list",Z.appendChild(R("File view",()=>be(V))),typeof q=="function"&&Z.appendChild(R("Edit",()=>q(V.id))),typeof X=="function"&&V.id&&rt.forEach(x=>{if(!(x!=null&&x.value))return;const Q=x.name||x.value;Z.appendChild(R(`Set color: ${Q}`,()=>X(V.id,x.value)))}),j.appendChild(Z)}function Ne(V,Z){if(!j)return;const x=4;j.style.left=`${V+x}px`,j.style.top=`${Z+x}px`,j.hidden=!1,j.setAttribute("aria-hidden","false"),j.classList.add("is-open");const Q=j.getBoundingClientRect();let Se=Q.left,ue=Q.top;Q.right>window.innerWidth-x&&(Se=Math.max(x,window.innerWidth-Q.width-x)),Q.bottom>window.innerHeight-x&&(ue=Math.max(x,window.innerHeight-Q.height-x)),j.style.left=`${Se}px`,j.style.top=`${ue}px`}async function be(V){if(!l||!f||!T||!V)return;const Z=++fe,x=[];if(typeof q=="function"&&V.id&&x.push({label:"Edit",title:"Edit this item",onClick:()=>{We(),q(V.id)}}),V.externalUrl&&x.push({label:"Open link ↗",title:V.externalUrl,onClick:()=>ui(V.externalUrl)}),V.obsidianUrl&&x.push({label:"Open in Obsidian",title:V.obsidianUrl,onClick:()=>ui(V.obsidianUrl)}),Fe(x),V.id&&typeof C=="function"&&C(V.id),f.textContent=V.displayName,T.innerHTML='<div class="item-preview__status">Loading…</div>',l.classList.remove("item-preview--has-frame"),l.classList.add("item-preview--expanded"),z(V.anchorX,V.anchorY),!V.filepath){T.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',U(le.x,le.y);return}try{const Q=await fetch(V.filepath,{cache:"no-cache"});if(!Q.ok)throw new Error(`HTTP ${Q.status}`);const Se=await Q.text();if(Z!==fe)return;if(!Se.trim()){const Te=ne?ne(V.filename):V.filename;T.innerHTML=`<div class="item-preview__status">No content in <code>${Te}</code>.</div>`,U(le.x,le.y);return}const Ee=document.createElement("iframe");Ee.className="item-preview__frame",Ee.title=`${V.displayName} details`,Ee.srcdoc=Se,T.innerHTML="",T.appendChild(Ee),l.classList.add("item-preview--has-frame"),U(le.x,le.y)}catch(Q){if(Z!==fe)return;const Se=ne?ne(V.displayName):V.displayName;T.innerHTML=`<div class="item-preview__status">No preview available for <strong>${Se}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${V.filepath}`,Q),U(le.x,le.y)}}function nt(V,Z){if(!Z)return;V.preventDefault(),V.stopPropagation();const x=ae(Z,V);!x||!x.id||(typeof C=="function"&&C(x.id),me(x),Ne(V.clientX,V.clientY))}function Ie(V){const Z=V==null?void 0:V.target,x=j&&!j.hidden&&j.contains(Z),Q=l&&!l.hidden&&l.contains(Z);!x&&!Q&&We()}function de(){!l||l.hidden||U(le.x,le.y)}function ht(){We()}return G&&G.addEventListener("click",We),{handleTileContextMenu:nt,hidePreview:We,hideMenu:He,handleDocumentClick:Ie,handleWindowResize:de,handleWindowScroll:ht,updateColorPresets:V=>{rt=Array.isArray(V)?V:[]}}}function ls(r,l="series"){return(r||l).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||l}function _n(r,l="series"){const f=ls(r,l).replace(/\./g,"-");return f.replace(/-series$/i,"").replace(/-+$/,"")||f||ls(l,"series")}function cs(r,{seriesName:l,fallbackTitle:f="unknown"}={}){var q,X;const _=[r==null?void 0:r.seriesId,(q=r==null?void 0:r.data)==null?void 0:q.seriesId,r==null?void 0:r.apicurioArtifactId,l,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(X=r==null?void 0:r.data)==null?void 0:X.title,f].map(C=>(C??"").toString().trim()),G=_.findIndex(Boolean),ne=G!==-1?_[G]:"";return ne?(console.log("[Series] deriveSeriesId: picked base",{base:ne,sourceIndex:G,candidates:_}),_n(ne,f)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:f}),null)}function Jt(r,{seriesName:l,fallbackTitle:f="unknown"}={}){if(!r||typeof r!="object")return null;const T=cs(r,{seriesName:l,fallbackTitle:f});return T?(r.seriesId=T,r.apicurioArtifactId||(r.apicurioArtifactId=T),T):null}function Dn(r,l={}){var _,G;if(!r)return null;const f=r.isSeries||((_=r.apicurioVersions)==null?void 0:_.length)>1||r.seriesId||((G=r.data)==null?void 0:G.seriesId)||r.apicurioArtifactId;if(!f&&!l.force)return null;const T=cs(r,l);return T||(f?_n(l.fallbackTitle||"unknown"):null)}const ds={selectionDimOpacity:.2,selectionDimEnabled:!0},Xn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,l=!0)=>{const f=Math.round((1-r)*100);return l?f===0?"Off":`${f}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function Qn(r){return r===!0||r==="true"||r===1||r==="1"}function Cc(r,{localBackend:l}={}){const f=l&&typeof l.getAutoReloadConfig=="function"&&l.getAutoReloadConfig(),T={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness,stripParentheticalNames:r.stripParentheticalNames};return f&&(T.autoReloadEnabled=!!f.enabled,T.autoReloadIntervalMs=f.intervalMs),T}function xc(r={},l){var y,w,pt,re;if(!r||typeof r!="object")return{applied:[]};const f=[],{applyTheme:T,applyTileHoverScale:_,persistTileHoverScale:G,applySelectionDimEnabled:ne,persistSelectionDimEnabled:q,applySelectionDimOpacity:X,persistSelectionDimOpacity:C,applyTileCompactness:ce,persistTileCompactness:j,applyTitleWrapMode:le,persistTitleWrapMode:fe,applyTitleHoverWidthMultiplier:rt,persistTitleHoverWidthMultiplier:He,applyTitleHoverTextPortion:Fe,persistTitleHoverTextPortion:We,applyLinkThickness:z,persistLinkThickness:U,applyDepColor:ae,persistDepColor:R,applyRevdepColor:me,persistRevdepColor:Ne,applyObsidianLinksEnabled:be,persistObsidianLinksEnabled:nt,applyObsidianLinkMode:Ie,persistObsidianLinkMode:de,applyObsidianVaultName:ht,persistObsidianVaultName:V,applyAutoIdFromNameEnabled:Z,persistAutoIdFromNameEnabled:x,applySeriesNavDoubleClickWait:Q,persistSeriesNavDoubleClickWait:Se,applyCenterItems:ue,persistCenterItems:Ee,applyStripParentheticalNames:Te,persistStripParentheticalNames:we,applyShowSeriesPanel:Ye,persistShowSeriesPanel:st,localBackend:gt,ui:b,refreshObsidianLinks:ze,scheduleOverlaySync:Ct,selection:wt,select:Ae,clearStyles:ut,drawLinks:Bt,applyReusedHighlights:je,current:lt}=l;if(r.theme){const At=((T==null?void 0:T(r.theme))||r.theme)==="dark";(y=l.ui)!=null&&y.themeToggle&&(l.ui.themeToggle.checked=At),(w=l.ui)!=null&&w.tabThemeToggle&&(l.ui.tabThemeToggle.checked=At),f.push("theme")}if(r.hoverScale!=null){const M=_(parseFloat(r.hoverScale));G(M),b!=null&&b.hoverScaleInput&&(b.hoverScaleInput.value=String(M)),b!=null&&b.hoverScaleValue&&(b.hoverScaleValue.textContent=Xn.hoverScale(M)),wt&&Ct(),f.push("hoverScale")}if(r.selectionDimEnabled!=null){const M=ne(Qn(r.selectionDimEnabled));q(M),b!=null&&b.selectionDimToggle&&(b.selectionDimToggle.checked=M),b!=null&&b.selectionDimInput&&(b.selectionDimInput.disabled=!M),b!=null&&b.selectionDimValue&&(b.selectionDimValue.textContent=Xn.selectionDimming(lt.selectionDimOpacity??ds.selectionDimOpacity,M)),f.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const M=X(parseFloat(r.selectionDimOpacity));C(M),b!=null&&b.selectionDimInput&&(b.selectionDimInput.value=String(M)),b!=null&&b.selectionDimValue&&(b.selectionDimValue.textContent=Xn.selectionDimming(M,lt.selectionDimEnabled??ds.selectionDimEnabled)),f.push("selectionDimOpacity")}if(r.tileCompactness!=null){const M=ce(parseFloat(r.tileCompactness));j(M),b!=null&&b.tileCompactnessInput&&(b.tileCompactnessInput.value=String(M)),b!=null&&b.tileCompactnessValue&&(b.tileCompactnessValue.textContent=Xn.compactness(M)),wt&&Ct(),f.push("tileCompactness")}if(r.titleWrapMode){const M=le(r.titleWrapMode);fe(M),b!=null&&b.titleWrapInput&&(b.titleWrapInput.checked=M!=="nowrap"),f.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const M=rt(parseFloat(r.titleHoverWidthMultiplier));He(M),b!=null&&b.titleWidthInput&&(b.titleWidthInput.value=String(M)),b!=null&&b.titleWidthValue&&(b.titleWidthValue.textContent=Xn.titleWidth(M)),f.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const M=Fe(parseFloat(r.titleHoverTextPortion));We(M),b!=null&&b.titleZoomInput&&(b.titleZoomInput.value=String(M)),b!=null&&b.titleZoomValue&&(b.titleZoomValue.textContent=Xn.titleZoomPortion(M)),f.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const M=be(Qn(r.obsidianLinksEnabled));nt(M),b!=null&&b.obsidianToggle&&(b.obsidianToggle.checked=M),(pt=b==null?void 0:b.obsidianModeInputs)==null||pt.forEach(At=>{At.disabled=!M}),b!=null&&b.obsidianVaultInput&&(b.obsidianVaultInput.disabled=!M),ze==null||ze(),f.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const M=Ie(r.obsidianLinkMode);de(M),(re=b==null?void 0:b.obsidianModeInputs)==null||re.forEach(At=>{At.checked=At.value===M}),ze==null||ze(),f.push("obsidianLinkMode")}if(r.obsidianVault!=null){const M=ht(r.obsidianVault);V(M),b!=null&&b.obsidianVaultInput&&(b.obsidianVaultInput.value=M),ze==null||ze(),f.push("obsidianVault")}if(r.colorPresets&&(typeof l.setColorPresets=="function"&&l.setColorPresets(r.colorPresets),f.push("colorPresets")),r.linkThickness){const M=z==null?void 0:z(r.linkThickness);M&&(U==null||U(M),b!=null&&b.linkThicknessInput&&(b.linkThicknessInput.value=M),f.push("linkThickness"))}if(r.stripParentheticalNames!=null){const M=Te==null?void 0:Te(Qn(r.stripParentheticalNames));we==null||we(M),b!=null&&b.stripParentheticalToggle&&(b.stripParentheticalToggle.checked=M),f.push("stripParentheticalNames")}if(r.depColor){const M=ae==null?void 0:ae(r.depColor);M&&(R==null||R(M),b!=null&&b.depColorInput&&(b.depColorInput.value=M),f.push("depColor"))}if(r.revdepColor){const M=me==null?void 0:me(r.revdepColor);M&&(Ne==null||Ne(M),b!=null&&b.revdepColorInput&&(b.revdepColorInput.value=M),f.push("revdepColor"))}if(r.autoIdFromName!=null){const M=Z(Qn(r.autoIdFromName));x(M),b!=null&&b.autoIdToggle&&(b.autoIdToggle.checked=M),f.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const M=Q(parseInt(r.seriesNavDoubleClickMs,10));Se(M),b!=null&&b.seriesNavInput&&(b.seriesNavInput.value=String(M)),b!=null&&b.seriesNavValue&&(b.seriesNavValue.textContent=Xn.seriesNavWait(M)),f.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&gt&&typeof gt.setAutoReloadEnabled=="function"){const M=Qn(r.autoReloadEnabled);gt.setAutoReloadEnabled(M),b!=null&&b.autoReloadToggle&&(b.autoReloadToggle.checked=M),b!=null&&b.autoReloadInput&&(b.autoReloadInput.disabled=!M),f.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&gt&&typeof gt.setAutoReloadInterval=="function"){const M=gt.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));b!=null&&b.autoReloadInput&&(b.autoReloadInput.value=String(M)),b!=null&&b.autoReloadValue&&(b.autoReloadValue.textContent=Xn.autoReloadInterval(M)),f.push("autoReloadIntervalMs")}if(r.centerItems!=null){const M=ue==null?void 0:ue(Qn(r.centerItems));Ee==null||Ee(M),b!=null&&b.tabCenterToggle&&(b.tabCenterToggle.checked=M),f.push("centerItems")}if(r.showSecondaryLinks!=null){const M=Qn(r.showSecondaryLinks);typeof l.setShowSecondaryLinks=="function"?l.setShowSecondaryLinks(M):l.showSecondaryLinks=M,b!=null&&b.secondaryLinksToggle&&(b.secondaryLinksToggle.checked=M),b!=null&&b.tabSecondaryLinksToggle&&(b.tabSecondaryLinksToggle.checked=M),wt?Ae(wt):(ut(),Bt()),f.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const M=Qn(r.showReusedInMap);typeof l.setShowReusedInMap=="function"?l.setShowReusedInMap(M):l.showReusedInMap=M,b!=null&&b.reusedToggle&&(b.reusedToggle.checked=M),je==null||je(),f.push("showReusedInMap")}return{applied:f}}function Tc(r,l){const f=new Blob([l],{type:"application/json"}),T=URL.createObjectURL(f),_=document.createElement("a");_.href=T,_.download=r,_.click(),URL.revokeObjectURL(T)}const Yi=typeof{url:Vn&&Vn.tagName.toUpperCase()==="SCRIPT"&&Vn.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function Ac(r={}){console.log("[Blockscape] init");const l={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},f=document.getElementById("jsonBox"),T=document.querySelector(".blockscape-json-panel"),_=document.getElementById("app"),G=document.getElementById("overlay"),ne=document.getElementById("tabTooltip"),q=document.getElementById("modelList"),X=document.getElementById("itemPreview"),C=document.getElementById("urlForm"),ce=document.getElementById("urlInput"),j=document.getElementById("loadUrl"),le=X.querySelector(".item-preview__title"),fe=X.querySelector(".item-preview__body"),rt=X.querySelector(".item-preview__actions"),He=X.querySelector(".item-preview__close"),Fe=document.getElementById("downloadJson"),We=document.getElementById("shareModel"),z=document.getElementById("createVersion"),U=document.getElementById("openInEditor"),ae=document.getElementById("copyJson"),R=document.getElementById("copySeries"),me=document.getElementById("pasteJson"),Ne=document.getElementById("helpButton"),be=document.getElementById("newPanelButton"),nt=document.getElementById("newBlankButton"),Ie=document.getElementById("shortcutHelp"),de=document.getElementById("shortcutHelpList"),ht=document.getElementById("shortcutHelpClose"),V=document.getElementById("shortcutHelpBackdrop"),Z=document.getElementById("newPanel"),x=document.getElementById("newPanelClose"),Q=document.getElementById("newPanelBackdrop"),Se=document.getElementById("search"),ue=document.getElementById("searchResults"),Ee=document.getElementById("localBackendPanel"),Te=document.getElementById("localBackendStatus"),we=document.getElementById("localFileList"),Ye=document.getElementById("localDirSelect"),st=document.getElementById("refreshLocalFiles"),gt=document.getElementById("loadLocalFile"),b=document.getElementById("deleteLocalFile"),ze=document.getElementById("toggleServerSidebar"),Ct=document.getElementById("saveLocalFile"),wt=document.getElementById("saveLocalFileAs"),Ae=document.getElementById("localSavePath"),ut="blockscape:editorPayload",Bt="blockscape:editorTransfer",je="blockscape:serverSidebarWide",lt=document.title;Ee&&(Ee.hidden=!0),!l.localBackend&&Ee&&(Ee.hidden=!0),l.fileOpen||(gt&&(gt.hidden=!0),Ye&&(Ye.hidden=!0),st&&(st.hidden=!0),b&&(b.hidden=!0),we&&(we.hidden=!0)),l.fileSave||(Ct&&(Ct.hidden=!0),wt&&(wt.hidden=!0),Ae&&(Ae.hidden=!0)),f.value=document.getElementById("seed").textContent.trim();let y=[],w=-1;const pt=gc({models:y,getActiveIndex:()=>w,setActive:$t,ensureModelMetadata:Pn,getModelId:kt,getSeriesId:Dn,ensureSeriesId:Jt,getModelTitle:Xe,computeJsonFingerprint:sa,uid:uo});let re=null,M=new Map,At=new Map,K=null,ot=null,ft=null,bt=null,Cn=!0,xn=!1,Tn=!1,Kt="map",Pt=null,gn=null,cn=!1,Un=null;const so=2e3;let tn=null,Ft=null,An=null,Wt=null,dn=null,qt=null,Ln=null,d=null,v=null,B="",N=!1,k=null;const D=new Map;let ee=null,J=null,ke=[],he=null;const Le=30,Ge=1e3,mt="blockscape:hoverScale",xe=1.5,It=1,jt=2.5,vt="blockscape:selectionDimOpacity",Be="blockscape:selectionDimEnabled",qe=.2,Yt=.05,Ze=1,xt="blockscape:titleWrap",St="blockscape:titleHoverWidth",yt="blockscape:titleHoverTextPortion",Rt="wrap",pn=1.3,_e=1,it=1.6,pi=.25,ms=0,hs=.6,gs="blockscape:tileCompactness",fi=1,bs=.75,ws=1.25,vs="blockscape:obsidianLinksEnabled",ys="blockscape:obsidianLinkMode",Ss="blockscape:obsidianVault",Oa="title",Zi="id",Xi=Oa,Es="blockscape:autoReloadEnabled",ks="blockscape:autoReloadIntervalMs",mi=1e3,Is=500,_s=1e4,Cs="blockscape:autoIdFromName",Qi=!0,xs="blockscape:stripParentheticalNames",ea=!0,Ts="blockscape:colorPresets",As="blockscape:centerItems",Ls="blockscape:theme",Ns=4,To=1,ta=4,Ms="0.2rem",Ao="light",lo="dark",na="cat:",oa=!1,Bs="blockscape:depColor",Ps="blockscape:revdepColor",Rs="blockscape:linkThickness",$s=6,Os={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let Lo=xe,Hn=qe,Fn=!0,No=fi,Va=Rt,Mo=pn,Bo=pi,Po=!1,hi=Xi,Ro="",co=Qi,gi=ea,bi=Ao,nn=[],Et=oa,ia="",aa="",wi="m",$o=null,Da=null;const Vs="blockscape:seriesNavDoubleClickMs",vi=900,Ds=300,Us=4e3;let Wn=vi,eo=!0;const ge={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSeriesPanelToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null,stripParentheticalToggle:null};let Oo=null;const Jc={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:mi}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},Qe=l.localBackend?vd():Jc,Hs=l.localBackend?Qe.detect():Promise.resolve(!1);pt.hydrateConfig(),Ha(ed()),Uo(ld(),{silent:!0}),od(),id(),sd(),Md(),Bd(),$d(),Dd(),Od(),Vd(),jd(),Yd(),Gd(),Zd(),Pd(),Rd(),qd(),nd(),an();function uo(){return Math.random().toString(36).slice(2,10)}function Kc(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function qc(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function Yc(e){return Kc(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Zc(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),qc(t)}const Fs=(e,t)=>Tc(e,t);function Ua(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function Xc(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await Fl(i),s=JSON.parse(a),c=Ua(s);if(c)return c}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function Qc(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];l.initialSettings&&t.push({type:"inline",snapshot:l.initialSettings}),l.initialSettingsUrl&&t.push({type:"url",url:l.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?Ua(o.snapshot):await Xc(o.url);if(!i)continue;const a=Ya(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function ed(){if(typeof window>"u"||!window.localStorage)return Ao;try{return window.localStorage.getItem(Ls)===lo?lo:Ao}catch{return Ao}}function td(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ls,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function Ha(e){const t=e===lo?lo:Ao;return bi=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),td(t),bi}function Ws(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(As,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function Vo(e){return Et=!!e,_&&(_.classList.toggle("is-center-mode",Et),_.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",Et)}),_.querySelectorAll(".tile-add").forEach(t=>{t.hidden=Et,t.tabIndex=Et?-1:0,t.setAttribute("aria-hidden",Et?"true":"false")}),_.querySelectorAll(".category-add").forEach(t=>{t.hidden=Et,t.tabIndex=Et?-1:0,t.setAttribute("aria-hidden",Et?"true":"false")})),zs(),js(),re&&(ma(),Nn()),Et}function nd(){if(typeof window>"u"||!window.localStorage)return Vo(oa);try{const e=window.localStorage.getItem(As);return e==null?Vo(oa):Vo(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),Vo(oa)}}function yi(e){if(e==null)return null;const t=Number(e);if(!Number.isFinite(t))return null;const n=Math.round(t);return n<To||n>ta?null:n}function js(){if(!_)return;const e=`repeat(${Ns}, minmax(var(--blockscape-tile), 1fr))`;_.querySelectorAll(".grid").forEach(t=>{const n=Array.from(t.querySelectorAll(".tile[data-stage]")).map((m,S)=>({tile:m,stage:yi(m.dataset.stage),order:S})),o=n.some(m=>m.stage),i=Et&&o;i?(t.style.gridTemplateColumns=e,t.style.gridAutoFlow="row",t.style.justifyContent="space-between",t.style.justifyItems="start",t.style.columnGap=Ms,t.style.rowGap=Ms):(t.style.removeProperty("grid-template-columns"),t.style.removeProperty("grid-auto-flow"),t.style.removeProperty("justify-content"),t.style.removeProperty("justify-items"),t.style.removeProperty("column-gap"),t.style.removeProperty("row-gap"));const a=m=>{m.style.removeProperty("grid-column"),m.style.removeProperty("grid-row")};if(t.querySelectorAll(".tile").forEach(a),!i)return;const s=n.filter(m=>m.stage).sort((m,S)=>m.stage!==S.stage?m.stage-S.stage:m.order-S.order),c=(m,S,O)=>{if(S.has(m)&&S.get(m)===O)return{col:m,needsNewRow:!0};const A=Ns-1;for(let L=0;L<=A;L+=1){const $=[];m-L>=To&&$.push(m-L),L!==0&&m+L<=ta&&$.push(m+L);for(const te of $)if(!S.has(te))return{col:te,needsNewRow:!1}}return{col:null,needsNewRow:!1}};let u=1,h=new Map;s.forEach(({tile:m,stage:S})=>{let O=c(S,h,S);O.needsNewRow&&(u+=1,h=new Map,O=c(S,h,S)),O.col!=null&&(h.set(O.col,S),m.style.gridColumn=String(O.col),m.style.gridRow=String(u))})}),zs()}function zs(){Da&&(Da.hidden=!Et)}function Do(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Gs(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function Fa(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function Js(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=Do(i[1]);if(a)return Fa(a,n);if(t){const s=Do(t);if(s)return Fa(s,n)}}return Fa(o,n)}function Ks(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function Wa(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Bs,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function ja(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ps,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function za(e){const t=Js(e,{fallbackVar:"--color-primary",fallbackColor:Gt.color.primary});return ia=t,Gs("--blockscape-dep",t),G&&Nn(),ia}function Ga(e){const t=Js(e,{fallbackVar:"--color-danger",fallbackColor:Gt.blockscape.revdep});return aa=t,Gs("--blockscape-revdep",t),G&&Nn(),aa}function od(){const e=Ks(Bs),t=za(e||Do("--blockscape-dep")||Gt.color.primary);return Wa(t),t}function id(){const e=Ks(Ps),t=Ga(e||Do("--blockscape-revdep")||Gt.blockscape.revdep);return ja(t),t}function ad(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function rd(){return Os[wi]||Os.m}function Si(e){return wi=ad(e),Nn(),wi}function Ja(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Rs,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function sd(){if(typeof window>"u"||!window.localStorage)return Si("m");try{const e=window.localStorage.getItem(Rs),t=Si(e||"m");return Ja(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),Si("m")}}function qs(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return Ei();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:Ei()}function Ei(){return[{name:"Black",value:Gt.color.ink},{name:"White",value:Gt.color.white},{name:"Red",value:Gt.blockscape.revdep},{name:"Green",value:Gt.color.success}]}function ld(){if(typeof window>"u"||!window.localStorage)return Ei();try{const e=window.localStorage.getItem(Ts);if(!e)return Ei();const t=JSON.parse(e);return qs(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),Ei()}}function cd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ts,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function Uo(e,{silent:t=!1}={}){return nn=qs(e),cd(nn),!t&&typeof ti=="function"&&ti(nn),$o==null||$o(),nn}function dd(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function ra(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=po(e);if(!o)return;const i=y[w],a=po(i==null?void 0:i.sourcePath),s=t??(a&&a===o?kt(i):null),c=n??(a&&a===o?K:null),u=o.split("/").filter(Boolean).map(S=>encodeURIComponent(S)),h=s?encodeURIComponent(s):null,m=c?encodeURIComponent(c):null;try{const S=new URL(window.location.href),O=new URLSearchParams(S.search);O.delete("load"),O.delete("share");const A=["","server",...u,...h?[h]:[],...m?[m]:[]].join("/").replace(/\/+/g,"/");S.pathname=A,S.search=O.toString()?`?${O.toString()}`:"",S.hash="",window.history.replaceState({},document.title,S.toString())}catch(S){console.warn("[Blockscape] failed to update URL for server path",S)}}function ud(e,{origin:t}={}){if(!(typeof window>"u"||!e))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-path",{detail:{path:e,origin:t}}))}catch(n){console.warn("[Blockscape] failed to notify local save path",n)}}function pd({origin:e}={}){if(!(typeof window>"u"))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-clear",{detail:{origin:e}}))}catch(t){console.warn("[Blockscape] failed to notify local save clear",t)}}function fd(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex($=>$.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex($=>$.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),c=i.slice(a+1),u=$=>{try{return decodeURIComponent($)}catch{return $}},h=s.map(u),m=c.map(u),S=h.join("/"),O=po(S);if(!O)return null;const A=m[0]?m[0].trim():null,L=m[1]?m[1].trim():null;return{path:O,modelId:A||null,itemId:L||null}}function md(){if(!(typeof window>"u"||!window.location))try{const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(c=>c.toLowerCase()==="server");if(o===-1)return;const i=n.slice(0,o),a=new URLSearchParams(e.search);a.delete("load"),a.delete("share");const s=i.length?`/${i.join("/")}`:"/";e.pathname=s.replace(/\/+/g,"/"),e.search=a.toString()?`?${a.toString()}`:"",e.hash="",window.history.replaceState({},document.title,e.toString())}catch(e){console.warn("[Blockscape] failed to clear server path from URL",e)}}function Ka({itemId:e}={}){const t=y[w];if(!(t!=null&&t.sourcePath)){md();return}ra(t.sourcePath,{modelId:kt(t),itemId:e===void 0?K:e})}function hd(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function gd(){if(typeof window>"u"||!window.localStorage)return!0;try{const e=window.localStorage.getItem(je);return e==null?!0:e==="true"}catch{return!0}}function bd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(je,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist sidebar width",t)}}function Ys(e){var t;typeof document>"u"||((t=document.body)==null||t.classList.toggle("blockscape-server-sidebar-wide",!!e),ze&&(ze.setAttribute("aria-pressed",e?"true":"false"),ze.textContent=e?"<":">",ze.title=e?"Switch to thin menu":"Switch to wide menu"))}function wd(e){if(!ze||(ze.hidden=!e,!e))return;let t=gd();Ys(t),ze.onclick=()=>{t=!t,bd(t),Ys(t)}}function vd(){var si;const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(I,F={}){console.log("[Blockscape][local-backend]",I,{...e(),...F})}if(hd())return t("Disabled on github.io host"),Ee&&(Ee.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};const n=dd();if(n&&typeof document<"u"&&((si=document.body)==null||si.classList.add("blockscape-server-mode")),wd(n),!n||!Ee||!Te)return t("Opt-in flag missing or panel unavailable"),Ee&&(Ee.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!Ee||!Te)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],c="",u=new Map,h=$(),m=Pe(),S=null,O=!1;const A=new Set;function L(){return A.size>0}function $(){if(typeof window>"u"||!window.localStorage)return!0;try{const I=window.localStorage.getItem(Es);return I==null?!0:I==="true"}catch{return!0}}function te(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Es,I?"true":"false")}catch(F){console.warn("[Blockscape] auto-reload: failed to persist",F)}}function Pe(){if(typeof window>"u"||!window.localStorage)return mi;try{const I=window.localStorage.getItem(ks);if(!I)return mi;const F=parseInt(I,10);return ye(F)}catch{return mi}}function ct(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ks,String(I))}catch(F){console.warn("[Blockscape] auto-reload: failed to persist interval",F)}}function ye(I){return Number.isFinite(I)?Math.min(_s,Math.max(Is,I)):mi}function Oe(I){if(!I)return"";const F=I.split("/").filter(Boolean);return F.pop(),F.join("/")}function Re(I,{error:F=!1}={}){Te.textContent=I,Te.style.color=F?Gt.color.dangerStrong:"",t("Status",{text:I,error:F})}function at(I){return po(I)}function Zt(I){const F=da(I);return F?{payload:F,isSeries:!0}:{payload:I==null?void 0:I.data,isSeries:!1}}function Vt(){var F;if(w>=0&&((F=y[w])!=null&&F.sourcePath))return y[w].sourcePath;if(w<0)return"blockscape.bs";const I=Xe(y[w])||"blockscape";return`${_n(I,"blockscape")}.bs`}function et(){var F;if(!Ae)return;Ae.placeholder=Vt();const I=(F=y[w])==null?void 0:F.sourcePath;if(I){Ae.value=I;return}Ae.value&&(Ae.value="")}function dt(){if(!Ye)return;Ye.innerHTML="";const I=document.createElement("option");I.value="",I.textContent="Root (~/blockscape)",Ye.appendChild(I),s.forEach(oe=>{const ve=document.createElement("option");ve.value=oe,ve.textContent=oe||"(root)",Ye.appendChild(ve)});const F=s.includes(c)?c:"";Ye.value=F,c=F}function zt(){if(!we)return;we.innerHTML="";const I=a.filter(F=>Oe(F.path)===c);if(!I.length){const F=document.createElement("option");F.disabled=!0,F.textContent="No .bs files found yet",we.appendChild(F),we.disabled=!0;return}we.disabled=!1,I.forEach(F=>{const oe=document.createElement("option");oe.value=F.path;const ve=F.mtimeMs?new Date(F.mtimeMs).toLocaleString():"";oe.textContent=ve?`${F.path} · ${ve}`:F.path,we.appendChild(oe)}),i&&Array.from(we.options).forEach(F=>{F.value===i&&(F.selected=!0)}),!we.value&&we.options.length&&(we.options[0].selected=!0)}function bn(I){if(!o||!we)return;if(!I){i="",Array.from(we.options).forEach(tt=>{tt.selected=!1}),Ae&&(Ae.value="");return}if(!a.find(tt=>tt.path===I))return;const oe=Oe(I);oe!==c&&(c=oe,dt()),zt(),Array.from(we.options).forEach(tt=>{tt.selected=tt.value===I});const ve=Array.from(we.options).find(tt=>tt.value===I);ve!=null&&ve.scrollIntoView&&ve.scrollIntoView({block:"nearest"}),Ae&&(Ae.value=I)}function mn(){S&&(clearInterval(S),S=null)}function Tt(){mn(),!(!o||!h||L())&&(S=setInterval(Ve,m))}function un(I){if(!I)return;const F=A.size;A.add(I),A.size!==F&&(t("Auto-reload paused",{reason:I}),Tt())}function rn(I){if(!I)return;A.delete(I)&&(t("Auto-reload resumed",{reason:I}),Tt())}async function sn(I){const F=y.findIndex(oe=>oe.sourcePath===I);if(F!==-1)try{const oe=await fetch(`/api/file?path=${encodeURIComponent(I)}`,{cache:"no-store"});if(!oe.ok)throw new Error(`HTTP ${oe.status}`);const ve=await oe.json(),tt=JSON.stringify(ve.data??ve,null,2),Je=zn(tt,I,{seriesTitleOverride:`${I} series`});if(!Je.length)return;const ie=Je[0];if(ie.sourcePath=I,Pn(ie,{titleHint:Xe(y[F]),idHint:kt(y[F])}),ie.isSeries){const De=ie.title||Xe(ie)||Xe(y[F]),Dt=_n(De||"unknown");fo(ie,Dt),Jt(ie,{seriesName:De||"unknown",fallbackTitle:"unknown"})}y[F]={...y[F],...ie,title:ie.title||Xe(ie),data:ie.data,sourcePath:I},F===w?(Ot(),Nt()):jn(),console.log("[Blockscape] auto-reloaded model from",I)}catch(oe){console.warn("[Blockscape] auto-reload failed for",I,oe)}}async function Ve(){if(!(!o||!h||L()||O)){O=!0;try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);const oe=((await I.json()).files||[]).slice().sort((ie,De)=>{const Dt=(ie==null?void 0:ie.mtimeMs)||0,Xt=(De==null?void 0:De.mtimeMs)||0;return Dt===Xt?(ie.path||"").localeCompare(De.path||""):Xt-Dt}),ve=new Map;oe.forEach(ie=>ve.set(ie.path,ie.mtimeMs||0));const tt=y.map((ie,De)=>({path:ie.sourcePath,idx:De})).filter(ie=>ie.path);for(const ie of tt){const De=u.get(ie.path)||0;(ve.get(ie.path)||0)>De&&await sn(ie.path)}a=oe;const Je=new Set;a.forEach(ie=>Je.add(Oe(ie.path))),s=Array.from(Je).filter(ie=>ie!=="").sort(),u=ve,dt(),zt()}catch(I){console.warn("[Blockscape] auto-reload check failed",I)}finally{O=!1}}}function ai(I){h=!!I,te(h),Tt()}function wo(I){return m=ye(I),ct(m),Tt(),m}function hn(I){o=!1,a=[],u=new Map,mn(),zt(),Ee.hidden=!0,I&&Re(I,{error:!0}),t("Panel hidden",{message:I})}async function vo({silent:I=!1}={}){try{t("Health check start");const F=await fetch("/api/health",{cache:"no-store"});if(!F.ok)throw new Error(`HTTP ${F.status}`);const oe=await F.json();if(o=!!(oe!=null&&oe.ok),!o)throw new Error("Health check failed");return Ee.hidden=!1,I||Re(oe.root?`Local server ready (root: ${oe.root})`:"Local server ready"),t("Health check ok",{payload:oe}),!0}catch(F){return I||console.log("[Blockscape] local backend health failed",F),hn("Local server unavailable"),!1}}async function wn(){if(o&&we){Re("Loading files…");try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);a=((await I.json()).files||[]).slice().sort((Je,ie)=>{const De=(Je==null?void 0:Je.mtimeMs)||0,Dt=(ie==null?void 0:ie.mtimeMs)||0;return De===Dt?(Je.path||"").localeCompare(ie.path||""):Dt-De});const oe=new Set;a.forEach(Je=>{oe.add(Oe(Je.path))}),s=Array.from(oe).filter(Je=>Je!=="").sort(),c&&!oe.has(c)&&(c=""),!c&&i&&(c=Oe(i)),u=new Map(a.map(Je=>[Je.path,Je.mtimeMs||0])),dt(),zt();const ve=a.filter(Je=>Oe(Je.path)===c).length,tt=c?`~/blockscape/${c}`:"~/blockscape";Re(ve?`Browsing ${ve} file(s) in ${tt}`:`No .bs files in ${tt} yet`)}catch(I){console.warn("[Blockscape] local backend refresh failed",I),hn("Local server unavailable")}}}async function ba(){o=!1,hn(),Re("Checking for local server…");try{return t("Detect start"),await vo()?(et(),await wn(),Tt(),!0):!1}catch(I){return o=!1,console.log("[Blockscape] local backend not detected",I),t("Detect failed",{err:I}),!1}}async function yo(){if(!o||!we)return;const I=Array.from(we.selectedOptions||[]).map(oe=>oe.value).filter(Boolean).sort((oe,ve)=>oe.localeCompare(ve));if(!I.length){alert("Select one or more files to load from ~/blockscape.");return}let F=null;for(const oe of I)try{Re(`Loading ${oe}…`);const ve=await Zs(oe);F==null&&(F=(ve==null?void 0:ve.firstIndex)??null),i=oe,ra(oe)}catch(ve){console.error("[Blockscape] failed to load from local server",ve),alert(`Local load failed for ${oe}: ${ve.message}`)}F!=null&&$t(F),Re(`Loaded ${I.length} file(s)`),zt()}async function Ai(){if(!o||!we)return;const I=Array.from(we.selectedOptions||[]).map(ie=>ie.value).filter(Boolean).sort((ie,De)=>ie.localeCompare(De));if(!I.length){alert("Select one or more files to delete from ~/blockscape.");return}const F=I.length,oe=F===1?I[0]:`${F} file(s)`,ve=F===1?`Delete "${oe}" from ~/blockscape? This cannot be undone.`:`Delete ${oe} from ~/blockscape? This cannot be undone.`;if(!window.confirm(ve))return;const tt="local-files-delete";un(tt);const Je=[];try{Re(`Deleting ${oe}…`);for(const ie of I)try{const De=await fetch(`/api/file?path=${encodeURIComponent(ie)}`,{method:"DELETE"});if(!De.ok)throw new Error(`HTTP ${De.status}`);ie===i&&(i=""),(Ae==null?void 0:Ae.value)===ie&&(Ae.value="")}catch(De){Je.push(ie),console.warn("[Blockscape] local delete failed",ie,De)}await wn(),Je.length?Re(`Deleted ${F-Je.length} file(s), ${Je.length} failed`,{error:!0}):Re(`Deleted ${F} file(s)`)}finally{rn(tt)}}async function ri(I,{statusPrefix:F="Saved to",updateInput:oe=!0}={}){if(!o)return;if(w<0){alert("No active model to save.");return}const ve=y[w],{payload:tt,isSeries:Je}=Zt(ve);if(!tt){alert("No model data to save.");return}const ie=at(I);if(!ie){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const De=JSON.stringify(tt,null,2);Re(`Saving ${Je?"series":"map"} to ${ie}…`);const Xt=await fetch(`/api/file?path=${encodeURIComponent(ie)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:De});if(!Xt.ok)throw new Error(`HTTP ${Xt.status}`);const ln=await Xt.json();i=ln.path||ie,ve.sourcePath=ln.path||ie,oe&&Ae&&(Ae.value=ln.path||ie),ra(ln.path||ie),Re(`${F} ${ln.path||ie}`),await wn()}catch(De){console.error("[Blockscape] local save failed",De),alert(`Local save failed: ${De.message}`),hn("Local server unavailable")}}async function to(){var F;const I=at(Ae==null?void 0:Ae.value)||at((F=y[w])==null?void 0:F.sourcePath)||Vt();if(!I){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await ri(I,{statusPrefix:"Saved to"})}async function Li(){var ve;if(!o)return;if(w<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const I=at((ve=y[w])==null?void 0:ve.sourcePath)||Vt(),F=window.prompt("Save active map as (under ~/blockscape):",I);if(F==null)return;const oe=at(F);if(!oe){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await ri(oe,{statusPrefix:"Saved to"})}async function Ni(I,F,{refreshAfter:oe=!0,statusPrefix:ve="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(I)||I<0)return{ok:!1,error:"Invalid model index"};const tt=y[I],{payload:Je,isSeries:ie}=Zt(tt);if(!Je)return{ok:!1,error:"Model has no data"};const De=at(F)||at(tt==null?void 0:tt.sourcePath)||Vt();if(!De)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const Dt=JSON.stringify(Je,null,2);Re(`Saving ${ie?"series":"map"} to ${De}…`);const ln=await fetch(`/api/file?path=${encodeURIComponent(De)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:Dt});if(!ln.ok)throw new Error(`HTTP ${ln.status}`);const $n=await ln.json();return i=$n.path||De,tt.sourcePath=$n.path||De,I===w&&et(),Re(`${ve} ${$n.path||De}`),oe&&await wn(),{ok:!0,path:$n.path||De}}catch(Dt){return console.error("[Blockscape] local save failed",Dt),hn("Local server unavailable"),{ok:!1,error:Dt.message}}}if(st&&(st.onclick=()=>wn()),gt&&(gt.onclick=()=>yo()),b&&(b.onclick=()=>Ai()),Ct&&(Ct.onclick=()=>to()),wt&&(wt.onclick=()=>Li()),we&&Ae&&(we.addEventListener("change",()=>{const I=Array.from(we.selectedOptions||[])[0];I!=null&&I.value&&(Ae.value=I.value)}),we.addEventListener("dblclick",()=>{yo()})),Ye&&Ye.addEventListener("change",()=>{c=Ye.value||"",zt()}),Ee){const I="local-files-panel-focus",F="local-files-panel-pointer";let oe=!1,ve=!1;Ee.addEventListener("focusin",()=>{oe||(oe=!0,un(I))}),Ee.addEventListener("focusout",tt=>{if(!oe)return;const Je=tt.relatedTarget;Je&&Ee.contains(Je)||(oe=!1,rn(I))}),Ee.addEventListener("pointerenter",()=>{ve||(ve=!0,un(F))}),Ee.addEventListener("pointerleave",()=>{ve&&(ve=!1,rn(F))})}return{detect:ba,refresh:wn,updateActiveSavePlaceholder:et,isAvailable:()=>o,highlightSource:bn,saveModelByIndex:Ni,getAutoReloadConfig:()=>({enabled:h,intervalMs:m,available:o}),setAutoReloadEnabled:ai,setAutoReloadInterval:wo}}async function Zs(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=zn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let c=null;return s.forEach((u,h)=>{if(u.sourcePath=e,u.isSeries&&!u.title){const O=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");u.title=O}const m=Rn(u,{versionLabel:s.length>1?`${t} #${h+1}`:t});c==null&&(c=m)}),{firstIndex:c,total:s.length}}async function Xs(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function yd(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function on(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function po(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function Sd(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Ed(e,t){const n=po(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function qa(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function ki(){try{await Hs}catch{}return typeof(Qe==null?void 0:Qe.isAvailable)=="function"?Qe.isAvailable():!1}async function kd(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Id(e,t){const n=po(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const c=`${a}-${s}.bs`,u=[...o,c].filter(Boolean).join("/");if(!t.has(u))return u}return null}function _d(e,t="clipboard"){const n=Xe(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=on(n),i=qa();return`${o}-${i}.bs`}function Cd(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=Sd(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=_n(n||"unknown");return fo(e,o),Jt(e,{seriesName:n,fallbackTitle:n}),!0}function xd(e){return Number.isFinite(e)?Math.min(jt,Math.max(It,e)):xe}function an(){if(!_)return;const e=!!K||!!ot;_.classList.toggle("blockscape-has-selection",e),_.classList.toggle("blockscape-has-item-selection",!!K)}function Ho(e){return Lo=xd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",Lo),Lo}function Td(e){return Number.isFinite(e)?Math.min(Ze,Math.max(Yt,e)):qe}function Fo(e){Hn=Td(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Hn);const t=Fn?Hn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Hn}function Ad(e){return Number.isFinite(e)?Math.min(ws,Math.max(bs,e)):fi}function Wo(e){return No=Ad(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",No),No}function Ld(e){return Number.isFinite(e)?Math.min(it,Math.max(_e,e)):pn}function jo(e){return Mo=Ld(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",Mo),Mo}function Nd(e){return Number.isFinite(e)?Math.min(hs,Math.max(ms,e)):pi}function zo(e){return Bo=Nd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Bo),Bo}function Go(e){const t=e==="nowrap"?"nowrap":"wrap";Va=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function Qs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(mt,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function Md(){if(typeof window>"u"||!window.localStorage)return Ho(xe);try{const e=window.localStorage.getItem(mt);if(!e)return Ho(xe);const t=parseFloat(e);return Ho(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Ho(xe)}}function el(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(vt,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function Bd(){if(typeof window>"u"||!window.localStorage)return Fo(qe);try{const e=window.localStorage.getItem(vt);if(!e)return Fo(qe);const t=parseFloat(e);return Fo(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Fo(qe)}}function Jo(e){Fn=!!e;const t=Fn?Hn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),_&&_.classList.toggle("blockscape-dimming-disabled",!Fn),Fn}function tl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Be,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function Pd(){if(typeof window>"u"||!window.localStorage)return Jo(!0);try{const e=window.localStorage.getItem(Be);return e==null?Jo(!0):Jo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),Jo(!0)}}function Ko(e){return co=!!e,co}function nl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Cs,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function Rd(){if(typeof window>"u"||!window.localStorage)return Ko(Qi);try{const e=window.localStorage.getItem(Cs);return e==null?Ko(Qi):Ko(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Ko(Qi)}}function ol(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(gs,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function $d(){if(typeof window>"u"||!window.localStorage)return Wo(fi);try{const e=window.localStorage.getItem(gs);if(!e)return Wo(fi);const t=parseFloat(e);return Wo(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Wo(fi)}}function il(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(St,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function Od(){if(typeof window>"u"||!window.localStorage)return jo(pn);try{const e=window.localStorage.getItem(St);if(!e)return jo(pn);const t=parseFloat(e);return jo(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),jo(pn)}}function al(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(yt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function Vd(){if(typeof window>"u"||!window.localStorage)return zo(pi);try{const e=window.localStorage.getItem(yt);if(!e)return zo(pi);const t=parseFloat(e);return zo(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),zo(pi)}}function rl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(xt,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function Dd(){if(typeof window>"u"||!window.localStorage)return Go(Rt);try{const e=window.localStorage.getItem(xt);return Go(e||Rt)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Go(Rt)}}function Ud(e){return Number.isFinite(e)?Math.min(Us,Math.max(Ds,e)):vi}function qo(e){return Wn=Ud(e),Wn}function Hd(e){Cn=!!e}function Fd(e){Tn=!!e}function sl(e){return eo=e!==!1,Oo&&(Oo.hidden=!eo,Oo.style.display=eo?"":"none"),ge.tabSeriesPanelToggle&&(ge.tabSeriesPanelToggle.checked=eo),eo}function ll(){return{hoverScale:Lo,selectionDimOpacity:Hn,selectionDimEnabled:Fn,tileCompactness:No,titleWrapMode:Va,titleHoverWidthMultiplier:Mo,titleHoverTextPortion:Bo,obsidianLinksEnabled:Po,obsidianLinkMode:hi,obsidianVaultName:Ro,autoIdFromNameEnabled:co,seriesNavDoubleClickWaitMs:Wn,showSecondaryLinks:Cn,stripParentheticalNames:gi,centerItems:Et,showReusedInMap:Tn,theme:bi,colorPresets:nn,depColor:ia,revdepColor:aa,linkThickness:wi}}function Ya(e,{refreshObsidianLinks:t}={}){return xc(e,{applyTileHoverScale:Ho,persistTileHoverScale:Qs,applySelectionDimEnabled:Jo,persistSelectionDimEnabled:tl,applySelectionDimOpacity:Fo,persistSelectionDimOpacity:el,applyTileCompactness:Wo,persistTileCompactness:ol,applyTitleWrapMode:Go,persistTitleWrapMode:rl,applyTitleHoverWidthMultiplier:jo,persistTitleHoverWidthMultiplier:il,applyTitleHoverTextPortion:zo,persistTitleHoverTextPortion:al,applyObsidianLinksEnabled:Zo,persistObsidianLinksEnabled:pl,applyObsidianLinkMode:Yo,persistObsidianLinkMode:ul,applyObsidianVaultName:Qo,persistObsidianVaultName:fl,applyAutoIdFromNameEnabled:Ko,persistAutoIdFromNameEnabled:nl,applySeriesNavDoubleClickWait:qo,persistSeriesNavDoubleClickWait:dl,localBackend:Qe,ui:ge,refreshObsidianLinks:t,scheduleOverlaySync:go,selection:K,select:Lt,clearStyles:ga,drawLinks:Nn,applyReusedHighlights:dr,setShowSecondaryLinks:Hd,setShowReusedInMap:Fd,applyDepColor:za,persistDepColor:Wa,applyRevdepColor:Ga,persistRevdepColor:ja,applyLinkThickness:Si,persistLinkThickness:Ja,applyStripParentheticalNames:Xo,persistStripParentheticalNames:Za,applyTheme:Ha,setColorPresets:Uo,applyCenterItems:Vo,persistCenterItems:Ws,current:ll()})}const cl=()=>({version:1,exportedAt:new Date().toISOString(),settings:Cc(ll(),{localBackend:Qe})}),Wd=e=>{const t=Ua(e);return Ya(t||{})};typeof window<"u"&&(window.__blockscapeSettingsBridge={exportPayload:cl,applyPayload:Wd});function dl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Vs,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function jd(){if(typeof window>"u"||!window.localStorage)return qo(vi);try{const e=window.localStorage.getItem(Vs);if(!e)return qo(vi);const t=parseInt(e,10);return qo(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),qo(vi)}}function zd(e){return e===Zi?Zi:Oa}function Yo(e){return hi=zd(e),hi}function ul(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ys,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function Gd(){if(typeof window>"u"||!window.localStorage)return Yo(Xi);try{const e=window.localStorage.getItem(ys);return Yo(e||Xi)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Yo(Xi)}}function Zo(e){return Po=!!e,Po}function Jd(e){const t=(e??"").toString();return t.replace(/\s*\([^)]*\)\s*$/,"").trim()||t.trim()}function Ii(e){const t=(e&&typeof e=="object"?e.name||e.id:e)||"";return gi?Jd(t):t}function Kd(){if(_&&(_.querySelectorAll(".tile .name").forEach(e=>{var a;const t=e.closest(".tile"),n=(a=t==null?void 0:t.dataset)==null?void 0:a.id,o=n?ei(n):null,i=o!=null&&o.item?Ii(o.item):Ii(n);e.textContent=i}),Se&&sr(Se.value||""),K)){const e=ei(K);e!=null&&e.item&&le&&(le.textContent=Ii(e.item))}}function Xo(e){return gi=!!e,Kd(),gi}function Za(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(xs,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist strip parentheses",t)}}function qd(){if(typeof window>"u"||!window.localStorage)return Xo(ea);try{const e=window.localStorage.getItem(xs);if(e==null)return Xo(ea);const t=Xo(e==="1"||e==="true");return Za(t),t}catch(e){return console.warn("[Blockscape] failed to read strip parentheses",e),Xo(ea)}}function pl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(vs,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function Yd(){if(typeof window>"u"||!window.localStorage)return Zo(!1);try{const e=window.localStorage.getItem(vs);return e==null?Zo(!1):Zo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Zo(!1)}}function Qo(e){return Ro=(e??"").toString().trim(),Ro}function fl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ss,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Zd(){if(typeof window>"u"||!window.localStorage)return Qo("");try{const e=window.localStorage.getItem(Ss);return Qo(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Qo("")}}function Xd(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Qd(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function fo(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function eu(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||la(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=Dn(e,{seriesName:o,fallbackTitle:o})||_n(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=_n(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,fo(e,s),!0}function Xa(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>Xa(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${Xa(e[o])}`).join(",")}}`}function ml(e){try{return Xa(e)}catch{return""}}function sa(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=ml(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=ml(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const tu=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category (cycles item.stage in Center view)."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function Pn(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=on(a).replace(/\./g,"-");e.id=s||`model-${uo()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function nu(e){var s,c;const t=u=>{const h=(u??"").toString().trim();if(!h)return{base:"",suffix:null};const m=h.match(/^(.*?)-(\d+)$/);return{base:m?m[1]:h,suffix:m?Number.parseInt(m[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const u of n){if(u!=null&&u.isCategoryView)continue;const h=t(((c=u==null?void 0:u.data)==null?void 0:c.id)??(u==null?void 0:u.id)??"");if(h.base){i=h.base;break}}i||(i=on(Dn(e)||Qa(e)||Xe(e,"model")));let a=0;return n.forEach(u=>{var m;if(u!=null&&u.isCategoryView)return;const h=t(((m=u==null?void 0:u.data)==null?void 0:m.id)??(u==null?void 0:u.id)??"");h.base===i&&Number.isFinite(h.suffix)&&h.suffix>a&&(a=h.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function ou(e){return JSON.parse(JSON.stringify(e))}function Xe(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function la(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=kt(e);return a?`${a} series`:t}return Xe(e,t)}function kt(e){var i;const t=Dn(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function Qa(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function iu(e){return e?e.toString().replace(/-series$/i,""):null}function er(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<y.length;n++){const o=(kt(y[n])||"").toLowerCase(),i=(Qa(y[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function hl(e){var c;if(e<0||e>=y.length||!f)return!0;const t=y[e],n=(f.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Pn(o,{titleHint:Xe(t),idHint:kt(t)});const i=sa(t.data),a=sa(o);if(i===a)return!0;t.data=o;const s=Gn(t);return s>=0&&((c=t.apicurioVersions)!=null&&c[s])&&(t.apicurioVersions[s].data=o),!0}function gl(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function ei(e){if(w<0||!e)return null;const t=y[w].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function au(e,t){const n=ei(e);return n?(t?n.item.color=t:delete n.item.color,Ot(),Nt(),Lt(e),!0):!1}function ru(e){if(w<0||!e)return!1;const t=y[w].data,o=((t==null?void 0:t.categories)||[]).find(a=>a.id===e);if(!o)return!1;let i=!1;return(o.items||[]).forEach(a=>{yi(a.stage)!=null&&(delete a.stage,i=!0)}),i?(Ot(),Nt(),K&&Lt(K),!0):!1}function su(e,t){if(!e||!t||w<0)return!1;const n=ei(e);if(!n)return!1;const o=yi(n.item.stage),i=o??(t>0?To:ta),a=ta-To+1,s=((i-To+t)%a+a)%a,c=To+s;return n.item.stage=c,Ot(),Nt(),Lt(e),!0}function lu(e,t){const n=gl(t);let o=on(e||"item");if(!n.has(o))return o;const i=()=>uo().slice(0,4);for(;n.has(o);)o=`${on(e||"item")}-${i()}`;return o}function cu(e="category",t){const n=(t==null?void 0:t.categories)||[],o=on(e||"category"),i=c=>n.some(u=>u.id===c);let a=o||`category-${uo()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const mo=Sc({findItemAndCategoryById:ei,collectAllItemIds:gl,updateItemReferences:yc,loadActiveIntoEditor:Ot,rebuildFromActive:Nt,select:e=>Lt(e),onSelectionRenamed:(e,t)=>{var n;K===e&&(K=t,an()),((n=Pt==null?void 0:Pt.item)==null?void 0:n.id)===e&&(Pt.item.id=t)},makeSlug:on,isAutoIdFromNameEnabled:()=>co});function du({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=L=>{if(a.fields.errorEl){if(!L){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=L}},c=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},u=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var L,$;(L=a.fields.titleInput)==null||L.focus(),($=a.fields.titleInput)==null||$.select()}))},h=({force:L}={})=>{var te,Pe;if(!co||!a.autoSyncEnabled||!((te=a.fields)!=null&&te.idInput)||!((Pe=a.fields)!=null&&Pe.titleInput)||!L&&a.idManuallyEdited)return;const $=on(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=$},m=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const L=a.modelData.categories||[],$=L.find(Oe=>Oe.id===a.categoryId);if(!$)throw new Error("Category not found.");const te=(a.fields.idInput.value||"").trim();if(!te)throw new Error("ID is required.");const Pe=(a.fields.titleInput.value||"").trim();if(L.some(Oe=>Oe.id===te&&Oe.id!==$.id))throw new Error("Another category already uses that ID.");const ye=$.id;return $.id=te,$.title=Pe||$.id,ye!==te&&typeof i=="function"&&i(ye,te),t(),n(),o(te,{scrollIntoView:!0}),!0},S=()=>{try{return m(),c(),!0}catch(L){return console.warn("[CategoryEditor] save failed",L),s((L==null?void 0:L.message)||"Unable to save category."),!1}},O=()=>{if(a.wrapper)return a.wrapper;const L=document.createElement("div");L.className="item-editor-modal category-editor-modal",L.hidden=!0,L.setAttribute("role","dialog"),L.setAttribute("aria-modal","true");const $=document.createElement("div");$.className="item-editor-modal__backdrop",L.appendChild($);const te=document.createElement("div");te.className="item-editor",L.appendChild(te);const Pe=document.createElement("div");Pe.className="item-editor__header";const ct=document.createElement("h2");ct.className="item-editor__title",ct.textContent="Edit category";const ye=document.createElement("button");ye.type="button",ye.className="item-editor__close",ye.setAttribute("aria-label","Close category editor"),ye.textContent="×",Pe.appendChild(ct),Pe.appendChild(ye),te.appendChild(Pe);const Oe=document.createElement("form");Oe.className="item-editor__form",te.appendChild(Oe);const Re=document.createElement("div");Re.className="item-editor__meta",Re.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',Oe.appendChild(Re);const at=document.createElement("div");at.className="item-editor__error",at.hidden=!0,Oe.appendChild(at);const Zt=(Ve,ai,wo)=>{const hn=document.createElement("label");hn.className="item-editor__field";const vo=document.createElement("span");if(vo.className="item-editor__label",vo.textContent=Ve,hn.appendChild(vo),ai.classList.add("item-editor__control"),hn.appendChild(ai),wo){const wn=document.createElement("div");wn.className="item-editor__hint",wn.textContent=wo,hn.appendChild(wn)}return hn},Vt=document.createElement("input");Vt.type="text",Oe.appendChild(Zt("Title",Vt,"Display label shown in the map."));const et=document.createElement("input");et.type="text",et.required=!0,Oe.appendChild(Zt("ID",et,"Unique identifier for this category (used in URLs and references)."));const dt=document.createElement("div");dt.className="item-editor__checkbox";const zt=document.createElement("label");zt.className="item-editor__checkbox-row";const bn=document.createElement("input");bn.type="checkbox";const mn=document.createElement("span");mn.textContent="Sync ID while editing title";const Tt=document.createElement("div");Tt.className="item-editor__hint",Tt.textContent="Turn off to keep typing titles without changing the ID.",zt.append(bn,mn),dt.append(zt,Tt),Oe.appendChild(dt);const un=document.createElement("div");un.className="item-editor__actions";const rn=document.createElement("button");rn.type="submit",rn.className="item-editor__action item-editor__action--primary",rn.textContent="Save";const sn=document.createElement("button");return sn.type="button",sn.className="item-editor__action",sn.textContent="Cancel",un.appendChild(rn),un.appendChild(sn),Oe.appendChild(un),Oe.addEventListener("submit",Ve=>{Ve.preventDefault(),S()}),sn.addEventListener("click",c),ye.addEventListener("click",c),$.addEventListener("click",c),et.addEventListener("input",()=>{a.idManuallyEdited=!0}),Vt.addEventListener("input",()=>h()),bn.addEventListener("change",()=>{a.autoSyncEnabled=!!bn.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,h({force:!0}))}),L.addEventListener("keydown",Ve=>{Ve.key==="Escape"&&(Ve.preventDefault(),c())}),document.body.appendChild(L),a.wrapper=L,a.fields={titleInput:Vt,idInput:et,errorEl:at,metaLabel:Re.querySelector(".item-editor__meta-value"),syncCheckbox:bn},L};return{open:L=>{if(!L||!O())return!1;const te=e(),ct=((te==null?void 0:te.categories)||[]).find(Oe=>Oe.id===L);if(!ct)return!1;a.categoryId=ct.id,a.modelData=te,a.idManuallyEdited=!1;const ye=!!co;return a.autoSyncEnabled=ye,a.fields.metaLabel.textContent=ct.title||ct.id||"Category",a.fields.titleInput.value=ct.title||ct.id||"",a.fields.idInput.value=ct.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!ye,!a.fields.idInput.value&&ye&&h({force:!0}),s(""),u(),!0},hide:c,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const uu=du({getActiveModelData:()=>{var e;return(e=y[w])==null?void 0:e.data},loadActiveIntoEditor:Ot,rebuildFromActive:Nt,selectCategory:(e,t={})=>Jn(e,t),onCategoryRenamed:(e,t)=>{ot===e&&(ot=t,an())}}),{handleTileContextMenu:pu,hidePreview:ho,handleDocumentClick:fu,handleWindowResize:mu,handleWindowScroll:hu,updateColorPresets:ti}=_c({menuEl:document.getElementById("tileContextMenu"),previewEl:X,previewTitleEl:le,previewBodyEl:fe,previewActionsEl:rt,previewCloseEl:He,escapeHtml:xi,onEditItem:e=>mo.open(e),onChangeColor:(e,t)=>au(e,t),selectItem:e=>Lt(e),colorPresets:nn});function ca(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||Xe(e);return Jt(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function gu({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=on(`${e||"blank"}-${qa()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),Pn(o,{titleHint:t,idHint:n}),o}function bu(){const t=`Blank series ${qa()}`,n=_n(t,"blank-series"),o=gu({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return fo(i,n),Jt(i,{seriesName:t,fallbackTitle:t}),i}function wu(){const e=bu(),t=Rn(e,{versionLabel:"blank"});return $t(t),pd({origin:"new-blank"}),ua(),fn("Blank series created. Add categories and tiles to start.",2600),t}function Rn(e,{versionLabel:t,createdOn:n}={}){var u,h,m;if(e!=null&&e.isSeries||((u=e==null?void 0:e.apicurioVersions)==null?void 0:u.length)>1){const S=e.title||Xe(e);Jt(e,{seriesName:S,fallbackTitle:S}),pa(e)}const o=kt(e);if(!o)return ca(e,{versionLabel:t||"1",createdOn:n}),y.push(e),y.length-1;const i=y.findIndex(S=>kt(S)===o);if(i===-1)return ca(e,{versionLabel:t||"1",createdOn:n}),y.push(e),y.length-1;const a=y[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(m=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:m.createdOn}],a.apicurioActiveVersionIndex=0;const S=a.title||Xe(a);Jt(a,{seriesName:S,fallbackTitle:S})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=Xe(e)||a.title,a.isSeries=!0;const c=a.title||Xe(a);return Jt(a,{seriesName:c,fallbackTitle:c}),i}function bl({versionLabel:e}={}){var c;if(w<0||!y[w])throw new Error("Load or select a model before creating a version.");const t=y[w];ca(t,{versionLabel:"1"});const n=nu(t);let o;try{o=ou(t.data)}catch(u){throw console.warn("[Blockscape] failed to clone active model for versioning",u),new Error("Could not copy the current model.")}n&&(o.id=n),Pn(o,{titleHint:Xe(t),idHint:kt(t)||Dn(t)});const a={version:e||String((((c=t.apicurioVersions)==null?void 0:c.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||Xe(t);return Jt(t,{seriesName:s,fallbackTitle:s}),w}function tr(){const e=w>=0&&y[w]?y[w]:null,t=kt(e);document.title=t?`${t}-blockscape`:lt}function da(e){if(!e)return null;pa(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||Xe(e);return Jt(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var u;const s=((i==null?void 0:i.version)??"").toString().trim(),c=(((u=i==null?void 0:i.data)==null?void 0:u.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(na)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:c}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function vu(){const e=y[w],t=da(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function wl(e="shortcut",t=!1){const n=f.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=y[w],i=t?da(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,c=Dn(o),u=kt(o),h=c||u||Xe(o,"blockscape"),m=a?"-series":"",S=`${on(h)}${m}.bs`;return Fs(S,s),console.log(`[Blockscape] saved JSON (${e}):`,S),!0}const yu=Gt.palette.letter,Su=Gt.palette.letterFallback;function vl(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return yu[n]||Su}function Eu(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?Gt.color.ink:Gt.color.white}function ku(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function nr(){if(dn)return;dn=document.createElement("div"),dn.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",qt=document.createElement("span"),qt.className="series-nav-notice__text",dn.appendChild(e),dn.appendChild(qt),document.body.appendChild(dn)}function or(){Ln&&(clearTimeout(Ln),Ln=null),dn&&dn.classList.remove("is-visible"),qt&&(qt.textContent="")}function ni(){tn=null,Ft&&(clearTimeout(Ft),Ft=null),or()}function ir(){An=null,Wt&&(clearTimeout(Wt),Wt=null),or()}function Iu(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function _u(e,t,n){nr(),tn={id:e,targetVersionIndex:t},Ft&&clearTimeout(Ft),Ft=setTimeout(()=>{Ft=null,ni()},Wn);const o=Iu(n,t);fn(`Click again to open ${o} in this series.`,Wn)}function Cu(e,t){nr(),An={id:e,targetIndex:t},Wt&&clearTimeout(Wt),Wt=setTimeout(()=>{Wt=null,ir()},Wn);const n=la(y[t]);fn(`Click again to open "${n}".`,Wn)}function fn(e,t=so,n=null){if(nr(),qt.textContent="",qt.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,qt.appendChild(o),qt.appendChild(i)}dn.classList.add("is-visible"),Ln&&clearTimeout(Ln),Ln=setTimeout(()=>or(),t)}function xu(){de&&(de.innerHTML="",tu.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const c=document.createElement("span");c.className="shortcut-help__or",c.textContent="or",n.appendChild(c)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((c,u)=>{if(u>0){const m=document.createElement("span");m.className="shortcut-help__sep",m.textContent="+",s.appendChild(m)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=c,s.appendChild(h)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),de.appendChild(t)}),cn=!0)}function Tu(){return!!Ie&&Ie.hidden===!1}function Au(){if(!Ie)return;cn||xu(),Un=document.activeElement,Ie.hidden=!1,Ie.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Ie.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function ar(){if(!Ie||Ie.hidden)return;Ie.hidden=!0,Ie.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=Un;e!=null&&e.focus?e.focus({preventScroll:!0}):Ne!=null&&Ne.focus&&Ne.focus({preventScroll:!0})}function Lu(){if(!Z)return;Z.hidden=!1,Z.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Z.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function ua(){!Z||Z.hidden||(Z.hidden=!0,Z.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),be!=null&&be.focus&&be.focus({preventScroll:!0}))}let rr=!1;function go(){rr||(rr=!0,requestAnimationFrame(()=>{rr=!1,ma(),Nn()}))}let yl=!1;function Sl(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function Nu(e){const t=Sl(e);if(!t.length){_.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}_.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(c=>o.includes(c)||i.includes(c));n.style.opacity=a?"1":"0.2"})}function Mu(e){const t=Sl(e);if(!t.length)return[];const n=[];return y.forEach((o,i)=>{var h;const a=la(o),s=kt(o)||"",c=`${a} ${s}`.toLowerCase();t.every(m=>c.includes(m))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((h=o.data)==null?void 0:h.categories)?o.data.categories:[]).forEach(m=>{const S=(m.title||m.id||"").toString();(m.items||[]).forEach(O=>{const A=Ii(O),L=(O.name||O.id||"").toString(),$=`${L} ${O.id||""} ${S}`.toLowerCase();t.every(te=>$.includes(te))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:O.id,itemName:L,itemDisplayName:A,categoryTitle:S})})})}),n.slice(0,Le)}function El(e){if(!ue)return;ue.innerHTML="";const t=(e||"").toString();if(!t.trim()){ue.hidden=!0;return}if(!y.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",ue.appendChild(o),ue.hidden=!1;return}const n=Mu(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",ue.appendChild(o),ue.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===w&&(!o.itemId||K===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemDisplayName||o.itemName||o.itemId||"Item",a.appendChild(s);const c=document.createElement("span");c.className="search-result__badge",c.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(c);const u=document.createElement("div");u.className="search-result__meta";const h=document.createElement("span");if(h.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,u.appendChild(h),o.type==="item"&&o.itemId){const m=document.createElement("span");m.textContent=`Item ID: ${o.itemId}`,u.appendChild(m)}else if(o.type==="model"){const m=document.createElement("span");m.textContent="Matches model title",u.appendChild(m)}i.appendChild(a),i.appendChild(u),ue.appendChild(i)}),ue.hidden=!1}function sr(e){Nu(e||""),El(e||"")}function Bu(e){!e||!Number.isInteger(e.modelIndex)||($t(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(w!==e.modelIndex)return;const t=(n=M.get(e.itemId))==null?void 0:n.el;t&&(Lt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function $t(e){var t;if(ho(),ni(),Pt=null,gn=null,ot=null,bt=null,e<0||e>=y.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(N=!0,w=e,console.log("[Blockscape] active model:",Xe(y[e]),"(index",e+" )"),typeof(Qe==null?void 0:Qe.highlightSource)=="function"){const n=((t=y[e])==null?void 0:t.sourcePath)||null;Qe.highlightSource(n)}tr(),jn(),Ot(),Nt(),Se&&sr(Se.value||""),Qe.updateActiveSavePlaceholder(),pt.updateAvailability(),Ka()}function jn(){if(q.innerHTML="",!y.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",q.appendChild(e);return}y.forEach((e,t)=>{var S;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===w?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===w?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=la(e),i.appendChild(a);const s=iu(Qa(e)||kt(e));if(s){const O=document.createElement("span");O.className="model-nav-id",O.textContent=s,i.appendChild(O)}const c=Array.isArray((S=e.data)==null?void 0:S.categories)?e.data.categories:[],u=c.reduce((O,A)=>O+(A.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const m=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";h.textContent=`${c.length} cat · ${u} items${m}`,o.appendChild(i),o.appendChild(h),n.appendChild(o),q.appendChild(n)}),pt.updateAvailability()}function Ot(){if(w<0){f.value="",R&&(R.disabled=!0);return}const e=y[w];f.value=JSON.stringify(e.data,null,2),R&&(R.disabled=!da(e))}function Pu(e){try{return JSON.parse(e)}catch{return null}}function kl(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function Ru(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,c)=>{const u=s==null?void 0:s.data;if(!u||!Array.isArray(u.categories))return;const h=Xe(u,`Map ${c+1}`),m=(u.id??"").toString().trim()||on(h||`map-${c+1}`),S=on(m||h||`map-${c+1}`);u.categories.forEach(O=>{const A=((O==null?void 0:O.id)??"").toString().trim();if(!A)return;n.has(A)||n.set(A,{catTitle:O.title||A,sources:[]});const L=n.get(A);!L.catTitle&&(O.title||A)&&(L.catTitle=O.title||A),L.sources.push({category:O,mapId:m,mapTitle:h,mapSlug:S,versionIndex:c})})});const o=Dn(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||Xe(e,"Series"),a=[];return n.forEach((s,c)=>{var O;if((((O=s.sources)==null?void 0:O.length)||0)<2)return;const u=s.catTitle||c,h=new Set,m=s.sources.map(A=>{var ct;let $=A.mapSlug||on(A.mapTitle||A.mapId)||`map-${A.versionIndex+1}`;h.has($)&&($=`${$}-${A.versionIndex+1}`),h.add($);const te=new Map,Pe=(((ct=A.category)==null?void 0:ct.items)||[]).map((ye,Oe)=>{const Re=((ye==null?void 0:ye.id)??"").toString().trim()||`item-${Oe+1}`,at=`${$}-${Re}`;te.set(Re,at);const Zt={...ye,id:at};return Zt.deps=Array.isArray(ye==null?void 0:ye.deps)?[...ye.deps]:[],Zt});return Pe.forEach(ye=>{ye.deps=(ye.deps||[]).map(Oe=>te.get(Oe)).filter(Boolean)}),{id:$,title:A.mapTitle||A.mapId||`Map ${A.versionIndex+1}`,items:Pe}}),S={id:on(`${c}-category-view`),title:u,abstract:`Items from "${u}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:m};o&&(S.seriesId=o),Pn(S,{titleHint:u,idHint:`${o||"series"}-${c}`}),a.push({version:`${na}${c}`,data:S,isCategoryView:!0,categoryViewKey:c})}),a}function Il(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${na}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function pa(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=Il(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(c=>!(c!=null&&c.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Gn(e),e.apicurioVersions.length-1));const c=e.apicurioVersions[e.apicurioActiveVersionIndex];return c!=null&&c.data&&(e.data=c.data),e}const o=Ru({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(c=>Il(c)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function $u(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((m,S)=>!m||typeof m!="object"?null:(Pn(m,{titleHint:`${t} #${S+1}`}),{obj:m,idx:S})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let c=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const u={id:uo(),title:c,data:a,apicurioVersions:i.map(({obj:m,idx:S})=>({version:String(S+1),data:m})),apicurioActiveVersionIndex:0,isSeries:!0},h=Jt(u,{seriesName:c,fallbackTitle:c});return h&&(u.id=h),pa(u),[u]}function _l(e,t="Pasted",n={}){return Array.isArray(e)?$u(e,t,n):!e||typeof e!="object"?[]:(Pn(e,{titleHint:`${t} #1`}),[{id:uo(),title:e.title||`${t} #1`,data:e}])}function zn(e,t="Pasted",n={}){const a=(kl(typeof e=="string"?e:"")||"").replace(/^\uFEFF/,"").replace(/\u0000/g,"").trim();if(!a)return[];const s=Pu(a);if(s){let u=n;if(Array.isArray(s)&&n.promptForSeriesName){const m=Qd(s,t),S=Xd(m);u={...n,promptForSeriesName:!1,seriesTitleOverride:S||m}}const h=_l(s,t,u);if(h.length)return h}return a.split(/^\s*(?:---|%%%)\s*$/m).map(u=>u.trim()).filter(Boolean).map((u,h)=>{const m=JSON.parse(u);return Pn(m,{titleHint:`${t} #${h+1}`}),{id:uo(),title:m.title||`${t} #${h+1}`,data:m}})}function Ou(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function bo(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!Ou(e)}function Vu(e){if(!e)return!1;const n=(kl(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function Cl(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(ut)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(ut)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(ut)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=zn(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let o=null;return n.forEach(i=>{const a=Rn(i,{versionLabel:"editor"});o==null&&(o=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:o,count:n.length}}function xl(e="storage"){const t=Cl();return!t||typeof t.index!="number"?!1:($t(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Du(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=Zc(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=_l(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const c=s.isSeries?o.title||s.title:null,u=Rn({...s,apicurioArtifactName:c||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=u)}),a}async function Uu(){const e=fd();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await ki())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await Zs(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(Qe==null?void 0:Qe.highlightSource)=="function"&&Qe.highlightSource(t);let s=a.firstIndex;if(n){const c=er(n);c!==-1&&(s=c)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function Hu(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await ur(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function Fu(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const c=new Set(s.deps||[]);t.set(s.id,c),c.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function Wu(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=vl(e,t),c=Eu(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=c,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function Gn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Tl(e){const t=Gn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Al(e,t="active"){return Dn(e)||kt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function ju(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,c;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((c=n==null?void 0:n.data)==null?void 0:c.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function zu(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(on(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,c]of t.entries())if(s.toLowerCase()===a)return c}return null}const Ll=new WeakMap;function Gu(e,t){var at;if(!((at=e==null?void 0:e.apicurioVersions)!=null&&at[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=sa(o),a=Ll.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,c=160,u=document.createElement("canvas");u.width=s,u.height=c;const h=u.getContext("2d"),m=Do("--color-surface-ghost")||Gt.color.surfaceGhost,S=Do("--color-border-muted")||Gt.color.borderMuted;h.fillStyle=m,h.fillRect(0,0,s,c),h.strokeStyle=S,h.strokeRect(.5,.5,s-1,c-1);const O=8,A=8,L=4,$=Array.isArray(o==null?void 0:o.categories)?o.categories:[],te=Math.max($.length,1),Pe=s-L*2,ct=L*3,ye=te>1?Math.min(ct,Pe/(te-1)):0,Oe=te>1?(s-ye*(te-1))/2:s/2;$.forEach((Zt,Vt)=>{const et=Oe+Vt*ye,dt=Array.isArray(Zt.items)?Zt.items:[],zt=Math.max(dt.length,1),bn=c-O-A-L*2,mn=zt>1?Math.min(L*3,bn/(zt-1)):0;dt.forEach((Tt,un)=>{const rn=c-A-L-un*mn;h.beginPath(),h.arc(et,rn,L,0,Math.PI*2);const sn=vl(Tt.name||Tt.id||"",Tt.color);h.fillStyle=sn,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const Re=u.toDataURL("image/png");return Ll.set(n,{fingerprint:i,dataUrl:Re}),Re}function fa(e,t){var c;if(ni(),e<0||e>=y.length)return!1;const n=y[e];if(!((c=n==null?void 0:n.apicurioVersions)!=null&&c.length)||!hl(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,N=!0,K=null,ft=null,an(),Ot(),Nt(),!0):!1}function lr(e){var o;if(!e||w<0)return!1;const t=y[w];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=Gn(t);return n===-1?!1:fa(w,n+e)}function Ju(e,t){if(ni(),e<0||e>=y.length)return!1;const n=y[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!hl(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=Gn(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const c=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(c==null?void 0:c.data)||n.data,n.isSeries=n.apicurioVersions.length>1,$t(e),!0}function Ku(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,l.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||kt(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var Pe;const $=y[w];!((Pe=$==null?void 0:$.apicurioVersions)!=null&&Pe.length)||!eu($)||(jn(),Ot(),Nt())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=Gn(e),s=Tl(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const c=document.createElement("div");c.className="version-nav__controls";const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Previous",u.addEventListener("click",()=>lr(-1));const h=document.createElement("button");h.type="button",h.className="version-nav__button",h.textContent="Next",h.addEventListener("click",()=>lr(1)),c.appendChild(u),c.appendChild(h),n.appendChild(c);const m=document.createElement("div");m.className="version-nav__thumbs",e.apicurioVersions.forEach(($,te)=>{var Vt,et;const Pe=document.createElement("button");Pe.type="button",Pe.className="version-nav__thumb",$!=null&&$.isCategoryView&&Pe.classList.add("version-nav__thumb--category"),te===a&&Pe.classList.add("is-active");const ct=Gu(e,te);if(ct){const dt=document.createElement("img");dt.src=ct,dt.alt=`Version ${te+1}`,Pe.appendChild(dt)}const ye=document.createElement("div");ye.className="version-nav__thumb-label";const Oe=document.createElement("span");Oe.className="version-nav__thumb-label-text";const Re=(((Vt=$==null?void 0:$.data)==null?void 0:Vt.id)??($==null?void 0:$.id)??"").toString().trim();let at=Re||($!=null&&$.version?`v${$.version}`:`${te+1}`),Zt=Re||at;if($!=null&&$.isCategoryView){const dt=((et=$.data)==null?void 0:et.title)||$.categoryViewKey||at||"Category";at=dt,Zt=`Category view: ${dt}`,Pe.dataset.computed="true"}if(Oe.textContent=at,ye.title=Zt,ye.appendChild(Oe),Pe.appendChild(ye),np(ye,Oe),e.apicurioVersions.length>1&&!($!=null&&$.isCategoryView)){const dt=document.createElement("span");dt.className="version-nav__thumb-remove",dt.title=`Remove ${at} from this series`,dt.setAttribute("aria-label",`Remove ${at} from this series`),dt.setAttribute("role","button"),dt.tabIndex=-1,dt.textContent="×",dt.addEventListener("click",zt=>{zt.stopPropagation(),zt.preventDefault(),window.confirm(`Remove ${at} from this series?`)&&Ju(w,te)}),Pe.appendChild(dt)}Pe.addEventListener("click",()=>fa(w,te)),ip(Pe,$),m.appendChild(Pe)});const S=document.createElement("button");S.type="button",S.className="version-nav__thumb version-nav__thumb--add",S.title="Create a new version from this map",S.addEventListener("click",()=>{try{const $=bl({versionLabel:"manual"});$t($)}catch($){alert(($==null?void 0:$.message)||"Unable to create a new version right now.")}});const O=document.createElement("span");O.className="version-nav__thumb-add-icon",O.textContent="+",S.appendChild(O),m.appendChild(S),n.appendChild(m);const A=Al(e,"active"),L=D.get(A);return typeof L=="number"&&!Number.isNaN(L)&&requestAnimationFrame(()=>{m.scrollLeft=L}),m.addEventListener("scroll",()=>{D.set(A,m.scrollLeft)}),n}function _i(){var Ql,ec;if(!re)return;const e=w>=0&&y[w]?y[w]:null,t=_&&_.querySelector?_.querySelector(".version-nav__thumbs"):null;if(t&&e){const p=Al(e,w);D.set(p,t.scrollLeft)}Kn(),Array.isArray(re.m.categories)||(re.m.categories=[]),console.log("[Blockscape] rendering categories=",re.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!re.m.abstract,"- value:",re.m.abstract?re.m.abstract.substring(0,50)+"...":"none"),_.innerHTML="",M.clear(),At.clear(),ke=[],eo=!0,ge.tabSeriesPanelToggle&&(ge.tabSeriesPanelToggle.checked=!0),ca(y[w],{versionLabel:"1"}),Oo=Ku(y[w]),Oo&&(sl(eo),_.appendChild(Oo)),G.setAttribute("width",window.innerWidth),G.setAttribute("height",window.innerHeight);const o=(()=>{var Y,Ke,en;const p=document.createElement("div");p.className="blockscape-model-meta";const P=document.createElement("div");P.className="blockscape-model-title",P.textContent=re.m.title&&re.m.title.trim()||Xe(y[w]),p.appendChild(P),((Y=y[w])!=null&&Y.isSeries||(en=(Ke=y[w])==null?void 0:Ke.apicurioVersions)!=null&&en.length)&&Jt(y[w],{seriesName:y[w].title||re.m.title||Xe(y[w])});const W=Tl(y[w]),Ce=Dn(y[w]),pe=(re.m.id??"").toString().trim(),$e=document.createElement("div");$e.className="blockscape-model-meta__details";const Me=(Ue,Ut)=>{if(!Ut)return;const In=document.createElement("div");In.className="blockscape-model-id";const Eo=document.createElement("span");Eo.className="blockscape-model-id__label",Eo.textContent=Ue;const ko=document.createElement("span");ko.className="blockscape-model-id__value",ko.textContent=Ut,In.append(Eo,ko),$e.appendChild(In)};return Me("Series ID",Ce),Me("Model ID",pe),Me("No. in series",W),$e.childElementCount&&p.appendChild($e),p})();l.showModelMeta!==!1&&_.appendChild(o.cloneNode(!0));const a=document.createElement("div");a.className="blockscape-tabs";const s=document.createElement("div");s.className="blockscape-tabrow";const c=document.createElement("div");c.className="blockscape-tablist",c.setAttribute("role","tablist"),s.appendChild(c);const u=document.createElement("div");u.className="blockscape-tabactions",s.appendChild(u),a.appendChild(s);const h=document.createElement("div");h.className="blockscape-tabpanels",a.appendChild(h);const m=document.createElement("div"),S=document.createElement("div"),O=document.createElement("div"),A=document.createElement("div"),L=()=>{const p=document.createElement("div");p.className="blockscape-map-legend";const P=document.createElement("div");return P.className="blockscape-legend",P.setAttribute("role","presentation"),P.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,p.appendChild(P),p};let $="";const te=ju(y[w]),Pe=Gn(y[w]),ct=((ec=(Ql=y[w])==null?void 0:Ql.apicurioVersions)==null?void 0:ec[Pe])||null,ye=xn=!!(ct!=null&&ct.isCategoryView||((ct==null?void 0:ct.version)||"").startsWith(na));v=null,B="";const Oe=(p,P)=>{!p||!P||(p.title=p.title?`${p.title}
${P}`:P)},Re=[{id:"map",label:"Map",panel:m},{id:"abstract",label:"Info",panel:S},{id:"source",label:"Settings",panel:O},{id:"apicurio",label:"Apicurio",panel:A}],at=typeof pt.isEnabled=="function"?pt.isEnabled():!1,Zt=p=>{if(!G)return;const P=p==="map";G.hidden=!P,P?(ma(),Nn()):G.innerHTML=""};Re.forEach((p,P)=>{const W=document.createElement("button");W.type="button",W.id=`tab-${p.id}`,W.className="blockscape-tab"+(P===0?" is-active":""),W.setAttribute("role","tab"),W.setAttribute("aria-controls",`panel-${p.id}`),W.setAttribute("aria-selected",P===0?"true":"false"),W.textContent=p.label,p.id==="apicurio"&&!at&&(W.hidden=!0,W.tabIndex=-1,W.setAttribute("aria-hidden","true"),W.style.display="none"),p.button=W,c.appendChild(W),p.panel.id=`panel-${p.id}`,p.panel.classList.add("blockscape-tabpanel"),p.panel.setAttribute("role","tabpanel"),p.panel.setAttribute("aria-labelledby",W.id),p.panel.hidden=P!==0,P===0&&p.panel.classList.add("is-active"),h.appendChild(p.panel)});const Vt=p=>{Kt=p,Re.forEach(P=>{const W=P.id===p;P.button.classList.toggle("is-active",W),P.button.setAttribute("aria-selected",W?"true":"false"),P.panel.classList.toggle("is-active",W),P.panel.hidden=!W}),Zt(p)},et=Re.find(p=>p.id==="apicurio"),dt=p=>{if(!et||!et.button||!et.panel)return;const P=!!p;if(et.button.hidden=!P,et.button.tabIndex=P?0:-1,et.button.setAttribute("aria-hidden",P?"false":"true"),et.button.style.display=P?"":"none",P){const W=Kt==="apicurio";et.button.classList.toggle("is-active",W),et.button.setAttribute("aria-selected",W?"true":"false"),et.panel.classList.toggle("is-active",W),et.panel.hidden=!W}else{const W=et.panel.classList.contains("is-active");if(et.button.classList.remove("is-active"),et.button.setAttribute("aria-selected","false"),et.panel.classList.remove("is-active"),et.panel.hidden=!0,W){const Ce=Re.find(pe=>pe.id!=="apicurio");Ce&&Vt(Ce.id)}}ee&&(ee.checked=P)};Re.forEach(p=>{p.button.addEventListener("click",()=>{Kn(),Vt(p.id)}),p.id==="abstract"&&(v=p.button,p.button.addEventListener("mouseenter",()=>Ti(p.button,$,{offset:12})),p.button.addEventListener("mouseleave",Kn),p.button.addEventListener("focus",()=>Ti(p.button,$,{offset:12})),p.button.addEventListener("blur",Kn))});const bn=(p=>{const P=Re.find(Ce=>Ce.id===Kt);if(P&&(P.id!=="apicurio"||p))return P.id;const W=Re.find(Ce=>Ce.id!=="apicurio"||p);return(W==null?void 0:W.id)||Re[0].id})(at);Vt(bn),dt(at),typeof pt.onEnabledChange=="function"&&pt.onEnabledChange(dt),_.appendChild(a),m.appendChild(L());const mn=document.createElement("div");mn.className="blockscape-render";const Tt=document.createElement("div");Tt.className="stage-guides",Tt.hidden=!Et,Tt.setAttribute("aria-hidden","true");const un=document.createElement("div");un.className="stage-guide-labels",["Genesis / Inception","Custom","Product / Rental","Service / Commodity"].forEach(p=>{const P=document.createElement("span");P.className="stage-guide-labels__item",P.textContent=p,un.appendChild(P)}),Tt.appendChild(un),mn.appendChild(Tt),Da=Tt,m.appendChild(mn);const rn=document.createElement("div");if(rn.className="blockscape-abstract-panel",S.appendChild(o.cloneNode(!0)),re.m.abstract){console.log("[Blockscape] Rendering abstract content");const p=document.createElement("div");p.className="blockscape-abstract",p.innerHTML=re.m.abstract,kp(p),rn.appendChild(p),$=p.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const p=document.createElement("div");p.className="blockscape-abstract-placeholder",p.textContent="No abstract has been provided for this model.",rn.appendChild(p),$=p.outerHTML}B=$,S.appendChild(rn);const sn=document.createElement("div");sn.className="blockscape-source-panel";const Ve=document.createElement("div");Ve.className="blockscape-settings-panel";const ai=p=>{ge.themeToggle&&(ge.themeToggle.checked=p),ge.tabThemeToggle&&(ge.tabThemeToggle.checked=p)},wo=p=>{ai(p),Ha(p?lo:Ao)},hn=p=>{ge.tabCenterToggle&&(ge.tabCenterToggle.checked=p)},vo=p=>{const P=Vo(p);hn(P),Ws(P)},wn=p=>{ge.secondaryLinksToggle&&(ge.secondaryLinksToggle.checked=p),ge.tabSecondaryLinksToggle&&(ge.tabSecondaryLinksToggle.checked=p)},ba=p=>{const P=!!p;wn(P),Cn=P,K?Lt(K):(ga(),Nn())},yo=({id:p,label:P,checked:W,onChange:Ce})=>{const pe=document.createElement("label");pe.className="blockscape-tab-toggle",pe.setAttribute("for",p);const $e=document.createElement("input");$e.type="checkbox",$e.id=p,$e.checked=W,typeof Ce=="function"&&$e.addEventListener("change",()=>Ce($e.checked));const Me=document.createElement("span");return Me.className="blockscape-tab-toggle__label",Me.textContent=P,pe.append($e,Me),{row:pe,input:$e}},Ai=document.createElement("p");Ai.className="blockscape-settings-panel__title",Ai.textContent="Feature toggles",Ve.appendChild(Ai);const ri=document.createElement("label");ri.className="settings-toggle";const to=document.createElement("input");to.type="checkbox",to.checked=bi===lo;const Li=document.createElement("span");Li.className="settings-toggle__text";const Ni=document.createElement("span");Ni.className="settings-toggle__label",Ni.textContent="Dark mode";const si=document.createElement("span");si.className="settings-toggle__hint",si.textContent="Switch Blockscape UI to dark colors.",Li.append(Ni,si),ri.append(to,Li),to.addEventListener("change",()=>{wo(to.checked)}),Ve.appendChild(ri),ge.themeToggle=to;const{row:I,input:F}=yo({id:"tabToggleTheme",label:"Dark mode",checked:bi===lo,onChange:p=>wo(p)});u.appendChild(I),ge.tabThemeToggle=F;const{row:oe,input:ve}=yo({id:"tabToggleSeriesPanel",label:"Series panel",checked:eo,onChange:p=>sl(p)});u.appendChild(oe),ge.tabSeriesPanelToggle=ve;const{row:tt,input:Je}=yo({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:Cn,onChange:p=>ba(p)});u.appendChild(tt),ge.tabSecondaryLinksToggle=Je;const{row:ie,input:De}=yo({id:"tabToggleCenterItems",label:"Wardley",checked:Et,onChange:p=>vo(p)});u.appendChild(ie),ge.tabCenterToggle=De;const Dt=document.createElement("div");Dt.className="settings-actions";const Xt=document.createElement("input");Xt.type="file",Xt.accept="application/json",Xt.hidden=!0;const ln=document.createElement("button");ln.type="button",ln.className="pf-v5-c-button pf-m-secondary",ln.textContent="Load settings",ln.addEventListener("click",()=>Xt.click()),Xt.addEventListener("change",async()=>{var P,W;const p=(P=Xt.files)==null?void 0:P[0];if(p)try{const Ce=await p.text(),pe=JSON.parse(Ce),$e=(pe==null?void 0:pe.settings)||pe,Y=((W=Ya($e||{},{refreshObsidianLinks:va}).applied)==null?void 0:W.length)||0;fn(Y?`Loaded ${Y} setting${Y===1?"":"s"} from ${p.name}.`:`No matching settings found in ${p.name}.`,2200)}catch(Ce){console.warn("[Blockscape] failed to load settings.json",Ce),fn("Invalid settings file.",2400)}finally{Xt.value=""}});const $n=document.createElement("button");$n.type="button",$n.className="pf-v5-c-button pf-m-tertiary",$n.textContent="Download settings",$n.addEventListener("click",async()=>{const p=cl();if(typeof window<"u"&&typeof window.__blockscapeSettingsSaveToFile=="function")try{await window.__blockscapeSettingsSaveToFile(p)?fn("Settings saved to ~/.blockscape/settings.json.",2e3):fn("Settings save failed. Check logs.",2400)}catch(P){console.warn("[Blockscape] settings save failed",P),fn("Settings save failed. Check logs.",2400)}else Fs("settings.json",JSON.stringify(p,null,2)),fn("Settings downloaded.",2e3)}),Dt.append(ln,$n,Xt),Ve.appendChild(Dt);const wa=document.createElement("div");wa.className="color-presets";const pr=document.createElement("div");pr.className="settings-text__label",pr.textContent="Color presets";const fr=document.createElement("div");fr.className="settings-text__hint",fr.textContent="Shown in tile context menu for quick coloring.",wa.append(pr,fr);const Mi=document.createElement("div");Mi.className="color-presets__list";const mr=document.createElement("div");mr.className="color-presets__add";const li=document.createElement("input");li.type="text",li.placeholder="Name",li.className="settings-text__input";const Bi=document.createElement("input");Bi.type="color",Bi.value="#2563eb",Bi.className="settings-color-input";const Pi=document.createElement("button");Pi.type="button",Pi.className="pf-v5-c-button pf-m-primary",Pi.textContent="Add preset",Pi.addEventListener("click",()=>{const p=li.value.trim()||"Custom",P=Bi.value,W=[...nn,{name:p,value:P}];Uo(W),ti(nn),li.value=""}),mr.append(li,Bi,Pi),wa.append(Mi,mr),Ve.appendChild(wa),ge.colorPresetList=Mi,$o=()=>{Mi.innerHTML="",nn.forEach((p,P)=>{const W=document.createElement("div");W.className="color-presets__row";const Ce=document.createElement("input");Ce.type="text",Ce.className="settings-text__input",Ce.value=p.name||"",Ce.placeholder="Name",Ce.addEventListener("input",()=>{const Me=[...nn];Me[P]={...Me[P],name:Ce.value},Uo(Me),ti(nn)});const pe=document.createElement("input");pe.type="color",pe.className="settings-color-input",pe.value=p.value,pe.addEventListener("input",()=>{const Me=[...nn];Me[P]={...Me[P],value:pe.value},Uo(Me),ti(nn)});const $e=document.createElement("button");$e.type="button",$e.className="pf-v5-c-button pf-m-plain",$e.textContent="✕",$e.title="Remove preset",$e.addEventListener("click",()=>{const Me=nn.filter((Y,Ke)=>Ke!==P);Uo(Me),ti(nn),$o()}),W.append(Ce,pe,$e),Mi.appendChild(W)})},$o();const hr=document.createElement("div");hr.className="settings-text";const gr=document.createElement("div");gr.className="settings-text__label",gr.textContent="Link colors";const br=document.createElement("div");br.className="settings-text__hint",br.textContent="Adjust the colors used when highlighting enables/dependents.";const wr=document.createElement("div");wr.className="settings-color-rows";const zl=({id:p,label:P,hint:W,value:Ce,onChange:pe})=>{const $e=document.createElement("label");$e.className="settings-color-row",$e.setAttribute("for",p);const Me=document.createElement("span");if(Me.className="settings-color-row__label",Me.textContent=P,W){const Ke=document.createElement("span");Ke.className="settings-color-row__hint",Ke.textContent=W,Me.appendChild(Ke)}const Y=document.createElement("input");if(Y.type="color",Y.id=p,Y.className="settings-color-input",Y.value=Ce,typeof pe=="function"){const Ke=()=>pe(Y.value);Y.addEventListener("input",Ke),Y.addEventListener("change",Ke)}return $e.append(Me,Y),wr.appendChild($e),Y};ge.depColorInput=zl({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:ia,onChange:p=>{const P=za(p);Wa(P)}}),ge.revdepColorInput=zl({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:aa,onChange:p=>{const P=Ga(p);ja(P)}}),hr.append(gr,br,wr),Ve.appendChild(hr);const vr=document.createElement("div");vr.className="settings-text";const yr=document.createElement("div");yr.className="settings-text__text";const Sr=document.createElement("div");Sr.className="settings-text__label",Sr.textContent="Link thickness";const Er=document.createElement("div");Er.className="settings-text__hint",Er.textContent="Adjust stroke width for enables/dependents lines.",yr.append(Sr,Er);const So=document.createElement("select");So.id="linkThickness",So.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:p,label:P})=>{const W=document.createElement("option");W.value=p,W.textContent=P,p===wi&&(W.selected=!0),So.appendChild(W)}),So.addEventListener("change",()=>{const p=Si(So.value);Ja(p)});const kr=document.createElement("div");kr.className="settings-text__row",kr.append(yr,So),vr.appendChild(kr),Ve.appendChild(vr),ge.linkThicknessInput=So;const qn=({id:p,label:P,hint:W,checked:Ce,className:pe="",onChange:$e})=>{const Me=document.createElement("label");Me.className=["settings-toggle",pe].filter(Boolean).join(" ");const Y=document.createElement("input");Y.type="checkbox",Y.id=p,Y.checked=Ce;const Ke=document.createElement("span");Ke.className="settings-toggle__text";const en=document.createElement("span");if(en.className="settings-toggle__label",en.textContent=P,Ke.appendChild(en),W){const Ue=document.createElement("span");Ue.className="settings-toggle__hint",Ue.textContent=W,Ke.appendChild(Ue)}return Me.appendChild(Y),Me.appendChild(Ke),typeof $e=="function"&&Y.addEventListener("change",()=>$e(Y.checked)),{row:Me,input:Y}},va=()=>{_.querySelectorAll(".tile").forEach(p=>{const P=p.dataset.id,W=ei(P);if(!(W!=null&&W.item))return;const Ce=$l(W.item.external),pe=Rl(W.item,{externalMeta:Ce,seriesIdLookup:te});Ol(p,pe)})},{row:xp,input:Tp}=qn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:Cn,className:"map-controls__toggle",onChange:p=>ba(p)});Ve.appendChild(xp),ge.secondaryLinksToggle=Tp;const{row:Ap,input:Lp}=qn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:Tn,className:"map-controls__toggle",onChange:p=>{Tn=p,dr()}});Ve.appendChild(Ap),ge.reusedToggle=Lp;const{row:Np,input:Mp}=qn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:co,className:"map-controls__toggle",onChange:p=>{const P=Ko(p);nl(P)}});Ve.appendChild(Np),ge.autoIdToggle=Mp;const Ir=[],{row:Bp,input:Pp}=qn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:Po,className:"map-controls__toggle",onChange:p=>{const P=Zo(p);pl(P),Ir.forEach(W=>{W.disabled=!P}),va()}});if(Ve.appendChild(Bp),ge.obsidianToggle=Pp,typeof(Qe==null?void 0:Qe.isAvailable)=="function"&&Qe.isAvailable()&&typeof(Qe==null?void 0:Qe.getAutoReloadConfig)=="function"){const{enabled:p,intervalMs:P}=Qe.getAutoReloadConfig();let W=null;const{row:Ce,input:pe}=qn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:p,className:"map-controls__toggle",onChange:Ut=>{Qe.setAutoReloadEnabled(Ut),W&&(W.disabled=!Ut)}});Ve.appendChild(Ce),ge.autoReloadToggle=pe;const $e=Ut=>`${(Ut/1e3).toFixed(2)}s`,Me=document.createElement("label");Me.className="settings-slider",Me.setAttribute("for","autoReloadInterval");const Y=document.createElement("div");Y.className="settings-slider__text";const Ke=document.createElement("span");Ke.className="settings-slider__label",Ke.textContent="Auto-reload interval";const en=document.createElement("span");en.className="settings-slider__hint",en.textContent="Adjust how often to poll for file changes.",Y.append(Ke,en);const Ue=document.createElement("span");Ue.className="settings-slider__value",Ue.textContent=$e(P),W=document.createElement("input"),W.type="range",W.id="autoReloadInterval",W.className="settings-slider__input",W.min=String(Is),W.max=String(_s),W.step="100",W.value=String(P),W.disabled=!p,W.setAttribute("aria-label","Set auto-reload polling interval"),W.addEventListener("input",()=>{const Ut=Qe.setAutoReloadInterval(parseInt(W.value,10));Ue.textContent=$e(Ut)}),Me.append(Y,Ue,W),Ve.appendChild(Me),ge.autoReloadInput=W,ge.autoReloadValue=Ue}const _r=document.createElement("div");_r.className="settings-radio";const Cr=document.createElement("div");Cr.className="settings-radio__label",Cr.textContent="Obsidian link format";const xr=document.createElement("div");xr.className="settings-radio__hint",xr.textContent="Use the tile title or id when building Obsidian links.";const Tr=document.createElement("div");Tr.className="settings-radio__options";const Gl=(p,P)=>{const W=document.createElement("label");W.className="settings-radio__option";const Ce=document.createElement("input");Ce.type="radio",Ce.name="obsidianLinkMode",Ce.value=p,Ce.checked=hi===p,Ce.disabled=!Po,Ce.addEventListener("change",()=>{if(!Ce.checked)return;const $e=Yo(p);ul($e),va()});const pe=document.createElement("span");pe.textContent=P,W.append(Ce,pe),Ir.push(Ce),Tr.appendChild(W)};Gl(Oa,"Use title"),Gl(Zi,"Use id"),_r.append(Cr,Tr,xr),Ve.appendChild(_r),ge.obsidianModeInputs=Ir;const{row:Rp,input:$p}=qn({id:"toggleStripParentheses",label:"Hide parentheses in names",hint:"Display item names without trailing text in parentheses.",checked:gi,className:"map-controls__toggle",onChange:p=>{const P=Xo(p);Za(P)}});Ve.appendChild(Rp),ge.stripParentheticalToggle=$p;const ya=document.createElement("label");ya.className="settings-text",ya.setAttribute("for","obsidianVaultInput");const Ar=document.createElement("div");Ar.className="settings-text__text";const Lr=document.createElement("span");Lr.className="settings-text__label",Lr.textContent="Obsidian vault";const Nr=document.createElement("span");Nr.className="settings-text__hint",Nr.textContent="Optional. Set the vault name to avoid duplicates.",Ar.append(Lr,Nr);const Yn=document.createElement("input");Yn.type="text",Yn.id="obsidianVaultInput",Yn.className="settings-text__input",Yn.placeholder="Vault name",Yn.value=Ro,Yn.addEventListener("input",()=>{const p=Qo(Yn.value);fl(p),va()}),ya.append(Ar,Yn),Ve.appendChild(ya),ge.obsidianVaultInput=Yn;const Mr=document.createElement("p");Mr.className="settings-note",Mr.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',Ve.appendChild(Mr);const Jl=p=>`${(p/1e3).toFixed(1)}s`,Sa=document.createElement("label");Sa.className="settings-slider",Sa.setAttribute("for","seriesNavDoubleClickWait");const Br=document.createElement("div");Br.className="settings-slider__text";const Pr=document.createElement("span");Pr.className="settings-slider__label",Pr.textContent="Series double-click wait";const Rr=document.createElement("span");Rr.className="settings-slider__hint",Rr.textContent="Time window to double-click into another map version.",Br.append(Pr,Rr);const Ri=document.createElement("span");Ri.className="settings-slider__value",Ri.textContent=Jl(Wn);const vn=document.createElement("input");vn.type="range",vn.id="seriesNavDoubleClickWait",vn.className="settings-slider__input",vn.min=String(Ds),vn.max=String(Us),vn.step="50",vn.value=String(Wn),vn.setAttribute("aria-label","Adjust double-click wait for series navigation"),vn.addEventListener("input",()=>{const p=qo(parseInt(vn.value,10));Ri.textContent=Jl(p),dl(p)}),Sa.append(Br,Ri,vn),Ve.appendChild(Sa),ge.seriesNavInput=vn,ge.seriesNavValue=Ri;const Kl=p=>`${Math.round((p-1)*100)}%`,Ea=document.createElement("label");Ea.className="settings-slider",Ea.setAttribute("for","hoverScaleSlider");const $r=document.createElement("div");$r.className="settings-slider__text";const Or=document.createElement("span");Or.className="settings-slider__label",Or.textContent="Hover zoom";const Vr=document.createElement("span");Vr.className="settings-slider__hint",Vr.textContent="Expand tiles on hover to see more detail.",$r.append(Or,Vr);const $i=document.createElement("span");$i.className="settings-slider__value",$i.textContent=Kl(Lo);const yn=document.createElement("input");yn.type="range",yn.id="hoverScaleSlider",yn.className="settings-slider__input",yn.min=String(It),yn.max=String(jt),yn.step="0.1",yn.value=String(Lo),yn.setAttribute("aria-label","Adjust hover zoom"),yn.addEventListener("input",()=>{const p=Ho(parseFloat(yn.value));$i.textContent=Kl(p),Qs(p),K&&go()}),Ea.append($r,$i,yn),Ve.appendChild(Ea),ge.hoverScaleInput=yn,ge.hoverScaleValue=$i;let Qt=null,no=null;const Dr=p=>{const P=Math.round((1-p)*100);return P===0?"Off":`${P}% dim`},{row:Op,input:Vp}=qn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Fn,className:"map-controls__toggle",onChange:p=>{const P=Jo(p);tl(P),Qt&&(Qt.disabled=!P),no&&(no.textContent=Dr(P?Hn:1))}});Ve.appendChild(Op),ge.selectionDimToggle=Vp;const ka=document.createElement("label");ka.className="settings-slider",ka.setAttribute("for","selectionDimmingSlider");const Ur=document.createElement("div");Ur.className="settings-slider__text";const Hr=document.createElement("span");Hr.className="settings-slider__label",Hr.textContent="Dimming strength";const Fr=document.createElement("span");Fr.className="settings-slider__hint",Fr.textContent="Adjust how much unrelated tiles fade when dimming is on.",Ur.append(Hr,Fr),no=document.createElement("span"),no.className="settings-slider__value",no.textContent=Dr(Fn?Hn:1),Qt=document.createElement("input"),Qt.type="range",Qt.id="selectionDimmingSlider",Qt.className="settings-slider__input",Qt.min=String(Yt),Qt.max=String(Ze),Qt.step="0.05",Qt.value=String(Hn),Qt.disabled=!Fn,Qt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Qt.addEventListener("input",()=>{const p=Fo(parseFloat(Qt.value));no.textContent=Dr(p),el(p)}),ka.append(Ur,no,Qt),Ve.appendChild(ka),ge.selectionDimInput=Qt,ge.selectionDimValue=no;const ql=p=>p===1?"Default":`${Math.round(p*100)}%`,Ia=document.createElement("label");Ia.className="settings-slider",Ia.setAttribute("for","tileCompactnessSlider");const Wr=document.createElement("div");Wr.className="settings-slider__text";const jr=document.createElement("span");jr.className="settings-slider__label",jr.textContent="Tile compactness";const zr=document.createElement("span");zr.className="settings-slider__hint",zr.textContent="Adjust padding, gap, and logo size for tiles.",Wr.append(jr,zr);const Oi=document.createElement("span");Oi.className="settings-slider__value",Oi.textContent=ql(No);const Sn=document.createElement("input");Sn.type="range",Sn.id="tileCompactnessSlider",Sn.className="settings-slider__input",Sn.min=String(bs),Sn.max=String(ws),Sn.step="0.05",Sn.value=String(No),Sn.setAttribute("aria-label","Adjust tile compactness"),Sn.addEventListener("input",()=>{const p=Wo(parseFloat(Sn.value));Oi.textContent=ql(p),ol(p),K&&go()}),Ia.append(Wr,Oi,Sn),Ve.appendChild(Ia),ge.tileCompactnessInput=Sn,ge.tileCompactnessValue=Oi;const{row:Dp,input:Up}=qn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:Va!=="nowrap",className:"map-controls__toggle",onChange:p=>{const P=p?"wrap":"nowrap";Go(P),rl(P)}});Ve.appendChild(Dp),ge.titleWrapInput=Up;const Yl=p=>`${Math.round((p-1)*100)}% extra`,_a=document.createElement("label");_a.className="settings-slider",_a.setAttribute("for","titleHoverWidthSlider");const Gr=document.createElement("div");Gr.className="settings-slider__text";const Jr=document.createElement("span");Jr.className="settings-slider__label",Jr.textContent="Title width on hover";const Kr=document.createElement("span");Kr.className="settings-slider__hint",Kr.textContent="Give titles more room horizontally when zoomed.",Gr.append(Jr,Kr);const Vi=document.createElement("span");Vi.className="settings-slider__value",Vi.textContent=Yl(Mo);const En=document.createElement("input");En.type="range",En.id="titleHoverWidthSlider",En.className="settings-slider__input",En.min=String(_e),En.max=String(it),En.step="0.05",En.value=String(Mo),En.setAttribute("aria-label","Adjust title width boost on hover"),En.addEventListener("input",()=>{const p=jo(parseFloat(En.value));Vi.textContent=Yl(p),il(p)}),_a.append(Gr,Vi,En),Ve.appendChild(_a),ge.titleWidthInput=En,ge.titleWidthValue=Vi;const Zl=p=>`${Math.round(p*100)}% of hover zoom`,Ca=document.createElement("label");Ca.className="settings-slider",Ca.setAttribute("for","titleZoomPortionSlider");const qr=document.createElement("div");qr.className="settings-slider__text";const Yr=document.createElement("span");Yr.className="settings-slider__label",Yr.textContent="Title zoom influence";const Zr=document.createElement("span");Zr.className="settings-slider__hint",Zr.textContent="How much the title scales relative to tile hover zoom.",qr.append(Yr,Zr);const Di=document.createElement("span");Di.className="settings-slider__value",Di.textContent=Zl(Bo);const kn=document.createElement("input");kn.type="range",kn.id="titleZoomPortionSlider",kn.className="settings-slider__input",kn.min=String(ms),kn.max=String(hs),kn.step="0.05",kn.value=String(Bo),kn.setAttribute("aria-label","Adjust how much titles scale on hover"),kn.addEventListener("input",()=>{const p=zo(parseFloat(kn.value));Di.textContent=Zl(p),al(p)}),Ca.append(qr,Di,kn),Ve.appendChild(Ca),ge.titleZoomInput=kn,ge.titleZoomValue=Di;const Hp=typeof pt.isEnabled=="function"?pt.isEnabled():!1,{row:Fp,input:Wp}=qn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:Hp,className:"apicurio-toggle",onChange:p=>{typeof pt.setEnabled=="function"&&pt.setEnabled(p)}});if(ee=Wp,Ve.appendChild(Fp),sn.appendChild(Ve),T)T.hidden=!1,T.classList.remove("pf-v5-c-page__main-section"),sn.appendChild(T);else{const p=document.createElement("p");p.className="muted",p.textContent="Source editor unavailable.",sn.appendChild(p)}O.appendChild(sn),pt.mount(A);let Xl=0;re.m.categories.forEach(p=>{const P=document.createElement("section");P.className="category",P.dataset.cat=p.id;const W=ye?zu(p,te):null,Ce=(p.items||[]).some(Y=>yi(Y.stage)),pe=document.createElement("div");pe.className="cat-head",pe.dataset.cat=p.id,pe.tabIndex=0,ye&&Number.isInteger(W)?(pe.dataset.seriesVersionIndex=String(W),pe.title="Open this category's map in the series",pe.classList.add("cat-head--series-link")):pe.title="Select category",pe.innerHTML=`<div class="cat-title">${xi(p.title||p.id)}</div>
                          ${Ce?`<span class="cat-stage-indicator" title="Contains staged items">Stage</span>
                                 <button type="button" class="cat-stage-clear" title="Clear all stages in this category" aria-label="Clear all stages">×</button>`:""}
                          <div class="muted cat-count">${(p.items||[]).length} items</div>`,pe.addEventListener("click",()=>{var Ut;const Y=pe.dataset.seriesVersionIndex!=null?parseInt(pe.dataset.seriesVersionIndex,10):null,Ke=y[w],en=Ke?Gn(Ke):-1;ye&&((Ut=Ke==null?void 0:Ke.apicurioVersions)==null?void 0:Ut.length)>1&&Number.isInteger(Y)&&Y!==en&&fa(w,Y)||Jn(p.id)}),pe.addEventListener("keydown",Y=>{(Y.key==="Enter"||Y.key===" ")&&(Y.preventDefault(),pe.click())});const $e=pe.querySelector(".cat-stage-clear");$e&&$e.addEventListener("click",Y=>{Y.preventDefault(),Y.stopPropagation(),ru(p.id)&&fn("Cleared stages for this category.",1400)}),pe.addEventListener("focus",()=>Jn(p.id,{scrollIntoView:!1})),P.appendChild(pe);const Me=document.createElement("div");if(Me.className="grid"+(Et?" is-centered":""),P.appendChild(Me),(p.items||[]).forEach(Y=>{Xl+=1;const Ke=$l(Y.external),en=Rl(Y,{externalMeta:Ke,seriesIdLookup:te}),Ue=document.createElement("div");if(Ue.className=Ke.isExternal?"tile external":"tile",Ue.tabIndex=0,Ue.dataset.id=Y.id,Ue.dataset.globalIndex=String(Xl),Ke.url&&(Ue.dataset.externalUrl=Ke.url),!ye){let Mn=null;if(te.has(Y.id)&&(Mn=te.get(Y.id)),Number.isInteger(Mn)){Ue.dataset.seriesVersionIndex=String(Mn),Ue.classList.add("tile--series-link");const jp=Mn===Pe?"Current map in this series":`Open version ${Mn+1} in this series`;Oe(Ue,jp)}}en&&(Ue.dataset.obsidianUrl=en);const Ut=yi(Y.stage);if(Ut&&(Ue.dataset.stage=String(Ut),Et&&(Ue.style.gridColumn=String(Ut))),!ye){const Mn=er(Y.id);Mn!==-1&&Mn!==w&&(Ue.classList.add("tile--series-link"),Ue.dataset.navTargetIndex=String(Mn))}const In=document.createElement("img");In.className="logo",Y.logo?(In.src=Y.logo,In.alt=Y.name||Y.id):(In.alt="",In.style.opacity=1,In.src=Wu(Y.name||Y.id,Y.color));const Eo=document.createElement("div");Eo.className="name",Eo.textContent=Ii(Y);const ko=document.createElement("div");ko.className="tile-id",ko.textContent=Y.id||"";let Ui=null;Ut&&(Ui=document.createElement("div"),Ui.className="tile-stage",Ui.textContent=String(Ut));const Xr=document.createElement("div");Xr.className="badge",Xr.textContent="reused";let oo=null;ye||(oo=document.createElement("button"),oo.type="button",oo.className="tile-delete",oo.setAttribute("aria-label",`Delete ${Y.name||Y.id}`),oo.textContent="×",oo.addEventListener("click",Mn=>{Mn.stopPropagation(),yp(Y.id)})),Ke.url&&Ue.appendChild(tp(Ke.url)),Ol(Ue,en),oo&&Ue.appendChild(oo),Ue.appendChild(In),Ue.appendChild(Eo),Ue.appendChild(ko),Ui&&Ue.appendChild(Ui),Ue.appendChild(Xr),Me.appendChild(Ue),M.set(Y.id,{el:Ue,catId:p.id,rect:null})}),mn.appendChild(P),At.set(p.id,{el:P,headEl:pe}),!ye){const Y=document.createElement("button");Y.type="button",Y.className="tile-add",Y.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',Y.hidden=Et,Y.tabIndex=Et?-1:0,Y.setAttribute("aria-hidden",Et?"true":"false"),Y.addEventListener("click",()=>lp(p.id)),Me.appendChild(Y)}});let On=null;ye||(On=document.createElement("button"),On.type="button",On.className="category-add",On.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',On.addEventListener("click",()=>Dl()),mn.appendChild(On)),On&&Et&&(On.hidden=!0,On.tabIndex=-1,On.setAttribute("aria-hidden","true")),js(),dr(),qu(),ma(),Nn(),oi(),ap()}function qu(){_.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var A;if(typeof n.button=="number"&&n.button!==0)return;ho();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,c=y[w],u=c?Gn(c):-1,h=((A=c==null?void 0:c.apicurioVersions)==null?void 0:A.length)>1&&Number.isInteger(i)&&i!==u,m=Number.isInteger(s)&&s!==w&&s>=0&&s<y.length,S=tn&&tn.id===o&&tn.targetVersionIndex===i,O=An&&An.id===o&&An.targetIndex===s;if(tn&&!S&&ni(),An&&!O&&ir(),h)if(S){if(ni(),fa(w,i))return}else _u(o,i,c);else if(m){if(O){ir(),$t(s);return}Cu(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&fn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),K===o&&!(h&&S)&&!(m&&O)){ii();return}Lt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):er(o);i!==-1&&i!==w&&$t(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{K&&go()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),yl||(yl=!0,window.addEventListener("resize",go),window.addEventListener("blockscape:zoom",go),window.addEventListener("scroll",go,{passive:!0}),window.addEventListener("resize",Vl),document.addEventListener("click",e=>{var a,s,c;if(!K&&!ot||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),o=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),i=(c=t==null?void 0:t.closest)==null?void 0:c.call(t,".tile-context-menu");n||o||i||ii()})),document.getElementById("clear").onclick=()=>ii()}function ma(){M.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function Nl(e,{includeSecondary:t=Cn}={}){if(!e||!re)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(re.fwd.get(e)||[]),o=new Set(re.rev.get(e)||[]),i=new Set,a=new Set,s=[],c=new Set,u=(h,m,S,O)=>{if(!h||!m)return;const A=`${h}->${m}:${S}:${O}`;c.has(A)||(c.add(A),s.push({from:h,to:m,type:S,depth:O}))};return n.forEach(h=>u(e,h,"dep",1)),o.forEach(h=>u(e,h,"revdep",1)),t&&new Set([...n,...o]).forEach(m=>{(re.fwd.get(m)||new Set).forEach(A=>{const L=A===e;L||i.add(A),L||u(m,A,"dep",2)}),(re.rev.get(m)||new Set).forEach(A=>{const L=A===e;L||a.add(A),L||u(m,A,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function ha(e,t){const n=M.get(e);n&&n.el.classList.add(t)}function Lt(e){var c,u,h;if(!e)return;ot=null,K=e,bt=null,ft=Nl(e),an(),ga(),oi();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=ft;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=M.get(e);a&&a.el.classList.add("selected"),t.forEach(m=>ha(m,"dep")),n.forEach(m=>ha(m,"revdep")),o.forEach(m=>{!t.has(m)&&m!==e&&ha(m,"dep-indirect")}),i.forEach(m=>{!n.has(m)&&!t.has(m)&&m!==e&&ha(m,"revdep-indirect")}),Nn();const s=(h=(u=(c=M.get(e))==null?void 0:c.el)==null?void 0:u.dataset)==null?void 0:h.externalUrl;s&&fn("This item has link to",so,s),Ka()}function Jn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,c;if(!((s=re==null?void 0:re.m)!=null&&s.categories)||!e)return!1;const i=(re.m.categories||[]).find(u=>u.id===e);if(!i)return!1;ho(),cr(),n||(bt=null),ot=i.id,an(),oi();const a=At.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(c=a.headEl)==null||c.focus({preventScroll:!0})),!0}function oi(){if(At.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!ot)return;const e=At.get(ot);if(!(e!=null&&e.el)){ot=null,bt=null,an();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function Ci(){if(ot)return ot;const e=K?M.get(K):null;return e!=null&&e.catId?e.catId:null}function Yu(e){var a,s,c,u;if(!((s=(a=re==null?void 0:re.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=re.m.categories,n=Ci();let o=t.findIndex(h=>h.id===n);if(o===-1){const h=((c=t.find(m=>(m.items||[]).length))==null?void 0:c.id)||((u=t[0])==null?void 0:u.id);return h?Jn(h):!1}const i=o+e;return i<0||i>=t.length?!1:Jn(t[i].id)}function cr(){K=null,ft=null,ga(),Nn(),Ka({itemId:null})}function Zu(){ot=null,bt=null,oi()}function ii(){cr(),Zu(),bt=null,an()}function ga(){_.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function dr(){re!=null&&re.reusedLocal&&re.reusedLocal.forEach(e=>{const t=M.get(e);if(!t)return;t.el.classList.toggle("reused",Tn);const n=t.el.querySelector(".badge");n&&(n.style.display=Tn?"inline-block":"none")})}function Nn(){for(;G.firstChild;)G.removeChild(G.firstChild);if(!K||G.hidden)return;ft=Nl(K);const e=ft,{primary:t,secondary:n}=rd();e.edges.forEach(o=>{var $,te;const i=($=M.get(o.from))==null?void 0:$.rect,a=(te=M.get(o.to))==null?void 0:te.rect;if(!i||!a)return;const s=Ml(i),c=Ml(a),u=Pl(Bl(i,c)||s,i,$s)||s,h=Pl(Bl(a,s)||c,a,$s)||c,m=document.createElementNS("http://www.w3.org/2000/svg","path"),S=(u.x+h.x)/2,O=u.y,A=(u.x+h.x)/2,L=h.y;m.setAttribute("d",`M ${u.x},${u.y} C ${S},${O} ${A},${L} ${h.x},${h.y}`),m.setAttribute("fill","none"),m.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),m.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),m.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&m.setAttribute("stroke-dasharray","4 3"),m.setAttribute("vector-effect","non-scaling-stroke"),G.appendChild(m)})}function Ml(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Bl(e,t){if(!e||!t)return null;const n=e.left+e.width/2,o=e.top+e.height/2,i=t.x-n,a=t.y-o;if(i===0&&a===0)return{x:n,y:o};const s=e.width/2,c=e.height/2,u=[];i!==0&&u.push((i>0?s:-s)/i),a!==0&&u.push((a>0?c:-c)/a);const h=Math.min(...u.filter(S=>S>0)),m=Number.isFinite(h)?h:0;return{x:n+i*m,y:o+a*m}}function Pl(e,t,n=0){if(!e||!t||n<=0)return e;const o=t.left+t.width/2,i=t.top+t.height/2,a=o-e.x,s=i-e.y,c=Math.hypot(a,s);if(!c)return e;const u=Math.min(n,c/2)/c;return{x:e.x+a*u,y:e.y+s*u}}function xi(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Xu(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),Ro&&o.set("vault",Ro),`obsidian://advanced-uri?${o.toString()}`}function Qu(e){return e?hi===Zi?e.id??e.name??"":e.name??e.id??"":""}function Rl(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!Po||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=Qu(e);return Xu(o)}function $l(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function ep(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),ui(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function tp(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),ui(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Ol(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(ep(t))}function Vl(){he||(he=requestAnimationFrame(()=>{he=null,ke=ke.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),ke.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function np(e,t){!e||!t||(ke.push({labelEl:e,textEl:t}),Vl())}function op(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${xi(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${xi(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function Ti(e,t,{offset:n=8}={}){!ne||!e||!t||(ne.innerHTML=t,ne.hidden=!1,ne.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=ne.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let c=o.left+o.width/2-i.width/2+a,u=o.top-i.height-n+s;c<a+n&&(c=a+n);const h=a+window.innerWidth-i.width-n;c>h&&(c=h),u<s+n&&(u=o.bottom+n+s),ne.style.left=`${c}px`,ne.style.top=`${u}px`,ne.classList.add("is-visible")}))}function Kn(){d&&(clearTimeout(d),d=null),ne&&(ne.classList.remove("is-visible"),ne.setAttribute("aria-hidden","true"),ne.hidden=!0)}function ip(e,t){if(!e)return;const n=Xe((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=op(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{J=e,Ti(e,`<div class="version-nav__tooltip-title">${xi(n)}</div>`,{offset:10})},c=()=>{a(),i=setTimeout(()=>{J===e&&Ti(e,o,{offset:10})},Ge)},u=()=>{s(),c()},h=()=>{J!==e&&s(),c()},m=()=>{a(),J===e&&(J=null,Kn())};e.addEventListener("mouseenter",u),e.addEventListener("focus",u),e.addEventListener("pointermove",h),e.addEventListener("mouseleave",m),e.addEventListener("blur",m),e.addEventListener("click",m)}function ap(){N&&(N=!1,!(!v||!B)&&(Kn(),Ti(v,B,{offset:12}),d=setTimeout(()=>{Kn(),rp()},1e3)))}function rp(){v&&(k&&(clearTimeout(k),k=null),v.classList.add("blockscape-tab--twinkle"),k=setTimeout(()=>{v.classList.remove("blockscape-tab--twinkle"),k=null},1400))}window.addEventListener("scroll",Kn,!0),window.addEventListener("resize",Kn),Ne&&Ne.addEventListener("click",()=>{Au()}),be&&be.addEventListener("click",()=>{Lu()}),nt&&nt.addEventListener("click",()=>{try{ku(),wu()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),ht&&ht.addEventListener("click",ar),V&&V.addEventListener("click",ar),x&&x.addEventListener("click",ua),Q&&Q.addEventListener("click",ua),_&&_.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");xn||!t||!_.contains(t)||pu(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||fu(e)}),Fe&&Fe.addEventListener("click",()=>{wl("button")}),z&&z.addEventListener("click",()=>{if(w<0){alert("Load or select a model before creating a version.");return}try{const e=bl({versionLabel:"map edit"});$t(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),We&&We.addEventListener("click",async()=>{var a;if(w<0||!y[w]){alert("Select or load a model before sharing.");return}const e={title:Xe(y[w],"Shared Model"),data:y[w].data};let t;try{t=Yc(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),U&&U.addEventListener("click",()=>{const e=(f.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};K&&(n.selectedItemId=K),localStorage.setItem(ut,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";K&&(t=`editor.html?selected=${encodeURIComponent(K)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==ut||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||xl("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===Bt&&xl("message")})),document.addEventListener("keydown",e=>{var o,i,a,s,c,u,h,m,S,O;if(Tu()){e.key==="Escape"&&(e.preventDefault(),ar());return}if(!(Z!=null&&Z.hidden)&&e.key==="Escape"){e.preventDefault(),ua();return}if((o=mo==null?void 0:mo.isOpen)==null?void 0:o.call(mo))return;const n=xn;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const A=y[w],L=((i=A==null?void 0:A.apicurioVersions)==null?void 0:i.length)>1;wl("shortcut",L);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!bo())return;if(gp()){e.preventDefault();return}}if(e.key==="Escape"){let A=!1;X&&!X.hidden&&(ho(),A=!0),(K||ot)&&(ii(),A=!0),A&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!bo())return;const A=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if(Et&&e.shiftKey&&K&&!e.ctrlKey&&!e.metaKey&&su(K,A)){e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&!e.shiftKey){lr(A)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(ot&&!e.shiftKey){e.preventDefault();return}e.shiftKey?dp(A)&&e.preventDefault():up(A)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!bo())return;const A=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){hp(A)&&e.preventDefault();return}if(e.altKey)return;if(ot&&!K&&!e.shiftKey){if(fp(A)){e.preventDefault();return}if(Yu(A)){e.preventDefault();return}}e.shiftKey?mp(A)&&e.preventDefault():pp(A)&&e.preventDefault()}if(e.key==="Delete"){if(n||!bo()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const A=ot?vp():!1,L=A?!0:Ul();(A||L)&&e.preventDefault()}if(e.key==="F2"){if(n||!bo())return;const A=ot&&!K&&ot||!K&&((u=(c=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:c.dataset)==null?void 0:u.cat)||null;if(A&&!K&&cp(A)){e.preventDefault();return}const L=K||((O=(S=(m=(h=e.target)==null?void 0:h.closest)==null?void 0:m.call(h,".tile"))==null?void 0:S.dataset)==null?void 0:O.id);L&&mo.open(L)&&e.preventDefault()}if(e.key==="Insert"){if(n||!bo()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Dl()&&e.preventDefault()}}),window.addEventListener("resize",()=>{mu()}),window.addEventListener("scroll",()=>hu(),!0);function sp(e,t,n){if(w<0)return;const i=y[w].data.categories||[],a=i.find(m=>(m.items||[]).some(S=>S.id===e)),s=i.find(m=>m.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const c=a.items.findIndex(m=>m.id===e);if(c===-1)return;const[u]=a.items.splice(c,1);let h=s.items.length;if(t){const m=s.items.findIndex(S=>S.id===t);m!==-1&&(h=m)}s.items.splice(h,0,u),Ot(),Nt()}function lp(e){if(w<0||!e)return;const t=y[w].data,o=(t.categories||[]).find(u=>u.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:lu(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),Ot(),Nt(),ho(),Lt(s.id);const c=M.get(s.id);c!=null&&c.el&&c.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Dl(){if(w<0)return!1;const e=y[w].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=cu(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),ot=n,K=null,ft=null,bt=null,Ot(),Nt(),Jn(n),console.log("[Blockscape] added category",n),!0}function cp(e=Ci()){if(w<0||!e)return!1;const t=uu.open(e);return t&&(K=null,ft=null,an()),t}function dp(e){if(!K||w<0||!e)return!1;const n=y[w].data.categories||[],o=M.get(K);let i=null;if(o!=null&&o.catId&&(i=n.find(u=>u.id===o.catId)),i||(i=n.find(u=>(u.items||[]).some(h=>h.id===K))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(u=>u.id===K);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[c]=i.items.splice(a,1);return i.items.splice(s,0,c),Ot(),Nt(),_i(),Lt(K),!0}function up(e){if(!re||!re.m||!e)return!1;const t=re.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(h=>(h.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!K){const u=n();return u?(Lt(u.item.id),!0):!1}const o=M.get(K);let i=null;if(o!=null&&o.catId&&(i=t.find(u=>u.id===o.catId)),i||(i=t.find(u=>(u.items||[]).some(h=>h.id===K))),!i){const u=n();return u?(Lt(u.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(u=>u.id===K);if(s===-1)return!1;const c=s+e;return c<0||c>=a.length?!1:(Lt(a[c].id),!0)}function pp(e){if(!re||!re.m||!e)return!1;const t=re.m.categories||[];if(!t.length)return!1;const n=Ci();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(K){const c=(t[o].items||[]).findIndex(u=>u.id===K);bt={catId:a.id,position:c===-1?0:c}}else bt=null;return Jn(a.id,{preserveEntryHint:!0})}function fp(e){var a;if(!ot||!((a=re==null?void 0:re.m)!=null&&a.categories)||!e)return!1;const n=(re.m.categories||[]).find(s=>s.id===ot);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(bt==null?void 0:bt.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,bt.position||0))),bt=null,Lt(o[i].id),!0}function mp(e){if(!K||w<0||!e)return!1;const n=y[w].data.categories||[];if(!n.length)return!1;const o=M.get(K);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(S=>S.id===o.catId)),i===-1&&(i=n.findIndex(S=>(S.items||[]).some(O=>O.id===K))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],c=n[a];if(!c)return!1;s.items=s.items||[],c.items=c.items||[];const u=s.items.findIndex(S=>S.id===K);if(u===-1)return!1;const h=Math.min(c.items.length,Math.max(0,u)),m=h<c.items.length?c.items[h].id:null;return sp(K,m,c.id),_i(),Lt(K),!0}function hp(e){if(w<0||!e)return!1;const n=y[w].data.categories||[];if(!n.length)return!1;const o=Ci();if(!o)return!1;const i=n.findIndex(c=>c.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),ot=s.id,cr(),bt=null,an(),Ot(),Nt(),oi(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function gp(){if(w<0)return!1;const e=y[w],t=kt(e)||(e?e.id:null),n=[];if(Pt&&t===Pt.modelId&&n.push({...Pt,type:"item"}),gn&&t===gn.modelId&&n.push({...gn,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(wp(o))return!0}else if(o.type==="item"&&bp(o))return!0;return!1}function bp(e){const t=y[w],n=kt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(c=>c.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),Pt=null,ho(),K=null,ft=null,an(),Ot(),Nt(),_i(),Lt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function wp(e){const t=y[w],n=kt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),gn=null,K=null,ft=null,ot=e.category.id,bt=null,an(),Ot(),Nt(),oi(),Jn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function Ul(){if(!K||w<0)return!1;const t=y[w].data.categories||[];if(!t.length)return!1;const n=M.get(K);let o=null;if(n!=null&&n.catId&&(o=t.find(h=>h.id===n.catId)),o||(o=t.find(h=>(h.items||[]).some(m=>m.id===K))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(h=>h.id===K);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=y[w];Pt={item:a,categoryId:o.id,index:i,modelId:kt(s)||(s?s.id:null),ts:Date.now()};const u=(()=>{var m;if(o.items.length){const S=Math.min(i,o.items.length-1);return((m=o.items[S])==null?void 0:m.id)||null}const h=t.findIndex(S=>S.id===o.id);if(h===-1)return null;for(let S=h+1;S<t.length;S++){const O=t[S].items||[];if(O.length)return O[0].id}for(let S=h-1;S>=0;S--){const O=t[S].items||[];if(O.length)return O[0].id}return null})();return ho(),K=null,ft=null,bt=null,an(),Ot(),Nt(),_i(),u?Lt(u):ii(),console.log("[Blockscape] removed item",a.id),!0}function vp(){var c,u;const e=Ci();if(!e||w<0)return!1;const n=y[w].data.categories||[];if(!n.length)return!1;const o=n.findIndex(h=>h.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=y[w];gn={category:i,index:o,modelId:kt(a)||(a?a.id:null),ts:Date.now()},ot=null,K=null,ft=null,bt=null,an(),Ot(),Nt();const s=((c=n[o])==null?void 0:c.id)||((u=n[o-1])==null?void 0:u.id)||null;return s?Jn(s):ii(),console.log("[Blockscape] removed category",i.id),!0}function yp(e){if(!e)return!1;const t=K;K=e;const n=Ul();return n||(K=t,an()),n}ae&&ae.addEventListener("click",async()=>{const e=f.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await Xs(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),R&&R.addEventListener("click",async()=>{const e=vu();if(!e){alert("No series available to copy. Create another version first.");return}await Xs(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),me&&me.addEventListener("click",async()=>{try{const e=await yd();if(!e){alert("Clipboard is empty.");return}f.value=e,f.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await ki(),t=zn(f.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=Rn(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),w===-1&&n!=null?$t(n):jn(),e&&await Hl(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(w<0){alert("No active model selected.");return}try{const t=JSON.parse(f.value);if(Pn(t,{titleHint:Xe(y[w]),idHint:kt(y[w])||Xe(y[w])}),y[w].data=t,y[w].title=t.title||y[w].title,y[w].isSeries||((e=y[w].apicurioVersions)==null?void 0:e.length)>1){const n=y[w].title||Xe(y[w]);Jt(y[w],{seriesName:n,fallbackTitle:n})}tr(),console.log("[Blockscape] replaced active model:",Xe(y[w])),Nt(),pt.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=zn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((c,u)=>{var $;const h=((($=c.data)==null?void 0:$.title)??"").toString().trim(),m=s.length>1?`${o.name} #${u+1}`:o.name,S=`${a} series`,O=c.isSeries?S:null;let A={...c};if(c.isSeries){const te=O||h||c.title||m||"unknown";A.title=te;const Pe=_n(te||"unknown");fo(A,Pe),Jt(A,{seriesName:te,fallbackTitle:"unknown"}),A.apicurioArtifactName=A.apicurioArtifactName||te}else A.title=h||m;const L=Rn({...A,apicurioArtifactName:A.apicurioArtifactName||O||A.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=L)})}w===-1&&n!=null?$t(n):jn()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",Sp);async function Sp(e){var a;if(!bo())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Vu(t))return;let n=[];try{const s=await ki();n=zn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,c)=>{const u=Rn(s,{versionLabel:n.length>1?`paste #${c+1}`:"paste"});o==null&&(o=u),i.push(u)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&$t(o),await ki()&&await Hl(i,{origin:"clipboard"})}async function Hl(e,{origin:t="clipboard"}={}){if(!await ki()||typeof(Qe==null?void 0:Qe.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter(O=>{const A=y[O];return A&&!A.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=y[o[0]],s=_d(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const c=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(c==null)return;const u=po(c);if(!u){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const h=await kd(),m=[];for(let O=0;O<o.length;O++){const A=o.length===1?u:Ed(u,O+1),L=Id(A,h);if(!L){alert("Could not find a unique filename to save.");return}h.add(L),m.push(L)}let S=null;for(let O=0;O<o.length;O++){const A=o[O],L=m[O],$=y[A];if(!$)continue;o.length===1&&Cd($,L);const te=await Qe.saveModelByIndex(A,L,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(te!=null&&te.ok)){alert(`Local auto-save failed: ${(te==null?void 0:te.error)||"unknown error"}`);return}S==null&&(S=L)}S&&(ra(S),ud(S,{origin:t})),await Qe.refresh(),jn(),fn(`Saved ${o.length} ${i}.`,2500)}q.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&$t(n)}),document.getElementById("removeModel").onclick=()=>{if(w<0)return;const e=Xe(y[w]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",Xe(y[w])),y.splice(w,1),!y.length){w=-1,re=null,_.innerHTML="",G.innerHTML="",f.value="",jn(),tr();return}const n=Math.min(w,y.length-1);$t(n)},Se&&(Se.addEventListener("input",e=>{sr(e.target.value||"")}),Se.addEventListener("focus",()=>{Se.value&&Se.value.trim()&&El(Se.value)})),ue&&ue.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;Bu({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!ue||ue.hidden)return;const t=e.target;ue.contains(t)||Se&&(t===Se||Se.contains(t))||(ue.hidden=!0)}),document.addEventListener("click",e=>{var o,i,a;const t=(i=(o=e.target)==null?void 0:o.closest)==null?void 0:i.call(o,"a[href]");if(!t||(a=t.classList)!=null&&a.contains("blockscape-gist-link")||t.hasAttribute("download"))return;const n=t.getAttribute("href");kc(n)&&(e.preventDefault(),e.stopPropagation(),ui(Ic(n)))}),C&&ce&&j&&C.addEventListener("submit",async e=>{e.preventDefault();const t=ce.value.trim();if(!t){alert("Please enter a URL"),ce.focus();return}const n=await ur(t);if(typeof n=="number"){$t(n),ce.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!ce||!t)return;let n=null;ce.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=ce.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function Nt(){if(!(w<0))try{pa(y[w]),re=Fu(y[w].data),_i()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Ep(){const e=["models.bs"],t=n=>Yi?Yi.endsWith("/")?`${Yi}${n}`:`${Yi}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=zn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(c=>{let u={...c};if(c.isSeries){const h=`${a} series`;u={...c,title:h,apicurioArtifactName:h};const m=_n(h||"unknown");fo(u,m),Jt(u,{seriesName:h,fallbackTitle:"unknown"})}Rn(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}jn()}async function Fl(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function kp(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>Ip(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");jl(i)&&Wl(o,i)})}function Ip(e){var c,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(c=e.parentNode)==null?void 0:c.closest)!=null&&u.call(c,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:h,index:m})=>{m>s&&a.appendChild(document.createTextNode(t.slice(s,m))),a.appendChild(_p(h)),s=m+h.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function _p(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",jl(e)&&Wl(t,e),t}function Wl(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Cp(n,t,e)))}async function Cp(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await ur(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function jl(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function ur(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Fl(e),o=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=zn(t,o)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let a=null;return i.forEach((s,c)=>{var A;const u=(((A=s.data)==null?void 0:A.title)??"").toString().trim(),h=i.length>1?`${o} #${c+1}`:o,m=s.isSeries?`${o} series`:null;let S={...s};if(s.isSeries){const L=m||u||S.title||h;S={...s,title:L,apicurioArtifactName:L||s.apicurioArtifactName};const $=_n(L||"unknown");fo(S,$),Jt(S,{seriesName:L||m||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:$,url:e,baseName:o,seriesTitle:L})}const O=Rn({...S,title:u||S.title||h,apicurioArtifactName:S.apicurioArtifactName||m||s.apicurioArtifactName},{versionLabel:o});a==null&&(a=O)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,o),w===-1&&a!=null?$t(a):jn(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=zn(n,"Blockscape");if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(A=>{const L=Rn(A,{versionLabel:"seed"});i==null&&(i=L)}),await Qc(),!await Hs&&l.autoLoadFromDir&&await Ep();const s=await Uu(),c=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,u=await Hu(),h=Cl(),m=h==null?void 0:h.index,S=Du(),O=typeof c=="number"?c:typeof u=="number"?u:typeof S=="number"?S:typeof m=="number"?m:i??0;$t(O),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===O&&requestAnimationFrame(()=>{var L;if(w!==s.modelIndex)return;const A=(L=M.get(s.itemId))==null?void 0:L.el;A&&(Lt(s.itemId),A.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),A.focus({preventScroll:!0}))})})()}const Lc=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function Nc(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function Mc(r){return Lc(Nc())}const Bc=`${Mc()}documentation/`;function Pc(r){let l;return{c(){l=H("div"),l.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Watch the <a href="https://youtube.com/playlist?list=PLZIp4-s83kaPj5m9VcGXTBhjaquc9fT15&amp;si=aaeXo5ga0D7Vb5LN">videos</a></li> <li>Open the <a href="${Bc}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,g(l,"id","shortcutHelp"),g(l,"class","shortcut-help"),l.hidden=!0,g(l,"aria-hidden","true"),g(l,"role","dialog"),g(l,"aria-modal","true"),g(l,"aria-labelledby","shortcutHelpTitle")},m(f,T){Mt(f,l,T)},p:Ht,i:Ht,o:Ht,d(f){f&&_t(l)}}}class Rc extends Ki{constructor(l){super(),Ji(this,l,null,Pc,Hi,{})}}const $c=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
        * optional \`stage\`: integer 1–4 for Wardley maps only (1=genesis, 2=custom, 3=product, 4=commodity/service). Include only when the user explicitly asks for a Wardley model/series.
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping. Only include the \`stage\` field when explicitly asked for a Wardley map/series.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function us(r){let l,f,T,_,G,ne,q,X;return{c(){l=H("div"),f=H("div"),T=H("a"),_=Fi("Open Blockscape GPT"),G=se(),ne=H("div"),ne.textContent="Paste the copied prompt into that chat.",q=se(),X=H("div"),X.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',g(T,"href",Vc),g(T,"target","_blank"),g(T,"rel","noreferrer"),g(ne,"class","new-panel__hint"),g(f,"class","new-panel__link"),g(X,"class","new-panel__link new-panel__link--disabled"),g(l,"class","new-panel__links")},m(C,ce){Mt(C,l,ce),E(l,f),E(f,T),E(T,_),E(f,G),E(f,ne),E(l,q),E(l,X)},p:Ht,d(C){C&&_t(l)}}}function ps(r){let l,f,T,_,G,ne;return{c(){l=H("div"),f=H("div"),f.textContent="Generated prompt",T=se(),_=H("textarea"),g(f,"class","new-panel__prompt-label"),g(_,"class","pf-v5-c-form-control new-panel__textarea"),g(_,"rows","4"),_.readOnly=!0,g(l,"class","new-panel__prompt")},m(q,X){Mt(q,l,X),E(l,f),E(l,T),E(l,_),ro(_,r[4]),G||(ne=Bn(_,"input",r[12]),G=!0)},p(q,X){X&16&&ro(_,q[4])},d(q){q&&_t(l),G=!1,ne()}}}function Oc(r){let l,f,T,_,G,ne,q,X,C,ce,j,le,fe,rt,He,Fe,We,z,U,ae,R,me,Ne,be,nt,Ie,de,ht,V,Z,x,Q,Se,ue,Ee,Te,we,Ye,st,gt,b,ze,Ct,wt,Ae,ut,Bt,je=r[2]==="gpt"&&us(),lt=r[4]&&r[5]&&ps(r);return Ae=ic(r[10][0]),{c(){l=H("div"),f=H("div"),T=se(),_=H("div"),G=H("div"),G.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',ne=se(),q=H("form"),X=H("div"),C=H("label"),C.textContent="Domain",ce=se(),j=H("p"),j.textContent="Describe what you want to create a map for.",le=se(),fe=H("textarea"),rt=se(),He=H("div"),Fe=H("label"),We=H("input"),z=se(),U=H("span"),U.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,ae=se(),R=H("fieldset"),me=H("legend"),me.textContent="Target",Ne=se(),be=H("p"),be.textContent="Choose where you plan to use the prompt.",nt=se(),Ie=H("label"),de=H("input"),ht=se(),V=H("div"),V.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',Z=se(),x=H("label"),Q=H("input"),Se=se(),ue=H("div"),ue.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',Ee=se(),Te=H("div"),we=H("button"),we.textContent="Copy prompt",Ye=se(),st=H("button"),st.textContent="New blank",gt=se(),b=H("div"),ze=Fi(r[3]),Ct=se(),je&&je.c(),wt=se(),lt&&lt.c(),g(f,"id","newPanelBackdrop"),g(f,"class","shortcut-help__backdrop"),g(G,"class","shortcut-help__header"),g(C,"for","newDomain"),g(j,"class","new-panel__hint"),g(fe,"id","newDomain"),g(fe,"class","pf-v5-c-form-control new-panel__textarea"),g(fe,"rows","4"),fe.required=!0,g(fe,"placeholder","Ex: Companies building open-source geospatial tools"),g(X,"class","new-panel__field"),g(We,"id","seriesToggle"),g(We,"type","checkbox"),g(Fe,"class","new-panel__toggle"),g(Fe,"for","seriesToggle"),g(He,"class","new-panel__field"),g(be,"class","new-panel__hint"),g(de,"type","radio"),g(de,"name","target"),de.__value="gpt",ro(de,de.__value),g(Ie,"class","new-panel__option"),g(Q,"type","radio"),g(Q,"name","target"),Q.__value="plain",ro(Q,Q.__value),g(x,"class","new-panel__option"),g(R,"class","new-panel__field"),g(we,"class","pf-v5-c-button pf-m-primary"),g(we,"type","submit"),g(st,"id","newBlankButton"),g(st,"class","pf-v5-c-button pf-m-secondary"),g(st,"type","button"),g(st,"title","Start from an empty map"),g(b,"class","new-panel__status"),g(b,"aria-live","polite"),g(Te,"class","new-panel__actions"),g(q,"class","shortcut-help__list new-panel__form"),g(_,"class","shortcut-help__panel"),g(_,"tabindex","-1"),g(l,"id","newPanel"),g(l,"class","shortcut-help"),l.hidden=!0,g(l,"aria-hidden","true"),g(l,"role","dialog"),g(l,"aria-modal","true"),g(l,"aria-labelledby","newPanelTitle"),Ae.p(de,Q)},m(y,w){Mt(y,l,w),E(l,f),E(l,T),E(l,_),E(_,G),E(_,ne),E(_,q),E(q,X),E(X,C),E(X,ce),E(X,j),E(X,le),E(X,fe),ro(fe,r[0]),E(q,rt),E(q,He),E(He,Fe),E(Fe,We),We.checked=r[1],E(Fe,z),E(Fe,U),E(q,ae),E(q,R),E(R,me),E(R,Ne),E(R,be),E(R,nt),E(R,Ie),E(Ie,de),de.checked=de.__value===r[2],E(Ie,ht),E(Ie,V),E(R,Z),E(R,x),E(x,Q),Q.checked=Q.__value===r[2],E(x,Se),E(x,ue),E(q,Ee),E(q,Te),E(Te,we),E(Te,Ye),E(Te,st),E(Te,gt),E(Te,b),E(b,ze),E(q,Ct),je&&je.m(q,null),E(q,wt),lt&&lt.m(q,null),ut||(Bt=[Bn(fe,"input",r[7]),Bn(We,"change",r[8]),Bn(de,"change",r[9]),Bn(Q,"change",r[11]),Bn(q,"submit",oc(r[6]))],ut=!0)},p(y,[w]){w&1&&ro(fe,y[0]),w&2&&(We.checked=y[1]),w&4&&(de.checked=de.__value===y[2]),w&4&&(Q.checked=Q.__value===y[2]),w&8&&ns(ze,y[3]),y[2]==="gpt"?je?je.p(y,w):(je=us(),je.c(),je.m(q,wt)):je&&(je.d(1),je=null),y[4]&&y[5]?lt?lt.p(y,w):(lt=ps(y),lt.c(),lt.m(q,null)):lt&&(lt.d(1),lt=null)},i:Ht,o:Ht,d(y){y&&_t(l),je&&je.d(),lt&&lt.d(),Ae.r(),ut=!1,Io(Bt)}}}const Vc="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function Dc(r,l,f){let T="",_=!1,G="gpt",ne="",q="",X=!1;const C=()=>{var z;return typeof navigator<"u"&&!!((z=navigator.clipboard)!=null&&z.writeText)};function ce(z){const U=z||"[DOMAIN]",ae=_?"series":"map",me=$c.replaceAll("[DOMAIN NAME]",U).replaceAll("[DOMAIN]",U).replaceAll("[map|series]",ae).split(`
`),Ne=`Generate a **blockscape ${ae}** for the domain of ${U}.`,be=me.findIndex(Ie=>Ie.toLowerCase().includes("generate a **blockscape value")||Ie.toLowerCase().includes("generate a blockscape [map|series]")||Ie.toLowerCase().startsWith("generate a blockscape"));be>=0?me[be]=Ne:me.unshift(Ne);const nt=_?`

User requested a series (return an array of models).`:"";return`${me.join(`
`).trim()}${nt}`}async function j(z){z.preventDefault();const U=T.trim();if(f(3,ne=""),f(5,X=G!=="gpt"),!U){f(3,ne="Add a domain to generate a prompt."),f(4,q="");return}if(G==="gpt"?f(4,q=`${_?"Create a series":"Create a map"} for ${U}`):(f(4,q=ce(U)),f(5,X=!0)),!C()){f(3,ne="Clipboard access is unavailable. Copy the prompt below."),f(5,X=!0);return}try{await navigator.clipboard.writeText(q),f(3,ne=G==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),G==="gpt"&&f(5,X=!1)}catch(R){console.warn("[Blockscape] clipboard write failed",R),f(3,ne="Copy failed. Use the prompt below."),f(5,X=!0)}}const le=[[]];function fe(){T=this.value,f(0,T)}function rt(){_=this.checked,f(1,_)}function He(){G=this.__value,f(2,G)}function Fe(){G=this.__value,f(2,G)}function We(){q=this.value,f(4,q)}return[T,_,G,ne,q,X,j,fe,rt,He,le,Fe,We]}class Uc extends Ki{constructor(l){super(),Ji(this,l,Dc,Oc,Hi,{})}}const{document:fs}=nc;function Hc(r){let l,f,T,_,G,ne,q,X,C,ce,j,le,fe,rt,He,Fe,We,z,U,ae,R,me,Ne,be,nt,Ie,de,ht,V,Z,x,Q,Se,ue,Ee,Te,we,Ye,st,gt,b,ze,Ct,wt,Ae,ut,Bt,je,lt,y,w,pt,re,M,At,K,ot,ft,bt,Cn,xn,Tn,Kt,Pt,gn,cn,Un,so,tn,Ft,An,Wt,dn,qt,Ln,d,v,B,N,k,D,ee,J,ke,he,Le=`<script id="seed" type="application/json">${r[5]}<\/script>`,Ge,mt,xe,It,jt,vt,Be,qe,Yt,Ze,xt,St,yt,Rt,pn;return Ze=new Rc({}),St=new Uc({}),{c(){l=H("link"),f=se(),T=H("div"),_=H("header"),G=H("div"),ne=H("div"),q=H("div"),X=H("div"),X.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',C=se(),ce=H("div"),j=H("div"),le=H("button"),fe=H("span"),fe.textContent="Advanced",rt=se(),He=H("span"),He.textContent="▾",We=se(),z=H("button"),z.textContent="New",U=se(),ae=H("label"),ae.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',R=se(),me=H("div"),Ne=H("span"),Ne.textContent="Zoom",be=se(),nt=H("button"),nt.textContent="-",Ie=se(),de=H("button"),ht=Fi(r[1]),V=se(),Z=H("button"),Z.textContent="+",x=se(),Q=H("button"),Q.textContent="Share",Se=se(),ue=H("button"),ue.textContent="Help",Ee=se(),Te=H("div"),we=H("div"),we.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',Ye=se(),st=H("form"),st.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',gt=se(),b=H("button"),b.textContent="Edit",Ae=se(),ut=H("a"),ut.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',je=se(),lt=H("main"),y=H("div"),w=H("aside"),pt=H("div"),pt.textContent="Models",re=se(),M=H("ul"),At=se(),K=H("div"),K.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',ot=se(),ft=H("section"),bt=H("div"),bt.innerHTML='<div class="sidebar-heading">Local files</div> <button id="toggleServerSidebar" class="pf-v5-c-button pf-m-tertiary" type="button" aria-pressed="false" hidden="">Wide menu</button>',Cn=se(),xn=H("p"),xn.textContent="Checking for local server…",Tn=se(),Kt=H("div"),Pt=H("label"),Pt.textContent="Blockscape files under ~/blockscape",gn=se(),cn=H("div"),Un=H("label"),Un.textContent="Folder",so=se(),tn=H("select"),Ft=H("option"),Ft.textContent="Root (~/blockscape)",An=se(),Wt=H("select"),dn=se(),qt=H("div"),qt.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button> <button id="deleteLocalFile" class="pf-v5-c-button pf-m-danger" type="button">Delete</button>',Ln=se(),d=H("div"),d.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',B=se(),N=H("div"),N.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,stage?:1-4,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,k=se(),D=H("footer"),ee=H("div"),ee.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',ke=se(),he=new rc(!1),Ge=se(),mt=ts("svg"),xe=se(),It=H("div"),jt=se(),vt=H("div"),Be=se(),qe=H("div"),qe.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',Yt=se(),Na(Ze.$$.fragment),xt=se(),Na(St.$$.fragment),fs.title="Blockscape — simple landscape-style tiles",g(l,"rel","icon"),g(l,"type","image/svg+xml"),g(l,"href","./favicon.svg"),g(X,"class","blockscape-brand"),g(fe,"class","blockscape-toolbar__toggle-label"),g(He,"class","blockscape-toolbar__toggle-icon"),g(He,"aria-hidden","true"),g(le,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),g(le,"type","button"),g(le,"aria-expanded",r[0]),g(le,"aria-controls","blockscapeHeaderExtras"),g(le,"aria-label",Fe=r[0]?"Hide advanced tools":"Show advanced tools"),g(z,"id","newPanelButton"),g(z,"class","pf-v5-c-button pf-m-primary"),g(z,"type","button"),g(z,"title","Create something new"),g(ae,"class","pf-v5-c-button pf-m-primary blockscape-file"),g(Ne,"class","blockscape-zoom__label"),g(nt,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),g(nt,"type","button"),g(nt,"title","Zoom out (Ctrl -)"),g(de,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__reset"),g(de,"type","button"),g(de,"title","Reset zoom (Ctrl 0)"),g(Z,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),g(Z,"type","button"),g(Z,"title","Zoom in (Ctrl +)"),g(me,"class","blockscape-zoom"),g(me,"role","group"),g(me,"aria-label","Zoom controls"),g(Q,"id","shareModel"),g(Q,"class","pf-v5-c-button pf-m-secondary"),g(Q,"type","button"),g(Q,"title","Copy a shareable URL for this model"),g(ue,"id","helpButton"),g(ue,"class","pf-v5-c-button pf-m-primary"),g(ue,"type","button"),g(ue,"title","Show keyboard shortcuts"),g(j,"class","blockscape-toolbar__primary"),g(we,"class","blockscape-search"),g(st,"id","urlForm"),g(st,"class","blockscape-url-form"),g(st,"autocomplete","on"),st.noValidate=!0,g(b,"id","openInEditor"),g(b,"class","pf-v5-c-button pf-m-secondary"),g(b,"type","button"),g(b,"title","Open current JSON in the editor"),g(Te,"id","blockscapeHeaderExtras"),g(Te,"class","blockscape-toolbar__extras"),Te.hidden=ze=!r[0],g(Te,"aria-hidden",Ct=!r[0]),g(ce,"class","blockscape-toolbar__controls"),g(ce,"data-expanded",wt=r[0]?"true":"false"),g(ut,"href","https://github.com/pwright/blockscape"),g(ut,"target","_blank"),g(ut,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),g(ut,"title","View on GitHub"),g(ut,"aria-label","View Blockscape on GitHub"),g(q,"class","blockscape-toolbar"),g(ne,"class","pf-v5-c-masthead__content"),g(G,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),g(_,"class","pf-v5-c-page__header"),_.hidden=Bt=!r[4],g(pt,"class","sidebar-heading"),g(M,"id","modelList"),g(M,"class","model-nav-list"),g(K,"class","model-actions"),g(bt,"class","local-backend__header"),g(xn,"id","localBackendStatus"),g(xn,"class","local-backend__status muted"),g(Pt,"class","sr-only"),g(Pt,"for","localFileList"),g(Un,"for","localDirSelect"),Ft.__value="",ro(Ft,Ft.__value),g(tn,"id","localDirSelect"),g(tn,"class","pf-v5-c-form-control"),g(tn,"aria-label","Folder filter"),g(cn,"class","local-backend__dir"),g(Wt,"id","localFileList"),g(Wt,"class","pf-v5-c-form-control"),g(Wt,"size","12"),Wt.multiple=!0,g(Wt,"aria-label","Blockscape files on local server"),g(qt,"class","local-backend__actions"),g(Kt,"class","local-backend__list"),g(d,"class","local-backend__save"),g(ft,"id","localBackendPanel"),g(ft,"class","local-backend"),ft.hidden=!0,g(w,"class","blockscape-sidebar"),g(w,"aria-label","Models"),w.hidden=v=!r[3],g(N,"class","blockscape-main"),g(y,"class","blockscape-content"),g(lt,"class","pf-v5-c-page__main"),g(ee,"class","blockscape-footer__inner"),g(D,"class","pf-v5-c-page__footer blockscape-footer"),D.hidden=J=!r[2],g(T,"class","pf-v5-c-page"),he.a=Ge,g(mt,"id","overlay"),g(mt,"class","svg-layer"),g(It,"id","tabTooltip"),g(It,"class","blockscape-tab-tooltip"),It.hidden=!0,g(It,"aria-hidden","true"),g(vt,"id","tileContextMenu"),g(vt,"class","tile-context-menu"),vt.hidden=!0,g(vt,"aria-hidden","true"),g(qe,"id","itemPreview"),g(qe,"class","item-preview"),qe.hidden=!0,g(qe,"aria-hidden","true")},m(_e,it){E(fs.head,l),Mt(_e,f,it),Mt(_e,T,it),E(T,_),E(_,G),E(G,ne),E(ne,q),E(q,X),E(q,C),E(q,ce),E(ce,j),E(j,le),E(le,fe),E(le,rt),E(le,He),E(j,We),E(j,z),E(j,U),E(j,ae),E(j,R),E(j,me),E(me,Ne),E(me,be),E(me,nt),E(me,Ie),E(me,de),E(de,ht),E(me,V),E(me,Z),E(j,x),E(j,Q),E(j,Se),E(j,ue),E(ce,Ee),E(ce,Te),E(Te,we),E(Te,Ye),E(Te,st),E(Te,gt),E(Te,b),E(q,Ae),E(q,ut),E(T,je),E(T,lt),E(lt,y),E(y,w),E(w,pt),E(w,re),E(w,M),E(w,At),E(w,K),E(w,ot),E(w,ft),E(ft,bt),E(ft,Cn),E(ft,xn),E(ft,Tn),E(ft,Kt),E(Kt,Pt),E(Kt,gn),E(Kt,cn),E(cn,Un),E(cn,so),E(cn,tn),E(tn,Ft),E(Kt,An),E(Kt,Wt),E(Kt,dn),E(Kt,qt),E(ft,Ln),E(ft,d),E(y,B),E(y,N),E(T,k),E(T,D),E(D,ee),Mt(_e,ke,it),he.m(Le,_e,it),Mt(_e,Ge,it),Mt(_e,mt,it),Mt(_e,xe,it),Mt(_e,It,it),Mt(_e,jt,it),Mt(_e,vt,it),Mt(_e,Be,it),Mt(_e,qe,it),Mt(_e,Yt,it),zi(Ze,_e,it),Mt(_e,xt,it),zi(St,_e,it),yt=!0,Rt||(pn=[Bn(le,"click",r[6]),Bn(nt,"click",r[8]),Bn(de,"click",r[9]),Bn(Z,"click",r[7])],Rt=!0)},p(_e,[it]){(!yt||it&1)&&g(le,"aria-expanded",_e[0]),(!yt||it&1&&Fe!==(Fe=_e[0]?"Hide advanced tools":"Show advanced tools"))&&g(le,"aria-label",Fe),(!yt||it&2)&&ns(ht,_e[1]),(!yt||it&1&&ze!==(ze=!_e[0]))&&(Te.hidden=ze),(!yt||it&1&&Ct!==(Ct=!_e[0]))&&g(Te,"aria-hidden",Ct),(!yt||it&1&&wt!==(wt=_e[0]?"true":"false"))&&g(ce,"data-expanded",wt),(!yt||it&16&&Bt!==(Bt=!_e[4]))&&(_.hidden=Bt),(!yt||it&8&&v!==(v=!_e[3]))&&(w.hidden=v),(!yt||it&4&&J!==(J=!_e[2]))&&(D.hidden=J)},i(_e){yt||(ji(Ze.$$.fragment,_e),ji(St.$$.fragment,_e),yt=!0)},o(_e){La(Ze.$$.fragment,_e),La(St.$$.fragment,_e),yt=!1},d(_e){_e&&(_t(f),_t(T),_t(ke),he.d(),_t(Ge),_t(mt),_t(xe),_t(It),_t(jt),_t(vt),_t(Be),_t(qe),_t(Yt),_t(xt)),_t(l),Gi(Ze,_e),Gi(St,_e),Rt=!1,Io(pn)}}}function Fc(r,l,f){let T,_,G,ne,{seed:q}=l,{features:X={}}=l;const ce=q?JSON.stringify(q,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let j=!1;const le=[{label:"S",value:.9},{label:"M",value:1},{label:"L",value:1.15}];let fe=1;const rt=()=>{if(f(0,j=!j),!j){const U=document.getElementById("search");U&&U.value&&(U.value="",U.dispatchEvent(new Event("input",{bubbles:!0})))}},He=()=>{const U=le[fe].value;document.documentElement.style.setProperty("--blockscape-scale",String(U)),window.dispatchEvent(new CustomEvent("blockscape:zoom",{detail:{scale:U}}))},Fe=()=>{f(12,fe=Math.min(le.length-1,fe+1)),He()},We=()=>{f(12,fe=Math.max(0,fe-1)),He()},z=()=>{f(12,fe=1),He()};return lc(()=>{Ac(X),He();const U=ae=>{if(!(!ae.ctrlKey&&!ae.metaKey)){if(ae.key==="="||ae.key==="+"){Fe(),ae.preventDefault();return}if(ae.key==="-"||ae.key==="_"){We(),ae.preventDefault();return}ae.key==="0"&&(z(),ae.preventDefault())}};return window.addEventListener("keydown",U),()=>window.removeEventListener("keydown",U)}),r.$$set=U=>{"seed"in U&&f(10,q=U.seed),"features"in U&&f(11,X=U.features)},r.$$.update=()=>{r.$$.dirty&2048&&f(4,T=X.showHeader!==!1),r.$$.dirty&2048&&f(3,_=X.showSidebar!==!1),r.$$.dirty&2048&&f(2,G=X.showFooter!==!1),r.$$.dirty&4096&&f(1,ne=`${Math.round(le[fe].value*100)}%`)},[j,ne,G,_,T,ce,rt,Fe,We,z,q,X,fe]}class Wc extends Ki{constructor(l){super(),Ji(this,l,Fc,Hc,Hi,{seed:10,features:11})}}function jc(r){let l,f;return l=new Wc({props:{seed:r[0],features:r[1]}}),{c(){Na(l.$$.fragment)},m(T,_){zi(l,T,_),f=!0},p(T,[_]){const G={};_&1&&(G.seed=T[0]),_&2&&(G.features=T[1]),l.$set(G)},i(T){f||(ji(l.$$.fragment,T),f=!0)},o(T){La(l.$$.fragment,T),f=!1},d(T){Gi(l,T)}}}function zc(r,l,f){let{seed:T}=l,{features:_={}}=l;return r.$$set=G=>{"seed"in G&&f(0,T=G.seed),"features"in G&&f(1,_=G.features)},[T,_]}class Gc extends Ki{constructor(l){super(),Ji(this,l,zc,jc,Hi,{seed:0,features:1})}}return Gc}();
