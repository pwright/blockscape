var Blockscape=function(){"use strict";var Bp=Object.defineProperty;var $p=(Pn,Ht,io)=>Ht in Pn?Bp(Pn,Ht,{enumerable:!0,configurable:!0,writable:!0,value:io}):Pn[Ht]=io;var oo=(Pn,Ht,io)=>$p(Pn,typeof Ht!="symbol"?Ht+"":Ht,io);var Pn=typeof document<"u"?document.currentScript:null;function Ht(){}function io(r){return r()}function jr(){return Object.create(null)}function So(r){r.forEach(io)}function zr(r){return typeof r=="function"}function Ri(r,l){return r!=r?l==l:r!==l||r&&typeof r=="object"||typeof r=="function"}function Gl(r){return Object.keys(r).length===0}const Jl=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function E(r,l){r.appendChild(l)}function Bt(r,l,m){r.insertBefore(l,m||null)}function _t(r){r.parentNode&&r.parentNode.removeChild(r)}function D(r){return document.createElement(r)}function Gr(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function Oi(r){return document.createTextNode(r)}function ae(){return Oi(" ")}function Bn(r,l,m,A){return r.addEventListener(l,m,A),()=>r.removeEventListener(l,m,A)}function Kl(r){return function(l){return l.preventDefault(),r.call(this,l)}}function w(r,l,m){m==null?r.removeAttribute(l):r.getAttribute(l)!==m&&r.setAttribute(l,m)}function ql(r){let l;return{p(...m){l=m,l.forEach(A=>r.push(A))},r(){l.forEach(m=>r.splice(r.indexOf(m),1))}}}function Yl(r){return Array.from(r.childNodes)}function Jr(r,l){l=""+l,r.data!==l&&(r.data=l)}function ao(r,l){r.value=l??""}class Zl{constructor(l=!1){oo(this,"is_svg",!1);oo(this,"e");oo(this,"n");oo(this,"t");oo(this,"a");this.is_svg=l,this.e=this.n=null}c(l){this.h(l)}m(l,m,A=null){this.e||(this.is_svg?this.e=Gr(m.nodeName):this.e=D(m.nodeType===11?"TEMPLATE":m.nodeName),this.t=m.tagName!=="TEMPLATE"?m:m.content,this.c(l)),this.i(A)}h(l){this.e.innerHTML=l,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(l){for(let m=0;m<this.n.length;m+=1)Bt(this.t,this.n[m],l)}p(l){this.d(),this.h(l),this.i(this.a)}d(){this.n.forEach(_t)}}let ii;function ai(r){ii=r}function Xl(){if(!ii)throw new Error("Function called outside component initialization");return ii}function Ql(r){Xl().$$.on_mount.push(r)}const Eo=[],Kr=[];let ko=[];const qr=[],ec=Promise.resolve();let va=!1;function tc(){va||(va=!0,ec.then(Yr))}function ya(r){ko.push(r)}const Sa=new Set;let Io=0;function Yr(){if(Io!==0)return;const r=ii;do{try{for(;Io<Eo.length;){const l=Eo[Io];Io++,ai(l),nc(l.$$)}}catch(l){throw Eo.length=0,Io=0,l}for(ai(null),Eo.length=0,Io=0;Kr.length;)Kr.pop()();for(let l=0;l<ko.length;l+=1){const m=ko[l];Sa.has(m)||(Sa.add(m),m())}ko.length=0}while(Eo.length);for(;qr.length;)qr.pop()();va=!1,Sa.clear(),ai(r)}function nc(r){if(r.fragment!==null){r.update(),So(r.before_update);const l=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,l),r.after_update.forEach(ya)}}function oc(r){const l=[],m=[];ko.forEach(A=>r.indexOf(A)===-1?l.push(A):m.push(A)),m.forEach(A=>A()),ko=l}const Pi=new Set;let ic;function Vi(r,l){r&&r.i&&(Pi.delete(r),r.i(l))}function Ea(r,l,m,A){if(r&&r.o){if(Pi.has(r))return;Pi.add(r),ic.c.push(()=>{Pi.delete(r)}),r.o(l)}}function ka(r){r&&r.c()}function Di(r,l,m){const{fragment:A,after_update:_}=r.$$;A&&A.m(l,m),ya(()=>{const j=r.$$.on_mount.map(io).filter(zr);r.$$.on_destroy?r.$$.on_destroy.push(...j):So(j),r.$$.on_mount=[]}),_.forEach(ya)}function Ui(r,l){const m=r.$$;m.fragment!==null&&(oc(m.after_update),So(m.on_destroy),m.fragment&&m.fragment.d(l),m.on_destroy=m.fragment=null,m.ctx=[])}function ac(r,l){r.$$.dirty[0]===-1&&(Eo.push(r),tc(),r.$$.dirty.fill(0)),r.$$.dirty[l/31|0]|=1<<l%31}function Hi(r,l,m,A,_,j,te=null,G=[-1]){const Z=ii;ai(r);const C=r.$$={fragment:null,ctx:[],props:j,update:Ht,not_equal:_,bound:jr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(Z?Z.$$.context:[])),callbacks:jr(),dirty:G,skip_bound:!1,root:l.target||Z.$$.root};te&&te(C.root);let le=!1;if(C.ctx=m?m(r,l.props||{},(F,re,...Ce)=>{const it=Ce.length?Ce[0]:re;return C.ctx&&_(C.ctx[F],C.ctx[F]=it)&&(!C.skip_bound&&C.bound[F]&&C.bound[F](it),le&&ac(r,F)),re}):[],C.update(),le=!0,So(C.before_update),C.fragment=A?A(C.ctx):!1,l.target){if(l.hydrate){const F=Yl(l.target);C.fragment&&C.fragment.l(F),F.forEach(_t)}else C.fragment&&C.fragment.c();l.intro&&Vi(r.$$.fragment),Di(r,l.target,l.anchor),Yr()}ai(Z)}class Fi{constructor(){oo(this,"$$");oo(this,"$$set")}$destroy(){Ui(this,1),this.$destroy=Ht}$on(l,m){if(!zr(m))return Ht;const A=this.$$.callbacks[l]||(this.$$.callbacks[l]=[]);return A.push(m),()=>{const _=A.indexOf(m);_!==-1&&A.splice(_,1)}}$set(l){this.$$set&&!Gl(l)&&(this.$$.skip_bound=!0,this.$$set(l),this.$$.skip_bound=!1)}}const rc="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(rc);const Zr="blockscape:apicurioConfig",Ia="http://localhost:8080/apis/registry/v3",Wi="bs",Xr="-series",_a=!1,Ca=!1;function sc({models:r,getActiveIndex:l,setActive:m,ensureModelMetadata:A,ensureSeriesId:_,getModelId:j,getSeriesId:te,getModelTitle:G,computeJsonFingerprint:Z,uid:C}){let le=null,F=null,re=null,Ce=null,it=null,Ge=null,Ve=null,Ue=null,W=null,J=null;const Q=new Set,M={baseUrl:Ia,groupId:Wi,authToken:"",enabled:_a,useSemver:Ca},pe=new Map,Be=new Map;function me(d){return(d||"").toString().trim().replace(/\/+$/,"")}function et(d){return`${(d||"").toString().trim()||Wi}${Xr}`}function we(){return!!(M.baseUrl&&M.groupId)}function ce(){return M.enabled!==!1}function ut(){Q.forEach(d=>{try{d(ce())}catch(y){console.warn("[Blockscape] failed to run Apicurio enabled listener",y)}})}function P(d){return typeof d=="function"&&Q.add(d),()=>Q.delete(d)}function Y(){re&&(re.value=M.baseUrl||""),Ce&&(Ce.value=M.groupId||""),it&&(it.value=M.authToken||""),Ge&&(Ge.checked=ce()),Ve&&(Ve.checked=!!M.useSemver)}function x(d="",y="muted"){Ue&&(Ue.textContent=d||"",Ue.classList.remove("is-error","is-success"),y==="error"?Ue.classList.add("is-error"):y==="success"&&Ue.classList.add("is-success"))}function X(d){if(!J||(J.innerHTML="",!d))return;const y=document.createElement("p");y.className="apicurio-hint",y.textContent=d,J.appendChild(y)}function Ee(d){pe.clear(),Be.clear(),X(d)}function de(){const d=l(),y=ce(),B=we(),N=d>=0?r[d]:null,k=!!(N!=null&&N.apicurioVersions&&N.apicurioVersions.length>1);if(le){const V=le.dataset.loading==="true",ee=y&&B&&d>=0&&!!xe(r[d]);le.disabled=!y||V||!ee,y?V||(le.textContent="Push to Apicurio"):le.textContent="Enable Apicurio to push"}if(W){const V=W.dataset.loading==="true",ee=y&&B&&k&&!!xe(N);W.disabled=!ee||V,W.hidden=!k,y?V||(W.textContent="Push series"):W.textContent="Enable Apicurio to push series"}if(F){const V=F.dataset.loading==="true",ee=y&&B;F.disabled=!ee||V,V||(y?B?F.textContent="List artifacts":F.textContent="Enter details to list":F.textContent="Enable Apicurio to list")}}function ge(){Y(),ce()?we()?(x("Apicurio push is ready when a model is selected.","muted"),pe.size||X("Click “List artifacts” to browse the current group.")):(x("Enter Apicurio connection details to enable push.","muted"),Ee("Enter registry details to browse artifacts.")):(x("Apicurio integration is off. Enable it to allow pushes.","muted"),Ee("Apicurio integration is disabled.")),de()}function ve(){if(window!=null&&window.localStorage)try{localStorage.setItem(Zr,JSON.stringify(M))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function b(){let d={};if(window!=null&&window.localStorage)try{const V=localStorage.getItem(Zr);if(V){const ee=JSON.parse(V);ee&&typeof ee=="object"&&(d=ee)}}catch(V){console.warn("[Blockscape] failed to restore Apicurio settings",V)}const y=me(d.baseUrl??Ia),B=(d.groupId??Wi).toString().trim();let N=_a,k=Ca;typeof d.enabled=="boolean"?N=d.enabled:typeof d.enabled=="string"&&(N=d.enabled==="true"),typeof d.useSemver=="boolean"?k=d.useSemver:typeof d.useSemver=="string"&&(k=d.useSemver==="true"),M.baseUrl=y||Ia,M.groupId=B||Wi,M.authToken=(d.authToken??"").toString().trim(),M.enabled=N,M.useSemver=k,ge(),ut()}function Le(){const d={Accept:"application/json"},y=(M.authToken||"").trim();return y&&(d.Authorization=/\s/.test(y)?y:`Bearer ${y}`),d}function Ye(d,y,{title:B,description:N,version:k}={}){const V={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:y},metadata:{properties:{}}}};k&&(V.firstVersion.version=k),B&&(V.name=B),N&&(V.description=N);try{const ee=JSON.parse(y),z=ee==null?void 0:ee.seriesId;z&&typeof z=="string"&&(V.firstVersion.metadata.properties.seriesId=z)}catch{}return V}function wt(d,{version:y}={}){const B={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const N=JSON.parse(d),k=N==null?void 0:N.seriesId;k&&typeof k=="string"&&(B.metadata.properties.seriesId=k)}catch{}return y&&(B.version=y),B}function lt(d){if(d==null)return null;const y=String(d).trim();if(!y)return null;const B=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(y);if(B)return{major:Number(B[1]),minor:Number(B[2]),patch:Number(B[3])};const N=/^v?(\d+)$/.exec(y);return N?{major:Number(N[1]),minor:0,patch:0}:null}function dt(d){return`${d.major}.${d.minor}.${d.patch}`}function xt(d,y){return!d&&!y?0:d?y?d.major!==y.major?d.major-y.major:d.minor!==y.minor?d.minor-y.minor:d.patch-y.patch:1:-1}function vt(d=[]){let y=null;if(d.forEach(N=>{const k=lt((N==null?void 0:N.version)??N);k&&(!y||xt(k,y)>0)&&(y=k)}),!y)return"1.0.0";const B={...y,patch:y.patch+1};return dt(B)}function xe(d,{seriesName:y,fallbackTitle:B}={}){var V;if(!d)return null;const N=y||d.title||d.apicurioArtifactName||G(d),k=B||N;if(typeof _=="function"&&(d.isSeries||((V=d.apicurioVersions)==null?void 0:V.length)>1)&&_(d,{seriesName:N,fallbackTitle:k}),typeof te=="function"){const ee=te(d,{seriesName:N,fallbackTitle:k});if(ee)return ee}return j(d)}function at(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function At(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function Fe(d=[]){if(!Array.isArray(d)||!d.length)return null;const y=[...d].filter(Boolean);return y.sort((B,N)=>{const k=B!=null&&B.createdOn?new Date(B.createdOn).getTime():0,V=N!=null&&N.createdOn?new Date(N.createdOn).getTime():0;if(k!==V)return V-k;const ee=Number(B==null?void 0:B.version),z=Number(N==null?void 0:N.version),be=Number.isFinite(ee),fe=Number.isFinite(z);if(be&&fe&&ee!==z)return z-ee;const Ne=String((B==null?void 0:B.version)??"");return String((N==null?void 0:N.version)??"").localeCompare(Ne,void 0,{numeric:!0})}),y[0]||null}function rt(d){if(!d)return d;let y=d;if(!Array.isArray(d==null?void 0:d.categories)){const N=d==null?void 0:d.content;if(typeof N=="string")try{y=JSON.parse(N)}catch(k){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",k)}else N&&typeof N=="object"&&(y=N)}return y}async function u(d,y,B){const N=encodeURIComponent(y),k=encodeURIComponent(B),V=`${d}/groups/${N}/artifacts/${k}`,ee=Le();ee.Accept="application/json";const z=await fetch(V,{method:"GET",headers:ee});if(!z.ok){let be=z.statusText||"Unknown error";try{const fe=await z.text();fe&&(be=fe.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${z.status}): ${be}`)}return z.json()}async function v(d,y,B){const N=encodeURIComponent(y),k=encodeURIComponent(B),V=`${d}/groups/${N}/artifacts/${k}/versions?limit=50&order=desc`,ee=Le();ee.Accept="application/json";const z=await fetch(V,{method:"GET",headers:ee});if(!z.ok){let fe=z.statusText||"Unknown error";try{const Ne=await z.text();Ne&&(fe=Ne.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${z.status}): ${fe}`)}const be=await z.json();return At(be).filter(fe=>fe&&fe.version!=null)}async function pt(d,y,B,N="latest"){const k=encodeURIComponent(y),V=encodeURIComponent(B),ee=encodeURIComponent(N||"latest"),z=`${d}/groups/${k}/artifacts/${V}/versions/${ee}/content`,be=Le();be.Accept="application/json, application/*+json, */*;q=0.8";const fe=await fetch(z,{method:"GET",headers:be});if(!fe.ok){let ct=fe.statusText||"Unknown error";try{const Ae=await fe.text();Ae&&(ct=Ae.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${fe.status}): ${ct}`)}const Ne=await fe.text();let We=null;try{We=JSON.parse(Ne)}catch{throw new Error("Artifact content is not valid JSON.")}return rt(We)}async function se(d,y,B,N="latest"){const k=await pt(d,y,B,N);return{data:k,fingerprint:Z(k)}}async function ft(d,y,B){try{const k=await v(d,y,B);if(k!=null&&k.length){Be.set(B,k);const V=Fe(k);if((V==null?void 0:V.version)!=null)return V.version}}catch(k){console.warn("[Blockscape] compare-version: unable to fetch versions list",k)}try{const k=await u(d,y,B);if((k==null?void 0:k.version)!=null)return k.version}catch(k){console.warn("[Blockscape] compare-version: unable to fetch metadata",k)}const N=Be.get(B);if(N&&N.length){const k=Fe(N);if((k==null?void 0:k.version)!=null)return k.version}return"latest"}async function In(d,y,B,N){if(!M.useSemver)return null;if(!N)return"1.0.0";try{const k=await v(d,y,B);return vt(k)}catch(k){throw new Error(`Unable to compute next semantic version: ${k.message}`)}}function K(d=document){le=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),W=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),F=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),re=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),Ce=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),it=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),Ge=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),Ve=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),Ue=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),J=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function tt(){M.baseUrl=me((re==null?void 0:re.value)??M.baseUrl),M.groupId=((Ce==null?void 0:Ce.value)??"").trim(),M.authToken=((it==null?void 0:it.value)??"").trim(),ve(),ge()}function st(d){M.enabled=d!==!1,ve(),ge(),ut()}function mt(){st(Ge?Ge.checked:_a)}function _n(){M.useSemver=Ve?Ve.checked:Ca,ve(),ge()}function Cn(){[re,Ce,it].forEach(d=>{d&&d.addEventListener("input",tt)}),le&&le.addEventListener("click",()=>{An()}),W&&W.addEventListener("click",()=>{Wt()}),Ge&&Ge.addEventListener("change",mt),Ve&&Ve.addEventListener("change",_n),F&&F.addEventListener("click",sn),J&&J.addEventListener("click",d=>{const y=d.target.closest("[data-artifact-version]");if(y){d.stopPropagation();const k=y.dataset.artifactId,V=y.dataset.artifactVersion;k&&V&&qt(k,V);return}const B=d.target.closest("[data-artifact-load-all]");if(B){d.stopPropagation(),B.dataset.artifactId&&Tn();return}const N=d.target.closest("[data-artifact-trigger]");if(N){const k=N.dataset.artifactId;if(!k)return;so(k)}})}function xn(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function Kt(d){if(!d)return;d.innerHTML="";const y=xn();d.appendChild(y),K(d),Cn(),ge()}function $t(d){if(!J)return;if(J.innerHTML="",!d.length){X("No artifacts found in this group.");return}const y=k=>{const V=document.createElement("section");V.className="apicurio-artifact-section";const ee=document.createElement("h3");ee.textContent=k,V.appendChild(ee);const z=document.createElement("ul");return z.className="apicurio-artifact-list",V.appendChild(z),{section:V,list:z}},B=y("Series artifacts"),N=y("Artifacts");d.forEach(k=>{if(!(k!=null&&k.artifactId))return;const ee=k._groupId&&k._groupId.endsWith(Xr)?B.list:N.list,z=document.createElement("li"),be=document.createElement("button");be.type="button",be.className="apicurio-artifact",be.dataset.artifactId=k.artifactId,be.dataset.artifactTrigger="toggle";const fe=document.createElement("span");fe.className="apicurio-artifact-title",fe.textContent=k.artifactId,be.appendChild(fe);const Ne=[];if(k.name&&Ne.push(k.name),k.version!=null&&Ne.push(`v${k.version}`),k.type&&Ne.push(k.type),k._groupId&&Ne.push(k._groupId),Ne.length){const Ae=document.createElement("span");Ae.className="apicurio-artifact-meta",Ae.textContent=Ne.join(" • "),be.appendChild(Ae)}if(k.description){const Ae=document.createElement("span");Ae.className="apicurio-artifact-meta",Ae.textContent=k.description,be.appendChild(Ae)}z.appendChild(be);const We=document.createElement("div");We.className="apicurio-version-list",We.dataset.versionPanel=k.artifactId,We.hidden=!0;const ct=document.createElement("p");ct.className="apicurio-hint",ct.textContent="Click to load the latest or open versions.",We.appendChild(ct),z.appendChild(We),ee.appendChild(z)}),B.list.children.length&&J.appendChild(B.section),N.list.children.length&&J.appendChild(N.section)}function hn(d){return J?J.querySelector(`[data-version-panel="${d}"]`):null}function rn(d,y){if(!d||(d.innerHTML="",!y))return;const B=document.createElement("p");B.className="apicurio-hint",B.textContent=y,d.appendChild(B)}function Dn(d,y){const B=hn(d);if(B){if(B.innerHTML="",!y.length){rn(B,"No versions found for this artifact.");return}y.forEach(N=>{const k=document.createElement("button");k.type="button",k.className="apicurio-version-button",k.dataset.artifactId=d,k.dataset.artifactVersion=N.version;const V=[`Version ${N.version}`];if(N.createdOn){const ee=new Date(N.createdOn);isNaN(ee)||V.push(ee.toISOString().slice(0,10))}k.textContent=V.join(" — "),B.appendChild(k)})}}async function so(d){const y=hn(d);if(!y)return;if(y.dataset.open==="true"){y.hidden=!0,y.dataset.open="false";return}if(y.hidden=!1,y.dataset.open="true",y.dataset.loaded!=="true"){if(!we()){rn(y,"Enter registry details first.");return}rn(y,"Loading versions…");try{const N=me(M.baseUrl),k=pe.get(d),V=M.groupId.trim(),ee=(k==null?void 0:k._groupId)||V,z=await v(N,ee,d);Be.set(d,z),y.dataset.loaded="true",Dn(d,z)}catch(N){console.error("[Blockscape] failed to load versions",N),rn(y,`Unable to fetch versions: ${N.message}`)}}}function en(d,y){var N;const B=r.findIndex(k=>k.apicurioArtifactId===d);if(B!==-1){const k=r[B].id;r[B]={...y,id:k||y.id},((N=r[B].apicurioVersions)==null?void 0:N.length)>1&&(r[B].isSeries=!0),m(B)}else r.push(y),m(r.length-1)}async function Ft(d,y,B,N){const k=encodeURIComponent(y),V=encodeURIComponent(B),ee=`${d}/groups/${k}/artifacts/${V}`;try{const z=await fetch(ee,{method:"GET",headers:N});if(z.status===404)return!1;if(z.ok)return!0;throw z.status===401||z.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${z.status} while checking the artifact.`)}catch(z){throw z instanceof TypeError?new Error("Network error while contacting Apicurio registry."):z}}async function An(){var ee;if(!le||le.dataset.loading==="true")return;if(!ce()){x("Apicurio integration is off. Enable it first.","error");return}if(!we()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=l();if(d<0||!r[d]){x("No active model to push.","error");return}const y=xe(r[d],{fallbackTitle:G(r[d])});if(!y){x("Active model needs an id before pushing.","error");return}const B=me(M.baseUrl),N=M.groupId.trim(),k=JSON.stringify(r[d].data,null,2),V=Le();le.dataset.loading="true",le.textContent="Pushing…",le.disabled=!0,x("Pushing to Apicurio…","muted");try{const z=await Ft(B,N,y,V),be=Z(r[d].data);if(z)try{const Ke=await ft(B,N,y),{data:Ct,fingerprint:yt}=await se(B,N,y,Ke);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",Ke),console.log("local fingerprint",be),console.log("registry fingerprint",yt),console.log("local payload",r[d].data),console.log("registry payload",Ct),console.groupEnd(),be&&yt&&be===yt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){x("Push cancelled (content matches the latest registry version).","muted");return}x("Pushing identical content by user choice.","muted")}else yt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(Ke){console.warn("[Blockscape] unable to compare registry content before push",Ke),x("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const fe=M.useSemver?await In(B,N,y,z):null;if(M.useSemver&&!fe)throw new Error("Semantic versioning is enabled but no version could be computed.");const Ne=encodeURIComponent(N),We=encodeURIComponent(y),ct=z?`${B}/groups/${Ne}/artifacts/${We}/versions`:`${B}/groups/${Ne}/artifacts`,Ae={...V,"Content-Type":"application/json"};fe&&(Ae["X-Registry-Version"]=fe,x(`Pushing to Apicurio as version ${fe}…`,"muted"));const It=z?wt(k,{version:fe}):Ye(y,k,{title:G(r[d]),description:(ee=r[d].data)==null?void 0:ee.abstract,version:fe}),jt=await fetch(ct,{method:"POST",headers:Ae,body:JSON.stringify(It)});if(!jt.ok){let Ke=jt.statusText||"Unknown error";try{const Ct=await jt.text();Ct&&(Ke=Ct.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${jt.status}): ${Ke}`)}let gt=null;try{gt=await jt.json()}catch{gt=null}const Oe=(gt==null?void 0:gt.version)||(gt==null?void 0:gt.globalId)||"",Je=z?"Updated":"Created",Yt=Oe?` (version ${Oe})`:"";x(`${Je} ${y}${Yt}`,"success")}catch(z){console.error("[Blockscape] Apicurio push failed",z),x(`Apicurio push failed: ${z.message}`,"error")}finally{le.dataset.loading="false",de()}}async function Wt(){var fe,Ne;if(!W||W.dataset.loading==="true")return;if(!ce()){x("Apicurio integration is off. Enable it first.","error");return}if(!we()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=l(),y=d>=0?r[d]:null;if(!y||!y.apicurioVersions||y.apicurioVersions.length<2){x("Series push requires a model with multiple versions.","error");return}const B=xe(y,{seriesName:y.title||y.apicurioArtifactName||G(y)});if(!B){x("Active series needs an id before pushing.","error");return}typeof _=="function"&&_(y,{seriesName:y.title||y.apicurioArtifactName||G(y)});const N=me(M.baseUrl),k=M.groupId.trim(),V=y.apicurioVersions.map(We=>We.data),ee=JSON.stringify(V,null,2),z=Le(),be=et(k);W.dataset.loading="true",W.textContent="Pushing…",W.disabled=!0,x("Pushing series to Apicurio…","muted");try{const We=await Ft(N,be,B,z),ct=Z(V);if(We)try{const Rt=await ft(N,be,B),{data:pn,fingerprint:ye}=await se(N,be,B,Rt);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",Rt),console.log("local fingerprint",ct),console.log("registry fingerprint",ye),console.log("local payload (series)",V),console.log("registry payload",pn),console.groupEnd(),ct&&ye&&ct===ye){if(!window.confirm("The current registry version matches this series. Push anyway?")){x("Series push cancelled (content matches latest).","muted");return}x("Pushing identical series by user choice.","muted")}else ye?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(Rt){console.warn("[Blockscape] unable to compare registry content before series push",Rt),x("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const Ae=M.useSemver?await In(N,be,B,We):null;if(M.useSemver&&!Ae)throw new Error("Semantic versioning is enabled but no version could be computed.");const It=encodeURIComponent(be),jt=encodeURIComponent(B),gt=We?`${N}/groups/${It}/artifacts/${jt}/versions`:`${N}/groups/${It}/artifacts`,Oe={...z,"Content-Type":"application/json"};Ae&&(Oe["X-Registry-Version"]=Ae,x(`Pushing series to Apicurio as version ${Ae}…`,"muted"));const Je=We?wt(ee,{version:Ae}):Ye(B,ee,{title:y.apicurioArtifactName||((fe=y.data)==null?void 0:fe.title)||B,description:(Ne=y.data)==null?void 0:Ne.abstract,version:Ae}),Yt=await fetch(gt,{method:"POST",headers:Oe,body:JSON.stringify(Je)});if(!Yt.ok){let Rt=Yt.statusText||"Unknown error";try{const pn=await Yt.text();pn&&(Rt=pn.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${Yt.status}): ${Rt}`)}let Ke=null;try{Ke=await Yt.json()}catch{Ke=null}const Ct=(Ke==null?void 0:Ke.version)||(Ke==null?void 0:Ke.globalId)||"",yt=We?"Updated":"Created",bt=Ct?` (version ${Ct})`:"";x(`${yt} ${B} series${bt}`,"success")}catch(We){console.error("[Blockscape] Apicurio series push failed",We),x(`Apicurio series push failed: ${We.message}`,"error")}finally{W.dataset.loading="false",de()}}async function sn(){if(!F||F.dataset.loading==="true")return;if(!ce()){x("Enable Apicurio integration to list artifacts.","error");return}if(!we()){x("Enter registry base URL and group ID before listing.","error");return}const d=me(M.baseUrl),y=M.groupId.trim(),B=et(y),N=[{groupId:y,label:"base"},{groupId:B,label:"series"}];F.dataset.loading="true",F.textContent="Listing…",F.disabled=!0,x("Listing artifacts…","muted"),X("Contacting registry…");try{const k=Le();k.Accept="application/json";const V=[];for(const z of N){const be=encodeURIComponent(z.groupId),fe=`${d}/groups/${be}/artifacts?limit=50&offset=0`,Ne=await fetch(fe,{method:"GET",headers:k});if(!Ne.ok){let Ae=Ne.statusText||"Unknown error";try{const It=await Ne.text();It&&(Ae=It.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${z.groupId} (${Ne.status}): ${Ae}`);continue}const We=await Ne.json(),ct=at(We).filter(Ae=>Ae&&Ae.artifactId);ct.forEach(Ae=>{Ae&&(Ae._groupId=z.groupId)}),V.push(...ct)}pe.clear(),Be.clear(),V.forEach(z=>{z!=null&&z.artifactId&&pe.set(z.artifactId,z)}),$t(V);const ee=V.length;x(ee?`Found ${ee} artifact${ee===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",ee?"success":"muted")}catch(k){console.error("[Blockscape] failed to list artifacts",k),Ee("Unable to list artifacts."),x(`Listing failed: ${k.message}`,"error")}finally{F.dataset.loading="false",de()}}async function qt(d,y=null){var We,ct,Ae,It,jt,gt;if(!d)return;if(!ce()){x("Enable Apicurio integration to load artifacts.","error");return}if(!we()){x("Enter registry connection details before loading artifacts.","error");return}const B=me(M.baseUrl),N=M.groupId.trim(),k=d&&((We=pe.get(d))==null?void 0:We._groupId)||N;let V=pe.get(d);const ee=async()=>{try{const Oe=await u(B,k,d);return Oe!=null&&Oe.artifactId&&pe.set(d,Oe),Oe}catch(Oe){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",Oe),Oe}};if(!V)try{V=await ee()}catch(Oe){x(`Failed to fetch artifact metadata: ${Oe.message}`,"error");return}const z=Be.get(d)||[];let be="latest",fe="latest";if(y)be=y,fe=y;else{if(!V||V.version==null)try{V=await ee()}catch(Oe){x(`Failed to fetch artifact metadata: ${Oe.message}`,"error");return}be=(V==null?void 0:V.version)||"latest",fe=(V==null?void 0:V.version)||"latest"}const Ne=z.find(Oe=>String(Oe.version)===String(be));(Ne==null?void 0:Ne.version)!=null&&(fe=Ne.version),x(`Loading artifact ${d}…`,"muted");try{const Oe=await pt(B,k,d,be),Je=pe.get(d)||V||{},Yt=Array.isArray(Oe);let Ke=null;if(Yt){const Ct=Oe.map((bt,Rt)=>(A(bt,{titleHint:Je.name||d,idHint:d}),{version:String(Rt+1),data:bt,createdOn:(Ne==null?void 0:Ne.createdOn)||Je.createdOn}));Ke={id:C(),title:((Ae=(ct=Ct[0])==null?void 0:ct.data)==null?void 0:Ae.title)||Je.name||d,data:(It=Ct[0])==null?void 0:It.data,apicurioArtifactId:d,apicurioArtifactName:Je.name||"",apicurioVersions:Ct,apicurioActiveVersionIndex:0,isSeries:!0};const yt=((jt=Je==null?void 0:Je.properties)==null?void 0:jt.seriesId)||d;typeof _=="function"&&_(Ke,{seriesName:yt,fallbackTitle:yt}),x(`Loaded series artifact ${d}.`,"success")}else{A(Oe,{titleHint:Je.name||d,idHint:d});const Ct={version:fe,data:Oe,createdOn:(Ne==null?void 0:Ne.createdOn)||Je.createdOn};Ke={id:C(),title:Oe.title||Je.name||d,data:Oe,apicurioArtifactId:d,apicurioArtifactName:Je.name||"",apicurioVersions:[Ct],apicurioActiveVersionIndex:0};const yt=(gt=Je==null?void 0:Je.properties)==null?void 0:gt.seriesId;yt&&typeof _=="function"&&_(Ke,{seriesName:yt,fallbackTitle:yt});const bt=fe?` (version ${fe})`:"";x(`Loaded artifact ${d}${bt}.`,"success")}en(d,Ke)}catch(Oe){console.error("[Blockscape] failed to load artifact",Oe),x(`Failed to load artifact: ${Oe.message}`,"error")}}async function Tn(d){}return{hydrateConfig:b,mount:Kt,updateAvailability:de,isEnabled:ce,setEnabled:st,onEnabledChange:P}}const Gt={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Zn(r,l){if(typeof r!="function")throw new Error(`[itemEditor] expected ${l} to be a function`)}function lc(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}const xa=1,Aa=4;function cc(r){if(r==null)return null;const l=Number(r);if(!Number.isFinite(l))return null;const m=Math.round(l);return m<xa||m>Aa?null:m}function dc(r,{excludeId:l}={}){if(!r)return[];const m=r.split(/[\s,]+/).map(_=>_.trim()).filter(Boolean),A=[];return m.forEach(_=>{l&&_===l||A.includes(_)||A.push(_)}),A}function uc(r,l,m){if(!l||!m||l===m)return;((r==null?void 0:r.categories)||[]).forEach(_=>{(_.items||[]).forEach(j=>{Array.isArray(j.deps)&&(j.deps=j.deps.map(te=>te===l?m:te))})})}function pc({findItemAndCategoryById:r,collectAllItemIds:l,updateItemReferences:m,loadActiveIntoEditor:A,rebuildFromActive:_,select:j,onSelectionRenamed:te,makeSlug:G=lc,isAutoIdFromNameEnabled:Z=()=>!0}={}){Zn(r,"findItemAndCategoryById"),Zn(l,"collectAllItemIds"),Zn(m,"updateItemReferences"),Zn(A,"loadActiveIntoEditor"),Zn(_,"rebuildFromActive"),Zn(j,"select"),Zn(G,"makeSlug"),Zn(Z,"isAutoIdFromNameEnabled");const C={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function le(W){if(C.fields.errorEl){if(!W){C.fields.errorEl.hidden=!0,C.fields.errorEl.textContent="";return}C.fields.errorEl.hidden=!1,C.fields.errorEl.textContent=W}}function F(){C.wrapper&&(C.wrapper.hidden=!0,C.wrapper.setAttribute("aria-hidden","true"),le(""),C.categoryId=null,C.itemId=null,C.modelData=null,document.body.classList.remove("item-editor-open"))}function re(){C.wrapper&&(C.wrapper.hidden=!1,C.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var W,J;(W=C.fields.nameInput)==null||W.focus(),(J=C.fields.nameInput)==null||J.select()}))}function Ce({force:W}={}){var Q,M;if(!((Q=C.fields)!=null&&Q.idInput)||!((M=C.fields)!=null&&M.nameInput)||!C.autoSyncEnabled||!Z()||!W&&C.autoIdManuallyEdited)return;const J=G(C.fields.nameInput.value||C.itemId||"item");C.fields.idInput.value=J}function it(W){var ut;if(!C.modelData||!C.categoryId||!C.itemId)throw new Error("No item loaded.");const Q=(((ut=C.modelData)==null?void 0:ut.categories)||[]).find(P=>P.id===C.categoryId);if(!Q)throw new Error("Category not found.");Q.items=Q.items||[];const M=Q.items.find(P=>P.id===C.itemId);if(!M)throw new Error("Item not found.");const pe=(W.id||"").trim();if(!pe)throw new Error("ID is required.");const Be=l(C.modelData);if(pe!==M.id&&Be.has(pe))throw new Error("Another item already uses that ID.");M.id=pe;const me=(W.name||"").trim();M.name=me||M.id;const et=(W.logo||"").trim();if(et?M.logo=et:delete M.logo,W.externalFlag&&!W.external)M.external=!0;else{const P=(W.external??"").toString().trim();P?M.external=P:delete M.external}const we=(W.color||"").trim();we?M.color=we:delete M.color;const ce=cc(W.stage);return ce!=null?M.stage=ce:delete M.stage,M.deps=Array.isArray(W.deps)?W.deps:[],M.id!==W.originalId&&typeof te=="function"&&te(W.originalId,M.id),m(C.modelData,W.originalId,M.id),A(),_(),j(M.id),M.id}function Ge(){if(!C.fields||!C.fields.idInput)return!1;const W=(C.fields.idInput.value||"").trim(),J={originalId:C.itemId,id:W,name:C.fields.nameInput.value||"",logo:C.fields.logoInput.value||"",external:C.fields.externalInput.value||"",externalFlag:C.fields.externalFlagInput.checked,color:C.fields.colorInput.value||"",stage:C.fields.stageInput.value,deps:dc(C.fields.depsInput.value,{excludeId:W})};try{return it(J),F(),!0}catch(Q){return console.warn("[itemEditor] item edit failed",Q),le((Q==null?void 0:Q.message)||"Unable to save item."),!1}}function Ve(){if(C.wrapper)return C.wrapper;const W=document.createElement("div");W.className="item-editor-modal",W.hidden=!0,W.setAttribute("role","dialog"),W.setAttribute("aria-modal","true");const J=document.createElement("div");J.className="item-editor-modal__backdrop",W.appendChild(J);const Q=document.createElement("div");Q.className="item-editor",W.appendChild(Q);const M=document.createElement("div");M.className="item-editor__header";const pe=document.createElement("h2");pe.className="item-editor__title",pe.textContent="Edit item";const Be=document.createElement("button");Be.type="button",Be.className="item-editor__close",Be.setAttribute("aria-label","Close item editor"),Be.textContent="×",M.appendChild(pe),M.appendChild(Be),Q.appendChild(M);const me=document.createElement("form");me.className="item-editor__form",Q.appendChild(me);const et=document.createElement("div");et.className="item-editor__meta",et.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',me.appendChild(et);const we=document.createElement("div");we.className="item-editor__error",we.hidden=!0,me.appendChild(we);const ce=(Fe,rt,u)=>{const v=document.createElement("label");v.className="item-editor__field";const pt=document.createElement("span");if(pt.className="item-editor__label",pt.textContent=Fe,v.appendChild(pt),rt.classList.add("item-editor__control"),v.appendChild(rt),u){const se=document.createElement("div");se.className="item-editor__hint",se.textContent=u,v.appendChild(se)}return v},ut=document.createElement("input");ut.type="text",ut.required=!0,me.appendChild(ce("ID",ut,"Unique identifier used for dependencies."));const P=document.createElement("input");P.type="text",me.appendChild(ce("Name",P,"Visible label shown on the tile."));const Y=document.createElement("input");Y.type="url",Y.inputMode="url",Y.placeholder="https://…",me.appendChild(ce("Logo URL",Y,"Optional image URL."));const x=document.createElement("input");x.type="url",x.inputMode="url",x.placeholder="https://…",me.appendChild(ce("External link",x,"Shown with ↗ icon and in preview."));const X=document.createElement("div");X.className="item-editor__checkbox";const Ee=document.createElement("label");Ee.className="item-editor__checkbox-row";const de=document.createElement("input");de.type="checkbox";const ge=document.createElement("span");ge.textContent="Mark as external without link";const ve=document.createElement("div");ve.className="item-editor__hint",ve.textContent="Keeps dashed border even without a URL.",Ee.appendChild(de),Ee.appendChild(ge),X.appendChild(Ee),X.appendChild(ve),me.appendChild(X);const b=document.createElement("input");b.type="text",b.placeholder=Gt.color.primary,me.appendChild(ce("Color",b,"Optional badge color (hex or CSS color)."));const Le=document.createElement("input");Le.type="number",Le.min=String(xa),Le.max=String(Aa),Le.inputMode="numeric",Le.placeholder=`${xa}-${Aa}`,me.appendChild(ce("Stage",Le,"Optional 1 (far left) to 4 (far right) when Center view is on."));const Ye=document.createElement("textarea");Ye.rows=2,Ye.placeholder="Comma or space separated ids",me.appendChild(ce("Dependencies",Ye,"Use item IDs, separated by commas or spaces."));const wt=document.createElement("div");wt.className="item-editor__checkbox";const lt=document.createElement("label");lt.className="item-editor__checkbox-row";const dt=document.createElement("input");dt.type="checkbox";const xt=document.createElement("span");xt.textContent="Sync ID while editing name";const vt=document.createElement("div");vt.className="item-editor__hint",vt.textContent="Turn off to keep typing names without changing the ID.",lt.appendChild(dt),lt.appendChild(xt),wt.appendChild(lt),wt.appendChild(vt),me.appendChild(wt);const xe=document.createElement("div");xe.className="item-editor__actions";const at=document.createElement("button");at.type="button",at.className="pf-v5-c-button pf-m-tertiary",at.textContent="Cancel";const At=document.createElement("button");return At.type="submit",At.className="pf-v5-c-button pf-m-primary",At.textContent="Save",xe.appendChild(at),xe.appendChild(At),me.appendChild(xe),C.wrapper=W,C.fields={idInput:ut,nameInput:P,logoInput:Y,externalInput:x,externalFlagInput:de,colorInput:b,stageInput:Le,depsInput:Ye,syncCheckbox:dt,categoryValue:et.querySelector(".item-editor__meta-value"),errorEl:we},at.addEventListener("click",F),Be.addEventListener("click",F),J.addEventListener("click",F),ut.addEventListener("input",()=>{C.autoIdManuallyEdited=!0}),P.addEventListener("input",Ce),dt.addEventListener("change",()=>{C.autoSyncEnabled=!!dt.checked,C.autoSyncEnabled&&(C.autoIdManuallyEdited=!1,Ce({force:!0}))}),me.addEventListener("submit",Fe=>{Fe.preventDefault(),Ge()}),document.addEventListener("keydown",Fe=>{Fe.key==="Escape"&&!W.hidden&&(Fe.preventDefault(),Fe.stopPropagation(),F())}),document.body.appendChild(W),W}function Ue(W){const J=r(W);if(!J)return!1;Ve(),C.categoryId=J.category.id,C.itemId=J.item.id,C.modelData=J.modelData,C.autoIdManuallyEdited=!1;const Q=!!Z();return C.autoSyncEnabled=Q,C.fields.categoryValue.textContent=J.category.title||J.category.id,C.fields.idInput.value=J.item.id||"",C.fields.nameInput.value=J.item.name||"",C.fields.logoInput.value=J.item.logo||"",C.fields.externalInput.value=typeof J.item.external=="string"?J.item.external:"",C.fields.externalFlagInput.checked=J.item.external===!0,C.fields.colorInput.value=J.item.color||"",C.fields.stageInput.value=J.item.stage??"",C.fields.depsInput.value=Array.isArray(J.item.deps)?J.item.deps.join(", "):"",C.fields.syncCheckbox.checked=C.autoSyncEnabled,C.fields.syncCheckbox.disabled=!Q,!C.fields.idInput.value&&Q&&Ce({force:!0}),le(""),j(J.item.id),re(),!0}return{open:Ue,hide:F,isOpen:()=>!!C.wrapper&&!C.wrapper.hidden}}function fc(){return typeof window<"u"&&window.Neutralino&&window.Neutralino.os&&typeof window.Neutralino.os.open=="function"}function ri(r){if(!r)return!1;if(fc())try{return window.Neutralino.os.open(r),!0}catch(l){console.warn("[Blockscape] failed to open external url",r,l)}return window.open(r,"_blank","noopener"),!0}function mc(r){if(!r||r.startsWith("#")||/^javascript:/i.test(r))return!1;try{const l=new URL(r,window.location.href);return l.protocol==="http:"||l.protocol==="https:"?l.origin!==window.location.origin:!0}catch{return!1}}function hc(r){try{return new URL(r,window.location.href).toString()}catch{return r}}function gc({menuEl:r,previewEl:l,previewTitleEl:m,previewBodyEl:A,previewActionsEl:_,previewCloseEl:j,escapeHtml:te,onEditItem:G,onChangeColor:Z,selectItem:C,colorPresets:le=[]}={}){const F=r||(()=>{const P=document.createElement("div");return P.className="tile-context-menu",P.hidden=!0,P.setAttribute("aria-hidden","true"),document.body.appendChild(P),P})();let re={x:0,y:0},Ce=0,it=Array.isArray(le)?le:[];function Ge(){F&&(F.classList.remove("is-open"),F.hidden=!0,F.setAttribute("aria-hidden","true"),F.innerHTML="")}function Ve(P=[]){_&&(_.innerHTML="",P.forEach(Y=>{const x=document.createElement("button");x.type="button",x.className="item-preview__action",x.textContent=Y.label||"Action",Y.title&&(x.title=Y.title),x.addEventListener("click",X=>{X.stopPropagation(),typeof Y.onClick=="function"&&Y.onClick(X)}),_.appendChild(x)}),_.hidden=P.length===0)}function Ue(){Ge(),l&&(l.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),l.setAttribute("aria-hidden","true"),l.hidden=!0,Ve([]))}function W(P,Y){l&&(re={x:P,y:Y},l.hidden=!1,l.setAttribute("aria-hidden","false"),l.classList.add("is-visible"),J(P,Y))}function J(P,Y){if(!l)return;const x=12;l.style.left=`${P+x}px`,l.style.top=`${Y+x}px`;const X=l.getBoundingClientRect();let Ee=X.left,de=X.top;X.right>window.innerWidth-x&&(Ee=Math.max(x,window.innerWidth-X.width-x)),X.bottom>window.innerHeight-x&&(de=Math.max(x,window.innerHeight-X.height-x)),l.style.left=`${Ee}px`,l.style.top=`${de}px`}function Q(P,Y){var ge;if(!P)return null;const x=P.dataset.id,X=((ge=P.querySelector(".name"))==null?void 0:ge.textContent)||x||"Preview",Ee=x?`${x}.html`:"",de=Ee?`items/${Ee}`:"";return{id:x,displayName:X,filename:Ee,filepath:de,externalUrl:P.dataset.externalUrl||"",obsidianUrl:P.dataset.obsidianUrl||"",anchorX:(Y==null?void 0:Y.clientX)??0,anchorY:(Y==null?void 0:Y.clientY)??0}}function M(P,Y){const x=document.createElement("button");return x.type="button",x.className="tile-context-menu__item",x.textContent=P,x.addEventListener("click",()=>{Ge(),typeof Y=="function"&&Y()}),x}function pe(P){if(!F)return;F.innerHTML="";const Y=document.createElement("div");Y.className="tile-context-menu__list",Y.appendChild(M("File view",()=>me(P))),typeof G=="function"&&Y.appendChild(M("Edit",()=>G(P.id))),typeof Z=="function"&&P.id&&it.forEach(x=>{if(!(x!=null&&x.value))return;const X=x.name||x.value;Y.appendChild(M(`Set color: ${X}`,()=>Z(P.id,x.value)))}),F.appendChild(Y)}function Be(P,Y){if(!F)return;const x=4;F.style.left=`${P+x}px`,F.style.top=`${Y+x}px`,F.hidden=!1,F.setAttribute("aria-hidden","false"),F.classList.add("is-open");const X=F.getBoundingClientRect();let Ee=X.left,de=X.top;X.right>window.innerWidth-x&&(Ee=Math.max(x,window.innerWidth-X.width-x)),X.bottom>window.innerHeight-x&&(de=Math.max(x,window.innerHeight-X.height-x)),F.style.left=`${Ee}px`,F.style.top=`${de}px`}async function me(P){if(!l||!m||!A||!P)return;const Y=++Ce,x=[];if(typeof G=="function"&&P.id&&x.push({label:"Edit",title:"Edit this item",onClick:()=>{Ue(),G(P.id)}}),P.externalUrl&&x.push({label:"Open link ↗",title:P.externalUrl,onClick:()=>ri(P.externalUrl)}),P.obsidianUrl&&x.push({label:"Open in Obsidian",title:P.obsidianUrl,onClick:()=>ri(P.obsidianUrl)}),Ve(x),P.id&&typeof C=="function"&&C(P.id),m.textContent=P.displayName,A.innerHTML='<div class="item-preview__status">Loading…</div>',l.classList.remove("item-preview--has-frame"),l.classList.add("item-preview--expanded"),W(P.anchorX,P.anchorY),!P.filepath){A.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',J(re.x,re.y);return}try{const X=await fetch(P.filepath,{cache:"no-cache"});if(!X.ok)throw new Error(`HTTP ${X.status}`);const Ee=await X.text();if(Y!==Ce)return;if(!Ee.trim()){const ve=te?te(P.filename):P.filename;A.innerHTML=`<div class="item-preview__status">No content in <code>${ve}</code>.</div>`,J(re.x,re.y);return}const ge=document.createElement("iframe");ge.className="item-preview__frame",ge.title=`${P.displayName} details`,ge.srcdoc=Ee,A.innerHTML="",A.appendChild(ge),l.classList.add("item-preview--has-frame"),J(re.x,re.y)}catch(X){if(Y!==Ce)return;const Ee=te?te(P.displayName):P.displayName;A.innerHTML=`<div class="item-preview__status">No preview available for <strong>${Ee}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${P.filepath}`,X),J(re.x,re.y)}}function et(P,Y){if(!Y)return;P.preventDefault(),P.stopPropagation();const x=Q(Y,P);!x||!x.id||(typeof C=="function"&&C(x.id),pe(x),Be(P.clientX,P.clientY))}function we(P){const Y=P==null?void 0:P.target,x=F&&!F.hidden&&F.contains(Y),X=l&&!l.hidden&&l.contains(Y);!x&&!X&&Ue()}function ce(){!l||l.hidden||J(re.x,re.y)}function ut(){Ue()}return j&&j.addEventListener("click",Ue),{handleTileContextMenu:et,hidePreview:Ue,hideMenu:Ge,handleDocumentClick:we,handleWindowResize:ce,handleWindowScroll:ut,updateColorPresets:P=>{it=Array.isArray(P)?P:[]}}}function Qr(r,l="series"){return(r||l).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||l}function kn(r,l="series"){const m=Qr(r,l).replace(/\./g,"-");return m.replace(/-series$/i,"").replace(/-+$/,"")||m||Qr(l,"series")}function es(r,{seriesName:l,fallbackTitle:m="unknown"}={}){var G,Z;const _=[r==null?void 0:r.seriesId,(G=r==null?void 0:r.data)==null?void 0:G.seriesId,r==null?void 0:r.apicurioArtifactId,l,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(Z=r==null?void 0:r.data)==null?void 0:Z.title,m].map(C=>(C??"").toString().trim()),j=_.findIndex(Boolean),te=j!==-1?_[j]:"";return te?(console.log("[Series] deriveSeriesId: picked base",{base:te,sourceIndex:j,candidates:_}),kn(te,m)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:m}),null)}function Jt(r,{seriesName:l,fallbackTitle:m="unknown"}={}){if(!r||typeof r!="object")return null;const A=es(r,{seriesName:l,fallbackTitle:m});return A?(r.seriesId=A,r.apicurioArtifactId||(r.apicurioArtifactId=A),A):null}function Vn(r,l={}){var _,j;if(!r)return null;const m=r.isSeries||((_=r.apicurioVersions)==null?void 0:_.length)>1||r.seriesId||((j=r.data)==null?void 0:j.seriesId)||r.apicurioArtifactId;if(!m&&!l.force)return null;const A=es(r,l);return A||(m?kn(l.fallbackTitle||"unknown"):null)}const ts={selectionDimOpacity:.2,selectionDimEnabled:!0},Xn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,l=!0)=>{const m=Math.round((1-r)*100);return l?m===0?"Off":`${m}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function ro(r){return r===!0||r==="true"||r===1||r==="1"}function bc(r,{localBackend:l}={}){const m=l&&typeof l.getAutoReloadConfig=="function"&&l.getAutoReloadConfig(),A={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness};return m&&(A.autoReloadEnabled=!!m.enabled,A.autoReloadIntervalMs=m.intervalMs),A}function wc(r={},l){var at,At,Fe,rt;if(!r||typeof r!="object")return{applied:[]};const m=[],{applyTheme:A,applyTileHoverScale:_,persistTileHoverScale:j,applySelectionDimEnabled:te,persistSelectionDimEnabled:G,applySelectionDimOpacity:Z,persistSelectionDimOpacity:C,applyTileCompactness:le,persistTileCompactness:F,applyTitleWrapMode:re,persistTitleWrapMode:Ce,applyTitleHoverWidthMultiplier:it,persistTitleHoverWidthMultiplier:Ge,applyTitleHoverTextPortion:Ve,persistTitleHoverTextPortion:Ue,applyLinkThickness:W,persistLinkThickness:J,applyDepColor:Q,persistDepColor:M,applyRevdepColor:pe,persistRevdepColor:Be,applyObsidianLinksEnabled:me,persistObsidianLinksEnabled:et,applyObsidianLinkMode:we,persistObsidianLinkMode:ce,applyObsidianVaultName:ut,persistObsidianVaultName:P,applyAutoIdFromNameEnabled:Y,persistAutoIdFromNameEnabled:x,applySeriesNavDoubleClickWait:X,persistSeriesNavDoubleClickWait:Ee,applyCenterItems:de,persistCenterItems:ge,localBackend:ve,ui:b,refreshObsidianLinks:Le,scheduleOverlaySync:Ye,selection:wt,select:lt,clearStyles:dt,drawLinks:xt,applyReusedHighlights:vt,current:xe}=l;if(r.theme){const v=((A==null?void 0:A(r.theme))||r.theme)==="dark";(at=l.ui)!=null&&at.themeToggle&&(l.ui.themeToggle.checked=v),(At=l.ui)!=null&&At.tabThemeToggle&&(l.ui.tabThemeToggle.checked=v),m.push("theme")}if(r.hoverScale!=null){const u=_(parseFloat(r.hoverScale));j(u),b!=null&&b.hoverScaleInput&&(b.hoverScaleInput.value=String(u)),b!=null&&b.hoverScaleValue&&(b.hoverScaleValue.textContent=Xn.hoverScale(u)),wt&&Ye(),m.push("hoverScale")}if(r.selectionDimEnabled!=null){const u=te(ro(r.selectionDimEnabled));G(u),b!=null&&b.selectionDimToggle&&(b.selectionDimToggle.checked=u),b!=null&&b.selectionDimInput&&(b.selectionDimInput.disabled=!u),b!=null&&b.selectionDimValue&&(b.selectionDimValue.textContent=Xn.selectionDimming(xe.selectionDimOpacity??ts.selectionDimOpacity,u)),m.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const u=Z(parseFloat(r.selectionDimOpacity));C(u),b!=null&&b.selectionDimInput&&(b.selectionDimInput.value=String(u)),b!=null&&b.selectionDimValue&&(b.selectionDimValue.textContent=Xn.selectionDimming(u,xe.selectionDimEnabled??ts.selectionDimEnabled)),m.push("selectionDimOpacity")}if(r.tileCompactness!=null){const u=le(parseFloat(r.tileCompactness));F(u),b!=null&&b.tileCompactnessInput&&(b.tileCompactnessInput.value=String(u)),b!=null&&b.tileCompactnessValue&&(b.tileCompactnessValue.textContent=Xn.compactness(u)),wt&&Ye(),m.push("tileCompactness")}if(r.titleWrapMode){const u=re(r.titleWrapMode);Ce(u),b!=null&&b.titleWrapInput&&(b.titleWrapInput.checked=u!=="nowrap"),m.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const u=it(parseFloat(r.titleHoverWidthMultiplier));Ge(u),b!=null&&b.titleWidthInput&&(b.titleWidthInput.value=String(u)),b!=null&&b.titleWidthValue&&(b.titleWidthValue.textContent=Xn.titleWidth(u)),m.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const u=Ve(parseFloat(r.titleHoverTextPortion));Ue(u),b!=null&&b.titleZoomInput&&(b.titleZoomInput.value=String(u)),b!=null&&b.titleZoomValue&&(b.titleZoomValue.textContent=Xn.titleZoomPortion(u)),m.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const u=me(ro(r.obsidianLinksEnabled));et(u),b!=null&&b.obsidianToggle&&(b.obsidianToggle.checked=u),(Fe=b==null?void 0:b.obsidianModeInputs)==null||Fe.forEach(v=>{v.disabled=!u}),b!=null&&b.obsidianVaultInput&&(b.obsidianVaultInput.disabled=!u),Le==null||Le(),m.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const u=we(r.obsidianLinkMode);ce(u),(rt=b==null?void 0:b.obsidianModeInputs)==null||rt.forEach(v=>{v.checked=v.value===u}),Le==null||Le(),m.push("obsidianLinkMode")}if(r.obsidianVault!=null){const u=ut(r.obsidianVault);P(u),b!=null&&b.obsidianVaultInput&&(b.obsidianVaultInput.value=u),Le==null||Le(),m.push("obsidianVault")}if(r.colorPresets&&(typeof l.setColorPresets=="function"&&l.setColorPresets(r.colorPresets),m.push("colorPresets")),r.linkThickness){const u=W==null?void 0:W(r.linkThickness);u&&(J==null||J(u),b!=null&&b.linkThicknessInput&&(b.linkThicknessInput.value=u),m.push("linkThickness"))}if(r.depColor){const u=Q==null?void 0:Q(r.depColor);u&&(M==null||M(u),b!=null&&b.depColorInput&&(b.depColorInput.value=u),m.push("depColor"))}if(r.revdepColor){const u=pe==null?void 0:pe(r.revdepColor);u&&(Be==null||Be(u),b!=null&&b.revdepColorInput&&(b.revdepColorInput.value=u),m.push("revdepColor"))}if(r.autoIdFromName!=null){const u=Y(ro(r.autoIdFromName));x(u),b!=null&&b.autoIdToggle&&(b.autoIdToggle.checked=u),m.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const u=X(parseInt(r.seriesNavDoubleClickMs,10));Ee(u),b!=null&&b.seriesNavInput&&(b.seriesNavInput.value=String(u)),b!=null&&b.seriesNavValue&&(b.seriesNavValue.textContent=Xn.seriesNavWait(u)),m.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&ve&&typeof ve.setAutoReloadEnabled=="function"){const u=ro(r.autoReloadEnabled);ve.setAutoReloadEnabled(u),b!=null&&b.autoReloadToggle&&(b.autoReloadToggle.checked=u),b!=null&&b.autoReloadInput&&(b.autoReloadInput.disabled=!u),m.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&ve&&typeof ve.setAutoReloadInterval=="function"){const u=ve.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));b!=null&&b.autoReloadInput&&(b.autoReloadInput.value=String(u)),b!=null&&b.autoReloadValue&&(b.autoReloadValue.textContent=Xn.autoReloadInterval(u)),m.push("autoReloadIntervalMs")}if(r.centerItems!=null){const u=de==null?void 0:de(ro(r.centerItems));ge==null||ge(u),b!=null&&b.tabCenterToggle&&(b.tabCenterToggle.checked=u),m.push("centerItems")}if(r.showSecondaryLinks!=null){const u=ro(r.showSecondaryLinks);typeof l.setShowSecondaryLinks=="function"?l.setShowSecondaryLinks(u):l.showSecondaryLinks=u,b!=null&&b.secondaryLinksToggle&&(b.secondaryLinksToggle.checked=u),b!=null&&b.tabSecondaryLinksToggle&&(b.tabSecondaryLinksToggle.checked=u),wt?lt(wt):(dt(),xt()),m.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const u=ro(r.showReusedInMap);typeof l.setShowReusedInMap=="function"?l.setShowReusedInMap(u):l.showReusedInMap=u,b!=null&&b.reusedToggle&&(b.reusedToggle.checked=u),vt==null||vt(),m.push("showReusedInMap")}return{applied:m}}function vc(r,l){const m=new Blob([l],{type:"application/json"}),A=URL.createObjectURL(m),_=document.createElement("a");_.href=A,_.download=r,_.click(),URL.revokeObjectURL(A)}const ji=typeof{url:Pn&&Pn.tagName.toUpperCase()==="SCRIPT"&&Pn.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function yc(r={}){console.log("[Blockscape] init");const l={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},m=document.getElementById("jsonBox"),A=document.querySelector(".blockscape-json-panel"),_=document.getElementById("app"),j=document.getElementById("overlay"),te=document.getElementById("tabTooltip"),G=document.getElementById("modelList"),Z=document.getElementById("itemPreview"),C=document.getElementById("urlForm"),le=document.getElementById("urlInput"),F=document.getElementById("loadUrl"),re=Z.querySelector(".item-preview__title"),Ce=Z.querySelector(".item-preview__body"),it=Z.querySelector(".item-preview__actions"),Ge=Z.querySelector(".item-preview__close"),Ve=document.getElementById("downloadJson"),Ue=document.getElementById("shareModel"),W=document.getElementById("createVersion"),J=document.getElementById("openInEditor"),Q=document.getElementById("copyJson"),M=document.getElementById("copySeries"),pe=document.getElementById("pasteJson"),Be=document.getElementById("helpButton"),me=document.getElementById("newPanelButton"),et=document.getElementById("newBlankButton"),we=document.getElementById("shortcutHelp"),ce=document.getElementById("shortcutHelpList"),ut=document.getElementById("shortcutHelpClose"),P=document.getElementById("shortcutHelpBackdrop"),Y=document.getElementById("newPanel"),x=document.getElementById("newPanelClose"),X=document.getElementById("newPanelBackdrop"),Ee=document.getElementById("search"),de=document.getElementById("searchResults"),ge=document.getElementById("localBackendPanel"),ve=document.getElementById("localBackendStatus"),b=document.getElementById("localFileList"),Le=document.getElementById("localDirSelect"),Ye=document.getElementById("refreshLocalFiles"),wt=document.getElementById("loadLocalFile"),lt=document.getElementById("deleteLocalFile"),dt=document.getElementById("toggleServerSidebar"),xt=document.getElementById("saveLocalFile"),vt=document.getElementById("saveLocalFileAs"),xe=document.getElementById("localSavePath"),at="blockscape:editorPayload",At="blockscape:editorTransfer",Fe="blockscape:serverSidebarWide",rt=document.title;ge&&(ge.hidden=!0),!l.localBackend&&ge&&(ge.hidden=!0),l.fileOpen||(wt&&(wt.hidden=!0),Le&&(Le.hidden=!0),Ye&&(Ye.hidden=!0),lt&&(lt.hidden=!0),b&&(b.hidden=!0)),l.fileSave||(xt&&(xt.hidden=!0),vt&&(vt.hidden=!0),xe&&(xe.hidden=!0)),m.value=document.getElementById("seed").textContent.trim();let u=[],v=-1;const pt=sc({models:u,getActiveIndex:()=>v,setActive:Ot,ensureModelMetadata:$n,getModelId:kt,getSeriesId:Vn,ensureSeriesId:Jt,getModelTitle:qe,computeJsonFingerprint:ea,uid:uo});let se=null,ft=new Map,In=new Map,K=null,tt=null,st=null,mt=null,_n=!0,Cn=!1,xn=!1,Kt="map",$t=null,hn=null,rn=!1,Dn=null;const so=2e3;let en=null,Ft=null,An=null,Wt=null,sn=null,qt=null,Tn=null,d=null,y=null,B="",N=!1,k=null;const V=new Map;let ee=null,z=null,be=[],fe=null;const Ne=30,We=1e3,ct="blockscape:hoverScale",Ae=1.5,It=1,jt=2.5,gt="blockscape:selectionDimOpacity",Oe="blockscape:selectionDimEnabled",Je=.2,Yt=.05,Ke=1,Ct="blockscape:titleWrap",yt="blockscape:titleHoverWidth",bt="blockscape:titleHoverTextPortion",Rt="wrap",pn=1.3,ye=1,nt=1.6,si=.25,rs=0,ss=.6,ls="blockscape:tileCompactness",li=1,cs=.75,ds=1.25,us="blockscape:obsidianLinksEnabled",ps="blockscape:obsidianLinkMode",fs="blockscape:obsidianVault",Ta="title",zi="id",Gi=Ta,ms="blockscape:autoReloadEnabled",hs="blockscape:autoReloadIntervalMs",ci=1e3,gs=500,bs=1e4,ws="blockscape:autoIdFromName",Ji=!0,vs="blockscape:colorPresets",ys="blockscape:centerItems",Ss="blockscape:theme",Es=4,_o=1,Ki=4,ks="0.2rem",Co="light",lo="dark",qi="cat:",Yi=!1,Is="blockscape:depColor",_s="blockscape:revdepColor",Cs="blockscape:linkThickness",xs=6,As={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let xo=Ae,Un=Je,Hn=!0,Ao=li,La=Rt,To=pn,Lo=si,No=!1,di=Gi,Mo="",co=Ji,ui=Co,tn=[],Et=Yi,Zi="",Xi="",pi="m",Bo=null,Na=null;const Ts="blockscape:seriesNavDoubleClickMs",fi=900,Ls=300,Ns=4e3;let Fn=fi;const Te={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null},Uc={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:ci}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},Ze=l.localBackend?pd():Uc,Ms=l.localBackend?Ze.detect():Promise.resolve(!1);pt.hydrateConfig(),Ba(Jc()),Oo(td(),{silent:!0}),Yc(),Zc(),ed(),_d(),Cd(),Td(),Md(),Ld(),Nd(),Pd(),Ud(),Dd(),Hd(),xd(),Ad(),qc(),on();function uo(){return Math.random().toString(36).slice(2,10)}function Hc(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function Fc(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function Wc(e){return Hc(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function jc(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Fc(t)}const Bs=(e,t)=>vc(e,t);function Ma(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function zc(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await Bl(i),s=JSON.parse(a),c=Ma(s);if(c)return c}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function Gc(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];l.initialSettings&&t.push({type:"inline",snapshot:l.initialSettings}),l.initialSettingsUrl&&t.push({type:"url",url:l.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?Ma(o.snapshot):await zc(o.url);if(!i)continue;const a=Fa(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function Jc(){if(typeof window>"u"||!window.localStorage)return Co;try{return window.localStorage.getItem(Ss)===lo?lo:Co}catch{return Co}}function Kc(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ss,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function Ba(e){const t=e===lo?lo:Co;return ui=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),Kc(t),ui}function $s(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ys,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function $o(e){return Et=!!e,_&&(_.classList.toggle("is-center-mode",Et),_.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",Et)}),_.querySelectorAll(".tile-add").forEach(t=>{t.hidden=Et,t.tabIndex=Et?-1:0,t.setAttribute("aria-hidden",Et?"true":"false")}),_.querySelectorAll(".category-add").forEach(t=>{t.hidden=Et,t.tabIndex=Et?-1:0,t.setAttribute("aria-hidden",Et?"true":"false")})),Os(),Rs(),se&&(la(),Ln()),Et}function qc(){if(typeof window>"u"||!window.localStorage)return $o(Yi);try{const e=window.localStorage.getItem(ys);return e==null?$o(Yi):$o(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),$o(Yi)}}function mi(e){if(e==null)return null;const t=Number(e);if(!Number.isFinite(t))return null;const n=Math.round(t);return n<_o||n>Ki?null:n}function Rs(){if(!_)return;const e=`repeat(${Es}, minmax(var(--blockscape-tile), 1fr))`;_.querySelectorAll(".grid").forEach(t=>{const n=Array.from(t.querySelectorAll(".tile[data-stage]")).map((h,S)=>({tile:h,stage:mi(h.dataset.stage),order:S})),o=n.some(h=>h.stage),i=Et&&o;i?(t.style.gridTemplateColumns=e,t.style.gridAutoFlow="row",t.style.justifyContent="space-between",t.style.justifyItems="start",t.style.columnGap=ks,t.style.rowGap=ks):(t.style.removeProperty("grid-template-columns"),t.style.removeProperty("grid-auto-flow"),t.style.removeProperty("justify-content"),t.style.removeProperty("justify-items"),t.style.removeProperty("column-gap"),t.style.removeProperty("row-gap"));const a=h=>{h.style.removeProperty("grid-column"),h.style.removeProperty("grid-row")};if(t.querySelectorAll(".tile").forEach(a),!i)return;const s=n.filter(h=>h.stage).sort((h,S)=>h.stage!==S.stage?h.stage-S.stage:h.order-S.order),c=(h,S,R)=>{if(S.has(h)&&S.get(h)===R)return{col:h,needsNewRow:!0};const T=Es-1;for(let L=0;L<=T;L+=1){const O=[];h-L>=_o&&O.push(h-L),L!==0&&h+L<=Ki&&O.push(h+L);for(const ne of O)if(!S.has(ne))return{col:ne,needsNewRow:!1}}return{col:null,needsNewRow:!1}};let p=1,g=new Map;s.forEach(({tile:h,stage:S})=>{let R=c(S,g,S);R.needsNewRow&&(p+=1,g=new Map,R=c(S,g,S)),R.col!=null&&(g.set(R.col,S),h.style.gridColumn=String(R.col),h.style.gridRow=String(p))})}),Os()}function Os(){Na&&(Na.hidden=!Et)}function Ro(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Ps(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function $a(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function Vs(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=Ro(i[1]);if(a)return $a(a,n);if(t){const s=Ro(t);if(s)return $a(s,n)}}return $a(o,n)}function Ds(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function Ra(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Is,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function Oa(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(_s,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function Pa(e){const t=Vs(e,{fallbackVar:"--color-primary",fallbackColor:Gt.color.primary});return Zi=t,Ps("--blockscape-dep",t),j&&Ln(),Zi}function Va(e){const t=Vs(e,{fallbackVar:"--color-danger",fallbackColor:Gt.blockscape.revdep});return Xi=t,Ps("--blockscape-revdep",t),j&&Ln(),Xi}function Yc(){const e=Ds(Is),t=Pa(e||Ro("--blockscape-dep")||Gt.color.primary);return Ra(t),t}function Zc(){const e=Ds(_s),t=Va(e||Ro("--blockscape-revdep")||Gt.blockscape.revdep);return Oa(t),t}function Xc(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function Qc(){return As[pi]||As.m}function hi(e){return pi=Xc(e),Ln(),pi}function Da(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Cs,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function ed(){if(typeof window>"u"||!window.localStorage)return hi("m");try{const e=window.localStorage.getItem(Cs),t=hi(e||"m");return Da(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),hi("m")}}function Us(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return gi();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:gi()}function gi(){return[{name:"Black",value:Gt.color.ink},{name:"White",value:Gt.color.white},{name:"Red",value:Gt.blockscape.revdep},{name:"Green",value:Gt.color.success}]}function td(){if(typeof window>"u"||!window.localStorage)return gi();try{const e=window.localStorage.getItem(vs);if(!e)return gi();const t=JSON.parse(e);return Us(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),gi()}}function nd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(vs,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function Oo(e,{silent:t=!1}={}){return tn=Us(e),nd(tn),!t&&typeof qo=="function"&&qo(tn),Bo==null||Bo(),tn}function od(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function Qi(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=po(e);if(!o)return;const i=u[v],a=po(i==null?void 0:i.sourcePath),s=t??(a&&a===o?kt(i):null),c=n??(a&&a===o?K:null),p=o.split("/").filter(Boolean).map(S=>encodeURIComponent(S)),g=s?encodeURIComponent(s):null,h=c?encodeURIComponent(c):null;try{const S=new URL(window.location.href),R=new URLSearchParams(S.search);R.delete("load"),R.delete("share");const T=["","server",...p,...g?[g]:[],...h?[h]:[]].join("/").replace(/\/+/g,"/");S.pathname=T,S.search=R.toString()?`?${R.toString()}`:"",S.hash="",window.history.replaceState({},document.title,S.toString())}catch(S){console.warn("[Blockscape] failed to update URL for server path",S)}}function id(e,{origin:t}={}){if(!(typeof window>"u"||!e))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-path",{detail:{path:e,origin:t}}))}catch(n){console.warn("[Blockscape] failed to notify local save path",n)}}function ad({origin:e}={}){if(!(typeof window>"u"))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-clear",{detail:{origin:e}}))}catch(t){console.warn("[Blockscape] failed to notify local save clear",t)}}function rd(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(O=>O.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex(O=>O.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),c=i.slice(a+1),p=O=>{try{return decodeURIComponent(O)}catch{return O}},g=s.map(p),h=c.map(p),S=g.join("/"),R=po(S);if(!R)return null;const T=h[0]?h[0].trim():null,L=h[1]?h[1].trim():null;return{path:R,modelId:T||null,itemId:L||null}}function sd(){if(!(typeof window>"u"||!window.location))try{const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(c=>c.toLowerCase()==="server");if(o===-1)return;const i=n.slice(0,o),a=new URLSearchParams(e.search);a.delete("load"),a.delete("share");const s=i.length?`/${i.join("/")}`:"/";e.pathname=s.replace(/\/+/g,"/"),e.search=a.toString()?`?${a.toString()}`:"",e.hash="",window.history.replaceState({},document.title,e.toString())}catch(e){console.warn("[Blockscape] failed to clear server path from URL",e)}}function Ua({itemId:e}={}){const t=u[v];if(!(t!=null&&t.sourcePath)){sd();return}Qi(t.sourcePath,{modelId:kt(t),itemId:e===void 0?K:e})}function ld(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function cd(){if(typeof window>"u"||!window.localStorage)return!0;try{const e=window.localStorage.getItem(Fe);return e==null?!0:e==="true"}catch{return!0}}function dd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Fe,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist sidebar width",t)}}function Hs(e){var t;typeof document>"u"||((t=document.body)==null||t.classList.toggle("blockscape-server-sidebar-wide",!!e),dt&&(dt.setAttribute("aria-pressed",e?"true":"false"),dt.textContent=e?"<":">",dt.title=e?"Switch to thin menu":"Switch to wide menu"))}function ud(e){if(!dt||(dt.hidden=!e,!e))return;let t=cd();Hs(t),dt.onclick=()=>{t=!t,dd(t),Hs(t)}}function pd(){var ni;const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(I,U={}){console.log("[Blockscape][local-backend]",I,{...e(),...U})}if(ld())return t("Disabled on github.io host"),ge&&(ge.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};const n=od();if(n&&typeof document<"u"&&((ni=document.body)==null||ni.classList.add("blockscape-server-mode")),ud(n),!n||!ge||!ve)return t("Opt-in flag missing or panel unavailable"),ge&&(ge.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!ge||!ve)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],c="",p=new Map,g=O(),h=Me(),S=null,R=!1;const T=new Set;function L(){return T.size>0}function O(){if(typeof window>"u"||!window.localStorage)return!0;try{const I=window.localStorage.getItem(ms);return I==null?!0:I==="true"}catch{return!0}}function ne(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ms,I?"true":"false")}catch(U){console.warn("[Blockscape] auto-reload: failed to persist",U)}}function Me(){if(typeof window>"u"||!window.localStorage)return ci;try{const I=window.localStorage.getItem(hs);if(!I)return ci;const U=parseInt(I,10);return Se(U)}catch{return ci}}function ht(I){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(hs,String(I))}catch(U){console.warn("[Blockscape] auto-reload: failed to persist interval",U)}}function Se(I){return Number.isFinite(I)?Math.min(bs,Math.max(gs,I)):ci}function ke(I){if(!I)return"";const U=I.split("/").filter(Boolean);return U.pop(),U.join("/")}function ot(I,{error:U=!1}={}){ve.textContent=I,ve.style.color=U?Gt.color.dangerStrong:"",t("Status",{text:I,error:U})}function He(I){return po(I)}function Vt(I){const U=ia(I);return U?{payload:U,isSeries:!0}:{payload:I==null?void 0:I.data,isSeries:!1}}function Zt(){var U;if(v>=0&&((U=u[v])!=null&&U.sourcePath))return u[v].sourcePath;if(v<0)return"blockscape.bs";const I=qe(u[v])||"blockscape";return`${kn(I,"blockscape")}.bs`}function Dt(){var U;if(!xe)return;xe.placeholder=Zt();const I=(U=u[v])==null?void 0:U.sourcePath;if(I){xe.value=I;return}xe.value&&(xe.value="")}function Ie(){if(!Le)return;Le.innerHTML="";const I=document.createElement("option");I.value="",I.textContent="Root (~/blockscape)",Le.appendChild(I),s.forEach(oe=>{const he=document.createElement("option");he.value=oe,he.textContent=oe||"(root)",Le.appendChild(he)});const U=s.includes(c)?c:"";Le.value=U,c=U}function Nt(){if(!b)return;b.innerHTML="";const I=a.filter(U=>ke(U.path)===c);if(!I.length){const U=document.createElement("option");U.disabled=!0,U.textContent="No .bs files found yet",b.appendChild(U),b.disabled=!0;return}b.disabled=!1,I.forEach(U=>{const oe=document.createElement("option");oe.value=U.path;const he=U.mtimeMs?new Date(U.mtimeMs).toLocaleString():"";oe.textContent=he?`${U.path} · ${he}`:U.path,b.appendChild(oe)}),i&&Array.from(b.options).forEach(U=>{U.value===i&&(U.selected=!0)}),!b.value&&b.options.length&&(b.options[0].selected=!0)}function Nn(I){if(!o||!b)return;if(!I){i="",Array.from(b.options).forEach(Qe=>{Qe.selected=!1}),xe&&(xe.value="");return}if(!a.find(Qe=>Qe.path===I))return;const oe=ke(I);oe!==c&&(c=oe,Ie()),Nt(),Array.from(b.options).forEach(Qe=>{Qe.selected=Qe.value===I});const he=Array.from(b.options).find(Qe=>Qe.value===I);he!=null&&he.scrollIntoView&&he.scrollIntoView({block:"nearest"}),xe&&(xe.value=I)}function Kn(){S&&(clearInterval(S),S=null)}function Mt(){Kn(),!(!o||!g||L())&&(S=setInterval(dn,h))}function zt(I){if(!I)return;const U=T.size;T.add(I),T.size!==U&&(t("Auto-reload paused",{reason:I}),Mt())}function ln(I){if(!I)return;T.delete(I)&&(t("Auto-reload resumed",{reason:I}),Mt())}async function cn(I){const U=u.findIndex(oe=>oe.sourcePath===I);if(U!==-1)try{const oe=await fetch(`/api/file?path=${encodeURIComponent(I)}`,{cache:"no-store"});if(!oe.ok)throw new Error(`HTTP ${oe.status}`);const he=await oe.json(),Qe=JSON.stringify(he.data??he,null,2),je=jn(Qe,I,{seriesTitleOverride:`${I} series`});if(!je.length)return;const ie=je[0];if(ie.sourcePath=I,$n(ie,{titleHint:qe(u[U]),idHint:kt(u[U])}),ie.isSeries){const $e=ie.title||qe(ie)||qe(u[U]),St=kn($e||"unknown");fo(ie,St),Jt(ie,{seriesName:$e||"unknown",fallbackTitle:"unknown"})}u[U]={...u[U],...ie,title:ie.title||qe(ie),data:ie.data,sourcePath:I},U===v?(Pt(),Lt()):Wn(),console.log("[Blockscape] auto-reloaded model from",I)}catch(oe){console.warn("[Blockscape] auto-reload failed for",I,oe)}}async function dn(){if(!(!o||!g||L()||R)){R=!0;try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);const oe=((await I.json()).files||[]).slice().sort((ie,$e)=>{const St=(ie==null?void 0:ie.mtimeMs)||0,mn=($e==null?void 0:$e.mtimeMs)||0;return St===mn?(ie.path||"").localeCompare($e.path||""):mn-St}),he=new Map;oe.forEach(ie=>he.set(ie.path,ie.mtimeMs||0));const Qe=u.map((ie,$e)=>({path:ie.sourcePath,idx:$e})).filter(ie=>ie.path);for(const ie of Qe){const $e=p.get(ie.path)||0;(he.get(ie.path)||0)>$e&&await cn(ie.path)}a=oe;const je=new Set;a.forEach(ie=>je.add(ke(ie.path))),s=Array.from(je).filter(ie=>ie!=="").sort(),p=he,Ie(),Nt()}catch(I){console.warn("[Blockscape] auto-reload check failed",I)}finally{R=!1}}}function Xe(I){g=!!I,ne(g),Mt()}function ei(I){return h=Se(I),ht(h),Mt(),h}function un(I){o=!1,a=[],p=new Map,Kn(),Nt(),ge.hidden=!0,I&&ot(I,{error:!0}),t("Panel hidden",{message:I})}async function bo({silent:I=!1}={}){try{t("Health check start");const U=await fetch("/api/health",{cache:"no-store"});if(!U.ok)throw new Error(`HTTP ${U.status}`);const oe=await U.json();if(o=!!(oe!=null&&oe.ok),!o)throw new Error("Health check failed");return ge.hidden=!1,I||ot(oe.root?`Local server ready (root: ${oe.root})`:"Local server ready"),t("Health check ok",{payload:oe}),!0}catch(U){return I||console.log("[Blockscape] local backend health failed",U),un("Local server unavailable"),!1}}async function gn(){if(o&&b){ot("Loading files…");try{const I=await fetch("/api/files",{cache:"no-store"});if(!I.ok)throw new Error(`HTTP ${I.status}`);a=((await I.json()).files||[]).slice().sort((je,ie)=>{const $e=(je==null?void 0:je.mtimeMs)||0,St=(ie==null?void 0:ie.mtimeMs)||0;return $e===St?(je.path||"").localeCompare(ie.path||""):St-$e});const oe=new Set;a.forEach(je=>{oe.add(ke(je.path))}),s=Array.from(oe).filter(je=>je!=="").sort(),c&&!oe.has(c)&&(c=""),!c&&i&&(c=ke(i)),p=new Map(a.map(je=>[je.path,je.mtimeMs||0])),Ie(),Nt();const he=a.filter(je=>ke(je.path)===c).length,Qe=c?`~/blockscape/${c}`:"~/blockscape";ot(he?`Browsing ${he} file(s) in ${Qe}`:`No .bs files in ${Qe} yet`)}catch(I){console.warn("[Blockscape] local backend refresh failed",I),un("Local server unavailable")}}}async function nr(){o=!1,un(),ot("Checking for local server…");try{return t("Detect start"),await bo()?(Dt(),await gn(),Mt(),!0):!1}catch(I){return o=!1,console.log("[Blockscape] local backend not detected",I),t("Detect failed",{err:I}),!1}}async function Ei(){if(!o||!b)return;const I=Array.from(b.selectedOptions||[]).map(oe=>oe.value).filter(Boolean).sort((oe,he)=>oe.localeCompare(he));if(!I.length){alert("Select one or more files to load from ~/blockscape.");return}let U=null;for(const oe of I)try{ot(`Loading ${oe}…`);const he=await Fs(oe);U==null&&(U=(he==null?void 0:he.firstIndex)??null),i=oe,Qi(oe)}catch(he){console.error("[Blockscape] failed to load from local server",he),alert(`Local load failed for ${oe}: ${he.message}`)}U!=null&&Ot(U),ot(`Loaded ${I.length} file(s)`),Nt()}async function ki(){if(!o||!b)return;const I=Array.from(b.selectedOptions||[]).map(ie=>ie.value).filter(Boolean).sort((ie,$e)=>ie.localeCompare($e));if(!I.length){alert("Select one or more files to delete from ~/blockscape.");return}const U=I.length,oe=U===1?I[0]:`${U} file(s)`,he=U===1?`Delete "${oe}" from ~/blockscape? This cannot be undone.`:`Delete ${oe} from ~/blockscape? This cannot be undone.`;if(!window.confirm(he))return;const Qe="local-files-delete";zt(Qe);const je=[];try{ot(`Deleting ${oe}…`);for(const ie of I)try{const $e=await fetch(`/api/file?path=${encodeURIComponent(ie)}`,{method:"DELETE"});if(!$e.ok)throw new Error(`HTTP ${$e.status}`);ie===i&&(i=""),(xe==null?void 0:xe.value)===ie&&(xe.value="")}catch($e){je.push(ie),console.warn("[Blockscape] local delete failed",ie,$e)}await gn(),je.length?ot(`Deleted ${U-je.length} file(s), ${je.length} failed`,{error:!0}):ot(`Deleted ${U} file(s)`)}finally{ln(Qe)}}async function ti(I,{statusPrefix:U="Saved to",updateInput:oe=!0}={}){if(!o)return;if(v<0){alert("No active model to save.");return}const he=u[v],{payload:Qe,isSeries:je}=Vt(he);if(!Qe){alert("No model data to save.");return}const ie=He(I);if(!ie){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const $e=JSON.stringify(Qe,null,2);ot(`Saving ${je?"series":"map"} to ${ie}…`);const mn=await fetch(`/api/file?path=${encodeURIComponent(ie)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:$e});if(!mn.ok)throw new Error(`HTTP ${mn.status}`);const an=await mn.json();i=an.path||ie,he.sourcePath=an.path||ie,oe&&xe&&(xe.value=an.path||ie),Qi(an.path||ie),ot(`${U} ${an.path||ie}`),await gn()}catch($e){console.error("[Blockscape] local save failed",$e),alert(`Local save failed: ${$e.message}`),un("Local server unavailable")}}async function Ii(){var U;const I=He(xe==null?void 0:xe.value)||He((U=u[v])==null?void 0:U.sourcePath)||Zt();if(!I){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await ti(I,{statusPrefix:"Saved to"})}async function Qn(){var he;if(!o)return;if(v<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const I=He((he=u[v])==null?void 0:he.sourcePath)||Zt(),U=window.prompt("Save active map as (under ~/blockscape):",I);if(U==null)return;const oe=He(U);if(!oe){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await ti(oe,{statusPrefix:"Saved to"})}async function _i(I,U,{refreshAfter:oe=!0,statusPrefix:he="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(I)||I<0)return{ok:!1,error:"Invalid model index"};const Qe=u[I],{payload:je,isSeries:ie}=Vt(Qe);if(!je)return{ok:!1,error:"Model has no data"};const $e=He(U)||He(Qe==null?void 0:Qe.sourcePath)||Zt();if(!$e)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const St=JSON.stringify(je,null,2);ot(`Saving ${ie?"series":"map"} to ${$e}…`);const an=await fetch(`/api/file?path=${encodeURIComponent($e)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:St});if(!an.ok)throw new Error(`HTTP ${an.status}`);const qn=await an.json();return i=qn.path||$e,Qe.sourcePath=qn.path||$e,I===v&&Dt(),ot(`${he} ${qn.path||$e}`),oe&&await gn(),{ok:!0,path:qn.path||$e}}catch(St){return console.error("[Blockscape] local save failed",St),un("Local server unavailable"),{ok:!1,error:St.message}}}if(Ye&&(Ye.onclick=()=>gn()),wt&&(wt.onclick=()=>Ei()),lt&&(lt.onclick=()=>ki()),xt&&(xt.onclick=()=>Ii()),vt&&(vt.onclick=()=>Qn()),b&&xe&&(b.addEventListener("change",()=>{const I=Array.from(b.selectedOptions||[])[0];I!=null&&I.value&&(xe.value=I.value)}),b.addEventListener("dblclick",()=>{Ei()})),Le&&Le.addEventListener("change",()=>{c=Le.value||"",Nt()}),ge){const I="local-files-panel-focus",U="local-files-panel-pointer";let oe=!1,he=!1;ge.addEventListener("focusin",()=>{oe||(oe=!0,zt(I))}),ge.addEventListener("focusout",Qe=>{if(!oe)return;const je=Qe.relatedTarget;je&&ge.contains(je)||(oe=!1,ln(I))}),ge.addEventListener("pointerenter",()=>{he||(he=!0,zt(U))}),ge.addEventListener("pointerleave",()=>{he&&(he=!1,ln(U))})}return{detect:nr,refresh:gn,updateActiveSavePlaceholder:Dt,isAvailable:()=>o,highlightSource:Nn,saveModelByIndex:_i,getAutoReloadConfig:()=>({enabled:g,intervalMs:h,available:o}),setAutoReloadEnabled:Xe,setAutoReloadInterval:ei}}async function Fs(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=jn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let c=null;return s.forEach((p,g)=>{if(p.sourcePath=e,p.isSeries&&!p.title){const R=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");p.title=R}const h=Rn(p,{versionLabel:s.length>1?`${t} #${g+1}`:t});c==null&&(c=h)}),{firstIndex:c,total:s.length}}async function Ws(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function fd(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function nn(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function po(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function md(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function hd(e,t){const n=po(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function Ha(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function bi(){try{await Ms}catch{}return typeof(Ze==null?void 0:Ze.isAvailable)=="function"?Ze.isAvailable():!1}async function gd(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function bd(e,t){const n=po(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const c=`${a}-${s}.bs`,p=[...o,c].filter(Boolean).join("/");if(!t.has(p))return p}return null}function wd(e,t="clipboard"){const n=qe(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=nn(n),i=Ha();return`${o}-${i}.bs`}function vd(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=md(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=kn(n||"unknown");return fo(e,o),Jt(e,{seriesName:n,fallbackTitle:n}),!0}function yd(e){return Number.isFinite(e)?Math.min(jt,Math.max(It,e)):Ae}function on(){if(!_)return;const e=!!K||!!tt;_.classList.toggle("blockscape-has-selection",e),_.classList.toggle("blockscape-has-item-selection",!!K)}function Po(e){return xo=yd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",xo),xo}function Sd(e){return Number.isFinite(e)?Math.min(Ke,Math.max(Yt,e)):Je}function Vo(e){Un=Sd(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Un);const t=Hn?Un:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Un}function Ed(e){return Number.isFinite(e)?Math.min(ds,Math.max(cs,e)):li}function Do(e){return Ao=Ed(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",Ao),Ao}function kd(e){return Number.isFinite(e)?Math.min(nt,Math.max(ye,e)):pn}function Uo(e){return To=kd(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",To),To}function Id(e){return Number.isFinite(e)?Math.min(ss,Math.max(rs,e)):si}function Ho(e){return Lo=Id(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Lo),Lo}function Fo(e){const t=e==="nowrap"?"nowrap":"wrap";La=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function js(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ct,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function _d(){if(typeof window>"u"||!window.localStorage)return Po(Ae);try{const e=window.localStorage.getItem(ct);if(!e)return Po(Ae);const t=parseFloat(e);return Po(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Po(Ae)}}function zs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(gt,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function Cd(){if(typeof window>"u"||!window.localStorage)return Vo(Je);try{const e=window.localStorage.getItem(gt);if(!e)return Vo(Je);const t=parseFloat(e);return Vo(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Vo(Je)}}function Wo(e){Hn=!!e;const t=Hn?Un:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),_&&_.classList.toggle("blockscape-dimming-disabled",!Hn),Hn}function Gs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Oe,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function xd(){if(typeof window>"u"||!window.localStorage)return Wo(!0);try{const e=window.localStorage.getItem(Oe);return e==null?Wo(!0):Wo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),Wo(!0)}}function jo(e){return co=!!e,co}function Js(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ws,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function Ad(){if(typeof window>"u"||!window.localStorage)return jo(Ji);try{const e=window.localStorage.getItem(ws);return e==null?jo(Ji):jo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),jo(Ji)}}function Ks(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ls,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function Td(){if(typeof window>"u"||!window.localStorage)return Do(li);try{const e=window.localStorage.getItem(ls);if(!e)return Do(li);const t=parseFloat(e);return Do(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Do(li)}}function qs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(yt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function Ld(){if(typeof window>"u"||!window.localStorage)return Uo(pn);try{const e=window.localStorage.getItem(yt);if(!e)return Uo(pn);const t=parseFloat(e);return Uo(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Uo(pn)}}function Ys(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(bt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function Nd(){if(typeof window>"u"||!window.localStorage)return Ho(si);try{const e=window.localStorage.getItem(bt);if(!e)return Ho(si);const t=parseFloat(e);return Ho(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Ho(si)}}function Zs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ct,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function Md(){if(typeof window>"u"||!window.localStorage)return Fo(Rt);try{const e=window.localStorage.getItem(Ct);return Fo(e||Rt)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Fo(Rt)}}function Bd(e){return Number.isFinite(e)?Math.min(Ns,Math.max(Ls,e)):fi}function zo(e){return Fn=Bd(e),Fn}function $d(e){_n=!!e}function Rd(e){xn=!!e}function Xs(){return{hoverScale:xo,selectionDimOpacity:Un,selectionDimEnabled:Hn,tileCompactness:Ao,titleWrapMode:La,titleHoverWidthMultiplier:To,titleHoverTextPortion:Lo,obsidianLinksEnabled:No,obsidianLinkMode:di,obsidianVaultName:Mo,autoIdFromNameEnabled:co,seriesNavDoubleClickWaitMs:Fn,showSecondaryLinks:_n,centerItems:Et,showReusedInMap:xn,theme:ui,colorPresets:tn,depColor:Zi,revdepColor:Xi,linkThickness:pi}}function Fa(e,{refreshObsidianLinks:t}={}){return wc(e,{applyTileHoverScale:Po,persistTileHoverScale:js,applySelectionDimEnabled:Wo,persistSelectionDimEnabled:Gs,applySelectionDimOpacity:Vo,persistSelectionDimOpacity:zs,applyTileCompactness:Do,persistTileCompactness:Ks,applyTitleWrapMode:Fo,persistTitleWrapMode:Zs,applyTitleHoverWidthMultiplier:Uo,persistTitleHoverWidthMultiplier:qs,applyTitleHoverTextPortion:Ho,persistTitleHoverTextPortion:Ys,applyObsidianLinksEnabled:Jo,persistObsidianLinksEnabled:nl,applyObsidianLinkMode:Go,persistObsidianLinkMode:tl,applyObsidianVaultName:Ko,persistObsidianVaultName:ol,applyAutoIdFromNameEnabled:jo,persistAutoIdFromNameEnabled:Js,applySeriesNavDoubleClickWait:zo,persistSeriesNavDoubleClickWait:el,localBackend:Ze,ui:Te,refreshObsidianLinks:t,scheduleOverlaySync:Zo,selection:K,select:Tt,clearStyles:da,drawLinks:Ln,applyReusedHighlights:er,setShowSecondaryLinks:$d,setShowReusedInMap:Rd,applyDepColor:Pa,persistDepColor:Ra,applyRevdepColor:Va,persistRevdepColor:Oa,applyLinkThickness:hi,persistLinkThickness:Da,applyTheme:Ba,setColorPresets:Oo,applyCenterItems:$o,persistCenterItems:$s,current:Xs()})}const Qs=()=>({version:1,exportedAt:new Date().toISOString(),settings:bc(Xs(),{localBackend:Ze})}),Od=e=>{const t=Ma(e);return Fa(t||{})};typeof window<"u"&&(window.__blockscapeSettingsBridge={exportPayload:Qs,applyPayload:Od});function el(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ts,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function Pd(){if(typeof window>"u"||!window.localStorage)return zo(fi);try{const e=window.localStorage.getItem(Ts);if(!e)return zo(fi);const t=parseInt(e,10);return zo(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),zo(fi)}}function Vd(e){return e===zi?zi:Ta}function Go(e){return di=Vd(e),di}function tl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ps,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function Dd(){if(typeof window>"u"||!window.localStorage)return Go(Gi);try{const e=window.localStorage.getItem(ps);return Go(e||Gi)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Go(Gi)}}function Jo(e){return No=!!e,No}function nl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(us,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function Ud(){if(typeof window>"u"||!window.localStorage)return Jo(!1);try{const e=window.localStorage.getItem(us);return e==null?Jo(!1):Jo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Jo(!1)}}function Ko(e){return Mo=(e??"").toString().trim(),Mo}function ol(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(fs,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Hd(){if(typeof window>"u"||!window.localStorage)return Ko("");try{const e=window.localStorage.getItem(fs);return Ko(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Ko("")}}function Fd(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Wd(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function fo(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function jd(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||ta(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=Vn(e,{seriesName:o,fallbackTitle:o})||kn(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=kn(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,fo(e,s),!0}function Wa(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>Wa(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${Wa(e[o])}`).join(",")}}`}function il(e){try{return Wa(e)}catch{return""}}function ea(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=il(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=il(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const zd=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category (cycles item.stage in Center view)."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function $n(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=nn(a).replace(/\./g,"-");e.id=s||`model-${uo()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function Gd(e){var s,c;const t=p=>{const g=(p??"").toString().trim();if(!g)return{base:"",suffix:null};const h=g.match(/^(.*?)-(\d+)$/);return{base:h?h[1]:g,suffix:h?Number.parseInt(h[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const p of n){if(p!=null&&p.isCategoryView)continue;const g=t(((c=p==null?void 0:p.data)==null?void 0:c.id)??(p==null?void 0:p.id)??"");if(g.base){i=g.base;break}}i||(i=nn(Vn(e)||ja(e)||qe(e,"model")));let a=0;return n.forEach(p=>{var h;if(p!=null&&p.isCategoryView)return;const g=t(((h=p==null?void 0:p.data)==null?void 0:h.id)??(p==null?void 0:p.id)??"");g.base===i&&Number.isFinite(g.suffix)&&g.suffix>a&&(a=g.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function Jd(e){return JSON.parse(JSON.stringify(e))}function qe(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function ta(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=kt(e);return a?`${a} series`:t}return qe(e,t)}function kt(e){var i;const t=Vn(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function ja(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function Kd(e){return e?e.toString().replace(/-series$/i,""):null}function za(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<u.length;n++){const o=(kt(u[n])||"").toLowerCase(),i=(ja(u[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function al(e){var c;if(e<0||e>=u.length||!m)return!0;const t=u[e],n=(m.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}$n(o,{titleHint:qe(t),idHint:kt(t)});const i=ea(t.data),a=ea(o);if(i===a)return!0;t.data=o;const s=zn(t);return s>=0&&((c=t.apicurioVersions)!=null&&c[s])&&(t.apicurioVersions[s].data=o),!0}function rl(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function na(e){if(v<0||!e)return null;const t=u[v].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function qd(e,t){const n=na(e);return n?(t?n.item.color=t:delete n.item.color,Pt(),Lt(),Tt(e),!0):!1}function Yd(e){if(v<0||!e)return!1;const t=u[v].data,o=((t==null?void 0:t.categories)||[]).find(a=>a.id===e);if(!o)return!1;let i=!1;return(o.items||[]).forEach(a=>{mi(a.stage)!=null&&(delete a.stage,i=!0)}),i?(Pt(),Lt(),K&&Tt(K),!0):!1}function Zd(e,t){if(!e||!t||v<0)return!1;const n=na(e);if(!n)return!1;const o=mi(n.item.stage),i=o??(t>0?_o:Ki),a=Ki-_o+1,s=((i-_o+t)%a+a)%a,c=_o+s;return n.item.stage=c,Pt(),Lt(),Tt(e),!0}function Xd(e,t){const n=rl(t);let o=nn(e||"item");if(!n.has(o))return o;const i=()=>uo().slice(0,4);for(;n.has(o);)o=`${nn(e||"item")}-${i()}`;return o}function Qd(e="category",t){const n=(t==null?void 0:t.categories)||[],o=nn(e||"category"),i=c=>n.some(p=>p.id===c);let a=o||`category-${uo()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const mo=pc({findItemAndCategoryById:na,collectAllItemIds:rl,updateItemReferences:uc,loadActiveIntoEditor:Pt,rebuildFromActive:Lt,select:e=>Tt(e),onSelectionRenamed:(e,t)=>{var n;K===e&&(K=t,on()),((n=$t==null?void 0:$t.item)==null?void 0:n.id)===e&&($t.item.id=t)},makeSlug:nn,isAutoIdFromNameEnabled:()=>co});function eu({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=L=>{if(a.fields.errorEl){if(!L){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=L}},c=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},p=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var L,O;(L=a.fields.titleInput)==null||L.focus(),(O=a.fields.titleInput)==null||O.select()}))},g=({force:L}={})=>{var ne,Me;if(!co||!a.autoSyncEnabled||!((ne=a.fields)!=null&&ne.idInput)||!((Me=a.fields)!=null&&Me.titleInput)||!L&&a.idManuallyEdited)return;const O=nn(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=O},h=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const L=a.modelData.categories||[],O=L.find(ke=>ke.id===a.categoryId);if(!O)throw new Error("Category not found.");const ne=(a.fields.idInput.value||"").trim();if(!ne)throw new Error("ID is required.");const Me=(a.fields.titleInput.value||"").trim();if(L.some(ke=>ke.id===ne&&ke.id!==O.id))throw new Error("Another category already uses that ID.");const Se=O.id;return O.id=ne,O.title=Me||O.id,Se!==ne&&typeof i=="function"&&i(Se,ne),t(),n(),o(ne,{scrollIntoView:!0}),!0},S=()=>{try{return h(),c(),!0}catch(L){return console.warn("[CategoryEditor] save failed",L),s((L==null?void 0:L.message)||"Unable to save category."),!1}},R=()=>{if(a.wrapper)return a.wrapper;const L=document.createElement("div");L.className="item-editor-modal category-editor-modal",L.hidden=!0,L.setAttribute("role","dialog"),L.setAttribute("aria-modal","true");const O=document.createElement("div");O.className="item-editor-modal__backdrop",L.appendChild(O);const ne=document.createElement("div");ne.className="item-editor",L.appendChild(ne);const Me=document.createElement("div");Me.className="item-editor__header";const ht=document.createElement("h2");ht.className="item-editor__title",ht.textContent="Edit category";const Se=document.createElement("button");Se.type="button",Se.className="item-editor__close",Se.setAttribute("aria-label","Close category editor"),Se.textContent="×",Me.appendChild(ht),Me.appendChild(Se),ne.appendChild(Me);const ke=document.createElement("form");ke.className="item-editor__form",ne.appendChild(ke);const ot=document.createElement("div");ot.className="item-editor__meta",ot.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',ke.appendChild(ot);const He=document.createElement("div");He.className="item-editor__error",He.hidden=!0,ke.appendChild(He);const Vt=(dn,Xe,ei)=>{const un=document.createElement("label");un.className="item-editor__field";const bo=document.createElement("span");if(bo.className="item-editor__label",bo.textContent=dn,un.appendChild(bo),Xe.classList.add("item-editor__control"),un.appendChild(Xe),ei){const gn=document.createElement("div");gn.className="item-editor__hint",gn.textContent=ei,un.appendChild(gn)}return un},Zt=document.createElement("input");Zt.type="text",ke.appendChild(Vt("Title",Zt,"Display label shown in the map."));const Dt=document.createElement("input");Dt.type="text",Dt.required=!0,ke.appendChild(Vt("ID",Dt,"Unique identifier for this category (used in URLs and references)."));const Ie=document.createElement("div");Ie.className="item-editor__checkbox";const Nt=document.createElement("label");Nt.className="item-editor__checkbox-row";const Nn=document.createElement("input");Nn.type="checkbox";const Kn=document.createElement("span");Kn.textContent="Sync ID while editing title";const Mt=document.createElement("div");Mt.className="item-editor__hint",Mt.textContent="Turn off to keep typing titles without changing the ID.",Nt.append(Nn,Kn),Ie.append(Nt,Mt),ke.appendChild(Ie);const zt=document.createElement("div");zt.className="item-editor__actions";const ln=document.createElement("button");ln.type="submit",ln.className="item-editor__action item-editor__action--primary",ln.textContent="Save";const cn=document.createElement("button");return cn.type="button",cn.className="item-editor__action",cn.textContent="Cancel",zt.appendChild(ln),zt.appendChild(cn),ke.appendChild(zt),ke.addEventListener("submit",dn=>{dn.preventDefault(),S()}),cn.addEventListener("click",c),Se.addEventListener("click",c),O.addEventListener("click",c),Dt.addEventListener("input",()=>{a.idManuallyEdited=!0}),Zt.addEventListener("input",()=>g()),Nn.addEventListener("change",()=>{a.autoSyncEnabled=!!Nn.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,g({force:!0}))}),L.addEventListener("keydown",dn=>{dn.key==="Escape"&&(dn.preventDefault(),c())}),document.body.appendChild(L),a.wrapper=L,a.fields={titleInput:Zt,idInput:Dt,errorEl:He,metaLabel:ot.querySelector(".item-editor__meta-value"),syncCheckbox:Nn},L};return{open:L=>{if(!L||!R())return!1;const ne=e(),ht=((ne==null?void 0:ne.categories)||[]).find(ke=>ke.id===L);if(!ht)return!1;a.categoryId=ht.id,a.modelData=ne,a.idManuallyEdited=!1;const Se=!!co;return a.autoSyncEnabled=Se,a.fields.metaLabel.textContent=ht.title||ht.id||"Category",a.fields.titleInput.value=ht.title||ht.id||"",a.fields.idInput.value=ht.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!Se,!a.fields.idInput.value&&Se&&g({force:!0}),s(""),p(),!0},hide:c,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const tu=eu({getActiveModelData:()=>{var e;return(e=u[v])==null?void 0:e.data},loadActiveIntoEditor:Pt,rebuildFromActive:Lt,selectCategory:(e,t={})=>Gn(e,t),onCategoryRenamed:(e,t)=>{tt===e&&(tt=t,on())}}),{handleTileContextMenu:nu,hidePreview:ho,handleDocumentClick:ou,handleWindowResize:iu,handleWindowScroll:au,updateColorPresets:qo}=gc({menuEl:document.getElementById("tileContextMenu"),previewEl:Z,previewTitleEl:re,previewBodyEl:Ce,previewActionsEl:it,previewCloseEl:Ge,escapeHtml:yi,onEditItem:e=>mo.open(e),onChangeColor:(e,t)=>qd(e,t),selectItem:e=>Tt(e),colorPresets:tn});function oa(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||qe(e);return Jt(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function ru({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=nn(`${e||"blank"}-${Ha()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),$n(o,{titleHint:t,idHint:n}),o}function su(){const t=`Blank series ${Ha()}`,n=kn(t,"blank-series"),o=ru({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return fo(i,n),Jt(i,{seriesName:t,fallbackTitle:t}),i}function lu(){const e=su(),t=Rn(e,{versionLabel:"blank"});return Ot(t),ad({origin:"new-blank"}),aa(),fn("Blank series created. Add categories and tiles to start.",2600),t}function Rn(e,{versionLabel:t,createdOn:n}={}){var p,g,h;if(e!=null&&e.isSeries||((p=e==null?void 0:e.apicurioVersions)==null?void 0:p.length)>1){const S=e.title||qe(e);Jt(e,{seriesName:S,fallbackTitle:S}),ra(e)}const o=kt(e);if(!o)return oa(e,{versionLabel:t||"1",createdOn:n}),u.push(e),u.length-1;const i=u.findIndex(S=>kt(S)===o);if(i===-1)return oa(e,{versionLabel:t||"1",createdOn:n}),u.push(e),u.length-1;const a=u[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(h=(g=a.apicurioVersions)==null?void 0:g[0])==null?void 0:h.createdOn}],a.apicurioActiveVersionIndex=0;const S=a.title||qe(a);Jt(a,{seriesName:S,fallbackTitle:S})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=qe(e)||a.title,a.isSeries=!0;const c=a.title||qe(a);return Jt(a,{seriesName:c,fallbackTitle:c}),i}function sl({versionLabel:e}={}){var c;if(v<0||!u[v])throw new Error("Load or select a model before creating a version.");const t=u[v];oa(t,{versionLabel:"1"});const n=Gd(t);let o;try{o=Jd(t.data)}catch(p){throw console.warn("[Blockscape] failed to clone active model for versioning",p),new Error("Could not copy the current model.")}n&&(o.id=n),$n(o,{titleHint:qe(t),idHint:kt(t)||Vn(t)});const a={version:e||String((((c=t.apicurioVersions)==null?void 0:c.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||qe(t);return Jt(t,{seriesName:s,fallbackTitle:s}),v}function Ga(){const e=v>=0&&u[v]?u[v]:null,t=kt(e);document.title=t?`${t}-blockscape`:rt}function ia(e){if(!e)return null;ra(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||qe(e);return Jt(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var p;const s=((i==null?void 0:i.version)??"").toString().trim(),c=(((p=i==null?void 0:i.data)==null?void 0:p.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(qi)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:c}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function cu(){const e=u[v],t=ia(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function ll(e="shortcut",t=!1){const n=m.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=u[v],i=t?ia(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,c=Vn(o),p=kt(o),g=c||p||qe(o,"blockscape"),h=a?"-series":"",S=`${nn(g)}${h}.bs`;return Bs(S,s),console.log(`[Blockscape] saved JSON (${e}):`,S),!0}const du=Gt.palette.letter,uu=Gt.palette.letterFallback;function cl(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return du[n]||uu}function pu(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(p=>p+p).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?Gt.color.ink:Gt.color.white}function fu(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function Ja(){if(sn)return;sn=document.createElement("div"),sn.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",qt=document.createElement("span"),qt.className="series-nav-notice__text",sn.appendChild(e),sn.appendChild(qt),document.body.appendChild(sn)}function Ka(){Tn&&(clearTimeout(Tn),Tn=null),sn&&sn.classList.remove("is-visible"),qt&&(qt.textContent="")}function Yo(){en=null,Ft&&(clearTimeout(Ft),Ft=null),Ka()}function qa(){An=null,Wt&&(clearTimeout(Wt),Wt=null),Ka()}function mu(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function hu(e,t,n){Ja(),en={id:e,targetVersionIndex:t},Ft&&clearTimeout(Ft),Ft=setTimeout(()=>{Ft=null,Yo()},Fn);const o=mu(n,t);fn(`Click again to open ${o} in this series.`,Fn)}function gu(e,t){Ja(),An={id:e,targetIndex:t},Wt&&clearTimeout(Wt),Wt=setTimeout(()=>{Wt=null,qa()},Fn);const n=ta(u[t]);fn(`Click again to open "${n}".`,Fn)}function fn(e,t=so,n=null){if(Ja(),qt.textContent="",qt.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,qt.appendChild(o),qt.appendChild(i)}sn.classList.add("is-visible"),Tn&&clearTimeout(Tn),Tn=setTimeout(()=>Ka(),t)}function bu(){ce&&(ce.innerHTML="",zd.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const c=document.createElement("span");c.className="shortcut-help__or",c.textContent="or",n.appendChild(c)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((c,p)=>{if(p>0){const h=document.createElement("span");h.className="shortcut-help__sep",h.textContent="+",s.appendChild(h)}const g=document.createElement("kbd");g.className="shortcut-help__key",g.textContent=c,s.appendChild(g)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),ce.appendChild(t)}),rn=!0)}function wu(){return!!we&&we.hidden===!1}function vu(){if(!we)return;rn||bu(),Dn=document.activeElement,we.hidden=!1,we.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=we.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ya(){if(!we||we.hidden)return;we.hidden=!0,we.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=Dn;e!=null&&e.focus?e.focus({preventScroll:!0}):Be!=null&&Be.focus&&Be.focus({preventScroll:!0})}function yu(){if(!Y)return;Y.hidden=!1,Y.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Y.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function aa(){!Y||Y.hidden||(Y.hidden=!0,Y.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),me!=null&&me.focus&&me.focus({preventScroll:!0}))}let Za=!1;function Zo(){Za||(Za=!0,requestAnimationFrame(()=>{Za=!1,la(),Ln()}))}let dl=!1;function ul(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function Su(e){const t=ul(e);if(!t.length){_.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}_.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(c=>o.includes(c)||i.includes(c));n.style.opacity=a?"1":"0.2"})}function Eu(e){const t=ul(e);if(!t.length)return[];const n=[];return u.forEach((o,i)=>{var g;const a=ta(o),s=kt(o)||"",c=`${a} ${s}`.toLowerCase();t.every(h=>c.includes(h))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((g=o.data)==null?void 0:g.categories)?o.data.categories:[]).forEach(h=>{const S=(h.title||h.id||"").toString();(h.items||[]).forEach(R=>{const T=(R.name||R.id||"").toString(),L=`${T} ${R.id||""} ${S}`.toLowerCase();t.every(O=>L.includes(O))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:R.id,itemName:T,categoryTitle:S})})})}),n.slice(0,Ne)}function pl(e){if(!de)return;de.innerHTML="";const t=(e||"").toString();if(!t.trim()){de.hidden=!0;return}if(!u.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",de.appendChild(o),de.hidden=!1;return}const n=Eu(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",de.appendChild(o),de.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===v&&(!o.itemId||K===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemName||o.itemId||"Item",a.appendChild(s);const c=document.createElement("span");c.className="search-result__badge",c.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(c);const p=document.createElement("div");p.className="search-result__meta";const g=document.createElement("span");if(g.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,p.appendChild(g),o.type==="item"&&o.itemId){const h=document.createElement("span");h.textContent=`Item ID: ${o.itemId}`,p.appendChild(h)}else if(o.type==="model"){const h=document.createElement("span");h.textContent="Matches model title",p.appendChild(h)}i.appendChild(a),i.appendChild(p),de.appendChild(i)}),de.hidden=!1}function fl(e){Su(e||""),pl(e||"")}function ku(e){!e||!Number.isInteger(e.modelIndex)||(Ot(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(v!==e.modelIndex)return;const t=(n=ft.get(e.itemId))==null?void 0:n.el;t&&(Tt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function Ot(e){var t;if(ho(),Yo(),$t=null,hn=null,tt=null,mt=null,e<0||e>=u.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(N=!0,v=e,console.log("[Blockscape] active model:",qe(u[e]),"(index",e+" )"),typeof(Ze==null?void 0:Ze.highlightSource)=="function"){const n=((t=u[e])==null?void 0:t.sourcePath)||null;Ze.highlightSource(n)}Ga(),Wn(),Pt(),Lt(),Ee&&fl(Ee.value||""),Ze.updateActiveSavePlaceholder(),pt.updateAvailability(),Ua()}function Wn(){if(G.innerHTML="",!u.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",G.appendChild(e);return}u.forEach((e,t)=>{var S;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===v?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===v?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=ta(e),i.appendChild(a);const s=Kd(ja(e)||kt(e));if(s){const R=document.createElement("span");R.className="model-nav-id",R.textContent=s,i.appendChild(R)}const c=Array.isArray((S=e.data)==null?void 0:S.categories)?e.data.categories:[],p=c.reduce((R,T)=>R+(T.items||[]).length,0),g=document.createElement("span");g.className="model-nav-meta";const h=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";g.textContent=`${c.length} cat · ${p} items${h}`,o.appendChild(i),o.appendChild(g),n.appendChild(o),G.appendChild(n)}),pt.updateAvailability()}function Pt(){if(v<0){m.value="",M&&(M.disabled=!0);return}const e=u[v];m.value=JSON.stringify(e.data,null,2),M&&(M.disabled=!ia(e))}function Iu(e){try{return JSON.parse(e)}catch{return null}}function ml(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function _u(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,c)=>{const p=s==null?void 0:s.data;if(!p||!Array.isArray(p.categories))return;const g=qe(p,`Map ${c+1}`),h=(p.id??"").toString().trim()||nn(g||`map-${c+1}`),S=nn(h||g||`map-${c+1}`);p.categories.forEach(R=>{const T=((R==null?void 0:R.id)??"").toString().trim();if(!T)return;n.has(T)||n.set(T,{catTitle:R.title||T,sources:[]});const L=n.get(T);!L.catTitle&&(R.title||T)&&(L.catTitle=R.title||T),L.sources.push({category:R,mapId:h,mapTitle:g,mapSlug:S,versionIndex:c})})});const o=Vn(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||qe(e,"Series"),a=[];return n.forEach((s,c)=>{var R;if((((R=s.sources)==null?void 0:R.length)||0)<2)return;const p=s.catTitle||c,g=new Set,h=s.sources.map(T=>{var ht;let O=T.mapSlug||nn(T.mapTitle||T.mapId)||`map-${T.versionIndex+1}`;g.has(O)&&(O=`${O}-${T.versionIndex+1}`),g.add(O);const ne=new Map,Me=(((ht=T.category)==null?void 0:ht.items)||[]).map((Se,ke)=>{const ot=((Se==null?void 0:Se.id)??"").toString().trim()||`item-${ke+1}`,He=`${O}-${ot}`;ne.set(ot,He);const Vt={...Se,id:He};return Vt.deps=Array.isArray(Se==null?void 0:Se.deps)?[...Se.deps]:[],Vt});return Me.forEach(Se=>{Se.deps=(Se.deps||[]).map(ke=>ne.get(ke)).filter(Boolean)}),{id:O,title:T.mapTitle||T.mapId||`Map ${T.versionIndex+1}`,items:Me}}),S={id:nn(`${c}-category-view`),title:p,abstract:`Items from "${p}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:h};o&&(S.seriesId=o),$n(S,{titleHint:p,idHint:`${o||"series"}-${c}`}),a.push({version:`${qi}${c}`,data:S,isCategoryView:!0,categoryViewKey:c})}),a}function hl(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${qi}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function ra(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=hl(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(c=>!(c!=null&&c.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(zn(e),e.apicurioVersions.length-1));const c=e.apicurioVersions[e.apicurioActiveVersionIndex];return c!=null&&c.data&&(e.data=c.data),e}const o=_u({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(c=>hl(c)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function Cu(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((h,S)=>!h||typeof h!="object"?null:($n(h,{titleHint:`${t} #${S+1}`}),{obj:h,idx:S})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let c=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const p={id:uo(),title:c,data:a,apicurioVersions:i.map(({obj:h,idx:S})=>({version:String(S+1),data:h})),apicurioActiveVersionIndex:0,isSeries:!0},g=Jt(p,{seriesName:c,fallbackTitle:c});return g&&(p.id=g),ra(p),[p]}function gl(e,t="Pasted",n={}){return Array.isArray(e)?Cu(e,t,n):!e||typeof e!="object"?[]:($n(e,{titleHint:`${t} #1`}),[{id:uo(),title:e.title||`${t} #1`,data:e}])}function jn(e,t="Pasted",n={}){const a=(ml(typeof e=="string"?e:"")||"").replace(/^\uFEFF/,"").replace(/\u0000/g,"").trim();if(!a)return[];const s=Iu(a);if(s){let p=n;if(Array.isArray(s)&&n.promptForSeriesName){const h=Wd(s,t),S=Fd(h);p={...n,promptForSeriesName:!1,seriesTitleOverride:S||h}}const g=gl(s,t,p);if(g.length)return g}return a.split(/^\s*(?:---|%%%)\s*$/m).map(p=>p.trim()).filter(Boolean).map((p,g)=>{const h=JSON.parse(p);return $n(h,{titleHint:`${t} #${g+1}`}),{id:uo(),title:h.title||`${t} #${g+1}`,data:h}})}function xu(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function go(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!xu(e)}function Au(e){if(!e)return!1;const n=(ml(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function bl(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(at)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(at)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(at)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=jn(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let o=null;return n.forEach(i=>{const a=Rn(i,{versionLabel:"editor"});o==null&&(o=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:o,count:n.length}}function wl(e="storage"){const t=bl();return!t||typeof t.index!="number"?!1:(Ot(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Tu(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=jc(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=gl(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const c=s.isSeries?o.title||s.title:null,p=Rn({...s,apicurioArtifactName:c||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=p)}),a}async function Lu(){const e=rd();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await bi())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await Fs(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(Ze==null?void 0:Ze.highlightSource)=="function"&&Ze.highlightSource(t);let s=a.firstIndex;if(n){const c=za(n);c!==-1&&(s=c)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function Nu(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await tr(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function Mu(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const c=new Set(s.deps||[]);t.set(s.id,c),c.forEach(p=>{n.has(p)||n.set(p,new Set),n.get(p).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function Bu(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=cl(e,t),c=pu(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=c,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function zn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function vl(e){const t=zn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function yl(e,t="active"){return Vn(e)||kt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function $u(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,c;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((c=n==null?void 0:n.data)==null?void 0:c.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function Ru(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(nn(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,c]of t.entries())if(s.toLowerCase()===a)return c}return null}const Sl=new WeakMap;function Ou(e,t){var He;if(!((He=e==null?void 0:e.apicurioVersions)!=null&&He[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=ea(o),a=Sl.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,c=160,p=document.createElement("canvas");p.width=s,p.height=c;const g=p.getContext("2d"),h=Ro("--color-surface-ghost")||Gt.color.surfaceGhost,S=Ro("--color-border-muted")||Gt.color.borderMuted;g.fillStyle=h,g.fillRect(0,0,s,c),g.strokeStyle=S,g.strokeRect(.5,.5,s-1,c-1);const R=8,T=8,L=4,O=Array.isArray(o==null?void 0:o.categories)?o.categories:[],ne=Math.max(O.length,1),Me=s-L*2,ht=L*3,Se=ne>1?Math.min(ht,Me/(ne-1)):0,ke=ne>1?(s-Se*(ne-1))/2:s/2;O.forEach((Vt,Zt)=>{const Dt=ke+Zt*Se,Ie=Array.isArray(Vt.items)?Vt.items:[],Nt=Math.max(Ie.length,1),Nn=c-R-T-L*2,Kn=Nt>1?Math.min(L*3,Nn/(Nt-1)):0;Ie.forEach((Mt,zt)=>{const ln=c-T-L-zt*Kn;g.beginPath(),g.arc(Dt,ln,L,0,Math.PI*2);const cn=cl(Mt.name||Mt.id||"",Mt.color);g.fillStyle=cn,g.strokeStyle="rgba(15,23,42,0.25)",g.fill(),g.stroke()})});const ot=p.toDataURL("image/png");return Sl.set(n,{fingerprint:i,dataUrl:ot}),ot}function sa(e,t){var c;if(Yo(),e<0||e>=u.length)return!1;const n=u[e];if(!((c=n==null?void 0:n.apicurioVersions)!=null&&c.length)||!al(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,N=!0,K=null,st=null,on(),Pt(),Lt(),!0):!1}function Xa(e){var o;if(!e||v<0)return!1;const t=u[v];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=zn(t);return n===-1?!1:sa(v,n+e)}function Pu(e,t){if(Yo(),e<0||e>=u.length)return!1;const n=u[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!al(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=zn(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const c=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(c==null?void 0:c.data)||n.data,n.isSeries=n.apicurioVersions.length>1,Ot(e),!0}function Vu(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,l.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||kt(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var Me;const O=u[v];!((Me=O==null?void 0:O.apicurioVersions)!=null&&Me.length)||!jd(O)||(Wn(),Pt(),Lt())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=zn(e),s=vl(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const c=document.createElement("div");c.className="version-nav__controls";const p=document.createElement("button");p.type="button",p.className="version-nav__button",p.textContent="Previous",p.addEventListener("click",()=>Xa(-1));const g=document.createElement("button");g.type="button",g.className="version-nav__button",g.textContent="Next",g.addEventListener("click",()=>Xa(1)),c.appendChild(p),c.appendChild(g),n.appendChild(c);const h=document.createElement("div");h.className="version-nav__thumbs",e.apicurioVersions.forEach((O,ne)=>{var Zt,Dt;const Me=document.createElement("button");Me.type="button",Me.className="version-nav__thumb",O!=null&&O.isCategoryView&&Me.classList.add("version-nav__thumb--category"),ne===a&&Me.classList.add("is-active");const ht=Ou(e,ne);if(ht){const Ie=document.createElement("img");Ie.src=ht,Ie.alt=`Version ${ne+1}`,Me.appendChild(Ie)}const Se=document.createElement("div");Se.className="version-nav__thumb-label";const ke=document.createElement("span");ke.className="version-nav__thumb-label-text";const ot=(((Zt=O==null?void 0:O.data)==null?void 0:Zt.id)??(O==null?void 0:O.id)??"").toString().trim();let He=ot||(O!=null&&O.version?`v${O.version}`:`${ne+1}`),Vt=ot||He;if(O!=null&&O.isCategoryView){const Ie=((Dt=O.data)==null?void 0:Dt.title)||O.categoryViewKey||He||"Category";He=Ie,Vt=`Category view: ${Ie}`,Me.dataset.computed="true"}if(ke.textContent=He,Se.title=Vt,Se.appendChild(ke),Me.appendChild(Se),Gu(Se,ke),e.apicurioVersions.length>1&&!(O!=null&&O.isCategoryView)){const Ie=document.createElement("span");Ie.className="version-nav__thumb-remove",Ie.title=`Remove ${He} from this series`,Ie.setAttribute("aria-label",`Remove ${He} from this series`),Ie.setAttribute("role","button"),Ie.tabIndex=-1,Ie.textContent="×",Ie.addEventListener("click",Nt=>{Nt.stopPropagation(),Nt.preventDefault(),window.confirm(`Remove ${He} from this series?`)&&Pu(v,ne)}),Me.appendChild(Ie)}Me.addEventListener("click",()=>sa(v,ne)),Ku(Me,O),h.appendChild(Me)});const S=document.createElement("button");S.type="button",S.className="version-nav__thumb version-nav__thumb--add",S.title="Create a new version from this map",S.addEventListener("click",()=>{try{const O=sl({versionLabel:"manual"});Ot(O)}catch(O){alert((O==null?void 0:O.message)||"Unable to create a new version right now.")}});const R=document.createElement("span");R.className="version-nav__thumb-add-icon",R.textContent="+",S.appendChild(R),h.appendChild(S),n.appendChild(h);const T=yl(e,"active"),L=V.get(T);return typeof L=="number"&&!Number.isNaN(L)&&requestAnimationFrame(()=>{h.scrollLeft=L}),h.addEventListener("scroll",()=>{V.set(T,h.scrollLeft)}),n}function wi(){var jl,zl;if(!se)return;const e=v>=0&&u[v]?u[v]:null,t=_&&_.querySelector?_.querySelector(".version-nav__thumbs"):null;if(t&&e){const f=yl(e,v);V.set(f,t.scrollLeft)}Jn(),Array.isArray(se.m.categories)||(se.m.categories=[]),console.log("[Blockscape] rendering categories=",se.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!se.m.abstract,"- value:",se.m.abstract?se.m.abstract.substring(0,50)+"...":"none"),_.innerHTML="",ft.clear(),In.clear(),be=[],oa(u[v],{versionLabel:"1"});const n=Vu(u[v]);n&&_.appendChild(n),j.setAttribute("width",window.innerWidth),j.setAttribute("height",window.innerHeight);const i=(()=>{var q,ze,Qt;const f=document.createElement("div");f.className="blockscape-model-meta";const $=document.createElement("div");$.className="blockscape-model-title",$.textContent=se.m.title&&se.m.title.trim()||qe(u[v]),f.appendChild($),((q=u[v])!=null&&q.isSeries||(Qt=(ze=u[v])==null?void 0:ze.apicurioVersions)!=null&&Qt.length)&&Jt(u[v],{seriesName:u[v].title||se.m.title||qe(u[v])});const H=vl(u[v]),_e=Vn(u[v]),ue=(se.m.id??"").toString().trim(),Pe=document.createElement("div");Pe.className="blockscape-model-meta__details";const Re=(De,Ut)=>{if(!Ut)return;const En=document.createElement("div");En.className="blockscape-model-id";const vo=document.createElement("span");vo.className="blockscape-model-id__label",vo.textContent=De;const yo=document.createElement("span");yo.className="blockscape-model-id__value",yo.textContent=Ut,En.append(vo,yo),Pe.appendChild(En)};return Re("Series ID",_e),Re("Model ID",ue),Re("No. in series",H),Pe.childElementCount&&f.appendChild(Pe),f})();l.showModelMeta!==!1&&_.appendChild(i.cloneNode(!0));const s=document.createElement("div");s.className="blockscape-tabs";const c=document.createElement("div");c.className="blockscape-tabrow";const p=document.createElement("div");p.className="blockscape-tablist",p.setAttribute("role","tablist"),c.appendChild(p);const g=document.createElement("div");g.className="blockscape-tabactions",c.appendChild(g),s.appendChild(c);const h=document.createElement("div");h.className="blockscape-tabpanels",s.appendChild(h);const S=document.createElement("div"),R=document.createElement("div"),T=document.createElement("div"),L=document.createElement("div"),O=()=>{const f=document.createElement("div");f.className="blockscape-map-legend";const $=document.createElement("div");return $.className="blockscape-legend",$.setAttribute("role","presentation"),$.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,f.appendChild($),f};let ne="";const Me=$u(u[v]),ht=zn(u[v]),Se=((zl=(jl=u[v])==null?void 0:jl.apicurioVersions)==null?void 0:zl[ht])||null,ke=Cn=!!(Se!=null&&Se.isCategoryView||((Se==null?void 0:Se.version)||"").startsWith(qi));y=null,B="";const ot=(f,$)=>{!f||!$||(f.title=f.title?`${f.title}
${$}`:$)},He=[{id:"map",label:"Map",panel:S},{id:"abstract",label:"Info",panel:R},{id:"source",label:"Settings",panel:T},{id:"apicurio",label:"Apicurio",panel:L}],Vt=typeof pt.isEnabled=="function"?pt.isEnabled():!1,Zt=f=>{if(!j)return;const $=f==="map";j.hidden=!$,$?(la(),Ln()):j.innerHTML=""};He.forEach((f,$)=>{const H=document.createElement("button");H.type="button",H.id=`tab-${f.id}`,H.className="blockscape-tab"+($===0?" is-active":""),H.setAttribute("role","tab"),H.setAttribute("aria-controls",`panel-${f.id}`),H.setAttribute("aria-selected",$===0?"true":"false"),H.textContent=f.label,f.id==="apicurio"&&!Vt&&(H.hidden=!0,H.tabIndex=-1,H.setAttribute("aria-hidden","true"),H.style.display="none"),f.button=H,p.appendChild(H),f.panel.id=`panel-${f.id}`,f.panel.classList.add("blockscape-tabpanel"),f.panel.setAttribute("role","tabpanel"),f.panel.setAttribute("aria-labelledby",H.id),f.panel.hidden=$!==0,$===0&&f.panel.classList.add("is-active"),h.appendChild(f.panel)});const Dt=f=>{Kt=f,He.forEach($=>{const H=$.id===f;$.button.classList.toggle("is-active",H),$.button.setAttribute("aria-selected",H?"true":"false"),$.panel.classList.toggle("is-active",H),$.panel.hidden=!H}),Zt(f)},Ie=He.find(f=>f.id==="apicurio"),Nt=f=>{if(!Ie||!Ie.button||!Ie.panel)return;const $=!!f;if(Ie.button.hidden=!$,Ie.button.tabIndex=$?0:-1,Ie.button.setAttribute("aria-hidden",$?"false":"true"),Ie.button.style.display=$?"":"none",$){const H=Kt==="apicurio";Ie.button.classList.toggle("is-active",H),Ie.button.setAttribute("aria-selected",H?"true":"false"),Ie.panel.classList.toggle("is-active",H),Ie.panel.hidden=!H}else{const H=Ie.panel.classList.contains("is-active");if(Ie.button.classList.remove("is-active"),Ie.button.setAttribute("aria-selected","false"),Ie.panel.classList.remove("is-active"),Ie.panel.hidden=!0,H){const _e=He.find(ue=>ue.id!=="apicurio");_e&&Dt(_e.id)}}ee&&(ee.checked=$)};He.forEach(f=>{f.button.addEventListener("click",()=>{Jn(),Dt(f.id)}),f.id==="abstract"&&(y=f.button,f.button.addEventListener("mouseenter",()=>Si(f.button,ne,{offset:12})),f.button.addEventListener("mouseleave",Jn),f.button.addEventListener("focus",()=>Si(f.button,ne,{offset:12})),f.button.addEventListener("blur",Jn))});const Kn=(f=>{const $=He.find(_e=>_e.id===Kt);if($&&($.id!=="apicurio"||f))return $.id;const H=He.find(_e=>_e.id!=="apicurio"||f);return(H==null?void 0:H.id)||He[0].id})(Vt);Dt(Kn),Nt(Vt),typeof pt.onEnabledChange=="function"&&pt.onEnabledChange(Nt),_.appendChild(s),S.appendChild(O());const Mt=document.createElement("div");Mt.className="blockscape-render";const zt=document.createElement("div");zt.className="stage-guides",zt.hidden=!Et,zt.setAttribute("aria-hidden","true");const ln=document.createElement("div");ln.className="stage-guide-labels",["Genesis / Inception","Custom","Product / Rental","Service / Commodity"].forEach(f=>{const $=document.createElement("span");$.className="stage-guide-labels__item",$.textContent=f,ln.appendChild($)}),zt.appendChild(ln),Mt.appendChild(zt),Na=zt,S.appendChild(Mt);const cn=document.createElement("div");if(cn.className="blockscape-abstract-panel",R.appendChild(i.cloneNode(!0)),se.m.abstract){console.log("[Blockscape] Rendering abstract content");const f=document.createElement("div");f.className="blockscape-abstract",f.innerHTML=se.m.abstract,fp(f),cn.appendChild(f),ne=f.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const f=document.createElement("div");f.className="blockscape-abstract-placeholder",f.textContent="No abstract has been provided for this model.",cn.appendChild(f),ne=f.outerHTML}B=ne,R.appendChild(cn);const dn=document.createElement("div");dn.className="blockscape-source-panel";const Xe=document.createElement("div");Xe.className="blockscape-settings-panel";const ei=f=>{Te.themeToggle&&(Te.themeToggle.checked=f),Te.tabThemeToggle&&(Te.tabThemeToggle.checked=f)},un=f=>{ei(f),Ba(f?lo:Co)},bo=f=>{Te.tabCenterToggle&&(Te.tabCenterToggle.checked=f)},gn=f=>{const $=$o(f);bo($),$s($)},nr=f=>{Te.secondaryLinksToggle&&(Te.secondaryLinksToggle.checked=f),Te.tabSecondaryLinksToggle&&(Te.tabSecondaryLinksToggle.checked=f)},Ei=f=>{const $=!!f;nr($),_n=$,K?Tt(K):(da(),Ln())},ki=({id:f,label:$,checked:H,onChange:_e})=>{const ue=document.createElement("label");ue.className="blockscape-tab-toggle",ue.setAttribute("for",f);const Pe=document.createElement("input");Pe.type="checkbox",Pe.id=f,Pe.checked=H,typeof _e=="function"&&Pe.addEventListener("change",()=>_e(Pe.checked));const Re=document.createElement("span");return Re.className="blockscape-tab-toggle__label",Re.textContent=$,ue.append(Pe,Re),{row:ue,input:Pe}},ti=document.createElement("p");ti.className="blockscape-settings-panel__title",ti.textContent="Feature toggles",Xe.appendChild(ti);const Ii=document.createElement("label");Ii.className="settings-toggle";const Qn=document.createElement("input");Qn.type="checkbox",Qn.checked=ui===lo;const _i=document.createElement("span");_i.className="settings-toggle__text";const ni=document.createElement("span");ni.className="settings-toggle__label",ni.textContent="Dark mode";const I=document.createElement("span");I.className="settings-toggle__hint",I.textContent="Switch Blockscape UI to dark colors.",_i.append(ni,I),Ii.append(Qn,_i),Qn.addEventListener("change",()=>{un(Qn.checked)}),Xe.appendChild(Ii),Te.themeToggle=Qn;const{row:U,input:oe}=ki({id:"tabToggleTheme",label:"Dark mode",checked:ui===lo,onChange:f=>un(f)});g.appendChild(U),Te.tabThemeToggle=oe;const{row:he,input:Qe}=ki({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:_n,onChange:f=>Ei(f)});g.appendChild(he),Te.tabSecondaryLinksToggle=Qe;const{row:je,input:ie}=ki({id:"tabToggleCenterItems",label:"Wardley",checked:Et,onChange:f=>gn(f)});g.appendChild(je),Te.tabCenterToggle=ie;const $e=document.createElement("div");$e.className="settings-actions";const St=document.createElement("input");St.type="file",St.accept="application/json",St.hidden=!0;const mn=document.createElement("button");mn.type="button",mn.className="pf-v5-c-button pf-m-secondary",mn.textContent="Load settings",mn.addEventListener("click",()=>St.click()),St.addEventListener("change",async()=>{var $,H;const f=($=St.files)==null?void 0:$[0];if(f)try{const _e=await f.text(),ue=JSON.parse(_e),Pe=(ue==null?void 0:ue.settings)||ue,q=((H=Fa(Pe||{},{refreshObsidianLinks:ua}).applied)==null?void 0:H.length)||0;fn(q?`Loaded ${q} setting${q===1?"":"s"} from ${f.name}.`:`No matching settings found in ${f.name}.`,2200)}catch(_e){console.warn("[Blockscape] failed to load settings.json",_e),fn("Invalid settings file.",2400)}finally{St.value=""}});const an=document.createElement("button");an.type="button",an.className="pf-v5-c-button pf-m-tertiary",an.textContent="Download settings",an.addEventListener("click",async()=>{const f=Qs();if(typeof window<"u"&&typeof window.__blockscapeSettingsSaveToFile=="function")try{await window.__blockscapeSettingsSaveToFile(f)?fn("Settings saved to ~/.blockscape/settings.json.",2e3):fn("Settings save failed. Check logs.",2400)}catch($){console.warn("[Blockscape] settings save failed",$),fn("Settings save failed. Check logs.",2400)}else Bs("settings.json",JSON.stringify(f,null,2)),fn("Settings downloaded.",2e3)}),$e.append(mn,an,St),Xe.appendChild($e);const qn=document.createElement("div");qn.className="color-presets";const or=document.createElement("div");or.className="settings-text__label",or.textContent="Color presets";const ir=document.createElement("div");ir.className="settings-text__hint",ir.textContent="Shown in tile context menu for quick coloring.",qn.append(or,ir);const Ci=document.createElement("div");Ci.className="color-presets__list";const ar=document.createElement("div");ar.className="color-presets__add";const oi=document.createElement("input");oi.type="text",oi.placeholder="Name",oi.className="settings-text__input";const xi=document.createElement("input");xi.type="color",xi.value="#2563eb",xi.className="settings-color-input";const Ai=document.createElement("button");Ai.type="button",Ai.className="pf-v5-c-button pf-m-primary",Ai.textContent="Add preset",Ai.addEventListener("click",()=>{const f=oi.value.trim()||"Custom",$=xi.value,H=[...tn,{name:f,value:$}];Oo(H),qo(tn),oi.value=""}),ar.append(oi,xi,Ai),qn.append(Ci,ar),Xe.appendChild(qn),Te.colorPresetList=Ci,Bo=()=>{Ci.innerHTML="",tn.forEach((f,$)=>{const H=document.createElement("div");H.className="color-presets__row";const _e=document.createElement("input");_e.type="text",_e.className="settings-text__input",_e.value=f.name||"",_e.placeholder="Name",_e.addEventListener("input",()=>{const Re=[...tn];Re[$]={...Re[$],name:_e.value},Oo(Re),qo(tn)});const ue=document.createElement("input");ue.type="color",ue.className="settings-color-input",ue.value=f.value,ue.addEventListener("input",()=>{const Re=[...tn];Re[$]={...Re[$],value:ue.value},Oo(Re),qo(tn)});const Pe=document.createElement("button");Pe.type="button",Pe.className="pf-v5-c-button pf-m-plain",Pe.textContent="✕",Pe.title="Remove preset",Pe.addEventListener("click",()=>{const Re=tn.filter((q,ze)=>ze!==$);Oo(Re),qo(tn),Bo()}),H.append(_e,ue,Pe),Ci.appendChild(H)})},Bo();const rr=document.createElement("div");rr.className="settings-text";const sr=document.createElement("div");sr.className="settings-text__label",sr.textContent="Link colors";const lr=document.createElement("div");lr.className="settings-text__hint",lr.textContent="Adjust the colors used when highlighting enables/dependents.";const cr=document.createElement("div");cr.className="settings-color-rows";const Ol=({id:f,label:$,hint:H,value:_e,onChange:ue})=>{const Pe=document.createElement("label");Pe.className="settings-color-row",Pe.setAttribute("for",f);const Re=document.createElement("span");if(Re.className="settings-color-row__label",Re.textContent=$,H){const ze=document.createElement("span");ze.className="settings-color-row__hint",ze.textContent=H,Re.appendChild(ze)}const q=document.createElement("input");if(q.type="color",q.id=f,q.className="settings-color-input",q.value=_e,typeof ue=="function"){const ze=()=>ue(q.value);q.addEventListener("input",ze),q.addEventListener("change",ze)}return Pe.append(Re,q),cr.appendChild(Pe),q};Te.depColorInput=Ol({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:Zi,onChange:f=>{const $=Pa(f);Ra($)}}),Te.revdepColorInput=Ol({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:Xi,onChange:f=>{const $=Va(f);Oa($)}}),rr.append(sr,lr,cr),Xe.appendChild(rr);const dr=document.createElement("div");dr.className="settings-text";const ur=document.createElement("div");ur.className="settings-text__text";const pr=document.createElement("div");pr.className="settings-text__label",pr.textContent="Link thickness";const fr=document.createElement("div");fr.className="settings-text__hint",fr.textContent="Adjust stroke width for enables/dependents lines.",ur.append(pr,fr);const wo=document.createElement("select");wo.id="linkThickness",wo.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:f,label:$})=>{const H=document.createElement("option");H.value=f,H.textContent=$,f===pi&&(H.selected=!0),wo.appendChild(H)}),wo.addEventListener("change",()=>{const f=hi(wo.value);Da(f)});const mr=document.createElement("div");mr.className="settings-text__row",mr.append(ur,wo),dr.appendChild(mr),Xe.appendChild(dr),Te.linkThicknessInput=wo;const eo=({id:f,label:$,hint:H,checked:_e,className:ue="",onChange:Pe})=>{const Re=document.createElement("label");Re.className=["settings-toggle",ue].filter(Boolean).join(" ");const q=document.createElement("input");q.type="checkbox",q.id=f,q.checked=_e;const ze=document.createElement("span");ze.className="settings-toggle__text";const Qt=document.createElement("span");if(Qt.className="settings-toggle__label",Qt.textContent=$,ze.appendChild(Qt),H){const De=document.createElement("span");De.className="settings-toggle__hint",De.textContent=H,ze.appendChild(De)}return Re.appendChild(q),Re.appendChild(ze),typeof Pe=="function"&&q.addEventListener("change",()=>Pe(q.checked)),{row:Re,input:q}},ua=()=>{_.querySelectorAll(".tile").forEach(f=>{const $=f.dataset.id,H=na($);if(!(H!=null&&H.item))return;const _e=xl(H.item.external),ue=Cl(H.item,{externalMeta:_e,seriesIdLookup:Me});Al(f,ue)})},{row:bp,input:wp}=eo({id:"toggleSecondaryLinks",label:"Show indirect links",checked:_n,className:"map-controls__toggle",onChange:f=>Ei(f)});Xe.appendChild(bp),Te.secondaryLinksToggle=wp;const{row:vp,input:yp}=eo({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:xn,className:"map-controls__toggle",onChange:f=>{xn=f,er()}});Xe.appendChild(vp),Te.reusedToggle=yp;const{row:Sp,input:Ep}=eo({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:co,className:"map-controls__toggle",onChange:f=>{const $=jo(f);Js($)}});Xe.appendChild(Sp),Te.autoIdToggle=Ep;const hr=[],{row:kp,input:Ip}=eo({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:No,className:"map-controls__toggle",onChange:f=>{const $=Jo(f);nl($),hr.forEach(H=>{H.disabled=!$}),ua()}});if(Xe.appendChild(kp),Te.obsidianToggle=Ip,typeof(Ze==null?void 0:Ze.isAvailable)=="function"&&Ze.isAvailable()&&typeof(Ze==null?void 0:Ze.getAutoReloadConfig)=="function"){const{enabled:f,intervalMs:$}=Ze.getAutoReloadConfig();let H=null;const{row:_e,input:ue}=eo({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:f,className:"map-controls__toggle",onChange:Ut=>{Ze.setAutoReloadEnabled(Ut),H&&(H.disabled=!Ut)}});Xe.appendChild(_e),Te.autoReloadToggle=ue;const Pe=Ut=>`${(Ut/1e3).toFixed(2)}s`,Re=document.createElement("label");Re.className="settings-slider",Re.setAttribute("for","autoReloadInterval");const q=document.createElement("div");q.className="settings-slider__text";const ze=document.createElement("span");ze.className="settings-slider__label",ze.textContent="Auto-reload interval";const Qt=document.createElement("span");Qt.className="settings-slider__hint",Qt.textContent="Adjust how often to poll for file changes.",q.append(ze,Qt);const De=document.createElement("span");De.className="settings-slider__value",De.textContent=Pe($),H=document.createElement("input"),H.type="range",H.id="autoReloadInterval",H.className="settings-slider__input",H.min=String(gs),H.max=String(bs),H.step="100",H.value=String($),H.disabled=!f,H.setAttribute("aria-label","Set auto-reload polling interval"),H.addEventListener("input",()=>{const Ut=Ze.setAutoReloadInterval(parseInt(H.value,10));De.textContent=Pe(Ut)}),Re.append(q,De,H),Xe.appendChild(Re),Te.autoReloadInput=H,Te.autoReloadValue=De}const gr=document.createElement("div");gr.className="settings-radio";const br=document.createElement("div");br.className="settings-radio__label",br.textContent="Obsidian link format";const wr=document.createElement("div");wr.className="settings-radio__hint",wr.textContent="Use the tile title or id when building Obsidian links.";const vr=document.createElement("div");vr.className="settings-radio__options";const Pl=(f,$)=>{const H=document.createElement("label");H.className="settings-radio__option";const _e=document.createElement("input");_e.type="radio",_e.name="obsidianLinkMode",_e.value=f,_e.checked=di===f,_e.disabled=!No,_e.addEventListener("change",()=>{if(!_e.checked)return;const Pe=Go(f);tl(Pe),ua()});const ue=document.createElement("span");ue.textContent=$,H.append(_e,ue),hr.push(_e),vr.appendChild(H)};Pl(Ta,"Use title"),Pl(zi,"Use id"),gr.append(br,vr,wr),Xe.appendChild(gr),Te.obsidianModeInputs=hr;const pa=document.createElement("label");pa.className="settings-text",pa.setAttribute("for","obsidianVaultInput");const yr=document.createElement("div");yr.className="settings-text__text";const Sr=document.createElement("span");Sr.className="settings-text__label",Sr.textContent="Obsidian vault";const Er=document.createElement("span");Er.className="settings-text__hint",Er.textContent="Optional. Set the vault name to avoid duplicates.",yr.append(Sr,Er);const Yn=document.createElement("input");Yn.type="text",Yn.id="obsidianVaultInput",Yn.className="settings-text__input",Yn.placeholder="Vault name",Yn.value=Mo,Yn.addEventListener("input",()=>{const f=Ko(Yn.value);ol(f),ua()}),pa.append(yr,Yn),Xe.appendChild(pa),Te.obsidianVaultInput=Yn;const kr=document.createElement("p");kr.className="settings-note",kr.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',Xe.appendChild(kr);const Vl=f=>`${(f/1e3).toFixed(1)}s`,fa=document.createElement("label");fa.className="settings-slider",fa.setAttribute("for","seriesNavDoubleClickWait");const Ir=document.createElement("div");Ir.className="settings-slider__text";const _r=document.createElement("span");_r.className="settings-slider__label",_r.textContent="Series double-click wait";const Cr=document.createElement("span");Cr.className="settings-slider__hint",Cr.textContent="Time window to double-click into another map version.",Ir.append(_r,Cr);const Ti=document.createElement("span");Ti.className="settings-slider__value",Ti.textContent=Vl(Fn);const bn=document.createElement("input");bn.type="range",bn.id="seriesNavDoubleClickWait",bn.className="settings-slider__input",bn.min=String(Ls),bn.max=String(Ns),bn.step="50",bn.value=String(Fn),bn.setAttribute("aria-label","Adjust double-click wait for series navigation"),bn.addEventListener("input",()=>{const f=zo(parseInt(bn.value,10));Ti.textContent=Vl(f),el(f)}),fa.append(Ir,Ti,bn),Xe.appendChild(fa),Te.seriesNavInput=bn,Te.seriesNavValue=Ti;const Dl=f=>`${Math.round((f-1)*100)}%`,ma=document.createElement("label");ma.className="settings-slider",ma.setAttribute("for","hoverScaleSlider");const xr=document.createElement("div");xr.className="settings-slider__text";const Ar=document.createElement("span");Ar.className="settings-slider__label",Ar.textContent="Hover zoom";const Tr=document.createElement("span");Tr.className="settings-slider__hint",Tr.textContent="Expand tiles on hover to see more detail.",xr.append(Ar,Tr);const Li=document.createElement("span");Li.className="settings-slider__value",Li.textContent=Dl(xo);const wn=document.createElement("input");wn.type="range",wn.id="hoverScaleSlider",wn.className="settings-slider__input",wn.min=String(It),wn.max=String(jt),wn.step="0.1",wn.value=String(xo),wn.setAttribute("aria-label","Adjust hover zoom"),wn.addEventListener("input",()=>{const f=Po(parseFloat(wn.value));Li.textContent=Dl(f),js(f),K&&Zo()}),ma.append(xr,Li,wn),Xe.appendChild(ma),Te.hoverScaleInput=wn,Te.hoverScaleValue=Li;let Xt=null,to=null;const Lr=f=>{const $=Math.round((1-f)*100);return $===0?"Off":`${$}% dim`},{row:_p,input:Cp}=eo({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Hn,className:"map-controls__toggle",onChange:f=>{const $=Wo(f);Gs($),Xt&&(Xt.disabled=!$),to&&(to.textContent=Lr($?Un:1))}});Xe.appendChild(_p),Te.selectionDimToggle=Cp;const ha=document.createElement("label");ha.className="settings-slider",ha.setAttribute("for","selectionDimmingSlider");const Nr=document.createElement("div");Nr.className="settings-slider__text";const Mr=document.createElement("span");Mr.className="settings-slider__label",Mr.textContent="Dimming strength";const Br=document.createElement("span");Br.className="settings-slider__hint",Br.textContent="Adjust how much unrelated tiles fade when dimming is on.",Nr.append(Mr,Br),to=document.createElement("span"),to.className="settings-slider__value",to.textContent=Lr(Hn?Un:1),Xt=document.createElement("input"),Xt.type="range",Xt.id="selectionDimmingSlider",Xt.className="settings-slider__input",Xt.min=String(Yt),Xt.max=String(Ke),Xt.step="0.05",Xt.value=String(Un),Xt.disabled=!Hn,Xt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Xt.addEventListener("input",()=>{const f=Vo(parseFloat(Xt.value));to.textContent=Lr(f),zs(f)}),ha.append(Nr,to,Xt),Xe.appendChild(ha),Te.selectionDimInput=Xt,Te.selectionDimValue=to;const Ul=f=>f===1?"Default":`${Math.round(f*100)}%`,ga=document.createElement("label");ga.className="settings-slider",ga.setAttribute("for","tileCompactnessSlider");const $r=document.createElement("div");$r.className="settings-slider__text";const Rr=document.createElement("span");Rr.className="settings-slider__label",Rr.textContent="Tile compactness";const Or=document.createElement("span");Or.className="settings-slider__hint",Or.textContent="Adjust padding, gap, and logo size for tiles.",$r.append(Rr,Or);const Ni=document.createElement("span");Ni.className="settings-slider__value",Ni.textContent=Ul(Ao);const vn=document.createElement("input");vn.type="range",vn.id="tileCompactnessSlider",vn.className="settings-slider__input",vn.min=String(cs),vn.max=String(ds),vn.step="0.05",vn.value=String(Ao),vn.setAttribute("aria-label","Adjust tile compactness"),vn.addEventListener("input",()=>{const f=Do(parseFloat(vn.value));Ni.textContent=Ul(f),Ks(f),K&&Zo()}),ga.append($r,Ni,vn),Xe.appendChild(ga),Te.tileCompactnessInput=vn,Te.tileCompactnessValue=Ni;const{row:xp,input:Ap}=eo({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:La!=="nowrap",className:"map-controls__toggle",onChange:f=>{const $=f?"wrap":"nowrap";Fo($),Zs($)}});Xe.appendChild(xp),Te.titleWrapInput=Ap;const Hl=f=>`${Math.round((f-1)*100)}% extra`,ba=document.createElement("label");ba.className="settings-slider",ba.setAttribute("for","titleHoverWidthSlider");const Pr=document.createElement("div");Pr.className="settings-slider__text";const Vr=document.createElement("span");Vr.className="settings-slider__label",Vr.textContent="Title width on hover";const Dr=document.createElement("span");Dr.className="settings-slider__hint",Dr.textContent="Give titles more room horizontally when zoomed.",Pr.append(Vr,Dr);const Mi=document.createElement("span");Mi.className="settings-slider__value",Mi.textContent=Hl(To);const yn=document.createElement("input");yn.type="range",yn.id="titleHoverWidthSlider",yn.className="settings-slider__input",yn.min=String(ye),yn.max=String(nt),yn.step="0.05",yn.value=String(To),yn.setAttribute("aria-label","Adjust title width boost on hover"),yn.addEventListener("input",()=>{const f=Uo(parseFloat(yn.value));Mi.textContent=Hl(f),qs(f)}),ba.append(Pr,Mi,yn),Xe.appendChild(ba),Te.titleWidthInput=yn,Te.titleWidthValue=Mi;const Fl=f=>`${Math.round(f*100)}% of hover zoom`,wa=document.createElement("label");wa.className="settings-slider",wa.setAttribute("for","titleZoomPortionSlider");const Ur=document.createElement("div");Ur.className="settings-slider__text";const Hr=document.createElement("span");Hr.className="settings-slider__label",Hr.textContent="Title zoom influence";const Fr=document.createElement("span");Fr.className="settings-slider__hint",Fr.textContent="How much the title scales relative to tile hover zoom.",Ur.append(Hr,Fr);const Bi=document.createElement("span");Bi.className="settings-slider__value",Bi.textContent=Fl(Lo);const Sn=document.createElement("input");Sn.type="range",Sn.id="titleZoomPortionSlider",Sn.className="settings-slider__input",Sn.min=String(rs),Sn.max=String(ss),Sn.step="0.05",Sn.value=String(Lo),Sn.setAttribute("aria-label","Adjust how much titles scale on hover"),Sn.addEventListener("input",()=>{const f=Ho(parseFloat(Sn.value));Bi.textContent=Fl(f),Ys(f)}),wa.append(Ur,Bi,Sn),Xe.appendChild(wa),Te.titleZoomInput=Sn,Te.titleZoomValue=Bi;const Tp=typeof pt.isEnabled=="function"?pt.isEnabled():!1,{row:Lp,input:Np}=eo({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:Tp,className:"apicurio-toggle",onChange:f=>{typeof pt.setEnabled=="function"&&pt.setEnabled(f)}});if(ee=Np,Xe.appendChild(Lp),dn.appendChild(Xe),A)A.hidden=!1,A.classList.remove("pf-v5-c-page__main-section"),dn.appendChild(A);else{const f=document.createElement("p");f.className="muted",f.textContent="Source editor unavailable.",dn.appendChild(f)}T.appendChild(dn),pt.mount(L);let Wl=0;se.m.categories.forEach(f=>{const $=document.createElement("section");$.className="category",$.dataset.cat=f.id;const H=ke?Ru(f,Me):null,_e=(f.items||[]).some(q=>mi(q.stage)),ue=document.createElement("div");ue.className="cat-head",ue.dataset.cat=f.id,ue.tabIndex=0,ke&&Number.isInteger(H)?(ue.dataset.seriesVersionIndex=String(H),ue.title="Open this category's map in the series",ue.classList.add("cat-head--series-link")):ue.title="Select category",ue.innerHTML=`<div class="cat-title">${yi(f.title||f.id)}</div>
                          ${_e?`<span class="cat-stage-indicator" title="Contains staged items">Stage</span>
                                 <button type="button" class="cat-stage-clear" title="Clear all stages in this category" aria-label="Clear all stages">×</button>`:""}
                          <div class="muted cat-count">${(f.items||[]).length} items</div>`,ue.addEventListener("click",()=>{var Ut;const q=ue.dataset.seriesVersionIndex!=null?parseInt(ue.dataset.seriesVersionIndex,10):null,ze=u[v],Qt=ze?zn(ze):-1;ke&&((Ut=ze==null?void 0:ze.apicurioVersions)==null?void 0:Ut.length)>1&&Number.isInteger(q)&&q!==Qt&&sa(v,q)||Gn(f.id)}),ue.addEventListener("keydown",q=>{(q.key==="Enter"||q.key===" ")&&(q.preventDefault(),ue.click())});const Pe=ue.querySelector(".cat-stage-clear");Pe&&Pe.addEventListener("click",q=>{q.preventDefault(),q.stopPropagation(),Yd(f.id)&&fn("Cleared stages for this category.",1400)}),ue.addEventListener("focus",()=>Gn(f.id,{scrollIntoView:!1})),$.appendChild(ue);const Re=document.createElement("div");if(Re.className="grid"+(Et?" is-centered":""),$.appendChild(Re),(f.items||[]).forEach(q=>{Wl+=1;const ze=xl(q.external),Qt=Cl(q,{externalMeta:ze,seriesIdLookup:Me}),De=document.createElement("div");if(De.className=ze.isExternal?"tile external":"tile",De.tabIndex=0,De.dataset.id=q.id,De.dataset.globalIndex=String(Wl),ze.url&&(De.dataset.externalUrl=ze.url),!ke){let Mn=null;if(Me.has(q.id)&&(Mn=Me.get(q.id)),Number.isInteger(Mn)){De.dataset.seriesVersionIndex=String(Mn),De.classList.add("tile--series-link");const Mp=Mn===ht?"Current map in this series":`Open version ${Mn+1} in this series`;ot(De,Mp)}}Qt&&(De.dataset.obsidianUrl=Qt);const Ut=mi(q.stage);if(Ut&&(De.dataset.stage=String(Ut),Et&&(De.style.gridColumn=String(Ut))),!ke){const Mn=za(q.id);Mn!==-1&&Mn!==v&&(De.classList.add("tile--series-link"),De.dataset.navTargetIndex=String(Mn))}const En=document.createElement("img");En.className="logo",q.logo?(En.src=q.logo,En.alt=q.name||q.id):(En.alt="",En.style.opacity=1,En.src=Bu(q.name||q.id,q.color));const vo=document.createElement("div");vo.className="name",vo.textContent=q.name||q.id;const yo=document.createElement("div");yo.className="tile-id",yo.textContent=q.id||"";let $i=null;Ut&&($i=document.createElement("div"),$i.className="tile-stage",$i.textContent=String(Ut));const Wr=document.createElement("div");Wr.className="badge",Wr.textContent="reused";let no=null;ke||(no=document.createElement("button"),no.type="button",no.className="tile-delete",no.setAttribute("aria-label",`Delete ${q.name||q.id}`),no.textContent="×",no.addEventListener("click",Mn=>{Mn.stopPropagation(),dp(q.id)})),ze.url&&De.appendChild(zu(ze.url)),Al(De,Qt),no&&De.appendChild(no),De.appendChild(En),De.appendChild(vo),De.appendChild(yo),$i&&De.appendChild($i),De.appendChild(Wr),Re.appendChild(De),ft.set(q.id,{el:De,catId:f.id,rect:null})}),Mt.appendChild($),In.set(f.id,{el:$,headEl:ue}),!ke){const q=document.createElement("button");q.type="button",q.className="tile-add",q.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',q.hidden=Et,q.tabIndex=Et?-1:0,q.setAttribute("aria-hidden",Et?"true":"false"),q.addEventListener("click",()=>Xu(f.id)),Re.appendChild(q)}});let On=null;ke||(On=document.createElement("button"),On.type="button",On.className="category-add",On.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',On.addEventListener("click",()=>Ll()),Mt.appendChild(On)),On&&Et&&(On.hidden=!0,On.tabIndex=-1,On.setAttribute("aria-hidden","true")),Rs(),er(),Du(),la(),Ln(),Xo(),qu()}function Du(){_.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var T;if(typeof n.button=="number"&&n.button!==0)return;ho();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,c=u[v],p=c?zn(c):-1,g=((T=c==null?void 0:c.apicurioVersions)==null?void 0:T.length)>1&&Number.isInteger(i)&&i!==p,h=Number.isInteger(s)&&s!==v&&s>=0&&s<u.length,S=en&&en.id===o&&en.targetVersionIndex===i,R=An&&An.id===o&&An.targetIndex===s;if(en&&!S&&Yo(),An&&!R&&qa(),g)if(S){if(Yo(),sa(v,i))return}else hu(o,i,c);else if(h){if(R){qa(),Ot(s);return}gu(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&fn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),K===o&&!(g&&S)&&!(h&&R)){Qo();return}Tt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):za(o);i!==-1&&i!==v&&Ot(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{K&&Zo()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),dl||(dl=!0,window.addEventListener("resize",Zo),window.addEventListener("scroll",Zo,{passive:!0}),window.addEventListener("resize",Tl),document.addEventListener("click",e=>{var a,s,c;if(!K&&!tt||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),o=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),i=(c=t==null?void 0:t.closest)==null?void 0:c.call(t,".tile-context-menu");n||o||i||Qo()})),document.getElementById("clear").onclick=()=>Qo()}function la(){ft.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function El(e,{includeSecondary:t=_n}={}){if(!e||!se)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(se.fwd.get(e)||[]),o=new Set(se.rev.get(e)||[]),i=new Set,a=new Set,s=[],c=new Set,p=(g,h,S,R)=>{if(!g||!h)return;const T=`${g}->${h}:${S}:${R}`;c.has(T)||(c.add(T),s.push({from:g,to:h,type:S,depth:R}))};return n.forEach(g=>p(e,g,"dep",1)),o.forEach(g=>p(e,g,"revdep",1)),t&&new Set([...n,...o]).forEach(h=>{(se.fwd.get(h)||new Set).forEach(T=>{const L=T===e;L||i.add(T),L||p(h,T,"dep",2)}),(se.rev.get(h)||new Set).forEach(T=>{const L=T===e;L||a.add(T),L||p(h,T,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function ca(e,t){const n=ft.get(e);n&&n.el.classList.add(t)}function Tt(e){var c,p,g;if(!e)return;tt=null,K=e,mt=null,st=El(e),on(),da(),Xo();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=st;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=ft.get(e);a&&a.el.classList.add("selected"),t.forEach(h=>ca(h,"dep")),n.forEach(h=>ca(h,"revdep")),o.forEach(h=>{!t.has(h)&&h!==e&&ca(h,"dep-indirect")}),i.forEach(h=>{!n.has(h)&&!t.has(h)&&h!==e&&ca(h,"revdep-indirect")}),Ln();const s=(g=(p=(c=ft.get(e))==null?void 0:c.el)==null?void 0:p.dataset)==null?void 0:g.externalUrl;s&&fn("This item has link to",so,s),Ua()}function Gn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,c;if(!((s=se==null?void 0:se.m)!=null&&s.categories)||!e)return!1;const i=(se.m.categories||[]).find(p=>p.id===e);if(!i)return!1;ho(),Qa(),n||(mt=null),tt=i.id,on(),Xo();const a=In.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(c=a.headEl)==null||c.focus({preventScroll:!0})),!0}function Xo(){if(In.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!tt)return;const e=In.get(tt);if(!(e!=null&&e.el)){tt=null,mt=null,on();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function vi(){if(tt)return tt;const e=K?ft.get(K):null;return e!=null&&e.catId?e.catId:null}function Uu(e){var a,s,c,p;if(!((s=(a=se==null?void 0:se.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=se.m.categories,n=vi();let o=t.findIndex(g=>g.id===n);if(o===-1){const g=((c=t.find(h=>(h.items||[]).length))==null?void 0:c.id)||((p=t[0])==null?void 0:p.id);return g?Gn(g):!1}const i=o+e;return i<0||i>=t.length?!1:Gn(t[i].id)}function Qa(){K=null,st=null,da(),Ln(),Ua({itemId:null})}function Hu(){tt=null,mt=null,Xo()}function Qo(){Qa(),Hu(),mt=null,on()}function da(){_.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function er(){se!=null&&se.reusedLocal&&se.reusedLocal.forEach(e=>{const t=ft.get(e);if(!t)return;t.el.classList.toggle("reused",xn);const n=t.el.querySelector(".badge");n&&(n.style.display=xn?"inline-block":"none")})}function Ln(){for(;j.firstChild;)j.removeChild(j.firstChild);if(!K||j.hidden)return;st=El(K);const e=st,{primary:t,secondary:n}=Qc();e.edges.forEach(o=>{var O,ne;const i=(O=ft.get(o.from))==null?void 0:O.rect,a=(ne=ft.get(o.to))==null?void 0:ne.rect;if(!i||!a)return;const s=kl(i),c=kl(a),p=_l(Il(i,c)||s,i,xs)||s,g=_l(Il(a,s)||c,a,xs)||c,h=document.createElementNS("http://www.w3.org/2000/svg","path"),S=(p.x+g.x)/2,R=p.y,T=(p.x+g.x)/2,L=g.y;h.setAttribute("d",`M ${p.x},${p.y} C ${S},${R} ${T},${L} ${g.x},${g.y}`),h.setAttribute("fill","none"),h.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),h.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),h.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&h.setAttribute("stroke-dasharray","4 3"),h.setAttribute("vector-effect","non-scaling-stroke"),j.appendChild(h)})}function kl(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Il(e,t){if(!e||!t)return null;const n=e.left+e.width/2,o=e.top+e.height/2,i=t.x-n,a=t.y-o;if(i===0&&a===0)return{x:n,y:o};const s=e.width/2,c=e.height/2,p=[];i!==0&&p.push((i>0?s:-s)/i),a!==0&&p.push((a>0?c:-c)/a);const g=Math.min(...p.filter(S=>S>0)),h=Number.isFinite(g)?g:0;return{x:n+i*h,y:o+a*h}}function _l(e,t,n=0){if(!e||!t||n<=0)return e;const o=t.left+t.width/2,i=t.top+t.height/2,a=o-e.x,s=i-e.y,c=Math.hypot(a,s);if(!c)return e;const p=Math.min(n,c/2)/c;return{x:e.x+a*p,y:e.y+s*p}}function yi(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Fu(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),Mo&&o.set("vault",Mo),`obsidian://advanced-uri?${o.toString()}`}function Wu(e){return e?di===zi?e.id??e.name??"":e.name??e.id??"":""}function Cl(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!No||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=Wu(e);return Fu(o)}function xl(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function ju(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),ri(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function zu(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),ri(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Al(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(ju(t))}function Tl(){fe||(fe=requestAnimationFrame(()=>{fe=null,be=be.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),be.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function Gu(e,t){!e||!t||(be.push({labelEl:e,textEl:t}),Tl())}function Ju(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${yi(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${yi(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function Si(e,t,{offset:n=8}={}){!te||!e||!t||(te.innerHTML=t,te.hidden=!1,te.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=te.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let c=o.left+o.width/2-i.width/2+a,p=o.top-i.height-n+s;c<a+n&&(c=a+n);const g=a+window.innerWidth-i.width-n;c>g&&(c=g),p<s+n&&(p=o.bottom+n+s),te.style.left=`${c}px`,te.style.top=`${p}px`,te.classList.add("is-visible")}))}function Jn(){d&&(clearTimeout(d),d=null),te&&(te.classList.remove("is-visible"),te.setAttribute("aria-hidden","true"),te.hidden=!0)}function Ku(e,t){if(!e)return;const n=qe((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=Ju(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{z=e,Si(e,`<div class="version-nav__tooltip-title">${yi(n)}</div>`,{offset:10})},c=()=>{a(),i=setTimeout(()=>{z===e&&Si(e,o,{offset:10})},We)},p=()=>{s(),c()},g=()=>{z!==e&&s(),c()},h=()=>{a(),z===e&&(z=null,Jn())};e.addEventListener("mouseenter",p),e.addEventListener("focus",p),e.addEventListener("pointermove",g),e.addEventListener("mouseleave",h),e.addEventListener("blur",h),e.addEventListener("click",h)}function qu(){N&&(N=!1,!(!y||!B)&&(Jn(),Si(y,B,{offset:12}),d=setTimeout(()=>{Jn(),Yu()},1e3)))}function Yu(){y&&(k&&(clearTimeout(k),k=null),y.classList.add("blockscape-tab--twinkle"),k=setTimeout(()=>{y.classList.remove("blockscape-tab--twinkle"),k=null},1400))}window.addEventListener("scroll",Jn,!0),window.addEventListener("resize",Jn),Be&&Be.addEventListener("click",()=>{vu()}),me&&me.addEventListener("click",()=>{yu()}),et&&et.addEventListener("click",()=>{try{fu(),lu()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),ut&&ut.addEventListener("click",Ya),P&&P.addEventListener("click",Ya),x&&x.addEventListener("click",aa),X&&X.addEventListener("click",aa),_&&_.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");Cn||!t||!_.contains(t)||nu(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||ou(e)}),Ve&&Ve.addEventListener("click",()=>{ll("button")}),W&&W.addEventListener("click",()=>{if(v<0){alert("Load or select a model before creating a version.");return}try{const e=sl({versionLabel:"map edit"});Ot(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),Ue&&Ue.addEventListener("click",async()=>{var a;if(v<0||!u[v]){alert("Select or load a model before sharing.");return}const e={title:qe(u[v],"Shared Model"),data:u[v].data};let t;try{t=Wc(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),J&&J.addEventListener("click",()=>{const e=(m.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};K&&(n.selectedItemId=K),localStorage.setItem(at,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";K&&(t=`editor.html?selected=${encodeURIComponent(K)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==at||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||wl("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===At&&wl("message")})),document.addEventListener("keydown",e=>{var o,i,a,s,c,p,g,h,S,R;if(wu()){e.key==="Escape"&&(e.preventDefault(),Ya());return}if(!(Y!=null&&Y.hidden)&&e.key==="Escape"){e.preventDefault(),aa();return}if((o=mo==null?void 0:mo.isOpen)==null?void 0:o.call(mo))return;const n=Cn;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const T=u[v],L=((i=T==null?void 0:T.apicurioVersions)==null?void 0:i.length)>1;ll("shortcut",L);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!go())return;if(rp()){e.preventDefault();return}}if(e.key==="Escape"){let T=!1;Z&&!Z.hidden&&(ho(),T=!0),(K||tt)&&(Qo(),T=!0),T&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!go())return;const T=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if(Et&&e.shiftKey&&K&&!e.ctrlKey&&!e.metaKey&&Zd(K,T)){e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&!e.shiftKey){Xa(T)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(tt&&!e.shiftKey){e.preventDefault();return}e.shiftKey?ep(T)&&e.preventDefault():tp(T)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!go())return;const T=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){ap(T)&&e.preventDefault();return}if(e.altKey)return;if(tt&&!K&&!e.shiftKey){if(op(T)){e.preventDefault();return}if(Uu(T)){e.preventDefault();return}}e.shiftKey?ip(T)&&e.preventDefault():np(T)&&e.preventDefault()}if(e.key==="Delete"){if(n||!go()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const T=tt?cp():!1,L=T?!0:Nl();(T||L)&&e.preventDefault()}if(e.key==="F2"){if(n||!go())return;const T=tt&&!K&&tt||!K&&((p=(c=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:c.dataset)==null?void 0:p.cat)||null;if(T&&!K&&Qu(T)){e.preventDefault();return}const L=K||((R=(S=(h=(g=e.target)==null?void 0:g.closest)==null?void 0:h.call(g,".tile"))==null?void 0:S.dataset)==null?void 0:R.id);L&&mo.open(L)&&e.preventDefault()}if(e.key==="Insert"){if(n||!go()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Ll()&&e.preventDefault()}}),window.addEventListener("resize",()=>{iu()}),window.addEventListener("scroll",()=>au(),!0);function Zu(e,t,n){if(v<0)return;const i=u[v].data.categories||[],a=i.find(h=>(h.items||[]).some(S=>S.id===e)),s=i.find(h=>h.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const c=a.items.findIndex(h=>h.id===e);if(c===-1)return;const[p]=a.items.splice(c,1);let g=s.items.length;if(t){const h=s.items.findIndex(S=>S.id===t);h!==-1&&(g=h)}s.items.splice(g,0,p),Pt(),Lt()}function Xu(e){if(v<0||!e)return;const t=u[v].data,o=(t.categories||[]).find(p=>p.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:Xd(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),Pt(),Lt(),ho(),Tt(s.id);const c=ft.get(s.id);c!=null&&c.el&&c.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Ll(){if(v<0)return!1;const e=u[v].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=Qd(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),tt=n,K=null,st=null,mt=null,Pt(),Lt(),Gn(n),console.log("[Blockscape] added category",n),!0}function Qu(e=vi()){if(v<0||!e)return!1;const t=tu.open(e);return t&&(K=null,st=null,on()),t}function ep(e){if(!K||v<0||!e)return!1;const n=u[v].data.categories||[],o=ft.get(K);let i=null;if(o!=null&&o.catId&&(i=n.find(p=>p.id===o.catId)),i||(i=n.find(p=>(p.items||[]).some(g=>g.id===K))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(p=>p.id===K);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[c]=i.items.splice(a,1);return i.items.splice(s,0,c),Pt(),Lt(),wi(),Tt(K),!0}function tp(e){if(!se||!se.m||!e)return!1;const t=se.m.categories||[];if(!t.length)return!1;const n=()=>{const p=t.find(g=>(g.items||[]).length);return p?{category:p,item:p.items[0]}:null};if(!K){const p=n();return p?(Tt(p.item.id),!0):!1}const o=ft.get(K);let i=null;if(o!=null&&o.catId&&(i=t.find(p=>p.id===o.catId)),i||(i=t.find(p=>(p.items||[]).some(g=>g.id===K))),!i){const p=n();return p?(Tt(p.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(p=>p.id===K);if(s===-1)return!1;const c=s+e;return c<0||c>=a.length?!1:(Tt(a[c].id),!0)}function np(e){if(!se||!se.m||!e)return!1;const t=se.m.categories||[];if(!t.length)return!1;const n=vi();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(K){const c=(t[o].items||[]).findIndex(p=>p.id===K);mt={catId:a.id,position:c===-1?0:c}}else mt=null;return Gn(a.id,{preserveEntryHint:!0})}function op(e){var a;if(!tt||!((a=se==null?void 0:se.m)!=null&&a.categories)||!e)return!1;const n=(se.m.categories||[]).find(s=>s.id===tt);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(mt==null?void 0:mt.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,mt.position||0))),mt=null,Tt(o[i].id),!0}function ip(e){if(!K||v<0||!e)return!1;const n=u[v].data.categories||[];if(!n.length)return!1;const o=ft.get(K);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(S=>S.id===o.catId)),i===-1&&(i=n.findIndex(S=>(S.items||[]).some(R=>R.id===K))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],c=n[a];if(!c)return!1;s.items=s.items||[],c.items=c.items||[];const p=s.items.findIndex(S=>S.id===K);if(p===-1)return!1;const g=Math.min(c.items.length,Math.max(0,p)),h=g<c.items.length?c.items[g].id:null;return Zu(K,h,c.id),wi(),Tt(K),!0}function ap(e){if(v<0||!e)return!1;const n=u[v].data.categories||[];if(!n.length)return!1;const o=vi();if(!o)return!1;const i=n.findIndex(c=>c.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),tt=s.id,Qa(),mt=null,on(),Pt(),Lt(),Xo(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function rp(){if(v<0)return!1;const e=u[v],t=kt(e)||(e?e.id:null),n=[];if($t&&t===$t.modelId&&n.push({...$t,type:"item"}),hn&&t===hn.modelId&&n.push({...hn,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(lp(o))return!0}else if(o.type==="item"&&sp(o))return!0;return!1}function sp(e){const t=u[v],n=kt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(c=>c.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),$t=null,ho(),K=null,st=null,on(),Pt(),Lt(),wi(),Tt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function lp(e){const t=u[v],n=kt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),hn=null,K=null,st=null,tt=e.category.id,mt=null,on(),Pt(),Lt(),Xo(),Gn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function Nl(){if(!K||v<0)return!1;const t=u[v].data.categories||[];if(!t.length)return!1;const n=ft.get(K);let o=null;if(n!=null&&n.catId&&(o=t.find(g=>g.id===n.catId)),o||(o=t.find(g=>(g.items||[]).some(h=>h.id===K))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(g=>g.id===K);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=u[v];$t={item:a,categoryId:o.id,index:i,modelId:kt(s)||(s?s.id:null),ts:Date.now()};const p=(()=>{var h;if(o.items.length){const S=Math.min(i,o.items.length-1);return((h=o.items[S])==null?void 0:h.id)||null}const g=t.findIndex(S=>S.id===o.id);if(g===-1)return null;for(let S=g+1;S<t.length;S++){const R=t[S].items||[];if(R.length)return R[0].id}for(let S=g-1;S>=0;S--){const R=t[S].items||[];if(R.length)return R[0].id}return null})();return ho(),K=null,st=null,mt=null,on(),Pt(),Lt(),wi(),p?Tt(p):Qo(),console.log("[Blockscape] removed item",a.id),!0}function cp(){var c,p;const e=vi();if(!e||v<0)return!1;const n=u[v].data.categories||[];if(!n.length)return!1;const o=n.findIndex(g=>g.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=u[v];hn={category:i,index:o,modelId:kt(a)||(a?a.id:null),ts:Date.now()},tt=null,K=null,st=null,mt=null,on(),Pt(),Lt();const s=((c=n[o])==null?void 0:c.id)||((p=n[o-1])==null?void 0:p.id)||null;return s?Gn(s):Qo(),console.log("[Blockscape] removed category",i.id),!0}function dp(e){if(!e)return!1;const t=K;K=e;const n=Nl();return n||(K=t,on()),n}Q&&Q.addEventListener("click",async()=>{const e=m.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await Ws(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),M&&M.addEventListener("click",async()=>{const e=cu();if(!e){alert("No series available to copy. Create another version first.");return}await Ws(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),pe&&pe.addEventListener("click",async()=>{try{const e=await fd();if(!e){alert("Clipboard is empty.");return}m.value=e,m.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await bi(),t=jn(m.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=Rn(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),v===-1&&n!=null?Ot(n):Wn(),e&&await Ml(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(v<0){alert("No active model selected.");return}try{const t=JSON.parse(m.value);if($n(t,{titleHint:qe(u[v]),idHint:kt(u[v])||qe(u[v])}),u[v].data=t,u[v].title=t.title||u[v].title,u[v].isSeries||((e=u[v].apicurioVersions)==null?void 0:e.length)>1){const n=u[v].title||qe(u[v]);Jt(u[v],{seriesName:n,fallbackTitle:n})}Ga(),console.log("[Blockscape] replaced active model:",qe(u[v])),Lt(),pt.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=jn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((c,p)=>{var O;const g=(((O=c.data)==null?void 0:O.title)??"").toString().trim(),h=s.length>1?`${o.name} #${p+1}`:o.name,S=`${a} series`,R=c.isSeries?S:null;let T={...c};if(c.isSeries){const ne=R||g||c.title||h||"unknown";T.title=ne;const Me=kn(ne||"unknown");fo(T,Me),Jt(T,{seriesName:ne,fallbackTitle:"unknown"}),T.apicurioArtifactName=T.apicurioArtifactName||ne}else T.title=g||h;const L=Rn({...T,apicurioArtifactName:T.apicurioArtifactName||R||T.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=L)})}v===-1&&n!=null?Ot(n):Wn()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",up);async function up(e){var a;if(!go())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Au(t))return;let n=[];try{const s=await bi();n=jn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,c)=>{const p=Rn(s,{versionLabel:n.length>1?`paste #${c+1}`:"paste"});o==null&&(o=p),i.push(p)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&Ot(o),await bi()&&await Ml(i,{origin:"clipboard"})}async function Ml(e,{origin:t="clipboard"}={}){if(!await bi()||typeof(Ze==null?void 0:Ze.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter(R=>{const T=u[R];return T&&!T.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=u[o[0]],s=wd(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const c=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(c==null)return;const p=po(c);if(!p){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const g=await gd(),h=[];for(let R=0;R<o.length;R++){const T=o.length===1?p:hd(p,R+1),L=bd(T,g);if(!L){alert("Could not find a unique filename to save.");return}g.add(L),h.push(L)}let S=null;for(let R=0;R<o.length;R++){const T=o[R],L=h[R],O=u[T];if(!O)continue;o.length===1&&vd(O,L);const ne=await Ze.saveModelByIndex(T,L,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(ne!=null&&ne.ok)){alert(`Local auto-save failed: ${(ne==null?void 0:ne.error)||"unknown error"}`);return}S==null&&(S=L)}S&&(Qi(S),id(S,{origin:t})),await Ze.refresh(),Wn(),fn(`Saved ${o.length} ${i}.`,2500)}G.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&Ot(n)}),document.getElementById("removeModel").onclick=()=>{if(v<0)return;const e=qe(u[v]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",qe(u[v])),u.splice(v,1),!u.length){v=-1,se=null,_.innerHTML="",j.innerHTML="",m.value="",Wn(),Ga();return}const n=Math.min(v,u.length-1);Ot(n)},Ee&&(Ee.addEventListener("input",e=>{fl(e.target.value||"")}),Ee.addEventListener("focus",()=>{Ee.value&&Ee.value.trim()&&pl(Ee.value)})),de&&de.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;ku({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!de||de.hidden)return;const t=e.target;de.contains(t)||Ee&&(t===Ee||Ee.contains(t))||(de.hidden=!0)}),document.addEventListener("click",e=>{var o,i,a;const t=(i=(o=e.target)==null?void 0:o.closest)==null?void 0:i.call(o,"a[href]");if(!t||(a=t.classList)!=null&&a.contains("blockscape-gist-link")||t.hasAttribute("download"))return;const n=t.getAttribute("href");mc(n)&&(e.preventDefault(),e.stopPropagation(),ri(hc(n)))}),C&&le&&F&&C.addEventListener("submit",async e=>{e.preventDefault();const t=le.value.trim();if(!t){alert("Please enter a URL"),le.focus();return}const n=await tr(t);if(typeof n=="number"){Ot(n),le.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!le||!t)return;let n=null;le.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=le.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function Lt(){if(!(v<0))try{ra(u[v]),se=Mu(u[v].data),wi()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function pp(){const e=["Kubernetes.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>ji?ji.endsWith("/")?`${ji}${n}`:`${ji}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=jn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(c=>{let p={...c};if(c.isSeries){const g=`${a} series`;p={...c,title:g,apicurioArtifactName:g};const h=kn(g||"unknown");fo(p,h),Jt(p,{seriesName:g,fallbackTitle:"unknown"})}Rn(p,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}Wn()}async function Bl(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function fp(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>mp(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");Rl(i)&&$l(o,i)})}function mp(e){var c,p;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(p=(c=e.parentNode)==null?void 0:c.closest)!=null&&p.call(c,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:g,index:h})=>{h>s&&a.appendChild(document.createTextNode(t.slice(s,h))),a.appendChild(hp(g)),s=h+g.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function hp(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Rl(e)&&$l(t,e),t}function $l(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>gp(n,t,e)))}async function gp(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await tr(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Rl(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function tr(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Bl(e),o=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=jn(t,o)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let a=null;return i.forEach((s,c)=>{var T;const p=(((T=s.data)==null?void 0:T.title)??"").toString().trim(),g=i.length>1?`${o} #${c+1}`:o,h=s.isSeries?`${o} series`:null;let S={...s};if(s.isSeries){const L=h||p||S.title||g;S={...s,title:L,apicurioArtifactName:L||s.apicurioArtifactName};const O=kn(L||"unknown");fo(S,O),Jt(S,{seriesName:L||h||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:O,url:e,baseName:o,seriesTitle:L})}const R=Rn({...S,title:p||S.title||g,apicurioArtifactName:S.apicurioArtifactName||h||s.apicurioArtifactName},{versionLabel:o});a==null&&(a=R)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,o),v===-1&&a!=null?Ot(a):Wn(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=jn(n,"Blockscape");if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(T=>{const L=Rn(T,{versionLabel:"seed"});i==null&&(i=L)}),await Gc(),!await Ms&&l.autoLoadFromDir&&await pp();const s=await Lu(),c=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,p=await Nu(),g=bl(),h=g==null?void 0:g.index,S=Tu(),R=typeof c=="number"?c:typeof p=="number"?p:typeof S=="number"?S:typeof h=="number"?h:i??0;Ot(R),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===R&&requestAnimationFrame(()=>{var L;if(v!==s.modelIndex)return;const T=(L=ft.get(s.itemId))==null?void 0:L.el;T&&(Tt(s.itemId),T.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),T.focus({preventScroll:!0}))})})()}const Sc=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function Ec(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function kc(r){return Sc(Ec())}const Ic=`${kc()}documentation/`;function _c(r){let l;return{c(){l=D("div"),l.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Watch the <a href="https://youtube.com/playlist?list=PLZIp4-s83kaPj5m9VcGXTBhjaquc9fT15&amp;si=aaeXo5ga0D7Vb5LN">videos</a></li> <li>Open the <a href="${Ic}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,w(l,"id","shortcutHelp"),w(l,"class","shortcut-help"),l.hidden=!0,w(l,"aria-hidden","true"),w(l,"role","dialog"),w(l,"aria-modal","true"),w(l,"aria-labelledby","shortcutHelpTitle")},m(m,A){Bt(m,l,A)},p:Ht,i:Ht,o:Ht,d(m){m&&_t(l)}}}class Cc extends Fi{constructor(l){super(),Hi(this,l,null,_c,Ri,{})}}const xc=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
        * optional \`stage\`: integer 1–4 for Wardley maps only (1=genesis, 2=custom, 3=product, 4=commodity/service). Include only when the user explicitly asks for a Wardley model/series.
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping. Only include the \`stage\` field when explicitly asked for a Wardley map/series.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function ns(r){let l,m,A,_,j,te,G,Z;return{c(){l=D("div"),m=D("div"),A=D("a"),_=Oi("Open Blockscape GPT"),j=ae(),te=D("div"),te.textContent="Paste the copied prompt into that chat.",G=ae(),Z=D("div"),Z.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',w(A,"href",Tc),w(A,"target","_blank"),w(A,"rel","noreferrer"),w(te,"class","new-panel__hint"),w(m,"class","new-panel__link"),w(Z,"class","new-panel__link new-panel__link--disabled"),w(l,"class","new-panel__links")},m(C,le){Bt(C,l,le),E(l,m),E(m,A),E(A,_),E(m,j),E(m,te),E(l,G),E(l,Z)},p:Ht,d(C){C&&_t(l)}}}function os(r){let l,m,A,_,j,te;return{c(){l=D("div"),m=D("div"),m.textContent="Generated prompt",A=ae(),_=D("textarea"),w(m,"class","new-panel__prompt-label"),w(_,"class","pf-v5-c-form-control new-panel__textarea"),w(_,"rows","4"),_.readOnly=!0,w(l,"class","new-panel__prompt")},m(G,Z){Bt(G,l,Z),E(l,m),E(l,A),E(l,_),ao(_,r[4]),j||(te=Bn(_,"input",r[12]),j=!0)},p(G,Z){Z&16&&ao(_,G[4])},d(G){G&&_t(l),j=!1,te()}}}function Ac(r){let l,m,A,_,j,te,G,Z,C,le,F,re,Ce,it,Ge,Ve,Ue,W,J,Q,M,pe,Be,me,et,we,ce,ut,P,Y,x,X,Ee,de,ge,ve,b,Le,Ye,wt,lt,dt,xt,vt,xe,at,At,Fe=r[2]==="gpt"&&ns(),rt=r[4]&&r[5]&&os(r);return xe=ql(r[10][0]),{c(){l=D("div"),m=D("div"),A=ae(),_=D("div"),j=D("div"),j.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',te=ae(),G=D("form"),Z=D("div"),C=D("label"),C.textContent="Domain",le=ae(),F=D("p"),F.textContent="Describe what you want to create a map for.",re=ae(),Ce=D("textarea"),it=ae(),Ge=D("div"),Ve=D("label"),Ue=D("input"),W=ae(),J=D("span"),J.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,Q=ae(),M=D("fieldset"),pe=D("legend"),pe.textContent="Target",Be=ae(),me=D("p"),me.textContent="Choose where you plan to use the prompt.",et=ae(),we=D("label"),ce=D("input"),ut=ae(),P=D("div"),P.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',Y=ae(),x=D("label"),X=D("input"),Ee=ae(),de=D("div"),de.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',ge=ae(),ve=D("div"),b=D("button"),b.textContent="Copy prompt",Le=ae(),Ye=D("button"),Ye.textContent="New blank",wt=ae(),lt=D("div"),dt=Oi(r[3]),xt=ae(),Fe&&Fe.c(),vt=ae(),rt&&rt.c(),w(m,"id","newPanelBackdrop"),w(m,"class","shortcut-help__backdrop"),w(j,"class","shortcut-help__header"),w(C,"for","newDomain"),w(F,"class","new-panel__hint"),w(Ce,"id","newDomain"),w(Ce,"class","pf-v5-c-form-control new-panel__textarea"),w(Ce,"rows","4"),Ce.required=!0,w(Ce,"placeholder","Ex: Companies building open-source geospatial tools"),w(Z,"class","new-panel__field"),w(Ue,"id","seriesToggle"),w(Ue,"type","checkbox"),w(Ve,"class","new-panel__toggle"),w(Ve,"for","seriesToggle"),w(Ge,"class","new-panel__field"),w(me,"class","new-panel__hint"),w(ce,"type","radio"),w(ce,"name","target"),ce.__value="gpt",ao(ce,ce.__value),w(we,"class","new-panel__option"),w(X,"type","radio"),w(X,"name","target"),X.__value="plain",ao(X,X.__value),w(x,"class","new-panel__option"),w(M,"class","new-panel__field"),w(b,"class","pf-v5-c-button pf-m-primary"),w(b,"type","submit"),w(Ye,"id","newBlankButton"),w(Ye,"class","pf-v5-c-button pf-m-secondary"),w(Ye,"type","button"),w(Ye,"title","Start from an empty map"),w(lt,"class","new-panel__status"),w(lt,"aria-live","polite"),w(ve,"class","new-panel__actions"),w(G,"class","shortcut-help__list new-panel__form"),w(_,"class","shortcut-help__panel"),w(_,"tabindex","-1"),w(l,"id","newPanel"),w(l,"class","shortcut-help"),l.hidden=!0,w(l,"aria-hidden","true"),w(l,"role","dialog"),w(l,"aria-modal","true"),w(l,"aria-labelledby","newPanelTitle"),xe.p(ce,X)},m(u,v){Bt(u,l,v),E(l,m),E(l,A),E(l,_),E(_,j),E(_,te),E(_,G),E(G,Z),E(Z,C),E(Z,le),E(Z,F),E(Z,re),E(Z,Ce),ao(Ce,r[0]),E(G,it),E(G,Ge),E(Ge,Ve),E(Ve,Ue),Ue.checked=r[1],E(Ve,W),E(Ve,J),E(G,Q),E(G,M),E(M,pe),E(M,Be),E(M,me),E(M,et),E(M,we),E(we,ce),ce.checked=ce.__value===r[2],E(we,ut),E(we,P),E(M,Y),E(M,x),E(x,X),X.checked=X.__value===r[2],E(x,Ee),E(x,de),E(G,ge),E(G,ve),E(ve,b),E(ve,Le),E(ve,Ye),E(ve,wt),E(ve,lt),E(lt,dt),E(G,xt),Fe&&Fe.m(G,null),E(G,vt),rt&&rt.m(G,null),at||(At=[Bn(Ce,"input",r[7]),Bn(Ue,"change",r[8]),Bn(ce,"change",r[9]),Bn(X,"change",r[11]),Bn(G,"submit",Kl(r[6]))],at=!0)},p(u,[v]){v&1&&ao(Ce,u[0]),v&2&&(Ue.checked=u[1]),v&4&&(ce.checked=ce.__value===u[2]),v&4&&(X.checked=X.__value===u[2]),v&8&&Jr(dt,u[3]),u[2]==="gpt"?Fe?Fe.p(u,v):(Fe=ns(),Fe.c(),Fe.m(G,vt)):Fe&&(Fe.d(1),Fe=null),u[4]&&u[5]?rt?rt.p(u,v):(rt=os(u),rt.c(),rt.m(G,null)):rt&&(rt.d(1),rt=null)},i:Ht,o:Ht,d(u){u&&_t(l),Fe&&Fe.d(),rt&&rt.d(),xe.r(),at=!1,So(At)}}}const Tc="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function Lc(r,l,m){let A="",_=!1,j="gpt",te="",G="",Z=!1;const C=()=>{var W;return typeof navigator<"u"&&!!((W=navigator.clipboard)!=null&&W.writeText)};function le(W){const J=W||"[DOMAIN]",Q=_?"series":"map",pe=xc.replaceAll("[DOMAIN NAME]",J).replaceAll("[DOMAIN]",J).replaceAll("[map|series]",Q).split(`
`),Be=`Generate a **blockscape ${Q}** for the domain of ${J}.`,me=pe.findIndex(we=>we.toLowerCase().includes("generate a **blockscape value")||we.toLowerCase().includes("generate a blockscape [map|series]")||we.toLowerCase().startsWith("generate a blockscape"));me>=0?pe[me]=Be:pe.unshift(Be);const et=_?`

User requested a series (return an array of models).`:"";return`${pe.join(`
`).trim()}${et}`}async function F(W){W.preventDefault();const J=A.trim();if(m(3,te=""),m(5,Z=j!=="gpt"),!J){m(3,te="Add a domain to generate a prompt."),m(4,G="");return}if(j==="gpt"?m(4,G=`${_?"Create a series":"Create a map"} for ${J}`):(m(4,G=le(J)),m(5,Z=!0)),!C()){m(3,te="Clipboard access is unavailable. Copy the prompt below."),m(5,Z=!0);return}try{await navigator.clipboard.writeText(G),m(3,te=j==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),j==="gpt"&&m(5,Z=!1)}catch(M){console.warn("[Blockscape] clipboard write failed",M),m(3,te="Copy failed. Use the prompt below."),m(5,Z=!0)}}const re=[[]];function Ce(){A=this.value,m(0,A)}function it(){_=this.checked,m(1,_)}function Ge(){j=this.__value,m(2,j)}function Ve(){j=this.__value,m(2,j)}function Ue(){G=this.value,m(4,G)}return[A,_,j,te,G,Z,F,Ce,it,Ge,re,Ve,Ue]}class Nc extends Fi{constructor(l){super(),Hi(this,l,Lc,Ac,Ri,{})}}const{document:is}=Jl;function Mc(r){let l,m,A,_,j,te,G,Z,C,le,F,re,Ce,it,Ge,Ve,Ue,W,J,Q,M,pe,Be,me,et,we,ce,ut,P,Y,x,X,Ee,de,ge,ve,b,Le,Ye,wt,lt,dt,xt,vt,xe,at,At,Fe,rt,u,v,pt,se,ft,In,K,tt,st,mt,_n,Cn,xn,Kt,$t,hn,rn,Dn,so,en,Ft,An,Wt,sn,qt,Tn,d,y,B,N,k,V,ee,z,be,fe,Ne=`<script id="seed" type="application/json">${r[5]}<\/script>`,We,ct,Ae,It,jt,gt,Oe,Je,Yt,Ke,Ct,yt,bt,Rt,pn;return Ke=new Cc({}),yt=new Nc({}),{c(){l=D("link"),m=ae(),A=D("div"),_=D("header"),j=D("div"),te=D("div"),G=D("div"),Z=D("div"),Z.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',C=ae(),le=D("div"),F=D("div"),re=D("button"),Ce=D("span"),Ce.textContent="Advanced",it=ae(),Ge=D("span"),Ge.textContent="▾",Ue=ae(),W=D("button"),W.textContent="New",J=ae(),Q=D("label"),Q.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',M=ae(),pe=D("div"),Be=D("span"),Be.textContent="Zoom",me=ae(),et=D("button"),et.textContent="-",we=ae(),ce=D("button"),ut=Oi(r[1]),P=ae(),Y=D("button"),Y.textContent="+",x=ae(),X=D("button"),X.textContent="Share",Ee=ae(),de=D("button"),de.textContent="Help",ge=ae(),ve=D("div"),b=D("div"),b.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',Le=ae(),Ye=D("form"),Ye.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',wt=ae(),lt=D("button"),lt.textContent="Edit",xe=ae(),at=D("a"),at.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',Fe=ae(),rt=D("main"),u=D("div"),v=D("aside"),pt=D("div"),pt.textContent="Models",se=ae(),ft=D("ul"),In=ae(),K=D("div"),K.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',tt=ae(),st=D("section"),mt=D("div"),mt.innerHTML='<div class="sidebar-heading">Local files</div> <button id="toggleServerSidebar" class="pf-v5-c-button pf-m-tertiary" type="button" aria-pressed="false" hidden="">Wide menu</button>',_n=ae(),Cn=D("p"),Cn.textContent="Checking for local server…",xn=ae(),Kt=D("div"),$t=D("label"),$t.textContent="Blockscape files under ~/blockscape",hn=ae(),rn=D("div"),Dn=D("label"),Dn.textContent="Folder",so=ae(),en=D("select"),Ft=D("option"),Ft.textContent="Root (~/blockscape)",An=ae(),Wt=D("select"),sn=ae(),qt=D("div"),qt.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button> <button id="deleteLocalFile" class="pf-v5-c-button pf-m-danger" type="button">Delete</button>',Tn=ae(),d=D("div"),d.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',B=ae(),N=D("div"),N.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,stage?:1-4,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,k=ae(),V=D("footer"),ee=D("div"),ee.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',be=ae(),fe=new Zl(!1),We=ae(),ct=Gr("svg"),Ae=ae(),It=D("div"),jt=ae(),gt=D("div"),Oe=ae(),Je=D("div"),Je.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',Yt=ae(),ka(Ke.$$.fragment),Ct=ae(),ka(yt.$$.fragment),is.title="Blockscape — simple landscape-style tiles",w(l,"rel","icon"),w(l,"type","image/svg+xml"),w(l,"href","./favicon.svg"),w(Z,"class","blockscape-brand"),w(Ce,"class","blockscape-toolbar__toggle-label"),w(Ge,"class","blockscape-toolbar__toggle-icon"),w(Ge,"aria-hidden","true"),w(re,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),w(re,"type","button"),w(re,"aria-expanded",r[0]),w(re,"aria-controls","blockscapeHeaderExtras"),w(re,"aria-label",Ve=r[0]?"Hide advanced tools":"Show advanced tools"),w(W,"id","newPanelButton"),w(W,"class","pf-v5-c-button pf-m-primary"),w(W,"type","button"),w(W,"title","Create something new"),w(Q,"class","pf-v5-c-button pf-m-primary blockscape-file"),w(Be,"class","blockscape-zoom__label"),w(et,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),w(et,"type","button"),w(et,"title","Zoom out (Ctrl -)"),w(ce,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__reset"),w(ce,"type","button"),w(ce,"title","Reset zoom (Ctrl 0)"),w(Y,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),w(Y,"type","button"),w(Y,"title","Zoom in (Ctrl +)"),w(pe,"class","blockscape-zoom"),w(pe,"role","group"),w(pe,"aria-label","Zoom controls"),w(X,"id","shareModel"),w(X,"class","pf-v5-c-button pf-m-secondary"),w(X,"type","button"),w(X,"title","Copy a shareable URL for this model"),w(de,"id","helpButton"),w(de,"class","pf-v5-c-button pf-m-primary"),w(de,"type","button"),w(de,"title","Show keyboard shortcuts"),w(F,"class","blockscape-toolbar__primary"),w(b,"class","blockscape-search"),w(Ye,"id","urlForm"),w(Ye,"class","blockscape-url-form"),w(Ye,"autocomplete","on"),Ye.noValidate=!0,w(lt,"id","openInEditor"),w(lt,"class","pf-v5-c-button pf-m-secondary"),w(lt,"type","button"),w(lt,"title","Open current JSON in the editor"),w(ve,"id","blockscapeHeaderExtras"),w(ve,"class","blockscape-toolbar__extras"),ve.hidden=dt=!r[0],w(ve,"aria-hidden",xt=!r[0]),w(le,"class","blockscape-toolbar__controls"),w(le,"data-expanded",vt=r[0]?"true":"false"),w(at,"href","https://github.com/pwright/blockscape"),w(at,"target","_blank"),w(at,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),w(at,"title","View on GitHub"),w(at,"aria-label","View Blockscape on GitHub"),w(G,"class","blockscape-toolbar"),w(te,"class","pf-v5-c-masthead__content"),w(j,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),w(_,"class","pf-v5-c-page__header"),_.hidden=At=!r[4],w(pt,"class","sidebar-heading"),w(ft,"id","modelList"),w(ft,"class","model-nav-list"),w(K,"class","model-actions"),w(mt,"class","local-backend__header"),w(Cn,"id","localBackendStatus"),w(Cn,"class","local-backend__status muted"),w($t,"class","sr-only"),w($t,"for","localFileList"),w(Dn,"for","localDirSelect"),Ft.__value="",ao(Ft,Ft.__value),w(en,"id","localDirSelect"),w(en,"class","pf-v5-c-form-control"),w(en,"aria-label","Folder filter"),w(rn,"class","local-backend__dir"),w(Wt,"id","localFileList"),w(Wt,"class","pf-v5-c-form-control"),w(Wt,"size","12"),Wt.multiple=!0,w(Wt,"aria-label","Blockscape files on local server"),w(qt,"class","local-backend__actions"),w(Kt,"class","local-backend__list"),w(d,"class","local-backend__save"),w(st,"id","localBackendPanel"),w(st,"class","local-backend"),st.hidden=!0,w(v,"class","blockscape-sidebar"),w(v,"aria-label","Models"),v.hidden=y=!r[3],w(N,"class","blockscape-main"),w(u,"class","blockscape-content"),w(rt,"class","pf-v5-c-page__main"),w(ee,"class","blockscape-footer__inner"),w(V,"class","pf-v5-c-page__footer blockscape-footer"),V.hidden=z=!r[2],w(A,"class","pf-v5-c-page"),fe.a=We,w(ct,"id","overlay"),w(ct,"class","svg-layer"),w(It,"id","tabTooltip"),w(It,"class","blockscape-tab-tooltip"),It.hidden=!0,w(It,"aria-hidden","true"),w(gt,"id","tileContextMenu"),w(gt,"class","tile-context-menu"),gt.hidden=!0,w(gt,"aria-hidden","true"),w(Je,"id","itemPreview"),w(Je,"class","item-preview"),Je.hidden=!0,w(Je,"aria-hidden","true")},m(ye,nt){E(is.head,l),Bt(ye,m,nt),Bt(ye,A,nt),E(A,_),E(_,j),E(j,te),E(te,G),E(G,Z),E(G,C),E(G,le),E(le,F),E(F,re),E(re,Ce),E(re,it),E(re,Ge),E(F,Ue),E(F,W),E(F,J),E(F,Q),E(F,M),E(F,pe),E(pe,Be),E(pe,me),E(pe,et),E(pe,we),E(pe,ce),E(ce,ut),E(pe,P),E(pe,Y),E(F,x),E(F,X),E(F,Ee),E(F,de),E(le,ge),E(le,ve),E(ve,b),E(ve,Le),E(ve,Ye),E(ve,wt),E(ve,lt),E(G,xe),E(G,at),E(A,Fe),E(A,rt),E(rt,u),E(u,v),E(v,pt),E(v,se),E(v,ft),E(v,In),E(v,K),E(v,tt),E(v,st),E(st,mt),E(st,_n),E(st,Cn),E(st,xn),E(st,Kt),E(Kt,$t),E(Kt,hn),E(Kt,rn),E(rn,Dn),E(rn,so),E(rn,en),E(en,Ft),E(Kt,An),E(Kt,Wt),E(Kt,sn),E(Kt,qt),E(st,Tn),E(st,d),E(u,B),E(u,N),E(A,k),E(A,V),E(V,ee),Bt(ye,be,nt),fe.m(Ne,ye,nt),Bt(ye,We,nt),Bt(ye,ct,nt),Bt(ye,Ae,nt),Bt(ye,It,nt),Bt(ye,jt,nt),Bt(ye,gt,nt),Bt(ye,Oe,nt),Bt(ye,Je,nt),Bt(ye,Yt,nt),Di(Ke,ye,nt),Bt(ye,Ct,nt),Di(yt,ye,nt),bt=!0,Rt||(pn=[Bn(re,"click",r[6]),Bn(et,"click",r[8]),Bn(ce,"click",r[9]),Bn(Y,"click",r[7])],Rt=!0)},p(ye,[nt]){(!bt||nt&1)&&w(re,"aria-expanded",ye[0]),(!bt||nt&1&&Ve!==(Ve=ye[0]?"Hide advanced tools":"Show advanced tools"))&&w(re,"aria-label",Ve),(!bt||nt&2)&&Jr(ut,ye[1]),(!bt||nt&1&&dt!==(dt=!ye[0]))&&(ve.hidden=dt),(!bt||nt&1&&xt!==(xt=!ye[0]))&&w(ve,"aria-hidden",xt),(!bt||nt&1&&vt!==(vt=ye[0]?"true":"false"))&&w(le,"data-expanded",vt),(!bt||nt&16&&At!==(At=!ye[4]))&&(_.hidden=At),(!bt||nt&8&&y!==(y=!ye[3]))&&(v.hidden=y),(!bt||nt&4&&z!==(z=!ye[2]))&&(V.hidden=z)},i(ye){bt||(Vi(Ke.$$.fragment,ye),Vi(yt.$$.fragment,ye),bt=!0)},o(ye){Ea(Ke.$$.fragment,ye),Ea(yt.$$.fragment,ye),bt=!1},d(ye){ye&&(_t(m),_t(A),_t(be),fe.d(),_t(We),_t(ct),_t(Ae),_t(It),_t(jt),_t(gt),_t(Oe),_t(Je),_t(Yt),_t(Ct)),_t(l),Ui(Ke,ye),Ui(yt,ye),Rt=!1,So(pn)}}}const as=.1,Bc=.2,$c=2.5;function Rc(r,l,m){let A,_,j,te,{seed:G}=l,{features:Z={}}=l;const le=G?JSON.stringify(G,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let F=!1,re=1;const Ce=()=>{if(m(0,F=!F),!F){const Q=document.getElementById("search");Q&&Q.value&&(Q.value="",Q.dispatchEvent(new Event("input",{bubbles:!0})))}},it=Q=>Math.min($c,Math.max(Bc,Q)),Ge=()=>{document.body.style.zoom=String(re)},Ve=Q=>{m(12,re=it(Q)),Ge()},Ue=()=>Ve(re+as),W=()=>Ve(re-as),J=()=>Ve(1);return Ql(()=>{yc(Z),Ge();const Q=M=>{if(!(!M.ctrlKey&&!M.metaKey)){if(M.key==="="||M.key==="+"){Ue(),M.preventDefault();return}if(M.key==="-"||M.key==="_"){W(),M.preventDefault();return}M.key==="0"&&(J(),M.preventDefault())}};return window.addEventListener("keydown",Q),()=>window.removeEventListener("keydown",Q)}),r.$$set=Q=>{"seed"in Q&&m(10,G=Q.seed),"features"in Q&&m(11,Z=Q.features)},r.$$.update=()=>{r.$$.dirty&2048&&m(4,A=Z.showHeader!==!1),r.$$.dirty&2048&&m(3,_=Z.showSidebar!==!1),r.$$.dirty&2048&&m(2,j=Z.showFooter!==!1),r.$$.dirty&4096&&m(1,te=`${Math.round(re*100)}%`)},[F,te,j,_,A,le,Ce,Ue,W,J,G,Z,re]}class Oc extends Fi{constructor(l){super(),Hi(this,l,Rc,Mc,Ri,{seed:10,features:11})}}function Pc(r){let l,m;return l=new Oc({props:{seed:r[0],features:r[1]}}),{c(){ka(l.$$.fragment)},m(A,_){Di(l,A,_),m=!0},p(A,[_]){const j={};_&1&&(j.seed=A[0]),_&2&&(j.features=A[1]),l.$set(j)},i(A){m||(Vi(l.$$.fragment,A),m=!0)},o(A){Ea(l.$$.fragment,A),m=!1},d(A){Ui(l,A)}}}function Vc(r,l,m){let{seed:A}=l,{features:_={}}=l;return r.$$set=j=>{"seed"in j&&m(0,A=j.seed),"features"in j&&m(1,_=j.features)},[A,_]}class Dc extends Fi{constructor(l){super(),Hi(this,l,Vc,Pc,Ri,{seed:0,features:1})}}return Dc}();
