var Blockscape=function(){"use strict";var pu=Object.defineProperty;var fu=(Tn,Lt,Zn)=>Lt in Tn?pu(Tn,Lt,{enumerable:!0,configurable:!0,writable:!0,value:Zn}):Tn[Lt]=Zn;var Xn=(Tn,Lt,Zn)=>fu(Tn,typeof Lt!="symbol"?Lt+"":Lt,Zn);var Tn=typeof document<"u"?document.currentScript:null;function Lt(){}function Zn(r){return r()}function rr(){return Object.create(null)}function Ki(r){r.forEach(Zn)}function sr(r){return typeof r=="function"}function Eo(r,l){return r!=r?l==l:r!==l||r&&typeof r=="object"||typeof r=="function"}function Js(r){return Object.keys(r).length===0}const zs=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function I(r,l){r.appendChild(l)}function It(r,l,m){r.insertBefore(l,m||null)}function gt(r){r.parentNode&&r.parentNode.removeChild(r)}function U(r){return document.createElement(r)}function lr(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function So(r){return document.createTextNode(r)}function ce(){return So(" ")}function Qn(r,l,m,C){return r.addEventListener(l,m,C),()=>r.removeEventListener(l,m,C)}function Gs(r){return function(l){return l.preventDefault(),r.call(this,l)}}function g(r,l,m){m==null?r.removeAttribute(l):r.getAttribute(l)!==m&&r.setAttribute(l,m)}function qs(r){let l;return{p(...m){l=m,l.forEach(C=>r.push(C))},r(){l.forEach(m=>r.splice(r.indexOf(m),1))}}}function Ks(r){return Array.from(r.childNodes)}function cr(r,l){l=""+l,r.data!==l&&(r.data=l)}function ei(r,l){r.value=l??""}class Ys{constructor(l=!1){Xn(this,"is_svg",!1);Xn(this,"e");Xn(this,"n");Xn(this,"t");Xn(this,"a");this.is_svg=l,this.e=this.n=null}c(l){this.h(l)}m(l,m,C=null){this.e||(this.is_svg?this.e=lr(m.nodeName):this.e=U(m.nodeType===11?"TEMPLATE":m.nodeName),this.t=m.tagName!=="TEMPLATE"?m:m.content,this.c(l)),this.i(C)}h(l){this.e.innerHTML=l,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(l){for(let m=0;m<this.n.length;m+=1)It(this.t,this.n[m],l)}p(l){this.d(),this.h(l),this.i(this.a)}d(){this.n.forEach(gt)}}let Yi;function Xi(r){Yi=r}function Xs(){if(!Yi)throw new Error("Function called outside component initialization");return Yi}function Zs(r){Xs().$$.on_mount.push(r)}const hi=[],dr=[];let gi=[];const ur=[],Qs=Promise.resolve();let ta=!1;function el(){ta||(ta=!0,Qs.then(pr))}function na(r){gi.push(r)}const ia=new Set;let bi=0;function pr(){if(bi!==0)return;const r=Yi;do{try{for(;bi<hi.length;){const l=hi[bi];bi++,Xi(l),tl(l.$$)}}catch(l){throw hi.length=0,bi=0,l}for(Xi(null),hi.length=0,bi=0;dr.length;)dr.pop()();for(let l=0;l<gi.length;l+=1){const m=gi[l];ia.has(m)||(ia.add(m),m())}gi.length=0}while(hi.length);for(;ur.length;)ur.pop()();ta=!1,ia.clear(),Xi(r)}function tl(r){if(r.fragment!==null){r.update(),Ki(r.before_update);const l=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,l),r.after_update.forEach(na)}}function nl(r){const l=[],m=[];gi.forEach(C=>r.indexOf(C)===-1?l.push(C):m.push(C)),m.forEach(C=>C()),gi=l}const Io=new Set;let il;function ko(r,l){r&&r.i&&(Io.delete(r),r.i(l))}function oa(r,l,m,C){if(r&&r.o){if(Io.has(r))return;Io.add(r),il.c.push(()=>{Io.delete(r)}),r.o(l)}}function aa(r){r&&r.c()}function _o(r,l,m){const{fragment:C,after_update:k}=r.$$;C&&C.m(l,m),na(()=>{const W=r.$$.on_mount.map(Zn).filter(sr);r.$$.on_destroy?r.$$.on_destroy.push(...W):Ki(W),r.$$.on_mount=[]}),k.forEach(na)}function Co(r,l){const m=r.$$;m.fragment!==null&&(nl(m.after_update),Ki(m.on_destroy),m.fragment&&m.fragment.d(l),m.on_destroy=m.fragment=null,m.ctx=[])}function ol(r,l){r.$$.dirty[0]===-1&&(hi.push(r),el(),r.$$.dirty.fill(0)),r.$$.dirty[l/31|0]|=1<<l%31}function xo(r,l,m,C,k,W,ee=null,J=[-1]){const te=Yi;Xi(r);const _=r.$$={fragment:null,ctx:[],props:W,update:Lt,not_equal:k,bound:rr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(te?te.$$.context:[])),callbacks:rr(),dirty:J,skip_bound:!1,root:l.target||te.$$.root};ee&&ee(_.root);let ae=!1;if(_.ctx=m?m(r,l.props||{},(H,ie,...Ce)=>{const Xe=Ce.length?Ce[0]:ie;return _.ctx&&k(_.ctx[H],_.ctx[H]=Xe)&&(!_.skip_bound&&_.bound[H]&&_.bound[H](Xe),ae&&ol(r,H)),ie}):[],_.update(),ae=!0,Ki(_.before_update),_.fragment=C?C(_.ctx):!1,l.target){if(l.hydrate){const H=Ks(l.target);_.fragment&&_.fragment.l(H),H.forEach(gt)}else _.fragment&&_.fragment.c();l.intro&&ko(r.$$.fragment),_o(r,l.target,l.anchor),pr()}Xi(te)}class Ao{constructor(){Xn(this,"$$");Xn(this,"$$set")}$destroy(){Co(this,1),this.$destroy=Lt}$on(l,m){if(!sr(m))return Lt;const C=this.$$.callbacks[l]||(this.$$.callbacks[l]=[]);return C.push(m),()=>{const k=C.indexOf(m);k!==-1&&C.splice(k,1)}}$set(l){this.$$set&&!Js(l)&&(this.$$.skip_bound=!0,this.$$set(l),this.$$.skip_bound=!1)}}const al="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(al);const fr="blockscape:apicurioConfig",ra="http://localhost:8080/apis/registry/v3",To="bs",mr="-series",sa=!1,la=!1;function rl({models:r,getActiveIndex:l,setActive:m,ensureModelMetadata:C,ensureSeriesId:k,getModelId:W,getSeriesId:ee,getModelTitle:J,computeJsonFingerprint:te,uid:_}){let ae=null,H=null,ie=null,Ce=null,Xe=null,Ze=null,qe=null,Ve=null,z=null,Y=null;const he=new Set,M={baseUrl:ra,groupId:To,authToken:"",enabled:sa,useSemver:la},Ne=new Map,De=new Map;function de(u){return(u||"").toString().trim().replace(/\/+$/,"")}function lt(u){return`${(u||"").toString().trim()||To}${mr}`}function pe(){return!!(M.baseUrl&&M.groupId)}function ye(){return M.enabled!==!1}function Ie(){he.forEach(u=>{try{u(ye())}catch(b){console.warn("[Blockscape] failed to run Apicurio enabled listener",b)}})}function $(u){return typeof u=="function"&&he.add(u),()=>he.delete(u)}function K(){ie&&(ie.value=M.baseUrl||""),Ce&&(Ce.value=M.groupId||""),Xe&&(Xe.value=M.authToken||""),Ze&&(Ze.checked=ye()),qe&&(qe.checked=!!M.useSemver)}function c(u="",b="muted"){Ve&&(Ve.textContent=u||"",Ve.classList.remove("is-error","is-success"),b==="error"?Ve.classList.add("is-error"):b==="success"&&Ve.classList.add("is-success"))}function X(u){if(!Y||(Y.innerHTML="",!u))return;const b=document.createElement("p");b.className="apicurio-hint",b.textContent=u,Y.appendChild(b)}function fe(u){Ne.clear(),De.clear(),X(u)}function me(){const u=l(),b=ye(),L=pe(),T=u>=0?r[u]:null,y=!!(T!=null&&T.apicurioVersions&&T.apicurioVersions.length>1);if(ae){const R=ae.dataset.loading==="true",Q=b&&L&&u>=0&&!!it(r[u]);ae.disabled=!b||R||!Q,b?R||(ae.textContent="Push to Apicurio"):ae.textContent="Enable Apicurio to push"}if(z){const R=z.dataset.loading==="true",Q=b&&L&&y&&!!it(T);z.disabled=!Q||R,z.hidden=!y,b?R||(z.textContent="Push series"):z.textContent="Enable Apicurio to push series"}if(H){const R=H.dataset.loading==="true",Q=b&&L;H.disabled=!Q||R,R||(b?L?H.textContent="List artifacts":H.textContent="Enter details to list":H.textContent="Enable Apicurio to list")}}function we(){K(),ye()?pe()?(c("Apicurio push is ready when a model is selected.","muted"),Ne.size||X("Click “List artifacts” to browse the current group.")):(c("Enter Apicurio connection details to enable push.","muted"),fe("Enter registry details to browse artifacts.")):(c("Apicurio integration is off. Enable it to allow pushes.","muted"),fe("Apicurio integration is disabled.")),me()}function Ke(){if(window!=null&&window.localStorage)try{localStorage.setItem(fr,JSON.stringify(M))}catch(u){console.warn("[Blockscape] unable to persist Apicurio settings",u)}}function xe(){let u={};if(window!=null&&window.localStorage)try{const R=localStorage.getItem(fr);if(R){const Q=JSON.parse(R);Q&&typeof Q=="object"&&(u=Q)}}catch(R){console.warn("[Blockscape] failed to restore Apicurio settings",R)}const b=de(u.baseUrl??ra),L=(u.groupId??To).toString().trim();let T=sa,y=la;typeof u.enabled=="boolean"?T=u.enabled:typeof u.enabled=="string"&&(T=u.enabled==="true"),typeof u.useSemver=="boolean"?y=u.useSemver:typeof u.useSemver=="string"&&(y=u.useSemver==="true"),M.baseUrl=b||ra,M.groupId=L||To,M.authToken=(u.authToken??"").toString().trim(),M.enabled=T,M.useSemver=y,we(),Ie()}function Oe(){const u={Accept:"application/json"},b=(M.authToken||"").trim();return b&&(u.Authorization=/\s/.test(b)?b:`Bearer ${b}`),u}function Qe(u,b,{title:L,description:T,version:y}={}){const R={artifactId:u,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:b},metadata:{properties:{}}}};y&&(R.firstVersion.version=y),L&&(R.name=L),T&&(R.description=T);try{const Q=JSON.parse(b),q=Q==null?void 0:Q.seriesId;q&&typeof q=="string"&&(R.firstVersion.metadata.properties.seriesId=q)}catch{}return R}function mt(u,{version:b}={}){const L={content:{contentType:"application/json",content:u},metadata:{properties:{}}};try{const T=JSON.parse(u),y=T==null?void 0:T.seriesId;y&&typeof y=="string"&&(L.metadata.properties.seriesId=y)}catch{}return b&&(L.version=b),L}function at(u){if(u==null)return null;const b=String(u).trim();if(!b)return null;const L=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(b);if(L)return{major:Number(L[1]),minor:Number(L[2]),patch:Number(L[3])};const T=/^v?(\d+)$/.exec(b);return T?{major:Number(T[1]),minor:0,patch:0}:null}function pt(u){return`${u.major}.${u.minor}.${u.patch}`}function Ae(u,b){return!u&&!b?0:u?b?u.major!==b.major?u.major-b.major:u.minor!==b.minor?u.minor-b.minor:u.patch-b.patch:1:-1}function O(u=[]){let b=null;if(u.forEach(T=>{const y=at((T==null?void 0:T.version)??T);y&&(!b||Ae(y,b)>0)&&(b=y)}),!b)return"1.0.0";const L={...b,patch:b.patch+1};return pt(L)}function it(u,{seriesName:b,fallbackTitle:L}={}){var R;if(!u)return null;const T=b||u.title||u.apicurioArtifactName||J(u),y=L||T;if(typeof k=="function"&&(u.isSeries||((R=u.apicurioVersions)==null?void 0:R.length)>1)&&k(u,{seriesName:T,fallbackTitle:y}),typeof ee=="function"){const Q=ee(u,{seriesName:T,fallbackTitle:y});if(Q)return Q}return W(u)}function Nt(u){return Array.isArray(u)?u:Array.isArray(u==null?void 0:u.artifacts)?u.artifacts:Array.isArray(u==null?void 0:u.items)?u.items:Array.isArray(u==null?void 0:u.results)?u.results:[]}function E(u){return Array.isArray(u)?u:Array.isArray(u==null?void 0:u.versions)?u.versions:Array.isArray(u==null?void 0:u.items)?u.items:[]}function w(u=[]){if(!Array.isArray(u)||!u.length)return null;const b=[...u].filter(Boolean);return b.sort((L,T)=>{const y=L!=null&&L.createdOn?new Date(L.createdOn).getTime():0,R=T!=null&&T.createdOn?new Date(T.createdOn).getTime():0;if(y!==R)return R-y;const Q=Number(L==null?void 0:L.version),q=Number(T==null?void 0:T.version),ve=Number.isFinite(Q),be=Number.isFinite(q);if(ve&&be&&Q!==q)return q-Q;const ue=String((L==null?void 0:L.version)??"");return String((T==null?void 0:T.version)??"").localeCompare(ue,void 0,{numeric:!0})}),b[0]||null}function Re(u){if(!u)return u;let b=u;if(!Array.isArray(u==null?void 0:u.categories)){const T=u==null?void 0:u.content;if(typeof T=="string")try{b=JSON.parse(T)}catch(y){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",y)}else T&&typeof T=="object"&&(b=T)}return b}async function D(u,b,L){const T=encodeURIComponent(b),y=encodeURIComponent(L),R=`${u}/groups/${T}/artifacts/${y}`,Q=Oe();Q.Accept="application/json";const q=await fetch(R,{method:"GET",headers:Q});if(!q.ok){let ve=q.statusText||"Unknown error";try{const be=await q.text();be&&(ve=be.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${q.status}): ${ve}`)}return q.json()}async function Te(u,b,L){const T=encodeURIComponent(b),y=encodeURIComponent(L),R=`${u}/groups/${T}/artifacts/${y}/versions?limit=50&order=desc`,Q=Oe();Q.Accept="application/json";const q=await fetch(R,{method:"GET",headers:Q});if(!q.ok){let be=q.statusText||"Unknown error";try{const ue=await q.text();ue&&(be=ue.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${q.status}): ${be}`)}const ve=await q.json();return E(ve).filter(be=>be&&be.version!=null)}async function Ht(u,b,L,T="latest"){const y=encodeURIComponent(b),R=encodeURIComponent(L),Q=encodeURIComponent(T||"latest"),q=`${u}/groups/${y}/artifacts/${R}/versions/${Q}/content`,ve=Oe();ve.Accept="application/json, application/*+json, */*;q=0.8";const be=await fetch(q,{method:"GET",headers:ve});if(!be.ok){let et=be.statusText||"Unknown error";try{const Me=await be.text();Me&&(et=Me.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${be.status}): ${et}`)}const ue=await be.text();let Fe=null;try{Fe=JSON.parse(ue)}catch{throw new Error("Artifact content is not valid JSON.")}return Re(Fe)}async function G(u,b,L,T="latest"){const y=await Ht(u,b,L,T);return{data:y,fingerprint:te(y)}}async function ze(u,b,L){try{const y=await Te(u,b,L);if(y!=null&&y.length){De.set(L,y);const R=w(y);if((R==null?void 0:R.version)!=null)return R.version}}catch(y){console.warn("[Blockscape] compare-version: unable to fetch versions list",y)}try{const y=await D(u,b,L);if((y==null?void 0:y.version)!=null)return y.version}catch(y){console.warn("[Blockscape] compare-version: unable to fetch metadata",y)}const T=De.get(L);if(T&&T.length){const y=w(T);if((y==null?void 0:y.version)!=null)return y.version}return"latest"}async function rt(u,b,L,T){if(!M.useSemver)return null;if(!T)return"1.0.0";try{const y=await Te(u,b,L);return O(y)}catch(y){throw new Error(`Unable to compute next semantic version: ${y.message}`)}}function st(u=document){ae=u.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),z=u.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),H=u.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),ie=u.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),Ce=u.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),Xe=u.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),Ze=u.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),qe=u.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),Ve=u.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),Y=u.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function yn(){M.baseUrl=de((ie==null?void 0:ie.value)??M.baseUrl),M.groupId=((Ce==null?void 0:Ce.value)??"").trim(),M.authToken=((Xe==null?void 0:Xe.value)??"").trim(),Ke(),we()}function Qt(u){M.enabled=u!==!1,Ke(),we(),Ie()}function en(){Qt(Ze?Ze.checked:sa)}function Jn(){M.useSemver=qe?qe.checked:la,Ke(),we()}function yt(){[ie,Ce,Xe].forEach(u=>{u&&u.addEventListener("input",yn)}),ae&&ae.addEventListener("click",()=>{Rt()}),z&&z.addEventListener("click",()=>{En()}),Ze&&Ze.addEventListener("change",en),qe&&qe.addEventListener("change",Jn),H&&H.addEventListener("click",nn),Y&&Y.addEventListener("click",u=>{const b=u.target.closest("[data-artifact-version]");if(b){u.stopPropagation();const y=b.dataset.artifactId,R=b.dataset.artifactVersion;y&&R&&Xt(y,R);return}const L=u.target.closest("[data-artifact-load-all]");if(L){u.stopPropagation(),L.dataset.artifactId&&Sn();return}const T=u.target.closest("[data-artifact-trigger]");if(T){const y=T.dataset.artifactId;if(!y)return;tn(y)}})}function Ft(){const u=document.createElement("div");return u.className="blockscape-registry-panel",u.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,u}function ni(u){if(!u)return;u.innerHTML="";const b=Ft();u.appendChild(b),st(u),yt(),we()}function cn(u){if(!Y)return;if(Y.innerHTML="",!u.length){X("No artifacts found in this group.");return}const b=y=>{const R=document.createElement("section");R.className="apicurio-artifact-section";const Q=document.createElement("h3");Q.textContent=y,R.appendChild(Q);const q=document.createElement("ul");return q.className="apicurio-artifact-list",R.appendChild(q),{section:R,list:q}},L=b("Series artifacts"),T=b("Artifacts");u.forEach(y=>{if(!(y!=null&&y.artifactId))return;const Q=y._groupId&&y._groupId.endsWith(mr)?L.list:T.list,q=document.createElement("li"),ve=document.createElement("button");ve.type="button",ve.className="apicurio-artifact",ve.dataset.artifactId=y.artifactId,ve.dataset.artifactTrigger="toggle";const be=document.createElement("span");be.className="apicurio-artifact-title",be.textContent=y.artifactId,ve.appendChild(be);const ue=[];if(y.name&&ue.push(y.name),y.version!=null&&ue.push(`v${y.version}`),y.type&&ue.push(y.type),y._groupId&&ue.push(y._groupId),ue.length){const Me=document.createElement("span");Me.className="apicurio-artifact-meta",Me.textContent=ue.join(" • "),ve.appendChild(Me)}if(y.description){const Me=document.createElement("span");Me.className="apicurio-artifact-meta",Me.textContent=y.description,ve.appendChild(Me)}q.appendChild(ve);const Fe=document.createElement("div");Fe.className="apicurio-version-list",Fe.dataset.versionPanel=y.artifactId,Fe.hidden=!0;const et=document.createElement("p");et.className="apicurio-hint",et.textContent="Click to load the latest or open versions.",Fe.appendChild(et),q.appendChild(Fe),Q.appendChild(q)}),L.list.children.length&&Y.appendChild(L.section),T.list.children.length&&Y.appendChild(T.section)}function zn(u){return Y?Y.querySelector(`[data-version-panel="${u}"]`):null}function Ot(u,b){if(!u||(u.innerHTML="",!b))return;const L=document.createElement("p");L.className="apicurio-hint",L.textContent=b,u.appendChild(L)}function dn(u,b){const L=zn(u);if(L){if(L.innerHTML="",!b.length){Ot(L,"No versions found for this artifact.");return}b.forEach(T=>{const y=document.createElement("button");y.type="button",y.className="apicurio-version-button",y.dataset.artifactId=u,y.dataset.artifactVersion=T.version;const R=[`Version ${T.version}`];if(T.createdOn){const Q=new Date(T.createdOn);isNaN(Q)||R.push(Q.toISOString().slice(0,10))}y.textContent=R.join(" — "),L.appendChild(y)})}}async function tn(u){const b=zn(u);if(!b)return;if(b.dataset.open==="true"){b.hidden=!0,b.dataset.open="false";return}if(b.hidden=!1,b.dataset.open="true",b.dataset.loaded!=="true"){if(!pe()){Ot(b,"Enter registry details first.");return}Ot(b,"Loading versions…");try{const T=de(M.baseUrl),y=Ne.get(u),R=M.groupId.trim(),Q=(y==null?void 0:y._groupId)||R,q=await Te(T,Q,u);De.set(u,q),b.dataset.loaded="true",dn(u,q)}catch(T){console.error("[Blockscape] failed to load versions",T),Ot(b,`Unable to fetch versions: ${T.message}`)}}}function Yt(u,b){var T;const L=r.findIndex(y=>y.apicurioArtifactId===u);if(L!==-1){const y=r[L].id;r[L]={...b,id:y||b.id},((T=r[L].apicurioVersions)==null?void 0:T.length)>1&&(r[L].isSeries=!0),m(L)}else r.push(b),m(r.length-1)}async function Wt(u,b,L,T){const y=encodeURIComponent(b),R=encodeURIComponent(L),Q=`${u}/groups/${y}/artifacts/${R}`;try{const q=await fetch(Q,{method:"GET",headers:T});if(q.status===404)return!1;if(q.ok)return!0;throw q.status===401||q.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${q.status} while checking the artifact.`)}catch(q){throw q instanceof TypeError?new Error("Network error while contacting Apicurio registry."):q}}async function Rt(){var Q;if(!ae||ae.dataset.loading==="true")return;if(!ye()){c("Apicurio integration is off. Enable it first.","error");return}if(!pe()){c("Enter the registry base URL and group ID before pushing.","error");return}const u=l();if(u<0||!r[u]){c("No active model to push.","error");return}const b=it(r[u],{fallbackTitle:J(r[u])});if(!b){c("Active model needs an id before pushing.","error");return}const L=de(M.baseUrl),T=M.groupId.trim(),y=JSON.stringify(r[u].data,null,2),R=Oe();ae.dataset.loading="true",ae.textContent="Pushing…",ae.disabled=!0,c("Pushing to Apicurio…","muted");try{const q=await Wt(L,T,b,R),ve=te(r[u].data);if(q)try{const ct=await ze(L,T,b),{data:kt,fingerprint:Et}=await G(L,T,b,ct);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",ct),console.log("local fingerprint",ve),console.log("registry fingerprint",Et),console.log("local payload",r[u].data),console.log("registry payload",kt),console.groupEnd(),ve&&Et&&ve===Et){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){c("Push cancelled (content matches the latest registry version).","muted");return}c("Pushing identical content by user choice.","muted")}else Et?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):c("Unable to compare with registry content (skipping confirmation).","muted")}catch(ct){console.warn("[Blockscape] unable to compare registry content before push",ct),c("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const be=M.useSemver?await rt(L,T,b,q):null;if(M.useSemver&&!be)throw new Error("Semantic versioning is enabled but no version could be computed.");const ue=encodeURIComponent(T),Fe=encodeURIComponent(b),et=q?`${L}/groups/${ue}/artifacts/${Fe}/versions`:`${L}/groups/${ue}/artifacts`,Me={...R,"Content-Type":"application/json"};be&&(Me["X-Registry-Version"]=be,c(`Pushing to Apicurio as version ${be}…`,"muted"));const bt=q?mt(y,{version:be}):Qe(b,y,{title:J(r[u]),description:(Q=r[u].data)==null?void 0:Q.abstract,version:be}),Ye=await fetch(et,{method:"POST",headers:Me,body:JSON.stringify(bt)});if(!Ye.ok){let ct=Ye.statusText||"Unknown error";try{const kt=await Ye.text();kt&&(ct=kt.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Ye.status}): ${ct}`)}let wt=null;try{wt=await Ye.json()}catch{wt=null}const Pe=(wt==null?void 0:wt.version)||(wt==null?void 0:wt.globalId)||"",ne=q?"Updated":"Created",Be=Pe?` (version ${Pe})`:"";c(`${ne} ${b}${Be}`,"success")}catch(q){console.error("[Blockscape] Apicurio push failed",q),c(`Apicurio push failed: ${q.message}`,"error")}finally{ae.dataset.loading="false",me()}}async function En(){var be,ue;if(!z||z.dataset.loading==="true")return;if(!ye()){c("Apicurio integration is off. Enable it first.","error");return}if(!pe()){c("Enter the registry base URL and group ID before pushing.","error");return}const u=l(),b=u>=0?r[u]:null;if(!b||!b.apicurioVersions||b.apicurioVersions.length<2){c("Series push requires a model with multiple versions.","error");return}const L=it(b,{seriesName:b.title||b.apicurioArtifactName||J(b)});if(!L){c("Active series needs an id before pushing.","error");return}typeof k=="function"&&k(b,{seriesName:b.title||b.apicurioArtifactName||J(b)});const T=de(M.baseUrl),y=M.groupId.trim(),R=b.apicurioVersions.map(Fe=>Fe.data),Q=JSON.stringify(R,null,2),q=Oe(),ve=lt(y);z.dataset.loading="true",z.textContent="Pushing…",z.disabled=!0,c("Pushing series to Apicurio…","muted");try{const Fe=await Wt(T,ve,L,q),et=te(R);if(Fe)try{const un=await ze(T,ve,L),{data:_n,fingerprint:ii}=await G(T,ve,L,un);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",un),console.log("local fingerprint",et),console.log("registry fingerprint",ii),console.log("local payload (series)",R),console.log("registry payload",_n),console.groupEnd(),et&&ii&&et===ii){if(!window.confirm("The current registry version matches this series. Push anyway?")){c("Series push cancelled (content matches latest).","muted");return}c("Pushing identical series by user choice.","muted")}else ii?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):c("Unable to compare with registry content (skipping confirmation).","muted")}catch(un){console.warn("[Blockscape] unable to compare registry content before series push",un),c("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const Me=M.useSemver?await rt(T,ve,L,Fe):null;if(M.useSemver&&!Me)throw new Error("Semantic versioning is enabled but no version could be computed.");const bt=encodeURIComponent(ve),Ye=encodeURIComponent(L),wt=Fe?`${T}/groups/${bt}/artifacts/${Ye}/versions`:`${T}/groups/${bt}/artifacts`,Pe={...q,"Content-Type":"application/json"};Me&&(Pe["X-Registry-Version"]=Me,c(`Pushing series to Apicurio as version ${Me}…`,"muted"));const ne=Fe?mt(Q,{version:Me}):Qe(L,Q,{title:b.apicurioArtifactName||((be=b.data)==null?void 0:be.title)||L,description:(ue=b.data)==null?void 0:ue.abstract,version:Me}),Be=await fetch(wt,{method:"POST",headers:Pe,body:JSON.stringify(ne)});if(!Be.ok){let un=Be.statusText||"Unknown error";try{const _n=await Be.text();_n&&(un=_n.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${Be.status}): ${un}`)}let ct=null;try{ct=await Be.json()}catch{ct=null}const kt=(ct==null?void 0:ct.version)||(ct==null?void 0:ct.globalId)||"",Et=Fe?"Updated":"Created",kn=kt?` (version ${kt})`:"";c(`${Et} ${L} series${kn}`,"success")}catch(Fe){console.error("[Blockscape] Apicurio series push failed",Fe),c(`Apicurio series push failed: ${Fe.message}`,"error")}finally{z.dataset.loading="false",me()}}async function nn(){if(!H||H.dataset.loading==="true")return;if(!ye()){c("Enable Apicurio integration to list artifacts.","error");return}if(!pe()){c("Enter registry base URL and group ID before listing.","error");return}const u=de(M.baseUrl),b=M.groupId.trim(),L=lt(b),T=[{groupId:b,label:"base"},{groupId:L,label:"series"}];H.dataset.loading="true",H.textContent="Listing…",H.disabled=!0,c("Listing artifacts…","muted"),X("Contacting registry…");try{const y=Oe();y.Accept="application/json";const R=[];for(const q of T){const ve=encodeURIComponent(q.groupId),be=`${u}/groups/${ve}/artifacts?limit=50&offset=0`,ue=await fetch(be,{method:"GET",headers:y});if(!ue.ok){let Me=ue.statusText||"Unknown error";try{const bt=await ue.text();bt&&(Me=bt.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${q.groupId} (${ue.status}): ${Me}`);continue}const Fe=await ue.json(),et=Nt(Fe).filter(Me=>Me&&Me.artifactId);et.forEach(Me=>{Me&&(Me._groupId=q.groupId)}),R.push(...et)}Ne.clear(),De.clear(),R.forEach(q=>{q!=null&&q.artifactId&&Ne.set(q.artifactId,q)}),cn(R);const Q=R.length;c(Q?`Found ${Q} artifact${Q===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",Q?"success":"muted")}catch(y){console.error("[Blockscape] failed to list artifacts",y),fe("Unable to list artifacts."),c(`Listing failed: ${y.message}`,"error")}finally{H.dataset.loading="false",me()}}async function Xt(u,b=null){var Fe,et,Me,bt,Ye,wt;if(!u)return;if(!ye()){c("Enable Apicurio integration to load artifacts.","error");return}if(!pe()){c("Enter registry connection details before loading artifacts.","error");return}const L=de(M.baseUrl),T=M.groupId.trim(),y=u&&((Fe=Ne.get(u))==null?void 0:Fe._groupId)||T;let R=Ne.get(u);const Q=async()=>{try{const Pe=await D(L,y,u);return Pe!=null&&Pe.artifactId&&Ne.set(u,Pe),Pe}catch(Pe){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",Pe),Pe}};if(!R)try{R=await Q()}catch(Pe){c(`Failed to fetch artifact metadata: ${Pe.message}`,"error");return}const q=De.get(u)||[];let ve="latest",be="latest";if(b)ve=b,be=b;else{if(!R||R.version==null)try{R=await Q()}catch(Pe){c(`Failed to fetch artifact metadata: ${Pe.message}`,"error");return}ve=(R==null?void 0:R.version)||"latest",be=(R==null?void 0:R.version)||"latest"}const ue=q.find(Pe=>String(Pe.version)===String(ve));(ue==null?void 0:ue.version)!=null&&(be=ue.version),c(`Loading artifact ${u}…`,"muted");try{const Pe=await Ht(L,y,u,ve),ne=Ne.get(u)||R||{},Be=Array.isArray(Pe);let ct=null;if(Be){const kt=Pe.map((kn,un)=>(C(kn,{titleHint:ne.name||u,idHint:u}),{version:String(un+1),data:kn,createdOn:(ue==null?void 0:ue.createdOn)||ne.createdOn}));ct={id:_(),title:((Me=(et=kt[0])==null?void 0:et.data)==null?void 0:Me.title)||ne.name||u,data:(bt=kt[0])==null?void 0:bt.data,apicurioArtifactId:u,apicurioArtifactName:ne.name||"",apicurioVersions:kt,apicurioActiveVersionIndex:0,isSeries:!0};const Et=((Ye=ne==null?void 0:ne.properties)==null?void 0:Ye.seriesId)||u;typeof k=="function"&&k(ct,{seriesName:Et,fallbackTitle:Et}),c(`Loaded series artifact ${u}.`,"success")}else{C(Pe,{titleHint:ne.name||u,idHint:u});const kt={version:be,data:Pe,createdOn:(ue==null?void 0:ue.createdOn)||ne.createdOn};ct={id:_(),title:Pe.title||ne.name||u,data:Pe,apicurioArtifactId:u,apicurioArtifactName:ne.name||"",apicurioVersions:[kt],apicurioActiveVersionIndex:0};const Et=(wt=ne==null?void 0:ne.properties)==null?void 0:wt.seriesId;Et&&typeof k=="function"&&k(ct,{seriesName:Et,fallbackTitle:Et});const kn=be?` (version ${be})`:"";c(`Loaded artifact ${u}${kn}.`,"success")}Yt(u,ct)}catch(Pe){console.error("[Blockscape] failed to load artifact",Pe),c(`Failed to load artifact: ${Pe.message}`,"error")}}async function Sn(u){}return{hydrateConfig:xe,mount:ni,updateAvailability:me,isEnabled:ye,setEnabled:Qt,onEnabledChange:$}}const ln={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Wn(r,l){if(typeof r!="function")throw new Error(`[itemEditor] expected ${l} to be a function`)}function sl(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}function ll(r,{excludeId:l}={}){if(!r)return[];const m=r.split(/[\s,]+/).map(k=>k.trim()).filter(Boolean),C=[];return m.forEach(k=>{l&&k===l||C.includes(k)||C.push(k)}),C}function cl(r,l,m){if(!l||!m||l===m)return;((r==null?void 0:r.categories)||[]).forEach(k=>{(k.items||[]).forEach(W=>{Array.isArray(W.deps)&&(W.deps=W.deps.map(ee=>ee===l?m:ee))})})}function dl({findItemAndCategoryById:r,collectAllItemIds:l,updateItemReferences:m,loadActiveIntoEditor:C,rebuildFromActive:k,select:W,onSelectionRenamed:ee,makeSlug:J=sl,isAutoIdFromNameEnabled:te=()=>!0}={}){Wn(r,"findItemAndCategoryById"),Wn(l,"collectAllItemIds"),Wn(m,"updateItemReferences"),Wn(C,"loadActiveIntoEditor"),Wn(k,"rebuildFromActive"),Wn(W,"select"),Wn(J,"makeSlug"),Wn(te,"isAutoIdFromNameEnabled");const _={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function ae(z){if(_.fields.errorEl){if(!z){_.fields.errorEl.hidden=!0,_.fields.errorEl.textContent="";return}_.fields.errorEl.hidden=!1,_.fields.errorEl.textContent=z}}function H(){_.wrapper&&(_.wrapper.hidden=!0,_.wrapper.setAttribute("aria-hidden","true"),ae(""),_.categoryId=null,_.itemId=null,_.modelData=null,document.body.classList.remove("item-editor-open"))}function ie(){_.wrapper&&(_.wrapper.hidden=!1,_.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var z,Y;(z=_.fields.nameInput)==null||z.focus(),(Y=_.fields.nameInput)==null||Y.select()}))}function Ce({force:z}={}){var he,M;if(!((he=_.fields)!=null&&he.idInput)||!((M=_.fields)!=null&&M.nameInput)||!_.autoSyncEnabled||!te()||!z&&_.autoIdManuallyEdited)return;const Y=J(_.fields.nameInput.value||_.itemId||"item");_.fields.idInput.value=Y}function Xe(z){var ye;if(!_.modelData||!_.categoryId||!_.itemId)throw new Error("No item loaded.");const he=(((ye=_.modelData)==null?void 0:ye.categories)||[]).find(Ie=>Ie.id===_.categoryId);if(!he)throw new Error("Category not found.");he.items=he.items||[];const M=he.items.find(Ie=>Ie.id===_.itemId);if(!M)throw new Error("Item not found.");const Ne=(z.id||"").trim();if(!Ne)throw new Error("ID is required.");const De=l(_.modelData);if(Ne!==M.id&&De.has(Ne))throw new Error("Another item already uses that ID.");M.id=Ne;const de=(z.name||"").trim();M.name=de||M.id;const lt=(z.logo||"").trim();if(lt?M.logo=lt:delete M.logo,z.externalFlag&&!z.external)M.external=!0;else{const Ie=(z.external??"").toString().trim();Ie?M.external=Ie:delete M.external}const pe=(z.color||"").trim();return pe?M.color=pe:delete M.color,M.deps=Array.isArray(z.deps)?z.deps:[],M.id!==z.originalId&&typeof ee=="function"&&ee(z.originalId,M.id),m(_.modelData,z.originalId,M.id),C(),k(),W(M.id),M.id}function Ze(){if(!_.fields||!_.fields.idInput)return!1;const z=(_.fields.idInput.value||"").trim(),Y={originalId:_.itemId,id:z,name:_.fields.nameInput.value||"",logo:_.fields.logoInput.value||"",external:_.fields.externalInput.value||"",externalFlag:_.fields.externalFlagInput.checked,color:_.fields.colorInput.value||"",deps:ll(_.fields.depsInput.value,{excludeId:z})};try{return Xe(Y),H(),!0}catch(he){return console.warn("[itemEditor] item edit failed",he),ae((he==null?void 0:he.message)||"Unable to save item."),!1}}function qe(){if(_.wrapper)return _.wrapper;const z=document.createElement("div");z.className="item-editor-modal",z.hidden=!0,z.setAttribute("role","dialog"),z.setAttribute("aria-modal","true");const Y=document.createElement("div");Y.className="item-editor-modal__backdrop",z.appendChild(Y);const he=document.createElement("div");he.className="item-editor",z.appendChild(he);const M=document.createElement("div");M.className="item-editor__header";const Ne=document.createElement("h2");Ne.className="item-editor__title",Ne.textContent="Edit item";const De=document.createElement("button");De.type="button",De.className="item-editor__close",De.setAttribute("aria-label","Close item editor"),De.textContent="×",M.appendChild(Ne),M.appendChild(De),he.appendChild(M);const de=document.createElement("form");de.className="item-editor__form",he.appendChild(de);const lt=document.createElement("div");lt.className="item-editor__meta",lt.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',de.appendChild(lt);const pe=document.createElement("div");pe.className="item-editor__error",pe.hidden=!0,de.appendChild(pe);const ye=(E,w,Re)=>{const D=document.createElement("label");D.className="item-editor__field";const Te=document.createElement("span");if(Te.className="item-editor__label",Te.textContent=E,D.appendChild(Te),w.classList.add("item-editor__control"),D.appendChild(w),Re){const Ht=document.createElement("div");Ht.className="item-editor__hint",Ht.textContent=Re,D.appendChild(Ht)}return D},Ie=document.createElement("input");Ie.type="text",Ie.required=!0,de.appendChild(ye("ID",Ie,"Unique identifier used for dependencies."));const $=document.createElement("input");$.type="text",de.appendChild(ye("Name",$,"Visible label shown on the tile."));const K=document.createElement("input");K.type="url",K.inputMode="url",K.placeholder="https://…",de.appendChild(ye("Logo URL",K,"Optional image URL."));const c=document.createElement("input");c.type="url",c.inputMode="url",c.placeholder="https://…",de.appendChild(ye("External link",c,"Shown with ↗ icon and in preview."));const X=document.createElement("div");X.className="item-editor__checkbox";const fe=document.createElement("label");fe.className="item-editor__checkbox-row";const me=document.createElement("input");me.type="checkbox";const we=document.createElement("span");we.textContent="Mark as external without link";const Ke=document.createElement("div");Ke.className="item-editor__hint",Ke.textContent="Keeps dashed border even without a URL.",fe.appendChild(me),fe.appendChild(we),X.appendChild(fe),X.appendChild(Ke),de.appendChild(X);const xe=document.createElement("input");xe.type="text",xe.placeholder=ln.color.primary,de.appendChild(ye("Color",xe,"Optional badge color (hex or CSS color)."));const Oe=document.createElement("textarea");Oe.rows=2,Oe.placeholder="Comma or space separated ids",de.appendChild(ye("Dependencies",Oe,"Use item IDs, separated by commas or spaces."));const Qe=document.createElement("div");Qe.className="item-editor__checkbox";const mt=document.createElement("label");mt.className="item-editor__checkbox-row";const at=document.createElement("input");at.type="checkbox";const pt=document.createElement("span");pt.textContent="Sync ID while editing name";const Ae=document.createElement("div");Ae.className="item-editor__hint",Ae.textContent="Turn off to keep typing names without changing the ID.",mt.appendChild(at),mt.appendChild(pt),Qe.appendChild(mt),Qe.appendChild(Ae),de.appendChild(Qe);const O=document.createElement("div");O.className="item-editor__actions";const it=document.createElement("button");it.type="button",it.className="pf-v5-c-button pf-m-tertiary",it.textContent="Cancel";const Nt=document.createElement("button");return Nt.type="submit",Nt.className="pf-v5-c-button pf-m-primary",Nt.textContent="Save",O.appendChild(it),O.appendChild(Nt),de.appendChild(O),_.wrapper=z,_.fields={idInput:Ie,nameInput:$,logoInput:K,externalInput:c,externalFlagInput:me,colorInput:xe,depsInput:Oe,syncCheckbox:at,categoryValue:lt.querySelector(".item-editor__meta-value"),errorEl:pe},it.addEventListener("click",H),De.addEventListener("click",H),Y.addEventListener("click",H),Ie.addEventListener("input",()=>{_.autoIdManuallyEdited=!0}),$.addEventListener("input",Ce),at.addEventListener("change",()=>{_.autoSyncEnabled=!!at.checked,_.autoSyncEnabled&&(_.autoIdManuallyEdited=!1,Ce({force:!0}))}),de.addEventListener("submit",E=>{E.preventDefault(),Ze()}),document.addEventListener("keydown",E=>{E.key==="Escape"&&!z.hidden&&(E.preventDefault(),E.stopPropagation(),H())}),document.body.appendChild(z),z}function Ve(z){const Y=r(z);if(!Y)return!1;qe(),_.categoryId=Y.category.id,_.itemId=Y.item.id,_.modelData=Y.modelData,_.autoIdManuallyEdited=!1;const he=!!te();return _.autoSyncEnabled=he,_.fields.categoryValue.textContent=Y.category.title||Y.category.id,_.fields.idInput.value=Y.item.id||"",_.fields.nameInput.value=Y.item.name||"",_.fields.logoInput.value=Y.item.logo||"",_.fields.externalInput.value=typeof Y.item.external=="string"?Y.item.external:"",_.fields.externalFlagInput.checked=Y.item.external===!0,_.fields.colorInput.value=Y.item.color||"",_.fields.depsInput.value=Array.isArray(Y.item.deps)?Y.item.deps.join(", "):"",_.fields.syncCheckbox.checked=_.autoSyncEnabled,_.fields.syncCheckbox.disabled=!he,!_.fields.idInput.value&&he&&Ce({force:!0}),ae(""),W(Y.item.id),ie(),!0}return{open:Ve,hide:H,isOpen:()=>!!_.wrapper&&!_.wrapper.hidden}}function ul({menuEl:r,previewEl:l,previewTitleEl:m,previewBodyEl:C,previewActionsEl:k,previewCloseEl:W,escapeHtml:ee,onEditItem:J,onChangeColor:te,selectItem:_,colorPresets:ae=[]}={}){const H=r||(()=>{const $=document.createElement("div");return $.className="tile-context-menu",$.hidden=!0,$.setAttribute("aria-hidden","true"),document.body.appendChild($),$})();let ie={x:0,y:0},Ce=0,Xe=Array.isArray(ae)?ae:[];function Ze(){H&&(H.classList.remove("is-open"),H.hidden=!0,H.setAttribute("aria-hidden","true"),H.innerHTML="")}function qe($=[]){k&&(k.innerHTML="",$.forEach(K=>{const c=document.createElement("button");c.type="button",c.className="item-preview__action",c.textContent=K.label||"Action",K.title&&(c.title=K.title),c.addEventListener("click",X=>{X.stopPropagation(),typeof K.onClick=="function"&&K.onClick(X)}),k.appendChild(c)}),k.hidden=$.length===0)}function Ve(){Ze(),l&&(l.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),l.setAttribute("aria-hidden","true"),l.hidden=!0,qe([]))}function z($,K){l&&(ie={x:$,y:K},l.hidden=!1,l.setAttribute("aria-hidden","false"),l.classList.add("is-visible"),Y($,K))}function Y($,K){if(!l)return;const c=12;l.style.left=`${$+c}px`,l.style.top=`${K+c}px`;const X=l.getBoundingClientRect();let fe=X.left,me=X.top;X.right>window.innerWidth-c&&(fe=Math.max(c,window.innerWidth-X.width-c)),X.bottom>window.innerHeight-c&&(me=Math.max(c,window.innerHeight-X.height-c)),l.style.left=`${fe}px`,l.style.top=`${me}px`}function he($,K){var we;if(!$)return null;const c=$.dataset.id,X=((we=$.querySelector(".name"))==null?void 0:we.textContent)||c||"Preview",fe=c?`${c}.html`:"",me=fe?`items/${fe}`:"";return{id:c,displayName:X,filename:fe,filepath:me,externalUrl:$.dataset.externalUrl||"",obsidianUrl:$.dataset.obsidianUrl||"",anchorX:(K==null?void 0:K.clientX)??0,anchorY:(K==null?void 0:K.clientY)??0}}function M($,K){const c=document.createElement("button");return c.type="button",c.className="tile-context-menu__item",c.textContent=$,c.addEventListener("click",()=>{Ze(),typeof K=="function"&&K()}),c}function Ne($){if(!H)return;H.innerHTML="";const K=document.createElement("div");K.className="tile-context-menu__list",K.appendChild(M("File view",()=>de($))),typeof J=="function"&&K.appendChild(M("Edit",()=>J($.id))),typeof te=="function"&&$.id&&Xe.forEach(c=>{if(!(c!=null&&c.value))return;const X=c.name||c.value;K.appendChild(M(`Set color: ${X}`,()=>te($.id,c.value)))}),H.appendChild(K)}function De($,K){if(!H)return;const c=4;H.style.left=`${$+c}px`,H.style.top=`${K+c}px`,H.hidden=!1,H.setAttribute("aria-hidden","false"),H.classList.add("is-open");const X=H.getBoundingClientRect();let fe=X.left,me=X.top;X.right>window.innerWidth-c&&(fe=Math.max(c,window.innerWidth-X.width-c)),X.bottom>window.innerHeight-c&&(me=Math.max(c,window.innerHeight-X.height-c)),H.style.left=`${fe}px`,H.style.top=`${me}px`}async function de($){if(!l||!m||!C||!$)return;const K=++Ce,c=[];if(typeof J=="function"&&$.id&&c.push({label:"Edit",title:"Edit this item",onClick:()=>{Ve(),J($.id)}}),$.externalUrl&&c.push({label:"Open link ↗",title:$.externalUrl,onClick:()=>window.open($.externalUrl,"_blank","noopener")}),$.obsidianUrl&&c.push({label:"Open in Obsidian",title:$.obsidianUrl,onClick:()=>window.open($.obsidianUrl,"_blank","noopener")}),qe(c),$.id&&typeof _=="function"&&_($.id),m.textContent=$.displayName,C.innerHTML='<div class="item-preview__status">Loading…</div>',l.classList.remove("item-preview--has-frame"),l.classList.add("item-preview--expanded"),z($.anchorX,$.anchorY),!$.filepath){C.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',Y(ie.x,ie.y);return}try{const X=await fetch($.filepath,{cache:"no-cache"});if(!X.ok)throw new Error(`HTTP ${X.status}`);const fe=await X.text();if(K!==Ce)return;if(!fe.trim()){const Ke=ee?ee($.filename):$.filename;C.innerHTML=`<div class="item-preview__status">No content in <code>${Ke}</code>.</div>`,Y(ie.x,ie.y);return}const we=document.createElement("iframe");we.className="item-preview__frame",we.title=`${$.displayName} details`,we.srcdoc=fe,C.innerHTML="",C.appendChild(we),l.classList.add("item-preview--has-frame"),Y(ie.x,ie.y)}catch(X){if(K!==Ce)return;const fe=ee?ee($.displayName):$.displayName;C.innerHTML=`<div class="item-preview__status">No preview available for <strong>${fe}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${$.filepath}`,X),Y(ie.x,ie.y)}}function lt($,K){if(!K)return;$.preventDefault(),$.stopPropagation();const c=he(K,$);!c||!c.id||(typeof _=="function"&&_(c.id),Ne(c),De($.clientX,$.clientY))}function pe($){const K=$==null?void 0:$.target,c=H&&!H.hidden&&H.contains(K),X=l&&!l.hidden&&l.contains(K);!c&&!X&&Ve()}function ye(){!l||l.hidden||Y(ie.x,ie.y)}function Ie(){Ve()}return W&&W.addEventListener("click",Ve),{handleTileContextMenu:lt,hidePreview:Ve,hideMenu:Ze,handleDocumentClick:pe,handleWindowResize:ye,handleWindowScroll:Ie,updateColorPresets:$=>{Xe=Array.isArray($)?$:[]}}}function hr(r,l="series"){return(r||l).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||l}function vn(r,l="series"){const m=hr(r,l).replace(/\./g,"-");return m.replace(/-series$/i,"").replace(/-+$/,"")||m||hr(l,"series")}function gr(r,{seriesName:l,fallbackTitle:m="unknown"}={}){var J,te;const k=[r==null?void 0:r.seriesId,(J=r==null?void 0:r.data)==null?void 0:J.seriesId,r==null?void 0:r.apicurioArtifactId,l,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(te=r==null?void 0:r.data)==null?void 0:te.title,m].map(_=>(_??"").toString().trim()),W=k.findIndex(Boolean),ee=W!==-1?k[W]:"";return ee?(console.log("[Series] deriveSeriesId: picked base",{base:ee,sourceIndex:W,candidates:k}),vn(ee,m)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:m}),null)}function $t(r,{seriesName:l,fallbackTitle:m="unknown"}={}){if(!r||typeof r!="object")return null;const C=gr(r,{seriesName:l,fallbackTitle:m});return C?(r.seriesId=C,r.apicurioArtifactId||(r.apicurioArtifactId=C),C):null}function Ln(r,l={}){var k,W;if(!r)return null;const m=r.isSeries||((k=r.apicurioVersions)==null?void 0:k.length)>1||r.seriesId||((W=r.data)==null?void 0:W.seriesId)||r.apicurioArtifactId;if(!m&&!l.force)return null;const C=gr(r,l);return C||(m?vn(l.fallbackTitle||"unknown"):null)}const br={selectionDimOpacity:.2,selectionDimEnabled:!0},jn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,l=!0)=>{const m=Math.round((1-r)*100);return l?m===0?"Off":`${m}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function ti(r){return r===!0||r==="true"||r===1||r==="1"}function pl(r,{localBackend:l}={}){const m=l&&typeof l.getAutoReloadConfig=="function"&&l.getAutoReloadConfig(),C={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets};return m&&(C.autoReloadEnabled=!!m.enabled,C.autoReloadIntervalMs=m.intervalMs),C}function fl(r={},l){var mt,at,pt,Ae;if(!r||typeof r!="object")return{applied:[]};const m=[],{applyTheme:C,applyTileHoverScale:k,persistTileHoverScale:W,applySelectionDimEnabled:ee,persistSelectionDimEnabled:J,applySelectionDimOpacity:te,persistSelectionDimOpacity:_,applyTileCompactness:ae,persistTileCompactness:H,applyTitleWrapMode:ie,persistTitleWrapMode:Ce,applyTitleHoverWidthMultiplier:Xe,persistTitleHoverWidthMultiplier:Ze,applyTitleHoverTextPortion:qe,persistTitleHoverTextPortion:Ve,applyObsidianLinksEnabled:z,persistObsidianLinksEnabled:Y,applyObsidianLinkMode:he,persistObsidianLinkMode:M,applyObsidianVaultName:Ne,persistObsidianVaultName:De,applyAutoIdFromNameEnabled:de,persistAutoIdFromNameEnabled:lt,applySeriesNavDoubleClickWait:pe,persistSeriesNavDoubleClickWait:ye,applyCenterItems:Ie,persistCenterItems:$,localBackend:K,ui:c,refreshObsidianLinks:X,scheduleOverlaySync:fe,selection:me,select:we,clearStyles:Ke,drawLinks:xe,applyReusedHighlights:Oe,current:Qe}=l;if(r.theme){const it=((C==null?void 0:C(r.theme))||r.theme)==="dark";(mt=l.ui)!=null&&mt.themeToggle&&(l.ui.themeToggle.checked=it),(at=l.ui)!=null&&at.tabThemeToggle&&(l.ui.tabThemeToggle.checked=it),m.push("theme")}if(r.hoverScale!=null){const O=k(parseFloat(r.hoverScale));W(O),c!=null&&c.hoverScaleInput&&(c.hoverScaleInput.value=String(O)),c!=null&&c.hoverScaleValue&&(c.hoverScaleValue.textContent=jn.hoverScale(O)),me&&fe(),m.push("hoverScale")}if(r.selectionDimEnabled!=null){const O=ee(ti(r.selectionDimEnabled));J(O),c!=null&&c.selectionDimToggle&&(c.selectionDimToggle.checked=O),c!=null&&c.selectionDimInput&&(c.selectionDimInput.disabled=!O),c!=null&&c.selectionDimValue&&(c.selectionDimValue.textContent=jn.selectionDimming(Qe.selectionDimOpacity??br.selectionDimOpacity,O)),m.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const O=te(parseFloat(r.selectionDimOpacity));_(O),c!=null&&c.selectionDimInput&&(c.selectionDimInput.value=String(O)),c!=null&&c.selectionDimValue&&(c.selectionDimValue.textContent=jn.selectionDimming(O,Qe.selectionDimEnabled??br.selectionDimEnabled)),m.push("selectionDimOpacity")}if(r.tileCompactness!=null){const O=ae(parseFloat(r.tileCompactness));H(O),c!=null&&c.tileCompactnessInput&&(c.tileCompactnessInput.value=String(O)),c!=null&&c.tileCompactnessValue&&(c.tileCompactnessValue.textContent=jn.compactness(O)),me&&fe(),m.push("tileCompactness")}if(r.titleWrapMode){const O=ie(r.titleWrapMode);Ce(O),c!=null&&c.titleWrapInput&&(c.titleWrapInput.checked=O!=="nowrap"),m.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const O=Xe(parseFloat(r.titleHoverWidthMultiplier));Ze(O),c!=null&&c.titleWidthInput&&(c.titleWidthInput.value=String(O)),c!=null&&c.titleWidthValue&&(c.titleWidthValue.textContent=jn.titleWidth(O)),m.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const O=qe(parseFloat(r.titleHoverTextPortion));Ve(O),c!=null&&c.titleZoomInput&&(c.titleZoomInput.value=String(O)),c!=null&&c.titleZoomValue&&(c.titleZoomValue.textContent=jn.titleZoomPortion(O)),m.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const O=z(ti(r.obsidianLinksEnabled));Y(O),c!=null&&c.obsidianToggle&&(c.obsidianToggle.checked=O),(pt=c==null?void 0:c.obsidianModeInputs)==null||pt.forEach(it=>{it.disabled=!O}),c!=null&&c.obsidianVaultInput&&(c.obsidianVaultInput.disabled=!O),X==null||X(),m.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const O=he(r.obsidianLinkMode);M(O),(Ae=c==null?void 0:c.obsidianModeInputs)==null||Ae.forEach(it=>{it.checked=it.value===O}),X==null||X(),m.push("obsidianLinkMode")}if(r.obsidianVault!=null){const O=Ne(r.obsidianVault);De(O),c!=null&&c.obsidianVaultInput&&(c.obsidianVaultInput.value=O),X==null||X(),m.push("obsidianVault")}if(r.colorPresets&&(typeof l.setColorPresets=="function"&&l.setColorPresets(r.colorPresets),m.push("colorPresets")),r.autoIdFromName!=null){const O=de(ti(r.autoIdFromName));lt(O),c!=null&&c.autoIdToggle&&(c.autoIdToggle.checked=O),m.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const O=pe(parseInt(r.seriesNavDoubleClickMs,10));ye(O),c!=null&&c.seriesNavInput&&(c.seriesNavInput.value=String(O)),c!=null&&c.seriesNavValue&&(c.seriesNavValue.textContent=jn.seriesNavWait(O)),m.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&K&&typeof K.setAutoReloadEnabled=="function"){const O=ti(r.autoReloadEnabled);K.setAutoReloadEnabled(O),c!=null&&c.autoReloadToggle&&(c.autoReloadToggle.checked=O),c!=null&&c.autoReloadInput&&(c.autoReloadInput.disabled=!O),m.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&K&&typeof K.setAutoReloadInterval=="function"){const O=K.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));c!=null&&c.autoReloadInput&&(c.autoReloadInput.value=String(O)),c!=null&&c.autoReloadValue&&(c.autoReloadValue.textContent=jn.autoReloadInterval(O)),m.push("autoReloadIntervalMs")}if(r.centerItems!=null){const O=Ie==null?void 0:Ie(ti(r.centerItems));$==null||$(O),c!=null&&c.tabCenterToggle&&(c.tabCenterToggle.checked=O),m.push("centerItems")}if(r.showSecondaryLinks!=null){const O=ti(r.showSecondaryLinks);typeof l.setShowSecondaryLinks=="function"?l.setShowSecondaryLinks(O):l.showSecondaryLinks=O,c!=null&&c.secondaryLinksToggle&&(c.secondaryLinksToggle.checked=O),c!=null&&c.tabSecondaryLinksToggle&&(c.tabSecondaryLinksToggle.checked=O),me?we(me):(Ke(),xe()),m.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const O=ti(r.showReusedInMap);typeof l.setShowReusedInMap=="function"?l.setShowReusedInMap(O):l.showReusedInMap=O,c!=null&&c.reusedToggle&&(c.reusedToggle.checked=O),Oe==null||Oe(),m.push("showReusedInMap")}return{applied:m}}function ml(r,l){const m=new Blob([l],{type:"application/json"}),C=URL.createObjectURL(m),k=document.createElement("a");k.href=C,k.download=r,k.click(),URL.revokeObjectURL(C)}const Lo=typeof{url:Tn&&Tn.tagName.toUpperCase()==="SCRIPT"&&Tn.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function hl(r={}){console.log("[Blockscape] init");const l={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},m=document.getElementById("jsonBox"),C=document.querySelector(".blockscape-json-panel"),k=document.getElementById("app"),W=document.getElementById("overlay"),ee=document.getElementById("tabTooltip"),J=document.getElementById("modelList"),te=document.getElementById("itemPreview"),_=document.getElementById("urlForm"),ae=document.getElementById("urlInput"),H=document.getElementById("loadUrl"),ie=te.querySelector(".item-preview__title"),Ce=te.querySelector(".item-preview__body"),Xe=te.querySelector(".item-preview__actions"),Ze=te.querySelector(".item-preview__close"),qe=document.getElementById("downloadJson"),Ve=document.getElementById("shareModel"),z=document.getElementById("createVersion"),Y=document.getElementById("openInEditor"),he=document.getElementById("copyJson"),M=document.getElementById("copySeries"),Ne=document.getElementById("pasteJson"),De=document.getElementById("helpButton"),de=document.getElementById("newPanelButton"),lt=document.getElementById("newBlankButton"),pe=document.getElementById("shortcutHelp"),ye=document.getElementById("shortcutHelpList"),Ie=document.getElementById("shortcutHelpClose"),$=document.getElementById("shortcutHelpBackdrop"),K=document.getElementById("newPanel"),c=document.getElementById("newPanelClose"),X=document.getElementById("newPanelBackdrop"),fe=document.getElementById("search"),me=document.getElementById("searchResults"),we=document.getElementById("localBackendPanel"),Ke=document.getElementById("localBackendStatus"),xe=document.getElementById("localFileList"),Oe=document.getElementById("localDirSelect"),Qe=document.getElementById("refreshLocalFiles"),mt=document.getElementById("loadLocalFile"),at=document.getElementById("saveLocalFile"),pt=document.getElementById("saveLocalFileAs"),Ae=document.getElementById("localSavePath"),O="blockscape:editorPayload",it="blockscape:editorTransfer",Nt=document.title;we&&(we.hidden=!0),!l.localBackend&&we&&(we.hidden=!0),l.fileOpen||(mt&&(mt.hidden=!0),Oe&&(Oe.hidden=!0),Qe&&(Qe.hidden=!0),xe&&(xe.hidden=!0)),l.fileSave||(at&&(at.hidden=!0),pt&&(pt.hidden=!0),Ae&&(Ae.hidden=!0)),m.value=document.getElementById("seed").textContent.trim();let E=[],w=-1;const Re=rl({models:E,getActiveIndex:()=>w,setActive:_t,ensureModelMetadata:Cn,getModelId:ft,getSeriesId:Ln,ensureSeriesId:$t,getModelTitle:Je,computeJsonFingerprint:Po,uid:ri});let D=null,Te=new Map,Ht=new Map,G=null,ze=null,rt=null,st=null,yn=!0,Qt=!1,en=!1,Jn="map",yt=null,Ft=null,ni=!1,cn=null;const zn=2e3;let Ot=null,dn=null,tn=null,Yt=null,Wt=null,Rt=null,En=null,nn=null,Xt=null,Sn="",u=!1,b=null;const L=new Map;let T=null,y=null,R=[],Q=null;const q=30,ve=1e3,be="blockscape:hoverScale",ue=1.5,Fe=1,et=2.5,Me="blockscape:selectionDimOpacity",bt="blockscape:selectionDimEnabled",Ye=.2,wt=.05,Pe=1,ne="blockscape:titleWrap",Be="blockscape:titleHoverWidth",ct="blockscape:titleHoverTextPortion",kt="wrap",Et=1.3,kn=1,un=1.6,_n=.25,ii=0,ca=.6,Er="blockscape:tileCompactness",Zi=1,Sr=.75,Ir=1.25,kr="blockscape:obsidianLinksEnabled",_r="blockscape:obsidianLinkMode",Cr="blockscape:obsidianVault",da="title",No="id",Mo=da,xr="blockscape:autoReloadEnabled",Ar="blockscape:autoReloadIntervalMs",Qi=1e3,Tr=500,Lr=1e4,Nr="blockscape:autoIdFromName",Bo=!0,Mr="blockscape:colorPresets",Br="blockscape:centerItems",$r="blockscape:theme",wi="light",oi="dark",$o="cat:",Oo=!1;let vi=ue,Nn=Ye,Mn=!0,yi=Zi,ua=kt,Ei=Et,Si=_n,Ii=!1,eo=Mo,ki="",ai=Bo,to=wi,jt=[],on=Oo,_i=null;const Or="blockscape:seriesNavDoubleClickMs",no=900,Rr=300,Pr=4e3;let Bn=no;const $e={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null},Bl={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:Qi}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},Ge=l.localBackend?ql():Bl,Vr=l.localBackend?Ge.detect():Promise.resolve(!1);Re.hydrateConfig(),pa(Ul()),xi(Wl(),{silent:!0}),sc(),lc(),uc(),mc(),pc(),fc(),wc(),Ec(),yc(),Sc(),cc(),dc(),Fl(),zt();function ri(){return Math.random().toString(36).slice(2,10)}function $l(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(i=>{n+=String.fromCharCode(i)}),btoa(n)}function Ol(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new TextDecoder().decode(n)}function Rl(e){return $l(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Pl(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Ol(t)}const Dr=(e,t)=>ml(e,t);function Ur(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function Vl(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(o=>{if(typeof o=="string"&&o.trim()){n.push(o.trim());try{const a=new URL(o,window.location.origin).toString();a!==o.trim()&&n.push(a)}catch{}}});const i=new Set;for(const o of n)if(!i.has(o)){i.add(o);try{const a=await Bs(o),s=JSON.parse(a),d=Ur(s);if(d)return d}catch(a){console.warn("[Blockscape] initial settings fetch failed",o,a)}}return null}async function Dl(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];l.initialSettings&&t.push({type:"inline",snapshot:l.initialSettings}),l.initialSettingsUrl&&t.push({type:"url",url:l.initialSettingsUrl});let n=0;for(const i of t)try{const o=i.type==="inline"?Ur(i.snapshot):await Vl(i.url);if(!o)continue;const a=ts(o,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${i.type==="inline"?"inline config":i.url}.`))}catch(o){console.warn("[Blockscape] initial settings apply failed",o)}return n}function Ul(){if(typeof window>"u"||!window.localStorage)return wi;try{return window.localStorage.getItem($r)===oi?oi:wi}catch{return wi}}function Hl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem($r,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function pa(e){const t=e===oi?oi:wi;return to=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),Hl(t),to}function Hr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Br,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function Ci(e){return on=!!e,k&&(k.classList.toggle("is-center-mode",on),k.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",on)}),k.querySelectorAll(".tile-add").forEach(t=>{t.hidden=on,t.tabIndex=on?-1:0,t.setAttribute("aria-hidden",on?"true":"false")})),D&&(jo(),Gn()),on}function Fl(){if(typeof window>"u"||!window.localStorage)return Ci(Oo);try{const e=window.localStorage.getItem(Br);return e==null?Ci(Oo):Ci(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),Ci(Oo)}}function Fr(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Wr(e){const t=i=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(i||"");if(!Array.isArray(e))return io();const n=e.map(i=>({name:((i==null?void 0:i.name)||"").toString().trim()||"Custom",value:((i==null?void 0:i.value)||"").toString().trim()})).filter(i=>t(i.value));return n.length?n:io()}function io(){return[{name:"Black",value:ln.color.ink},{name:"White",value:ln.color.white},{name:"Red",value:ln.blockscape.revdep},{name:"Green",value:ln.color.success}]}function Wl(){if(typeof window>"u"||!window.localStorage)return io();try{const e=window.localStorage.getItem(Mr);if(!e)return io();const t=JSON.parse(e);return Wr(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),io()}}function jl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Mr,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function xi(e,{silent:t=!1}={}){return jt=Wr(e),jl(jt),!t&&typeof Ui=="function"&&Ui(jt),_i==null||_i(),jt}function Jl(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),i=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||i&&["1","true","yes","on"].includes(i.toLowerCase())}function Ro(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const i=si(e);if(!i)return;const o=E[w],a=si(o==null?void 0:o.sourcePath),s=t??(a&&a===i?ft(o):null),d=n??(a&&a===i?G:null),p=i.split("/").filter(Boolean).map(x=>encodeURIComponent(x)),h=s?encodeURIComponent(s):null,v=d?encodeURIComponent(d):null;try{const x=new URL(window.location.href),B=new URLSearchParams(x.search);B.delete("load"),B.delete("share");const A=["","server",...p,...h?[h]:[],...v?[v]:[]].join("/").replace(/\/+/g,"/");x.pathname=A,x.search=B.toString()?`?${B.toString()}`:"",x.hash="",window.history.replaceState({},document.title,x.toString())}catch(x){console.warn("[Blockscape] failed to update URL for server path",x)}}function zl(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),i=n.findIndex(V=>V.toLowerCase()==="server");if(i===-1)return null;const o=n.slice(i+1);if(!o.length)return null;const a=o.findIndex(V=>V.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=o.slice(0,a+1),d=o.slice(a+1),p=V=>{try{return decodeURIComponent(V)}catch{return V}},h=s.map(p),v=d.map(p),x=h.join("/"),B=si(x);if(!B)return null;const A=v[0]?v[0].trim():null,N=v[1]?v[1].trim():null;return{path:B,modelId:A||null,itemId:N||null}}function fa({itemId:e}={}){const t=E[w];t!=null&&t.sourcePath&&Ro(t.sourcePath,{modelId:ft(t),itemId:e===void 0?G:e})}function Gl(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function ql(){const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(S,j={}){console.log("[Blockscape][local-backend]",S,{...e(),...j})}if(Gl())return t("Disabled on github.io host"),we&&(we.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!Jl()||!we||!Ke)return t("Opt-in flag missing or panel unavailable"),we&&(we.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!we||!Ke)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let i=!1,o="",a=[],s=[],d="",p=new Map,h=V(),v=Le(),x=null,B=!1;const A=new Set;function N(){return A.size>0}function V(){if(typeof window>"u"||!window.localStorage)return!0;try{const S=window.localStorage.getItem(xr);return S==null?!0:S==="true"}catch{return!0}}function re(S){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(xr,S?"true":"false")}catch(j){console.warn("[Blockscape] auto-reload: failed to persist",j)}}function Le(){if(typeof window>"u"||!window.localStorage)return Qi;try{const S=window.localStorage.getItem(Ar);if(!S)return Qi;const j=parseInt(S,10);return Ee(j)}catch{return Qi}}function dt(S){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ar,String(S))}catch(j){console.warn("[Blockscape] auto-reload: failed to persist interval",j)}}function Ee(S){return Number.isFinite(S)?Math.min(Lr,Math.max(Tr,S)):Qi}function ke(S){if(!S)return"";const j=S.split("/").filter(Boolean);return j.pop(),j.join("/")}function ot(S,{error:j=!1}={}){Ke.textContent=S,Ke.style.color=j?ln.color.dangerStrong:"",t("Status",{text:S,error:j})}function Ue(S){return si(S)}function Ct(S){const j=Uo(S);return j?{payload:j,isSeries:!0}:{payload:S==null?void 0:S.data,isSeries:!1}}function Vt(){var j;if(w>=0&&((j=E[w])!=null&&j.sourcePath))return E[w].sourcePath;if(w<0)return"blockscape.bs";const S=Je(E[w])||"blockscape";return`${vn(S,"blockscape")}.bs`}function xt(){var S;Ae&&(Ae.placeholder=Vt(),(S=E[w])!=null&&S.sourcePath&&(Ae.value=E[w].sourcePath))}function Se(){if(!Oe)return;Oe.innerHTML="";const S=document.createElement("option");S.value="",S.textContent="All (~/blockscape)",Oe.appendChild(S),s.forEach(se=>{const le=document.createElement("option");le.value=se,le.textContent=se||"(root)",Oe.appendChild(le)});const j=s.includes(d)?d:"";Oe.value=j,d=j}function St(){if(!xe)return;xe.innerHTML="";const S=d?a.filter(j=>j.path.startsWith(`${d}/`)):a;if(!S.length){const j=document.createElement("option");j.disabled=!0,j.textContent="No .bs files found yet",xe.appendChild(j),xe.disabled=!0;return}xe.disabled=!1,S.forEach(j=>{const se=document.createElement("option");se.value=j.path;const le=j.mtimeMs?new Date(j.mtimeMs).toLocaleString():"";se.textContent=le?`${j.path} · ${le}`:j.path,xe.appendChild(se)}),o&&Array.from(xe.options).forEach(j=>{j.value===o&&(j.selected=!0)}),!xe.value&&xe.options.length&&(xe.options[0].selected=!0)}function In(S){if(!i||!xe||!S||!a.find(tt=>tt.path===S))return;const se=ke(S);se!==d&&(d=se,Se()),St(),Array.from(xe.options).forEach(tt=>{tt.selected=tt.value===S});const le=Array.from(xe.options).find(tt=>tt.value===S);le!=null&&le.scrollIntoView&&le.scrollIntoView({block:"nearest"}),Ae&&(Ae.value=S)}function Un(){x&&(clearInterval(x),x=null)}function At(){Un(),!(!i||!h||N())&&(x=setInterval(An,v))}function Zt(S){if(!S)return;const j=A.size;A.add(S),A.size!==j&&(t("Auto-reload paused",{reason:S}),At())}function Gt(S){if(!S)return;A.delete(S)&&(t("Auto-reload resumed",{reason:S}),At())}async function We(S){const j=E.findIndex(se=>se.sourcePath===S);if(j!==-1)try{const se=await fetch(`/api/file?path=${encodeURIComponent(S)}`,{cache:"no-store"});if(!se.ok)throw new Error(`HTTP ${se.status}`);const le=await se.json(),tt=JSON.stringify(le.data??le,null,2),Tt=Rn(tt,S,{seriesTitleOverride:`${S} series`});if(!Tt.length)return;const ge=Tt[0];if(ge.sourcePath=S,Cn(ge,{titleHint:Je(E[j]),idHint:ft(E[j])}),ge.isSeries){const nt=ge.title||Je(ge)||Je(E[j]),vt=vn(nt||"unknown");li(ge,vt),$t(ge,{seriesName:nt||"unknown",fallbackTitle:"unknown"})}E[j]={...E[j],...ge,title:ge.title||Je(ge),data:ge.data,sourcePath:S},j===w?(Pt(),Bt()):On(),console.log("[Blockscape] auto-reloaded model from",S)}catch(se){console.warn("[Blockscape] auto-reload failed for",S,se)}}async function An(){if(!(!i||!h||N()||B)){B=!0;try{const S=await fetch("/api/files",{cache:"no-store"});if(!S.ok)throw new Error(`HTTP ${S.status}`);const se=((await S.json()).files||[]).slice().sort((ge,nt)=>{const vt=(ge==null?void 0:ge.mtimeMs)||0,rn=(nt==null?void 0:nt.mtimeMs)||0;return vt===rn?(ge.path||"").localeCompare(nt.path||""):rn-vt}),le=new Map;se.forEach(ge=>le.set(ge.path,ge.mtimeMs||0));const tt=E.map((ge,nt)=>({path:ge.sourcePath,idx:nt})).filter(ge=>ge.path);for(const ge of tt){const nt=p.get(ge.path)||0;(le.get(ge.path)||0)>nt&&await We(ge.path)}a=se;const Tt=new Set;a.forEach(ge=>Tt.add(ke(ge.path))),s=Array.from(Tt).filter(ge=>ge!=="").sort(),p=le,Se(),St()}catch(S){console.warn("[Blockscape] auto-reload check failed",S)}finally{B=!1}}}function pi(S){h=!!S,re(h),At()}function Ji(S){return v=Ee(S),dt(v),At(),v}function an(S){i=!1,a=[],p=new Map,Un(),St(),we.hidden=!0,S&&ot(S,{error:!0}),t("Panel hidden",{message:S})}async function fi({silent:S=!1}={}){try{t("Health check start");const j=await fetch("/api/health",{cache:"no-store"});if(!j.ok)throw new Error(`HTTP ${j.status}`);const se=await j.json();if(i=!!(se!=null&&se.ok),!i)throw new Error("Health check failed");return we.hidden=!1,S||ot(se.root?`Local server ready (root: ${se.root})`:"Local server ready"),t("Health check ok",{payload:se}),!0}catch(j){return S||console.log("[Blockscape] local backend health failed",j),an("Local server unavailable"),!1}}async function pn(){if(i&&xe){ot("Loading files…");try{const S=await fetch("/api/files",{cache:"no-store"});if(!S.ok)throw new Error(`HTTP ${S.status}`);a=((await S.json()).files||[]).slice().sort((le,tt)=>{const Tt=(le==null?void 0:le.mtimeMs)||0,ge=(tt==null?void 0:tt.mtimeMs)||0;return Tt===ge?(le.path||"").localeCompare(tt.path||""):ge-Tt});const se=new Set;a.forEach(le=>{se.add(ke(le.path))}),s=Array.from(se).filter(le=>le!=="").sort(),d&&!se.has(d)&&(d=""),!d&&o&&(d=ke(o)),p=new Map(a.map(le=>[le.path,le.mtimeMs||0])),Se(),St(),ot(a.length?`Browsing ${a.length} file(s) in ~/blockscape`:"No .bs files in ~/blockscape yet")}catch(S){console.warn("[Blockscape] local backend refresh failed",S),an("Local server unavailable")}}}async function co(){i=!1,an(),ot("Checking for local server…");try{return t("Detect start"),await fi()?(xt(),await pn(),At(),!0):!1}catch(S){return i=!1,console.log("[Blockscape] local backend not detected",S),t("Detect failed",{err:S}),!1}}async function zi(){if(!i||!xe)return;const S=Array.from(xe.selectedOptions||[]).map(se=>se.value).filter(Boolean).sort((se,le)=>se.localeCompare(le));if(!S.length){alert("Select one or more files to load from ~/blockscape.");return}let j=null;for(const se of S)try{ot(`Loading ${se}…`);const le=await jr(se);j==null&&(j=(le==null?void 0:le.firstIndex)??null),o=se,Ro(se)}catch(le){console.error("[Blockscape] failed to load from local server",le),alert(`Local load failed for ${se}: ${le.message}`)}j!=null&&_t(j),ot(`Loaded ${S.length} file(s)`),St()}async function Gi(S,{statusPrefix:j="Saved to",updateInput:se=!0}={}){if(!i)return;if(w<0){alert("No active model to save.");return}const le=E[w],{payload:tt,isSeries:Tt}=Ct(le);if(!tt){alert("No model data to save.");return}const ge=Ue(S);if(!ge){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const nt=JSON.stringify(tt,null,2);ot(`Saving ${Tt?"series":"map"} to ${ge}…`);const rn=await fetch(`/api/file?path=${encodeURIComponent(ge)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:nt});if(!rn.ok)throw new Error(`HTTP ${rn.status}`);const qt=await rn.json();o=qt.path||ge,le.sourcePath=qt.path||ge,se&&Ae&&(Ae.value=qt.path||ge),Ro(qt.path||ge),ot(`${j} ${qt.path||ge}`),await pn()}catch(nt){console.error("[Blockscape] local save failed",nt),alert(`Local save failed: ${nt.message}`),an("Local server unavailable")}}async function qn(){var j;const S=Ue(Ae==null?void 0:Ae.value)||Ue((j=E[w])==null?void 0:j.sourcePath)||Vt();if(!S){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Gi(S,{statusPrefix:"Saved to"})}async function uo(){var le;if(!i)return;if(w<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const S=Ue((le=E[w])==null?void 0:le.sourcePath)||Vt(),j=window.prompt("Save active map as (under ~/blockscape):",S);if(j==null)return;const se=Ue(j);if(!se){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Gi(se,{statusPrefix:"Saved to"})}async function po(S,j,{refreshAfter:se=!0,statusPrefix:le="Saved to"}={}){if(!i)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(S)||S<0)return{ok:!1,error:"Invalid model index"};const tt=E[S],{payload:Tt,isSeries:ge}=Ct(tt);if(!Tt)return{ok:!1,error:"Model has no data"};const nt=Ue(j)||Ue(tt==null?void 0:tt.sourcePath)||Vt();if(!nt)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const vt=JSON.stringify(Tt,null,2);ot(`Saving ${ge?"series":"map"} to ${nt}…`);const qt=await fetch(`/api/file?path=${encodeURIComponent(nt)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:vt});if(!qt.ok)throw new Error(`HTTP ${qt.status}`);const Hn=await qt.json();return o=Hn.path||nt,tt.sourcePath=Hn.path||nt,S===w&&xt(),ot(`${le} ${Hn.path||nt}`),se&&await pn(),{ok:!0,path:Hn.path||nt}}catch(vt){return console.error("[Blockscape] local save failed",vt),an("Local server unavailable"),{ok:!1,error:vt.message}}}if(Qe&&(Qe.onclick=()=>pn()),mt&&(mt.onclick=()=>zi()),at&&(at.onclick=()=>qn()),pt&&(pt.onclick=()=>uo()),xe&&Ae&&(xe.addEventListener("change",()=>{const S=Array.from(xe.selectedOptions||[])[0];S!=null&&S.value&&(Ae.value=S.value)}),xe.addEventListener("dblclick",()=>{zi()})),Oe&&Oe.addEventListener("change",()=>{d=Oe.value||"",St()}),we){const S="local-files-panel-focus",j="local-files-panel-pointer";let se=!1,le=!1;we.addEventListener("focusin",()=>{se||(se=!0,Zt(S))}),we.addEventListener("focusout",tt=>{if(!se)return;const Tt=tt.relatedTarget;Tt&&we.contains(Tt)||(se=!1,Gt(S))}),we.addEventListener("pointerenter",()=>{le||(le=!0,Zt(j))}),we.addEventListener("pointerleave",()=>{le&&(le=!1,Gt(j))})}return{detect:co,refresh:pn,updateActiveSavePlaceholder:xt,isAvailable:()=>i,highlightSource:In,saveModelByIndex:po,getAutoReloadConfig:()=>({enabled:h,intervalMs:v,available:i}),setAutoReloadEnabled:pi,setAutoReloadInterval:Ji}}async function jr(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const i=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!i.ok)throw new Error(`HTTP ${i.status}`);const o=await i.json(),a=JSON.stringify(o.data??o,null,2),s=Rn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let d=null;return s.forEach((p,h)=>{if(p.sourcePath=e,p.isSeries&&!p.title){const B=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");p.title=B}const v=xn(p,{versionLabel:s.length>1?`${t} #${h+1}`:t});d==null&&(d=v)}),{firstIndex:d,total:s.length}}async function Jr(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function Kl(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Jt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function si(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function Yl(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Xl(e,t){const n=si(e);if(!n)return null;const i=n.split("/"),s=`${(i.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...i,s].filter(Boolean).join("/")}function ma(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function oo(){try{await Vr}catch{}return typeof(Ge==null?void 0:Ge.isAvailable)=="function"?Ge.isAvailable():!1}async function Zl(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Ql(e,t){const n=si(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const i=n.split("/"),a=(i.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const d=`${a}-${s}.bs`,p=[...i,d].filter(Boolean).join("/");if(!t.has(p))return p}return null}function ec(e,t="clipboard"){const n=Je(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",i=Jt(n),o=ma();return`${i}-${o}.bs`}function tc(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=Yl(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const i=vn(n||"unknown");return li(e,i),$t(e,{seriesName:n,fallbackTitle:n}),!0}function nc(e){return Number.isFinite(e)?Math.min(et,Math.max(Fe,e)):ue}function zt(){if(!k)return;const e=!!G||!!ze;k.classList.toggle("blockscape-has-selection",e),k.classList.toggle("blockscape-has-item-selection",!!G)}function Ai(e){return vi=nc(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",vi),vi}function ic(e){return Number.isFinite(e)?Math.min(Pe,Math.max(wt,e)):Ye}function Ti(e){Nn=ic(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Nn);const t=Mn?Nn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Nn}function oc(e){return Number.isFinite(e)?Math.min(Ir,Math.max(Sr,e)):Zi}function Li(e){return yi=oc(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",yi),yi}function ac(e){return Number.isFinite(e)?Math.min(un,Math.max(kn,e)):Et}function Ni(e){return Ei=ac(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",Ei),Ei}function rc(e){return Number.isFinite(e)?Math.min(ca,Math.max(ii,e)):_n}function Mi(e){return Si=rc(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Si),Si}function Bi(e){const t=e==="nowrap"?"nowrap":"wrap";ua=t;const n=t==="nowrap"?"nowrap":"normal",i=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",i),t}function zr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(be,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function sc(){if(typeof window>"u"||!window.localStorage)return Ai(ue);try{const e=window.localStorage.getItem(be);if(!e)return Ai(ue);const t=parseFloat(e);return Ai(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Ai(ue)}}function Gr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Me,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function lc(){if(typeof window>"u"||!window.localStorage)return Ti(Ye);try{const e=window.localStorage.getItem(Me);if(!e)return Ti(Ye);const t=parseFloat(e);return Ti(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Ti(Ye)}}function $i(e){Mn=!!e;const t=Mn?Nn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),k&&k.classList.toggle("blockscape-dimming-disabled",!Mn),Mn}function qr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(bt,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function cc(){if(typeof window>"u"||!window.localStorage)return $i(!0);try{const e=window.localStorage.getItem(bt);return e==null?$i(!0):$i(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),$i(!0)}}function Oi(e){return ai=!!e,ai}function Kr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Nr,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function dc(){if(typeof window>"u"||!window.localStorage)return Oi(Bo);try{const e=window.localStorage.getItem(Nr);return e==null?Oi(Bo):Oi(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Oi(Bo)}}function Yr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Er,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function uc(){if(typeof window>"u"||!window.localStorage)return Li(Zi);try{const e=window.localStorage.getItem(Er);if(!e)return Li(Zi);const t=parseFloat(e);return Li(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Li(Zi)}}function Xr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Be,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function pc(){if(typeof window>"u"||!window.localStorage)return Ni(Et);try{const e=window.localStorage.getItem(Be);if(!e)return Ni(Et);const t=parseFloat(e);return Ni(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Ni(Et)}}function Zr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ct,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function fc(){if(typeof window>"u"||!window.localStorage)return Mi(_n);try{const e=window.localStorage.getItem(ct);if(!e)return Mi(_n);const t=parseFloat(e);return Mi(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Mi(_n)}}function Qr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ne,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function mc(){if(typeof window>"u"||!window.localStorage)return Bi(kt);try{const e=window.localStorage.getItem(ne);return Bi(e||kt)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Bi(kt)}}function hc(e){return Number.isFinite(e)?Math.min(Pr,Math.max(Rr,e)):no}function Ri(e){return Bn=hc(e),Bn}function gc(e){yn=!!e}function bc(e){en=!!e}function es(){return{hoverScale:vi,selectionDimOpacity:Nn,selectionDimEnabled:Mn,tileCompactness:yi,titleWrapMode:ua,titleHoverWidthMultiplier:Ei,titleHoverTextPortion:Si,obsidianLinksEnabled:Ii,obsidianLinkMode:eo,obsidianVaultName:ki,autoIdFromNameEnabled:ai,seriesNavDoubleClickWaitMs:Bn,showSecondaryLinks:yn,centerItems:on,showReusedInMap:en,theme:to,colorPresets:jt}}function ts(e,{refreshObsidianLinks:t}={}){return fl(e,{applyTileHoverScale:Ai,persistTileHoverScale:zr,applySelectionDimEnabled:$i,persistSelectionDimEnabled:qr,applySelectionDimOpacity:Ti,persistSelectionDimOpacity:Gr,applyTileCompactness:Li,persistTileCompactness:Yr,applyTitleWrapMode:Bi,persistTitleWrapMode:Qr,applyTitleHoverWidthMultiplier:Ni,persistTitleHoverWidthMultiplier:Xr,applyTitleHoverTextPortion:Mi,persistTitleHoverTextPortion:Zr,applyObsidianLinksEnabled:Vi,persistObsidianLinksEnabled:os,applyObsidianLinkMode:Pi,persistObsidianLinkMode:is,applyObsidianVaultName:Di,persistObsidianVaultName:as,applyAutoIdFromNameEnabled:Oi,persistAutoIdFromNameEnabled:Kr,applySeriesNavDoubleClickWait:Ri,persistSeriesNavDoubleClickWait:ns,localBackend:Ge,ui:$e,refreshObsidianLinks:t,scheduleOverlaySync:Fi,selection:G,select:Mt,clearStyles:zo,drawLinks:Gn,applyReusedHighlights:xa,setShowSecondaryLinks:gc,setShowReusedInMap:bc,applyTheme:pa,setColorPresets:xi,applyCenterItems:Ci,persistCenterItems:Hr,current:es()})}function ns(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Or,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function wc(){if(typeof window>"u"||!window.localStorage)return Ri(no);try{const e=window.localStorage.getItem(Or);if(!e)return Ri(no);const t=parseInt(e,10);return Ri(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Ri(no)}}function vc(e){return e===No?No:da}function Pi(e){return eo=vc(e),eo}function is(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(_r,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function yc(){if(typeof window>"u"||!window.localStorage)return Pi(Mo);try{const e=window.localStorage.getItem(_r);return Pi(e||Mo)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),Pi(Mo)}}function Vi(e){return Ii=!!e,Ii}function os(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(kr,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function Ec(){if(typeof window>"u"||!window.localStorage)return Vi(!1);try{const e=window.localStorage.getItem(kr);return e==null?Vi(!1):Vi(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),Vi(!1)}}function Di(e){return ki=(e??"").toString().trim(),ki}function as(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Cr,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Sc(){if(typeof window>"u"||!window.localStorage)return Di("");try{const e=window.localStorage.getItem(Cr);return Di(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Di("")}}function Ic(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function kc(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const i=n.find(a=>a&&typeof a=="object")||n[0];return((i==null?void 0:i.title)??"").toString().trim()||`${t} series`}function li(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function _c(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||Vo(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const i=n.trim();if(!i)return!1;const o=Ln(e,{seriesName:i,fallbackTitle:i})||vn(i,i),a=window.prompt("Series ID (used for linking and downloads)",o);if(a==null)return!1;const s=vn(a.trim()||i,i||"series");return e.title=i,e.apicurioArtifactName=i,li(e,s),!0}function ha(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(i=>ha(i)).join(",")}]`:`{${Object.keys(e).sort().map(i=>`${JSON.stringify(i)}:${ha(e[i])}`).join(",")}}`}function rs(e){try{return ha(e)}catch{return""}}function Po(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=rs(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=rs(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const Cc=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function Cn(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const i=(e.title??"").toString().trim();e.title=i||t||"Untitled Model";const o=(e.id??"").toString().trim();if(o)e.id=o;else{const a=n||e.title||t||"model",s=Jt(a).replace(/\./g,"-");e.id=s||`model-${ri()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function xc(e){var s,d;const t=p=>{const h=(p??"").toString().trim();if(!h)return{base:"",suffix:null};const v=h.match(/^(.*?)-(\d+)$/);return{base:v?v[1]:h,suffix:v?Number.parseInt(v[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],i=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let o=t(i).base;if(!o)for(const p of n){if(p!=null&&p.isCategoryView)continue;const h=t(((d=p==null?void 0:p.data)==null?void 0:d.id)??(p==null?void 0:p.id)??"");if(h.base){o=h.base;break}}o||(o=Jt(Ln(e)||ga(e)||Je(e,"model")));let a=0;return n.forEach(p=>{var v;if(p!=null&&p.isCategoryView)return;const h=t(((v=p==null?void 0:p.data)==null?void 0:v.id)??(p==null?void 0:p.id)??"");h.base===o&&Number.isFinite(h.suffix)&&h.suffix>a&&(a=h.suffix)}),`${o}-${String(a+1).padStart(2,"0")}`}function Ac(e){return JSON.parse(JSON.stringify(e))}function Je(e,t="Untitled Model"){var i;return e&&(((i=e.data)==null?void 0:i.title)??e.title??"").toString().trim()||t}function Vo(e,t="Untitled Model"){var i;if(((i=e==null?void 0:e.apicurioVersions)==null?void 0:i.length)>1||(e==null?void 0:e.isSeries)){const o=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(o)return o;const a=ft(e);return a?`${a} series`:t}return Je(e,t)}function ft(e){var o;const t=Ln(e);if(t)return t;const n=(o=e==null?void 0:e.data)==null?void 0:o.id;return n&&n.toString().trim()||null}function ga(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function Tc(e){return e?e.toString().replace(/-series$/i,""):null}function ba(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<E.length;n++){const i=(ft(E[n])||"").toLowerCase(),o=(ga(E[n])||"").toLowerCase();if(t===i||t===o)return n}return-1}function ss(e){var d;if(e<0||e>=E.length||!m)return!0;const t=E[e],n=(m.value||"").trim();if(!n)return!0;let i;try{i=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Cn(i,{titleHint:Je(t),idHint:ft(t)});const o=Po(t.data),a=Po(i);if(o===a)return!0;t.data=i;const s=Pn(t);return s>=0&&((d=t.apicurioVersions)!=null&&d[s])&&(t.apicurioVersions[s].data=i),!0}function ls(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(i=>{i!=null&&i.id&&t.add(i.id)})),t}function wa(e){if(w<0||!e)return null;const t=E[w].data,n=(t==null?void 0:t.categories)||[];for(const i of n){const a=(i.items||[]).find(s=>s.id===e);if(a)return{category:i,item:a,modelData:t}}return null}function Lc(e,t){const n=wa(e);return n?(t?n.item.color=t:delete n.item.color,Pt(),Bt(),Mt(e),!0):!1}function Nc(e,t){const n=ls(t);let i=Jt(e||"item");if(!n.has(i))return i;const o=()=>ri().slice(0,4);for(;n.has(i);)i=`${Jt(e||"item")}-${o()}`;return i}function Mc(e="category",t){const n=(t==null?void 0:t.categories)||[],i=Jt(e||"category"),o=d=>n.some(p=>p.id===d);let a=i||`category-${ri()}`;if(!o(a))return a;let s=n.length+1;for(;o(`${i}-${s}`);)s+=1;return`${i}-${s}`}const ci=dl({findItemAndCategoryById:wa,collectAllItemIds:ls,updateItemReferences:cl,loadActiveIntoEditor:Pt,rebuildFromActive:Bt,select:e=>Mt(e),onSelectionRenamed:(e,t)=>{var n;G===e&&(G=t,zt()),((n=yt==null?void 0:yt.item)==null?void 0:n.id)===e&&(yt.item.id=t)},makeSlug:Jt,isAutoIdFromNameEnabled:()=>ai});function Bc({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:i,onCategoryRenamed:o}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=N=>{if(a.fields.errorEl){if(!N){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=N}},d=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},p=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var N,V;(N=a.fields.titleInput)==null||N.focus(),(V=a.fields.titleInput)==null||V.select()}))},h=({force:N}={})=>{var re,Le;if(!ai||!a.autoSyncEnabled||!((re=a.fields)!=null&&re.idInput)||!((Le=a.fields)!=null&&Le.titleInput)||!N&&a.idManuallyEdited)return;const V=Jt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=V},v=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const N=a.modelData.categories||[],V=N.find(ke=>ke.id===a.categoryId);if(!V)throw new Error("Category not found.");const re=(a.fields.idInput.value||"").trim();if(!re)throw new Error("ID is required.");const Le=(a.fields.titleInput.value||"").trim();if(N.some(ke=>ke.id===re&&ke.id!==V.id))throw new Error("Another category already uses that ID.");const Ee=V.id;return V.id=re,V.title=Le||V.id,Ee!==re&&typeof o=="function"&&o(Ee,re),t(),n(),i(re,{scrollIntoView:!0}),!0},x=()=>{try{return v(),d(),!0}catch(N){return console.warn("[CategoryEditor] save failed",N),s((N==null?void 0:N.message)||"Unable to save category."),!1}},B=()=>{if(a.wrapper)return a.wrapper;const N=document.createElement("div");N.className="item-editor-modal category-editor-modal",N.hidden=!0,N.setAttribute("role","dialog"),N.setAttribute("aria-modal","true");const V=document.createElement("div");V.className="item-editor-modal__backdrop",N.appendChild(V);const re=document.createElement("div");re.className="item-editor",N.appendChild(re);const Le=document.createElement("div");Le.className="item-editor__header";const dt=document.createElement("h2");dt.className="item-editor__title",dt.textContent="Edit category";const Ee=document.createElement("button");Ee.type="button",Ee.className="item-editor__close",Ee.setAttribute("aria-label","Close category editor"),Ee.textContent="×",Le.appendChild(dt),Le.appendChild(Ee),re.appendChild(Le);const ke=document.createElement("form");ke.className="item-editor__form",re.appendChild(ke);const ot=document.createElement("div");ot.className="item-editor__meta",ot.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',ke.appendChild(ot);const Ue=document.createElement("div");Ue.className="item-editor__error",Ue.hidden=!0,ke.appendChild(Ue);const Ct=(An,pi,Ji)=>{const an=document.createElement("label");an.className="item-editor__field";const fi=document.createElement("span");if(fi.className="item-editor__label",fi.textContent=An,an.appendChild(fi),pi.classList.add("item-editor__control"),an.appendChild(pi),Ji){const pn=document.createElement("div");pn.className="item-editor__hint",pn.textContent=Ji,an.appendChild(pn)}return an},Vt=document.createElement("input");Vt.type="text",ke.appendChild(Ct("Title",Vt,"Display label shown in the map."));const xt=document.createElement("input");xt.type="text",xt.required=!0,ke.appendChild(Ct("ID",xt,"Unique identifier for this category (used in URLs and references)."));const Se=document.createElement("div");Se.className="item-editor__checkbox";const St=document.createElement("label");St.className="item-editor__checkbox-row";const In=document.createElement("input");In.type="checkbox";const Un=document.createElement("span");Un.textContent="Sync ID while editing title";const At=document.createElement("div");At.className="item-editor__hint",At.textContent="Turn off to keep typing titles without changing the ID.",St.append(In,Un),Se.append(St,At),ke.appendChild(Se);const Zt=document.createElement("div");Zt.className="item-editor__actions";const Gt=document.createElement("button");Gt.type="submit",Gt.className="item-editor__action item-editor__action--primary",Gt.textContent="Save";const We=document.createElement("button");return We.type="button",We.className="item-editor__action",We.textContent="Cancel",Zt.appendChild(Gt),Zt.appendChild(We),ke.appendChild(Zt),ke.addEventListener("submit",An=>{An.preventDefault(),x()}),We.addEventListener("click",d),Ee.addEventListener("click",d),V.addEventListener("click",d),xt.addEventListener("input",()=>{a.idManuallyEdited=!0}),Vt.addEventListener("input",()=>h()),In.addEventListener("change",()=>{a.autoSyncEnabled=!!In.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,h({force:!0}))}),N.addEventListener("keydown",An=>{An.key==="Escape"&&(An.preventDefault(),d())}),document.body.appendChild(N),a.wrapper=N,a.fields={titleInput:Vt,idInput:xt,errorEl:Ue,metaLabel:ot.querySelector(".item-editor__meta-value"),syncCheckbox:In},N};return{open:N=>{if(!N||!B())return!1;const re=e(),dt=((re==null?void 0:re.categories)||[]).find(ke=>ke.id===N);if(!dt)return!1;a.categoryId=dt.id,a.modelData=re,a.idManuallyEdited=!1;const Ee=!!ai;return a.autoSyncEnabled=Ee,a.fields.metaLabel.textContent=dt.title||dt.id||"Category",a.fields.titleInput.value=dt.title||dt.id||"",a.fields.idInput.value=dt.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!Ee,!a.fields.idInput.value&&Ee&&h({force:!0}),s(""),p(),!0},hide:d,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const $c=Bc({getActiveModelData:()=>{var e;return(e=E[w])==null?void 0:e.data},loadActiveIntoEditor:Pt,rebuildFromActive:Bt,selectCategory:(e,t={})=>Vn(e,t),onCategoryRenamed:(e,t)=>{ze===e&&(ze=t,zt())}}),{handleTileContextMenu:Oc,hidePreview:di,handleDocumentClick:Rc,handleWindowResize:Pc,handleWindowScroll:Vc,updateColorPresets:Ui}=ul({menuEl:document.getElementById("tileContextMenu"),previewEl:te,previewTitleEl:ie,previewBodyEl:Ce,previewActionsEl:Xe,previewCloseEl:Ze,escapeHtml:so,onEditItem:e=>ci.open(e),onChangeColor:(e,t)=>Lc(e,t),selectItem:e=>Mt(e),colorPresets:jt});function Do(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const i={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[i],e.apicurioActiveVersionIndex=0;const o=e.title||Je(e);return $t(e,{seriesName:o,fallbackTitle:o}),e.isSeries=!0,e}function Dc({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=Jt(`${e||"blank"}-${ma()}`),i={id:n,title:t,categories:[],abstract:""};return e&&(i.seriesId=e),Cn(i,{titleHint:t,idHint:n}),i}function Uc(){const t=`Blank series ${ma()}`,n=vn(t,"blank-series"),i=Dc({seriesId:n,mapTitle:"Blank map"}),o={id:n,title:t,apicurioArtifactName:t,data:i,apicurioVersions:[{version:"1",data:i,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return li(o,n),$t(o,{seriesName:t,fallbackTitle:t}),o}function Hc(){const e=Uc(),t=xn(e,{versionLabel:"blank"});return _t(t),Ho(),$n("Blank series created. Add categories and tiles to start.",2600),t}function xn(e,{versionLabel:t,createdOn:n}={}){var p,h,v;if(e!=null&&e.isSeries||((p=e==null?void 0:e.apicurioVersions)==null?void 0:p.length)>1){const x=e.title||Je(e);$t(e,{seriesName:x,fallbackTitle:x}),Fo(e)}const i=ft(e);if(!i)return Do(e,{versionLabel:t||"1",createdOn:n}),E.push(e),E.length-1;const o=E.findIndex(x=>ft(x)===i);if(o===-1)return Do(e,{versionLabel:t||"1",createdOn:n}),E.push(e),E.length-1;const a=E[o];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(v=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:v.createdOn}],a.apicurioActiveVersionIndex=0;const x=a.title||Je(a);$t(a,{seriesName:x,fallbackTitle:x})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=Je(e)||a.title,a.isSeries=!0;const d=a.title||Je(a);return $t(a,{seriesName:d,fallbackTitle:d}),o}function cs({versionLabel:e}={}){var d;if(w<0||!E[w])throw new Error("Load or select a model before creating a version.");const t=E[w];Do(t,{versionLabel:"1"});const n=xc(t);let i;try{i=Ac(t.data)}catch(p){throw console.warn("[Blockscape] failed to clone active model for versioning",p),new Error("Could not copy the current model.")}n&&(i.id=n),Cn(i,{titleHint:Je(t),idHint:ft(t)||Ln(t)});const a={version:e||String((((d=t.apicurioVersions)==null?void 0:d.length)||0)+1),data:i,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=i,t.isSeries=!0;const s=t.title||Je(t);return $t(t,{seriesName:s,fallbackTitle:s}),w}function va(){const e=w>=0&&E[w]?E[w]:null,t=ft(e);document.title=t?`${t}-blockscape`:Nt}function Uo(e){if(!e)return null;Fo(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||Je(e);return $t(e,{seriesName:n,fallbackTitle:n}),t.filter((o,a)=>{var p;const s=((o==null?void 0:o.version)??"").toString().trim(),d=(((p=o==null?void 0:o.data)==null?void 0:p.id)??(o==null?void 0:o.id)??"").toString().trim();return o!=null&&o.isCategoryView||s.startsWith($o)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:d}),!1):!0}).map(o=>o&&typeof o=="object"&&"data"in o?o.data:o)}function Fc(){const e=E[w],t=Uo(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function ds(e="shortcut",t=!1){const n=m.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const i=E[w],o=t?Uo(i):null,a=!!o,s=a?JSON.stringify(o,null,2):n,d=Ln(i),p=ft(i),h=d||p||Je(i,"blockscape"),v=a?"-series":"",x=`${Jt(h)}${v}.bs`;return Dr(x,s),console.log(`[Blockscape] saved JSON (${e}):`,x),!0}const Wc=ln.palette.letter,jc=ln.palette.letterFallback;function us(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Wc[n]||jc}function Jc(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(p=>p+p).join(""):t,i=parseInt(n,16),o=i>>16&255,a=i>>8&255,s=i&255;return .2126*Math.pow(o/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?ln.color.ink:ln.color.white}function zc(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function ya(){if(Wt)return;Wt=document.createElement("div"),Wt.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",Rt=document.createElement("span"),Rt.className="series-nav-notice__text",Wt.appendChild(e),Wt.appendChild(Rt),document.body.appendChild(Wt)}function Ea(){En&&(clearTimeout(En),En=null),Wt&&Wt.classList.remove("is-visible"),Rt&&(Rt.textContent="")}function Hi(){Ot=null,dn&&(clearTimeout(dn),dn=null),Ea()}function Sa(){tn=null,Yt&&(clearTimeout(Yt),Yt=null),Ea()}function Gc(e,t){var i;if(!((i=e==null?void 0:e.apicurioVersions)!=null&&i[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function qc(e,t,n){ya(),Ot={id:e,targetVersionIndex:t},dn&&clearTimeout(dn),dn=setTimeout(()=>{dn=null,Hi()},Bn);const i=Gc(n,t);$n(`Click again to open ${i} in this series.`,Bn)}function Kc(e,t){ya(),tn={id:e,targetIndex:t},Yt&&clearTimeout(Yt),Yt=setTimeout(()=>{Yt=null,Sa()},Bn);const n=Vo(E[t]);$n(`Click again to open "${n}".`,Bn)}function $n(e,t=zn,n=null){if(ya(),Rt.textContent="",Rt.appendChild(document.createTextNode(e)),n){const i=document.createTextNode(" "),o=document.createElement("a");o.href=n,o.target="_blank",o.rel="noopener",o.textContent=n,Rt.appendChild(i),Rt.appendChild(o)}Wt.classList.add("is-visible"),En&&clearTimeout(En),En=setTimeout(()=>Ea(),t)}function Yc(){ye&&(ye.innerHTML="",Cc.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((o,a)=>{if(a>0){const d=document.createElement("span");d.className="shortcut-help__or",d.textContent="or",n.appendChild(d)}const s=document.createElement("div");s.className="shortcut-help__combo",o.forEach((d,p)=>{if(p>0){const v=document.createElement("span");v.className="shortcut-help__sep",v.textContent="+",s.appendChild(v)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=d,s.appendChild(h)}),n.appendChild(s)});const i=document.createElement("div");i.className="shortcut-help__desc",i.textContent=e.description,t.appendChild(n),t.appendChild(i),ye.appendChild(t)}),ni=!0)}function Xc(){return!!pe&&pe.hidden===!1}function Zc(){if(!pe)return;ni||Yc(),cn=document.activeElement,pe.hidden=!1,pe.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=pe.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ia(){if(!pe||pe.hidden)return;pe.hidden=!0,pe.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=cn;e!=null&&e.focus?e.focus({preventScroll:!0}):De!=null&&De.focus&&De.focus({preventScroll:!0})}function Qc(){if(!K)return;K.hidden=!1,K.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=K.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Ho(){!K||K.hidden||(K.hidden=!0,K.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),de!=null&&de.focus&&de.focus({preventScroll:!0}))}let ka=!1;function Fi(){ka||(ka=!0,requestAnimationFrame(()=>{ka=!1,jo(),Gn()}))}let ps=!1;function fs(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function ed(e){const t=fs(e);if(!t.length){k.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}k.querySelectorAll(".tile").forEach(n=>{var s;const i=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),o=(n.dataset.id||"").toLowerCase(),a=t.every(d=>i.includes(d)||o.includes(d));n.style.opacity=a?"1":"0.2"})}function td(e){const t=fs(e);if(!t.length)return[];const n=[];return E.forEach((i,o)=>{var h;const a=Vo(i),s=ft(i)||"",d=`${a} ${s}`.toLowerCase();t.every(v=>d.includes(v))&&n.push({type:"model",modelIndex:o,modelTitle:a,modelId:s}),(Array.isArray((h=i.data)==null?void 0:h.categories)?i.data.categories:[]).forEach(v=>{const x=(v.title||v.id||"").toString();(v.items||[]).forEach(B=>{const A=(B.name||B.id||"").toString(),N=`${A} ${B.id||""} ${x}`.toLowerCase();t.every(V=>N.includes(V))&&n.push({type:"item",modelIndex:o,modelTitle:a,modelId:s,itemId:B.id,itemName:A,categoryTitle:x})})})}),n.slice(0,q)}function ms(e){if(!me)return;me.innerHTML="";const t=(e||"").toString();if(!t.trim()){me.hidden=!0;return}if(!E.length){const i=document.createElement("div");i.className="search-results__empty",i.textContent="Load models to search",me.appendChild(i),me.hidden=!1;return}const n=td(t);if(!n.length){const i=document.createElement("div");i.className="search-results__empty",i.textContent="No matches yet",me.appendChild(i),me.hidden=!1;return}n.forEach(i=>{const o=document.createElement("button");o.type="button",o.className="search-result",o.dataset.modelIndex=String(i.modelIndex),i.itemId&&(o.dataset.itemId=i.itemId),i.type&&(o.dataset.type=i.type),i.modelIndex===w&&(!i.itemId||G===i.itemId)&&o.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=i.type==="model"?i.modelTitle:i.itemName||i.itemId||"Item",a.appendChild(s);const d=document.createElement("span");d.className="search-result__badge",d.textContent=i.type==="item"?i.categoryTitle||"Item":"Model",a.appendChild(d);const p=document.createElement("div");p.className="search-result__meta";const h=document.createElement("span");if(h.textContent=i.modelId?`${i.modelTitle} · ${i.modelId}`:i.modelTitle,p.appendChild(h),i.type==="item"&&i.itemId){const v=document.createElement("span");v.textContent=`Item ID: ${i.itemId}`,p.appendChild(v)}else if(i.type==="model"){const v=document.createElement("span");v.textContent="Matches model title",p.appendChild(v)}o.appendChild(a),o.appendChild(p),me.appendChild(o)}),me.hidden=!1}function hs(e){ed(e||""),ms(e||"")}function nd(e){!e||!Number.isInteger(e.modelIndex)||(_t(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(w!==e.modelIndex)return;const t=(n=Te.get(e.itemId))==null?void 0:n.el;t&&(Mt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function _t(e){var t;if(di(),Hi(),yt=null,Ft=null,ze=null,st=null,e<0||e>=E.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(u=!0,w=e,console.log("[Blockscape] active model:",Je(E[e]),"(index",e+" )"),typeof(Ge==null?void 0:Ge.highlightSource)=="function"){const n=((t=E[e])==null?void 0:t.sourcePath)||null;Ge.highlightSource(n)}va(),On(),Pt(),Bt(),fe&&hs(fe.value||""),Ge.updateActiveSavePlaceholder(),Re.updateAvailability(),fa()}function On(){if(J.innerHTML="",!E.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",J.appendChild(e);return}E.forEach((e,t)=>{var x;const n=document.createElement("li");n.className="model-nav-item";const i=document.createElement("button");i.type="button",i.className="model-nav-button"+(t===w?" is-active":""),i.dataset.index=String(t),i.setAttribute("aria-current",t===w?"true":"false");const o=document.createElement("span");o.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=Vo(e),o.appendChild(a);const s=Tc(ga(e)||ft(e));if(s){const B=document.createElement("span");B.className="model-nav-id",B.textContent=s,o.appendChild(B)}const d=Array.isArray((x=e.data)==null?void 0:x.categories)?e.data.categories:[],p=d.reduce((B,A)=>B+(A.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const v=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";h.textContent=`${d.length} cat · ${p} items${v}`,i.appendChild(o),i.appendChild(h),n.appendChild(i),J.appendChild(n)}),Re.updateAvailability()}function Pt(){if(w<0){m.value="",M&&(M.disabled=!0);return}const e=E[w];m.value=JSON.stringify(e.data,null,2),M&&(M.disabled=!Uo(e))}function id(e){try{return JSON.parse(e)}catch{return null}}function gs(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function od(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,d)=>{const p=s==null?void 0:s.data;if(!p||!Array.isArray(p.categories))return;const h=Je(p,`Map ${d+1}`),v=(p.id??"").toString().trim()||Jt(h||`map-${d+1}`),x=Jt(v||h||`map-${d+1}`);p.categories.forEach(B=>{const A=((B==null?void 0:B.id)??"").toString().trim();if(!A)return;n.has(A)||n.set(A,{catTitle:B.title||A,sources:[]});const N=n.get(A);!N.catTitle&&(B.title||A)&&(N.catTitle=B.title||A),N.sources.push({category:B,mapId:v,mapTitle:h,mapSlug:x,versionIndex:d})})});const i=Ln(e)||null,o=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||Je(e,"Series"),a=[];return n.forEach((s,d)=>{var B;if((((B=s.sources)==null?void 0:B.length)||0)<2)return;const p=s.catTitle||d,h=new Set,v=s.sources.map(A=>{var dt;let V=A.mapSlug||Jt(A.mapTitle||A.mapId)||`map-${A.versionIndex+1}`;h.has(V)&&(V=`${V}-${A.versionIndex+1}`),h.add(V);const re=new Map,Le=(((dt=A.category)==null?void 0:dt.items)||[]).map((Ee,ke)=>{const ot=((Ee==null?void 0:Ee.id)??"").toString().trim()||`item-${ke+1}`,Ue=`${V}-${ot}`;re.set(ot,Ue);const Ct={...Ee,id:Ue};return Ct.deps=Array.isArray(Ee==null?void 0:Ee.deps)?[...Ee.deps]:[],Ct});return Le.forEach(Ee=>{Ee.deps=(Ee.deps||[]).map(ke=>re.get(ke)).filter(Boolean)}),{id:V,title:A.mapTitle||A.mapId||`Map ${A.versionIndex+1}`,items:Le}}),x={id:Jt(`${d}-category-view`),title:p,abstract:`Items from "${p}" across ${s.sources.length} maps in this series${o?` (${o})`:""}.`,categories:v};i&&(x.seriesId=i),Cn(x,{titleHint:p,idHint:`${i||"series"}-${d}`}),a.push({version:`${$o}${d}`,data:x,isCategoryView:!0,categoryViewKey:d})}),a}function bs(e){var i;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${$o}${e.categoryViewKey}`;const t=(((i=e.data)==null?void 0:i.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function Fo(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=bs(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(d=>!(d!=null&&d.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Pn(e),e.apicurioVersions.length-1));const d=e.apicurioVersions[e.apicurioActiveVersionIndex];return d!=null&&d.data&&(e.data=d.data),e}const i=od({...e,apicurioVersions:n});e.apicurioVersions=[...n,...i];let o=e.apicurioVersions.findIndex(d=>bs(d)===t);o===-1&&(o=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(o,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function ad(e,t="Pasted",n={}){const i=Array.isArray(e)?e:[];if(!i.length)return[];const o=i.map((v,x)=>!v||typeof v!="object"?null:(Cn(v,{titleHint:`${t} #${x+1}`}),{obj:v,idx:x})).filter(Boolean);if(!o.length)return[];const a=o[0].obj,{seriesTitleOverride:s}=n;let d=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const p={id:ri(),title:d,data:a,apicurioVersions:o.map(({obj:v,idx:x})=>({version:String(x+1),data:v})),apicurioActiveVersionIndex:0,isSeries:!0},h=$t(p,{seriesName:d,fallbackTitle:d});return h&&(p.id=h),Fo(p),[p]}function ws(e,t="Pasted",n={}){return Array.isArray(e)?ad(e,t,n):!e||typeof e!="object"?[]:(Cn(e,{titleHint:`${t} #1`}),[{id:ri(),title:e.title||`${t} #1`,data:e}])}function Rn(e,t="Pasted",n={}){const o=(gs(typeof e=="string"?e:"")||"").trim();if(!o)return[];const a=id(o);if(a){let d=n;if(Array.isArray(a)&&n.promptForSeriesName){const h=kc(a,t),v=Ic(h);d={...n,promptForSeriesName:!1,seriesTitleOverride:v||h}}const p=ws(a,t,d);if(p.length)return p}return o.split(/^\s*(?:---|%%%)\s*$/m).map(d=>d.trim()).filter(Boolean).map((d,p)=>{const h=JSON.parse(d);return Cn(h,{titleHint:`${t} #${p+1}`}),{id:ri(),title:h.title||`${t} #${p+1}`,data:h}})}function rd(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function ui(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!rd(e)}function sd(e){if(!e)return!1;const n=(gs(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function vs(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(O)}catch(o){return console.warn("[Blockscape] failed to access editor payload",o),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(o){console.warn("[Blockscape] invalid payload JSON",o);try{localStorage.removeItem(O)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(O)}catch(o){console.warn("[Blockscape] failed to clear editor payload",o)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=Rn(t.text,t.title||"Editor Export")}catch(o){return console.warn("[Blockscape] could not parse payload text",o),null}if(!n.length)return null;let i=null;return n.forEach(o=>{const a=xn(o,{versionLabel:"editor"});i==null&&(i=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:i,count:n.length}}function ys(e="storage"){const t=vs();return!t||typeof t.index!="number"?!1:(_t(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function ld(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let i;try{const s=Pl(t);i=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!i||typeof i!="object"||i.data==null)return console.warn("[Blockscape] share payload missing data"),null;const o=ws(i.data,i.title||"Shared Model");if(!o.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return o.forEach(s=>{const d=s.isSeries?i.title||s.title:null,p=xn({...s,apicurioArtifactName:d||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=p)}),a}async function cd(){const e=zl();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:i}=e;try{if(!await oo())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await jr(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(Ge==null?void 0:Ge.highlightSource)=="function"&&Ge.highlightSource(t);let s=a.firstIndex;if(n){const d=ba(n);d!==-1&&(s=d)}return{modelIndex:s,itemId:i||null,modelId:n||null}}return null}catch(o){return console.warn("[Blockscape] server-path autoload failed",o),null}}async function dd(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const i=new URLSearchParams(window.location.search);i.has("load")&&(t=i.get("load"))}if(!t)return null;try{const i=await Aa(t);return typeof i=="number"?i:null}catch(i){return console.warn("[Blockscape] load param failed",i),null}}function ud(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,i=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{i.add(s.id);const d=new Set(s.deps||[]);t.set(s.id,d),d.forEach(p=>{n.has(p)||n.set(p,new Set),n.get(p).add(s.id)})}));const o=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&o.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:o,seen:i}}function pd(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),i=44;n.width=i,n.height=i;const o=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=us(e,t),d=Jc(s);return o.fillStyle=s,o.beginPath(),o.arc(i/2,i/2,i/2-2,0,2*Math.PI),o.fill(),o.strokeStyle="rgba(0,0,0,0.15)",o.lineWidth=1,o.stroke(),o.fillStyle=d,o.font=`bold ${i*.5}px system-ui, -apple-system, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(a,i/2,i/2),n.toDataURL("image/png")}function Pn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Es(e){const t=Pn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Ss(e,t="active"){return Ln(e)||ft(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function fd(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,i)=>{var s,d;const o=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();o&&t.set(o,i);const a=(((d=n==null?void 0:n.data)==null?void 0:d.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,i)}),t}function md(e,t){if(!e||!t)return null;const n=new Set,i=o=>{const a=(o??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(Jt(a)))};i(e.id),i(e.title);for(const o of n)if(t.has(o))return t.get(o);for(const o of n){const a=o.toLowerCase();for(const[s,d]of t.entries())if(s.toLowerCase()===a)return d}return null}const Is=new WeakMap;function hd(e,t){var Ue;if(!((Ue=e==null?void 0:e.apicurioVersions)!=null&&Ue[t]))return null;const n=e.apicurioVersions[t],i=n.data,o=Po(i),a=Is.get(n);if(a&&a.fingerprint===o)return a.dataUrl;const s=160,d=160,p=document.createElement("canvas");p.width=s,p.height=d;const h=p.getContext("2d"),v=Fr("--color-surface-ghost")||ln.color.surfaceGhost,x=Fr("--color-border-muted")||ln.color.borderMuted;h.fillStyle=v,h.fillRect(0,0,s,d),h.strokeStyle=x,h.strokeRect(.5,.5,s-1,d-1);const B=8,A=8,N=4,V=Array.isArray(i==null?void 0:i.categories)?i.categories:[],re=Math.max(V.length,1),Le=s-N*2,dt=N*3,Ee=re>1?Math.min(dt,Le/(re-1)):0,ke=re>1?(s-Ee*(re-1))/2:s/2;V.forEach((Ct,Vt)=>{const xt=ke+Vt*Ee,Se=Array.isArray(Ct.items)?Ct.items:[],St=Math.max(Se.length,1),In=d-B-A-N*2,Un=St>1?Math.min(N*3,In/(St-1)):0;Se.forEach((At,Zt)=>{const Gt=d-A-N-Zt*Un;h.beginPath(),h.arc(xt,Gt,N,0,Math.PI*2);const We=us(At.name||At.id||"",At.color);h.fillStyle=We,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const ot=p.toDataURL("image/png");return Is.set(n,{fingerprint:o,dataUrl:ot}),ot}function Wo(e,t){var d;if(Hi(),e<0||e>=E.length)return!1;const n=E[e];if(!((d=n==null?void 0:n.apicurioVersions)!=null&&d.length)||!ss(e))return!1;const o=n.apicurioVersions.length,a=(t%o+o)%o,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,u=!0,G=null,rt=null,zt(),Pt(),Bt(),!0):!1}function _a(e){var i;if(!e||w<0)return!1;const t=E[w];if(!((i=t==null?void 0:t.apicurioVersions)!=null&&i.length))return!1;const n=Pn(t);return n===-1?!1:Wo(w,n+e)}function gd(e,t){if(Hi(),e<0||e>=E.length)return!1;const n=E[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!ss(e))return!1;const i=Math.min(Math.max(t,0),n.apicurioVersions.length-1),o=Pn(n),[a]=n.apicurioVersions.splice(i,1);if(!a)return!1;let s=o;i===o?s=Math.min(i,n.apicurioVersions.length-1):i<o&&(s=Math.max(0,o-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const d=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(d==null?void 0:d.data)||n.data,n.isSeries=n.apicurioVersions.length>1,_t(e),!0}function bd(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,l.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const i=document.createElement("div");i.className="version-nav__title",i.textContent=e.apicurioArtifactName||e.apicurioArtifactId||ft(e)||"Artifact",i.title="Double-click to rename this series",i.setAttribute("role","button"),i.tabIndex=0,i.addEventListener("dblclick",()=>{var Le;const V=E[w];!((Le=V==null?void 0:V.apicurioVersions)!=null&&Le.length)||!_c(V)||(On(),Pt(),Bt())}),n.appendChild(i);const o=document.createElement("div");o.className="version-nav__status";const a=Pn(e),s=Es(e)||"latest";o.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(o);const d=document.createElement("div");d.className="version-nav__controls";const p=document.createElement("button");p.type="button",p.className="version-nav__button",p.textContent="Previous",p.addEventListener("click",()=>_a(-1));const h=document.createElement("button");h.type="button",h.className="version-nav__button",h.textContent="Next",h.addEventListener("click",()=>_a(1)),d.appendChild(p),d.appendChild(h),n.appendChild(d);const v=document.createElement("div");v.className="version-nav__thumbs",e.apicurioVersions.forEach((V,re)=>{var Vt,xt;const Le=document.createElement("button");Le.type="button",Le.className="version-nav__thumb",V!=null&&V.isCategoryView&&Le.classList.add("version-nav__thumb--category"),re===a&&Le.classList.add("is-active");const dt=hd(e,re);if(dt){const Se=document.createElement("img");Se.src=dt,Se.alt=`Version ${re+1}`,Le.appendChild(Se)}const Ee=document.createElement("div");Ee.className="version-nav__thumb-label";const ke=document.createElement("span");ke.className="version-nav__thumb-label-text";const ot=(((Vt=V==null?void 0:V.data)==null?void 0:Vt.id)??(V==null?void 0:V.id)??"").toString().trim();let Ue=ot||(V!=null&&V.version?`v${V.version}`:`${re+1}`),Ct=ot||Ue;if(V!=null&&V.isCategoryView){const Se=((xt=V.data)==null?void 0:xt.title)||V.categoryViewKey||Ue||"Category";Ue=Se,Ct=`Category view: ${Se}`,Le.dataset.computed="true"}if(ke.textContent=Ue,Ee.title=Ct,Ee.appendChild(ke),Le.appendChild(Ee),_d(Ee,ke),e.apicurioVersions.length>1&&!(V!=null&&V.isCategoryView)){const Se=document.createElement("span");Se.className="version-nav__thumb-remove",Se.title=`Remove ${Ue} from this series`,Se.setAttribute("aria-label",`Remove ${Ue} from this series`),Se.setAttribute("role","button"),Se.tabIndex=-1,Se.textContent="×",Se.addEventListener("click",St=>{St.stopPropagation(),St.preventDefault(),window.confirm(`Remove ${Ue} from this series?`)&&gd(w,re)}),Le.appendChild(Se)}Le.addEventListener("click",()=>Wo(w,re)),xd(Le,V),v.appendChild(Le)});const x=document.createElement("button");x.type="button",x.className="version-nav__thumb version-nav__thumb--add",x.title="Create a new version from this map",x.addEventListener("click",()=>{try{const V=cs({versionLabel:"manual"});_t(V)}catch(V){alert((V==null?void 0:V.message)||"Unable to create a new version right now.")}});const B=document.createElement("span");B.className="version-nav__thumb-add-icon",B.textContent="+",x.appendChild(B),v.appendChild(x),n.appendChild(v);const A=Ss(e,"active"),N=L.get(A);return typeof N=="number"&&!Number.isNaN(N)&&requestAnimationFrame(()=>{v.scrollLeft=N}),v.addEventListener("scroll",()=>{L.set(A,v.scrollLeft)}),n}function ao(){var Ws,js;if(!D)return;const e=w>=0&&E[w]?E[w]:null,t=k&&k.querySelector?k.querySelector(".version-nav__thumbs"):null;if(t&&e){const f=Ss(e,w);L.set(f,t.scrollLeft)}Dn(),Array.isArray(D.m.categories)||(D.m.categories=[]),console.log("[Blockscape] rendering categories=",D.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!D.m.abstract,"- value:",D.m.abstract?D.m.abstract.substring(0,50)+"...":"none"),k.innerHTML="",Te.clear(),Ht.clear(),R=[],Do(E[w],{versionLabel:"1"});const n=bd(E[w]);n&&k.appendChild(n),W.setAttribute("width",window.innerWidth),W.setAttribute("height",window.innerHeight);const o=(()=>{var ut,He,ht;const f=document.createElement("div");f.className="blockscape-model-meta";const P=document.createElement("div");P.className="blockscape-model-title",P.textContent=D.m.title&&D.m.title.trim()||Je(E[w]),f.appendChild(P),((ut=E[w])!=null&&ut.isSeries||(ht=(He=E[w])==null?void 0:He.apicurioVersions)!=null&&ht.length)&&$t(E[w],{seriesName:E[w].title||D.m.title||Je(E[w])});const F=Es(E[w]),oe=Ln(E[w]),je=(D.m.id??"").toString().trim(),Z=document.createElement("div");Z.className="blockscape-model-meta__details";const _e=(Ut,sn)=>{if(!sn)return;const mi=document.createElement("div");mi.className="blockscape-model-id";const wn=document.createElement("span");wn.className="blockscape-model-id__label",wn.textContent=Ut;const Kt=document.createElement("span");Kt.className="blockscape-model-id__value",Kt.textContent=sn,mi.append(wn,Kt),Z.appendChild(mi)};return _e("Series ID",oe),_e("Model ID",je),_e("No. in series",F),Z.childElementCount&&f.appendChild(Z),f})();l.showModelMeta!==!1&&k.appendChild(o.cloneNode(!0));const s=document.createElement("div");s.className="blockscape-tabs";const d=document.createElement("div");d.className="blockscape-tabrow";const p=document.createElement("div");p.className="blockscape-tablist",p.setAttribute("role","tablist"),d.appendChild(p);const h=document.createElement("div");h.className="blockscape-tabactions",d.appendChild(h),s.appendChild(d);const v=document.createElement("div");v.className="blockscape-tabpanels",s.appendChild(v);const x=document.createElement("div"),B=document.createElement("div"),A=document.createElement("div"),N=document.createElement("div"),V=()=>{const f=document.createElement("div");f.className="blockscape-map-legend";const P=document.createElement("div");return P.className="blockscape-legend",P.setAttribute("role","presentation"),P.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,f.appendChild(P),f};let re="";const Le=fd(E[w]),dt=Pn(E[w]),Ee=((js=(Ws=E[w])==null?void 0:Ws.apicurioVersions)==null?void 0:js[dt])||null,ke=Qt=!!(Ee!=null&&Ee.isCategoryView||((Ee==null?void 0:Ee.version)||"").startsWith($o));Xt=null,Sn="";const ot=(f,P)=>{!f||!P||(f.title=f.title?`${f.title}
${P}`:P)},Ue=[{id:"map",label:"Map",panel:x},{id:"abstract",label:"Info",panel:B},{id:"source",label:"Settings",panel:A},{id:"apicurio",label:"Apicurio",panel:N}],Ct=typeof Re.isEnabled=="function"?Re.isEnabled():!1,Vt=f=>{if(!W)return;const P=f==="map";W.hidden=!P,P?(jo(),Gn()):W.innerHTML=""};Ue.forEach((f,P)=>{const F=document.createElement("button");F.type="button",F.id=`tab-${f.id}`,F.className="blockscape-tab"+(P===0?" is-active":""),F.setAttribute("role","tab"),F.setAttribute("aria-controls",`panel-${f.id}`),F.setAttribute("aria-selected",P===0?"true":"false"),F.textContent=f.label,f.id==="apicurio"&&!Ct&&(F.hidden=!0,F.tabIndex=-1,F.setAttribute("aria-hidden","true"),F.style.display="none"),f.button=F,p.appendChild(F),f.panel.id=`panel-${f.id}`,f.panel.classList.add("blockscape-tabpanel"),f.panel.setAttribute("role","tabpanel"),f.panel.setAttribute("aria-labelledby",F.id),f.panel.hidden=P!==0,P===0&&f.panel.classList.add("is-active"),v.appendChild(f.panel)});const xt=f=>{Jn=f,Ue.forEach(P=>{const F=P.id===f;P.button.classList.toggle("is-active",F),P.button.setAttribute("aria-selected",F?"true":"false"),P.panel.classList.toggle("is-active",F),P.panel.hidden=!F}),Vt(f)},Se=Ue.find(f=>f.id==="apicurio"),St=f=>{if(!Se||!Se.button||!Se.panel)return;const P=!!f;if(Se.button.hidden=!P,Se.button.tabIndex=P?0:-1,Se.button.setAttribute("aria-hidden",P?"false":"true"),Se.button.style.display=P?"":"none",P){const F=Jn==="apicurio";Se.button.classList.toggle("is-active",F),Se.button.setAttribute("aria-selected",F?"true":"false"),Se.panel.classList.toggle("is-active",F),Se.panel.hidden=!F}else{const F=Se.panel.classList.contains("is-active");if(Se.button.classList.remove("is-active"),Se.button.setAttribute("aria-selected","false"),Se.panel.classList.remove("is-active"),Se.panel.hidden=!0,F){const oe=Ue.find(je=>je.id!=="apicurio");oe&&xt(oe.id)}}T&&(T.checked=P)};Ue.forEach(f=>{f.button.addEventListener("click",()=>{Dn(),xt(f.id)}),f.id==="abstract"&&(Xt=f.button,f.button.addEventListener("mouseenter",()=>lo(f.button,re,{offset:12})),f.button.addEventListener("mouseleave",Dn),f.button.addEventListener("focus",()=>lo(f.button,re,{offset:12})),f.button.addEventListener("blur",Dn))});const Un=(f=>{const P=Ue.find(oe=>oe.id===Jn);if(P&&(P.id!=="apicurio"||f))return P.id;const F=Ue.find(oe=>oe.id!=="apicurio"||f);return(F==null?void 0:F.id)||Ue[0].id})(Ct);xt(Un),St(Ct),typeof Re.onEnabledChange=="function"&&Re.onEnabledChange(St),k.appendChild(s),x.appendChild(V());const At=document.createElement("div");At.className="blockscape-render",x.appendChild(At);const Zt=document.createElement("div");if(Zt.className="blockscape-abstract-panel",B.appendChild(o.cloneNode(!0)),D.m.abstract){console.log("[Blockscape] Rendering abstract content");const f=document.createElement("div");f.className="blockscape-abstract",f.innerHTML=D.m.abstract,zd(f),Zt.appendChild(f),re=f.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const f=document.createElement("div");f.className="blockscape-abstract-placeholder",f.textContent="No abstract has been provided for this model.",Zt.appendChild(f),re=f.outerHTML}Sn=re,B.appendChild(Zt);const Gt=document.createElement("div");Gt.className="blockscape-source-panel";const We=document.createElement("div");We.className="blockscape-settings-panel";const An=f=>{$e.themeToggle&&($e.themeToggle.checked=f),$e.tabThemeToggle&&($e.tabThemeToggle.checked=f)},pi=f=>{An(f),pa(f?oi:wi)},Ji=f=>{$e.tabCenterToggle&&($e.tabCenterToggle.checked=f)},an=f=>{const P=Ci(f);Ji(P),Hr(P)},fi=f=>{$e.secondaryLinksToggle&&($e.secondaryLinksToggle.checked=f),$e.tabSecondaryLinksToggle&&($e.tabSecondaryLinksToggle.checked=f)},pn=f=>{const P=!!f;fi(P),yn=P,G?Mt(G):(zo(),Gn())},co=({id:f,label:P,checked:F,onChange:oe})=>{const je=document.createElement("label");je.className="blockscape-tab-toggle",je.setAttribute("for",f);const Z=document.createElement("input");Z.type="checkbox",Z.id=f,Z.checked=F,typeof oe=="function"&&Z.addEventListener("change",()=>oe(Z.checked));const _e=document.createElement("span");return _e.className="blockscape-tab-toggle__label",_e.textContent=P,je.append(Z,_e),{row:je,input:Z}},zi=document.createElement("p");zi.className="blockscape-settings-panel__title",zi.textContent="Feature toggles",We.appendChild(zi);const Gi=document.createElement("label");Gi.className="settings-toggle";const qn=document.createElement("input");qn.type="checkbox",qn.checked=to===oi;const uo=document.createElement("span");uo.className="settings-toggle__text";const po=document.createElement("span");po.className="settings-toggle__label",po.textContent="Dark mode";const S=document.createElement("span");S.className="settings-toggle__hint",S.textContent="Switch Blockscape UI to dark colors.",uo.append(po,S),Gi.append(qn,uo),qn.addEventListener("change",()=>{pi(qn.checked)}),We.appendChild(Gi),$e.themeToggle=qn;const{row:j,input:se}=co({id:"tabToggleTheme",label:"Dark mode",checked:to===oi,onChange:f=>pi(f)});h.appendChild(j),$e.tabThemeToggle=se;const{row:le,input:tt}=co({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:yn,onChange:f=>pn(f)});h.appendChild(le),$e.tabSecondaryLinksToggle=tt;const{row:Tt,input:ge}=co({id:"tabToggleCenterItems",label:"Center",checked:on,onChange:f=>an(f)});h.appendChild(Tt),$e.tabCenterToggle=ge;const nt=document.createElement("div");nt.className="settings-actions";const vt=document.createElement("input");vt.type="file",vt.accept="application/json",vt.hidden=!0;const rn=document.createElement("button");rn.type="button",rn.className="pf-v5-c-button pf-m-secondary",rn.textContent="Load settings",rn.addEventListener("click",()=>vt.click()),vt.addEventListener("change",async()=>{var P,F;const f=(P=vt.files)==null?void 0:P[0];if(f)try{const oe=await f.text(),je=JSON.parse(oe),Z=(je==null?void 0:je.settings)||je,ut=((F=ts(Z||{},{refreshObsidianLinks:Go}).applied)==null?void 0:F.length)||0;$n(ut?`Loaded ${ut} setting${ut===1?"":"s"} from ${f.name}.`:`No matching settings found in ${f.name}.`,2200)}catch(oe){console.warn("[Blockscape] failed to load settings.json",oe),$n("Invalid settings file.",2400)}finally{vt.value=""}});const qt=document.createElement("button");qt.type="button",qt.className="pf-v5-c-button pf-m-tertiary",qt.textContent="Download settings",qt.addEventListener("click",()=>{const f={version:1,exportedAt:new Date().toISOString(),settings:pl(es(),{localBackend:Ge})};Dr("settings.json",JSON.stringify(f,null,2)),$n("Settings downloaded.",2e3)}),nt.append(rn,qt,vt),We.appendChild(nt);const Hn=document.createElement("div");Hn.className="color-presets";const Ta=document.createElement("div");Ta.className="settings-text__label",Ta.textContent="Color presets";const La=document.createElement("div");La.className="settings-text__hint",La.textContent="Shown in tile context menu for quick coloring.",Hn.append(Ta,La);const fo=document.createElement("div");fo.className="color-presets__list";const Na=document.createElement("div");Na.className="color-presets__add";const qi=document.createElement("input");qi.type="text",qi.placeholder="Name",qi.className="settings-text__input";const mo=document.createElement("input");mo.type="color",mo.value="#2563eb",mo.className="settings-color-input";const ho=document.createElement("button");ho.type="button",ho.className="pf-v5-c-button pf-m-primary",ho.textContent="Add preset",ho.addEventListener("click",()=>{const f=qi.value.trim()||"Custom",P=mo.value,F=[...jt,{name:f,value:P}];xi(F),Ui(jt),qi.value=""}),Na.append(qi,mo,ho),Hn.append(fo,Na),We.appendChild(Hn),$e.colorPresetList=fo,_i=()=>{fo.innerHTML="",jt.forEach((f,P)=>{const F=document.createElement("div");F.className="color-presets__row";const oe=document.createElement("input");oe.type="text",oe.className="settings-text__input",oe.value=f.name||"",oe.placeholder="Name",oe.addEventListener("input",()=>{const _e=[...jt];_e[P]={..._e[P],name:oe.value},xi(_e),Ui(jt)});const je=document.createElement("input");je.type="color",je.className="settings-color-input",je.value=f.value,je.addEventListener("input",()=>{const _e=[...jt];_e[P]={..._e[P],value:je.value},xi(_e),Ui(jt)});const Z=document.createElement("button");Z.type="button",Z.className="pf-v5-c-button pf-m-plain",Z.textContent="✕",Z.title="Remove preset",Z.addEventListener("click",()=>{const _e=jt.filter((ut,He)=>He!==P);xi(_e),Ui(jt),_i()}),F.append(oe,je,Z),fo.appendChild(F)})},_i();const Kn=({id:f,label:P,hint:F,checked:oe,className:je="",onChange:Z})=>{const _e=document.createElement("label");_e.className=["settings-toggle",je].filter(Boolean).join(" ");const ut=document.createElement("input");ut.type="checkbox",ut.id=f,ut.checked=oe;const He=document.createElement("span");He.className="settings-toggle__text";const ht=document.createElement("span");if(ht.className="settings-toggle__label",ht.textContent=P,He.appendChild(ht),F){const Ut=document.createElement("span");Ut.className="settings-toggle__hint",Ut.textContent=F,He.appendChild(Ut)}return _e.appendChild(ut),_e.appendChild(He),typeof Z=="function"&&ut.addEventListener("change",()=>Z(ut.checked)),{row:_e,input:ut}},Go=()=>{k.querySelectorAll(".tile").forEach(f=>{const P=f.dataset.id,F=wa(P);if(!(F!=null&&F.item))return;const oe=xs(F.item.external),je=Cs(F.item,{externalMeta:oe,seriesIdLookup:Le});As(f,je)})},{row:Yd,input:Xd}=Kn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:yn,className:"map-controls__toggle",onChange:f=>pn(f)});We.appendChild(Yd),$e.secondaryLinksToggle=Xd;const{row:Zd,input:Qd}=Kn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:en,className:"map-controls__toggle",onChange:f=>{en=f,xa()}});We.appendChild(Zd),$e.reusedToggle=Qd;const{row:eu,input:tu}=Kn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:ai,className:"map-controls__toggle",onChange:f=>{const P=Oi(f);Kr(P)}});We.appendChild(eu),$e.autoIdToggle=tu;const Ma=[],{row:nu,input:iu}=Kn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:Ii,className:"map-controls__toggle",onChange:f=>{const P=Vi(f);os(P),Ma.forEach(F=>{F.disabled=!P}),Go()}});if(We.appendChild(nu),$e.obsidianToggle=iu,typeof(Ge==null?void 0:Ge.isAvailable)=="function"&&Ge.isAvailable()&&typeof(Ge==null?void 0:Ge.getAutoReloadConfig)=="function"){const{enabled:f,intervalMs:P}=Ge.getAutoReloadConfig();let F=null;const{row:oe,input:je}=Kn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:f,className:"map-controls__toggle",onChange:sn=>{Ge.setAutoReloadEnabled(sn),F&&(F.disabled=!sn)}});We.appendChild(oe),$e.autoReloadToggle=je;const Z=sn=>`${(sn/1e3).toFixed(2)}s`,_e=document.createElement("label");_e.className="settings-slider",_e.setAttribute("for","autoReloadInterval");const ut=document.createElement("div");ut.className="settings-slider__text";const He=document.createElement("span");He.className="settings-slider__label",He.textContent="Auto-reload interval";const ht=document.createElement("span");ht.className="settings-slider__hint",ht.textContent="Adjust how often to poll for file changes.",ut.append(He,ht);const Ut=document.createElement("span");Ut.className="settings-slider__value",Ut.textContent=Z(P),F=document.createElement("input"),F.type="range",F.id="autoReloadInterval",F.className="settings-slider__input",F.min=String(Tr),F.max=String(Lr),F.step="100",F.value=String(P),F.disabled=!f,F.setAttribute("aria-label","Set auto-reload polling interval"),F.addEventListener("input",()=>{const sn=Ge.setAutoReloadInterval(parseInt(F.value,10));Ut.textContent=Z(sn)}),_e.append(ut,Ut,F),We.appendChild(_e),$e.autoReloadInput=F,$e.autoReloadValue=Ut}const Ba=document.createElement("div");Ba.className="settings-radio";const $a=document.createElement("div");$a.className="settings-radio__label",$a.textContent="Obsidian link format";const Oa=document.createElement("div");Oa.className="settings-radio__hint",Oa.textContent="Use the tile title or id when building Obsidian links.";const Ra=document.createElement("div");Ra.className="settings-radio__options";const Rs=(f,P)=>{const F=document.createElement("label");F.className="settings-radio__option";const oe=document.createElement("input");oe.type="radio",oe.name="obsidianLinkMode",oe.value=f,oe.checked=eo===f,oe.disabled=!Ii,oe.addEventListener("change",()=>{if(!oe.checked)return;const Z=Pi(f);is(Z),Go()});const je=document.createElement("span");je.textContent=P,F.append(oe,je),Ma.push(oe),Ra.appendChild(F)};Rs(da,"Use title"),Rs(No,"Use id"),Ba.append($a,Ra,Oa),We.appendChild(Ba),$e.obsidianModeInputs=Ma;const qo=document.createElement("label");qo.className="settings-text",qo.setAttribute("for","obsidianVaultInput");const Pa=document.createElement("div");Pa.className="settings-text__text";const Va=document.createElement("span");Va.className="settings-text__label",Va.textContent="Obsidian vault";const Da=document.createElement("span");Da.className="settings-text__hint",Da.textContent="Optional. Set the vault name to avoid duplicates.",Pa.append(Va,Da);const Fn=document.createElement("input");Fn.type="text",Fn.id="obsidianVaultInput",Fn.className="settings-text__input",Fn.placeholder="Vault name",Fn.value=ki,Fn.addEventListener("input",()=>{const f=Di(Fn.value);as(f),Go()}),qo.append(Pa,Fn),We.appendChild(qo),$e.obsidianVaultInput=Fn;const Ua=document.createElement("p");Ua.className="settings-note",Ua.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',We.appendChild(Ua);const Ps=f=>`${(f/1e3).toFixed(1)}s`,Ko=document.createElement("label");Ko.className="settings-slider",Ko.setAttribute("for","seriesNavDoubleClickWait");const Ha=document.createElement("div");Ha.className="settings-slider__text";const Fa=document.createElement("span");Fa.className="settings-slider__label",Fa.textContent="Series double-click wait";const Wa=document.createElement("span");Wa.className="settings-slider__hint",Wa.textContent="Time window to double-click into another map version.",Ha.append(Fa,Wa);const go=document.createElement("span");go.className="settings-slider__value",go.textContent=Ps(Bn);const fn=document.createElement("input");fn.type="range",fn.id="seriesNavDoubleClickWait",fn.className="settings-slider__input",fn.min=String(Rr),fn.max=String(Pr),fn.step="50",fn.value=String(Bn),fn.setAttribute("aria-label","Adjust double-click wait for series navigation"),fn.addEventListener("input",()=>{const f=Ri(parseInt(fn.value,10));go.textContent=Ps(f),ns(f)}),Ko.append(Ha,go,fn),We.appendChild(Ko),$e.seriesNavInput=fn,$e.seriesNavValue=go;const Vs=f=>`${Math.round((f-1)*100)}%`,Yo=document.createElement("label");Yo.className="settings-slider",Yo.setAttribute("for","hoverScaleSlider");const ja=document.createElement("div");ja.className="settings-slider__text";const Ja=document.createElement("span");Ja.className="settings-slider__label",Ja.textContent="Hover zoom";const za=document.createElement("span");za.className="settings-slider__hint",za.textContent="Expand tiles on hover to see more detail.",ja.append(Ja,za);const bo=document.createElement("span");bo.className="settings-slider__value",bo.textContent=Vs(vi);const mn=document.createElement("input");mn.type="range",mn.id="hoverScaleSlider",mn.className="settings-slider__input",mn.min=String(Fe),mn.max=String(et),mn.step="0.1",mn.value=String(vi),mn.setAttribute("aria-label","Adjust hover zoom"),mn.addEventListener("input",()=>{const f=Ai(parseFloat(mn.value));bo.textContent=Vs(f),zr(f),G&&Fi()}),Yo.append(ja,bo,mn),We.appendChild(Yo),$e.hoverScaleInput=mn,$e.hoverScaleValue=bo;let Dt=null,Yn=null;const Ga=f=>{const P=Math.round((1-f)*100);return P===0?"Off":`${P}% dim`},{row:ou,input:au}=Kn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Mn,className:"map-controls__toggle",onChange:f=>{const P=$i(f);qr(P),Dt&&(Dt.disabled=!P),Yn&&(Yn.textContent=Ga(P?Nn:1))}});We.appendChild(ou),$e.selectionDimToggle=au;const Xo=document.createElement("label");Xo.className="settings-slider",Xo.setAttribute("for","selectionDimmingSlider");const qa=document.createElement("div");qa.className="settings-slider__text";const Ka=document.createElement("span");Ka.className="settings-slider__label",Ka.textContent="Dimming strength";const Ya=document.createElement("span");Ya.className="settings-slider__hint",Ya.textContent="Adjust how much unrelated tiles fade when dimming is on.",qa.append(Ka,Ya),Yn=document.createElement("span"),Yn.className="settings-slider__value",Yn.textContent=Ga(Mn?Nn:1),Dt=document.createElement("input"),Dt.type="range",Dt.id="selectionDimmingSlider",Dt.className="settings-slider__input",Dt.min=String(wt),Dt.max=String(Pe),Dt.step="0.05",Dt.value=String(Nn),Dt.disabled=!Mn,Dt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),Dt.addEventListener("input",()=>{const f=Ti(parseFloat(Dt.value));Yn.textContent=Ga(f),Gr(f)}),Xo.append(qa,Yn,Dt),We.appendChild(Xo),$e.selectionDimInput=Dt,$e.selectionDimValue=Yn;const Ds=f=>f===1?"Default":`${Math.round(f*100)}%`,Zo=document.createElement("label");Zo.className="settings-slider",Zo.setAttribute("for","tileCompactnessSlider");const Xa=document.createElement("div");Xa.className="settings-slider__text";const Za=document.createElement("span");Za.className="settings-slider__label",Za.textContent="Tile compactness";const Qa=document.createElement("span");Qa.className="settings-slider__hint",Qa.textContent="Adjust padding, gap, and logo size for tiles.",Xa.append(Za,Qa);const wo=document.createElement("span");wo.className="settings-slider__value",wo.textContent=Ds(yi);const hn=document.createElement("input");hn.type="range",hn.id="tileCompactnessSlider",hn.className="settings-slider__input",hn.min=String(Sr),hn.max=String(Ir),hn.step="0.05",hn.value=String(yi),hn.setAttribute("aria-label","Adjust tile compactness"),hn.addEventListener("input",()=>{const f=Li(parseFloat(hn.value));wo.textContent=Ds(f),Yr(f),G&&Fi()}),Zo.append(Xa,wo,hn),We.appendChild(Zo),$e.tileCompactnessInput=hn,$e.tileCompactnessValue=wo;const{row:ru,input:su}=Kn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:ua!=="nowrap",className:"map-controls__toggle",onChange:f=>{const P=f?"wrap":"nowrap";Bi(P),Qr(P)}});We.appendChild(ru),$e.titleWrapInput=su;const Us=f=>`${Math.round((f-1)*100)}% extra`,Qo=document.createElement("label");Qo.className="settings-slider",Qo.setAttribute("for","titleHoverWidthSlider");const er=document.createElement("div");er.className="settings-slider__text";const tr=document.createElement("span");tr.className="settings-slider__label",tr.textContent="Title width on hover";const nr=document.createElement("span");nr.className="settings-slider__hint",nr.textContent="Give titles more room horizontally when zoomed.",er.append(tr,nr);const vo=document.createElement("span");vo.className="settings-slider__value",vo.textContent=Us(Ei);const gn=document.createElement("input");gn.type="range",gn.id="titleHoverWidthSlider",gn.className="settings-slider__input",gn.min=String(kn),gn.max=String(un),gn.step="0.05",gn.value=String(Ei),gn.setAttribute("aria-label","Adjust title width boost on hover"),gn.addEventListener("input",()=>{const f=Ni(parseFloat(gn.value));vo.textContent=Us(f),Xr(f)}),Qo.append(er,vo,gn),We.appendChild(Qo),$e.titleWidthInput=gn,$e.titleWidthValue=vo;const Hs=f=>`${Math.round(f*100)}% of hover zoom`,ea=document.createElement("label");ea.className="settings-slider",ea.setAttribute("for","titleZoomPortionSlider");const ir=document.createElement("div");ir.className="settings-slider__text";const or=document.createElement("span");or.className="settings-slider__label",or.textContent="Title zoom influence";const ar=document.createElement("span");ar.className="settings-slider__hint",ar.textContent="How much the title scales relative to tile hover zoom.",ir.append(or,ar);const yo=document.createElement("span");yo.className="settings-slider__value",yo.textContent=Hs(Si);const bn=document.createElement("input");bn.type="range",bn.id="titleZoomPortionSlider",bn.className="settings-slider__input",bn.min=String(ii),bn.max=String(ca),bn.step="0.05",bn.value=String(Si),bn.setAttribute("aria-label","Adjust how much titles scale on hover"),bn.addEventListener("input",()=>{const f=Mi(parseFloat(bn.value));yo.textContent=Hs(f),Zr(f)}),ea.append(ir,yo,bn),We.appendChild(ea),$e.titleZoomInput=bn,$e.titleZoomValue=yo;const lu=typeof Re.isEnabled=="function"?Re.isEnabled():!1,{row:cu,input:du}=Kn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:lu,className:"apicurio-toggle",onChange:f=>{typeof Re.setEnabled=="function"&&Re.setEnabled(f)}});if(T=du,We.appendChild(cu),Gt.appendChild(We),C)C.hidden=!1,C.classList.remove("pf-v5-c-page__main-section"),Gt.appendChild(C);else{const f=document.createElement("p");f.className="muted",f.textContent="Source editor unavailable.",Gt.appendChild(f)}A.appendChild(Gt),Re.mount(N);let Fs=0;if(D.m.categories.forEach(f=>{const P=document.createElement("section");P.className="category",P.dataset.cat=f.id;const F=ke?md(f,Le):null,oe=document.createElement("div");oe.className="cat-head",oe.dataset.cat=f.id,oe.tabIndex=0,ke&&Number.isInteger(F)?(oe.dataset.seriesVersionIndex=String(F),oe.title="Open this category's map in the series",oe.classList.add("cat-head--series-link")):oe.title="Select category",oe.innerHTML=`<div class="cat-title">${so(f.title||f.id)}</div>
                          <div class="muted cat-count">${(f.items||[]).length} items</div>`,oe.addEventListener("click",()=>{var ht;const Z=oe.dataset.seriesVersionIndex!=null?parseInt(oe.dataset.seriesVersionIndex,10):null,_e=E[w],ut=_e?Pn(_e):-1;ke&&((ht=_e==null?void 0:_e.apicurioVersions)==null?void 0:ht.length)>1&&Number.isInteger(Z)&&Z!==ut&&Wo(w,Z)||Vn(f.id)}),oe.addEventListener("keydown",Z=>{(Z.key==="Enter"||Z.key===" ")&&(Z.preventDefault(),oe.click())}),oe.addEventListener("focus",()=>Vn(f.id,{scrollIntoView:!1})),P.appendChild(oe);const je=document.createElement("div");if(je.className="grid"+(on?" is-centered":""),P.appendChild(je),(f.items||[]).forEach(Z=>{Fs+=1;const _e=xs(Z.external),ut=Cs(Z,{externalMeta:_e,seriesIdLookup:Le}),He=document.createElement("div");if(He.className=_e.isExternal?"tile external":"tile",He.tabIndex=0,He.dataset.id=Z.id,He.dataset.globalIndex=String(Fs),_e.url&&(He.dataset.externalUrl=_e.url),!ke){let Kt=null;if(Le.has(Z.id)&&(Kt=Le.get(Z.id)),Number.isInteger(Kt)){He.dataset.seriesVersionIndex=String(Kt),He.classList.add("tile--series-link");const uu=Kt===dt?"Current map in this series":`Open version ${Kt+1} in this series`;ot(He,uu)}}if(ut&&(He.dataset.obsidianUrl=ut),!ke){const Kt=ba(Z.id);Kt!==-1&&Kt!==w&&(He.classList.add("tile--series-link"),He.dataset.navTargetIndex=String(Kt))}const ht=document.createElement("img");ht.className="logo",Z.logo?(ht.src=Z.logo,ht.alt=Z.name||Z.id):(ht.alt="",ht.style.opacity=1,ht.src=pd(Z.name||Z.id,Z.color));const Ut=document.createElement("div");Ut.className="name",Ut.textContent=Z.name||Z.id;const sn=document.createElement("div");sn.className="tile-id",sn.textContent=Z.id||"";const mi=document.createElement("div");mi.className="badge",mi.textContent="reused";let wn=null;ke||(wn=document.createElement("button"),wn.type="button",wn.className="tile-delete",wn.setAttribute("aria-label",`Delete ${Z.name||Z.id}`),wn.textContent="×",wn.addEventListener("click",Kt=>{Kt.stopPropagation(),Wd(Z.id)})),_e.url&&He.appendChild(kd(_e.url)),As(He,ut),wn&&He.appendChild(wn),He.appendChild(ht),He.appendChild(Ut),He.appendChild(sn),He.appendChild(mi),je.appendChild(He),Te.set(Z.id,{el:He,catId:f.id,rect:null})}),At.appendChild(P),Ht.set(f.id,{el:P,headEl:oe}),!ke){const Z=document.createElement("button");Z.type="button",Z.className="tile-add",Z.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',Z.hidden=on,Z.tabIndex=on?-1:0,Z.setAttribute("aria-hidden",on?"true":"false"),Z.addEventListener("click",()=>Nd(f.id)),je.appendChild(Z)}}),!ke){const f=document.createElement("button");f.type="button",f.className="category-add",f.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',f.addEventListener("click",()=>Ls()),At.appendChild(f)}xa(),wd(),jo(),Gn(),Wi(),Ad()}function wd(){k.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var A;if(typeof n.button=="number"&&n.button!==0)return;di();const i=e.dataset.id,o=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,d=E[w],p=d?Pn(d):-1,h=((A=d==null?void 0:d.apicurioVersions)==null?void 0:A.length)>1&&Number.isInteger(o)&&o!==p,v=Number.isInteger(s)&&s!==w&&s>=0&&s<E.length,x=Ot&&Ot.id===i&&Ot.targetVersionIndex===o,B=tn&&tn.id===i&&tn.targetIndex===s;if(Ot&&!x&&Hi(),tn&&!B&&Sa(),h)if(x){if(Hi(),Wo(w,o))return}else qc(i,o,d);else if(v){if(B){Sa(),_t(s);return}Kc(i,s)}else Number.isInteger(a)&&a>0&&a%5===0&&$n("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",i),G===i&&!(h&&x)&&!(v&&B)){ji();return}Mt(i)}),e.addEventListener("dblclick",n=>{n.preventDefault();const i=e.dataset.id,o=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):ba(i);o!==-1&&o!==w&&_t(o)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{G&&Fi()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),ps||(ps=!0,window.addEventListener("resize",Fi),window.addEventListener("scroll",Fi,{passive:!0}),window.addEventListener("resize",Ts),document.addEventListener("click",e=>{var a,s,d;if(!G&&!ze||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),i=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),o=(d=t==null?void 0:t.closest)==null?void 0:d.call(t,".tile-context-menu");n||i||o||ji()})),document.getElementById("clear").onclick=()=>ji()}function jo(){Te.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function ks(e,{includeSecondary:t=yn}={}){if(!e||!D)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(D.fwd.get(e)||[]),i=new Set(D.rev.get(e)||[]),o=new Set,a=new Set,s=[],d=new Set,p=(h,v,x,B)=>{if(!h||!v)return;const A=`${h}->${v}:${x}:${B}`;d.has(A)||(d.add(A),s.push({from:h,to:v,type:x,depth:B}))};return n.forEach(h=>p(e,h,"dep",1)),i.forEach(h=>p(e,h,"revdep",1)),t&&new Set([...n,...i]).forEach(v=>{(D.fwd.get(v)||new Set).forEach(A=>{const N=A===e;N||o.add(A),N||p(v,A,"dep",2)}),(D.rev.get(v)||new Set).forEach(A=>{const N=A===e;N||a.add(A),N||p(v,A,"revdep",2)})}),{deps:n,revs:i,secondaryDeps:o,secondaryRevs:a,edges:s}}function Jo(e,t){const n=Te.get(e);n&&n.el.classList.add(t)}function Mt(e){var d,p,h;if(!e)return;ze=null,G=e,st=null,rt=ks(e),zt(),zo(),Wi();const{deps:t,revs:n,secondaryDeps:i,secondaryRevs:o}=rt;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=Te.get(e);a&&a.el.classList.add("selected"),t.forEach(v=>Jo(v,"dep")),n.forEach(v=>Jo(v,"revdep")),i.forEach(v=>{!t.has(v)&&v!==e&&Jo(v,"dep-indirect")}),o.forEach(v=>{!n.has(v)&&!t.has(v)&&v!==e&&Jo(v,"revdep-indirect")}),Gn();const s=(h=(p=(d=Te.get(e))==null?void 0:d.el)==null?void 0:p.dataset)==null?void 0:h.externalUrl;s&&$n("This item has link to",zn,s),fa()}function Vn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,d;if(!((s=D==null?void 0:D.m)!=null&&s.categories)||!e)return!1;const o=(D.m.categories||[]).find(p=>p.id===e);if(!o)return!1;di(),Ca(),n||(st=null),ze=o.id,zt(),Wi();const a=Ht.get(o.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(d=a.headEl)==null||d.focus({preventScroll:!0})),!0}function Wi(){if(Ht.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!ze)return;const e=Ht.get(ze);if(!(e!=null&&e.el)){ze=null,st=null,zt();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function ro(){if(ze)return ze;const e=G?Te.get(G):null;return e!=null&&e.catId?e.catId:null}function vd(e){var a,s,d,p;if(!((s=(a=D==null?void 0:D.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=D.m.categories,n=ro();let i=t.findIndex(h=>h.id===n);if(i===-1){const h=((d=t.find(v=>(v.items||[]).length))==null?void 0:d.id)||((p=t[0])==null?void 0:p.id);return h?Vn(h):!1}const o=i+e;return o<0||o>=t.length?!1:Vn(t[o].id)}function Ca(){G=null,rt=null,zo(),Gn(),fa({itemId:null})}function yd(){ze=null,st=null,Wi()}function ji(){Ca(),yd(),st=null,zt()}function zo(){k.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function xa(){D!=null&&D.reusedLocal&&D.reusedLocal.forEach(e=>{const t=Te.get(e);if(!t)return;t.el.classList.toggle("reused",en);const n=t.el.querySelector(".badge");n&&(n.style.display=en?"inline-block":"none")})}function Gn(){for(;W.firstChild;)W.removeChild(W.firstChild);if(!G||W.hidden)return;rt=ks(G),rt.edges.forEach(t=>{var x,B;const n=(x=Te.get(t.from))==null?void 0:x.rect,i=(B=Te.get(t.to))==null?void 0:B.rect;if(!n||!i)return;const o=_s(n),a=_s(i),s=document.createElementNS("http://www.w3.org/2000/svg","path"),d=(o.x+a.x)/2,p=o.y,h=(o.x+a.x)/2,v=a.y;s.setAttribute("d",`M ${o.x},${o.y} C ${d},${p} ${h},${v} ${a.x},${a.y}`),s.setAttribute("fill","none"),s.setAttribute("stroke",t.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),s.setAttribute("stroke-opacity",t.depth===1?"0.45":"0.22"),s.setAttribute("stroke-width",t.depth===1?"2":"1.5"),t.depth>1&&s.setAttribute("stroke-dasharray","4 3"),s.setAttribute("vector-effect","non-scaling-stroke"),W.appendChild(s)})}function _s(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function so(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Ed(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,i=new URLSearchParams;return i.set("filepath",n),i.set("data"," "),i.set("mode","append"),ki&&i.set("vault",ki),`obsidian://advanced-uri?${i.toString()}`}function Sd(e){return e?eo===No?e.id??e.name??"":e.name??e.id??"":""}function Cs(e,{externalMeta:t,seriesIdLookup:n}={}){var o;if(!Ii||!e||(o=n==null?void 0:n.has)!=null&&o.call(n,e.id))return"";const i=Sd(e);return Ed(i)}function xs(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const i=new URL(n);return/^https?:/i.test(i.protocol)?{isExternal:!0,url:i.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const i=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:i?new URL(n,i).toString():n}}catch(i){return console.warn("[Blockscape] invalid external url skipped",e,i),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Id(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function kd(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function As(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(Id(t))}function Ts(){Q||(Q=requestAnimationFrame(()=>{Q=null,R=R.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),R.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const i=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${i}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function _d(e,t){!e||!t||(R.push({labelEl:e,textEl:t}),Ts())}function Cd(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${so(t)}</div>`],i=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();i&&n.push(`<div class="version-nav__tooltip-meta">Version ${so(i)}</div>`);const o=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return o?n.push(`<div class="version-nav__tooltip-body">${o}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function lo(e,t,{offset:n=8}={}){!ee||!e||!t||(ee.innerHTML=t,ee.hidden=!1,ee.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const i=e.getBoundingClientRect(),o=ee.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let d=i.left+i.width/2-o.width/2+a,p=i.top-o.height-n+s;d<a+n&&(d=a+n);const h=a+window.innerWidth-o.width-n;d>h&&(d=h),p<s+n&&(p=i.bottom+n+s),ee.style.left=`${d}px`,ee.style.top=`${p}px`,ee.classList.add("is-visible")}))}function Dn(){nn&&(clearTimeout(nn),nn=null),ee&&(ee.classList.remove("is-visible"),ee.setAttribute("aria-hidden","true"),ee.hidden=!0)}function xd(e,t){if(!e)return;const n=Je((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const i=Cd(t,n);let o=null;const a=()=>{o&&(clearTimeout(o),o=null)},s=()=>{y=e,lo(e,`<div class="version-nav__tooltip-title">${so(n)}</div>`,{offset:10})},d=()=>{a(),o=setTimeout(()=>{y===e&&lo(e,i,{offset:10})},ve)},p=()=>{s(),d()},h=()=>{y!==e&&s(),d()},v=()=>{a(),y===e&&(y=null,Dn())};e.addEventListener("mouseenter",p),e.addEventListener("focus",p),e.addEventListener("pointermove",h),e.addEventListener("mouseleave",v),e.addEventListener("blur",v),e.addEventListener("click",v)}function Ad(){u&&(u=!1,!(!Xt||!Sn)&&(Dn(),lo(Xt,Sn,{offset:12}),nn=setTimeout(()=>{Dn(),Td()},1e3)))}function Td(){Xt&&(b&&(clearTimeout(b),b=null),Xt.classList.add("blockscape-tab--twinkle"),b=setTimeout(()=>{Xt.classList.remove("blockscape-tab--twinkle"),b=null},1400))}window.addEventListener("scroll",Dn,!0),window.addEventListener("resize",Dn),De&&De.addEventListener("click",()=>{Zc()}),de&&de.addEventListener("click",()=>{Qc()}),lt&&lt.addEventListener("click",()=>{try{zc(),Hc()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),Ie&&Ie.addEventListener("click",Ia),$&&$.addEventListener("click",Ia),c&&c.addEventListener("click",Ho),X&&X.addEventListener("click",Ho),k&&k.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");Qt||!t||!k.contains(t)||Oc(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||Rc(e)}),qe&&qe.addEventListener("click",()=>{ds("button")}),z&&z.addEventListener("click",()=>{if(w<0){alert("Load or select a model before creating a version.");return}try{const e=cs({versionLabel:"map edit"});_t(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),Ve&&Ve.addEventListener("click",async()=>{var a;if(w<0||!E[w]){alert("Select or load a model before sharing.");return}const e={title:Je(E[w],"Shared Model"),data:E[w].data};let t;try{t=Rl(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const i=n.toString();try{window.history.replaceState({},document.title,i)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let o=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(i),o=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}o?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",i)}),Y&&Y.addEventListener("click",()=>{const e=(m.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};G&&(n.selectedItemId=G),localStorage.setItem(O,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";G&&(t=`editor.html?selected=${encodeURIComponent(G)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==O||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||ys("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===it&&ys("message")})),document.addEventListener("keydown",e=>{var i,o,a,s,d,p,h,v,x,B;if(Xc()){e.key==="Escape"&&(e.preventDefault(),Ia());return}if(!(K!=null&&K.hidden)&&e.key==="Escape"){e.preventDefault(),Ho();return}if((i=ci==null?void 0:ci.isOpen)==null?void 0:i.call(ci))return;const n=Qt;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const A=E[w],N=((o=A==null?void 0:A.apicurioVersions)==null?void 0:o.length)>1;ds("shortcut",N);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!ui())return;if(Dd()){e.preventDefault();return}}if(e.key==="Escape"){let A=!1;te&&!te.hidden&&(di(),A=!0),(G||ze)&&(ji(),A=!0),A&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!ui())return;const A=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if((e.ctrlKey||e.metaKey)&&!e.shiftKey){_a(A)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(ze&&!e.shiftKey){e.preventDefault();return}e.shiftKey?Bd(A)&&e.preventDefault():$d(A)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!ui())return;const A=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){Vd(A)&&e.preventDefault();return}if(e.altKey)return;if(ze&&!G&&!e.shiftKey){if(Rd(A)){e.preventDefault();return}if(vd(A)){e.preventDefault();return}}e.shiftKey?Pd(A)&&e.preventDefault():Od(A)&&e.preventDefault()}if(e.key==="Delete"){if(n||!ui()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const A=ze?Fd():!1,N=A?!0:Ns();(A||N)&&e.preventDefault()}if(e.key==="F2"){if(n||!ui())return;const A=ze&&!G&&ze||!G&&((p=(d=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:d.dataset)==null?void 0:p.cat)||null;if(A&&!G&&Md(A)){e.preventDefault();return}const N=G||((B=(x=(v=(h=e.target)==null?void 0:h.closest)==null?void 0:v.call(h,".tile"))==null?void 0:x.dataset)==null?void 0:B.id);N&&ci.open(N)&&e.preventDefault()}if(e.key==="Insert"){if(n||!ui()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;Ls()&&e.preventDefault()}}),window.addEventListener("resize",()=>{Pc()}),window.addEventListener("scroll",()=>Vc(),!0);function Ld(e,t,n){if(w<0)return;const o=E[w].data.categories||[],a=o.find(v=>(v.items||[]).some(x=>x.id===e)),s=o.find(v=>v.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const d=a.items.findIndex(v=>v.id===e);if(d===-1)return;const[p]=a.items.splice(d,1);let h=s.items.length;if(t){const v=s.items.findIndex(x=>x.id===t);v!==-1&&(h=v)}s.items.splice(h,0,p),Pt(),Bt()}function Nd(e){if(w<0||!e)return;const t=E[w].data,i=(t.categories||[]).find(p=>p.id===e);if(!i)return;i.items=i.items||[];const o=`New item ${i.items.length+1}`,s={id:Nc(`${e}-${i.items.length+1}`,t),name:o,deps:[]};i.items.push(s),Pt(),Bt(),di(),Mt(s.id);const d=Te.get(s.id);d!=null&&d.el&&d.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function Ls(){if(w<0)return!1;const e=E[w].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=Mc(t,e),i={id:n,title:t,items:[]};return e.categories.push(i),ze=n,G=null,rt=null,st=null,Pt(),Bt(),Vn(n),console.log("[Blockscape] added category",n),!0}function Md(e=ro()){if(w<0||!e)return!1;const t=$c.open(e);return t&&(G=null,rt=null,zt()),t}function Bd(e){if(!G||w<0||!e)return!1;const n=E[w].data.categories||[],i=Te.get(G);let o=null;if(i!=null&&i.catId&&(o=n.find(p=>p.id===i.catId)),o||(o=n.find(p=>(p.items||[]).some(h=>h.id===G))),!o)return!1;o.items=o.items||[];const a=o.items.findIndex(p=>p.id===G);if(a===-1)return!1;const s=a+e;if(s<0||s>=o.items.length)return!1;const[d]=o.items.splice(a,1);return o.items.splice(s,0,d),Pt(),Bt(),ao(),Mt(G),!0}function $d(e){if(!D||!D.m||!e)return!1;const t=D.m.categories||[];if(!t.length)return!1;const n=()=>{const p=t.find(h=>(h.items||[]).length);return p?{category:p,item:p.items[0]}:null};if(!G){const p=n();return p?(Mt(p.item.id),!0):!1}const i=Te.get(G);let o=null;if(i!=null&&i.catId&&(o=t.find(p=>p.id===i.catId)),o||(o=t.find(p=>(p.items||[]).some(h=>h.id===G))),!o){const p=n();return p?(Mt(p.item.id),!0):!1}const a=o.items||[];if(!a.length)return!1;const s=a.findIndex(p=>p.id===G);if(s===-1)return!1;const d=s+e;return d<0||d>=a.length?!1:(Mt(a[d].id),!0)}function Od(e){if(!D||!D.m||!e)return!1;const t=D.m.categories||[];if(!t.length)return!1;const n=ro();let i=t.findIndex(s=>s.id===n),o=i+e;if(i===-1&&(o=e>0?0:t.length-1),o<0||o>=t.length)return!1;const a=t[o];if(G){const d=(t[i].items||[]).findIndex(p=>p.id===G);st={catId:a.id,position:d===-1?0:d}}else st=null;return Vn(a.id,{preserveEntryHint:!0})}function Rd(e){var a;if(!ze||!((a=D==null?void 0:D.m)!=null&&a.categories)||!e)return!1;const n=(D.m.categories||[]).find(s=>s.id===ze);if(!n)return!1;const i=n.items||[];if(!i.length)return!1;let o=e>0?0:Math.max(0,i.length-1);return(st==null?void 0:st.catId)===n.id&&(o=Math.min(i.length-1,Math.max(0,st.position||0))),st=null,Mt(i[o].id),!0}function Pd(e){if(!G||w<0||!e)return!1;const n=E[w].data.categories||[];if(!n.length)return!1;const i=Te.get(G);let o=-1;if(i!=null&&i.catId&&(o=n.findIndex(x=>x.id===i.catId)),o===-1&&(o=n.findIndex(x=>(x.items||[]).some(B=>B.id===G))),o===-1)return!1;const a=o+e;if(a<0||a>=n.length)return!1;const s=n[o],d=n[a];if(!d)return!1;s.items=s.items||[],d.items=d.items||[];const p=s.items.findIndex(x=>x.id===G);if(p===-1)return!1;const h=Math.min(d.items.length,Math.max(0,p)),v=h<d.items.length?d.items[h].id:null;return Ld(G,v,d.id),ao(),Mt(G),!0}function Vd(e){if(w<0||!e)return!1;const n=E[w].data.categories||[];if(!n.length)return!1;const i=ro();if(!i)return!1;const o=n.findIndex(d=>d.id===i);if(o===-1)return!1;const a=o+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(o,1);return n.splice(a,0,s),ze=s.id,Ca(),st=null,zt(),Pt(),Bt(),Wi(),console.log("[Blockscape] moved category",s.id,"from",o,"to",a),!0}function Dd(){if(w<0)return!1;const e=E[w],t=ft(e)||(e?e.id:null),n=[];if(yt&&t===yt.modelId&&n.push({...yt,type:"item"}),Ft&&t===Ft.modelId&&n.push({...Ft,type:"category"}),!n.length)return!1;const i=n.reduce((o,a)=>o?(a.ts||0)>(o.ts||0)?a:o:a,null);if(!i)return!1;if(i.type==="category"){if(Hd(i))return!0}else if(i.type==="item"&&Ud(i))return!0;return!1}function Ud(e){const t=E[w],n=ft(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(d=>d.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),yt=null,di(),G=null,rt=null,zt(),Pt(),Bt(),ao(),Mt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function Hd(e){const t=E[w],n=ft(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const i=t.data;i.categories=i.categories||[];const o=Math.min(Math.max(e.index,0),i.categories.length);return i.categories.splice(o,0,e.category),Ft=null,G=null,rt=null,ze=e.category.id,st=null,zt(),Pt(),Bt(),Wi(),Vn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function Ns(){if(!G||w<0)return!1;const t=E[w].data.categories||[];if(!t.length)return!1;const n=Te.get(G);let i=null;if(n!=null&&n.catId&&(i=t.find(h=>h.id===n.catId)),i||(i=t.find(h=>(h.items||[]).some(v=>v.id===G))),!i||!Array.isArray(i.items))return!1;const o=i.items.findIndex(h=>h.id===G);if(o===-1)return!1;const a=i.items.splice(o,1)[0];if(!a)return!1;const s=E[w];yt={item:a,categoryId:i.id,index:o,modelId:ft(s)||(s?s.id:null),ts:Date.now()};const p=(()=>{var v;if(i.items.length){const x=Math.min(o,i.items.length-1);return((v=i.items[x])==null?void 0:v.id)||null}const h=t.findIndex(x=>x.id===i.id);if(h===-1)return null;for(let x=h+1;x<t.length;x++){const B=t[x].items||[];if(B.length)return B[0].id}for(let x=h-1;x>=0;x--){const B=t[x].items||[];if(B.length)return B[0].id}return null})();return di(),G=null,rt=null,st=null,zt(),Pt(),Bt(),ao(),p?Mt(p):ji(),console.log("[Blockscape] removed item",a.id),!0}function Fd(){var d,p;const e=ro();if(!e||w<0)return!1;const n=E[w].data.categories||[];if(!n.length)return!1;const i=n.findIndex(h=>h.id===e);if(i===-1)return!1;const[o]=n.splice(i,1);if(!o)return!1;const a=E[w];Ft={category:o,index:i,modelId:ft(a)||(a?a.id:null),ts:Date.now()},ze=null,G=null,rt=null,st=null,zt(),Pt(),Bt();const s=((d=n[i])==null?void 0:d.id)||((p=n[i-1])==null?void 0:p.id)||null;return s?Vn(s):ji(),console.log("[Blockscape] removed category",o.id),!0}function Wd(e){if(!e)return!1;const t=G;G=e;const n=Ns();return n||(G=t,zt()),n}he&&he.addEventListener("click",async()=>{const e=m.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await Jr(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),M&&M.addEventListener("click",async()=>{const e=Fc();if(!e){alert("No series available to copy. Create another version first.");return}await Jr(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),Ne&&Ne.addEventListener("click",async()=>{try{const e=await Kl();if(!e){alert("Clipboard is empty.");return}m.value=e,m.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await oo(),t=Rn(m.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const i=[];t.forEach((o,a)=>{const s=xn(o,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),i.push(s)}),w===-1&&n!=null?_t(n):On(),e&&await Ms(i,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(w<0){alert("No active model selected.");return}try{const t=JSON.parse(m.value);if(Cn(t,{titleHint:Je(E[w]),idHint:ft(E[w])||Je(E[w])}),E[w].data=t,E[w].title=t.title||E[w].title,E[w].isSeries||((e=E[w].apicurioVersions)==null?void 0:e.length)>1){const n=E[w].title||Je(E[w]);$t(E[w],{seriesName:n,fallbackTitle:n})}va(),console.log("[Blockscape] replaced active model:",Je(E[w])),Bt(),Re.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const i of t){const o=await i.text(),a=i.name.replace(/\.[^.]+$/,"")||"File",s=Rn(o,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",i.name);continue}s.forEach((d,p)=>{var V;const h=(((V=d.data)==null?void 0:V.title)??"").toString().trim(),v=s.length>1?`${i.name} #${p+1}`:i.name,x=`${a} series`,B=d.isSeries?x:null;let A={...d};if(d.isSeries){const re=B||h||d.title||v||"unknown";A.title=re;const Le=vn(re||"unknown");li(A,Le),$t(A,{seriesName:re,fallbackTitle:"unknown"}),A.apicurioArtifactName=A.apicurioArtifactName||re}else A.title=h||v;const N=xn({...A,apicurioArtifactName:A.apicurioArtifactName||B||A.apicurioArtifactName},{versionLabel:i.name});n==null&&(n=N)})}w===-1&&n!=null?_t(n):On()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",jd);async function jd(e){var a;if(!ui())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!sd(t))return;let n=[];try{const s=await oo();n=Rn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let i=null;const o=[];n.forEach((s,d)=>{const p=xn(s,{versionLabel:n.length>1?`paste #${d+1}`:"paste"});i==null&&(i=p),o.push(p)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),i!=null&&_t(i),await oo()&&await Ms(o,{origin:"clipboard"})}async function Ms(e,{origin:t="clipboard"}={}){if(!await oo()||typeof(Ge==null?void 0:Ge.saveModelByIndex)!="function")return;const i=(Array.isArray(e)?e:[]).filter(B=>{const A=E[B];return A&&!A.sourcePath});if(!i.length)return;const o=i.length===1?"model":"models",a=E[i[0]],s=ec(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const d=window.prompt(`Save pasted ${o} as a new .bs file (under ~/blockscape):`,s);if(d==null)return;const p=si(d);if(!p){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const h=await Zl(),v=[];for(let B=0;B<i.length;B++){const A=i.length===1?p:Xl(p,B+1),N=Ql(A,h);if(!N){alert("Could not find a unique filename to save.");return}h.add(N),v.push(N)}let x=null;for(let B=0;B<i.length;B++){const A=i[B],N=v[B],V=E[A];if(!V)continue;i.length===1&&tc(V,N);const re=await Ge.saveModelByIndex(A,N,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(re!=null&&re.ok)){alert(`Local auto-save failed: ${(re==null?void 0:re.error)||"unknown error"}`);return}x==null&&(x=N)}x&&Ro(x),await Ge.refresh(),On(),$n(`Saved ${i.length} ${o}.`,2500)}J.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&_t(n)}),document.getElementById("removeModel").onclick=()=>{if(w<0)return;const e=Je(E[w]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",Je(E[w])),E.splice(w,1),!E.length){w=-1,D=null,k.innerHTML="",W.innerHTML="",m.value="",On(),va();return}const n=Math.min(w,E.length-1);_t(n)},fe&&(fe.addEventListener("input",e=>{hs(e.target.value||"")}),fe.addEventListener("focus",()=>{fe.value&&fe.value.trim()&&ms(fe.value)})),me&&me.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),i=t.dataset.itemId;nd({modelIndex:n,itemId:i})}),document.addEventListener("click",e=>{if(!me||me.hidden)return;const t=e.target;me.contains(t)||fe&&(t===fe||fe.contains(t))||(me.hidden=!0)}),_&&ae&&H&&_.addEventListener("submit",async e=>{e.preventDefault();const t=ae.value.trim();if(!t){alert("Please enter a URL"),ae.focus();return}const n=await Aa(t);if(typeof n=="number"){_t(n),ae.value="";const i=document.getElementById("urlHint");i&&(i.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!ae||!t)return;let n=null;ae.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=ae.value.slice(-12);t.textContent=o?`…${o}`:""},300)})}();function Bt(){if(!(w<0))try{Fo(E[w]),D=ud(E[w].data),ao()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Jd(){const e=["comms.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>Lo?Lo.endsWith("/")?`${Lo}${n}`:`${Lo}/${n}`:n;for(const n of e)try{const i=await fetch(t(n),{cache:"no-store"});if(!i.ok){console.warn(`[Blockscape] ${n} not fetched (${i.status}); skipping`);continue}const o=await i.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=Rn(o,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(d=>{let p={...d};if(d.isSeries){const h=`${a} series`;p={...d,title:h,apicurioArtifactName:h};const v=vn(h||"unknown");li(p,v),$t(p,{seriesName:h,fallbackTitle:"unknown"})}xn(p,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(i){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",i)}On()}async function Bs(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const i of t)try{console.log(`[Blockscape] fetching ${e} with cache="${i.cache??"default"}"`);const o=await fetch(e,i);if(o.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return await o.text()}catch(o){n=o}throw n||new Error("Unable to fetch URL")}function zd(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(i=>Gd(i)),e.querySelectorAll("a[href]").forEach(i=>{const o=i.getAttribute("href");Os(o)&&$s(i,o)})}function Gd(e){var d,p;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(p=(d=e.parentNode)==null?void 0:d.closest)!=null&&p.call(d,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,i=[];let o;for(;(o=n.exec(t))!==null;)i.push({url:o[0],index:o.index});if(!i.length)return;const a=document.createDocumentFragment();let s=0;i.forEach(({url:h,index:v})=>{v>s&&a.appendChild(document.createTextNode(t.slice(s,v))),a.appendChild(qd(h)),s=v+h.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function qd(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Os(e)&&$s(t,e),t}function $s(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Kd(n,t,e)))}async function Kd(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await Aa(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Os(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function Aa(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Bs(e),i=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let o;try{o=Rn(t,i)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!o.length)throw new Error("No JSON objects found in response.");let a=null;return o.forEach((s,d)=>{var A;const p=(((A=s.data)==null?void 0:A.title)??"").toString().trim(),h=o.length>1?`${i} #${d+1}`:i,v=s.isSeries?`${i} series`:null;let x={...s};if(s.isSeries){const N=v||p||x.title||h;x={...s,title:N,apicurioArtifactName:N||s.apicurioArtifactName};const V=vn(N||"unknown");li(x,V),$t(x,{seriesName:N||v||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:V,url:e,baseName:i,seriesTitle:N})}const B=xn({...x,title:p||x.title||h,apicurioArtifactName:x.apicurioArtifactName||v||s.apicurioArtifactName},{versionLabel:i});a==null&&(a=B)}),console.log(`[Blockscape] loaded ${o.length} model(s) from URL:`,i),w===-1&&a!=null?_t(a):On(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const i=Rn(n,"Blockscape");if(!i.length)throw new Error("Seed template could not be parsed.");let o=null;i.forEach(A=>{const N=xn(A,{versionLabel:"seed"});o==null&&(o=N)}),await Dl(),!await Vr&&l.autoLoadFromDir&&await Jd();const s=await cd(),d=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,p=await dd(),h=vs(),v=h==null?void 0:h.index,x=ld(),B=typeof d=="number"?d:typeof p=="number"?p:typeof x=="number"?x:typeof v=="number"?v:o??0;_t(B),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===B&&requestAnimationFrame(()=>{var N;if(w!==s.modelIndex)return;const A=(N=Te.get(s.itemId))==null?void 0:N.el;A&&(Mt(s.itemId),A.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),A.focus({preventScroll:!0}))})})()}const gl=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function bl(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function wl(r){return gl(bl())}const vl=`${wl()}documentation/`;function yl(r){let l;return{c(){l=U("div"),l.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Open the <a href="${vl}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,g(l,"id","shortcutHelp"),g(l,"class","shortcut-help"),l.hidden=!0,g(l,"aria-hidden","true"),g(l,"role","dialog"),g(l,"aria-modal","true"),g(l,"aria-labelledby","shortcutHelpTitle")},m(m,C){It(m,l,C)},p:Lt,i:Lt,o:Lt,d(m){m&&gt(l)}}}class El extends Ao{constructor(l){super(),xo(this,l,null,yl,Eo,{})}}const Sl=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping, but do not add extra fields for it.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function wr(r){let l,m,C,k,W,ee,J,te;return{c(){l=U("div"),m=U("div"),C=U("a"),k=So("Open Blockscape GPT"),W=ce(),ee=U("div"),ee.textContent="Paste the copied prompt into that chat.",J=ce(),te=U("div"),te.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',g(C,"href",kl),g(C,"target","_blank"),g(C,"rel","noreferrer"),g(ee,"class","new-panel__hint"),g(m,"class","new-panel__link"),g(te,"class","new-panel__link new-panel__link--disabled"),g(l,"class","new-panel__links")},m(_,ae){It(_,l,ae),I(l,m),I(m,C),I(C,k),I(m,W),I(m,ee),I(l,J),I(l,te)},p:Lt,d(_){_&&gt(l)}}}function vr(r){let l,m,C,k,W,ee;return{c(){l=U("div"),m=U("div"),m.textContent="Generated prompt",C=ce(),k=U("textarea"),g(m,"class","new-panel__prompt-label"),g(k,"class","pf-v5-c-form-control new-panel__textarea"),g(k,"rows","4"),k.readOnly=!0,g(l,"class","new-panel__prompt")},m(J,te){It(J,l,te),I(l,m),I(l,C),I(l,k),ei(k,r[4]),W||(ee=Qn(k,"input",r[12]),W=!0)},p(J,te){te&16&&ei(k,J[4])},d(J){J&&gt(l),W=!1,ee()}}}function Il(r){let l,m,C,k,W,ee,J,te,_,ae,H,ie,Ce,Xe,Ze,qe,Ve,z,Y,he,M,Ne,De,de,lt,pe,ye,Ie,$,K,c,X,fe,me,we,Ke,xe,Oe,Qe,mt,at,pt,Ae,O,it,Nt,E,w=r[2]==="gpt"&&wr(),Re=r[4]&&r[5]&&vr(r);return it=qs(r[10][0]),{c(){l=U("div"),m=U("div"),C=ce(),k=U("div"),W=U("div"),W.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',ee=ce(),J=U("form"),te=U("div"),_=U("label"),_.textContent="Domain",ae=ce(),H=U("p"),H.textContent="Describe what you want to create a map for.",ie=ce(),Ce=U("textarea"),Xe=ce(),Ze=U("div"),qe=U("label"),Ve=U("input"),z=ce(),Y=U("span"),Y.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,he=ce(),M=U("fieldset"),Ne=U("legend"),Ne.textContent="Target",De=ce(),de=U("p"),de.textContent="Choose where you plan to use the prompt.",lt=ce(),pe=U("label"),ye=U("input"),Ie=ce(),$=U("div"),$.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',K=ce(),c=U("label"),X=U("input"),fe=ce(),me=U("div"),me.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',we=ce(),Ke=U("div"),xe=U("button"),xe.textContent="Copy prompt",Oe=ce(),Qe=U("button"),Qe.textContent="New blank",mt=ce(),at=U("div"),pt=So(r[3]),Ae=ce(),w&&w.c(),O=ce(),Re&&Re.c(),g(m,"id","newPanelBackdrop"),g(m,"class","shortcut-help__backdrop"),g(W,"class","shortcut-help__header"),g(_,"for","newDomain"),g(H,"class","new-panel__hint"),g(Ce,"id","newDomain"),g(Ce,"class","pf-v5-c-form-control new-panel__textarea"),g(Ce,"rows","4"),Ce.required=!0,g(Ce,"placeholder","Ex: Companies building open-source geospatial tools"),g(te,"class","new-panel__field"),g(Ve,"id","seriesToggle"),g(Ve,"type","checkbox"),g(qe,"class","new-panel__toggle"),g(qe,"for","seriesToggle"),g(Ze,"class","new-panel__field"),g(de,"class","new-panel__hint"),g(ye,"type","radio"),g(ye,"name","target"),ye.__value="gpt",ei(ye,ye.__value),g(pe,"class","new-panel__option"),g(X,"type","radio"),g(X,"name","target"),X.__value="plain",ei(X,X.__value),g(c,"class","new-panel__option"),g(M,"class","new-panel__field"),g(xe,"class","pf-v5-c-button pf-m-primary"),g(xe,"type","submit"),g(Qe,"id","newBlankButton"),g(Qe,"class","pf-v5-c-button pf-m-secondary"),g(Qe,"type","button"),g(Qe,"title","Start from an empty map"),g(at,"class","new-panel__status"),g(at,"aria-live","polite"),g(Ke,"class","new-panel__actions"),g(J,"class","shortcut-help__list new-panel__form"),g(k,"class","shortcut-help__panel"),g(k,"tabindex","-1"),g(l,"id","newPanel"),g(l,"class","shortcut-help"),l.hidden=!0,g(l,"aria-hidden","true"),g(l,"role","dialog"),g(l,"aria-modal","true"),g(l,"aria-labelledby","newPanelTitle"),it.p(ye,X)},m(D,Te){It(D,l,Te),I(l,m),I(l,C),I(l,k),I(k,W),I(k,ee),I(k,J),I(J,te),I(te,_),I(te,ae),I(te,H),I(te,ie),I(te,Ce),ei(Ce,r[0]),I(J,Xe),I(J,Ze),I(Ze,qe),I(qe,Ve),Ve.checked=r[1],I(qe,z),I(qe,Y),I(J,he),I(J,M),I(M,Ne),I(M,De),I(M,de),I(M,lt),I(M,pe),I(pe,ye),ye.checked=ye.__value===r[2],I(pe,Ie),I(pe,$),I(M,K),I(M,c),I(c,X),X.checked=X.__value===r[2],I(c,fe),I(c,me),I(J,we),I(J,Ke),I(Ke,xe),I(Ke,Oe),I(Ke,Qe),I(Ke,mt),I(Ke,at),I(at,pt),I(J,Ae),w&&w.m(J,null),I(J,O),Re&&Re.m(J,null),Nt||(E=[Qn(Ce,"input",r[7]),Qn(Ve,"change",r[8]),Qn(ye,"change",r[9]),Qn(X,"change",r[11]),Qn(J,"submit",Gs(r[6]))],Nt=!0)},p(D,[Te]){Te&1&&ei(Ce,D[0]),Te&2&&(Ve.checked=D[1]),Te&4&&(ye.checked=ye.__value===D[2]),Te&4&&(X.checked=X.__value===D[2]),Te&8&&cr(pt,D[3]),D[2]==="gpt"?w?w.p(D,Te):(w=wr(),w.c(),w.m(J,O)):w&&(w.d(1),w=null),D[4]&&D[5]?Re?Re.p(D,Te):(Re=vr(D),Re.c(),Re.m(J,null)):Re&&(Re.d(1),Re=null)},i:Lt,o:Lt,d(D){D&&gt(l),w&&w.d(),Re&&Re.d(),it.r(),Nt=!1,Ki(E)}}}const kl="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function _l(r,l,m){let C="",k=!1,W="gpt",ee="",J="",te=!1;const _=()=>{var z;return typeof navigator<"u"&&!!((z=navigator.clipboard)!=null&&z.writeText)};function ae(z){const Y=z||"[DOMAIN]",he=k?"series":"map",Ne=Sl.replaceAll("[DOMAIN NAME]",Y).replaceAll("[DOMAIN]",Y).replaceAll("[map|series]",he).split(`
`),De=`Generate a **blockscape ${he}** for the domain of ${Y}.`,de=Ne.findIndex(pe=>pe.toLowerCase().includes("generate a **blockscape value")||pe.toLowerCase().includes("generate a blockscape [map|series]")||pe.toLowerCase().startsWith("generate a blockscape"));de>=0?Ne[de]=De:Ne.unshift(De);const lt=k?`

User requested a series (return an array of models).`:"";return`${Ne.join(`
`).trim()}${lt}`}async function H(z){z.preventDefault();const Y=C.trim();if(m(3,ee=""),m(5,te=W!=="gpt"),!Y){m(3,ee="Add a domain to generate a prompt."),m(4,J="");return}if(W==="gpt"?m(4,J=`${k?"Create a series":"Create a map"} for ${Y}`):(m(4,J=ae(Y)),m(5,te=!0)),!_()){m(3,ee="Clipboard access is unavailable. Copy the prompt below."),m(5,te=!0);return}try{await navigator.clipboard.writeText(J),m(3,ee=W==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),W==="gpt"&&m(5,te=!1)}catch(M){console.warn("[Blockscape] clipboard write failed",M),m(3,ee="Copy failed. Use the prompt below."),m(5,te=!0)}}const ie=[[]];function Ce(){C=this.value,m(0,C)}function Xe(){k=this.checked,m(1,k)}function Ze(){W=this.__value,m(2,W)}function qe(){W=this.__value,m(2,W)}function Ve(){J=this.value,m(4,J)}return[C,k,W,ee,J,te,H,Ce,Xe,Ze,ie,qe,Ve]}class Cl extends Ao{constructor(l){super(),xo(this,l,_l,Il,Eo,{})}}const{document:yr}=zs;function xl(r){let l,m,C,k,W,ee,J,te,_,ae,H,ie,Ce,Xe=r[0]?"Hide tools":"Show tools",Ze,qe,Ve,z,Y,he,M,Ne,De,de,lt,pe,ye,Ie,$,K,c,X,fe,me,we,Ke,xe,Oe,Qe,mt,at,pt,Ae,O,it,Nt,E,w,Re,D,Te,Ht,G,ze,rt,st,yn,Qt,en,Jn,yt,Ft,ni,cn,zn,Ot,dn,tn,Yt,Wt,Rt,En,nn,Xt,Sn,u,b,L=`<script id="seed" type="application/json">${r[4]}<\/script>`,T,y,R,Q,q,ve,be,ue,Fe,et,Me,bt,Ye,wt,Pe;return et=new El({}),bt=new Cl({}),{c(){l=U("link"),m=ce(),C=U("div"),k=U("header"),W=U("div"),ee=U("div"),J=U("div"),te=U("div"),te.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',_=ce(),ae=U("div"),H=U("div"),ie=U("button"),Ce=U("span"),Ze=So(Xe),qe=ce(),Ve=U("span"),Ve.textContent="▾",Y=ce(),he=U("button"),he.textContent="New",M=ce(),Ne=U("label"),Ne.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',De=ce(),de=U("button"),de.textContent="Share",lt=ce(),pe=U("button"),pe.textContent="Help",ye=ce(),Ie=U("div"),$=U("div"),$.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',K=ce(),c=U("form"),c.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',X=ce(),fe=U("button"),fe.textContent="Edit",xe=ce(),Oe=U("a"),Oe.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',mt=ce(),at=U("main"),pt=U("div"),Ae=U("aside"),O=U("div"),O.textContent="Models",it=ce(),Nt=U("ul"),E=ce(),w=U("div"),w.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',Re=ce(),D=U("section"),Te=U("div"),Te.textContent="Local files",Ht=ce(),G=U("p"),G.textContent="Checking for local server…",ze=ce(),rt=U("div"),st=U("label"),st.textContent="Blockscape files under ~/blockscape",yn=ce(),Qt=U("div"),en=U("label"),en.textContent="Folder",Jn=ce(),yt=U("select"),Ft=U("option"),Ft.textContent="All (~/blockscape)",ni=ce(),cn=U("select"),zn=ce(),Ot=U("div"),Ot.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button>',dn=ce(),tn=U("div"),tn.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',Wt=ce(),Rt=U("div"),Rt.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,En=ce(),nn=U("footer"),Xt=U("div"),Xt.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',u=ce(),b=new Ys(!1),T=ce(),y=lr("svg"),R=ce(),Q=U("div"),q=ce(),ve=U("div"),be=ce(),ue=U("div"),ue.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',Fe=ce(),aa(et.$$.fragment),Me=ce(),aa(bt.$$.fragment),yr.title="Blockscape — simple landscape-style tiles",g(l,"rel","icon"),g(l,"type","image/svg+xml"),g(l,"href","./favicon.svg"),g(te,"class","blockscape-brand"),g(Ce,"class","blockscape-toolbar__toggle-label"),g(Ve,"class","blockscape-toolbar__toggle-icon"),g(Ve,"aria-hidden","true"),g(ie,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),g(ie,"type","button"),g(ie,"aria-expanded",r[0]),g(ie,"aria-controls","blockscapeHeaderExtras"),g(ie,"aria-label",z=r[0]?"Hide tools":"Show tools"),g(he,"id","newPanelButton"),g(he,"class","pf-v5-c-button pf-m-primary"),g(he,"type","button"),g(he,"title","Create something new"),g(Ne,"class","pf-v5-c-button pf-m-primary blockscape-file"),g(de,"id","shareModel"),g(de,"class","pf-v5-c-button pf-m-secondary"),g(de,"type","button"),g(de,"title","Copy a shareable URL for this model"),g(pe,"id","helpButton"),g(pe,"class","pf-v5-c-button pf-m-primary"),g(pe,"type","button"),g(pe,"title","Show keyboard shortcuts"),g(H,"class","blockscape-toolbar__primary"),g($,"class","blockscape-search"),g(c,"id","urlForm"),g(c,"class","blockscape-url-form"),g(c,"autocomplete","on"),c.noValidate=!0,g(fe,"id","openInEditor"),g(fe,"class","pf-v5-c-button pf-m-secondary"),g(fe,"type","button"),g(fe,"title","Open current JSON in the editor"),g(Ie,"id","blockscapeHeaderExtras"),g(Ie,"class","blockscape-toolbar__extras"),Ie.hidden=me=!r[0],g(Ie,"aria-hidden",we=!r[0]),g(ae,"class","blockscape-toolbar__controls"),g(ae,"data-expanded",Ke=r[0]?"true":"false"),g(Oe,"href","https://github.com/pwright/blockscape"),g(Oe,"target","_blank"),g(Oe,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),g(Oe,"title","View on GitHub"),g(Oe,"aria-label","View Blockscape on GitHub"),g(J,"class","blockscape-toolbar"),g(ee,"class","pf-v5-c-masthead__content"),g(W,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),g(k,"class","pf-v5-c-page__header"),k.hidden=Qe=!r[3],g(O,"class","sidebar-heading"),g(Nt,"id","modelList"),g(Nt,"class","model-nav-list"),g(w,"class","model-actions"),g(Te,"class","sidebar-heading"),g(G,"id","localBackendStatus"),g(G,"class","local-backend__status muted"),g(st,"class","sr-only"),g(st,"for","localFileList"),g(en,"for","localDirSelect"),Ft.__value="",ei(Ft,Ft.__value),g(yt,"id","localDirSelect"),g(yt,"class","pf-v5-c-form-control"),g(yt,"aria-label","Folder filter"),g(Qt,"class","local-backend__dir"),g(cn,"id","localFileList"),g(cn,"class","pf-v5-c-form-control"),g(cn,"size","12"),cn.multiple=!0,g(cn,"aria-label","Blockscape files on local server"),g(Ot,"class","local-backend__actions"),g(rt,"class","local-backend__list"),g(tn,"class","local-backend__save"),g(D,"id","localBackendPanel"),g(D,"class","local-backend"),D.hidden=!0,g(Ae,"class","blockscape-sidebar"),g(Ae,"aria-label","Models"),Ae.hidden=Yt=!r[2],g(Rt,"class","blockscape-main"),g(pt,"class","blockscape-content"),g(at,"class","pf-v5-c-page__main"),g(Xt,"class","blockscape-footer__inner"),g(nn,"class","pf-v5-c-page__footer blockscape-footer"),nn.hidden=Sn=!r[1],g(C,"class","pf-v5-c-page"),b.a=T,g(y,"id","overlay"),g(y,"class","svg-layer"),g(Q,"id","tabTooltip"),g(Q,"class","blockscape-tab-tooltip"),Q.hidden=!0,g(Q,"aria-hidden","true"),g(ve,"id","tileContextMenu"),g(ve,"class","tile-context-menu"),ve.hidden=!0,g(ve,"aria-hidden","true"),g(ue,"id","itemPreview"),g(ue,"class","item-preview"),ue.hidden=!0,g(ue,"aria-hidden","true")},m(ne,Be){I(yr.head,l),It(ne,m,Be),It(ne,C,Be),I(C,k),I(k,W),I(W,ee),I(ee,J),I(J,te),I(J,_),I(J,ae),I(ae,H),I(H,ie),I(ie,Ce),I(Ce,Ze),I(ie,qe),I(ie,Ve),I(H,Y),I(H,he),I(H,M),I(H,Ne),I(H,De),I(H,de),I(H,lt),I(H,pe),I(ae,ye),I(ae,Ie),I(Ie,$),I(Ie,K),I(Ie,c),I(Ie,X),I(Ie,fe),I(J,xe),I(J,Oe),I(C,mt),I(C,at),I(at,pt),I(pt,Ae),I(Ae,O),I(Ae,it),I(Ae,Nt),I(Ae,E),I(Ae,w),I(Ae,Re),I(Ae,D),I(D,Te),I(D,Ht),I(D,G),I(D,ze),I(D,rt),I(rt,st),I(rt,yn),I(rt,Qt),I(Qt,en),I(Qt,Jn),I(Qt,yt),I(yt,Ft),I(rt,ni),I(rt,cn),I(rt,zn),I(rt,Ot),I(D,dn),I(D,tn),I(pt,Wt),I(pt,Rt),I(C,En),I(C,nn),I(nn,Xt),It(ne,u,Be),b.m(L,ne,Be),It(ne,T,Be),It(ne,y,Be),It(ne,R,Be),It(ne,Q,Be),It(ne,q,Be),It(ne,ve,Be),It(ne,be,Be),It(ne,ue,Be),It(ne,Fe,Be),_o(et,ne,Be),It(ne,Me,Be),_o(bt,ne,Be),Ye=!0,wt||(Pe=Qn(ie,"click",r[5]),wt=!0)},p(ne,[Be]){(!Ye||Be&1)&&Xe!==(Xe=ne[0]?"Hide tools":"Show tools")&&cr(Ze,Xe),(!Ye||Be&1)&&g(ie,"aria-expanded",ne[0]),(!Ye||Be&1&&z!==(z=ne[0]?"Hide tools":"Show tools"))&&g(ie,"aria-label",z),(!Ye||Be&1&&me!==(me=!ne[0]))&&(Ie.hidden=me),(!Ye||Be&1&&we!==(we=!ne[0]))&&g(Ie,"aria-hidden",we),(!Ye||Be&1&&Ke!==(Ke=ne[0]?"true":"false"))&&g(ae,"data-expanded",Ke),(!Ye||Be&8&&Qe!==(Qe=!ne[3]))&&(k.hidden=Qe),(!Ye||Be&4&&Yt!==(Yt=!ne[2]))&&(Ae.hidden=Yt),(!Ye||Be&2&&Sn!==(Sn=!ne[1]))&&(nn.hidden=Sn)},i(ne){Ye||(ko(et.$$.fragment,ne),ko(bt.$$.fragment,ne),Ye=!0)},o(ne){oa(et.$$.fragment,ne),oa(bt.$$.fragment,ne),Ye=!1},d(ne){ne&&(gt(m),gt(C),gt(u),b.d(),gt(T),gt(y),gt(R),gt(Q),gt(q),gt(ve),gt(be),gt(ue),gt(Fe),gt(Me)),gt(l),Co(et,ne),Co(bt,ne),wt=!1,Pe()}}}function Al(r,l,m){let C,k,W,{seed:ee}=l,{features:J={}}=l;const _=ee?JSON.stringify(ee,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let ae=!1;const H=()=>{if(m(0,ae=!ae),!ae){const ie=document.getElementById("search");ie&&ie.value&&(ie.value="",ie.dispatchEvent(new Event("input",{bubbles:!0})))}};return Zs(()=>{hl(J)}),r.$$set=ie=>{"seed"in ie&&m(6,ee=ie.seed),"features"in ie&&m(7,J=ie.features)},r.$$.update=()=>{r.$$.dirty&128&&m(3,C=J.showHeader!==!1),r.$$.dirty&128&&m(2,k=J.showSidebar!==!1),r.$$.dirty&128&&m(1,W=J.showFooter!==!1)},[ae,W,k,C,_,H,ee,J]}class Tl extends Ao{constructor(l){super(),xo(this,l,Al,xl,Eo,{seed:6,features:7})}}function Ll(r){let l,m;return l=new Tl({props:{seed:r[0],features:r[1]}}),{c(){aa(l.$$.fragment)},m(C,k){_o(l,C,k),m=!0},p(C,[k]){const W={};k&1&&(W.seed=C[0]),k&2&&(W.features=C[1]),l.$set(W)},i(C){m||(ko(l.$$.fragment,C),m=!0)},o(C){oa(l.$$.fragment,C),m=!1},d(C){Co(l,C)}}}function Nl(r,l,m){let{seed:C}=l,{features:k={}}=l;return r.$$set=W=>{"seed"in W&&m(0,C=W.seed),"features"in W&&m(1,k=W.features)},[C,k]}class Ml extends Ao{constructor(l){super(),xo(this,l,Nl,Ll,Eo,{seed:0,features:1})}}return Ml}();
