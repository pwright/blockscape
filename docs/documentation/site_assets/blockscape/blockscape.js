var Blockscape=function(){"use strict";var Mf=Object.defineProperty;var Bf=($n,Ot,po)=>Ot in $n?Mf($n,Ot,{enumerable:!0,configurable:!0,writable:!0,value:po}):$n[Ot]=po;var uo=($n,Ot,po)=>Bf($n,typeof Ot!="symbol"?Ot+"":Ot,po);var $n=typeof document<"u"?document.currentScript:null;function Ot(){}function po(r){return r()}function ws(){return Object.create(null)}function Ao(r){r.forEach(po)}function vs(r){return typeof r=="function"}function qi(r,c){return r!=r?c==c:r!==c||r&&typeof r=="object"||typeof r=="function"}function Ec(r){return Object.keys(r).length===0}const kc=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function _(r,c){r.appendChild(c)}function Nt(r,c,f){r.insertBefore(c,f||null)}function Et(r){r.parentNode&&r.parentNode.removeChild(r)}function W(r){return document.createElement(r)}function ys(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function Ji(r){return document.createTextNode(r)}function le(){return Ji(" ")}function Ln(r,c,f,T){return r.addEventListener(c,f,T),()=>r.removeEventListener(c,f,T)}function Ic(r){return function(c){return c.preventDefault(),r.call(this,c)}}function b(r,c,f){f==null?r.removeAttribute(c):r.getAttribute(c)!==f&&r.setAttribute(c,f)}function _c(r){let c;return{p(...f){c=f,c.forEach(T=>r.push(T))},r(){c.forEach(f=>r.splice(r.indexOf(f),1))}}}function Cc(r){return Array.from(r.childNodes)}function Ss(r,c){c=""+c,r.data!==c&&(r.data=c)}function fo(r,c){r.value=c??""}class xc{constructor(c=!1){uo(this,"is_svg",!1);uo(this,"e");uo(this,"n");uo(this,"t");uo(this,"a");this.is_svg=c,this.e=this.n=null}c(c){this.h(c)}m(c,f,T=null){this.e||(this.is_svg?this.e=ys(f.nodeName):this.e=W(f.nodeType===11?"TEMPLATE":f.nodeName),this.t=f.tagName!=="TEMPLATE"?f:f.content,this.c(c)),this.i(T)}h(c){this.e.innerHTML=c,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(c){for(let f=0;f<this.n.length;f+=1)Nt(this.t,this.n[f],c)}p(c){this.d(),this.h(c),this.i(this.a)}d(){this.n.forEach(Et)}}let fi;function mi(r){fi=r}function Tc(){if(!fi)throw new Error("Function called outside component initialization");return fi}function Ac(r){Tc().$$.on_mount.push(r)}const Lo=[],Es=[];let No=[];const ks=[],Lc=Promise.resolve();let Oa=!1;function Nc(){Oa||(Oa=!0,Lc.then(Is))}function Va(r){No.push(r)}const Da=new Set;let Mo=0;function Is(){if(Mo!==0)return;const r=fi;do{try{for(;Mo<Lo.length;){const c=Lo[Mo];Mo++,mi(c),Mc(c.$$)}}catch(c){throw Lo.length=0,Mo=0,c}for(mi(null),Lo.length=0,Mo=0;Es.length;)Es.pop()();for(let c=0;c<No.length;c+=1){const f=No[c];Da.has(f)||(Da.add(f),f())}No.length=0}while(Lo.length);for(;ks.length;)ks.pop()();Oa=!1,Da.clear(),mi(r)}function Mc(r){if(r.fragment!==null){r.update(),Ao(r.before_update);const c=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,c),r.after_update.forEach(Va)}}function Bc(r){const c=[],f=[];No.forEach(T=>r.indexOf(T)===-1?c.push(T):f.push(T)),f.forEach(T=>T()),No=c}const Yi=new Set;let Pc;function Zi(r,c){r&&r.i&&(Yi.delete(r),r.i(c))}function Ua(r,c,f,T){if(r&&r.o){if(Yi.has(r))return;Yi.add(r),Pc.c.push(()=>{Yi.delete(r)}),r.o(c)}}function Ha(r){r&&r.c()}function Xi(r,c,f){const{fragment:T,after_update:S}=r.$$;T&&T.m(c,f),Va(()=>{const G=r.$$.on_mount.map(po).filter(vs);r.$$.on_destroy?r.$$.on_destroy.push(...G):Ao(G),r.$$.on_mount=[]}),S.forEach(Va)}function Qi(r,c){const f=r.$$;f.fragment!==null&&(Bc(f.after_update),Ao(f.on_destroy),f.fragment&&f.fragment.d(c),f.on_destroy=f.fragment=null,f.ctx=[])}function Rc(r,c){r.$$.dirty[0]===-1&&(Lo.push(r),Nc(),r.$$.dirty.fill(0)),r.$$.dirty[c/31|0]|=1<<c%31}function ea(r,c,f,T,S,G,ne=null,Y=[-1]){const ee=fi;mi(r);const C=r.$$={fragment:null,ctx:[],props:G,update:Ot,not_equal:S,bound:ws(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(c.context||(ee?ee.$$.context:[])),callbacks:ws(),dirty:Y,skip_bound:!1,root:c.target||ee.$$.root};ne&&ne(C.root);let pe=!1;if(C.ctx=f?f(r,c.props||{},(j,ce,...ge)=>{const at=ge.length?ge[0]:ce;return C.ctx&&S(C.ctx[j],C.ctx[j]=at)&&(!C.skip_bound&&C.bound[j]&&C.bound[j](at),pe&&Rc(r,j)),ce}):[],C.update(),pe=!0,Ao(C.before_update),C.fragment=T?T(C.ctx):!1,c.target){if(c.hydrate){const j=Cc(c.target);C.fragment&&C.fragment.l(j),j.forEach(Et)}else C.fragment&&C.fragment.c();c.intro&&Zi(r.$$.fragment),Xi(r,c.target,c.anchor),Is()}mi(ee)}class ta{constructor(){uo(this,"$$");uo(this,"$$set")}$destroy(){Qi(this,1),this.$destroy=Ot}$on(c,f){if(!vs(f))return Ot;const T=this.$$.callbacks[c]||(this.$$.callbacks[c]=[]);return T.push(f),()=>{const S=T.indexOf(f);S!==-1&&T.splice(S,1)}}$set(c){this.$$set&&!Ec(c)&&(this.$$.skip_bound=!0,this.$$set(c),this.$$.skip_bound=!1)}}const $c="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add($c);const _s="blockscape:apicurioConfig",Fa="http://localhost:8080/apis/registry/v3",na="bs",Cs="-series",Wa=!1,ja=!1;function Oc({models:r,getActiveIndex:c,setActive:f,ensureModelMetadata:T,ensureSeriesId:S,getModelId:G,getSeriesId:ne,getModelTitle:Y,computeJsonFingerprint:ee,uid:C}){let pe=null,j=null,ce=null,ge=null,at=null,We=null,je=null,ze=null,z=null,H=null;const oe=new Set,D={baseUrl:Fa,groupId:na,authToken:"",enabled:Wa,useSemver:ja},de=new Map,Ne=new Map;function Ce(d){return(d||"").toString().trim().replace(/\/+$/,"")}function Re(d){return`${(d||"").toString().trim()||na}${Cs}`}function $e(){return!!(D.baseUrl&&D.groupId)}function be(){return D.enabled!==!1}function ht(){oe.forEach(d=>{try{d(be())}catch(y){console.warn("[Blockscape] failed to run Apicurio enabled listener",y)}})}function $(d){return typeof d=="function"&&oe.add(d),()=>oe.delete(d)}function ie(){ce&&(ce.value=D.baseUrl||""),ge&&(ge.value=D.groupId||""),at&&(at.value=D.authToken||""),We&&(We.checked=be()),je&&(je.checked=!!D.useSemver)}function x(d="",y="muted"){ze&&(ze.textContent=d||"",ze.classList.remove("is-error","is-success"),y==="error"?ze.classList.add("is-error"):y==="success"&&ze.classList.add("is-success"))}function J(d){if(!H||(H.innerHTML="",!d))return;const y=document.createElement("p");y.className="apicurio-hint",y.textContent=d,H.appendChild(y)}function ye(d){de.clear(),Ne.clear(),J(d)}function ue(){const d=c(),y=be(),N=$e(),M=d>=0?r[d]:null,I=!!(M!=null&&M.apicurioVersions&&M.apicurioVersions.length>1);if(pe){const U=pe.dataset.loading==="true",te=y&&N&&d>=0&&!!gt(r[d]);pe.disabled=!y||U||!te,y?U||(pe.textContent="Push to Apicurio"):pe.textContent="Enable Apicurio to push"}if(z){const U=z.dataset.loading==="true",te=y&&N&&I&&!!gt(M);z.disabled=!te||U,z.hidden=!I,y?U||(z.textContent="Push series"):z.textContent="Enable Apicurio to push series"}if(j){const U=j.dataset.loading==="true",te=y&&N;j.disabled=!te||U,U||(y?N?j.textContent="List artifacts":j.textContent="Enter details to list":j.textContent="Enable Apicurio to list")}}function Xe(){ie(),be()?$e()?(x("Apicurio push is ready when a model is selected.","muted"),de.size||J("Click “List artifacts” to browse the current group.")):(x("Enter Apicurio connection details to enable push.","muted"),ye("Enter registry details to browse artifacts.")):(x("Apicurio integration is off. Enable it to allow pushes.","muted"),ye("Apicurio integration is disabled.")),ue()}function ae(){if(window!=null&&window.localStorage)try{localStorage.setItem(_s,JSON.stringify(D))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function Ye(){let d={};if(window!=null&&window.localStorage)try{const U=localStorage.getItem(_s);if(U){const te=JSON.parse(U);te&&typeof te=="object"&&(d=te)}}catch(U){console.warn("[Blockscape] failed to restore Apicurio settings",U)}const y=Ce(d.baseUrl??Fa),N=(d.groupId??na).toString().trim();let M=Wa,I=ja;typeof d.enabled=="boolean"?M=d.enabled:typeof d.enabled=="string"&&(M=d.enabled==="true"),typeof d.useSemver=="boolean"?I=d.useSemver:typeof d.useSemver=="string"&&(I=d.useSemver==="true"),D.baseUrl=y||Fa,D.groupId=N||na,D.authToken=(d.authToken??"").toString().trim(),D.enabled=M,D.useSemver=I,Xe(),ht()}function ft(){const d={Accept:"application/json"},y=(D.authToken||"").trim();return y&&(d.Authorization=/\s/.test(y)?y:`Bearer ${y}`),d}function rt(d,y,{title:N,description:M,version:I}={}){const U={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:y},metadata:{properties:{}}}};I&&(U.firstVersion.version=I),N&&(U.name=N),M&&(U.description=M);try{const te=JSON.parse(y),Z=te==null?void 0:te.seriesId;Z&&typeof Z=="string"&&(U.firstVersion.metadata.properties.seriesId=Z)}catch{}return U}function pt(d,{version:y}={}){const N={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const M=JSON.parse(d),I=M==null?void 0:M.seriesId;I&&typeof I=="string"&&(N.metadata.properties.seriesId=I)}catch{}return y&&(N.version=y),N}function w(d){if(d==null)return null;const y=String(d).trim();if(!y)return null;const N=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(y);if(N)return{major:Number(N[1]),minor:Number(N[2]),patch:Number(N[3])};const M=/^v?(\d+)$/.exec(y);return M?{major:Number(M[1]),minor:0,patch:0}:null}function Qe(d){return`${d.major}.${d.minor}.${d.patch}`}function Mt(d,y){return!d&&!y?0:d?y?d.major!==y.major?d.major-y.major:d.minor!==y.minor?d.minor-y.minor:d.patch-y.patch:1:-1}function Ee(d=[]){let y=null;if(d.forEach(M=>{const I=w((M==null?void 0:M.version)??M);I&&(!y||Mt(I,y)>0)&&(y=I)}),!y)return"1.0.0";const N={...y,patch:y.patch+1};return Qe(N)}function gt(d,{seriesName:y,fallbackTitle:N}={}){var U;if(!d)return null;const M=y||d.title||d.apicurioArtifactName||Y(d),I=N||M;if(typeof S=="function"&&(d.isSeries||((U=d.apicurioVersions)==null?void 0:U.length)>1)&&S(d,{seriesName:M,fallbackTitle:I}),typeof ne=="function"){const te=ne(d,{seriesName:M,fallbackTitle:I});if(te)return te}return G(d)}function Bt(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function k(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function g(d=[]){if(!Array.isArray(d)||!d.length)return null;const y=[...d].filter(Boolean);return y.sort((N,M)=>{const I=N!=null&&N.createdOn?new Date(N.createdOn).getTime():0,U=M!=null&&M.createdOn?new Date(M.createdOn).getTime():0;if(I!==U)return U-I;const te=Number(N==null?void 0:N.version),Z=Number(M==null?void 0:M.version),Me=Number.isFinite(te),ke=Number.isFinite(Z);if(Me&&ke&&te!==Z)return Z-te;const _e=String((N==null?void 0:N.version)??"");return String((M==null?void 0:M.version)??"").localeCompare(_e,void 0,{numeric:!0})}),y[0]||null}function he(d){if(!d)return d;let y=d;if(!Array.isArray(d==null?void 0:d.categories)){const M=d==null?void 0:d.content;if(typeof M=="string")try{y=JSON.parse(M)}catch(I){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",I)}else M&&typeof M=="object"&&(y=M)}return y}async function K(d,y,N){const M=encodeURIComponent(y),I=encodeURIComponent(N),U=`${d}/groups/${M}/artifacts/${I}`,te=ft();te.Accept="application/json";const Z=await fetch(U,{method:"GET",headers:te});if(!Z.ok){let Me=Z.statusText||"Unknown error";try{const ke=await Z.text();ke&&(Me=ke.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${Z.status}): ${Me}`)}return Z.json()}async function xe(d,y,N){const M=encodeURIComponent(y),I=encodeURIComponent(N),U=`${d}/groups/${M}/artifacts/${I}/versions?limit=50&order=desc`,te=ft();te.Accept="application/json";const Z=await fetch(U,{method:"GET",headers:te});if(!Z.ok){let ke=Z.statusText||"Unknown error";try{const _e=await Z.text();_e&&(ke=_e.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${Z.status}): ${ke}`)}const Me=await Z.json();return k(Me).filter(ke=>ke&&ke.version!=null)}async function kt(d,y,N,M="latest"){const I=encodeURIComponent(y),U=encodeURIComponent(N),te=encodeURIComponent(M||"latest"),Z=`${d}/groups/${I}/artifacts/${U}/versions/${te}/content`,Me=ft();Me.Accept="application/json, application/*+json, */*;q=0.8";const ke=await fetch(Z,{method:"GET",headers:Me});if(!ke.ok){let st=ke.statusText||"Unknown error";try{const Be=await ke.text();Be&&(st=Be.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${ke.status}): ${st}`)}const _e=await ke.text();let Oe=null;try{Oe=JSON.parse(_e)}catch{throw new Error("Artifact content is not valid JSON.")}return he(Oe)}async function q(d,y,N,M="latest"){const I=await kt(d,y,N,M);return{data:I,fingerprint:ee(I)}}async function A(d,y,N){try{const I=await xe(d,y,N);if(I!=null&&I.length){Ne.set(N,I);const U=g(I);if((U==null?void 0:U.version)!=null)return U.version}}catch(I){console.warn("[Blockscape] compare-version: unable to fetch versions list",I)}try{const I=await K(d,y,N);if((I==null?void 0:I.version)!=null)return I.version}catch(I){console.warn("[Blockscape] compare-version: unable to fetch metadata",I)}const M=Ne.get(N);if(M&&M.length){const I=g(M);if((I==null?void 0:I.version)!=null)return I.version}return"latest"}async function mt(d,y,N,M){if(!D.useSemver)return null;if(!M)return"1.0.0";try{const I=await xe(d,y,N);return Ee(I)}catch(I){throw new Error(`Unable to compute next semantic version: ${I.message}`)}}function qe(d=document){pe=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),z=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),j=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),ce=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),ge=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),at=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),We=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),je=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),ze=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),H=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function cn(){D.baseUrl=Ce((ce==null?void 0:ce.value)??D.baseUrl),D.groupId=((ge==null?void 0:ge.value)??"").trim(),D.authToken=((at==null?void 0:at.value)??"").trim(),ae(),Xe()}function Vn(d){D.enabled=d!==!1,ae(),Xe(),ht()}function nn(){Vn(We?We.checked:Wa)}function Qn(){D.useSemver=je?je.checked:ja,ae(),Xe()}function bt(){[ce,ge,at].forEach(d=>{d&&d.addEventListener("input",cn)}),pe&&pe.addEventListener("click",()=>{rn()}),z&&z.addEventListener("click",()=>{dn()}),We&&We.addEventListener("change",nn),je&&je.addEventListener("change",Qn),j&&j.addEventListener("click",Dn),H&&H.addEventListener("click",d=>{const y=d.target.closest("[data-artifact-version]");if(y){d.stopPropagation();const I=y.dataset.artifactId,U=y.dataset.artifactVersion;I&&U&&sn(I,U);return}const N=d.target.closest("[data-artifact-load-all]");if(N){d.stopPropagation(),N.dataset.artifactId&&Cn();return}const M=d.target.closest("[data-artifact-trigger]");if(M){const I=M.dataset.artifactId;if(!I)return;Jt(I)}})}function on(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function mo(d){if(!d)return;d.innerHTML="";const y=on();d.appendChild(y),qe(d),bt(),Xe()}function _n(d){if(!H)return;if(H.innerHTML="",!d.length){J("No artifacts found in this group.");return}const y=I=>{const U=document.createElement("section");U.className="apicurio-artifact-section";const te=document.createElement("h3");te.textContent=I,U.appendChild(te);const Z=document.createElement("ul");return Z.className="apicurio-artifact-list",U.appendChild(Z),{section:U,list:Z}},N=y("Series artifacts"),M=y("Artifacts");d.forEach(I=>{if(!(I!=null&&I.artifactId))return;const te=I._groupId&&I._groupId.endsWith(Cs)?N.list:M.list,Z=document.createElement("li"),Me=document.createElement("button");Me.type="button",Me.className="apicurio-artifact",Me.dataset.artifactId=I.artifactId,Me.dataset.artifactTrigger="toggle";const ke=document.createElement("span");ke.className="apicurio-artifact-title",ke.textContent=I.artifactId,Me.appendChild(ke);const _e=[];if(I.name&&_e.push(I.name),I.version!=null&&_e.push(`v${I.version}`),I.type&&_e.push(I.type),I._groupId&&_e.push(I._groupId),_e.length){const Be=document.createElement("span");Be.className="apicurio-artifact-meta",Be.textContent=_e.join(" • "),Me.appendChild(Be)}if(I.description){const Be=document.createElement("span");Be.className="apicurio-artifact-meta",Be.textContent=I.description,Me.appendChild(Be)}Z.appendChild(Me);const Oe=document.createElement("div");Oe.className="apicurio-version-list",Oe.dataset.versionPanel=I.artifactId,Oe.hidden=!0;const st=document.createElement("p");st.className="apicurio-hint",st.textContent="Click to load the latest or open versions.",Oe.appendChild(st),Z.appendChild(Oe),te.appendChild(Z)}),N.list.children.length&&H.appendChild(N.section),M.list.children.length&&H.appendChild(M.section)}function Nn(d){return H?H.querySelector(`[data-version-panel="${d}"]`):null}function an(d,y){if(!d||(d.innerHTML="",!y))return;const N=document.createElement("p");N.className="apicurio-hint",N.textContent=y,d.appendChild(N)}function Wt(d,y){const N=Nn(d);if(N){if(N.innerHTML="",!y.length){an(N,"No versions found for this artifact.");return}y.forEach(M=>{const I=document.createElement("button");I.type="button",I.className="apicurio-version-button",I.dataset.artifactId=d,I.dataset.artifactVersion=M.version;const U=[`Version ${M.version}`];if(M.createdOn){const te=new Date(M.createdOn);isNaN(te)||U.push(te.toISOString().slice(0,10))}I.textContent=U.join(" — "),N.appendChild(I)})}}async function Jt(d){const y=Nn(d);if(!y)return;if(y.dataset.open==="true"){y.hidden=!0,y.dataset.open="false";return}if(y.hidden=!1,y.dataset.open="true",y.dataset.loaded!=="true"){if(!$e()){an(y,"Enter registry details first.");return}an(y,"Loading versions…");try{const M=Ce(D.baseUrl),I=de.get(d),U=D.groupId.trim(),te=(I==null?void 0:I._groupId)||U,Z=await xe(M,te,d);Ne.set(d,Z),y.dataset.loaded="true",Wt(d,Z)}catch(M){console.error("[Blockscape] failed to load versions",M),an(y,`Unable to fetch versions: ${M.message}`)}}}function mn(d,y){var M;const N=r.findIndex(I=>I.apicurioArtifactId===d);if(N!==-1){const I=r[N].id;r[N]={...y,id:I||y.id},((M=r[N].apicurioVersions)==null?void 0:M.length)>1&&(r[N].isSeries=!0),f(N)}else r.push(y),f(r.length-1)}async function It(d,y,N,M){const I=encodeURIComponent(y),U=encodeURIComponent(N),te=`${d}/groups/${I}/artifacts/${U}`;try{const Z=await fetch(te,{method:"GET",headers:M});if(Z.status===404)return!1;if(Z.ok)return!0;throw Z.status===401||Z.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${Z.status} while checking the artifact.`)}catch(Z){throw Z instanceof TypeError?new Error("Network error while contacting Apicurio registry."):Z}}async function rn(){var te;if(!pe||pe.dataset.loading==="true")return;if(!be()){x("Apicurio integration is off. Enable it first.","error");return}if(!$e()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=c();if(d<0||!r[d]){x("No active model to push.","error");return}const y=gt(r[d],{fallbackTitle:Y(r[d])});if(!y){x("Active model needs an id before pushing.","error");return}const N=Ce(D.baseUrl),M=D.groupId.trim(),I=JSON.stringify(r[d].data,null,2),U=ft();pe.dataset.loading="true",pe.textContent="Pushing…",pe.disabled=!0,x("Pushing to Apicurio…","muted");try{const Z=await It(N,M,y,U),Me=ee(r[d].data);if(Z)try{const Ze=await A(N,M,y),{data:ot,fingerprint:wt}=await q(N,M,y,Ze);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",Ze),console.log("local fingerprint",Me),console.log("registry fingerprint",wt),console.log("local payload",r[d].data),console.log("registry payload",ot),console.groupEnd(),Me&&wt&&Me===wt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){x("Push cancelled (content matches the latest registry version).","muted");return}x("Pushing identical content by user choice.","muted")}else wt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(Ze){console.warn("[Blockscape] unable to compare registry content before push",Ze),x("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const ke=D.useSemver?await mt(N,M,y,Z):null;if(D.useSemver&&!ke)throw new Error("Semantic versioning is enabled but no version could be computed.");const _e=encodeURIComponent(M),Oe=encodeURIComponent(y),st=Z?`${N}/groups/${_e}/artifacts/${Oe}/versions`:`${N}/groups/${_e}/artifacts`,Be={...U,"Content-Type":"application/json"};ke&&(Be["X-Registry-Version"]=ke,x(`Pushing to Apicurio as version ${ke}…`,"muted"));const St=Z?pt(I,{version:ke}):rt(y,I,{title:Y(r[d]),description:(te=r[d].data)==null?void 0:te.abstract,version:ke}),Vt=await fetch(st,{method:"POST",headers:Be,body:JSON.stringify(St)});if(!Vt.ok){let Ze=Vt.statusText||"Unknown error";try{const ot=await Vt.text();ot&&(Ze=ot.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Vt.status}): ${Ze}`)}let dt=null;try{dt=await Vt.json()}catch{dt=null}const Ve=(dt==null?void 0:dt.version)||(dt==null?void 0:dt.globalId)||"",ut=Z?"Updated":"Created",jt=Ve?` (version ${Ve})`:"";x(`${ut} ${y}${jt}`,"success")}catch(Z){console.error("[Blockscape] Apicurio push failed",Z),x(`Apicurio push failed: ${Z.message}`,"error")}finally{pe.dataset.loading="false",ue()}}async function dn(){var ke,_e;if(!z||z.dataset.loading==="true")return;if(!be()){x("Apicurio integration is off. Enable it first.","error");return}if(!$e()){x("Enter the registry base URL and group ID before pushing.","error");return}const d=c(),y=d>=0?r[d]:null;if(!y||!y.apicurioVersions||y.apicurioVersions.length<2){x("Series push requires a model with multiple versions.","error");return}const N=gt(y,{seriesName:y.title||y.apicurioArtifactName||Y(y)});if(!N){x("Active series needs an id before pushing.","error");return}typeof S=="function"&&S(y,{seriesName:y.title||y.apicurioArtifactName||Y(y)});const M=Ce(D.baseUrl),I=D.groupId.trim(),U=y.apicurioVersions.map(Oe=>Oe.data),te=JSON.stringify(U,null,2),Z=ft(),Me=Re(I);z.dataset.loading="true",z.textContent="Pushing…",z.disabled=!0,x("Pushing series to Apicurio…","muted");try{const Oe=await It(M,Me,N,Z),st=ee(U);if(Oe)try{const we=await A(M,Me,N),{data:Ge,fingerprint:Mn}=await q(M,Me,N,we);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",we),console.log("local fingerprint",st),console.log("registry fingerprint",Mn),console.log("local payload (series)",U),console.log("registry payload",Ge),console.groupEnd(),st&&Mn&&st===Mn){if(!window.confirm("The current registry version matches this series. Push anyway?")){x("Series push cancelled (content matches latest).","muted");return}x("Pushing identical series by user choice.","muted")}else Mn?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(we){console.warn("[Blockscape] unable to compare registry content before series push",we),x("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const Be=D.useSemver?await mt(M,Me,N,Oe):null;if(D.useSemver&&!Be)throw new Error("Semantic versioning is enabled but no version could be computed.");const St=encodeURIComponent(Me),Vt=encodeURIComponent(N),dt=Oe?`${M}/groups/${St}/artifacts/${Vt}/versions`:`${M}/groups/${St}/artifacts`,Ve={...Z,"Content-Type":"application/json"};Be&&(Ve["X-Registry-Version"]=Be,x(`Pushing series to Apicurio as version ${Be}…`,"muted"));const ut=Oe?pt(te,{version:Be}):rt(N,te,{title:y.apicurioArtifactName||((ke=y.data)==null?void 0:ke.title)||N,description:(_e=y.data)==null?void 0:_e.abstract,version:Be}),jt=await fetch(dt,{method:"POST",headers:Ve,body:JSON.stringify(ut)});if(!jt.ok){let we=jt.statusText||"Unknown error";try{const Ge=await jt.text();Ge&&(we=Ge.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${jt.status}): ${we}`)}let Ze=null;try{Ze=await jt.json()}catch{Ze=null}const ot=(Ze==null?void 0:Ze.version)||(Ze==null?void 0:Ze.globalId)||"",wt=Oe?"Updated":"Created",zt=ot?` (version ${ot})`:"";x(`${wt} ${N} series${zt}`,"success")}catch(Oe){console.error("[Blockscape] Apicurio series push failed",Oe),x(`Apicurio series push failed: ${Oe.message}`,"error")}finally{z.dataset.loading="false",ue()}}async function Dn(){if(!j||j.dataset.loading==="true")return;if(!be()){x("Enable Apicurio integration to list artifacts.","error");return}if(!$e()){x("Enter registry base URL and group ID before listing.","error");return}const d=Ce(D.baseUrl),y=D.groupId.trim(),N=Re(y),M=[{groupId:y,label:"base"},{groupId:N,label:"series"}];j.dataset.loading="true",j.textContent="Listing…",j.disabled=!0,x("Listing artifacts…","muted"),J("Contacting registry…");try{const I=ft();I.Accept="application/json";const U=[];for(const Z of M){const Me=encodeURIComponent(Z.groupId),ke=`${d}/groups/${Me}/artifacts?limit=50&offset=0`,_e=await fetch(ke,{method:"GET",headers:I});if(!_e.ok){let Be=_e.statusText||"Unknown error";try{const St=await _e.text();St&&(Be=St.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${Z.groupId} (${_e.status}): ${Be}`);continue}const Oe=await _e.json(),st=Bt(Oe).filter(Be=>Be&&Be.artifactId);st.forEach(Be=>{Be&&(Be._groupId=Z.groupId)}),U.push(...st)}de.clear(),Ne.clear(),U.forEach(Z=>{Z!=null&&Z.artifactId&&de.set(Z.artifactId,Z)}),_n(U);const te=U.length;x(te?`Found ${te} artifact${te===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",te?"success":"muted")}catch(I){console.error("[Blockscape] failed to list artifacts",I),ye("Unable to list artifacts."),x(`Listing failed: ${I.message}`,"error")}finally{j.dataset.loading="false",ue()}}async function sn(d,y=null){var Oe,st,Be,St,Vt,dt;if(!d)return;if(!be()){x("Enable Apicurio integration to load artifacts.","error");return}if(!$e()){x("Enter registry connection details before loading artifacts.","error");return}const N=Ce(D.baseUrl),M=D.groupId.trim(),I=d&&((Oe=de.get(d))==null?void 0:Oe._groupId)||M;let U=de.get(d);const te=async()=>{try{const Ve=await K(N,I,d);return Ve!=null&&Ve.artifactId&&de.set(d,Ve),Ve}catch(Ve){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",Ve),Ve}};if(!U)try{U=await te()}catch(Ve){x(`Failed to fetch artifact metadata: ${Ve.message}`,"error");return}const Z=Ne.get(d)||[];let Me="latest",ke="latest";if(y)Me=y,ke=y;else{if(!U||U.version==null)try{U=await te()}catch(Ve){x(`Failed to fetch artifact metadata: ${Ve.message}`,"error");return}Me=(U==null?void 0:U.version)||"latest",ke=(U==null?void 0:U.version)||"latest"}const _e=Z.find(Ve=>String(Ve.version)===String(Me));(_e==null?void 0:_e.version)!=null&&(ke=_e.version),x(`Loading artifact ${d}…`,"muted");try{const Ve=await kt(N,I,d,Me),ut=de.get(d)||U||{},jt=Array.isArray(Ve);let Ze=null;if(jt){const ot=Ve.map((zt,we)=>(T(zt,{titleHint:ut.name||d,idHint:d}),{version:String(we+1),data:zt,createdOn:(_e==null?void 0:_e.createdOn)||ut.createdOn}));Ze={id:C(),title:((Be=(st=ot[0])==null?void 0:st.data)==null?void 0:Be.title)||ut.name||d,data:(St=ot[0])==null?void 0:St.data,apicurioArtifactId:d,apicurioArtifactName:ut.name||"",apicurioVersions:ot,apicurioActiveVersionIndex:0,isSeries:!0};const wt=((Vt=ut==null?void 0:ut.properties)==null?void 0:Vt.seriesId)||d;typeof S=="function"&&S(Ze,{seriesName:wt,fallbackTitle:wt}),x(`Loaded series artifact ${d}.`,"success")}else{T(Ve,{titleHint:ut.name||d,idHint:d});const ot={version:ke,data:Ve,createdOn:(_e==null?void 0:_e.createdOn)||ut.createdOn};Ze={id:C(),title:Ve.title||ut.name||d,data:Ve,apicurioArtifactId:d,apicurioArtifactName:ut.name||"",apicurioVersions:[ot],apicurioActiveVersionIndex:0};const wt=(dt=ut==null?void 0:ut.properties)==null?void 0:dt.seriesId;wt&&typeof S=="function"&&S(Ze,{seriesName:wt,fallbackTitle:wt});const zt=ke?` (version ${ke})`:"";x(`Loaded artifact ${d}${zt}.`,"success")}mn(d,Ze)}catch(Ve){console.error("[Blockscape] failed to load artifact",Ve),x(`Failed to load artifact: ${Ve.message}`,"error")}}async function Cn(d){}return{hydrateConfig:Ye,mount:mo,updateAvailability:ue,isEnabled:be,setEnabled:Vn,onEnabledChange:$}}const Ht={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Yn(r,c){if(typeof r!="function")throw new Error(`[itemEditor] expected ${c} to be a function`)}function Vc(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}const za=1,Ga=4;function Dc(r){if(r==null)return null;const c=Number(r);if(!Number.isFinite(c))return null;const f=Math.round(c);return f<za||f>Ga?null:f}function Uc(r,{excludeId:c}={}){if(!r)return[];const f=r.split(/[\s,]+/).map(S=>S.trim()).filter(Boolean),T=[];return f.forEach(S=>{c&&S===c||T.includes(S)||T.push(S)}),T}function Hc(r,c,f){if(!c||!f||c===f)return;((r==null?void 0:r.categories)||[]).forEach(S=>{(S.items||[]).forEach(G=>{Array.isArray(G.deps)&&(G.deps=G.deps.map(ne=>ne===c?f:ne))})})}function Fc({findItemAndCategoryById:r,collectAllItemIds:c,updateItemReferences:f,loadActiveIntoEditor:T,rebuildFromActive:S,select:G,onSelectionRenamed:ne,makeSlug:Y=Vc,isAutoIdFromNameEnabled:ee=()=>!0}={}){Yn(r,"findItemAndCategoryById"),Yn(c,"collectAllItemIds"),Yn(f,"updateItemReferences"),Yn(T,"loadActiveIntoEditor"),Yn(S,"rebuildFromActive"),Yn(G,"select"),Yn(Y,"makeSlug"),Yn(ee,"isAutoIdFromNameEnabled");const C={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function pe(z){if(C.fields.errorEl){if(!z){C.fields.errorEl.hidden=!0,C.fields.errorEl.textContent="";return}C.fields.errorEl.hidden=!1,C.fields.errorEl.textContent=z}}function j(){C.wrapper&&(C.wrapper.hidden=!0,C.wrapper.setAttribute("aria-hidden","true"),pe(""),C.categoryId=null,C.itemId=null,C.modelData=null,document.body.classList.remove("item-editor-open"))}function ce(){C.wrapper&&(C.wrapper.hidden=!1,C.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var z,H;(z=C.fields.nameInput)==null||z.focus(),(H=C.fields.nameInput)==null||H.select()}))}function ge({force:z}={}){var oe,D;if(!((oe=C.fields)!=null&&oe.idInput)||!((D=C.fields)!=null&&D.nameInput)||!C.autoSyncEnabled||!ee()||!z&&C.autoIdManuallyEdited)return;const H=Y(C.fields.nameInput.value||C.itemId||"item");C.fields.idInput.value=H}function at(z){var ht;if(!C.modelData||!C.categoryId||!C.itemId)throw new Error("No item loaded.");const oe=(((ht=C.modelData)==null?void 0:ht.categories)||[]).find($=>$.id===C.categoryId);if(!oe)throw new Error("Category not found.");oe.items=oe.items||[];const D=oe.items.find($=>$.id===C.itemId);if(!D)throw new Error("Item not found.");const de=(z.id||"").trim();if(!de)throw new Error("ID is required.");const Ne=c(C.modelData);if(de!==D.id&&Ne.has(de))throw new Error("Another item already uses that ID.");D.id=de;const Ce=(z.name||"").trim();D.name=Ce||D.id;const Re=(z.logo||"").trim();if(Re?D.logo=Re:delete D.logo,z.externalFlag&&!z.external)D.external=!0;else{const $=(z.external??"").toString().trim();$?D.external=$:delete D.external}const $e=(z.color||"").trim();$e?D.color=$e:delete D.color;const be=Dc(z.stage);return be!=null?D.stage=be:delete D.stage,D.deps=Array.isArray(z.deps)?z.deps:[],D.id!==z.originalId&&typeof ne=="function"&&ne(z.originalId,D.id),f(C.modelData,z.originalId,D.id),T(),S(),G(D.id),D.id}function We(){if(!C.fields||!C.fields.idInput)return!1;const z=(C.fields.idInput.value||"").trim(),H={originalId:C.itemId,id:z,name:C.fields.nameInput.value||"",logo:C.fields.logoInput.value||"",external:C.fields.externalInput.value||"",externalFlag:C.fields.externalFlagInput.checked,color:C.fields.colorInput.value||"",stage:C.fields.stageInput.value,deps:Uc(C.fields.depsInput.value,{excludeId:z})};try{return at(H),j(),!0}catch(oe){return console.warn("[itemEditor] item edit failed",oe),pe((oe==null?void 0:oe.message)||"Unable to save item."),!1}}function je(){if(C.wrapper)return C.wrapper;const z=document.createElement("div");z.className="item-editor-modal",z.hidden=!0,z.setAttribute("role","dialog"),z.setAttribute("aria-modal","true");const H=document.createElement("div");H.className="item-editor-modal__backdrop",z.appendChild(H);const oe=document.createElement("div");oe.className="item-editor",z.appendChild(oe);const D=document.createElement("div");D.className="item-editor__header";const de=document.createElement("h2");de.className="item-editor__title",de.textContent="Edit item";const Ne=document.createElement("button");Ne.type="button",Ne.className="item-editor__close",Ne.setAttribute("aria-label","Close item editor"),Ne.textContent="×",D.appendChild(de),D.appendChild(Ne),oe.appendChild(D);const Ce=document.createElement("form");Ce.className="item-editor__form",oe.appendChild(Ce);const Re=document.createElement("div");Re.className="item-editor__meta",Re.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',Ce.appendChild(Re);const $e=document.createElement("div");$e.className="item-editor__error",$e.hidden=!0,Ce.appendChild($e);const be=(g,he,K)=>{const xe=document.createElement("label");xe.className="item-editor__field";const kt=document.createElement("span");if(kt.className="item-editor__label",kt.textContent=g,xe.appendChild(kt),he.classList.add("item-editor__control"),xe.appendChild(he),K){const q=document.createElement("div");q.className="item-editor__hint",q.textContent=K,xe.appendChild(q)}return xe},ht=document.createElement("input");ht.type="text",ht.required=!0,Ce.appendChild(be("ID",ht,"Unique identifier used for dependencies."));const $=document.createElement("input");$.type="text",Ce.appendChild(be("Name",$,"Visible label shown on the tile."));const ie=document.createElement("input");ie.type="url",ie.inputMode="url",ie.placeholder="https://…",Ce.appendChild(be("Logo URL",ie,"Optional image URL."));const x=document.createElement("input");x.type="url",x.inputMode="url",x.placeholder="https://…",Ce.appendChild(be("External link",x,"Shown with ↗ icon and in preview."));const J=document.createElement("div");J.className="item-editor__checkbox";const ye=document.createElement("label");ye.className="item-editor__checkbox-row";const ue=document.createElement("input");ue.type="checkbox";const Xe=document.createElement("span");Xe.textContent="Mark as external without link";const ae=document.createElement("div");ae.className="item-editor__hint",ae.textContent="Keeps dashed border even without a URL.",ye.appendChild(ue),ye.appendChild(Xe),J.appendChild(ye),J.appendChild(ae),Ce.appendChild(J);const Ye=document.createElement("input");Ye.type="text",Ye.placeholder=Ht.color.primary,Ce.appendChild(be("Color",Ye,"Optional badge color (hex or CSS color)."));const ft=document.createElement("input");ft.type="number",ft.min=String(za),ft.max=String(Ga),ft.inputMode="numeric",ft.placeholder=`${za}-${Ga}`,Ce.appendChild(be("Stage",ft,"Optional 1 (far left) to 4 (far right) when Center view is on."));const rt=document.createElement("textarea");rt.rows=2,rt.placeholder="Comma or space separated ids",Ce.appendChild(be("Dependencies",rt,"Use item IDs, separated by commas or spaces."));const pt=document.createElement("div");pt.className="item-editor__checkbox";const w=document.createElement("label");w.className="item-editor__checkbox-row";const Qe=document.createElement("input");Qe.type="checkbox";const Mt=document.createElement("span");Mt.textContent="Sync ID while editing name";const Ee=document.createElement("div");Ee.className="item-editor__hint",Ee.textContent="Turn off to keep typing names without changing the ID.",w.appendChild(Qe),w.appendChild(Mt),pt.appendChild(w),pt.appendChild(Ee),Ce.appendChild(pt);const gt=document.createElement("div");gt.className="item-editor__actions";const Bt=document.createElement("button");Bt.type="button",Bt.className="pf-v5-c-button pf-m-tertiary",Bt.textContent="Cancel";const k=document.createElement("button");return k.type="submit",k.className="pf-v5-c-button pf-m-primary",k.textContent="Save",gt.appendChild(Bt),gt.appendChild(k),Ce.appendChild(gt),C.wrapper=z,C.fields={idInput:ht,nameInput:$,logoInput:ie,externalInput:x,externalFlagInput:ue,colorInput:Ye,stageInput:ft,depsInput:rt,syncCheckbox:Qe,categoryValue:Re.querySelector(".item-editor__meta-value"),errorEl:$e},Bt.addEventListener("click",j),Ne.addEventListener("click",j),H.addEventListener("click",j),ht.addEventListener("input",()=>{C.autoIdManuallyEdited=!0}),$.addEventListener("input",ge),Qe.addEventListener("change",()=>{C.autoSyncEnabled=!!Qe.checked,C.autoSyncEnabled&&(C.autoIdManuallyEdited=!1,ge({force:!0}))}),Ce.addEventListener("submit",g=>{g.preventDefault(),We()}),document.addEventListener("keydown",g=>{g.key==="Escape"&&!z.hidden&&(g.preventDefault(),g.stopPropagation(),j())}),document.body.appendChild(z),z}function ze(z){const H=r(z);if(!H)return!1;je(),C.categoryId=H.category.id,C.itemId=H.item.id,C.modelData=H.modelData,C.autoIdManuallyEdited=!1;const oe=!!ee();return C.autoSyncEnabled=oe,C.fields.categoryValue.textContent=H.category.title||H.category.id,C.fields.idInput.value=H.item.id||"",C.fields.nameInput.value=H.item.name||"",C.fields.logoInput.value=H.item.logo||"",C.fields.externalInput.value=typeof H.item.external=="string"?H.item.external:"",C.fields.externalFlagInput.checked=H.item.external===!0,C.fields.colorInput.value=H.item.color||"",C.fields.stageInput.value=H.item.stage??"",C.fields.depsInput.value=Array.isArray(H.item.deps)?H.item.deps.join(", "):"",C.fields.syncCheckbox.checked=C.autoSyncEnabled,C.fields.syncCheckbox.disabled=!oe,!C.fields.idInput.value&&oe&&ge({force:!0}),pe(""),G(H.item.id),ce(),!0}return{open:ze,hide:j,isOpen:()=>!!C.wrapper&&!C.wrapper.hidden}}function Wc(){return typeof window<"u"&&window.Neutralino&&window.Neutralino.os&&typeof window.Neutralino.os.open=="function"}function hi(r){if(!r)return!1;if(Wc())try{return window.Neutralino.os.open(r),!0}catch(c){console.warn("[Blockscape] failed to open external url",r,c)}return window.open(r,"_blank","noopener"),!0}function jc(r){if(!r||r.startsWith("#")||/^javascript:/i.test(r))return!1;try{const c=new URL(r,window.location.href);return c.protocol==="http:"||c.protocol==="https:"?c.origin!==window.location.origin:!0}catch{return!1}}function zc(r){try{return new URL(r,window.location.href).toString()}catch{return r}}function Gc({menuEl:r,previewEl:c,previewTitleEl:f,previewBodyEl:T,previewActionsEl:S,previewCloseEl:G,escapeHtml:ne,onEditItem:Y,onChangeColor:ee,selectItem:C,colorPresets:pe=[]}={}){const j=r||(()=>{const $=document.createElement("div");return $.className="tile-context-menu",$.hidden=!0,$.setAttribute("aria-hidden","true"),document.body.appendChild($),$})();let ce={x:0,y:0},ge=0,at=Array.isArray(pe)?pe:[];function We(){j&&(j.classList.remove("is-open"),j.hidden=!0,j.setAttribute("aria-hidden","true"),j.innerHTML="")}function je($=[]){S&&(S.innerHTML="",$.forEach(ie=>{const x=document.createElement("button");x.type="button",x.className="item-preview__action",x.textContent=ie.label||"Action",ie.title&&(x.title=ie.title),x.addEventListener("click",J=>{J.stopPropagation(),typeof ie.onClick=="function"&&ie.onClick(J)}),S.appendChild(x)}),S.hidden=$.length===0)}function ze(){We(),c&&(c.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),c.setAttribute("aria-hidden","true"),c.hidden=!0,je([]))}function z($,ie){c&&(ce={x:$,y:ie},c.hidden=!1,c.setAttribute("aria-hidden","false"),c.classList.add("is-visible"),H($,ie))}function H($,ie){if(!c)return;const x=12;c.style.left=`${$+x}px`,c.style.top=`${ie+x}px`;const J=c.getBoundingClientRect();let ye=J.left,ue=J.top;J.right>window.innerWidth-x&&(ye=Math.max(x,window.innerWidth-J.width-x)),J.bottom>window.innerHeight-x&&(ue=Math.max(x,window.innerHeight-J.height-x)),c.style.left=`${ye}px`,c.style.top=`${ue}px`}function oe($,ie){var Xe;if(!$)return null;const x=$.dataset.id,J=((Xe=$.querySelector(".name"))==null?void 0:Xe.textContent)||x||"Preview",ye=x?`${x}.html`:"",ue=ye?`items/${ye}`:"";return{id:x,displayName:J,filename:ye,filepath:ue,externalUrl:$.dataset.externalUrl||"",obsidianUrl:$.dataset.obsidianUrl||"",anchorX:(ie==null?void 0:ie.clientX)??0,anchorY:(ie==null?void 0:ie.clientY)??0}}function D($,ie){const x=document.createElement("button");return x.type="button",x.className="tile-context-menu__item",x.textContent=$,x.addEventListener("click",()=>{We(),typeof ie=="function"&&ie()}),x}function de($){if(!j)return;j.innerHTML="";const ie=document.createElement("div");ie.className="tile-context-menu__list",ie.appendChild(D("File view",()=>Ce($))),typeof Y=="function"&&ie.appendChild(D("Edit",()=>Y($.id))),typeof ee=="function"&&$.id&&at.forEach(x=>{if(!(x!=null&&x.value))return;const J=x.name||x.value;ie.appendChild(D(`Set color: ${J}`,()=>ee($.id,x.value)))}),j.appendChild(ie)}function Ne($,ie){if(!j)return;const x=4;j.style.left=`${$+x}px`,j.style.top=`${ie+x}px`,j.hidden=!1,j.setAttribute("aria-hidden","false"),j.classList.add("is-open");const J=j.getBoundingClientRect();let ye=J.left,ue=J.top;J.right>window.innerWidth-x&&(ye=Math.max(x,window.innerWidth-J.width-x)),J.bottom>window.innerHeight-x&&(ue=Math.max(x,window.innerHeight-J.height-x)),j.style.left=`${ye}px`,j.style.top=`${ue}px`}async function Ce($){if(!c||!f||!T||!$)return;const ie=++ge,x=[];if(typeof Y=="function"&&$.id&&x.push({label:"Edit",title:"Edit this item",onClick:()=>{ze(),Y($.id)}}),$.externalUrl&&x.push({label:"Open link ↗",title:$.externalUrl,onClick:()=>hi($.externalUrl)}),$.obsidianUrl&&x.push({label:"Open in Obsidian",title:$.obsidianUrl,onClick:()=>hi($.obsidianUrl)}),je(x),$.id&&typeof C=="function"&&C($.id),f.textContent=$.displayName,T.innerHTML='<div class="item-preview__status">Loading…</div>',c.classList.remove("item-preview--has-frame"),c.classList.add("item-preview--expanded"),z($.anchorX,$.anchorY),!$.filepath){T.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',H(ce.x,ce.y);return}try{const J=await fetch($.filepath,{cache:"no-cache"});if(!J.ok)throw new Error(`HTTP ${J.status}`);const ye=await J.text();if(ie!==ge)return;if(!ye.trim()){const ae=ne?ne($.filename):$.filename;T.innerHTML=`<div class="item-preview__status">No content in <code>${ae}</code>.</div>`,H(ce.x,ce.y);return}const Xe=document.createElement("iframe");Xe.className="item-preview__frame",Xe.title=`${$.displayName} details`,Xe.srcdoc=ye,T.innerHTML="",T.appendChild(Xe),c.classList.add("item-preview--has-frame"),H(ce.x,ce.y)}catch(J){if(ie!==ge)return;const ye=ne?ne($.displayName):$.displayName;T.innerHTML=`<div class="item-preview__status">No preview available for <strong>${ye}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${$.filepath}`,J),H(ce.x,ce.y)}}function Re($,ie){if(!ie)return;$.preventDefault(),$.stopPropagation();const x=oe(ie,$);!x||!x.id||(typeof C=="function"&&C(x.id),de(x),Ne($.clientX,$.clientY))}function $e($){const ie=$==null?void 0:$.target,x=j&&!j.hidden&&j.contains(ie),J=c&&!c.hidden&&c.contains(ie);!x&&!J&&ze()}function be(){!c||c.hidden||H(ce.x,ce.y)}function ht(){ze()}return G&&G.addEventListener("click",ze),{handleTileContextMenu:Re,hidePreview:ze,hideMenu:We,handleDocumentClick:$e,handleWindowResize:be,handleWindowScroll:ht,updateColorPresets:$=>{at=Array.isArray($)?$:[]}}}function xs(r,c="series"){return(r||c).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||c}function In(r,c="series"){const f=xs(r,c).replace(/\./g,"-");return f.replace(/-series$/i,"").replace(/-+$/,"")||f||xs(c,"series")}function Ts(r,{seriesName:c,fallbackTitle:f="unknown"}={}){var Y,ee;const S=[r==null?void 0:r.seriesId,(Y=r==null?void 0:r.data)==null?void 0:Y.seriesId,r==null?void 0:r.apicurioArtifactId,c,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(ee=r==null?void 0:r.data)==null?void 0:ee.title,f].map(C=>(C??"").toString().trim()),G=S.findIndex(Boolean),ne=G!==-1?S[G]:"";return ne?(console.log("[Series] deriveSeriesId: picked base",{base:ne,sourceIndex:G,candidates:S}),In(ne,f)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:f}),null)}function Ft(r,{seriesName:c,fallbackTitle:f="unknown"}={}){if(!r||typeof r!="object")return null;const T=Ts(r,{seriesName:c,fallbackTitle:f});return T?(r.seriesId=T,r.apicurioArtifactId||(r.apicurioArtifactId=T),T):null}function On(r,c={}){var S,G;if(!r)return null;const f=r.isSeries||((S=r.apicurioVersions)==null?void 0:S.length)>1||r.seriesId||((G=r.data)==null?void 0:G.seriesId)||r.apicurioArtifactId;if(!f&&!c.force)return null;const T=Ts(r,c);return T||(f?In(c.fallbackTitle||"unknown"):null)}const As={selectionDimOpacity:.2,selectionDimEnabled:!0},Zn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,c=!0)=>{const f=Math.round((1-r)*100);return c?f===0?"Off":`${f}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function Xn(r){return r===!0||r==="true"||r===1||r==="1"}function Kc(r,{localBackend:c}={}){const f=c&&typeof c.getAutoReloadConfig=="function"&&c.getAutoReloadConfig(),T={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness,stripParentheticalNames:r.stripParentheticalNames};return f&&(T.autoReloadEnabled=!!f.enabled,T.autoReloadIntervalMs=f.intervalMs),T}function qc(r={},c){var K,xe,kt,q;if(!r||typeof r!="object")return{applied:[]};const f=[],{applyTheme:T,applyTileHoverScale:S,persistTileHoverScale:G,applySelectionDimEnabled:ne,persistSelectionDimEnabled:Y,applySelectionDimOpacity:ee,persistSelectionDimOpacity:C,applyTileCompactness:pe,persistTileCompactness:j,applyTitleWrapMode:ce,persistTitleWrapMode:ge,applyTitleHoverWidthMultiplier:at,persistTitleHoverWidthMultiplier:We,applyTitleHoverTextPortion:je,persistTitleHoverTextPortion:ze,applyLinkThickness:z,persistLinkThickness:H,applyDepColor:oe,persistDepColor:D,applyRevdepColor:de,persistRevdepColor:Ne,applyObsidianLinksEnabled:Ce,persistObsidianLinksEnabled:Re,applyObsidianLinkMode:$e,persistObsidianLinkMode:be,applyObsidianVaultName:ht,persistObsidianVaultName:$,applyAutoIdFromNameEnabled:ie,persistAutoIdFromNameEnabled:x,applySeriesNavDoubleClickWait:J,persistSeriesNavDoubleClickWait:ye,applyCenterItems:ue,persistCenterItems:Xe,applyStripParentheticalNames:ae,persistStripParentheticalNames:Ye,applyShowSeriesPanel:ft,persistShowSeriesPanel:rt,localBackend:pt,ui:w,refreshObsidianLinks:Qe,scheduleOverlaySync:Mt,selection:Ee,select:gt,clearStyles:Bt,drawLinks:k,applyReusedHighlights:g,current:he}=c;if(r.theme){const mt=((T==null?void 0:T(r.theme))||r.theme)==="dark";(K=c.ui)!=null&&K.themeToggle&&(c.ui.themeToggle.checked=mt),(xe=c.ui)!=null&&xe.tabThemeToggle&&(c.ui.tabThemeToggle.checked=mt),f.push("theme")}if(r.hoverScale!=null){const A=S(parseFloat(r.hoverScale));G(A),w!=null&&w.hoverScaleInput&&(w.hoverScaleInput.value=String(A)),w!=null&&w.hoverScaleValue&&(w.hoverScaleValue.textContent=Zn.hoverScale(A)),Ee&&Mt(),f.push("hoverScale")}if(r.selectionDimEnabled!=null){const A=ne(Xn(r.selectionDimEnabled));Y(A),w!=null&&w.selectionDimToggle&&(w.selectionDimToggle.checked=A),w!=null&&w.selectionDimInput&&(w.selectionDimInput.disabled=!A),w!=null&&w.selectionDimValue&&(w.selectionDimValue.textContent=Zn.selectionDimming(he.selectionDimOpacity??As.selectionDimOpacity,A)),f.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const A=ee(parseFloat(r.selectionDimOpacity));C(A),w!=null&&w.selectionDimInput&&(w.selectionDimInput.value=String(A)),w!=null&&w.selectionDimValue&&(w.selectionDimValue.textContent=Zn.selectionDimming(A,he.selectionDimEnabled??As.selectionDimEnabled)),f.push("selectionDimOpacity")}if(r.tileCompactness!=null){const A=pe(parseFloat(r.tileCompactness));j(A),w!=null&&w.tileCompactnessInput&&(w.tileCompactnessInput.value=String(A)),w!=null&&w.tileCompactnessValue&&(w.tileCompactnessValue.textContent=Zn.compactness(A)),Ee&&Mt(),f.push("tileCompactness")}if(r.titleWrapMode){const A=ce(r.titleWrapMode);ge(A),w!=null&&w.titleWrapInput&&(w.titleWrapInput.checked=A!=="nowrap"),f.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const A=at(parseFloat(r.titleHoverWidthMultiplier));We(A),w!=null&&w.titleWidthInput&&(w.titleWidthInput.value=String(A)),w!=null&&w.titleWidthValue&&(w.titleWidthValue.textContent=Zn.titleWidth(A)),f.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const A=je(parseFloat(r.titleHoverTextPortion));ze(A),w!=null&&w.titleZoomInput&&(w.titleZoomInput.value=String(A)),w!=null&&w.titleZoomValue&&(w.titleZoomValue.textContent=Zn.titleZoomPortion(A)),f.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const A=Ce(Xn(r.obsidianLinksEnabled));Re(A),w!=null&&w.obsidianToggle&&(w.obsidianToggle.checked=A),(kt=w==null?void 0:w.obsidianModeInputs)==null||kt.forEach(mt=>{mt.disabled=!A}),w!=null&&w.obsidianVaultInput&&(w.obsidianVaultInput.disabled=!A),Qe==null||Qe(),f.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const A=$e(r.obsidianLinkMode);be(A),(q=w==null?void 0:w.obsidianModeInputs)==null||q.forEach(mt=>{mt.checked=mt.value===A}),Qe==null||Qe(),f.push("obsidianLinkMode")}if(r.obsidianVault!=null){const A=ht(r.obsidianVault);$(A),w!=null&&w.obsidianVaultInput&&(w.obsidianVaultInput.value=A),Qe==null||Qe(),f.push("obsidianVault")}if(r.colorPresets&&(typeof c.setColorPresets=="function"&&c.setColorPresets(r.colorPresets),f.push("colorPresets")),r.linkThickness){const A=z==null?void 0:z(r.linkThickness);A&&(H==null||H(A),w!=null&&w.linkThicknessInput&&(w.linkThicknessInput.value=A),f.push("linkThickness"))}if(r.stripParentheticalNames!=null){const A=ae==null?void 0:ae(Xn(r.stripParentheticalNames));Ye==null||Ye(A),w!=null&&w.stripParentheticalToggle&&(w.stripParentheticalToggle.checked=A),f.push("stripParentheticalNames")}if(r.depColor){const A=oe==null?void 0:oe(r.depColor);A&&(D==null||D(A),w!=null&&w.depColorInput&&(w.depColorInput.value=A),f.push("depColor"))}if(r.revdepColor){const A=de==null?void 0:de(r.revdepColor);A&&(Ne==null||Ne(A),w!=null&&w.revdepColorInput&&(w.revdepColorInput.value=A),f.push("revdepColor"))}if(r.autoIdFromName!=null){const A=ie(Xn(r.autoIdFromName));x(A),w!=null&&w.autoIdToggle&&(w.autoIdToggle.checked=A),f.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const A=J(parseInt(r.seriesNavDoubleClickMs,10));ye(A),w!=null&&w.seriesNavInput&&(w.seriesNavInput.value=String(A)),w!=null&&w.seriesNavValue&&(w.seriesNavValue.textContent=Zn.seriesNavWait(A)),f.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&pt&&typeof pt.setAutoReloadEnabled=="function"){const A=Xn(r.autoReloadEnabled);pt.setAutoReloadEnabled(A),w!=null&&w.autoReloadToggle&&(w.autoReloadToggle.checked=A),w!=null&&w.autoReloadInput&&(w.autoReloadInput.disabled=!A),f.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&pt&&typeof pt.setAutoReloadInterval=="function"){const A=pt.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));w!=null&&w.autoReloadInput&&(w.autoReloadInput.value=String(A)),w!=null&&w.autoReloadValue&&(w.autoReloadValue.textContent=Zn.autoReloadInterval(A)),f.push("autoReloadIntervalMs")}if(r.centerItems!=null){const A=ue==null?void 0:ue(Xn(r.centerItems));Xe==null||Xe(A),w!=null&&w.tabCenterToggle&&(w.tabCenterToggle.checked=A),f.push("centerItems")}if(r.showSecondaryLinks!=null){const A=Xn(r.showSecondaryLinks);typeof c.setShowSecondaryLinks=="function"?c.setShowSecondaryLinks(A):c.showSecondaryLinks=A,w!=null&&w.secondaryLinksToggle&&(w.secondaryLinksToggle.checked=A),w!=null&&w.tabSecondaryLinksToggle&&(w.tabSecondaryLinksToggle.checked=A),Ee?gt(Ee):(Bt(),k()),f.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const A=Xn(r.showReusedInMap);typeof c.setShowReusedInMap=="function"?c.setShowReusedInMap(A):c.showReusedInMap=A,w!=null&&w.reusedToggle&&(w.reusedToggle.checked=A),g==null||g(),f.push("showReusedInMap")}return{applied:f}}function Jc(r,c){const f=new Blob([c],{type:"application/json"}),T=URL.createObjectURL(f),S=document.createElement("a");S.href=T,S.download=r,S.click(),URL.revokeObjectURL(T)}const oa=typeof{url:$n&&$n.tagName.toUpperCase()==="SCRIPT"&&$n.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function Yc(r={}){console.log("[Blockscape] init");const c={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},f=document.getElementById("jsonBox"),T=document.querySelector(".blockscape-json-panel"),S=document.getElementById("app"),G=document.getElementById("overlay"),ne=document.getElementById("tabTooltip"),Y=document.getElementById("modelList"),ee=document.getElementById("itemPreview"),C=document.getElementById("urlForm"),pe=document.getElementById("urlInput"),j=document.getElementById("loadUrl"),ce=ee.querySelector(".item-preview__title"),ge=ee.querySelector(".item-preview__body"),at=ee.querySelector(".item-preview__actions"),We=ee.querySelector(".item-preview__close"),je=document.getElementById("downloadJson"),ze=document.getElementById("shareModel"),z=document.getElementById("createVersion"),H=document.getElementById("copyJson"),oe=document.getElementById("copySeries"),D=document.getElementById("pasteJson"),de=document.getElementById("helpButton"),Ne=document.getElementById("newPanelButton"),Ce=document.getElementById("newBlankButton"),Re=document.getElementById("shortcutHelp"),$e=document.getElementById("shortcutHelpList"),be=document.getElementById("shortcutHelpClose"),ht=document.getElementById("shortcutHelpBackdrop"),$=document.getElementById("newPanel"),ie=document.getElementById("newPanelClose"),x=document.getElementById("newPanelBackdrop"),J=document.getElementById("search"),ye=document.getElementById("searchResults"),ue=document.getElementById("localBackendPanel"),Xe=document.getElementById("localBackendStatus"),ae=document.getElementById("localFileList"),Ye=document.getElementById("localDirSelect"),ft=document.getElementById("refreshLocalFiles"),rt=document.getElementById("loadLocalFile"),pt=document.getElementById("deleteLocalFile"),w=document.getElementById("toggleServerSidebar"),Qe=document.getElementById("saveLocalFile"),Mt=document.getElementById("saveLocalFileAs"),Ee=document.getElementById("localSavePath"),gt="blockscape:serverSidebarWide",Bt=document.title;ue&&(ue.hidden=!0),!c.localBackend&&ue&&(ue.hidden=!0),c.fileOpen||(rt&&(rt.hidden=!0),Ye&&(Ye.hidden=!0),ft&&(ft.hidden=!0),pt&&(pt.hidden=!0),ae&&(ae.hidden=!0)),c.fileSave||(Qe&&(Qe.hidden=!0),Mt&&(Mt.hidden=!0),Ee&&(Ee.hidden=!0)),f.value=document.getElementById("seed").textContent.trim();let k=[],g=-1;const he=Oc({models:k,getActiveIndex:()=>g,setActive:Dt,ensureModelMetadata:Bn,getModelId:yt,getSeriesId:On,ensureSeriesId:Ft,getModelTitle:Je,computeJsonFingerprint:ha,uid:bo});let K=null,xe=new Map,kt=new Map,q=null,A=null,mt=null,qe=null,cn=!0,Vn=!1,nn=!1,Qn="map",bt=null,on=null,mo=!1,_n=null;const Nn=2e3;let an=null,Wt=null,Jt=null,mn=null,It=null,rn=null,dn=null,Dn=null,sn=null,Cn="",d=!1,y=null,N=null;const M=new Map;let I=null,U=null,te=[],Z=null;const Me=30,ke=1e3,_e="blockscape:hoverScale",Oe=1.5,st=1,Be=2.5,St="blockscape:selectionDimOpacity",Vt="blockscape:selectionDimEnabled",dt=.2,Ve=.05,ut=1,jt="blockscape:titleWrap",Ze="blockscape:titleHoverWidth",ot="blockscape:titleHoverTextPortion",wt="wrap",zt=1.3,we=1,Ge=1.6,Mn=.25,Ka=0,Bs=.6,Ps="blockscape:tileCompactness",gi=1,Rs=.75,$s=1.25,Os="blockscape:obsidianLinksEnabled",Vs="blockscape:obsidianLinkMode",Ds="blockscape:obsidianVault",qa="title",ia="id",aa=qa,Us="blockscape:autoReloadEnabled",Hs="blockscape:autoReloadIntervalMs",bi=1e3,Fs=500,Ws=1e4,js="blockscape:autoIdFromName",ra=!0,zs="blockscape:stripParentheticalNames",sa=!0,Gs="blockscape:colorPresets",Ks="blockscape:centerItems",qs="blockscape:theme",Js="blockscape:bgImageUrl",md="https://commons.wikimedia.org/wiki/Category:Background_images#/media/File:Bank-vault-door-black-background-bw-web.jpg",Ys="blockscape:bgImageOpacity",Bo=.35,Zs="blockscape:sidebarBgEnabled",Xs=4,Po=1,la=4,Qs="0.2rem",Ro="light",ho="dark",ca="cat:",da=!1,ua=!1,el="blockscape:depColor",tl="blockscape:revdepColor",nl="blockscape:linkThickness",ol=6,il={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let $o=Oe,Un=dt,Hn=!0,Oo=gi,Ja=wt,Vo=zt,Do=Mn,Uo=!1,wi=aa,Ho="",go=ra,vi=sa,yi=Ro,Fn="",eo=Bo,Yt=[],vt=da,Si=ua,pa="",fa="",Ei="m",Fo=null,Ya=null;const al="blockscape:seriesNavDoubleClickMs",ki=900,rl=300,sl=4e3;let Wn=ki,to=!0;const ve={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSeriesPanelToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null,stripParentheticalToggle:null};let Wo=null;const hd={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:bi}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},et=c.localBackend?Gd():hd,ll=c.localBackend?et.detect():Promise.resolve(!1);he.hydrateConfig(),Qa(Ed()),Cd(),Ko(Rd(),{silent:!0}),Ld(),Nd(),Pd(),au(),ru(),cu(),pu(),du(),uu(),bu(),ku(),vu(),Iu(),su(),lu(),Eu(),xd(),Ad(),Xt();function bo(){return Math.random().toString(36).slice(2,10)}function gd(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function Za(e){var o,i;if(!e)return"";const t=(o=e==null?void 0:e.data)==null?void 0:o.backgroundUrl;if(t!=null)return t.toString();const n=(i=e==null?void 0:e.m)==null?void 0:i.backgroundUrl;return n!=null?n.toString():""}function bd(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function wd(e){return gd(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function vd(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),bd(t)}const cl=(e,t)=>Jc(e,t);function Xa(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function yd(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await lc(i),s=JSON.parse(a),l=Xa(s);if(l)return l}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function Sd(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];c.initialSettings&&t.push({type:"inline",snapshot:c.initialSettings}),c.initialSettingsUrl&&t.push({type:"url",url:c.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?Xa(o.snapshot):await yd(o.url);if(!i)continue;const a=cr(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function Ed(){if(typeof window>"u"||!window.localStorage)return Ro;try{return window.localStorage.getItem(qs)===ho?ho:Ro}catch{return Ro}}function kd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(qs,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function Qa(e){const t=e===ho?ho:Ro;return yi=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),kd(t),yi}function Id(e){const t=typeof e=="string"?parseFloat(e):e;return Number.isFinite(t)?Math.min(1,Math.max(0,t)):Bo}function dl(){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Js,Fn),window.localStorage.setItem(Ys,String(eo))}catch(e){console.warn("[Blockscape] background persistence failed",e)}}function _d(){return N||(N=document.createElement("div"),N.className="blockscape-bg-preview",document.body.appendChild(N),N)}function jo(e){if(!e)return;const t=Fn?`url("${Fn}")`:"none",n=Fn?eo:0;e.style.setProperty("--blockscape-bg-image",t),e.style.setProperty("--blockscape-bg-opacity",String(n));const o=Si?n*.7:0;e.style.setProperty("--blockscape-sidebar-bg-opacity",String(o)),typeof document<"u"&&(document.documentElement.style.setProperty("--blockscape-bg-image",t),document.documentElement.style.setProperty("--blockscape-bg-opacity",String(n)),document.documentElement.style.setProperty("--blockscape-sidebar-bg-opacity",String(o)))}function er(){if(!Fn){N&&(N.style.opacity="0");return}const e=_d();e.style.backgroundImage=`url("${Fn}")`,e.style.opacity=String(eo)}function Ii(e,{skipPersist:t=!1}={}){return eo=Id(e),S&&jo(S),S==null||S.querySelectorAll(".blockscape-root").forEach(jo),er(),t||dl(),eo}function _i(e){return Fn=(e||"").trim(),S&&jo(S),S==null||S.querySelectorAll(".blockscape-root").forEach(jo),er(),Ii(eo,{skipPersist:!0}),dl(),console.log("[Blockscape] background image set",{url:Fn,opacity:eo}),Fn}function Cd(){if(typeof window>"u"||!window.localStorage){_i(""),Ii(Bo);return}try{const e=window.localStorage.getItem(Js)||"",t=window.localStorage.getItem(Ys),n=t?parseFloat(t):Bo;_i(e),Ii(Number.isFinite(n)?n:Bo),er()}catch{_i(""),Ii(Bo)}}function ul(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ks,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function zo(e){return vt=!!e,S&&(S.classList.toggle("is-center-mode",vt),S.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",vt)}),S.querySelectorAll(".tile-add").forEach(t=>{t.hidden=vt,t.tabIndex=vt?-1:0,t.setAttribute("aria-hidden",vt?"true":"false")}),S.querySelectorAll(".category-add").forEach(t=>{t.hidden=vt,t.tabIndex=vt?-1:0,t.setAttribute("aria-hidden",vt?"true":"false")})),fl(),pl(),K&&(Ea(),xn()),vt}function xd(){if(typeof window>"u"||!window.localStorage)return zo(da);try{const e=window.localStorage.getItem(Ks);return e==null?zo(da):zo(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),zo(da)}}function Td(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Zs,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist sidebar background pref",t)}}function Ci(e){return Si=!!e,S&&jo(S),S==null||S.querySelectorAll(".blockscape-root").forEach(jo),Td(Si),Si}function Ad(){if(typeof window>"u"||!window.localStorage)return Ci(ua);try{const e=window.localStorage.getItem(Zs);return e==null?Ci(ua):Ci(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read sidebar background pref",e),Ci(ua)}}function xi(e){if(e==null)return null;const t=Number(e);if(!Number.isFinite(t))return null;const n=Math.round(t);return n<Po||n>la?null:n}function pl(){if(!S)return;const e=`repeat(${Xs}, minmax(var(--blockscape-tile), 1fr))`;S.querySelectorAll(".grid").forEach(t=>{const n=Array.from(t.querySelectorAll(".tile[data-stage]")).map((m,E)=>({tile:m,stage:xi(m.dataset.stage),order:E})),o=n.some(m=>m.stage),i=vt&&o;i?(t.style.gridTemplateColumns=e,t.style.gridAutoFlow="row",t.style.justifyContent="space-between",t.style.justifyItems="start",t.style.columnGap=Qs,t.style.rowGap=Qs):(t.style.removeProperty("grid-template-columns"),t.style.removeProperty("grid-auto-flow"),t.style.removeProperty("justify-content"),t.style.removeProperty("justify-items"),t.style.removeProperty("column-gap"),t.style.removeProperty("row-gap"));const a=m=>{m.style.removeProperty("grid-column"),m.style.removeProperty("grid-row")};if(t.querySelectorAll(".tile").forEach(a),!i)return;const s=n.filter(m=>m.stage).sort((m,E)=>m.stage!==E.stage?m.stage-E.stage:m.order-E.order),l=(m,E,P)=>{if(E.has(m)&&E.get(m)===P)return{col:m,needsNewRow:!0};const B=Xs-1;for(let R=0;R<=B;R+=1){const O=[];m-R>=Po&&O.push(m-R),R!==0&&m+R<=la&&O.push(m+R);for(const Q of O)if(!E.has(Q))return{col:Q,needsNewRow:!1}}return{col:null,needsNewRow:!1}};let u=1,h=new Map;s.forEach(({tile:m,stage:E})=>{let P=l(E,h,E);P.needsNewRow&&(u+=1,h=new Map,P=l(E,h,E)),P.col!=null&&(h.set(P.col,E),m.style.gridColumn=String(P.col),m.style.gridRow=String(u))})}),fl()}function fl(){Ya&&(Ya.hidden=!vt)}function Go(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function ml(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function tr(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function hl(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=Go(i[1]);if(a)return tr(a,n);if(t){const s=Go(t);if(s)return tr(s,n)}}return tr(o,n)}function gl(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function nr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(el,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function or(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(tl,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function ir(e){const t=hl(e,{fallbackVar:"--color-primary",fallbackColor:Ht.color.primary});return pa=t,ml("--blockscape-dep",t),G&&xn(),pa}function ar(e){const t=hl(e,{fallbackVar:"--color-danger",fallbackColor:Ht.blockscape.revdep});return fa=t,ml("--blockscape-revdep",t),G&&xn(),fa}function Ld(){const e=gl(el),t=ir(e||Go("--blockscape-dep")||Ht.color.primary);return nr(t),t}function Nd(){const e=gl(tl),t=ar(e||Go("--blockscape-revdep")||Ht.blockscape.revdep);return or(t),t}function Md(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function Bd(){return il[Ei]||il.m}function Ti(e){return Ei=Md(e),xn(),Ei}function rr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(nl,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function Pd(){if(typeof window>"u"||!window.localStorage)return Ti("m");try{const e=window.localStorage.getItem(nl),t=Ti(e||"m");return rr(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),Ti("m")}}function bl(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return Ai();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:Ai()}function Ai(){return[{name:"Black",value:Ht.color.ink},{name:"White",value:Ht.color.white},{name:"Red",value:Ht.blockscape.revdep},{name:"Green",value:Ht.color.success}]}function Rd(){if(typeof window>"u"||!window.localStorage)return Ai();try{const e=window.localStorage.getItem(Gs);if(!e)return Ai();const t=JSON.parse(e);return bl(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),Ai()}}function $d(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Gs,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function Ko(e,{silent:t=!1}={}){return Yt=bl(e),$d(Yt),!t&&typeof li=="function"&&li(Yt),Fo==null||Fo(),Yt}function Od(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function ma(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=wo(e);if(!o)return;const i=k[g],a=wo(i==null?void 0:i.sourcePath),s=t??(a&&a===o?yt(i):null),l=n??(a&&a===o?q:null),u=o.split("/").filter(Boolean).map(E=>encodeURIComponent(E)),h=s?encodeURIComponent(s):null,m=l?encodeURIComponent(l):null;try{const E=new URL(window.location.href),P=new URLSearchParams(E.search);P.delete("load"),P.delete("share");const B=["","server",...u,...h?[h]:[],...m?[m]:[]].join("/").replace(/\/+/g,"/");E.pathname=B,E.search=P.toString()?`?${P.toString()}`:"",E.hash="",window.history.replaceState({},document.title,E.toString())}catch(E){console.warn("[Blockscape] failed to update URL for server path",E)}}function Vd(e,{origin:t}={}){if(!(typeof window>"u"||!e))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-path",{detail:{path:e,origin:t}}))}catch(n){console.warn("[Blockscape] failed to notify local save path",n)}}function Dd({origin:e}={}){if(!(typeof window>"u"))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-clear",{detail:{origin:e}}))}catch(t){console.warn("[Blockscape] failed to notify local save clear",t)}}function Ud(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(O=>O.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex(O=>O.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),l=i.slice(a+1),u=O=>{try{return decodeURIComponent(O)}catch{return O}},h=s.map(u),m=l.map(u),E=h.join("/"),P=wo(E);if(!P)return null;const B=m[0]?m[0].trim():null,R=m[1]?m[1].trim():null;return{path:P,modelId:B||null,itemId:R||null}}function Hd(){if(!(typeof window>"u"||!window.location))try{const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(l=>l.toLowerCase()==="server");if(o===-1)return;const i=n.slice(0,o),a=new URLSearchParams(e.search);a.delete("load"),a.delete("share");const s=i.length?`/${i.join("/")}`:"/";e.pathname=s.replace(/\/+/g,"/"),e.search=a.toString()?`?${a.toString()}`:"",e.hash="",window.history.replaceState({},document.title,e.toString())}catch(e){console.warn("[Blockscape] failed to clear server path from URL",e)}}function sr({itemId:e}={}){const t=k[g];if(!(t!=null&&t.sourcePath)){Hd();return}ma(t.sourcePath,{modelId:yt(t),itemId:e===void 0?q:e})}function Fd(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function Wd(){if(typeof window>"u"||!window.localStorage)return!0;try{const e=window.localStorage.getItem(gt);return e==null?!0:e==="true"}catch{return!0}}function jd(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(gt,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist sidebar width",t)}}function wl(e){var t;typeof document>"u"||((t=document.body)==null||t.classList.toggle("blockscape-server-sidebar-wide",!!e),w&&(w.setAttribute("aria-pressed",e?"true":"false"),w.textContent=e?"<":">",w.title=e?"Switch to thin menu":"Switch to wide menu"))}function zd(e){if(!w||(w.hidden=!e,!e))return;let t=Wd();wl(t),w.onclick=()=>{t=!t,jd(t),wl(t)}}function Gd(){var io;const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(v,F={}){console.log("[Blockscape][local-backend]",v,{...e(),...F})}if(Fd())return t("Disabled on github.io host"),ue&&(ue.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};const n=Od();if(n&&typeof document<"u"&&((io=document.body)==null||io.classList.add("blockscape-server-mode")),zd(n),!n||!ue||!Xe)return t("Opt-in flag missing or panel unavailable"),ue&&(ue.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!ue||!Xe)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],l="",u=new Map,h=O(),m=De(),E=null,P=!1;const B=new Set;function R(){return B.size>0}function O(){if(typeof window>"u"||!window.localStorage)return!0;try{const v=window.localStorage.getItem(Us);return v==null?!0:v==="true"}catch{return!0}}function Q(v){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Us,v?"true":"false")}catch(F){console.warn("[Blockscape] auto-reload: failed to persist",F)}}function De(){if(typeof window>"u"||!window.localStorage)return bi;try{const v=window.localStorage.getItem(Hs);if(!v)return bi;const F=parseInt(v,10);return Ie(F)}catch{return bi}}function lt(v){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Hs,String(v))}catch(F){console.warn("[Blockscape] auto-reload: failed to persist interval",F)}}function Ie(v){return Number.isFinite(v)?Math.min(Ws,Math.max(Fs,v)):bi}function Fe(v){if(!v)return"";const F=v.split("/").filter(Boolean);return F.pop(),F.join("/")}function Ue(v,{error:F=!1}={}){Xe.textContent=v,Xe.style.color=F?Ht.color.dangerStrong:"",t("Status",{text:v,error:F})}function it(v){return wo(v)}function Gt(v){const F=wa(v);return F?{payload:F,isSeries:!0}:{payload:v==null?void 0:v.data,isSeries:!1}}function Pt(){var F;if(g>=0&&((F=k[g])!=null&&F.sourcePath))return k[g].sourcePath;if(g<0)return"blockscape.bs";const v=Je(k[g])||"blockscape";return`${In(v,"blockscape")}.bs`}function tt(){var F;if(!Ee)return;Ee.placeholder=Pt();const v=(F=k[g])==null?void 0:F.sourcePath;if(v){Ee.value=v;return}Ee.value&&(Ee.value="")}function ct(){if(!Ye)return;Ye.innerHTML="";const v=document.createElement("option");v.value="",v.textContent="Root (~/blockscape)",Ye.appendChild(v),s.forEach(re=>{const Se=document.createElement("option");Se.value=re,Se.textContent=re||"(root)",Ye.appendChild(Se)});const F=s.includes(l)?l:"";Ye.value=F,l=F}function Ut(){if(!ae)return;ae.innerHTML="";const v=a.filter(F=>Fe(F.path)===l);if(!v.length){const F=document.createElement("option");F.disabled=!0,F.textContent="No .bs files found yet",ae.appendChild(F),ae.disabled=!0;return}ae.disabled=!1,v.forEach(F=>{const re=document.createElement("option");re.value=F.path;const Se=F.mtimeMs?new Date(F.mtimeMs).toLocaleString():"";re.textContent=Se?`${F.path} · ${Se}`:F.path,ae.appendChild(re)}),i&&Array.from(ae.options).forEach(F=>{F.value===i&&(F.selected=!0)}),!ae.value&&ae.options.length&&(ae.options[0].selected=!0)}function hn(v){if(!o||!ae)return;if(!v){i="",Array.from(ae.options).forEach(nt=>{nt.selected=!1}),Ee&&(Ee.value="");return}if(!a.find(nt=>nt.path===v))return;const re=Fe(v);re!==l&&(l=re,ct()),Ut(),Array.from(ae.options).forEach(nt=>{nt.selected=nt.value===v});const Se=Array.from(ae.options).find(nt=>nt.value===v);Se!=null&&Se.scrollIntoView&&Se.scrollIntoView({block:"nearest"}),Ee&&(Ee.value=v)}function pn(){E&&(clearInterval(E),E=null)}function Ct(){pn(),!(!o||!h||R())&&(E=setInterval(gn,m))}function ln(v){if(!v)return;const F=B.size;B.add(v),B.size!==F&&(t("Auto-reload paused",{reason:v}),Ct())}function Qt(v){if(!v)return;B.delete(v)&&(t("Auto-reload resumed",{reason:v}),Ct())}async function en(v){const F=k.findIndex(re=>re.sourcePath===v);if(F!==-1)try{const re=await fetch(`/api/file?path=${encodeURIComponent(v)}`,{cache:"no-store"});if(!re.ok)throw new Error(`HTTP ${re.status}`);const Se=await re.json(),nt=JSON.stringify(Se.data??Se,null,2),Ke=no(nt,v,{seriesTitleOverride:`${v} series`});if(!Ke.length)return;const se=Ke[0];if(se.sourcePath=v,Bn(se,{titleHint:Je(k[F]),idHint:yt(k[F])}),se.isSeries){const Ae=se.title||Je(se)||Je(k[F]),Rt=In(Ae||"unknown");vo(se,Rt),Ft(se,{seriesName:Ae||"unknown",fallbackTitle:"unknown"})}k[F]={...k[F],...se,title:se.title||Je(se),data:se.data,sourcePath:v},F===g?(xt(),_t()):Pn(),console.log("[Blockscape] auto-reloaded model from",v)}catch(re){console.warn("[Blockscape] auto-reload failed for",v,re)}}async function gn(){if(!(!o||!h||R()||P)){P=!0;try{const v=await fetch("/api/files",{cache:"no-store"});if(!v.ok)throw new Error(`HTTP ${v.status}`);const re=((await v.json()).files||[]).slice().sort((se,Ae)=>{const Rt=(se==null?void 0:se.mtimeMs)||0,Tn=(Ae==null?void 0:Ae.mtimeMs)||0;return Rt===Tn?(se.path||"").localeCompare(Ae.path||""):Tn-Rt}),Se=new Map;re.forEach(se=>Se.set(se.path,se.mtimeMs||0));const nt=k.map((se,Ae)=>({path:se.sourcePath,idx:Ae})).filter(se=>se.path);for(const se of nt){const Ae=u.get(se.path)||0;(Se.get(se.path)||0)>Ae&&await en(se.path)}a=re;const Ke=new Set;a.forEach(se=>Ke.add(Fe(se.path))),s=Array.from(Ke).filter(se=>se!=="").sort(),u=Se,ct(),Ut()}catch(v){console.warn("[Blockscape] auto-reload check failed",v)}finally{P=!1}}}function oo(v){h=!!v,Q(h),Ct()}function bn(v){return m=Ie(v),lt(m),Ct(),m}function At(v){o=!1,a=[],u=new Map,pn(),Ut(),ue.hidden=!0,v&&Ue(v,{error:!0}),t("Panel hidden",{message:v})}async function fn({silent:v=!1}={}){try{t("Health check start");const F=await fetch("/api/health",{cache:"no-store"});if(!F.ok)throw new Error(`HTTP ${F.status}`);const re=await F.json();if(o=!!(re!=null&&re.ok),!o)throw new Error("Health check failed");return ue.hidden=!1,v||Ue(re.root?`Local server ready (root: ${re.root})`:"Local server ready"),t("Health check ok",{payload:re}),!0}catch(F){return v||console.log("[Blockscape] local backend health failed",F),At("Local server unavailable"),!1}}async function tn(){if(o&&ae){Ue("Loading files…");try{const v=await fetch("/api/files",{cache:"no-store"});if(!v.ok)throw new Error(`HTTP ${v.status}`);a=((await v.json()).files||[]).slice().sort((Ke,se)=>{const Ae=(Ke==null?void 0:Ke.mtimeMs)||0,Rt=(se==null?void 0:se.mtimeMs)||0;return Ae===Rt?(Ke.path||"").localeCompare(se.path||""):Rt-Ae});const re=new Set;a.forEach(Ke=>{re.add(Fe(Ke.path))}),s=Array.from(re).filter(Ke=>Ke!=="").sort(),l&&!re.has(l)&&(l=""),!l&&i&&(l=Fe(i)),u=new Map(a.map(Ke=>[Ke.path,Ke.mtimeMs||0])),ct(),Ut();const Se=a.filter(Ke=>Fe(Ke.path)===l).length,nt=l?`~/blockscape/${l}`:"~/blockscape";Ue(Se?`Browsing ${Se} file(s) in ${nt}`:`No .bs files in ${nt} yet`)}catch(v){console.warn("[Blockscape] local backend refresh failed",v),At("Local server unavailable")}}}async function $i(){o=!1,At(),Ue("Checking for local server…");try{return t("Detect start"),await fn()?(tt(),await tn(),Ct(),!0):!1}catch(v){return o=!1,console.log("[Blockscape] local backend not detected",v),t("Detect failed",{err:v}),!1}}async function Io(){if(!o||!ae)return;const v=Array.from(ae.selectedOptions||[]).map(re=>re.value).filter(Boolean).sort((re,Se)=>re.localeCompare(Se));if(!v.length){alert("Select one or more files to load from ~/blockscape.");return}let F=null;for(const re of v)try{Ue(`Loading ${re}…`);const Se=await vl(re);F==null&&(F=(Se==null?void 0:Se.firstIndex)??null),i=re,ma(re)}catch(Se){console.error("[Blockscape] failed to load from local server",Se),alert(`Local load failed for ${re}: ${Se.message}`)}F!=null&&Dt(F),Ue(`Loaded ${v.length} file(s)`),Ut()}async function _r(){if(!o||!ae)return;const v=Array.from(ae.selectedOptions||[]).map(se=>se.value).filter(Boolean).sort((se,Ae)=>se.localeCompare(Ae));if(!v.length){alert("Select one or more files to delete from ~/blockscape.");return}const F=v.length,re=F===1?v[0]:`${F} file(s)`,Se=F===1?`Delete "${re}" from ~/blockscape? This cannot be undone.`:`Delete ${re} from ~/blockscape? This cannot be undone.`;if(!window.confirm(Se))return;const nt="local-files-delete";ln(nt);const Ke=[];try{Ue(`Deleting ${re}…`);for(const se of v)try{const Ae=await fetch(`/api/file?path=${encodeURIComponent(se)}`,{method:"DELETE"});if(!Ae.ok)throw new Error(`HTTP ${Ae.status}`);se===i&&(i=""),(Ee==null?void 0:Ee.value)===se&&(Ee.value="")}catch(Ae){Ke.push(se),console.warn("[Blockscape] local delete failed",se,Ae)}await tn(),Ke.length?Ue(`Deleted ${F-Ke.length} file(s), ${Ke.length} failed`,{error:!0}):Ue(`Deleted ${F} file(s)`)}finally{Qt(nt)}}async function _a(v,{statusPrefix:F="Saved to",updateInput:re=!0}={}){if(!o)return;if(g<0){alert("No active model to save.");return}const Se=k[g],{payload:nt,isSeries:Ke}=Gt(Se);if(!nt){alert("No model data to save.");return}const se=it(v);if(!se){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const Ae=JSON.stringify(nt,null,2);Ue(`Saving ${Ke?"series":"map"} to ${se}…`);const Tn=await fetch(`/api/file?path=${encodeURIComponent(se)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:Ae});if(!Tn.ok)throw new Error(`HTTP ${Tn.status}`);const Kt=await Tn.json();i=Kt.path||se,Se.sourcePath=Kt.path||se,re&&Ee&&(Ee.value=Kt.path||se),ma(Kt.path||se),Ue(`${F} ${Kt.path||se}`),await tn()}catch(Ae){console.error("[Blockscape] local save failed",Ae),alert(`Local save failed: ${Ae.message}`),At("Local server unavailable")}}async function Ca(){var F;const v=it(Ee==null?void 0:Ee.value)||it((F=k[g])==null?void 0:F.sourcePath)||Pt();if(!v){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await _a(v,{statusPrefix:"Saved to"})}async function xa(){var Se;if(!o)return;if(g<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const v=it((Se=k[g])==null?void 0:Se.sourcePath)||Pt(),F=window.prompt("Save active map as (under ~/blockscape):",v);if(F==null)return;const re=it(F);if(!re){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await _a(re,{statusPrefix:"Saved to"})}async function _o(v,F,{refreshAfter:re=!0,statusPrefix:Se="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(v)||v<0)return{ok:!1,error:"Invalid model index"};const nt=k[v],{payload:Ke,isSeries:se}=Gt(nt);if(!Ke)return{ok:!1,error:"Model has no data"};const Ae=it(F)||it(nt==null?void 0:nt.sourcePath)||Pt();if(!Ae)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const Rt=JSON.stringify(Ke,null,2);Ue(`Saving ${se?"series":"map"} to ${Ae}…`);const Kt=await fetch(`/api/file?path=${encodeURIComponent(Ae)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:Rt});if(!Kt.ok)throw new Error(`HTTP ${Kt.status}`);const ao=await Kt.json();return i=ao.path||Ae,nt.sourcePath=ao.path||Ae,v===g&&tt(),Ue(`${Se} ${ao.path||Ae}`),re&&await tn(),{ok:!0,path:ao.path||Ae}}catch(Rt){return console.error("[Blockscape] local save failed",Rt),At("Local server unavailable"),{ok:!1,error:Rt.message}}}if(ft&&(ft.onclick=()=>tn()),rt&&(rt.onclick=()=>Io()),pt&&(pt.onclick=()=>_r()),Qe&&(Qe.onclick=()=>Ca()),Mt&&(Mt.onclick=()=>xa()),ae&&Ee&&(ae.addEventListener("change",()=>{const v=Array.from(ae.selectedOptions||[])[0];v!=null&&v.value&&(Ee.value=v.value)}),ae.addEventListener("dblclick",()=>{Io()})),Ye&&Ye.addEventListener("change",()=>{l=Ye.value||"",Ut()}),ue){const v="local-files-panel-focus",F="local-files-panel-pointer";let re=!1,Se=!1;ue.addEventListener("focusin",()=>{re||(re=!0,ln(v))}),ue.addEventListener("focusout",nt=>{if(!re)return;const Ke=nt.relatedTarget;Ke&&ue.contains(Ke)||(re=!1,Qt(v))}),ue.addEventListener("pointerenter",()=>{Se||(Se=!0,ln(F))}),ue.addEventListener("pointerleave",()=>{Se&&(Se=!1,Qt(F))})}return{detect:$i,refresh:tn,updateActiveSavePlaceholder:tt,isAvailable:()=>o,highlightSource:hn,saveModelByIndex:_o,getAutoReloadConfig:()=>({enabled:h,intervalMs:m,available:o}),setAutoReloadEnabled:oo,setAutoReloadInterval:bn}}async function vl(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=no(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let l=null;return s.forEach((u,h)=>{if(u.sourcePath=e,u.isSeries&&!u.title){const P=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");u.title=P}const m=jn(u,{versionLabel:s.length>1?`${t} #${h+1}`:t});l==null&&(l=m)}),{firstIndex:l,total:s.length}}async function yl(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function Kd(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Zt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function wo(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function qd(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function Jd(e,t){const n=wo(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function lr(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function Li(){try{await ll}catch{}return typeof(et==null?void 0:et.isAvailable)=="function"?et.isAvailable():!1}async function Yd(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function Zd(e,t){const n=wo(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const l=`${a}-${s}.bs`,u=[...o,l].filter(Boolean).join("/");if(!t.has(u))return u}return null}function Xd(e,t="clipboard"){const n=Je(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=Zt(n),i=lr();return`${o}-${i}.bs`}function Qd(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=qd(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=In(n||"unknown");return vo(e,o),Ft(e,{seriesName:n,fallbackTitle:n}),!0}function eu(e){return Number.isFinite(e)?Math.min(Be,Math.max(st,e)):Oe}function Xt(){if(!S)return;const e=!!q||!!A;S.classList.toggle("blockscape-has-selection",e),S.classList.toggle("blockscape-has-item-selection",!!q)}function qo(e){return $o=eu(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",$o),$o}function tu(e){return Number.isFinite(e)?Math.min(ut,Math.max(Ve,e)):dt}function Jo(e){Un=tu(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Un);const t=Hn?Un:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Un}function nu(e){return Number.isFinite(e)?Math.min($s,Math.max(Rs,e)):gi}function Yo(e){return Oo=nu(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",Oo),Oo}function ou(e){return Number.isFinite(e)?Math.min(Ge,Math.max(we,e)):zt}function Zo(e){return Vo=ou(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",Vo),Vo}function iu(e){return Number.isFinite(e)?Math.min(Bs,Math.max(Ka,e)):Mn}function Xo(e){return Do=iu(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Do),Do}function Qo(e){const t=e==="nowrap"?"nowrap":"wrap";Ja=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function Sl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(_e,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function au(){if(typeof window>"u"||!window.localStorage)return qo(Oe);try{const e=window.localStorage.getItem(_e);if(!e)return qo(Oe);const t=parseFloat(e);return qo(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),qo(Oe)}}function El(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(St,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function ru(){if(typeof window>"u"||!window.localStorage)return Jo(dt);try{const e=window.localStorage.getItem(St);if(!e)return Jo(dt);const t=parseFloat(e);return Jo(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Jo(dt)}}function ei(e){Hn=!!e;const t=Hn?Un:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),S&&S.classList.toggle("blockscape-dimming-disabled",!Hn),Hn}function kl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Vt,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function su(){if(typeof window>"u"||!window.localStorage)return ei(!0);try{const e=window.localStorage.getItem(Vt);return e==null?ei(!0):ei(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),ei(!0)}}function ti(e){return go=!!e,go}function Il(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(js,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function lu(){if(typeof window>"u"||!window.localStorage)return ti(ra);try{const e=window.localStorage.getItem(js);return e==null?ti(ra):ti(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),ti(ra)}}function _l(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ps,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function cu(){if(typeof window>"u"||!window.localStorage)return Yo(gi);try{const e=window.localStorage.getItem(Ps);if(!e)return Yo(gi);const t=parseFloat(e);return Yo(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Yo(gi)}}function Cl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ze,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function du(){if(typeof window>"u"||!window.localStorage)return Zo(zt);try{const e=window.localStorage.getItem(Ze);if(!e)return Zo(zt);const t=parseFloat(e);return Zo(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Zo(zt)}}function xl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ot,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function uu(){if(typeof window>"u"||!window.localStorage)return Xo(Mn);try{const e=window.localStorage.getItem(ot);if(!e)return Xo(Mn);const t=parseFloat(e);return Xo(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Xo(Mn)}}function Tl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(jt,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function pu(){if(typeof window>"u"||!window.localStorage)return Qo(wt);try{const e=window.localStorage.getItem(jt);return Qo(e||wt)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Qo(wt)}}function fu(e){return Number.isFinite(e)?Math.min(sl,Math.max(rl,e)):ki}function ni(e){return Wn=fu(e),Wn}function mu(e){cn=!!e}function hu(e){nn=!!e}function Al(e){return to=e!==!1,Wo&&(Wo.hidden=!to,Wo.style.display=to?"":"none"),ve.tabSeriesPanelToggle&&(ve.tabSeriesPanelToggle.checked=to),to}function Ll(){return{hoverScale:$o,selectionDimOpacity:Un,selectionDimEnabled:Hn,tileCompactness:Oo,titleWrapMode:Ja,titleHoverWidthMultiplier:Vo,titleHoverTextPortion:Do,obsidianLinksEnabled:Uo,obsidianLinkMode:wi,obsidianVaultName:Ho,autoIdFromNameEnabled:go,seriesNavDoubleClickWaitMs:Wn,showSecondaryLinks:cn,stripParentheticalNames:vi,centerItems:vt,showReusedInMap:nn,theme:yi,colorPresets:Yt,depColor:pa,revdepColor:fa,linkThickness:Ei}}function cr(e,{refreshObsidianLinks:t}={}){return qc(e,{applyTileHoverScale:qo,persistTileHoverScale:Sl,applySelectionDimEnabled:ei,persistSelectionDimEnabled:kl,applySelectionDimOpacity:Jo,persistSelectionDimOpacity:El,applyTileCompactness:Yo,persistTileCompactness:_l,applyTitleWrapMode:Qo,persistTitleWrapMode:Tl,applyTitleHoverWidthMultiplier:Zo,persistTitleHoverWidthMultiplier:Cl,applyTitleHoverTextPortion:Xo,persistTitleHoverTextPortion:xl,applyObsidianLinksEnabled:ii,persistObsidianLinksEnabled:Pl,applyObsidianLinkMode:oi,persistObsidianLinkMode:Bl,applyObsidianVaultName:ri,persistObsidianVaultName:Rl,applyAutoIdFromNameEnabled:ti,persistAutoIdFromNameEnabled:Il,applySeriesNavDoubleClickWait:ni,persistSeriesNavDoubleClickWait:Ml,localBackend:et,ui:ve,refreshObsidianLinks:t,scheduleOverlaySync:Eo,selection:q,select:Tt,clearStyles:Ia,drawLinks:xn,applyReusedHighlights:kr,setShowSecondaryLinks:mu,setShowReusedInMap:hu,applyDepColor:ir,persistDepColor:nr,applyRevdepColor:ar,persistRevdepColor:or,applyLinkThickness:Ti,persistLinkThickness:rr,applyStripParentheticalNames:ai,persistStripParentheticalNames:dr,applyTheme:Qa,setColorPresets:Ko,applyCenterItems:zo,persistCenterItems:ul,current:Ll()})}const Nl=()=>({version:1,exportedAt:new Date().toISOString(),settings:Kc(Ll(),{localBackend:et})}),gu=e=>{const t=Xa(e);return cr(t||{})};typeof window<"u"&&(window.__blockscapeSettingsBridge={exportPayload:Nl,applyPayload:gu});function Ml(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(al,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function bu(){if(typeof window>"u"||!window.localStorage)return ni(ki);try{const e=window.localStorage.getItem(al);if(!e)return ni(ki);const t=parseInt(e,10);return ni(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),ni(ki)}}function wu(e){return e===ia?ia:qa}function oi(e){return wi=wu(e),wi}function Bl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Vs,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function vu(){if(typeof window>"u"||!window.localStorage)return oi(aa);try{const e=window.localStorage.getItem(Vs);return oi(e||aa)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),oi(aa)}}function ii(e){return Uo=!!e,Uo}function yu(e){const t=(e??"").toString();return t.replace(/\s*\([^)]*\)\s*$/,"").trim()||t.trim()}function Ni(e){const t=(e&&typeof e=="object"?e.name||e.id:e)||"";return vi?yu(t):t}function Su(){if(S&&(S.querySelectorAll(".tile .name").forEach(e=>{var a;const t=e.closest(".tile"),n=(a=t==null?void 0:t.dataset)==null?void 0:a.id,o=n?si(n):null,i=o!=null&&o.item?Ni(o.item):Ni(n);e.textContent=i}),J&&yr(J.value||""),q)){const e=si(q);e!=null&&e.item&&ce&&(ce.textContent=Ni(e.item))}}function ai(e){return vi=!!e,Su(),vi}function dr(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(zs,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist strip parentheses",t)}}function Eu(){if(typeof window>"u"||!window.localStorage)return ai(sa);try{const e=window.localStorage.getItem(zs);if(e==null)return ai(sa);const t=ai(e==="1"||e==="true");return dr(t),t}catch(e){return console.warn("[Blockscape] failed to read strip parentheses",e),ai(sa)}}function Pl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Os,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function ku(){if(typeof window>"u"||!window.localStorage)return ii(!1);try{const e=window.localStorage.getItem(Os);return e==null?ii(!1):ii(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),ii(!1)}}function ri(e){return Ho=(e??"").toString().trim(),Ho}function Rl(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ds,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Iu(){if(typeof window>"u"||!window.localStorage)return ri("");try{const e=window.localStorage.getItem(Ds);return ri(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),ri("")}}function _u(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Cu(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function vo(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function xu(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||ga(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=On(e,{seriesName:o,fallbackTitle:o})||In(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=In(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,vo(e,s),!0}function ur(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>ur(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${ur(e[o])}`).join(",")}}`}function $l(e){try{return ur(e)}catch{return""}}function ha(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=$l(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=$l(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const Tu=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category (cycles item.stage in Center view)."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function Bn(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=Zt(a).replace(/\./g,"-");e.id=s||`model-${bo()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function Au(e){var s,l;const t=u=>{const h=(u??"").toString().trim();if(!h)return{base:"",suffix:null};const m=h.match(/^(.*?)-(\d+)$/);return{base:m?m[1]:h,suffix:m?Number.parseInt(m[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const u of n){if(u!=null&&u.isCategoryView)continue;const h=t(((l=u==null?void 0:u.data)==null?void 0:l.id)??(u==null?void 0:u.id)??"");if(h.base){i=h.base;break}}i||(i=Zt(On(e)||pr(e)||Je(e,"model")));let a=0;return n.forEach(u=>{var m;if(u!=null&&u.isCategoryView)return;const h=t(((m=u==null?void 0:u.data)==null?void 0:m.id)??(u==null?void 0:u.id)??"");h.base===i&&Number.isFinite(h.suffix)&&h.suffix>a&&(a=h.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function Lu(e){return JSON.parse(JSON.stringify(e))}function Je(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function ga(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=yt(e);return a?`${a} series`:t}return Je(e,t)}function yt(e){var i;const t=On(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function pr(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function Nu(e){return e?e.toString().replace(/-series$/i,""):null}function fr(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<k.length;n++){const o=(yt(k[n])||"").toLowerCase(),i=(pr(k[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function Ol(e){var l;if(e<0||e>=k.length||!f)return!0;const t=k[e],n=(f.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Bn(o,{titleHint:Je(t),idHint:yt(t)});const i=ha(t.data),a=ha(o);if(i===a)return!0;t.data=o;const s=zn(t);return s>=0&&((l=t.apicurioVersions)!=null&&l[s])&&(t.apicurioVersions[s].data=o),!0}function Vl(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function si(e){if(g<0||!e)return null;const t=k[g].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function Mu(e,t){const n=si(e);return n?(t?n.item.color=t:delete n.item.color,xt(),_t(),Tt(e),!0):!1}function Bu(e){if(g<0||!e)return!1;const t=k[g].data,o=((t==null?void 0:t.categories)||[]).find(a=>a.id===e);if(!o)return!1;let i=!1;return(o.items||[]).forEach(a=>{xi(a.stage)!=null&&(delete a.stage,i=!0)}),i?(xt(),_t(),q&&Tt(q),!0):!1}function Pu(e,t){if(!e||!t||g<0)return!1;const n=si(e);if(!n)return!1;const o=xi(n.item.stage),i=o??(t>0?Po:la),a=la-Po+1,s=((i-Po+t)%a+a)%a,l=Po+s;return n.item.stage=l,xt(),_t(),Tt(e),!0}function Ru(e,t){const n=Vl(t);let o=Zt(e||"item");if(!n.has(o))return o;const i=()=>bo().slice(0,4);for(;n.has(o);)o=`${Zt(e||"item")}-${i()}`;return o}function $u(e="category",t){const n=(t==null?void 0:t.categories)||[],o=Zt(e||"category"),i=l=>n.some(u=>u.id===l);let a=o||`category-${bo()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const yo=Fc({findItemAndCategoryById:si,collectAllItemIds:Vl,updateItemReferences:Hc,loadActiveIntoEditor:xt,rebuildFromActive:_t,select:e=>Tt(e),onSelectionRenamed:(e,t)=>{var n;q===e&&(q=t,Xt()),((n=bt==null?void 0:bt.item)==null?void 0:n.id)===e&&(bt.item.id=t)},makeSlug:Zt,isAutoIdFromNameEnabled:()=>go});function Ou({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=R=>{if(a.fields.errorEl){if(!R){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=R}},l=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},u=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var R,O;(R=a.fields.titleInput)==null||R.focus(),(O=a.fields.titleInput)==null||O.select()}))},h=({force:R}={})=>{var Q,De;if(!go||!a.autoSyncEnabled||!((Q=a.fields)!=null&&Q.idInput)||!((De=a.fields)!=null&&De.titleInput)||!R&&a.idManuallyEdited)return;const O=Zt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=O},m=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const R=a.modelData.categories||[],O=R.find(Fe=>Fe.id===a.categoryId);if(!O)throw new Error("Category not found.");const Q=(a.fields.idInput.value||"").trim();if(!Q)throw new Error("ID is required.");const De=(a.fields.titleInput.value||"").trim();if(R.some(Fe=>Fe.id===Q&&Fe.id!==O.id))throw new Error("Another category already uses that ID.");const Ie=O.id;return O.id=Q,O.title=De||O.id,Ie!==Q&&typeof i=="function"&&i(Ie,Q),t(),n(),o(Q,{scrollIntoView:!0}),!0},E=()=>{try{return m(),l(),!0}catch(R){return console.warn("[CategoryEditor] save failed",R),s((R==null?void 0:R.message)||"Unable to save category."),!1}},P=()=>{if(a.wrapper)return a.wrapper;const R=document.createElement("div");R.className="item-editor-modal category-editor-modal",R.hidden=!0,R.setAttribute("role","dialog"),R.setAttribute("aria-modal","true");const O=document.createElement("div");O.className="item-editor-modal__backdrop",R.appendChild(O);const Q=document.createElement("div");Q.className="item-editor",R.appendChild(Q);const De=document.createElement("div");De.className="item-editor__header";const lt=document.createElement("h2");lt.className="item-editor__title",lt.textContent="Edit category";const Ie=document.createElement("button");Ie.type="button",Ie.className="item-editor__close",Ie.setAttribute("aria-label","Close category editor"),Ie.textContent="×",De.appendChild(lt),De.appendChild(Ie),Q.appendChild(De);const Fe=document.createElement("form");Fe.className="item-editor__form",Q.appendChild(Fe);const Ue=document.createElement("div");Ue.className="item-editor__meta",Ue.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',Fe.appendChild(Ue);const it=document.createElement("div");it.className="item-editor__error",it.hidden=!0,Fe.appendChild(it);const Gt=(gn,oo,bn)=>{const At=document.createElement("label");At.className="item-editor__field";const fn=document.createElement("span");if(fn.className="item-editor__label",fn.textContent=gn,At.appendChild(fn),oo.classList.add("item-editor__control"),At.appendChild(oo),bn){const tn=document.createElement("div");tn.className="item-editor__hint",tn.textContent=bn,At.appendChild(tn)}return At},Pt=document.createElement("input");Pt.type="text",Fe.appendChild(Gt("Title",Pt,"Display label shown in the map."));const tt=document.createElement("input");tt.type="text",tt.required=!0,Fe.appendChild(Gt("ID",tt,"Unique identifier for this category (used in URLs and references)."));const ct=document.createElement("div");ct.className="item-editor__checkbox";const Ut=document.createElement("label");Ut.className="item-editor__checkbox-row";const hn=document.createElement("input");hn.type="checkbox";const pn=document.createElement("span");pn.textContent="Sync ID while editing title";const Ct=document.createElement("div");Ct.className="item-editor__hint",Ct.textContent="Turn off to keep typing titles without changing the ID.",Ut.append(hn,pn),ct.append(Ut,Ct),Fe.appendChild(ct);const ln=document.createElement("div");ln.className="item-editor__actions";const Qt=document.createElement("button");Qt.type="submit",Qt.className="item-editor__action item-editor__action--primary",Qt.textContent="Save";const en=document.createElement("button");return en.type="button",en.className="item-editor__action",en.textContent="Cancel",ln.appendChild(Qt),ln.appendChild(en),Fe.appendChild(ln),Fe.addEventListener("submit",gn=>{gn.preventDefault(),E()}),en.addEventListener("click",l),Ie.addEventListener("click",l),O.addEventListener("click",l),tt.addEventListener("input",()=>{a.idManuallyEdited=!0}),Pt.addEventListener("input",()=>h()),hn.addEventListener("change",()=>{a.autoSyncEnabled=!!hn.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,h({force:!0}))}),R.addEventListener("keydown",gn=>{gn.key==="Escape"&&(gn.preventDefault(),l())}),document.body.appendChild(R),a.wrapper=R,a.fields={titleInput:Pt,idInput:tt,errorEl:it,metaLabel:Ue.querySelector(".item-editor__meta-value"),syncCheckbox:hn},R};return{open:R=>{if(!R||!P())return!1;const Q=e(),lt=((Q==null?void 0:Q.categories)||[]).find(Fe=>Fe.id===R);if(!lt)return!1;a.categoryId=lt.id,a.modelData=Q,a.idManuallyEdited=!1;const Ie=!!go;return a.autoSyncEnabled=Ie,a.fields.metaLabel.textContent=lt.title||lt.id||"Category",a.fields.titleInput.value=lt.title||lt.id||"",a.fields.idInput.value=lt.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!Ie,!a.fields.idInput.value&&Ie&&h({force:!0}),s(""),u(),!0},hide:l,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const Vu=Ou({getActiveModelData:()=>{var e;return(e=k[g])==null?void 0:e.data},loadActiveIntoEditor:xt,rebuildFromActive:_t,selectCategory:(e,t={})=>Gn(e,t),onCategoryRenamed:(e,t)=>{A===e&&(A=t,Xt())}}),{handleTileContextMenu:Du,hidePreview:So,handleDocumentClick:Uu,handleWindowResize:Hu,handleWindowScroll:Fu,updateColorPresets:li}=Gc({menuEl:document.getElementById("tileContextMenu"),previewEl:ee,previewTitleEl:ce,previewBodyEl:ge,previewActionsEl:at,previewCloseEl:We,escapeHtml:Pi,onEditItem:e=>yo.open(e),onChangeColor:(e,t)=>Mu(e,t),selectItem:e=>Tt(e),colorPresets:Yt});function ba(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||Je(e);return Ft(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function Wu({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=Zt(`${e||"blank"}-${lr()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),Bn(o,{titleHint:t,idHint:n}),o}function ju(){const t=`Blank series ${lr()}`,n=In(t,"blank-series"),o=Wu({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return vo(i,n),Ft(i,{seriesName:t,fallbackTitle:t}),i}function zu(){const e=ju(),t=jn(e,{versionLabel:"blank"});return Dt(t),Dd({origin:"new-blank"}),va(),un("Blank series created. Add categories and tiles to start.",2600),t}function jn(e,{versionLabel:t,createdOn:n}={}){var u,h,m;if(e!=null&&e.isSeries||((u=e==null?void 0:e.apicurioVersions)==null?void 0:u.length)>1){const E=e.title||Je(e);Ft(e,{seriesName:E,fallbackTitle:E}),ya(e)}const o=yt(e);if(!o)return ba(e,{versionLabel:t||"1",createdOn:n}),k.push(e),k.length-1;const i=k.findIndex(E=>yt(E)===o);if(i===-1)return ba(e,{versionLabel:t||"1",createdOn:n}),k.push(e),k.length-1;const a=k[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(m=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:m.createdOn}],a.apicurioActiveVersionIndex=0;const E=a.title||Je(a);Ft(a,{seriesName:E,fallbackTitle:E})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=Je(e)||a.title,a.isSeries=!0;const l=a.title||Je(a);return Ft(a,{seriesName:l,fallbackTitle:l}),i}function Dl({versionLabel:e}={}){var l;if(g<0||!k[g])throw new Error("Load or select a model before creating a version.");const t=k[g];ba(t,{versionLabel:"1"});const n=Au(t);let o;try{o=Lu(t.data)}catch(u){throw console.warn("[Blockscape] failed to clone active model for versioning",u),new Error("Could not copy the current model.")}n&&(o.id=n),Bn(o,{titleHint:Je(t),idHint:yt(t)||On(t)});const a={version:e||String((((l=t.apicurioVersions)==null?void 0:l.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||Je(t);return Ft(t,{seriesName:s,fallbackTitle:s}),g}function mr(){const e=g>=0&&k[g]?k[g]:null,t=yt(e);document.title=t?`${t}-blockscape`:Bt}function wa(e){if(!e)return null;ya(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||Je(e);return Ft(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var u;const s=((i==null?void 0:i.version)??"").toString().trim(),l=(((u=i==null?void 0:i.data)==null?void 0:u.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(ca)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:l}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function Gu(){const e=k[g],t=wa(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function Ul(e="shortcut",t=!1){const n=f.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=k[g],i=t?wa(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,l=On(o),u=yt(o),h=l||u||Je(o,"blockscape"),m=a?"-series":"",E=`${Zt(h)}${m}.bs`;return cl(E,s),console.log(`[Blockscape] saved JSON (${e}):`,E),!0}const Ku=Ht.palette.letter,qu=Ht.palette.letterFallback;function Hl(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Ku[n]||qu}function Ju(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?Ht.color.ink:Ht.color.white}function Yu(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function hr(){if(It)return;It=document.createElement("div"),It.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",rn=document.createElement("span"),rn.className="series-nav-notice__text",It.appendChild(e),It.appendChild(rn),document.body.appendChild(It)}function gr(){dn&&(clearTimeout(dn),dn=null),It&&It.classList.remove("is-visible"),rn&&(rn.textContent="")}function ci(){an=null,Wt&&(clearTimeout(Wt),Wt=null),gr()}function br(){Jt=null,mn&&(clearTimeout(mn),mn=null),gr()}function Zu(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function Xu(e,t,n){hr(),an={id:e,targetVersionIndex:t},Wt&&clearTimeout(Wt),Wt=setTimeout(()=>{Wt=null,ci()},Wn);const o=Zu(n,t);un(`Click again to open ${o} in this series.`,Wn)}function Qu(e,t){hr(),Jt={id:e,targetIndex:t},mn&&clearTimeout(mn),mn=setTimeout(()=>{mn=null,br()},Wn);const n=ga(k[t]);un(`Click again to open "${n}".`,Wn)}function un(e,t=Nn,n=null){if(hr(),rn.textContent="",rn.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,rn.appendChild(o),rn.appendChild(i)}It.classList.add("is-visible"),dn&&clearTimeout(dn),dn=setTimeout(()=>gr(),t)}function ep(){$e&&($e.innerHTML="",Tu.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const l=document.createElement("span");l.className="shortcut-help__or",l.textContent="or",n.appendChild(l)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((l,u)=>{if(u>0){const m=document.createElement("span");m.className="shortcut-help__sep",m.textContent="+",s.appendChild(m)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=l,s.appendChild(h)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),$e.appendChild(t)}),mo=!0)}function tp(){return!!Re&&Re.hidden===!1}function np(){if(!Re)return;mo||ep(),_n=document.activeElement,Re.hidden=!1,Re.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=Re.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function wr(){if(!Re||Re.hidden)return;Re.hidden=!0,Re.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=_n;e!=null&&e.focus?e.focus({preventScroll:!0}):de!=null&&de.focus&&de.focus({preventScroll:!0})}function op(){if(!$)return;$.hidden=!1,$.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=$.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function va(){!$||$.hidden||($.hidden=!0,$.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),Ne!=null&&Ne.focus&&Ne.focus({preventScroll:!0}))}let vr=!1;function Eo(){vr||(vr=!0,requestAnimationFrame(()=>{vr=!1,Ea(),xn()}))}let Fl=!1;function Wl(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function ip(e){const t=Wl(e);if(!t.length){S.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}S.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(l=>o.includes(l)||i.includes(l));n.style.opacity=a?"1":"0.2"})}function ap(e){const t=Wl(e);if(!t.length)return[];const n=[];return k.forEach((o,i)=>{var h;const a=ga(o),s=yt(o)||"",l=`${a} ${s}`.toLowerCase();t.every(m=>l.includes(m))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((h=o.data)==null?void 0:h.categories)?o.data.categories:[]).forEach(m=>{const E=(m.title||m.id||"").toString();(m.items||[]).forEach(P=>{const B=Ni(P),R=(P.name||P.id||"").toString(),O=`${R} ${P.id||""} ${E}`.toLowerCase();t.every(Q=>O.includes(Q))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:P.id,itemName:R,itemDisplayName:B,categoryTitle:E})})})}),n.slice(0,Me)}function jl(e){if(!ye)return;ye.innerHTML="";const t=(e||"").toString();if(!t.trim()){ye.hidden=!0;return}if(!k.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",ye.appendChild(o),ye.hidden=!1;return}const n=ap(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",ye.appendChild(o),ye.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===g&&(!o.itemId||q===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemDisplayName||o.itemName||o.itemId||"Item",a.appendChild(s);const l=document.createElement("span");l.className="search-result__badge",l.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(l);const u=document.createElement("div");u.className="search-result__meta";const h=document.createElement("span");if(h.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,u.appendChild(h),o.type==="item"&&o.itemId){const m=document.createElement("span");m.textContent=`Item ID: ${o.itemId}`,u.appendChild(m)}else if(o.type==="model"){const m=document.createElement("span");m.textContent="Matches model title",u.appendChild(m)}i.appendChild(a),i.appendChild(u),ye.appendChild(i)}),ye.hidden=!1}function yr(e){ip(e||""),jl(e||"")}function rp(e){!e||!Number.isInteger(e.modelIndex)||(Dt(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(g!==e.modelIndex)return;const t=(n=xe.get(e.itemId))==null?void 0:n.el;t&&(Tt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function Dt(e){var t;if(So(),ci(),bt=null,on=null,A=null,qe=null,e<0||e>=k.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(d=!0,g=e,console.log("[Blockscape] active model:",Je(k[e]),"(index",e+" )"),_i(Za(k[e])),typeof(et==null?void 0:et.highlightSource)=="function"){const n=((t=k[e])==null?void 0:t.sourcePath)||null;et.highlightSource(n)}mr(),Pn(),xt(),_t(),J&&yr(J.value||""),et.updateActiveSavePlaceholder(),he.updateAvailability(),sr()}function Pn(){if(Y.innerHTML="",!k.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",Y.appendChild(e);return}k.forEach((e,t)=>{var E;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===g?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===g?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=ga(e),i.appendChild(a);const s=Nu(pr(e)||yt(e));if(s){const P=document.createElement("span");P.className="model-nav-id",P.textContent=s,i.appendChild(P)}const l=Array.isArray((E=e.data)==null?void 0:E.categories)?e.data.categories:[],u=l.reduce((P,B)=>P+(B.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const m=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";h.textContent=`${l.length} cat · ${u} items${m}`,o.appendChild(i),o.appendChild(h),n.appendChild(o),Y.appendChild(n)}),he.updateAvailability()}function xt(){if(g<0){f.value="",oe&&(oe.disabled=!0);return}const e=k[g];f.value=JSON.stringify(e.data,null,2),oe&&(oe.disabled=!wa(e))}function sp(e){try{return JSON.parse(e)}catch{return null}}function zl(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function lp(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,l)=>{const u=s==null?void 0:s.data;if(!u||!Array.isArray(u.categories))return;const h=Je(u,`Map ${l+1}`),m=(u.id??"").toString().trim()||Zt(h||`map-${l+1}`),E=Zt(m||h||`map-${l+1}`);u.categories.forEach(P=>{const B=((P==null?void 0:P.id)??"").toString().trim();if(!B)return;n.has(B)||n.set(B,{catTitle:P.title||B,sources:[]});const R=n.get(B);!R.catTitle&&(P.title||B)&&(R.catTitle=P.title||B),R.sources.push({category:P,mapId:m,mapTitle:h,mapSlug:E,versionIndex:l})})});const o=On(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||Je(e,"Series"),a=[];return n.forEach((s,l)=>{var P;if((((P=s.sources)==null?void 0:P.length)||0)<2)return;const u=s.catTitle||l,h=new Set,m=s.sources.map(B=>{var lt;let O=B.mapSlug||Zt(B.mapTitle||B.mapId)||`map-${B.versionIndex+1}`;h.has(O)&&(O=`${O}-${B.versionIndex+1}`),h.add(O);const Q=new Map,De=(((lt=B.category)==null?void 0:lt.items)||[]).map((Ie,Fe)=>{const Ue=((Ie==null?void 0:Ie.id)??"").toString().trim()||`item-${Fe+1}`,it=`${O}-${Ue}`;Q.set(Ue,it);const Gt={...Ie,id:it};return Gt.deps=Array.isArray(Ie==null?void 0:Ie.deps)?[...Ie.deps]:[],Gt});return De.forEach(Ie=>{Ie.deps=(Ie.deps||[]).map(Fe=>Q.get(Fe)).filter(Boolean)}),{id:O,title:B.mapTitle||B.mapId||`Map ${B.versionIndex+1}`,items:De}}),E={id:Zt(`${l}-category-view`),title:u,abstract:`Items from "${u}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:m};o&&(E.seriesId=o),Bn(E,{titleHint:u,idHint:`${o||"series"}-${l}`}),a.push({version:`${ca}${l}`,data:E,isCategoryView:!0,categoryViewKey:l})}),a}function Gl(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${ca}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function ya(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=Gl(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(l=>!(l!=null&&l.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(zn(e),e.apicurioVersions.length-1));const l=e.apicurioVersions[e.apicurioActiveVersionIndex];return l!=null&&l.data&&(e.data=l.data),e}const o=lp({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(l=>Gl(l)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function cp(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((m,E)=>!m||typeof m!="object"?null:(Bn(m,{titleHint:`${t} #${E+1}`}),{obj:m,idx:E})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let l=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const u={id:bo(),title:l,data:a,apicurioVersions:i.map(({obj:m,idx:E})=>({version:String(E+1),data:m})),apicurioActiveVersionIndex:0,isSeries:!0},h=Ft(u,{seriesName:l,fallbackTitle:l});return h&&(u.id=h),ya(u),[u]}function Kl(e,t="Pasted",n={}){return Array.isArray(e)?cp(e,t,n):!e||typeof e!="object"?[]:(Bn(e,{titleHint:`${t} #1`}),n.defaultBackgroundUrl&&!e.backgroundUrl&&(e.backgroundUrl=n.defaultBackgroundUrl),[{id:bo(),title:e.title||`${t} #1`,data:e}])}function no(e,t="Pasted",n={}){const a=(zl(typeof e=="string"?e:"")||"").replace(/^\uFEFF/,"").replace(/\u0000/g,"").trim();if(!a)return[];const s=sp(a);if(s){let u=n;if(Array.isArray(s)&&n.promptForSeriesName){const m=Cu(s,t),E=_u(m);u={...n,promptForSeriesName:!1,seriesTitleOverride:E||m}}const h=Kl(s,t,u);if(h.length)return h}return a.split(/^\s*(?:---|%%%)\s*$/m).map(u=>u.trim()).filter(Boolean).map((u,h)=>{const m=JSON.parse(u);return Bn(m,{titleHint:`${t} #${h+1}`}),n.defaultBackgroundUrl&&!m.backgroundUrl&&(m.backgroundUrl=n.defaultBackgroundUrl),{id:bo(),title:m.title||`${t} #${h+1}`,data:m}})}function dp(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function ko(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!dp(e)}function up(e){if(!e)return!1;const n=(zl(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function pp(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=vd(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=Kl(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const l=s.isSeries?o.title||s.title:null,u=jn({...s,apicurioArtifactName:l||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=u)}),a}async function fp(){const e=Ud();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await Li())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await vl(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(et==null?void 0:et.highlightSource)=="function"&&et.highlightSource(t);let s=a.firstIndex;if(n){const l=fr(n);l!==-1&&(s=l)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function mp(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await Ir(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function hp(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const l=new Set(s.deps||[]);t.set(s.id,l),l.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function gp(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=Hl(e,t),l=Ju(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=l,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function zn(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function ql(e){const t=zn(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Jl(e,t="active"){return On(e)||yt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function bp(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,l;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((l=n==null?void 0:n.data)==null?void 0:l.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function wp(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(Zt(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,l]of t.entries())if(s.toLowerCase()===a)return l}return null}const Yl=new WeakMap;function vp(e,t){var it;if(!((it=e==null?void 0:e.apicurioVersions)!=null&&it[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=ha(o),a=Yl.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,l=160,u=document.createElement("canvas");u.width=s,u.height=l;const h=u.getContext("2d"),m=Go("--color-surface-ghost")||Ht.color.surfaceGhost,E=Go("--color-border-muted")||Ht.color.borderMuted;h.fillStyle=m,h.fillRect(0,0,s,l),h.strokeStyle=E,h.strokeRect(.5,.5,s-1,l-1);const P=8,B=8,R=4,O=Array.isArray(o==null?void 0:o.categories)?o.categories:[],Q=Math.max(O.length,1),De=s-R*2,lt=R*3,Ie=Q>1?Math.min(lt,De/(Q-1)):0,Fe=Q>1?(s-Ie*(Q-1))/2:s/2;O.forEach((Gt,Pt)=>{const tt=Fe+Pt*Ie,ct=Array.isArray(Gt.items)?Gt.items:[],Ut=Math.max(ct.length,1),hn=l-P-B-R*2,pn=Ut>1?Math.min(R*3,hn/(Ut-1)):0;ct.forEach((Ct,ln)=>{const Qt=l-B-R-ln*pn;h.beginPath(),h.arc(tt,Qt,R,0,Math.PI*2);const en=Hl(Ct.name||Ct.id||"",Ct.color);h.fillStyle=en,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const Ue=u.toDataURL("image/png");return Yl.set(n,{fingerprint:i,dataUrl:Ue}),Ue}function Sa(e,t){var l;if(ci(),e<0||e>=k.length)return!1;const n=k[e];if(!((l=n==null?void 0:n.apicurioVersions)!=null&&l.length)||!Ol(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,d=!0,q=null,mt=null,Xt(),xt(),_t(),!0):!1}function Sr(e){var o;if(!e||g<0)return!1;const t=k[g];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=zn(t);return n===-1?!1:Sa(g,n+e)}function yp(e,t){if(ci(),e<0||e>=k.length)return!1;const n=k[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!Ol(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=zn(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const l=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(l==null?void 0:l.data)||n.data,n.isSeries=n.apicurioVersions.length>1,Dt(e),!0}function Sp(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,c.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||yt(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var De;const O=k[g];!((De=O==null?void 0:O.apicurioVersions)!=null&&De.length)||!xu(O)||(Pn(),xt(),_t())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=zn(e),s=ql(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const l=document.createElement("div");l.className="version-nav__controls";const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Previous",u.addEventListener("click",()=>Sr(-1));const h=document.createElement("button");h.type="button",h.className="version-nav__button",h.textContent="Next",h.addEventListener("click",()=>Sr(1)),l.appendChild(u),l.appendChild(h),n.appendChild(l);const m=document.createElement("div");m.className="version-nav__thumbs",e.apicurioVersions.forEach((O,Q)=>{var Pt,tt;const De=document.createElement("button");De.type="button",De.className="version-nav__thumb",O!=null&&O.isCategoryView&&De.classList.add("version-nav__thumb--category"),Q===a&&De.classList.add("is-active");const lt=vp(e,Q);if(lt){const ct=document.createElement("img");ct.src=lt,ct.alt=`Version ${Q+1}`,De.appendChild(ct)}const Ie=document.createElement("div");Ie.className="version-nav__thumb-label";const Fe=document.createElement("span");Fe.className="version-nav__thumb-label-text";const Ue=(((Pt=O==null?void 0:O.data)==null?void 0:Pt.id)??(O==null?void 0:O.id)??"").toString().trim();let it=Ue||(O!=null&&O.version?`v${O.version}`:`${Q+1}`),Gt=Ue||it;if(O!=null&&O.isCategoryView){const ct=((tt=O.data)==null?void 0:tt.title)||O.categoryViewKey||it||"Category";it=ct,Gt=`Category view: ${ct}`,De.dataset.computed="true"}if(Fe.textContent=it,Ie.title=Gt,Ie.appendChild(Fe),De.appendChild(Ie),Ap(Ie,Fe),e.apicurioVersions.length>1&&!(O!=null&&O.isCategoryView)){const ct=document.createElement("span");ct.className="version-nav__thumb-remove",ct.title=`Remove ${it} from this series`,ct.setAttribute("aria-label",`Remove ${it} from this series`),ct.setAttribute("role","button"),ct.tabIndex=-1,ct.textContent="×",ct.addEventListener("click",Ut=>{Ut.stopPropagation(),Ut.preventDefault(),window.confirm(`Remove ${it} from this series?`)&&yp(g,Q)}),De.appendChild(ct)}De.addEventListener("click",()=>Sa(g,Q)),Np(De,O),m.appendChild(De)});const E=document.createElement("button");E.type="button",E.className="version-nav__thumb version-nav__thumb--add",E.title="Create a new version from this map",E.addEventListener("click",()=>{try{const O=Dl({versionLabel:"manual"});Dt(O)}catch(O){alert((O==null?void 0:O.message)||"Unable to create a new version right now.")}});const P=document.createElement("span");P.className="version-nav__thumb-add-icon",P.textContent="+",E.appendChild(P),m.appendChild(E),n.appendChild(m);const B=Jl(e,"active"),R=M.get(B);return typeof R=="number"&&!Number.isNaN(R)&&requestAnimationFrame(()=>{m.scrollLeft=R}),m.addEventListener("scroll",()=>{M.set(B,m.scrollLeft)}),n}function Mi(){var yc,Sc;if(!K)return;const e=g>=0&&k[g]?k[g]:null,t=S&&S.querySelector?S.querySelector(".version-nav__thumbs"):null;if(t&&e){const p=Jl(e,g);M.set(p,t.scrollLeft)}Kn(),Array.isArray(K.m.categories)||(K.m.categories=[]),console.log("[Blockscape] rendering categories=",K.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!K.m.abstract,"- value:",K.m.abstract?K.m.abstract.substring(0,50)+"...":"none"),S.innerHTML="",xe.clear(),kt.clear(),te=[],to=!0,ve.tabSeriesPanelToggle&&(ve.tabSeriesPanelToggle.checked=!0),ba(k[g],{versionLabel:"1"}),Wo=Sp(k[g]),Wo&&(Al(to),S.appendChild(Wo)),G.setAttribute("width",window.innerWidth),G.setAttribute("height",window.innerHeight);const o=(()=>{var X,He,Lt;const p=document.createElement("div");p.className="blockscape-model-meta";const L=document.createElement("div");L.className="blockscape-model-title",L.textContent=K.m.title&&K.m.title.trim()||Je(k[g]),p.appendChild(L),((X=k[g])!=null&&X.isSeries||(Lt=(He=k[g])==null?void 0:He.apicurioVersions)!=null&&Lt.length)&&Ft(k[g],{seriesName:k[g].title||K.m.title||Je(k[g])});const V=ql(k[g]),fe=On(k[g]),me=(K.m.id??"").toString().trim(),Te=document.createElement("div");Te.className="blockscape-model-meta__details";const Le=(Pe,$t)=>{if(!$t)return;const kn=document.createElement("div");kn.className="blockscape-model-id";const xo=document.createElement("span");xo.className="blockscape-model-id__label",xo.textContent=Pe;const To=document.createElement("span");To.className="blockscape-model-id__value",To.textContent=$t,kn.append(xo,To),Te.appendChild(kn)};return Le("Series ID",fe),Le("Model ID",me),Le("No. in series",V),Te.childElementCount&&p.appendChild(Te),p})();c.showModelMeta!==!1&&S.appendChild(o.cloneNode(!0));const a=document.createElement("div");a.className="blockscape-tabs";const s=document.createElement("div");s.className="blockscape-tabrow";const l=document.createElement("div");l.className="blockscape-tablist",l.setAttribute("role","tablist"),s.appendChild(l);const u=document.createElement("div");u.className="blockscape-tabactions",s.appendChild(u),a.appendChild(s);const h=document.createElement("div");h.className="blockscape-tabpanels",a.appendChild(h);const m=document.createElement("div"),E=document.createElement("div"),P=document.createElement("div"),B=document.createElement("div"),R=()=>{const p=document.createElement("div");p.className="blockscape-map-legend";const L=document.createElement("div");return L.className="blockscape-legend",L.setAttribute("role","presentation"),L.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,p.appendChild(L),p};let O="";const Q=bp(k[g]),De=zn(k[g]),lt=((Sc=(yc=k[g])==null?void 0:yc.apicurioVersions)==null?void 0:Sc[De])||null,Ie=Vn=!!(lt!=null&&lt.isCategoryView||((lt==null?void 0:lt.version)||"").startsWith(ca));sn=null,Cn="";const Fe=(p,L)=>{!p||!L||(p.title=p.title?`${p.title}
${L}`:L)},Ue=[{id:"map",label:"Map",panel:m},{id:"abstract",label:"Info",panel:E},{id:"source",label:"Settings",panel:P},{id:"apicurio",label:"Apicurio",panel:B}],it=typeof he.isEnabled=="function"?he.isEnabled():!1,Gt=p=>{if(!G)return;const L=p==="map";G.hidden=!L,L?(Ea(),xn()):G.innerHTML=""};Ue.forEach((p,L)=>{const V=document.createElement("button");V.type="button",V.id=`tab-${p.id}`,V.className="blockscape-tab"+(L===0?" is-active":""),V.setAttribute("role","tab"),V.setAttribute("aria-controls",`panel-${p.id}`),V.setAttribute("aria-selected",L===0?"true":"false"),V.textContent=p.label,p.id==="apicurio"&&!it&&(V.hidden=!0,V.tabIndex=-1,V.setAttribute("aria-hidden","true"),V.style.display="none"),p.button=V,l.appendChild(V),p.panel.id=`panel-${p.id}`,p.panel.classList.add("blockscape-tabpanel"),p.panel.setAttribute("role","tabpanel"),p.panel.setAttribute("aria-labelledby",V.id),p.panel.hidden=L!==0,L===0&&p.panel.classList.add("is-active"),h.appendChild(p.panel)});const Pt=p=>{Qn=p,Ue.forEach(L=>{const V=L.id===p;L.button.classList.toggle("is-active",V),L.button.setAttribute("aria-selected",V?"true":"false"),L.panel.classList.toggle("is-active",V),L.panel.hidden=!V}),Gt(p)},tt=Ue.find(p=>p.id==="apicurio"),ct=p=>{if(!tt||!tt.button||!tt.panel)return;const L=!!p;if(tt.button.hidden=!L,tt.button.tabIndex=L?0:-1,tt.button.setAttribute("aria-hidden",L?"false":"true"),tt.button.style.display=L?"":"none",L){const V=Qn==="apicurio";tt.button.classList.toggle("is-active",V),tt.button.setAttribute("aria-selected",V?"true":"false"),tt.panel.classList.toggle("is-active",V),tt.panel.hidden=!V}else{const V=tt.panel.classList.contains("is-active");if(tt.button.classList.remove("is-active"),tt.button.setAttribute("aria-selected","false"),tt.panel.classList.remove("is-active"),tt.panel.hidden=!0,V){const fe=Ue.find(me=>me.id!=="apicurio");fe&&Pt(fe.id)}}I&&(I.checked=L)};Ue.forEach(p=>{p.button.addEventListener("click",()=>{Kn(),Pt(p.id)}),p.id==="abstract"&&(sn=p.button,p.button.addEventListener("mouseenter",()=>Ri(p.button,O,{offset:12})),p.button.addEventListener("mouseleave",Kn),p.button.addEventListener("focus",()=>Ri(p.button,O,{offset:12})),p.button.addEventListener("blur",Kn))});const hn=(p=>{const L=Ue.find(fe=>fe.id===Qn);if(L&&(L.id!=="apicurio"||p))return L.id;const V=Ue.find(fe=>fe.id!=="apicurio"||p);return(V==null?void 0:V.id)||Ue[0].id})(it);Pt(hn),ct(it),typeof he.onEnabledChange=="function"&&he.onEnabledChange(ct),S.appendChild(a),m.appendChild(R());const pn=document.createElement("div");pn.className="blockscape-render";const Ct=document.createElement("div");Ct.className="stage-guides",Ct.hidden=!vt,Ct.setAttribute("aria-hidden","true");const ln=document.createElement("div");ln.className="stage-guide-labels",["Genesis / Inception","Custom","Product / Rental","Service / Commodity"].forEach(p=>{const L=document.createElement("span");L.className="stage-guide-labels__item",L.textContent=p,ln.appendChild(L)}),Ct.appendChild(ln),pn.appendChild(Ct),Ya=Ct,m.appendChild(pn);const Qt=document.createElement("div");Qt.className="blockscape-abstract-panel",E.appendChild(o.cloneNode(!0));const en=document.createElement("form");en.className="blockscape-info-form",en.noValidate=!0;const gn=document.createElement("div");gn.className="blockscape-info-fields";const oo=(p,L)=>{const V=document.createElement("label");V.className="blockscape-info-field";const fe=document.createElement("span");return fe.className="blockscape-info-label",fe.textContent=p,V.append(fe,L),V},bn=document.createElement("input");bn.type="text",bn.className="pf-v5-c-form-control",bn.placeholder="Title",bn.value=K.m.title&&K.m.title.toString()||Je(k[g],"");const At=document.createElement("input");At.type="url",At.className="pf-v5-c-form-control",At.placeholder="Background image URL",At.value=Za(K);const fn=document.createElement("textarea");fn.className="pf-v5-c-form-control",fn.rows=14,fn.placeholder="Abstract (supports basic HTML)",fn.value=K.m.abstract||"";const tn=()=>{var He,Lt,Pe;if(g<0)return;const p=k[g],L=(bn.value||"").trim(),V=fn.value||"";let fe=!1;const me=(((He=p.data)==null?void 0:He.title)||"").toString();L!==me&&(p.data.title=L,!p.isSeries&&!((Lt=p.apicurioVersions)!=null&&Lt.length)&&(p.title=L),fe=!0);const Te=(At.value||"").trim(),Le=Za(p);Te!==Le&&(p.data.backgroundUrl=Te,_i(Te),fe=!0);const X=((Pe=p.data)==null?void 0:Pe.abstract)||"";V!==X&&(p.data.abstract=V,fe=!0),fe&&(Pn(),xt(),_t())};bn.addEventListener("blur",tn),At.addEventListener("blur",tn),fn.addEventListener("blur",tn),en.addEventListener("submit",p=>{p.preventDefault(),tn()}),gn.append(oo("Title",bn),oo("Background image URL",At),oo("Abstract",fn));const $i=document.createElement("div");$i.className="blockscape-info-actions";const Io=document.createElement("button");Io.type="submit",Io.className="pf-v5-c-button pf-m-primary",Io.textContent="Update",$i.appendChild(Io),en.append(gn,$i);const _r=p=>p?p.replace(/\n/g,"<br>"):"",_a=K.m.abstract||"",Ca=_r(_a),xa=!!Ca,_o=document.createElement("div");_o.className=xa?"blockscape-abstract":"blockscape-abstract-placeholder",_o.innerHTML=xa?Ca:"No abstract has been provided for this model.",Yp(_o),Qt.appendChild(_o),Qt.appendChild(en),O=_o.outerHTML,Cn=O,E.appendChild(Qt);const io=document.createElement("div");io.className="blockscape-source-panel";const v=document.createElement("div");v.className="blockscape-settings-panel";const F=p=>{ve.themeToggle&&(ve.themeToggle.checked=p),ve.tabThemeToggle&&(ve.tabThemeToggle.checked=p)},re=p=>{F(p),Qa(p?ho:Ro)},Se=p=>{ve.tabCenterToggle&&(ve.tabCenterToggle.checked=p)},nt=p=>{const L=zo(p);Se(L),ul(L)},Ke=p=>{ve.secondaryLinksToggle&&(ve.secondaryLinksToggle.checked=p),ve.tabSecondaryLinksToggle&&(ve.tabSecondaryLinksToggle.checked=p)},se=p=>{const L=!!p;Ke(L),cn=L,q?Tt(q):(Ia(),xn())},Ae=({id:p,label:L,checked:V,onChange:fe})=>{const me=document.createElement("label");me.className="blockscape-tab-toggle",me.setAttribute("for",p);const Te=document.createElement("input");Te.type="checkbox",Te.id=p,Te.checked=V,typeof fe=="function"&&Te.addEventListener("change",()=>fe(Te.checked));const Le=document.createElement("span");return Le.className="blockscape-tab-toggle__label",Le.textContent=L,me.append(Te,Le),{row:me,input:Te}},Rt=document.createElement("p");Rt.className="blockscape-settings-panel__title",Rt.textContent="Feature toggles",v.appendChild(Rt);const Tn=document.createElement("label");Tn.className="settings-toggle";const Kt=document.createElement("input");Kt.type="checkbox",Kt.checked=yi===ho;const ao=document.createElement("span");ao.className="settings-toggle__text";const Cr=document.createElement("span");Cr.className="settings-toggle__label",Cr.textContent="Dark mode";const xr=document.createElement("span");xr.className="settings-toggle__hint",xr.textContent="Switch Blockscape UI to dark colors.",ao.append(Cr,xr),Tn.append(Kt,ao),Kt.addEventListener("change",()=>{re(Kt.checked)}),v.appendChild(Tn),ve.themeToggle=Kt;const{row:of,input:af}=Ae({id:"tabToggleTheme",label:"Dark mode",checked:yi===ho,onChange:p=>re(p)});u.appendChild(of),ve.tabThemeToggle=af;const Tr=document.createElement("div");Tr.className="blockscape-bg-controls";const Ar=document.createElement("label");Ar.className="bg-opacity";const uc=document.createElement("span");uc.textContent="Opacity";const ro=document.createElement("input");ro.type="range",ro.min="0",ro.max="100",ro.step="5",ro.value=String(Math.round(eo*100)),ro.addEventListener("input",()=>Ii(ro.valueAsNumber/100)),Ar.append(uc,ro),Tr.append(Ar),u.appendChild(Tr);const{row:rf,input:sf}=Ae({id:"tabToggleSeriesPanel",label:"Series panel",checked:to,onChange:p=>Al(p)});u.appendChild(rf),ve.tabSeriesPanelToggle=sf;const{row:lf,input:cf}=Ae({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:cn,onChange:p=>se(p)});u.appendChild(lf),ve.tabSecondaryLinksToggle=cf;const{row:df,input:uf}=Ae({id:"tabToggleCenterItems",label:"Wardley",checked:vt,onChange:p=>nt(p)});u.appendChild(df),ve.tabCenterToggle=uf;const{row:pf,input:ff}=Ae({id:"tabToggleSidebarBg",label:"Sidebar background",checked:Si,onChange:p=>Ci(p)});u.appendChild(pf),ve.tabSidebarBgToggle=ff;const Lr=document.createElement("div");Lr.className="settings-actions";const so=document.createElement("input");so.type="file",so.accept="application/json",so.hidden=!0;const Oi=document.createElement("button");Oi.type="button",Oi.className="pf-v5-c-button pf-m-secondary",Oi.textContent="Load settings",Oi.addEventListener("click",()=>so.click()),so.addEventListener("change",async()=>{var L,V;const p=(L=so.files)==null?void 0:L[0];if(p)try{const fe=await p.text(),me=JSON.parse(fe),Te=(me==null?void 0:me.settings)||me,X=((V=cr(Te||{},{refreshObsidianLinks:Aa}).applied)==null?void 0:V.length)||0;un(X?`Loaded ${X} setting${X===1?"":"s"} from ${p.name}.`:`No matching settings found in ${p.name}.`,2200)}catch(fe){console.warn("[Blockscape] failed to load settings.json",fe),un("Invalid settings file.",2400)}finally{so.value=""}});const Vi=document.createElement("button");Vi.type="button",Vi.className="pf-v5-c-button pf-m-tertiary",Vi.textContent="Download settings",Vi.addEventListener("click",async()=>{const p=Nl();if(typeof window<"u"&&typeof window.__blockscapeSettingsSaveToFile=="function")try{await window.__blockscapeSettingsSaveToFile(p)?un("Settings saved to ~/.blockscape/settings.json.",2e3):un("Settings save failed. Check logs.",2400)}catch(L){console.warn("[Blockscape] settings save failed",L),un("Settings save failed. Check logs.",2400)}else cl("settings.json",JSON.stringify(p,null,2)),un("Settings downloaded.",2e3)}),Lr.append(Oi,Vi,so),v.appendChild(Lr);const Ta=document.createElement("div");Ta.className="color-presets";const Nr=document.createElement("div");Nr.className="settings-text__label",Nr.textContent="Color presets";const Mr=document.createElement("div");Mr.className="settings-text__hint",Mr.textContent="Shown in tile context menu for quick coloring.",Ta.append(Nr,Mr);const Di=document.createElement("div");Di.className="color-presets__list";const Br=document.createElement("div");Br.className="color-presets__add";const pi=document.createElement("input");pi.type="text",pi.placeholder="Name",pi.className="settings-text__input";const Ui=document.createElement("input");Ui.type="color",Ui.value="#2563eb",Ui.className="settings-color-input";const Hi=document.createElement("button");Hi.type="button",Hi.className="pf-v5-c-button pf-m-primary",Hi.textContent="Add preset",Hi.addEventListener("click",()=>{const p=pi.value.trim()||"Custom",L=Ui.value,V=[...Yt,{name:p,value:L}];Ko(V),li(Yt),pi.value=""}),Br.append(pi,Ui,Hi),Ta.append(Di,Br),v.appendChild(Ta),ve.colorPresetList=Di,Fo=()=>{Di.innerHTML="",Yt.forEach((p,L)=>{const V=document.createElement("div");V.className="color-presets__row";const fe=document.createElement("input");fe.type="text",fe.className="settings-text__input",fe.value=p.name||"",fe.placeholder="Name",fe.addEventListener("input",()=>{const Le=[...Yt];Le[L]={...Le[L],name:fe.value},Ko(Le),li(Yt)});const me=document.createElement("input");me.type="color",me.className="settings-color-input",me.value=p.value,me.addEventListener("input",()=>{const Le=[...Yt];Le[L]={...Le[L],value:me.value},Ko(Le),li(Yt)});const Te=document.createElement("button");Te.type="button",Te.className="pf-v5-c-button pf-m-plain",Te.textContent="✕",Te.title="Remove preset",Te.addEventListener("click",()=>{const Le=Yt.filter((X,He)=>He!==L);Ko(Le),li(Yt),Fo()}),V.append(fe,me,Te),Di.appendChild(V)})},Fo();const Pr=document.createElement("div");Pr.className="settings-text";const Rr=document.createElement("div");Rr.className="settings-text__label",Rr.textContent="Link colors";const $r=document.createElement("div");$r.className="settings-text__hint",$r.textContent="Adjust the colors used when highlighting enables/dependents.";const Or=document.createElement("div");Or.className="settings-color-rows";const pc=({id:p,label:L,hint:V,value:fe,onChange:me})=>{const Te=document.createElement("label");Te.className="settings-color-row",Te.setAttribute("for",p);const Le=document.createElement("span");if(Le.className="settings-color-row__label",Le.textContent=L,V){const He=document.createElement("span");He.className="settings-color-row__hint",He.textContent=V,Le.appendChild(He)}const X=document.createElement("input");if(X.type="color",X.id=p,X.className="settings-color-input",X.value=fe,typeof me=="function"){const He=()=>me(X.value);X.addEventListener("input",He),X.addEventListener("change",He)}return Te.append(Le,X),Or.appendChild(Te),X};ve.depColorInput=pc({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:pa,onChange:p=>{const L=ir(p);nr(L)}}),ve.revdepColorInput=pc({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:fa,onChange:p=>{const L=ar(p);or(L)}}),Pr.append(Rr,$r,Or),v.appendChild(Pr);const Vr=document.createElement("div");Vr.className="settings-text";const Dr=document.createElement("div");Dr.className="settings-text__text";const Ur=document.createElement("div");Ur.className="settings-text__label",Ur.textContent="Link thickness";const Hr=document.createElement("div");Hr.className="settings-text__hint",Hr.textContent="Adjust stroke width for enables/dependents lines.",Dr.append(Ur,Hr);const Co=document.createElement("select");Co.id="linkThickness",Co.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:p,label:L})=>{const V=document.createElement("option");V.value=p,V.textContent=L,p===Ei&&(V.selected=!0),Co.appendChild(V)}),Co.addEventListener("change",()=>{const p=Ti(Co.value);rr(p)});const Fr=document.createElement("div");Fr.className="settings-text__row",Fr.append(Dr,Co),Vr.appendChild(Fr),v.appendChild(Vr),ve.linkThicknessInput=Co;const qn=({id:p,label:L,hint:V,checked:fe,className:me="",onChange:Te})=>{const Le=document.createElement("label");Le.className=["settings-toggle",me].filter(Boolean).join(" ");const X=document.createElement("input");X.type="checkbox",X.id=p,X.checked=fe;const He=document.createElement("span");He.className="settings-toggle__text";const Lt=document.createElement("span");if(Lt.className="settings-toggle__label",Lt.textContent=L,He.appendChild(Lt),V){const Pe=document.createElement("span");Pe.className="settings-toggle__hint",Pe.textContent=V,He.appendChild(Pe)}return Le.appendChild(X),Le.appendChild(He),typeof Te=="function"&&X.addEventListener("change",()=>Te(X.checked)),{row:Le,input:X}},Aa=()=>{S.querySelectorAll(".tile").forEach(p=>{const L=p.dataset.id,V=si(L);if(!(V!=null&&V.item))return;const fe=nc(V.item.external),me=tc(V.item,{externalMeta:fe,seriesIdLookup:Q});oc(p,me)})},{row:mf,input:hf}=qn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:cn,className:"map-controls__toggle",onChange:p=>se(p)});v.appendChild(mf),ve.secondaryLinksToggle=hf;const{row:gf,input:bf}=qn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:nn,className:"map-controls__toggle",onChange:p=>{nn=p,kr()}});v.appendChild(gf),ve.reusedToggle=bf;const{row:wf,input:vf}=qn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:go,className:"map-controls__toggle",onChange:p=>{const L=ti(p);Il(L)}});v.appendChild(wf),ve.autoIdToggle=vf;const Wr=[],{row:yf,input:Sf}=qn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:Uo,className:"map-controls__toggle",onChange:p=>{const L=ii(p);Pl(L),Wr.forEach(V=>{V.disabled=!L}),Aa()}});if(v.appendChild(yf),ve.obsidianToggle=Sf,typeof(et==null?void 0:et.isAvailable)=="function"&&et.isAvailable()&&typeof(et==null?void 0:et.getAutoReloadConfig)=="function"){const{enabled:p,intervalMs:L}=et.getAutoReloadConfig();let V=null;const{row:fe,input:me}=qn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:p,className:"map-controls__toggle",onChange:$t=>{et.setAutoReloadEnabled($t),V&&(V.disabled=!$t)}});v.appendChild(fe),ve.autoReloadToggle=me;const Te=$t=>`${($t/1e3).toFixed(2)}s`,Le=document.createElement("label");Le.className="settings-slider",Le.setAttribute("for","autoReloadInterval");const X=document.createElement("div");X.className="settings-slider__text";const He=document.createElement("span");He.className="settings-slider__label",He.textContent="Auto-reload interval";const Lt=document.createElement("span");Lt.className="settings-slider__hint",Lt.textContent="Adjust how often to poll for file changes.",X.append(He,Lt);const Pe=document.createElement("span");Pe.className="settings-slider__value",Pe.textContent=Te(L),V=document.createElement("input"),V.type="range",V.id="autoReloadInterval",V.className="settings-slider__input",V.min=String(Fs),V.max=String(Ws),V.step="100",V.value=String(L),V.disabled=!p,V.setAttribute("aria-label","Set auto-reload polling interval"),V.addEventListener("input",()=>{const $t=et.setAutoReloadInterval(parseInt(V.value,10));Pe.textContent=Te($t)}),Le.append(X,Pe,V),v.appendChild(Le),ve.autoReloadInput=V,ve.autoReloadValue=Pe}const jr=document.createElement("div");jr.className="settings-radio";const zr=document.createElement("div");zr.className="settings-radio__label",zr.textContent="Obsidian link format";const Gr=document.createElement("div");Gr.className="settings-radio__hint",Gr.textContent="Use the tile title or id when building Obsidian links.";const Kr=document.createElement("div");Kr.className="settings-radio__options";const fc=(p,L)=>{const V=document.createElement("label");V.className="settings-radio__option";const fe=document.createElement("input");fe.type="radio",fe.name="obsidianLinkMode",fe.value=p,fe.checked=wi===p,fe.disabled=!Uo,fe.addEventListener("change",()=>{if(!fe.checked)return;const Te=oi(p);Bl(Te),Aa()});const me=document.createElement("span");me.textContent=L,V.append(fe,me),Wr.push(fe),Kr.appendChild(V)};fc(qa,"Use title"),fc(ia,"Use id"),jr.append(zr,Kr,Gr),v.appendChild(jr),ve.obsidianModeInputs=Wr;const{row:Ef,input:kf}=qn({id:"toggleStripParentheses",label:"Hide parentheses in names",hint:"Display item names without trailing text in parentheses.",checked:vi,className:"map-controls__toggle",onChange:p=>{const L=ai(p);dr(L)}});v.appendChild(Ef),ve.stripParentheticalToggle=kf;const La=document.createElement("label");La.className="settings-text",La.setAttribute("for","obsidianVaultInput");const qr=document.createElement("div");qr.className="settings-text__text";const Jr=document.createElement("span");Jr.className="settings-text__label",Jr.textContent="Obsidian vault";const Yr=document.createElement("span");Yr.className="settings-text__hint",Yr.textContent="Optional. Set the vault name to avoid duplicates.",qr.append(Jr,Yr);const Jn=document.createElement("input");Jn.type="text",Jn.id="obsidianVaultInput",Jn.className="settings-text__input",Jn.placeholder="Vault name",Jn.value=Ho,Jn.addEventListener("input",()=>{const p=ri(Jn.value);Rl(p),Aa()}),La.append(qr,Jn),v.appendChild(La),ve.obsidianVaultInput=Jn;const Zr=document.createElement("p");Zr.className="settings-note",Zr.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',v.appendChild(Zr);const mc=p=>`${(p/1e3).toFixed(1)}s`,Na=document.createElement("label");Na.className="settings-slider",Na.setAttribute("for","seriesNavDoubleClickWait");const Xr=document.createElement("div");Xr.className="settings-slider__text";const Qr=document.createElement("span");Qr.className="settings-slider__label",Qr.textContent="Series double-click wait";const es=document.createElement("span");es.className="settings-slider__hint",es.textContent="Time window to double-click into another map version.",Xr.append(Qr,es);const Fi=document.createElement("span");Fi.className="settings-slider__value",Fi.textContent=mc(Wn);const wn=document.createElement("input");wn.type="range",wn.id="seriesNavDoubleClickWait",wn.className="settings-slider__input",wn.min=String(rl),wn.max=String(sl),wn.step="50",wn.value=String(Wn),wn.setAttribute("aria-label","Adjust double-click wait for series navigation"),wn.addEventListener("input",()=>{const p=ni(parseInt(wn.value,10));Fi.textContent=mc(p),Ml(p)}),Na.append(Xr,Fi,wn),v.appendChild(Na),ve.seriesNavInput=wn,ve.seriesNavValue=Fi;const hc=p=>`${Math.round((p-1)*100)}%`,Ma=document.createElement("label");Ma.className="settings-slider",Ma.setAttribute("for","hoverScaleSlider");const ts=document.createElement("div");ts.className="settings-slider__text";const ns=document.createElement("span");ns.className="settings-slider__label",ns.textContent="Hover zoom";const os=document.createElement("span");os.className="settings-slider__hint",os.textContent="Expand tiles on hover to see more detail.",ts.append(ns,os);const Wi=document.createElement("span");Wi.className="settings-slider__value",Wi.textContent=hc($o);const vn=document.createElement("input");vn.type="range",vn.id="hoverScaleSlider",vn.className="settings-slider__input",vn.min=String(st),vn.max=String(Be),vn.step="0.1",vn.value=String($o),vn.setAttribute("aria-label","Adjust hover zoom"),vn.addEventListener("input",()=>{const p=qo(parseFloat(vn.value));Wi.textContent=hc(p),Sl(p),q&&Eo()}),Ma.append(ts,Wi,vn),v.appendChild(Ma),ve.hoverScaleInput=vn,ve.hoverScaleValue=Wi;let qt=null,lo=null;const is=p=>{const L=Math.round((1-p)*100);return L===0?"Off":`${L}% dim`},{row:If,input:_f}=qn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:Hn,className:"map-controls__toggle",onChange:p=>{const L=ei(p);kl(L),qt&&(qt.disabled=!L),lo&&(lo.textContent=is(L?Un:1))}});v.appendChild(If),ve.selectionDimToggle=_f;const Ba=document.createElement("label");Ba.className="settings-slider",Ba.setAttribute("for","selectionDimmingSlider");const as=document.createElement("div");as.className="settings-slider__text";const rs=document.createElement("span");rs.className="settings-slider__label",rs.textContent="Dimming strength";const ss=document.createElement("span");ss.className="settings-slider__hint",ss.textContent="Adjust how much unrelated tiles fade when dimming is on.",as.append(rs,ss),lo=document.createElement("span"),lo.className="settings-slider__value",lo.textContent=is(Hn?Un:1),qt=document.createElement("input"),qt.type="range",qt.id="selectionDimmingSlider",qt.className="settings-slider__input",qt.min=String(Ve),qt.max=String(ut),qt.step="0.05",qt.value=String(Un),qt.disabled=!Hn,qt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),qt.addEventListener("input",()=>{const p=Jo(parseFloat(qt.value));lo.textContent=is(p),El(p)}),Ba.append(as,lo,qt),v.appendChild(Ba),ve.selectionDimInput=qt,ve.selectionDimValue=lo;const gc=p=>p===1?"Default":`${Math.round(p*100)}%`,Pa=document.createElement("label");Pa.className="settings-slider",Pa.setAttribute("for","tileCompactnessSlider");const ls=document.createElement("div");ls.className="settings-slider__text";const cs=document.createElement("span");cs.className="settings-slider__label",cs.textContent="Tile compactness";const ds=document.createElement("span");ds.className="settings-slider__hint",ds.textContent="Adjust padding, gap, and logo size for tiles.",ls.append(cs,ds);const ji=document.createElement("span");ji.className="settings-slider__value",ji.textContent=gc(Oo);const yn=document.createElement("input");yn.type="range",yn.id="tileCompactnessSlider",yn.className="settings-slider__input",yn.min=String(Rs),yn.max=String($s),yn.step="0.05",yn.value=String(Oo),yn.setAttribute("aria-label","Adjust tile compactness"),yn.addEventListener("input",()=>{const p=Yo(parseFloat(yn.value));ji.textContent=gc(p),_l(p),q&&Eo()}),Pa.append(ls,ji,yn),v.appendChild(Pa),ve.tileCompactnessInput=yn,ve.tileCompactnessValue=ji;const{row:Cf,input:xf}=qn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:Ja!=="nowrap",className:"map-controls__toggle",onChange:p=>{const L=p?"wrap":"nowrap";Qo(L),Tl(L)}});v.appendChild(Cf),ve.titleWrapInput=xf;const bc=p=>`${Math.round((p-1)*100)}% extra`,Ra=document.createElement("label");Ra.className="settings-slider",Ra.setAttribute("for","titleHoverWidthSlider");const us=document.createElement("div");us.className="settings-slider__text";const ps=document.createElement("span");ps.className="settings-slider__label",ps.textContent="Title width on hover";const fs=document.createElement("span");fs.className="settings-slider__hint",fs.textContent="Give titles more room horizontally when zoomed.",us.append(ps,fs);const zi=document.createElement("span");zi.className="settings-slider__value",zi.textContent=bc(Vo);const Sn=document.createElement("input");Sn.type="range",Sn.id="titleHoverWidthSlider",Sn.className="settings-slider__input",Sn.min=String(we),Sn.max=String(Ge),Sn.step="0.05",Sn.value=String(Vo),Sn.setAttribute("aria-label","Adjust title width boost on hover"),Sn.addEventListener("input",()=>{const p=Zo(parseFloat(Sn.value));zi.textContent=bc(p),Cl(p)}),Ra.append(us,zi,Sn),v.appendChild(Ra),ve.titleWidthInput=Sn,ve.titleWidthValue=zi;const wc=p=>`${Math.round(p*100)}% of hover zoom`,$a=document.createElement("label");$a.className="settings-slider",$a.setAttribute("for","titleZoomPortionSlider");const ms=document.createElement("div");ms.className="settings-slider__text";const hs=document.createElement("span");hs.className="settings-slider__label",hs.textContent="Title zoom influence";const gs=document.createElement("span");gs.className="settings-slider__hint",gs.textContent="How much the title scales relative to tile hover zoom.",ms.append(hs,gs);const Gi=document.createElement("span");Gi.className="settings-slider__value",Gi.textContent=wc(Do);const En=document.createElement("input");En.type="range",En.id="titleZoomPortionSlider",En.className="settings-slider__input",En.min=String(Ka),En.max=String(Bs),En.step="0.05",En.value=String(Do),En.setAttribute("aria-label","Adjust how much titles scale on hover"),En.addEventListener("input",()=>{const p=Xo(parseFloat(En.value));Gi.textContent=wc(p),xl(p)}),$a.append(ms,Gi,En),v.appendChild($a),ve.titleZoomInput=En,ve.titleZoomValue=Gi;const Tf=typeof he.isEnabled=="function"?he.isEnabled():!1,{row:Af,input:Lf}=qn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:Tf,className:"apicurio-toggle",onChange:p=>{typeof he.setEnabled=="function"&&he.setEnabled(p)}});if(I=Lf,v.appendChild(Af),io.appendChild(v),T)T.hidden=!1,T.classList.remove("pf-v5-c-page__main-section"),io.appendChild(T);else{const p=document.createElement("p");p.className="muted",p.textContent="Source editor unavailable.",io.appendChild(p)}P.appendChild(io),he.mount(B);let vc=0;K.m.categories.forEach(p=>{const L=document.createElement("section");L.className="category",L.dataset.cat=p.id;const V=Ie?wp(p,Q):null,fe=(p.items||[]).some(X=>xi(X.stage)),me=document.createElement("div");me.className="cat-head",me.dataset.cat=p.id,me.tabIndex=0,Ie&&Number.isInteger(V)?(me.dataset.seriesVersionIndex=String(V),me.title="Open this category's map in the series",me.classList.add("cat-head--series-link")):me.title="Select category",me.innerHTML=`<div class="cat-title">${Pi(p.title||p.id)}</div>
                          ${fe?`<span class="cat-stage-indicator" title="Contains staged items">Stage</span>
                                 <button type="button" class="cat-stage-clear" title="Clear all stages in this category" aria-label="Clear all stages">×</button>`:""}
                          <div class="muted cat-count">${(p.items||[]).length} items</div>`,me.addEventListener("click",()=>{var $t;const X=me.dataset.seriesVersionIndex!=null?parseInt(me.dataset.seriesVersionIndex,10):null,He=k[g],Lt=He?zn(He):-1;Ie&&(($t=He==null?void 0:He.apicurioVersions)==null?void 0:$t.length)>1&&Number.isInteger(X)&&X!==Lt&&Sa(g,X)||Gn(p.id)}),me.addEventListener("keydown",X=>{(X.key==="Enter"||X.key===" ")&&(X.preventDefault(),me.click())});const Te=me.querySelector(".cat-stage-clear");Te&&Te.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation(),Bu(p.id)&&un("Cleared stages for this category.",1400)}),me.addEventListener("focus",()=>Gn(p.id,{scrollIntoView:!1})),L.appendChild(me);const Le=document.createElement("div");if(Le.className="grid"+(vt?" is-centered":""),L.appendChild(Le),(p.items||[]).forEach(X=>{vc+=1;const He=nc(X.external),Lt=tc(X,{externalMeta:He,seriesIdLookup:Q}),Pe=document.createElement("div");if(Pe.className=He.isExternal?"tile external":"tile",Pe.tabIndex=0,Pe.dataset.id=X.id,Pe.dataset.globalIndex=String(vc),He.url&&(Pe.dataset.externalUrl=He.url),!Ie){let An=null;if(Q.has(X.id)&&(An=Q.get(X.id)),Number.isInteger(An)){Pe.dataset.seriesVersionIndex=String(An),Pe.classList.add("tile--series-link");const Nf=An===De?"Current map in this series":`Open version ${An+1} in this series`;Fe(Pe,Nf)}}Lt&&(Pe.dataset.obsidianUrl=Lt);const $t=xi(X.stage);if($t&&(Pe.dataset.stage=String($t),vt&&(Pe.style.gridColumn=String($t))),!Ie){const An=fr(X.id);An!==-1&&An!==g&&(Pe.classList.add("tile--series-link"),Pe.dataset.navTargetIndex=String(An))}const kn=document.createElement("img");kn.className="logo",X.logo?(kn.src=X.logo,kn.alt=X.name||X.id):(kn.alt="",kn.style.opacity=1,kn.src=gp(X.name||X.id,X.color));const xo=document.createElement("div");xo.className="name",xo.textContent=Ni(X);const To=document.createElement("div");To.className="tile-id",To.textContent=X.id||"";let Ki=null;$t&&(Ki=document.createElement("div"),Ki.className="tile-stage",Ki.textContent=String($t));const bs=document.createElement("div");bs.className="badge",bs.textContent="reused";let co=null;Ie||(co=document.createElement("button"),co.type="button",co.className="tile-delete",co.setAttribute("aria-label",`Delete ${X.name||X.id}`),co.textContent="×",co.addEventListener("click",An=>{An.stopPropagation(),Kp(X.id)})),He.url&&Pe.appendChild(Tp(He.url)),oc(Pe,Lt),co&&Pe.appendChild(co),Pe.appendChild(kn),Pe.appendChild(xo),Pe.appendChild(To),Ki&&Pe.appendChild(Ki),Pe.appendChild(bs),Le.appendChild(Pe),xe.set(X.id,{el:Pe,catId:p.id,rect:null})}),pn.appendChild(L),kt.set(p.id,{el:L,headEl:me}),!Ie){const X=document.createElement("button");X.type="button",X.className="tile-add",X.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',X.hidden=vt,X.tabIndex=vt?-1:0,X.setAttribute("aria-hidden",vt?"true":"false"),X.addEventListener("click",()=>Rp(p.id)),Le.appendChild(X)}});let Rn=null;Ie||(Rn=document.createElement("button"),Rn.type="button",Rn.className="category-add",Rn.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',Rn.addEventListener("click",()=>ac()),pn.appendChild(Rn)),Rn&&vt&&(Rn.hidden=!0,Rn.tabIndex=-1,Rn.setAttribute("aria-hidden","true")),pl(),kr(),Ep(),Ea(),xn(),di(),Mp()}function Ep(){S.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var B;if(typeof n.button=="number"&&n.button!==0)return;So();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,l=k[g],u=l?zn(l):-1,h=((B=l==null?void 0:l.apicurioVersions)==null?void 0:B.length)>1&&Number.isInteger(i)&&i!==u,m=Number.isInteger(s)&&s!==g&&s>=0&&s<k.length,E=an&&an.id===o&&an.targetVersionIndex===i,P=Jt&&Jt.id===o&&Jt.targetIndex===s;if(an&&!E&&ci(),Jt&&!P&&br(),h)if(E){if(ci(),Sa(g,i))return}else Xu(o,i,l);else if(m){if(P){br(),Dt(s);return}Qu(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&un("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),q===o&&!(h&&E)&&!(m&&P)){ui();return}Tt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):fr(o);i!==-1&&i!==g&&Dt(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{q&&Eo()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),Fl||(Fl=!0,window.addEventListener("resize",Eo),window.addEventListener("blockscape:zoom",Eo),window.addEventListener("scroll",Eo,{passive:!0}),window.addEventListener("resize",ic),document.addEventListener("click",e=>{var a,s,l;if(!q&&!A||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),o=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),i=(l=t==null?void 0:t.closest)==null?void 0:l.call(t,".tile-context-menu");n||o||i||ui()})),document.getElementById("clear").onclick=()=>ui()}function Ea(){xe.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function Zl(e,{includeSecondary:t=cn}={}){if(!e||!K)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(K.fwd.get(e)||[]),o=new Set(K.rev.get(e)||[]),i=new Set,a=new Set,s=[],l=new Set,u=(h,m,E,P)=>{if(!h||!m)return;const B=`${h}->${m}:${E}:${P}`;l.has(B)||(l.add(B),s.push({from:h,to:m,type:E,depth:P}))};return n.forEach(h=>u(e,h,"dep",1)),o.forEach(h=>u(e,h,"revdep",1)),t&&new Set([...n,...o]).forEach(m=>{(K.fwd.get(m)||new Set).forEach(B=>{const R=B===e;R||i.add(B),R||u(m,B,"dep",2)}),(K.rev.get(m)||new Set).forEach(B=>{const R=B===e;R||a.add(B),R||u(m,B,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function ka(e,t){const n=xe.get(e);n&&n.el.classList.add(t)}function Tt(e){var l,u,h;if(!e)return;A=null,q=e,qe=null,mt=Zl(e),Xt(),Ia(),di();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=mt;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=xe.get(e);a&&a.el.classList.add("selected"),t.forEach(m=>ka(m,"dep")),n.forEach(m=>ka(m,"revdep")),o.forEach(m=>{!t.has(m)&&m!==e&&ka(m,"dep-indirect")}),i.forEach(m=>{!n.has(m)&&!t.has(m)&&m!==e&&ka(m,"revdep-indirect")}),xn();const s=(h=(u=(l=xe.get(e))==null?void 0:l.el)==null?void 0:u.dataset)==null?void 0:h.externalUrl;s&&un("This item has link to",Nn,s),sr()}function Gn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,l;if(!((s=K==null?void 0:K.m)!=null&&s.categories)||!e)return!1;const i=(K.m.categories||[]).find(u=>u.id===e);if(!i)return!1;So(),Er(),n||(qe=null),A=i.id,Xt(),di();const a=kt.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(l=a.headEl)==null||l.focus({preventScroll:!0})),!0}function di(){if(kt.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!A)return;const e=kt.get(A);if(!(e!=null&&e.el)){A=null,qe=null,Xt();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function Bi(){if(A)return A;const e=q?xe.get(q):null;return e!=null&&e.catId?e.catId:null}function kp(e){var a,s,l,u;if(!((s=(a=K==null?void 0:K.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=K.m.categories,n=Bi();let o=t.findIndex(h=>h.id===n);if(o===-1){const h=((l=t.find(m=>(m.items||[]).length))==null?void 0:l.id)||((u=t[0])==null?void 0:u.id);return h?Gn(h):!1}const i=o+e;return i<0||i>=t.length?!1:Gn(t[i].id)}function Er(){q=null,mt=null,Ia(),xn(),sr({itemId:null})}function Ip(){A=null,qe=null,di()}function ui(){Er(),Ip(),qe=null,Xt()}function Ia(){S.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function kr(){K!=null&&K.reusedLocal&&K.reusedLocal.forEach(e=>{const t=xe.get(e);if(!t)return;t.el.classList.toggle("reused",nn);const n=t.el.querySelector(".badge");n&&(n.style.display=nn?"inline-block":"none")})}function xn(){for(;G.firstChild;)G.removeChild(G.firstChild);if(!q||G.hidden)return;mt=Zl(q);const e=mt,{primary:t,secondary:n}=Bd();e.edges.forEach(o=>{var O,Q;const i=(O=xe.get(o.from))==null?void 0:O.rect,a=(Q=xe.get(o.to))==null?void 0:Q.rect;if(!i||!a)return;const s=Xl(i),l=Xl(a),u=ec(Ql(i,l)||s,i,ol)||s,h=ec(Ql(a,s)||l,a,ol)||l,m=document.createElementNS("http://www.w3.org/2000/svg","path"),E=(u.x+h.x)/2,P=u.y,B=(u.x+h.x)/2,R=h.y;m.setAttribute("d",`M ${u.x},${u.y} C ${E},${P} ${B},${R} ${h.x},${h.y}`),m.setAttribute("fill","none"),m.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),m.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),m.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&m.setAttribute("stroke-dasharray","4 3"),m.setAttribute("vector-effect","non-scaling-stroke"),G.appendChild(m)})}function Xl(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Ql(e,t){if(!e||!t)return null;const n=e.left+e.width/2,o=e.top+e.height/2,i=t.x-n,a=t.y-o;if(i===0&&a===0)return{x:n,y:o};const s=e.width/2,l=e.height/2,u=[];i!==0&&u.push((i>0?s:-s)/i),a!==0&&u.push((a>0?l:-l)/a);const h=Math.min(...u.filter(E=>E>0)),m=Number.isFinite(h)?h:0;return{x:n+i*m,y:o+a*m}}function ec(e,t,n=0){if(!e||!t||n<=0)return e;const o=t.left+t.width/2,i=t.top+t.height/2,a=o-e.x,s=i-e.y,l=Math.hypot(a,s);if(!l)return e;const u=Math.min(n,l/2)/l;return{x:e.x+a*u,y:e.y+s*u}}function Pi(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function _p(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),Ho&&o.set("vault",Ho),`obsidian://advanced-uri?${o.toString()}`}function Cp(e){return e?wi===ia?e.id??e.name??"":e.name??e.id??"":""}function tc(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!Uo||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=Cp(e);return _p(o)}function nc(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function xp(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),hi(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Tp(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),hi(e)}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function oc(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(xp(t))}function ic(){Z||(Z=requestAnimationFrame(()=>{Z=null,te=te.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),te.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function Ap(e,t){!e||!t||(te.push({labelEl:e,textEl:t}),ic())}function Lp(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${Pi(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${Pi(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function Ri(e,t,{offset:n=8}={}){!ne||!e||!t||(ne.innerHTML=t,ne.hidden=!1,ne.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=ne.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let l=o.left+o.width/2-i.width/2+a,u=o.top-i.height-n+s;l<a+n&&(l=a+n);const h=a+window.innerWidth-i.width-n;l>h&&(l=h),u<s+n&&(u=o.bottom+n+s),ne.style.left=`${l}px`,ne.style.top=`${u}px`,ne.classList.add("is-visible")}))}function Kn(){Dn&&(clearTimeout(Dn),Dn=null),ne&&(ne.classList.remove("is-visible"),ne.setAttribute("aria-hidden","true"),ne.hidden=!0)}function Np(e,t){if(!e)return;const n=Je((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=Lp(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{U=e,Ri(e,`<div class="version-nav__tooltip-title">${Pi(n)}</div>`,{offset:10})},l=()=>{a(),i=setTimeout(()=>{U===e&&Ri(e,o,{offset:10})},ke)},u=()=>{s(),l()},h=()=>{U!==e&&s(),l()},m=()=>{a(),U===e&&(U=null,Kn())};e.addEventListener("mouseenter",u),e.addEventListener("focus",u),e.addEventListener("pointermove",h),e.addEventListener("mouseleave",m),e.addEventListener("blur",m),e.addEventListener("click",m)}function Mp(){d&&(d=!1,!(!sn||!Cn)&&(Kn(),Ri(sn,Cn,{offset:12}),Dn=setTimeout(()=>{Kn(),Bp()},1e3)))}function Bp(){sn&&(y&&(clearTimeout(y),y=null),sn.classList.add("blockscape-tab--twinkle"),y=setTimeout(()=>{sn.classList.remove("blockscape-tab--twinkle"),y=null},1400))}window.addEventListener("scroll",Kn,!0),window.addEventListener("resize",Kn),de&&de.addEventListener("click",()=>{np()}),Ne&&Ne.addEventListener("click",()=>{op()}),Ce&&Ce.addEventListener("click",()=>{try{Yu(),zu()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),be&&be.addEventListener("click",wr),ht&&ht.addEventListener("click",wr),ie&&ie.addEventListener("click",va),x&&x.addEventListener("click",va),S&&S.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");Vn||!t||!S.contains(t)||Du(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||Uu(e)}),je&&je.addEventListener("click",()=>{Ul("button")}),z&&z.addEventListener("click",()=>{if(g<0){alert("Load or select a model before creating a version.");return}try{const e=Dl({versionLabel:"map edit"});Dt(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),ze&&ze.addEventListener("click",async()=>{var a;if(g<0||!k[g]){alert("Select or load a model before sharing.");return}const e={title:Je(k[g],"Shared Model"),data:k[g].data};let t;try{t=wd(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),document.addEventListener("keydown",e=>{var o,i,a,s,l,u,h,m,E,P;if(tp()){e.key==="Escape"&&(e.preventDefault(),wr());return}if(!($!=null&&$.hidden)&&e.key==="Escape"){e.preventDefault(),va();return}if((o=yo==null?void 0:yo.isOpen)==null?void 0:o.call(yo))return;const n=Vn;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const B=k[g],R=((i=B==null?void 0:B.apicurioVersions)==null?void 0:i.length)>1;Ul("shortcut",R);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!ko())return;if(Wp()){e.preventDefault();return}}if(e.key==="Escape"){let B=!1;ee&&!ee.hidden&&(So(),B=!0),(q||A)&&(ui(),B=!0),B&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!ko())return;const B=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if(vt&&e.shiftKey&&q&&!e.ctrlKey&&!e.metaKey&&Pu(q,B)){e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&!e.shiftKey){Sr(B)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(A&&!e.shiftKey){e.preventDefault();return}e.shiftKey?Op(B)&&e.preventDefault():Vp(B)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!ko())return;const B=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){Fp(B)&&e.preventDefault();return}if(e.altKey)return;if(A&&!q&&!e.shiftKey){if(Up(B)){e.preventDefault();return}if(kp(B)){e.preventDefault();return}}e.shiftKey?Hp(B)&&e.preventDefault():Dp(B)&&e.preventDefault()}if(e.key==="Delete"){if(n||!ko()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const B=A?Gp():!1,R=B?!0:rc();(B||R)&&e.preventDefault()}if(e.key==="F2"){if(n||!ko())return;const B=A&&!q&&A||!q&&((u=(l=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:l.dataset)==null?void 0:u.cat)||null;if(B&&!q&&$p(B)){e.preventDefault();return}const R=q||((P=(E=(m=(h=e.target)==null?void 0:h.closest)==null?void 0:m.call(h,".tile"))==null?void 0:E.dataset)==null?void 0:P.id);R&&yo.open(R)&&e.preventDefault()}if(e.key==="Insert"){if(n||!ko()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;ac()&&e.preventDefault()}}),window.addEventListener("resize",()=>{Hu()}),window.addEventListener("scroll",()=>Fu(),!0);function Pp(e,t,n){if(g<0)return;const i=k[g].data.categories||[],a=i.find(m=>(m.items||[]).some(E=>E.id===e)),s=i.find(m=>m.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const l=a.items.findIndex(m=>m.id===e);if(l===-1)return;const[u]=a.items.splice(l,1);let h=s.items.length;if(t){const m=s.items.findIndex(E=>E.id===t);m!==-1&&(h=m)}s.items.splice(h,0,u),xt(),_t()}function Rp(e){if(g<0||!e)return;const t=k[g].data,o=(t.categories||[]).find(u=>u.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:Ru(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),xt(),_t(),So(),Tt(s.id);const l=xe.get(s.id);l!=null&&l.el&&l.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function ac(){if(g<0)return!1;const e=k[g].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=$u(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),A=n,q=null,mt=null,qe=null,xt(),_t(),Gn(n),console.log("[Blockscape] added category",n),!0}function $p(e=Bi()){if(g<0||!e)return!1;const t=Vu.open(e);return t&&(q=null,mt=null,Xt()),t}function Op(e){if(!q||g<0||!e)return!1;const n=k[g].data.categories||[],o=xe.get(q);let i=null;if(o!=null&&o.catId&&(i=n.find(u=>u.id===o.catId)),i||(i=n.find(u=>(u.items||[]).some(h=>h.id===q))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(u=>u.id===q);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[l]=i.items.splice(a,1);return i.items.splice(s,0,l),xt(),_t(),Mi(),Tt(q),!0}function Vp(e){if(!K||!K.m||!e)return!1;const t=K.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(h=>(h.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!q){const u=n();return u?(Tt(u.item.id),!0):!1}const o=xe.get(q);let i=null;if(o!=null&&o.catId&&(i=t.find(u=>u.id===o.catId)),i||(i=t.find(u=>(u.items||[]).some(h=>h.id===q))),!i){const u=n();return u?(Tt(u.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(u=>u.id===q);if(s===-1)return!1;const l=s+e;return l<0||l>=a.length?!1:(Tt(a[l].id),!0)}function Dp(e){if(!K||!K.m||!e)return!1;const t=K.m.categories||[];if(!t.length)return!1;const n=Bi();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(q){const l=(t[o].items||[]).findIndex(u=>u.id===q);qe={catId:a.id,position:l===-1?0:l}}else qe=null;return Gn(a.id,{preserveEntryHint:!0})}function Up(e){var a;if(!A||!((a=K==null?void 0:K.m)!=null&&a.categories)||!e)return!1;const n=(K.m.categories||[]).find(s=>s.id===A);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(qe==null?void 0:qe.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,qe.position||0))),qe=null,Tt(o[i].id),!0}function Hp(e){if(!q||g<0||!e)return!1;const n=k[g].data.categories||[];if(!n.length)return!1;const o=xe.get(q);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(E=>E.id===o.catId)),i===-1&&(i=n.findIndex(E=>(E.items||[]).some(P=>P.id===q))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],l=n[a];if(!l)return!1;s.items=s.items||[],l.items=l.items||[];const u=s.items.findIndex(E=>E.id===q);if(u===-1)return!1;const h=Math.min(l.items.length,Math.max(0,u)),m=h<l.items.length?l.items[h].id:null;return Pp(q,m,l.id),Mi(),Tt(q),!0}function Fp(e){if(g<0||!e)return!1;const n=k[g].data.categories||[];if(!n.length)return!1;const o=Bi();if(!o)return!1;const i=n.findIndex(l=>l.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),A=s.id,Er(),qe=null,Xt(),xt(),_t(),di(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function Wp(){if(g<0)return!1;const e=k[g],t=yt(e)||(e?e.id:null),n=[];if(bt&&t===bt.modelId&&n.push({...bt,type:"item"}),on&&t===on.modelId&&n.push({...on,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(zp(o))return!0}else if(o.type==="item"&&jp(o))return!0;return!1}function jp(e){const t=k[g],n=yt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(l=>l.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),bt=null,So(),q=null,mt=null,Xt(),xt(),_t(),Mi(),Tt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function zp(e){const t=k[g],n=yt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),on=null,q=null,mt=null,A=e.category.id,qe=null,Xt(),xt(),_t(),di(),Gn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function rc(){if(!q||g<0)return!1;const t=k[g].data.categories||[];if(!t.length)return!1;const n=xe.get(q);let o=null;if(n!=null&&n.catId&&(o=t.find(h=>h.id===n.catId)),o||(o=t.find(h=>(h.items||[]).some(m=>m.id===q))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(h=>h.id===q);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=k[g];bt={item:a,categoryId:o.id,index:i,modelId:yt(s)||(s?s.id:null),ts:Date.now()};const u=(()=>{var m;if(o.items.length){const E=Math.min(i,o.items.length-1);return((m=o.items[E])==null?void 0:m.id)||null}const h=t.findIndex(E=>E.id===o.id);if(h===-1)return null;for(let E=h+1;E<t.length;E++){const P=t[E].items||[];if(P.length)return P[0].id}for(let E=h-1;E>=0;E--){const P=t[E].items||[];if(P.length)return P[0].id}return null})();return So(),q=null,mt=null,qe=null,Xt(),xt(),_t(),Mi(),u?Tt(u):ui(),console.log("[Blockscape] removed item",a.id),!0}function Gp(){var l,u;const e=Bi();if(!e||g<0)return!1;const n=k[g].data.categories||[];if(!n.length)return!1;const o=n.findIndex(h=>h.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=k[g];on={category:i,index:o,modelId:yt(a)||(a?a.id:null),ts:Date.now()},A=null,q=null,mt=null,qe=null,Xt(),xt(),_t();const s=((l=n[o])==null?void 0:l.id)||((u=n[o-1])==null?void 0:u.id)||null;return s?Gn(s):ui(),console.log("[Blockscape] removed category",i.id),!0}function Kp(e){if(!e)return!1;const t=q;q=e;const n=rc();return n||(q=t,Xt()),n}H&&H.addEventListener("click",async()=>{const e=f.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await yl(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),oe&&oe.addEventListener("click",async()=>{const e=Gu();if(!e){alert("No series available to copy. Create another version first.");return}await yl(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),D&&D.addEventListener("click",async()=>{try{const e=await Kd();if(!e){alert("Clipboard is empty.");return}f.value=e,f.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await Li(),t=no(f.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=jn(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),g===-1&&n!=null?Dt(n):Pn(),e&&await sc(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(g<0){alert("No active model selected.");return}try{const t=JSON.parse(f.value);if(Bn(t,{titleHint:Je(k[g]),idHint:yt(k[g])||Je(k[g])}),k[g].data=t,k[g].title=t.title||k[g].title,k[g].isSeries||((e=k[g].apicurioVersions)==null?void 0:e.length)>1){const n=k[g].title||Je(k[g]);Ft(k[g],{seriesName:n,fallbackTitle:n})}mr(),console.log("[Blockscape] replaced active model:",Je(k[g])),_t(),he.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=no(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((l,u)=>{var O;const h=(((O=l.data)==null?void 0:O.title)??"").toString().trim(),m=s.length>1?`${o.name} #${u+1}`:o.name,E=`${a} series`,P=l.isSeries?E:null;let B={...l};if(l.isSeries){const Q=P||h||l.title||m||"unknown";B.title=Q;const De=In(Q||"unknown");vo(B,De),Ft(B,{seriesName:Q,fallbackTitle:"unknown"}),B.apicurioArtifactName=B.apicurioArtifactName||Q}else B.title=h||m;const R=jn({...B,apicurioArtifactName:B.apicurioArtifactName||P||B.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=R)})}g===-1&&n!=null?Dt(n):Pn()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",qp);async function qp(e){var a;if(!ko())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!up(t))return;let n=[];try{const s=await Li();n=no(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,l)=>{const u=jn(s,{versionLabel:n.length>1?`paste #${l+1}`:"paste"});o==null&&(o=u),i.push(u)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&Dt(o),await Li()&&await sc(i,{origin:"clipboard"})}async function sc(e,{origin:t="clipboard"}={}){if(!await Li()||typeof(et==null?void 0:et.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter(P=>{const B=k[P];return B&&!B.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=k[o[0]],s=Xd(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const l=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(l==null)return;const u=wo(l);if(!u){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const h=await Yd(),m=[];for(let P=0;P<o.length;P++){const B=o.length===1?u:Jd(u,P+1),R=Zd(B,h);if(!R){alert("Could not find a unique filename to save.");return}h.add(R),m.push(R)}let E=null;for(let P=0;P<o.length;P++){const B=o[P],R=m[P],O=k[B];if(!O)continue;o.length===1&&Qd(O,R);const Q=await et.saveModelByIndex(B,R,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(Q!=null&&Q.ok)){alert(`Local auto-save failed: ${(Q==null?void 0:Q.error)||"unknown error"}`);return}E==null&&(E=R)}E&&(ma(E),Vd(E,{origin:t})),await et.refresh(),Pn(),un(`Saved ${o.length} ${i}.`,2500)}Y.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&Dt(n)}),document.getElementById("removeModel").onclick=()=>{if(g<0)return;const e=Je(k[g]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",Je(k[g])),k.splice(g,1),!k.length){g=-1,K=null,S.innerHTML="",G.innerHTML="",f.value="",Pn(),mr();return}const n=Math.min(g,k.length-1);Dt(n)},J&&(J.addEventListener("input",e=>{yr(e.target.value||"")}),J.addEventListener("focus",()=>{J.value&&J.value.trim()&&jl(J.value)})),ye&&ye.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;rp({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!ye||ye.hidden)return;const t=e.target;ye.contains(t)||J&&(t===J||J.contains(t))||(ye.hidden=!0)}),document.addEventListener("click",e=>{var o,i,a;const t=(i=(o=e.target)==null?void 0:o.closest)==null?void 0:i.call(o,"a[href]");if(!t||(a=t.classList)!=null&&a.contains("blockscape-gist-link")||t.hasAttribute("download"))return;const n=t.getAttribute("href");jc(n)&&(e.preventDefault(),e.stopPropagation(),hi(zc(n)))}),C&&pe&&j&&C.addEventListener("submit",async e=>{e.preventDefault();const t=pe.value.trim();if(!t){alert("Please enter a URL"),pe.focus();return}const n=await Ir(t);if(typeof n=="number"){Dt(n),pe.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!pe||!t)return;let n=null;pe.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=pe.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function _t(){if(!(g<0))try{ya(k[g]),K=hp(k[g].data),Mi()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Jp(){const e=["models.bs"],t=n=>oa?oa.endsWith("/")?`${oa}${n}`:`${oa}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=no(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(l=>{let u={...l};if(l.isSeries){const h=`${a} series`;u={...l,title:h,apicurioArtifactName:h};const m=In(h||"unknown");vo(u,m),Ft(u,{seriesName:h,fallbackTitle:"unknown"})}jn(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}Pn()}async function lc(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function Yp(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>Zp(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");dc(i)&&cc(o,i)})}function Zp(e){var l,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(l=e.parentNode)==null?void 0:l.closest)!=null&&u.call(l,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:h,index:m})=>{m>s&&a.appendChild(document.createTextNode(t.slice(s,m))),a.appendChild(Xp(h)),s=m+h.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function Xp(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",dc(e)&&cc(t,e),t}function cc(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Qp(n,t,e)))}async function Qp(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await Ir(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function dc(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.github.com"||n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}function ef(e){if(!e)return null;const t=e.toString().trim();if(!t)return null;try{const n=new URL(t,window.location.href);if(n.hostname==="gist.github.com"){const o=nf(n);if(o)return o.toString()}if(n.hostname==="gist.githubusercontent.com"){const o=tf(n);if(o)return o.toString()}return n.toString()}catch{return t}}function tf(e){try{const t=new URL(e.toString()),n=t.pathname.split("/").filter(Boolean);if(n.includes("raw"))return t;if(n.length>=2){const[o,i,...a]=n,s=a.join("/");return t.pathname=`/${o}/${i}/raw${s?`/${s}`:""}`,t}return t}catch{return null}}function nf(e){try{const t=e.pathname.split("/").filter(Boolean);if(t.length<2)return e;const[n,o,...i]=t,a=i.find(h=>h.includes("."));let s=null;e.hash&&e.hash.startsWith("#file-")&&(s=e.hash.replace(/^#file-/,"").replace(/-/g,"."));const l=a||s||"";return new URL(`https://gist.githubusercontent.com/${n}/${o}/raw/${l}`)}catch{return e}}async function Ir(e){try{const t=ef(e);console.log("[Blockscape] loading from URL:",{requested:e,resolved:t});const n=await lc(t),i=((t||e||"").split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let a;try{a=no(n,i)}catch(l){throw new Error(`Invalid JSON payload: ${l.message}`)}if(!a.length)throw new Error("No JSON objects found in response.");let s=null;return a.forEach((l,u)=>{var R;const h=(((R=l.data)==null?void 0:R.title)??"").toString().trim(),m=a.length>1?`${i} #${u+1}`:i,E=l.isSeries?`${i} series`:null;let P={...l};if(l.isSeries){const O=E||h||P.title||m;P={...l,title:O,apicurioArtifactName:O||l.apicurioArtifactName};const Q=In(O||"unknown");vo(P,Q),Ft(P,{seriesName:O||E||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:Q,url:e,baseName:i,seriesTitle:O})}const B=jn({...P,title:h||P.title||m,apicurioArtifactName:P.apicurioArtifactName||E||l.apicurioArtifactName},{versionLabel:i});s==null&&(s=B)}),console.log(`[Blockscape] loaded ${a.length} model(s) from URL:`,i),g===-1&&s!=null?Dt(s):Pn(),s}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=no(n,"Blockscape",{defaultBackgroundUrl:md});if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(E=>{const P=jn(E,{versionLabel:"seed"});i==null&&(i=P)}),await Sd(),!await ll&&c.autoLoadFromDir&&await Jp();const s=await fp(),l=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,u=await mp(),h=pp(),m=typeof l=="number"?l:typeof u=="number"?u:typeof h=="number"?h:i??0;Dt(m),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===m&&requestAnimationFrame(()=>{var P;if(g!==s.modelIndex)return;const E=(P=xe.get(s.itemId))==null?void 0:P.el;E&&(Tt(s.itemId),E.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),E.focus({preventScroll:!0}))})})()}const Zc=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function Xc(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function Qc(r){return Zc(Xc())}const ed=`${Qc()}documentation/`;function td(r){let c;return{c(){c=W("div"),c.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Watch the <a href="https://youtube.com/playlist?list=PLZIp4-s83kaPj5m9VcGXTBhjaquc9fT15&amp;si=aaeXo5ga0D7Vb5LN">videos</a></li> <li>Open the <a href="${ed}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,b(c,"id","shortcutHelp"),b(c,"class","shortcut-help"),c.hidden=!0,b(c,"aria-hidden","true"),b(c,"role","dialog"),b(c,"aria-modal","true"),b(c,"aria-labelledby","shortcutHelpTitle")},m(f,T){Nt(f,c,T)},p:Ot,i:Ot,o:Ot,d(f){f&&Et(c)}}}class nd extends ta{constructor(c){super(),ea(this,c,null,td,qi,{})}}const od=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
        * optional \`stage\`: integer 1–4 for Wardley maps only (1=genesis, 2=custom, 3=product, 4=commodity/service). Include only when the user explicitly asks for a Wardley model/series.
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping. Only include the \`stage\` field when explicitly asked for a Wardley map/series.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function Ls(r){let c,f,T,S,G,ne,Y,ee;return{c(){c=W("div"),f=W("div"),T=W("a"),S=Ji("Open Blockscape GPT"),G=le(),ne=W("div"),ne.textContent="Paste the copied prompt into that chat.",Y=le(),ee=W("div"),ee.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',b(T,"href",ad),b(T,"target","_blank"),b(T,"rel","noreferrer"),b(ne,"class","new-panel__hint"),b(f,"class","new-panel__link"),b(ee,"class","new-panel__link new-panel__link--disabled"),b(c,"class","new-panel__links")},m(C,pe){Nt(C,c,pe),_(c,f),_(f,T),_(T,S),_(f,G),_(f,ne),_(c,Y),_(c,ee)},p:Ot,d(C){C&&Et(c)}}}function Ns(r){let c,f,T,S,G,ne;return{c(){c=W("div"),f=W("div"),f.textContent="Generated prompt",T=le(),S=W("textarea"),b(f,"class","new-panel__prompt-label"),b(S,"class","pf-v5-c-form-control new-panel__textarea"),b(S,"rows","4"),S.readOnly=!0,b(c,"class","new-panel__prompt")},m(Y,ee){Nt(Y,c,ee),_(c,f),_(c,T),_(c,S),fo(S,r[4]),G||(ne=Ln(S,"input",r[12]),G=!0)},p(Y,ee){ee&16&&fo(S,Y[4])},d(Y){Y&&Et(c),G=!1,ne()}}}function id(r){let c,f,T,S,G,ne,Y,ee,C,pe,j,ce,ge,at,We,je,ze,z,H,oe,D,de,Ne,Ce,Re,$e,be,ht,$,ie,x,J,ye,ue,Xe,ae,Ye,ft,rt,pt,w,Qe,Mt,Ee,gt,Bt,k,g=r[2]==="gpt"&&Ls(),he=r[4]&&r[5]&&Ns(r);return gt=_c(r[10][0]),{c(){c=W("div"),f=W("div"),T=le(),S=W("div"),G=W("div"),G.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',ne=le(),Y=W("form"),ee=W("div"),C=W("label"),C.textContent="Domain",pe=le(),j=W("p"),j.textContent="Describe what you want to create a map for.",ce=le(),ge=W("textarea"),at=le(),We=W("div"),je=W("label"),ze=W("input"),z=le(),H=W("span"),H.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,oe=le(),D=W("fieldset"),de=W("legend"),de.textContent="Target",Ne=le(),Ce=W("p"),Ce.textContent="Choose where you plan to use the prompt.",Re=le(),$e=W("label"),be=W("input"),ht=le(),$=W("div"),$.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',ie=le(),x=W("label"),J=W("input"),ye=le(),ue=W("div"),ue.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',Xe=le(),ae=W("div"),Ye=W("button"),Ye.textContent="Copy prompt",ft=le(),rt=W("button"),rt.textContent="New blank",pt=le(),w=W("div"),Qe=Ji(r[3]),Mt=le(),g&&g.c(),Ee=le(),he&&he.c(),b(f,"id","newPanelBackdrop"),b(f,"class","shortcut-help__backdrop"),b(G,"class","shortcut-help__header"),b(C,"for","newDomain"),b(j,"class","new-panel__hint"),b(ge,"id","newDomain"),b(ge,"class","pf-v5-c-form-control new-panel__textarea"),b(ge,"rows","4"),ge.required=!0,b(ge,"placeholder","Ex: Companies building open-source geospatial tools"),b(ee,"class","new-panel__field"),b(ze,"id","seriesToggle"),b(ze,"type","checkbox"),b(je,"class","new-panel__toggle"),b(je,"for","seriesToggle"),b(We,"class","new-panel__field"),b(Ce,"class","new-panel__hint"),b(be,"type","radio"),b(be,"name","target"),be.__value="gpt",fo(be,be.__value),b($e,"class","new-panel__option"),b(J,"type","radio"),b(J,"name","target"),J.__value="plain",fo(J,J.__value),b(x,"class","new-panel__option"),b(D,"class","new-panel__field"),b(Ye,"class","pf-v5-c-button pf-m-primary"),b(Ye,"type","submit"),b(rt,"id","newBlankButton"),b(rt,"class","pf-v5-c-button pf-m-secondary"),b(rt,"type","button"),b(rt,"title","Start from an empty map"),b(w,"class","new-panel__status"),b(w,"aria-live","polite"),b(ae,"class","new-panel__actions"),b(Y,"class","shortcut-help__list new-panel__form"),b(S,"class","shortcut-help__panel"),b(S,"tabindex","-1"),b(c,"id","newPanel"),b(c,"class","shortcut-help"),c.hidden=!0,b(c,"aria-hidden","true"),b(c,"role","dialog"),b(c,"aria-modal","true"),b(c,"aria-labelledby","newPanelTitle"),gt.p(be,J)},m(K,xe){Nt(K,c,xe),_(c,f),_(c,T),_(c,S),_(S,G),_(S,ne),_(S,Y),_(Y,ee),_(ee,C),_(ee,pe),_(ee,j),_(ee,ce),_(ee,ge),fo(ge,r[0]),_(Y,at),_(Y,We),_(We,je),_(je,ze),ze.checked=r[1],_(je,z),_(je,H),_(Y,oe),_(Y,D),_(D,de),_(D,Ne),_(D,Ce),_(D,Re),_(D,$e),_($e,be),be.checked=be.__value===r[2],_($e,ht),_($e,$),_(D,ie),_(D,x),_(x,J),J.checked=J.__value===r[2],_(x,ye),_(x,ue),_(Y,Xe),_(Y,ae),_(ae,Ye),_(ae,ft),_(ae,rt),_(ae,pt),_(ae,w),_(w,Qe),_(Y,Mt),g&&g.m(Y,null),_(Y,Ee),he&&he.m(Y,null),Bt||(k=[Ln(ge,"input",r[7]),Ln(ze,"change",r[8]),Ln(be,"change",r[9]),Ln(J,"change",r[11]),Ln(Y,"submit",Ic(r[6]))],Bt=!0)},p(K,[xe]){xe&1&&fo(ge,K[0]),xe&2&&(ze.checked=K[1]),xe&4&&(be.checked=be.__value===K[2]),xe&4&&(J.checked=J.__value===K[2]),xe&8&&Ss(Qe,K[3]),K[2]==="gpt"?g?g.p(K,xe):(g=Ls(),g.c(),g.m(Y,Ee)):g&&(g.d(1),g=null),K[4]&&K[5]?he?he.p(K,xe):(he=Ns(K),he.c(),he.m(Y,null)):he&&(he.d(1),he=null)},i:Ot,o:Ot,d(K){K&&Et(c),g&&g.d(),he&&he.d(),gt.r(),Bt=!1,Ao(k)}}}const ad="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function rd(r,c,f){let T="",S=!1,G="gpt",ne="",Y="",ee=!1;const C=()=>{var z;return typeof navigator<"u"&&!!((z=navigator.clipboard)!=null&&z.writeText)};function pe(z){const H=z||"[DOMAIN]",oe=S?"series":"map",de=od.replaceAll("[DOMAIN NAME]",H).replaceAll("[DOMAIN]",H).replaceAll("[map|series]",oe).split(`
`),Ne=`Generate a **blockscape ${oe}** for the domain of ${H}.`,Ce=de.findIndex($e=>$e.toLowerCase().includes("generate a **blockscape value")||$e.toLowerCase().includes("generate a blockscape [map|series]")||$e.toLowerCase().startsWith("generate a blockscape"));Ce>=0?de[Ce]=Ne:de.unshift(Ne);const Re=S?`

User requested a series (return an array of models).`:"";return`${de.join(`
`).trim()}${Re}`}async function j(z){z.preventDefault();const H=T.trim();if(f(3,ne=""),f(5,ee=G!=="gpt"),!H){f(3,ne="Add a domain to generate a prompt."),f(4,Y="");return}if(G==="gpt"?f(4,Y=`${S?"Create a series":"Create a map"} for ${H}`):(f(4,Y=pe(H)),f(5,ee=!0)),!C()){f(3,ne="Clipboard access is unavailable. Copy the prompt below."),f(5,ee=!0);return}try{await navigator.clipboard.writeText(Y),f(3,ne=G==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),G==="gpt"&&f(5,ee=!1)}catch(D){console.warn("[Blockscape] clipboard write failed",D),f(3,ne="Copy failed. Use the prompt below."),f(5,ee=!0)}}const ce=[[]];function ge(){T=this.value,f(0,T)}function at(){S=this.checked,f(1,S)}function We(){G=this.__value,f(2,G)}function je(){G=this.__value,f(2,G)}function ze(){Y=this.value,f(4,Y)}return[T,S,G,ne,Y,ee,j,ge,at,We,ce,je,ze]}class sd extends ta{constructor(c){super(),ea(this,c,rd,id,qi,{})}}const{document:Ms}=kc;function ld(r){let c,f,T,S,G,ne,Y,ee,C,pe,j,ce,ge,at,We,je,ze,z,H,oe,D,de,Ne,Ce,Re,$e,be,ht,$,ie,x,J,ye,ue,Xe,ae,Ye,ft,rt,pt,w,Qe,Mt,Ee,gt,Bt,k,g,he,K,xe,kt,q,A,mt,qe,cn,Vn,nn,Qn,bt,on,mo,_n,Nn,an,Wt,Jt,mn,It,rn,dn,Dn,sn,Cn,d,y,N,M,I,U,te,Z,Me=`<script id="seed" type="application/json">${r[5]}<\/script>`,ke,_e,Oe,st,Be,St,Vt,dt,Ve,ut,jt,Ze,ot,wt,zt;return ut=new nd({}),Ze=new sd({}),{c(){c=W("link"),f=le(),T=W("div"),S=W("header"),G=W("div"),ne=W("div"),Y=W("div"),ee=W("div"),ee.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',C=le(),pe=W("div"),j=W("div"),ce=W("button"),ge=W("span"),ge.textContent="Advanced",at=le(),We=W("span"),We.textContent="▾",ze=le(),z=W("button"),z.textContent="New",H=le(),oe=W("label"),oe.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',D=le(),de=W("div"),Ne=W("span"),Ne.textContent="Zoom",Ce=le(),Re=W("button"),Re.textContent="-",$e=le(),be=W("button"),ht=Ji(r[1]),$=le(),ie=W("button"),ie.textContent="+",x=le(),J=W("button"),J.textContent="Share",ye=le(),ue=W("button"),ue.textContent="Help",Xe=le(),ae=W("div"),Ye=W("div"),Ye.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',ft=le(),rt=W("form"),rt.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',Mt=le(),Ee=W("a"),Ee.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',Bt=le(),k=W("main"),g=W("div"),he=W("aside"),K=W("div"),K.textContent="Models",xe=le(),kt=W("ul"),q=le(),A=W("div"),A.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',mt=le(),qe=W("section"),cn=W("div"),cn.innerHTML='<div class="sidebar-heading">Local files</div> <button id="toggleServerSidebar" class="pf-v5-c-button pf-m-tertiary" type="button" aria-pressed="false" hidden="">Wide menu</button>',Vn=le(),nn=W("p"),nn.textContent="Checking for local server…",Qn=le(),bt=W("div"),on=W("label"),on.textContent="Blockscape files under ~/blockscape",mo=le(),_n=W("div"),Nn=W("label"),Nn.textContent="Folder",an=le(),Wt=W("select"),Jt=W("option"),Jt.textContent="Root (~/blockscape)",mn=le(),It=W("select"),rn=le(),dn=W("div"),dn.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button> <button id="deleteLocalFile" class="pf-v5-c-button pf-m-danger" type="button">Delete</button>',Dn=le(),sn=W("div"),sn.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',d=le(),y=W("div"),y.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,stage?:1-4,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,N=le(),M=W("footer"),I=W("div"),I.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',te=le(),Z=new xc(!1),ke=le(),_e=ys("svg"),Oe=le(),st=W("div"),Be=le(),St=W("div"),Vt=le(),dt=W("div"),dt.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',Ve=le(),Ha(ut.$$.fragment),jt=le(),Ha(Ze.$$.fragment),Ms.title="Blockscape — simple landscape-style tiles",b(c,"rel","icon"),b(c,"type","image/svg+xml"),b(c,"href","./favicon.svg"),b(ee,"class","blockscape-brand"),b(ge,"class","blockscape-toolbar__toggle-label"),b(We,"class","blockscape-toolbar__toggle-icon"),b(We,"aria-hidden","true"),b(ce,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),b(ce,"type","button"),b(ce,"aria-expanded",r[0]),b(ce,"aria-controls","blockscapeHeaderExtras"),b(ce,"aria-label",je=r[0]?"Hide advanced tools":"Show advanced tools"),b(z,"id","newPanelButton"),b(z,"class","pf-v5-c-button pf-m-primary"),b(z,"type","button"),b(z,"title","Create something new"),b(oe,"class","pf-v5-c-button pf-m-primary blockscape-file"),b(Ne,"class","blockscape-zoom__label"),b(Re,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),b(Re,"type","button"),b(Re,"title","Zoom out (Ctrl -)"),b(be,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__reset"),b(be,"type","button"),b(be,"title","Reset zoom (Ctrl 0)"),b(ie,"class","pf-v5-c-button pf-m-tertiary blockscape-zoom__button"),b(ie,"type","button"),b(ie,"title","Zoom in (Ctrl +)"),b(de,"class","blockscape-zoom"),b(de,"role","group"),b(de,"aria-label","Zoom controls"),b(J,"id","shareModel"),b(J,"class","pf-v5-c-button pf-m-secondary"),b(J,"type","button"),b(J,"title","Copy a shareable URL for this model"),b(ue,"id","helpButton"),b(ue,"class","pf-v5-c-button pf-m-primary"),b(ue,"type","button"),b(ue,"title","Show keyboard shortcuts"),b(j,"class","blockscape-toolbar__primary"),b(Ye,"class","blockscape-search"),b(rt,"id","urlForm"),b(rt,"class","blockscape-url-form"),b(rt,"autocomplete","on"),rt.noValidate=!0,b(ae,"id","blockscapeHeaderExtras"),b(ae,"class","blockscape-toolbar__extras"),ae.hidden=pt=!r[0],b(ae,"aria-hidden",w=!r[0]),b(pe,"class","blockscape-toolbar__controls"),b(pe,"data-expanded",Qe=r[0]?"true":"false"),b(Ee,"href","https://github.com/pwright/blockscape"),b(Ee,"target","_blank"),b(Ee,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),b(Ee,"title","View on GitHub"),b(Ee,"aria-label","View Blockscape on GitHub"),b(Y,"class","blockscape-toolbar"),b(ne,"class","pf-v5-c-masthead__content"),b(G,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),b(S,"class","pf-v5-c-page__header"),S.hidden=gt=!r[4],b(K,"class","sidebar-heading"),b(kt,"id","modelList"),b(kt,"class","model-nav-list"),b(A,"class","model-actions"),b(cn,"class","local-backend__header"),b(nn,"id","localBackendStatus"),b(nn,"class","local-backend__status muted"),b(on,"class","sr-only"),b(on,"for","localFileList"),b(Nn,"for","localDirSelect"),Jt.__value="",fo(Jt,Jt.__value),b(Wt,"id","localDirSelect"),b(Wt,"class","pf-v5-c-form-control"),b(Wt,"aria-label","Folder filter"),b(_n,"class","local-backend__dir"),b(It,"id","localFileList"),b(It,"class","pf-v5-c-form-control"),b(It,"size","12"),It.multiple=!0,b(It,"aria-label","Blockscape files on local server"),b(dn,"class","local-backend__actions"),b(bt,"class","local-backend__list"),b(sn,"class","local-backend__save"),b(qe,"id","localBackendPanel"),b(qe,"class","local-backend"),qe.hidden=!0,b(he,"class","blockscape-sidebar"),b(he,"aria-label","Models"),he.hidden=Cn=!r[3],b(y,"class","blockscape-main"),b(g,"class","blockscape-content"),b(k,"class","pf-v5-c-page__main"),b(I,"class","blockscape-footer__inner"),b(M,"class","pf-v5-c-page__footer blockscape-footer"),M.hidden=U=!r[2],b(T,"class","pf-v5-c-page"),Z.a=ke,b(_e,"id","overlay"),b(_e,"class","svg-layer"),b(st,"id","tabTooltip"),b(st,"class","blockscape-tab-tooltip"),st.hidden=!0,b(st,"aria-hidden","true"),b(St,"id","tileContextMenu"),b(St,"class","tile-context-menu"),St.hidden=!0,b(St,"aria-hidden","true"),b(dt,"id","itemPreview"),b(dt,"class","item-preview"),dt.hidden=!0,b(dt,"aria-hidden","true")},m(we,Ge){_(Ms.head,c),Nt(we,f,Ge),Nt(we,T,Ge),_(T,S),_(S,G),_(G,ne),_(ne,Y),_(Y,ee),_(Y,C),_(Y,pe),_(pe,j),_(j,ce),_(ce,ge),_(ce,at),_(ce,We),_(j,ze),_(j,z),_(j,H),_(j,oe),_(j,D),_(j,de),_(de,Ne),_(de,Ce),_(de,Re),_(de,$e),_(de,be),_(be,ht),_(de,$),_(de,ie),_(j,x),_(j,J),_(j,ye),_(j,ue),_(pe,Xe),_(pe,ae),_(ae,Ye),_(ae,ft),_(ae,rt),_(Y,Mt),_(Y,Ee),_(T,Bt),_(T,k),_(k,g),_(g,he),_(he,K),_(he,xe),_(he,kt),_(he,q),_(he,A),_(he,mt),_(he,qe),_(qe,cn),_(qe,Vn),_(qe,nn),_(qe,Qn),_(qe,bt),_(bt,on),_(bt,mo),_(bt,_n),_(_n,Nn),_(_n,an),_(_n,Wt),_(Wt,Jt),_(bt,mn),_(bt,It),_(bt,rn),_(bt,dn),_(qe,Dn),_(qe,sn),_(g,d),_(g,y),_(T,N),_(T,M),_(M,I),Nt(we,te,Ge),Z.m(Me,we,Ge),Nt(we,ke,Ge),Nt(we,_e,Ge),Nt(we,Oe,Ge),Nt(we,st,Ge),Nt(we,Be,Ge),Nt(we,St,Ge),Nt(we,Vt,Ge),Nt(we,dt,Ge),Nt(we,Ve,Ge),Xi(ut,we,Ge),Nt(we,jt,Ge),Xi(Ze,we,Ge),ot=!0,wt||(zt=[Ln(ce,"click",r[6]),Ln(Re,"click",r[8]),Ln(be,"click",r[9]),Ln(ie,"click",r[7])],wt=!0)},p(we,[Ge]){(!ot||Ge&1)&&b(ce,"aria-expanded",we[0]),(!ot||Ge&1&&je!==(je=we[0]?"Hide advanced tools":"Show advanced tools"))&&b(ce,"aria-label",je),(!ot||Ge&2)&&Ss(ht,we[1]),(!ot||Ge&1&&pt!==(pt=!we[0]))&&(ae.hidden=pt),(!ot||Ge&1&&w!==(w=!we[0]))&&b(ae,"aria-hidden",w),(!ot||Ge&1&&Qe!==(Qe=we[0]?"true":"false"))&&b(pe,"data-expanded",Qe),(!ot||Ge&16&&gt!==(gt=!we[4]))&&(S.hidden=gt),(!ot||Ge&8&&Cn!==(Cn=!we[3]))&&(he.hidden=Cn),(!ot||Ge&4&&U!==(U=!we[2]))&&(M.hidden=U)},i(we){ot||(Zi(ut.$$.fragment,we),Zi(Ze.$$.fragment,we),ot=!0)},o(we){Ua(ut.$$.fragment,we),Ua(Ze.$$.fragment,we),ot=!1},d(we){we&&(Et(f),Et(T),Et(te),Z.d(),Et(ke),Et(_e),Et(Oe),Et(st),Et(Be),Et(St),Et(Vt),Et(dt),Et(Ve),Et(jt)),Et(c),Qi(ut,we),Qi(Ze,we),wt=!1,Ao(zt)}}}function cd(r,c,f){let T,S,G,ne,{seed:Y}=c,{features:ee={}}=c;const pe=Y?JSON.stringify(Y,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "backgroundUrl": "https://upload.wikimedia.org/wikipedia/commons/4/44/Blured_black_keyboard.jpg",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let j=!1;const ce=[{label:"S",value:.9},{label:"M",value:1},{label:"L",value:1.15}];let ge=1;const at=()=>{if(f(0,j=!j),!j){const H=document.getElementById("search");H&&H.value&&(H.value="",H.dispatchEvent(new Event("input",{bubbles:!0})))}},We=()=>{const H=ce[ge].value;document.documentElement.style.setProperty("--blockscape-scale",String(H)),window.dispatchEvent(new CustomEvent("blockscape:zoom",{detail:{scale:H}}))},je=()=>{f(12,ge=Math.min(ce.length-1,ge+1)),We()},ze=()=>{f(12,ge=Math.max(0,ge-1)),We()},z=()=>{f(12,ge=1),We()};return Ac(()=>{Yc(ee),We();const H=oe=>{if(!(!oe.ctrlKey&&!oe.metaKey)){if(oe.key==="="||oe.key==="+"){je(),oe.preventDefault();return}if(oe.key==="-"||oe.key==="_"){ze(),oe.preventDefault();return}oe.key==="0"&&(z(),oe.preventDefault())}};return window.addEventListener("keydown",H),()=>window.removeEventListener("keydown",H)}),r.$$set=H=>{"seed"in H&&f(10,Y=H.seed),"features"in H&&f(11,ee=H.features)},r.$$.update=()=>{r.$$.dirty&2048&&f(4,T=ee.showHeader!==!1),r.$$.dirty&2048&&f(3,S=ee.showSidebar!==!1),r.$$.dirty&2048&&f(2,G=ee.showFooter!==!1),r.$$.dirty&4096&&f(1,ne=`${Math.round(ce[ge].value*100)}%`)},[j,ne,G,S,T,pe,at,je,ze,z,Y,ee,ge]}class dd extends ta{constructor(c){super(),ea(this,c,cd,ld,qi,{seed:10,features:11})}}function ud(r){let c,f;return c=new dd({props:{seed:r[0],features:r[1]}}),{c(){Ha(c.$$.fragment)},m(T,S){Xi(c,T,S),f=!0},p(T,[S]){const G={};S&1&&(G.seed=T[0]),S&2&&(G.features=T[1]),c.$set(G)},i(T){f||(Zi(c.$$.fragment,T),f=!0)},o(T){Ua(c.$$.fragment,T),f=!1},d(T){Qi(c,T)}}}function pd(r,c,f){let{seed:T}=c,{features:S={}}=c;return r.$$set=G=>{"seed"in G&&f(0,T=G.seed),"features"in G&&f(1,S=G.features)},[T,S]}class fd extends ta{constructor(c){super(),ea(this,c,pd,ud,qi,{seed:0,features:1})}}return fd}();
