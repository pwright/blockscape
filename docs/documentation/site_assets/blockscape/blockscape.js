var Blockscape=function(){"use strict";var Ip=Object.defineProperty;var _p=(Mn,Nt,to)=>Nt in Mn?Ip(Mn,Nt,{enumerable:!0,configurable:!0,writable:!0,value:to}):Mn[Nt]=to;var eo=(Mn,Nt,to)=>_p(Mn,typeof Nt!="symbol"?Nt+"":Nt,to);var Mn=typeof document<"u"?document.currentScript:null;function Nt(){}function to(r){return r()}function Wr(){return Object.create(null)}function ni(r){r.forEach(to)}function jr(r){return typeof r=="function"}function Bi(r,l){return r!=r?l==l:r!==l||r&&typeof r=="object"||typeof r=="function"}function Wl(r){return Object.keys(r).length===0}const jl=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function x(r,l){r.appendChild(l)}function It(r,l,h){r.insertBefore(l,h||null)}function vt(r){r.parentNode&&r.parentNode.removeChild(r)}function H(r){return document.createElement(r)}function zr(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function ga(r){return document.createTextNode(r)}function ue(){return ga(" ")}function no(r,l,h,A){return r.addEventListener(l,h,A),()=>r.removeEventListener(l,h,A)}function zl(r){return function(l){return l.preventDefault(),r.call(this,l)}}function v(r,l,h){h==null?r.removeAttribute(l):r.getAttribute(l)!==h&&r.setAttribute(l,h)}function Gl(r){let l;return{p(...h){l=h,l.forEach(A=>r.push(A))},r(){l.forEach(h=>r.splice(r.indexOf(h),1))}}}function Jl(r){return Array.from(r.childNodes)}function Kl(r,l){l=""+l,r.data!==l&&(r.data=l)}function oo(r,l){r.value=l??""}class ql{constructor(l=!1){eo(this,"is_svg",!1);eo(this,"e");eo(this,"n");eo(this,"t");eo(this,"a");this.is_svg=l,this.e=this.n=null}c(l){this.h(l)}m(l,h,A=null){this.e||(this.is_svg?this.e=zr(h.nodeName):this.e=H(h.nodeType===11?"TEMPLATE":h.nodeName),this.t=h.tagName!=="TEMPLATE"?h:h.content,this.c(l)),this.i(A)}h(l){this.e.innerHTML=l,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(l){for(let h=0;h<this.n.length;h+=1)It(this.t,this.n[h],l)}p(l){this.d(),this.h(l),this.i(this.a)}d(){this.n.forEach(vt)}}let oi;function ii(r){oi=r}function Yl(){if(!oi)throw new Error("Function called outside component initialization");return oi}function Xl(r){Yl().$$.on_mount.push(r)}const yo=[],Gr=[];let So=[];const Jr=[],Zl=Promise.resolve();let ba=!1;function Ql(){ba||(ba=!0,Zl.then(Kr))}function wa(r){So.push(r)}const va=new Set;let Eo=0;function Kr(){if(Eo!==0)return;const r=oi;do{try{for(;Eo<yo.length;){const l=yo[Eo];Eo++,ii(l),ec(l.$$)}}catch(l){throw yo.length=0,Eo=0,l}for(ii(null),yo.length=0,Eo=0;Gr.length;)Gr.pop()();for(let l=0;l<So.length;l+=1){const h=So[l];va.has(h)||(va.add(h),h())}So.length=0}while(yo.length);for(;Jr.length;)Jr.pop()();ba=!1,va.clear(),ii(r)}function ec(r){if(r.fragment!==null){r.update(),ni(r.before_update);const l=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,l),r.after_update.forEach(wa)}}function tc(r){const l=[],h=[];So.forEach(A=>r.indexOf(A)===-1?l.push(A):h.push(A)),h.forEach(A=>A()),So=l}const $i=new Set;let nc;function Ri(r,l){r&&r.i&&($i.delete(r),r.i(l))}function ya(r,l,h,A){if(r&&r.o){if($i.has(r))return;$i.add(r),nc.c.push(()=>{$i.delete(r)}),r.o(l)}}function Sa(r){r&&r.c()}function Oi(r,l,h){const{fragment:A,after_update:_}=r.$$;A&&A.m(l,h),wa(()=>{const W=r.$$.on_mount.map(to).filter(jr);r.$$.on_destroy?r.$$.on_destroy.push(...W):ni(W),r.$$.on_mount=[]}),_.forEach(wa)}function Pi(r,l){const h=r.$$;h.fragment!==null&&(tc(h.after_update),ni(h.on_destroy),h.fragment&&h.fragment.d(l),h.on_destroy=h.fragment=null,h.ctx=[])}function oc(r,l){r.$$.dirty[0]===-1&&(yo.push(r),Ql(),r.$$.dirty.fill(0)),r.$$.dirty[l/31|0]|=1<<l%31}function Vi(r,l,h,A,_,W,Z=null,z=[-1]){const ne=oi;ii(r);const C=r.$$={fragment:null,ctx:[],props:W,update:Nt,not_equal:_,bound:Wr(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(l.context||(ne?ne.$$.context:[])),callbacks:Wr(),dirty:z,skip_bound:!1,root:l.target||ne.$$.root};Z&&Z(C.root);let se=!1;if(C.ctx=h?h(r,l.props||{},(j,re,...Ne)=>{const ot=Ne.length?Ne[0]:re;return C.ctx&&_(C.ctx[j],C.ctx[j]=ot)&&(!C.skip_bound&&C.bound[j]&&C.bound[j](ot),se&&oc(r,j)),re}):[],C.update(),se=!0,ni(C.before_update),C.fragment=A?A(C.ctx):!1,l.target){if(l.hydrate){const j=Jl(l.target);C.fragment&&C.fragment.l(j),j.forEach(vt)}else C.fragment&&C.fragment.c();l.intro&&Ri(r.$$.fragment),Oi(r,l.target,l.anchor),Kr()}ii(ne)}class Di{constructor(){eo(this,"$$");eo(this,"$$set")}$destroy(){Pi(this,1),this.$destroy=Nt}$on(l,h){if(!jr(h))return Nt;const A=this.$$.callbacks[l]||(this.$$.callbacks[l]=[]);return A.push(h),()=>{const _=A.indexOf(h);_!==-1&&A.splice(_,1)}}$set(l){this.$$set&&!Wl(l)&&(this.$$.skip_bound=!0,this.$$set(l),this.$$.skip_bound=!1)}}const ic="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(ic);const qr="blockscape:apicurioConfig",Ea="http://localhost:8080/apis/registry/v3",Ui="bs",Yr="-series",ka=!1,Ia=!1;function ac({models:r,getActiveIndex:l,setActive:h,ensureModelMetadata:A,ensureSeriesId:_,getModelId:W,getSeriesId:Z,getModelTitle:z,computeJsonFingerprint:ne,uid:C}){let se=null,j=null,re=null,Ne=null,ot=null,Xe=null,ze=null,Ge=null,F=null,q=null;const ve=new Set,$={baseUrl:Ea,groupId:Ui,authToken:"",enabled:ka,useSemver:Ia},ke=new Map,Pe=new Map;function ce(d){return(d||"").toString().trim().replace(/\/+$/,"")}function lt(d){return`${(d||"").toString().trim()||Ui}${Yr}`}function le(){return!!($.baseUrl&&$.groupId)}function he(){return $.enabled!==!1}function pt(){ve.forEach(d=>{try{d(he())}catch(y){console.warn("[Blockscape] failed to run Apicurio enabled listener",y)}})}function R(d){return typeof d=="function"&&ve.add(d),()=>ve.delete(d)}function X(){re&&(re.value=$.baseUrl||""),Ne&&(Ne.value=$.groupId||""),ot&&(ot.value=$.authToken||""),Xe&&(Xe.checked=he()),ze&&(ze.checked=!!$.useSemver)}function I(d="",y="muted"){Ge&&(Ge.textContent=d||"",Ge.classList.remove("is-error","is-success"),y==="error"?Ge.classList.add("is-error"):y==="success"&&Ge.classList.add("is-success"))}function Q(d){if(!q||(q.innerHTML="",!d))return;const y=document.createElement("p");y.className="apicurio-hint",y.textContent=d,q.appendChild(y)}function ye(d){ke.clear(),Pe.clear(),Q(d)}function ge(){const d=l(),y=he(),N=le(),M=d>=0?r[d]:null,E=!!(M!=null&&M.apicurioVersions&&M.apicurioVersions.length>1);if(se){const D=se.dataset.loading==="true",Y=y&&N&&d>=0&&!!$e(r[d]);se.disabled=!y||D||!Y,y?D||(se.textContent="Push to Apicurio"):se.textContent="Enable Apicurio to push"}if(F){const D=F.dataset.loading==="true",Y=y&&N&&E&&!!$e(M);F.disabled=!Y||D,F.hidden=!E,y?D||(F.textContent="Push series"):F.textContent="Enable Apicurio to push series"}if(j){const D=j.dataset.loading==="true",Y=y&&N;j.disabled=!Y||D,D||(y?N?j.textContent="List artifacts":j.textContent="Enter details to list":j.textContent="Enable Apicurio to list")}}function Se(){X(),he()?le()?(I("Apicurio push is ready when a model is selected.","muted"),ke.size||Q("Click “List artifacts” to browse the current group.")):(I("Enter Apicurio connection details to enable push.","muted"),ye("Enter registry details to browse artifacts.")):(I("Apicurio integration is off. Enable it to allow pushes.","muted"),ye("Apicurio integration is disabled.")),ge()}function Be(){if(window!=null&&window.localStorage)try{localStorage.setItem(qr,JSON.stringify($))}catch(d){console.warn("[Blockscape] unable to persist Apicurio settings",d)}}function b(){let d={};if(window!=null&&window.localStorage)try{const D=localStorage.getItem(qr);if(D){const Y=JSON.parse(D);Y&&typeof Y=="object"&&(d=Y)}}catch(D){console.warn("[Blockscape] failed to restore Apicurio settings",D)}const y=ce(d.baseUrl??Ea),N=(d.groupId??Ui).toString().trim();let M=ka,E=Ia;typeof d.enabled=="boolean"?M=d.enabled:typeof d.enabled=="string"&&(M=d.enabled==="true"),typeof d.useSemver=="boolean"?E=d.useSemver:typeof d.useSemver=="string"&&(E=d.useSemver==="true"),$.baseUrl=y||Ea,$.groupId=N||Ui,$.authToken=(d.authToken??"").toString().trim(),$.enabled=M,$.useSemver=E,Se(),pt()}function Le(){const d={Accept:"application/json"},y=($.authToken||"").trim();return y&&(d.Authorization=/\s/.test(y)?y:`Bearer ${y}`),d}function tt(d,y,{title:N,description:M,version:E}={}){const D={artifactId:d,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:y},metadata:{properties:{}}}};E&&(D.firstVersion.version=E),N&&(D.name=N),M&&(D.description=M);try{const Y=JSON.parse(y),J=Y==null?void 0:Y.seriesId;J&&typeof J=="string"&&(D.firstVersion.metadata.properties.seriesId=J)}catch{}return D}function it(d,{version:y}={}){const N={content:{contentType:"application/json",content:d},metadata:{properties:{}}};try{const M=JSON.parse(d),E=M==null?void 0:M.seriesId;E&&typeof E=="string"&&(N.metadata.properties.seriesId=E)}catch{}return y&&(N.version=y),N}function We(d){if(d==null)return null;const y=String(d).trim();if(!y)return null;const N=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(y);if(N)return{major:Number(N[1]),minor:Number(N[2]),patch:Number(N[3])};const M=/^v?(\d+)$/.exec(y);return M?{major:Number(M[1]),minor:0,patch:0}:null}function rt(d){return`${d.major}.${d.minor}.${d.patch}`}function Mt(d,y){return!d&&!y?0:d?y?d.major!==y.major?d.major-y.major:d.minor!==y.minor?d.minor-y.minor:d.patch-y.patch:1:-1}function mt(d=[]){let y=null;if(d.forEach(M=>{const E=We((M==null?void 0:M.version)??M);E&&(!y||Mt(E,y)>0)&&(y=E)}),!y)return"1.0.0";const N={...y,patch:y.patch+1};return rt(N)}function $e(d,{seriesName:y,fallbackTitle:N}={}){var D;if(!d)return null;const M=y||d.title||d.apicurioArtifactName||z(d),E=N||M;if(typeof _=="function"&&(d.isSeries||((D=d.apicurioVersions)==null?void 0:D.length)>1)&&_(d,{seriesName:M,fallbackTitle:E}),typeof Z=="function"){const Y=Z(d,{seriesName:M,fallbackTitle:E});if(Y)return Y}return W(d)}function ct(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.artifacts)?d.artifacts:Array.isArray(d==null?void 0:d.items)?d.items:Array.isArray(d==null?void 0:d.results)?d.results:[]}function Bt(d){return Array.isArray(d)?d:Array.isArray(d==null?void 0:d.versions)?d.versions:Array.isArray(d==null?void 0:d.items)?d.items:[]}function Ie(d=[]){if(!Array.isArray(d)||!d.length)return null;const y=[...d].filter(Boolean);return y.sort((N,M)=>{const E=N!=null&&N.createdOn?new Date(N.createdOn).getTime():0,D=M!=null&&M.createdOn?new Date(M.createdOn).getTime():0;if(E!==D)return D-E;const Y=Number(N==null?void 0:N.version),J=Number(M==null?void 0:M.version),fe=Number.isFinite(Y),be=Number.isFinite(J);if(fe&&be&&Y!==J)return J-Y;const Ee=String((N==null?void 0:N.version)??"");return String((M==null?void 0:M.version)??"").localeCompare(Ee,void 0,{numeric:!0})}),y[0]||null}function Qe(d){if(!d)return d;let y=d;if(!Array.isArray(d==null?void 0:d.categories)){const M=d==null?void 0:d.content;if(typeof M=="string")try{y=JSON.parse(M)}catch(E){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",E)}else M&&typeof M=="object"&&(y=M)}return y}async function p(d,y,N){const M=encodeURIComponent(y),E=encodeURIComponent(N),D=`${d}/groups/${M}/artifacts/${E}`,Y=Le();Y.Accept="application/json";const J=await fetch(D,{method:"GET",headers:Y});if(!J.ok){let fe=J.statusText||"Unknown error";try{const be=await J.text();be&&(fe=be.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${J.status}): ${fe}`)}return J.json()}async function w(d,y,N){const M=encodeURIComponent(y),E=encodeURIComponent(N),D=`${d}/groups/${M}/artifacts/${E}/versions?limit=50&order=desc`,Y=Le();Y.Accept="application/json";const J=await fetch(D,{method:"GET",headers:Y});if(!J.ok){let be=J.statusText||"Unknown error";try{const Ee=await J.text();Ee&&(be=Ee.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${J.status}): ${be}`)}const fe=await J.json();return Bt(fe).filter(be=>be&&be.version!=null)}async function ht(d,y,N,M="latest"){const E=encodeURIComponent(y),D=encodeURIComponent(N),Y=encodeURIComponent(M||"latest"),J=`${d}/groups/${E}/artifacts/${D}/versions/${Y}/content`,fe=Le();fe.Accept="application/json, application/*+json, */*;q=0.8";const be=await fetch(J,{method:"GET",headers:fe});if(!be.ok){let nt=be.statusText||"Unknown error";try{const pe=await be.text();pe&&(nt=pe.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${be.status}): ${nt}`)}const Ee=await be.text();let je=null;try{je=JSON.parse(Ee)}catch{throw new Error("Artifact content is not valid JSON.")}return Qe(je)}async function ee(d,y,N,M="latest"){const E=await ht(d,y,N,M);return{data:E,fingerprint:ne(E)}}async function st(d,y,N){try{const E=await w(d,y,N);if(E!=null&&E.length){Pe.set(N,E);const D=Ie(E);if((D==null?void 0:D.version)!=null)return D.version}}catch(E){console.warn("[Blockscape] compare-version: unable to fetch versions list",E)}try{const E=await p(d,y,N);if((E==null?void 0:E.version)!=null)return E.version}catch(E){console.warn("[Blockscape] compare-version: unable to fetch metadata",E)}const M=Pe.get(N);if(M&&M.length){const E=Ie(M);if((E==null?void 0:E.version)!=null)return E.version}return"latest"}async function kn(d,y,N,M){if(!$.useSemver)return null;if(!M)return"1.0.0";try{const E=await w(d,y,N);return mt(E)}catch(E){throw new Error(`Unable to compute next semantic version: ${E.message}`)}}function G(d=document){se=d.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),F=d.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),j=d.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),re=d.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),Ne=d.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),ot=d.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),Xe=d.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),ze=d.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),Ge=d.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),q=d.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function Je(){$.baseUrl=ce((re==null?void 0:re.value)??$.baseUrl),$.groupId=((Ne==null?void 0:Ne.value)??"").trim(),$.authToken=((ot==null?void 0:ot.value)??"").trim(),Be(),Se()}function _t(d){$.enabled=d!==!1,Be(),Se(),pt()}function at(){_t(Xe?Xe.checked:ka)}function Jt(){$.useSemver=ze?ze.checked:Ia,Be(),Se()}function Kn(){[re,Ne,ot].forEach(d=>{d&&d.addEventListener("input",Je)}),se&&se.addEventListener("click",()=>{Kt()}),F&&F.addEventListener("click",()=>{en()}),Xe&&Xe.addEventListener("change",at),ze&&ze.addEventListener("change",Jt),j&&j.addEventListener("click",Ut),q&&q.addEventListener("click",d=>{const y=d.target.closest("[data-artifact-version]");if(y){d.stopPropagation();const E=y.dataset.artifactId,D=y.dataset.artifactVersion;E&&D&&qt(E,D);return}const N=d.target.closest("[data-artifact-load-all]");if(N){d.stopPropagation(),N.dataset.artifactId&&cn();return}const M=d.target.closest("[data-artifact-trigger]");if(M){const E=M.dataset.artifactId;if(!E)return;ao(E)}})}function Dt(){const d=document.createElement("div");return d.className="blockscape-registry-panel",d.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,d}function qn(d){if(!d)return;d.innerHTML="";const y=Dt();d.appendChild(y),G(d),Kn(),Se()}function $t(d){if(!q)return;if(q.innerHTML="",!d.length){Q("No artifacts found in this group.");return}const y=E=>{const D=document.createElement("section");D.className="apicurio-artifact-section";const Y=document.createElement("h3");Y.textContent=E,D.appendChild(Y);const J=document.createElement("ul");return J.className="apicurio-artifact-list",D.appendChild(J),{section:D,list:J}},N=y("Series artifacts"),M=y("Artifacts");d.forEach(E=>{if(!(E!=null&&E.artifactId))return;const Y=E._groupId&&E._groupId.endsWith(Yr)?N.list:M.list,J=document.createElement("li"),fe=document.createElement("button");fe.type="button",fe.className="apicurio-artifact",fe.dataset.artifactId=E.artifactId,fe.dataset.artifactTrigger="toggle";const be=document.createElement("span");be.className="apicurio-artifact-title",be.textContent=E.artifactId,fe.appendChild(be);const Ee=[];if(E.name&&Ee.push(E.name),E.version!=null&&Ee.push(`v${E.version}`),E.type&&Ee.push(E.type),E._groupId&&Ee.push(E._groupId),Ee.length){const pe=document.createElement("span");pe.className="apicurio-artifact-meta",pe.textContent=Ee.join(" • "),fe.appendChild(pe)}if(E.description){const pe=document.createElement("span");pe.className="apicurio-artifact-meta",pe.textContent=E.description,fe.appendChild(pe)}J.appendChild(fe);const je=document.createElement("div");je.className="apicurio-version-list",je.dataset.versionPanel=E.artifactId,je.hidden=!0;const nt=document.createElement("p");nt.className="apicurio-hint",nt.textContent="Click to load the latest or open versions.",je.appendChild(nt),J.appendChild(je),Y.appendChild(J)}),N.list.children.length&&q.appendChild(N.section),M.list.children.length&&q.appendChild(M.section)}function pn(d){return q?q.querySelector(`[data-version-panel="${d}"]`):null}function fn(d,y){if(!d||(d.innerHTML="",!y))return;const N=document.createElement("p");N.className="apicurio-hint",N.textContent=y,d.appendChild(N)}function $n(d,y){const N=pn(d);if(N){if(N.innerHTML="",!y.length){fn(N,"No versions found for this artifact.");return}y.forEach(M=>{const E=document.createElement("button");E.type="button",E.className="apicurio-version-button",E.dataset.artifactId=d,E.dataset.artifactVersion=M.version;const D=[`Version ${M.version}`];if(M.createdOn){const Y=new Date(M.createdOn);isNaN(Y)||D.push(Y.toISOString().slice(0,10))}E.textContent=D.join(" — "),N.appendChild(E)})}}async function ao(d){const y=pn(d);if(!y)return;if(y.dataset.open==="true"){y.hidden=!0,y.dataset.open="false";return}if(y.hidden=!1,y.dataset.open="true",y.dataset.loaded!=="true"){if(!le()){fn(y,"Enter registry details first.");return}fn(y,"Loading versions…");try{const M=ce($.baseUrl),E=ke.get(d),D=$.groupId.trim(),Y=(E==null?void 0:E._groupId)||D,J=await w(M,Y,d);Pe.set(d,J),y.dataset.loaded="true",$n(d,J)}catch(M){console.error("[Blockscape] failed to load versions",M),fn(y,`Unable to fetch versions: ${M.message}`)}}}function sn(d,y){var M;const N=r.findIndex(E=>E.apicurioArtifactId===d);if(N!==-1){const E=r[N].id;r[N]={...y,id:E||y.id},((M=r[N].apicurioVersions)==null?void 0:M.length)>1&&(r[N].isSeries=!0),h(N)}else r.push(y),h(r.length-1)}async function ln(d,y,N,M){const E=encodeURIComponent(y),D=encodeURIComponent(N),Y=`${d}/groups/${E}/artifacts/${D}`;try{const J=await fetch(Y,{method:"GET",headers:M});if(J.status===404)return!1;if(J.ok)return!0;throw J.status===401||J.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${J.status} while checking the artifact.`)}catch(J){throw J instanceof TypeError?new Error("Network error while contacting Apicurio registry."):J}}async function Kt(){var Y;if(!se||se.dataset.loading==="true")return;if(!he()){I("Apicurio integration is off. Enable it first.","error");return}if(!le()){I("Enter the registry base URL and group ID before pushing.","error");return}const d=l();if(d<0||!r[d]){I("No active model to push.","error");return}const y=$e(r[d],{fallbackTitle:z(r[d])});if(!y){I("Active model needs an id before pushing.","error");return}const N=ce($.baseUrl),M=$.groupId.trim(),E=JSON.stringify(r[d].data,null,2),D=Le();se.dataset.loading="true",se.textContent="Pushing…",se.disabled=!0,I("Pushing to Apicurio…","muted");try{const J=await ln(N,M,y,D),fe=ne(r[d].data);if(J)try{const dt=await st(N,M,y),{data:Ft,fingerprint:Wt}=await ee(N,M,y,dt);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",dt),console.log("local fingerprint",fe),console.log("registry fingerprint",Wt),console.log("local payload",r[d].data),console.log("registry payload",Ft),console.groupEnd(),fe&&Wt&&fe===Wt){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){I("Push cancelled (content matches the latest registry version).","muted");return}I("Pushing identical content by user choice.","muted")}else Wt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):I("Unable to compare with registry content (skipping confirmation).","muted")}catch(dt){console.warn("[Blockscape] unable to compare registry content before push",dt),I("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const be=$.useSemver?await kn(N,M,y,J):null;if($.useSemver&&!be)throw new Error("Semantic versioning is enabled but no version could be computed.");const Ee=encodeURIComponent(M),je=encodeURIComponent(y),nt=J?`${N}/groups/${Ee}/artifacts/${je}/versions`:`${N}/groups/${Ee}/artifacts`,pe={...D,"Content-Type":"application/json"};be&&(pe["X-Registry-Version"]=be,I(`Pushing to Apicurio as version ${be}…`,"muted"));const Rt=J?it(E,{version:be}):tt(y,E,{title:z(r[d]),description:(Y=r[d].data)==null?void 0:Y.abstract,version:be}),Ht=await fetch(nt,{method:"POST",headers:pe,body:JSON.stringify(Rt)});if(!Ht.ok){let dt=Ht.statusText||"Unknown error";try{const Ft=await Ht.text();Ft&&(dt=Ft.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Ht.status}): ${dt}`)}let de=null;try{de=await Ht.json()}catch{de=null}const oe=(de==null?void 0:de.version)||(de==null?void 0:de.globalId)||"",ft=J?"Updated":"Created",mn=oe?` (version ${oe})`:"";I(`${ft} ${y}${mn}`,"success")}catch(J){console.error("[Blockscape] Apicurio push failed",J),I(`Apicurio push failed: ${J.message}`,"error")}finally{se.dataset.loading="false",ge()}}async function en(){var be,Ee;if(!F||F.dataset.loading==="true")return;if(!he()){I("Apicurio integration is off. Enable it first.","error");return}if(!le()){I("Enter the registry base URL and group ID before pushing.","error");return}const d=l(),y=d>=0?r[d]:null;if(!y||!y.apicurioVersions||y.apicurioVersions.length<2){I("Series push requires a model with multiple versions.","error");return}const N=$e(y,{seriesName:y.title||y.apicurioArtifactName||z(y)});if(!N){I("Active series needs an id before pushing.","error");return}typeof _=="function"&&_(y,{seriesName:y.title||y.apicurioArtifactName||z(y)});const M=ce($.baseUrl),E=$.groupId.trim(),D=y.apicurioVersions.map(je=>je.data),Y=JSON.stringify(D,null,2),J=Le(),fe=lt(E);F.dataset.loading="true",F.textContent="Pushing…",F.disabled=!0,I("Pushing series to Apicurio…","muted");try{const je=await ln(M,fe,N,J),nt=ne(D);if(je)try{const tn=await st(M,fe,N),{data:An,fingerprint:ro}=await ee(M,fe,N,tn);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",tn),console.log("local fingerprint",nt),console.log("registry fingerprint",ro),console.log("local payload (series)",D),console.log("registry payload",An),console.groupEnd(),nt&&ro&&nt===ro){if(!window.confirm("The current registry version matches this series. Push anyway?")){I("Series push cancelled (content matches latest).","muted");return}I("Pushing identical series by user choice.","muted")}else ro?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):I("Unable to compare with registry content (skipping confirmation).","muted")}catch(tn){console.warn("[Blockscape] unable to compare registry content before series push",tn),I("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const pe=$.useSemver?await kn(M,fe,N,je):null;if($.useSemver&&!pe)throw new Error("Semantic versioning is enabled but no version could be computed.");const Rt=encodeURIComponent(fe),Ht=encodeURIComponent(N),de=je?`${M}/groups/${Rt}/artifacts/${Ht}/versions`:`${M}/groups/${Rt}/artifacts`,oe={...J,"Content-Type":"application/json"};pe&&(oe["X-Registry-Version"]=pe,I(`Pushing series to Apicurio as version ${pe}…`,"muted"));const ft=je?it(Y,{version:pe}):tt(N,Y,{title:y.apicurioArtifactName||((be=y.data)==null?void 0:be.title)||N,description:(Ee=y.data)==null?void 0:Ee.abstract,version:pe}),mn=await fetch(de,{method:"POST",headers:oe,body:JSON.stringify(ft)});if(!mn.ok){let tn=mn.statusText||"Unknown error";try{const An=await mn.text();An&&(tn=An.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${mn.status}): ${tn}`)}let dt=null;try{dt=await mn.json()}catch{dt=null}const Ft=(dt==null?void 0:dt.version)||(dt==null?void 0:dt.globalId)||"",Wt=je?"Updated":"Created",xn=Ft?` (version ${Ft})`:"";I(`${Wt} ${N} series${xn}`,"success")}catch(je){console.error("[Blockscape] Apicurio series push failed",je),I(`Apicurio series push failed: ${je.message}`,"error")}finally{F.dataset.loading="false",ge()}}async function Ut(){if(!j||j.dataset.loading==="true")return;if(!he()){I("Enable Apicurio integration to list artifacts.","error");return}if(!le()){I("Enter registry base URL and group ID before listing.","error");return}const d=ce($.baseUrl),y=$.groupId.trim(),N=lt(y),M=[{groupId:y,label:"base"},{groupId:N,label:"series"}];j.dataset.loading="true",j.textContent="Listing…",j.disabled=!0,I("Listing artifacts…","muted"),Q("Contacting registry…");try{const E=Le();E.Accept="application/json";const D=[];for(const J of M){const fe=encodeURIComponent(J.groupId),be=`${d}/groups/${fe}/artifacts?limit=50&offset=0`,Ee=await fetch(be,{method:"GET",headers:E});if(!Ee.ok){let pe=Ee.statusText||"Unknown error";try{const Rt=await Ee.text();Rt&&(pe=Rt.slice(0,400))}catch{}console.warn(`[Blockscape] failed to list artifacts for group ${J.groupId} (${Ee.status}): ${pe}`);continue}const je=await Ee.json(),nt=ct(je).filter(pe=>pe&&pe.artifactId);nt.forEach(pe=>{pe&&(pe._groupId=J.groupId)}),D.push(...nt)}ke.clear(),Pe.clear(),D.forEach(J=>{J!=null&&J.artifactId&&ke.set(J.artifactId,J)}),$t(D);const Y=D.length;I(Y?`Found ${Y} artifact${Y===1?"":"s"} across base and series groups.`:"No artifacts found in base/series groups.",Y?"success":"muted")}catch(E){console.error("[Blockscape] failed to list artifacts",E),ye("Unable to list artifacts."),I(`Listing failed: ${E.message}`,"error")}finally{j.dataset.loading="false",ge()}}async function qt(d,y=null){var je,nt,pe,Rt,Ht,de;if(!d)return;if(!he()){I("Enable Apicurio integration to load artifacts.","error");return}if(!le()){I("Enter registry connection details before loading artifacts.","error");return}const N=ce($.baseUrl),M=$.groupId.trim(),E=d&&((je=ke.get(d))==null?void 0:je._groupId)||M;let D=ke.get(d);const Y=async()=>{try{const oe=await p(N,E,d);return oe!=null&&oe.artifactId&&ke.set(d,oe),oe}catch(oe){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",oe),oe}};if(!D)try{D=await Y()}catch(oe){I(`Failed to fetch artifact metadata: ${oe.message}`,"error");return}const J=Pe.get(d)||[];let fe="latest",be="latest";if(y)fe=y,be=y;else{if(!D||D.version==null)try{D=await Y()}catch(oe){I(`Failed to fetch artifact metadata: ${oe.message}`,"error");return}fe=(D==null?void 0:D.version)||"latest",be=(D==null?void 0:D.version)||"latest"}const Ee=J.find(oe=>String(oe.version)===String(fe));(Ee==null?void 0:Ee.version)!=null&&(be=Ee.version),I(`Loading artifact ${d}…`,"muted");try{const oe=await ht(N,E,d,fe),ft=ke.get(d)||D||{},mn=Array.isArray(oe);let dt=null;if(mn){const Ft=oe.map((xn,tn)=>(A(xn,{titleHint:ft.name||d,idHint:d}),{version:String(tn+1),data:xn,createdOn:(Ee==null?void 0:Ee.createdOn)||ft.createdOn}));dt={id:C(),title:((pe=(nt=Ft[0])==null?void 0:nt.data)==null?void 0:pe.title)||ft.name||d,data:(Rt=Ft[0])==null?void 0:Rt.data,apicurioArtifactId:d,apicurioArtifactName:ft.name||"",apicurioVersions:Ft,apicurioActiveVersionIndex:0,isSeries:!0};const Wt=((Ht=ft==null?void 0:ft.properties)==null?void 0:Ht.seriesId)||d;typeof _=="function"&&_(dt,{seriesName:Wt,fallbackTitle:Wt}),I(`Loaded series artifact ${d}.`,"success")}else{A(oe,{titleHint:ft.name||d,idHint:d});const Ft={version:be,data:oe,createdOn:(Ee==null?void 0:Ee.createdOn)||ft.createdOn};dt={id:C(),title:oe.title||ft.name||d,data:oe,apicurioArtifactId:d,apicurioArtifactName:ft.name||"",apicurioVersions:[Ft],apicurioActiveVersionIndex:0};const Wt=(de=ft==null?void 0:ft.properties)==null?void 0:de.seriesId;Wt&&typeof _=="function"&&_(dt,{seriesName:Wt,fallbackTitle:Wt});const xn=be?` (version ${be})`:"";I(`Loaded artifact ${d}${xn}.`,"success")}sn(d,dt)}catch(oe){console.error("[Blockscape] failed to load artifact",oe),I(`Failed to load artifact: ${oe.message}`,"error")}}async function cn(d){}return{hydrateConfig:b,mount:qn,updateAvailability:ge,isEnabled:he,setEnabled:_t,onEnabledChange:R}}const Pt={color:{borderMuted:"#e5e7eb",surfaceGhost:"#f8fafc",primary:"#2563eb",dangerStrong:"#b42318",success:"#22c55e",ink:"#111111",white:"#ffffff"},blockscape:{revdep:"#ef4444"},palette:{letter:{A:"#0284c7",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#e879f9",P:"#67e8f9",Q:"#4ade80",R:"#facc15",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"},letterFallback:"#9ca3af"}};function Gn(r,l){if(typeof r!="function")throw new Error(`[itemEditor] expected ${l} to be a function`)}function rc(r){return(r||"item").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"item"}const _a=1,Ca=4;function sc(r){if(r==null)return null;const l=Number(r);if(!Number.isFinite(l))return null;const h=Math.round(l);return h<_a||h>Ca?null:h}function lc(r,{excludeId:l}={}){if(!r)return[];const h=r.split(/[\s,]+/).map(_=>_.trim()).filter(Boolean),A=[];return h.forEach(_=>{l&&_===l||A.includes(_)||A.push(_)}),A}function cc(r,l,h){if(!l||!h||l===h)return;((r==null?void 0:r.categories)||[]).forEach(_=>{(_.items||[]).forEach(W=>{Array.isArray(W.deps)&&(W.deps=W.deps.map(Z=>Z===l?h:Z))})})}function dc({findItemAndCategoryById:r,collectAllItemIds:l,updateItemReferences:h,loadActiveIntoEditor:A,rebuildFromActive:_,select:W,onSelectionRenamed:Z,makeSlug:z=rc,isAutoIdFromNameEnabled:ne=()=>!0}={}){Gn(r,"findItemAndCategoryById"),Gn(l,"collectAllItemIds"),Gn(h,"updateItemReferences"),Gn(A,"loadActiveIntoEditor"),Gn(_,"rebuildFromActive"),Gn(W,"select"),Gn(z,"makeSlug"),Gn(ne,"isAutoIdFromNameEnabled");const C={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null,autoIdManuallyEdited:!1,autoSyncEnabled:!0};function se(F){if(C.fields.errorEl){if(!F){C.fields.errorEl.hidden=!0,C.fields.errorEl.textContent="";return}C.fields.errorEl.hidden=!1,C.fields.errorEl.textContent=F}}function j(){C.wrapper&&(C.wrapper.hidden=!0,C.wrapper.setAttribute("aria-hidden","true"),se(""),C.categoryId=null,C.itemId=null,C.modelData=null,document.body.classList.remove("item-editor-open"))}function re(){C.wrapper&&(C.wrapper.hidden=!1,C.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var F,q;(F=C.fields.nameInput)==null||F.focus(),(q=C.fields.nameInput)==null||q.select()}))}function Ne({force:F}={}){var ve,$;if(!((ve=C.fields)!=null&&ve.idInput)||!(($=C.fields)!=null&&$.nameInput)||!C.autoSyncEnabled||!ne()||!F&&C.autoIdManuallyEdited)return;const q=z(C.fields.nameInput.value||C.itemId||"item");C.fields.idInput.value=q}function ot(F){var pt;if(!C.modelData||!C.categoryId||!C.itemId)throw new Error("No item loaded.");const ve=(((pt=C.modelData)==null?void 0:pt.categories)||[]).find(R=>R.id===C.categoryId);if(!ve)throw new Error("Category not found.");ve.items=ve.items||[];const $=ve.items.find(R=>R.id===C.itemId);if(!$)throw new Error("Item not found.");const ke=(F.id||"").trim();if(!ke)throw new Error("ID is required.");const Pe=l(C.modelData);if(ke!==$.id&&Pe.has(ke))throw new Error("Another item already uses that ID.");$.id=ke;const ce=(F.name||"").trim();$.name=ce||$.id;const lt=(F.logo||"").trim();if(lt?$.logo=lt:delete $.logo,F.externalFlag&&!F.external)$.external=!0;else{const R=(F.external??"").toString().trim();R?$.external=R:delete $.external}const le=(F.color||"").trim();le?$.color=le:delete $.color;const he=sc(F.stage);return he!=null?$.stage=he:delete $.stage,$.deps=Array.isArray(F.deps)?F.deps:[],$.id!==F.originalId&&typeof Z=="function"&&Z(F.originalId,$.id),h(C.modelData,F.originalId,$.id),A(),_(),W($.id),$.id}function Xe(){if(!C.fields||!C.fields.idInput)return!1;const F=(C.fields.idInput.value||"").trim(),q={originalId:C.itemId,id:F,name:C.fields.nameInput.value||"",logo:C.fields.logoInput.value||"",external:C.fields.externalInput.value||"",externalFlag:C.fields.externalFlagInput.checked,color:C.fields.colorInput.value||"",stage:C.fields.stageInput.value,deps:lc(C.fields.depsInput.value,{excludeId:F})};try{return ot(q),j(),!0}catch(ve){return console.warn("[itemEditor] item edit failed",ve),se((ve==null?void 0:ve.message)||"Unable to save item."),!1}}function ze(){if(C.wrapper)return C.wrapper;const F=document.createElement("div");F.className="item-editor-modal",F.hidden=!0,F.setAttribute("role","dialog"),F.setAttribute("aria-modal","true");const q=document.createElement("div");q.className="item-editor-modal__backdrop",F.appendChild(q);const ve=document.createElement("div");ve.className="item-editor",F.appendChild(ve);const $=document.createElement("div");$.className="item-editor__header";const ke=document.createElement("h2");ke.className="item-editor__title",ke.textContent="Edit item";const Pe=document.createElement("button");Pe.type="button",Pe.className="item-editor__close",Pe.setAttribute("aria-label","Close item editor"),Pe.textContent="×",$.appendChild(ke),$.appendChild(Pe),ve.appendChild($);const ce=document.createElement("form");ce.className="item-editor__form",ve.appendChild(ce);const lt=document.createElement("div");lt.className="item-editor__meta",lt.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',ce.appendChild(lt);const le=document.createElement("div");le.className="item-editor__error",le.hidden=!0,ce.appendChild(le);const he=(Ie,Qe,p)=>{const w=document.createElement("label");w.className="item-editor__field";const ht=document.createElement("span");if(ht.className="item-editor__label",ht.textContent=Ie,w.appendChild(ht),Qe.classList.add("item-editor__control"),w.appendChild(Qe),p){const ee=document.createElement("div");ee.className="item-editor__hint",ee.textContent=p,w.appendChild(ee)}return w},pt=document.createElement("input");pt.type="text",pt.required=!0,ce.appendChild(he("ID",pt,"Unique identifier used for dependencies."));const R=document.createElement("input");R.type="text",ce.appendChild(he("Name",R,"Visible label shown on the tile."));const X=document.createElement("input");X.type="url",X.inputMode="url",X.placeholder="https://…",ce.appendChild(he("Logo URL",X,"Optional image URL."));const I=document.createElement("input");I.type="url",I.inputMode="url",I.placeholder="https://…",ce.appendChild(he("External link",I,"Shown with ↗ icon and in preview."));const Q=document.createElement("div");Q.className="item-editor__checkbox";const ye=document.createElement("label");ye.className="item-editor__checkbox-row";const ge=document.createElement("input");ge.type="checkbox";const Se=document.createElement("span");Se.textContent="Mark as external without link";const Be=document.createElement("div");Be.className="item-editor__hint",Be.textContent="Keeps dashed border even without a URL.",ye.appendChild(ge),ye.appendChild(Se),Q.appendChild(ye),Q.appendChild(Be),ce.appendChild(Q);const b=document.createElement("input");b.type="text",b.placeholder=Pt.color.primary,ce.appendChild(he("Color",b,"Optional badge color (hex or CSS color)."));const Le=document.createElement("input");Le.type="number",Le.min=String(_a),Le.max=String(Ca),Le.inputMode="numeric",Le.placeholder=`${_a}-${Ca}`,ce.appendChild(he("Stage",Le,"Optional 1 (far left) to 4 (far right) when Center view is on."));const tt=document.createElement("textarea");tt.rows=2,tt.placeholder="Comma or space separated ids",ce.appendChild(he("Dependencies",tt,"Use item IDs, separated by commas or spaces."));const it=document.createElement("div");it.className="item-editor__checkbox";const We=document.createElement("label");We.className="item-editor__checkbox-row";const rt=document.createElement("input");rt.type="checkbox";const Mt=document.createElement("span");Mt.textContent="Sync ID while editing name";const mt=document.createElement("div");mt.className="item-editor__hint",mt.textContent="Turn off to keep typing names without changing the ID.",We.appendChild(rt),We.appendChild(Mt),it.appendChild(We),it.appendChild(mt),ce.appendChild(it);const $e=document.createElement("div");$e.className="item-editor__actions";const ct=document.createElement("button");ct.type="button",ct.className="pf-v5-c-button pf-m-tertiary",ct.textContent="Cancel";const Bt=document.createElement("button");return Bt.type="submit",Bt.className="pf-v5-c-button pf-m-primary",Bt.textContent="Save",$e.appendChild(ct),$e.appendChild(Bt),ce.appendChild($e),C.wrapper=F,C.fields={idInput:pt,nameInput:R,logoInput:X,externalInput:I,externalFlagInput:ge,colorInput:b,stageInput:Le,depsInput:tt,syncCheckbox:rt,categoryValue:lt.querySelector(".item-editor__meta-value"),errorEl:le},ct.addEventListener("click",j),Pe.addEventListener("click",j),q.addEventListener("click",j),pt.addEventListener("input",()=>{C.autoIdManuallyEdited=!0}),R.addEventListener("input",Ne),rt.addEventListener("change",()=>{C.autoSyncEnabled=!!rt.checked,C.autoSyncEnabled&&(C.autoIdManuallyEdited=!1,Ne({force:!0}))}),ce.addEventListener("submit",Ie=>{Ie.preventDefault(),Xe()}),document.addEventListener("keydown",Ie=>{Ie.key==="Escape"&&!F.hidden&&(Ie.preventDefault(),Ie.stopPropagation(),j())}),document.body.appendChild(F),F}function Ge(F){const q=r(F);if(!q)return!1;ze(),C.categoryId=q.category.id,C.itemId=q.item.id,C.modelData=q.modelData,C.autoIdManuallyEdited=!1;const ve=!!ne();return C.autoSyncEnabled=ve,C.fields.categoryValue.textContent=q.category.title||q.category.id,C.fields.idInput.value=q.item.id||"",C.fields.nameInput.value=q.item.name||"",C.fields.logoInput.value=q.item.logo||"",C.fields.externalInput.value=typeof q.item.external=="string"?q.item.external:"",C.fields.externalFlagInput.checked=q.item.external===!0,C.fields.colorInput.value=q.item.color||"",C.fields.stageInput.value=q.item.stage??"",C.fields.depsInput.value=Array.isArray(q.item.deps)?q.item.deps.join(", "):"",C.fields.syncCheckbox.checked=C.autoSyncEnabled,C.fields.syncCheckbox.disabled=!ve,!C.fields.idInput.value&&ve&&Ne({force:!0}),se(""),W(q.item.id),re(),!0}return{open:Ge,hide:j,isOpen:()=>!!C.wrapper&&!C.wrapper.hidden}}function uc({menuEl:r,previewEl:l,previewTitleEl:h,previewBodyEl:A,previewActionsEl:_,previewCloseEl:W,escapeHtml:Z,onEditItem:z,onChangeColor:ne,selectItem:C,colorPresets:se=[]}={}){const j=r||(()=>{const R=document.createElement("div");return R.className="tile-context-menu",R.hidden=!0,R.setAttribute("aria-hidden","true"),document.body.appendChild(R),R})();let re={x:0,y:0},Ne=0,ot=Array.isArray(se)?se:[];function Xe(){j&&(j.classList.remove("is-open"),j.hidden=!0,j.setAttribute("aria-hidden","true"),j.innerHTML="")}function ze(R=[]){_&&(_.innerHTML="",R.forEach(X=>{const I=document.createElement("button");I.type="button",I.className="item-preview__action",I.textContent=X.label||"Action",X.title&&(I.title=X.title),I.addEventListener("click",Q=>{Q.stopPropagation(),typeof X.onClick=="function"&&X.onClick(Q)}),_.appendChild(I)}),_.hidden=R.length===0)}function Ge(){Xe(),l&&(l.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),l.setAttribute("aria-hidden","true"),l.hidden=!0,ze([]))}function F(R,X){l&&(re={x:R,y:X},l.hidden=!1,l.setAttribute("aria-hidden","false"),l.classList.add("is-visible"),q(R,X))}function q(R,X){if(!l)return;const I=12;l.style.left=`${R+I}px`,l.style.top=`${X+I}px`;const Q=l.getBoundingClientRect();let ye=Q.left,ge=Q.top;Q.right>window.innerWidth-I&&(ye=Math.max(I,window.innerWidth-Q.width-I)),Q.bottom>window.innerHeight-I&&(ge=Math.max(I,window.innerHeight-Q.height-I)),l.style.left=`${ye}px`,l.style.top=`${ge}px`}function ve(R,X){var Se;if(!R)return null;const I=R.dataset.id,Q=((Se=R.querySelector(".name"))==null?void 0:Se.textContent)||I||"Preview",ye=I?`${I}.html`:"",ge=ye?`items/${ye}`:"";return{id:I,displayName:Q,filename:ye,filepath:ge,externalUrl:R.dataset.externalUrl||"",obsidianUrl:R.dataset.obsidianUrl||"",anchorX:(X==null?void 0:X.clientX)??0,anchorY:(X==null?void 0:X.clientY)??0}}function $(R,X){const I=document.createElement("button");return I.type="button",I.className="tile-context-menu__item",I.textContent=R,I.addEventListener("click",()=>{Xe(),typeof X=="function"&&X()}),I}function ke(R){if(!j)return;j.innerHTML="";const X=document.createElement("div");X.className="tile-context-menu__list",X.appendChild($("File view",()=>ce(R))),typeof z=="function"&&X.appendChild($("Edit",()=>z(R.id))),typeof ne=="function"&&R.id&&ot.forEach(I=>{if(!(I!=null&&I.value))return;const Q=I.name||I.value;X.appendChild($(`Set color: ${Q}`,()=>ne(R.id,I.value)))}),j.appendChild(X)}function Pe(R,X){if(!j)return;const I=4;j.style.left=`${R+I}px`,j.style.top=`${X+I}px`,j.hidden=!1,j.setAttribute("aria-hidden","false"),j.classList.add("is-open");const Q=j.getBoundingClientRect();let ye=Q.left,ge=Q.top;Q.right>window.innerWidth-I&&(ye=Math.max(I,window.innerWidth-Q.width-I)),Q.bottom>window.innerHeight-I&&(ge=Math.max(I,window.innerHeight-Q.height-I)),j.style.left=`${ye}px`,j.style.top=`${ge}px`}async function ce(R){if(!l||!h||!A||!R)return;const X=++Ne,I=[];if(typeof z=="function"&&R.id&&I.push({label:"Edit",title:"Edit this item",onClick:()=>{Ge(),z(R.id)}}),R.externalUrl&&I.push({label:"Open link ↗",title:R.externalUrl,onClick:()=>window.open(R.externalUrl,"_blank","noopener")}),R.obsidianUrl&&I.push({label:"Open in Obsidian",title:R.obsidianUrl,onClick:()=>window.open(R.obsidianUrl,"_blank","noopener")}),ze(I),R.id&&typeof C=="function"&&C(R.id),h.textContent=R.displayName,A.innerHTML='<div class="item-preview__status">Loading…</div>',l.classList.remove("item-preview--has-frame"),l.classList.add("item-preview--expanded"),F(R.anchorX,R.anchorY),!R.filepath){A.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',q(re.x,re.y);return}try{const Q=await fetch(R.filepath,{cache:"no-cache"});if(!Q.ok)throw new Error(`HTTP ${Q.status}`);const ye=await Q.text();if(X!==Ne)return;if(!ye.trim()){const Be=Z?Z(R.filename):R.filename;A.innerHTML=`<div class="item-preview__status">No content in <code>${Be}</code>.</div>`,q(re.x,re.y);return}const Se=document.createElement("iframe");Se.className="item-preview__frame",Se.title=`${R.displayName} details`,Se.srcdoc=ye,A.innerHTML="",A.appendChild(Se),l.classList.add("item-preview--has-frame"),q(re.x,re.y)}catch(Q){if(X!==Ne)return;const ye=Z?Z(R.displayName):R.displayName;A.innerHTML=`<div class="item-preview__status">No preview available for <strong>${ye}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${R.filepath}`,Q),q(re.x,re.y)}}function lt(R,X){if(!X)return;R.preventDefault(),R.stopPropagation();const I=ve(X,R);!I||!I.id||(typeof C=="function"&&C(I.id),ke(I),Pe(R.clientX,R.clientY))}function le(R){const X=R==null?void 0:R.target,I=j&&!j.hidden&&j.contains(X),Q=l&&!l.hidden&&l.contains(X);!I&&!Q&&Ge()}function he(){!l||l.hidden||q(re.x,re.y)}function pt(){Ge()}return W&&W.addEventListener("click",Ge),{handleTileContextMenu:lt,hidePreview:Ge,hideMenu:Xe,handleDocumentClick:le,handleWindowResize:he,handleWindowScroll:pt,updateColorPresets:R=>{ot=Array.isArray(R)?R:[]}}}function Xr(r,l="series"){return(r||l).trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||l}function En(r,l="series"){const h=Xr(r,l).replace(/\./g,"-");return h.replace(/-series$/i,"").replace(/-+$/,"")||h||Xr(l,"series")}function Zr(r,{seriesName:l,fallbackTitle:h="unknown"}={}){var z,ne;const _=[r==null?void 0:r.seriesId,(z=r==null?void 0:r.data)==null?void 0:z.seriesId,r==null?void 0:r.apicurioArtifactId,l,r==null?void 0:r.title,r==null?void 0:r.apicurioArtifactName,(ne=r==null?void 0:r.data)==null?void 0:ne.title,h].map(C=>(C??"").toString().trim()),W=_.findIndex(Boolean),Z=W!==-1?_[W]:"";return Z?(console.log("[Series] deriveSeriesId: picked base",{base:Z,sourceIndex:W,candidates:_}),En(Z,h)):(console.log("[Series] deriveSeriesId: no base found; fallback",{fallbackTitle:h}),null)}function Vt(r,{seriesName:l,fallbackTitle:h="unknown"}={}){if(!r||typeof r!="object")return null;const A=Zr(r,{seriesName:l,fallbackTitle:h});return A?(r.seriesId=A,r.apicurioArtifactId||(r.apicurioArtifactId=A),A):null}function Bn(r,l={}){var _,W;if(!r)return null;const h=r.isSeries||((_=r.apicurioVersions)==null?void 0:_.length)>1||r.seriesId||((W=r.data)==null?void 0:W.seriesId)||r.apicurioArtifactId;if(!h&&!l.force)return null;const A=Zr(r,l);return A||(h?En(l.fallbackTitle||"unknown"):null)}const Qr={selectionDimOpacity:.2,selectionDimEnabled:!0},Jn={seriesNavWait:r=>`${(r/1e3).toFixed(1)}s`,hoverScale:r=>`${Math.round((r-1)*100)}%`,selectionDimming:(r,l=!0)=>{const h=Math.round((1-r)*100);return l?h===0?"Off":`${h}% dim`:"Off"},compactness:r=>r===1?"Default":`${Math.round(r*100)}%`,titleWidth:r=>`${Math.round((r-1)*100)}% extra`,titleZoomPortion:r=>`${Math.round(r*100)}% of hover zoom`,autoReloadInterval:r=>`${(r/1e3).toFixed(2)}s`};function io(r){return r===!0||r==="true"||r===1||r==="1"}function pc(r,{localBackend:l}={}){const h=l&&typeof l.getAutoReloadConfig=="function"&&l.getAutoReloadConfig(),A={theme:r.theme,hoverScale:r.hoverScale,selectionDimOpacity:r.selectionDimOpacity,selectionDimEnabled:r.selectionDimEnabled,tileCompactness:r.tileCompactness,titleWrapMode:r.titleWrapMode,titleHoverWidthMultiplier:r.titleHoverWidthMultiplier,titleHoverTextPortion:r.titleHoverTextPortion,obsidianLinksEnabled:r.obsidianLinksEnabled,obsidianLinkMode:r.obsidianLinkMode,obsidianVault:r.obsidianVaultName,autoIdFromName:r.autoIdFromNameEnabled,seriesNavDoubleClickMs:r.seriesNavDoubleClickWaitMs,showSecondaryLinks:r.showSecondaryLinks,centerItems:r.centerItems,showReusedInMap:r.showReusedInMap,colorPresets:r.colorPresets,depColor:r.depColor,revdepColor:r.revdepColor,linkThickness:r.linkThickness};return h&&(A.autoReloadEnabled=!!h.enabled,A.autoReloadIntervalMs=h.intervalMs),A}function fc(r={},l){var ct,Bt,Ie,Qe;if(!r||typeof r!="object")return{applied:[]};const h=[],{applyTheme:A,applyTileHoverScale:_,persistTileHoverScale:W,applySelectionDimEnabled:Z,persistSelectionDimEnabled:z,applySelectionDimOpacity:ne,persistSelectionDimOpacity:C,applyTileCompactness:se,persistTileCompactness:j,applyTitleWrapMode:re,persistTitleWrapMode:Ne,applyTitleHoverWidthMultiplier:ot,persistTitleHoverWidthMultiplier:Xe,applyTitleHoverTextPortion:ze,persistTitleHoverTextPortion:Ge,applyLinkThickness:F,persistLinkThickness:q,applyDepColor:ve,persistDepColor:$,applyRevdepColor:ke,persistRevdepColor:Pe,applyObsidianLinksEnabled:ce,persistObsidianLinksEnabled:lt,applyObsidianLinkMode:le,persistObsidianLinkMode:he,applyObsidianVaultName:pt,persistObsidianVaultName:R,applyAutoIdFromNameEnabled:X,persistAutoIdFromNameEnabled:I,applySeriesNavDoubleClickWait:Q,persistSeriesNavDoubleClickWait:ye,applyCenterItems:ge,persistCenterItems:Se,localBackend:Be,ui:b,refreshObsidianLinks:Le,scheduleOverlaySync:tt,selection:it,select:We,clearStyles:rt,drawLinks:Mt,applyReusedHighlights:mt,current:$e}=l;if(r.theme){const w=((A==null?void 0:A(r.theme))||r.theme)==="dark";(ct=l.ui)!=null&&ct.themeToggle&&(l.ui.themeToggle.checked=w),(Bt=l.ui)!=null&&Bt.tabThemeToggle&&(l.ui.tabThemeToggle.checked=w),h.push("theme")}if(r.hoverScale!=null){const p=_(parseFloat(r.hoverScale));W(p),b!=null&&b.hoverScaleInput&&(b.hoverScaleInput.value=String(p)),b!=null&&b.hoverScaleValue&&(b.hoverScaleValue.textContent=Jn.hoverScale(p)),it&&tt(),h.push("hoverScale")}if(r.selectionDimEnabled!=null){const p=Z(io(r.selectionDimEnabled));z(p),b!=null&&b.selectionDimToggle&&(b.selectionDimToggle.checked=p),b!=null&&b.selectionDimInput&&(b.selectionDimInput.disabled=!p),b!=null&&b.selectionDimValue&&(b.selectionDimValue.textContent=Jn.selectionDimming($e.selectionDimOpacity??Qr.selectionDimOpacity,p)),h.push("selectionDimEnabled")}if(r.selectionDimOpacity!=null){const p=ne(parseFloat(r.selectionDimOpacity));C(p),b!=null&&b.selectionDimInput&&(b.selectionDimInput.value=String(p)),b!=null&&b.selectionDimValue&&(b.selectionDimValue.textContent=Jn.selectionDimming(p,$e.selectionDimEnabled??Qr.selectionDimEnabled)),h.push("selectionDimOpacity")}if(r.tileCompactness!=null){const p=se(parseFloat(r.tileCompactness));j(p),b!=null&&b.tileCompactnessInput&&(b.tileCompactnessInput.value=String(p)),b!=null&&b.tileCompactnessValue&&(b.tileCompactnessValue.textContent=Jn.compactness(p)),it&&tt(),h.push("tileCompactness")}if(r.titleWrapMode){const p=re(r.titleWrapMode);Ne(p),b!=null&&b.titleWrapInput&&(b.titleWrapInput.checked=p!=="nowrap"),h.push("titleWrapMode")}if(r.titleHoverWidthMultiplier!=null){const p=ot(parseFloat(r.titleHoverWidthMultiplier));Xe(p),b!=null&&b.titleWidthInput&&(b.titleWidthInput.value=String(p)),b!=null&&b.titleWidthValue&&(b.titleWidthValue.textContent=Jn.titleWidth(p)),h.push("titleHoverWidthMultiplier")}if(r.titleHoverTextPortion!=null){const p=ze(parseFloat(r.titleHoverTextPortion));Ge(p),b!=null&&b.titleZoomInput&&(b.titleZoomInput.value=String(p)),b!=null&&b.titleZoomValue&&(b.titleZoomValue.textContent=Jn.titleZoomPortion(p)),h.push("titleHoverTextPortion")}if(r.obsidianLinksEnabled!=null){const p=ce(io(r.obsidianLinksEnabled));lt(p),b!=null&&b.obsidianToggle&&(b.obsidianToggle.checked=p),(Ie=b==null?void 0:b.obsidianModeInputs)==null||Ie.forEach(w=>{w.disabled=!p}),b!=null&&b.obsidianVaultInput&&(b.obsidianVaultInput.disabled=!p),Le==null||Le(),h.push("obsidianLinksEnabled")}if(r.obsidianLinkMode){const p=le(r.obsidianLinkMode);he(p),(Qe=b==null?void 0:b.obsidianModeInputs)==null||Qe.forEach(w=>{w.checked=w.value===p}),Le==null||Le(),h.push("obsidianLinkMode")}if(r.obsidianVault!=null){const p=pt(r.obsidianVault);R(p),b!=null&&b.obsidianVaultInput&&(b.obsidianVaultInput.value=p),Le==null||Le(),h.push("obsidianVault")}if(r.colorPresets&&(typeof l.setColorPresets=="function"&&l.setColorPresets(r.colorPresets),h.push("colorPresets")),r.linkThickness){const p=F==null?void 0:F(r.linkThickness);p&&(q==null||q(p),b!=null&&b.linkThicknessInput&&(b.linkThicknessInput.value=p),h.push("linkThickness"))}if(r.depColor){const p=ve==null?void 0:ve(r.depColor);p&&($==null||$(p),b!=null&&b.depColorInput&&(b.depColorInput.value=p),h.push("depColor"))}if(r.revdepColor){const p=ke==null?void 0:ke(r.revdepColor);p&&(Pe==null||Pe(p),b!=null&&b.revdepColorInput&&(b.revdepColorInput.value=p),h.push("revdepColor"))}if(r.autoIdFromName!=null){const p=X(io(r.autoIdFromName));I(p),b!=null&&b.autoIdToggle&&(b.autoIdToggle.checked=p),h.push("autoIdFromName")}if(r.seriesNavDoubleClickMs!=null){const p=Q(parseInt(r.seriesNavDoubleClickMs,10));ye(p),b!=null&&b.seriesNavInput&&(b.seriesNavInput.value=String(p)),b!=null&&b.seriesNavValue&&(b.seriesNavValue.textContent=Jn.seriesNavWait(p)),h.push("seriesNavDoubleClickMs")}if(r.autoReloadEnabled!=null&&Be&&typeof Be.setAutoReloadEnabled=="function"){const p=io(r.autoReloadEnabled);Be.setAutoReloadEnabled(p),b!=null&&b.autoReloadToggle&&(b.autoReloadToggle.checked=p),b!=null&&b.autoReloadInput&&(b.autoReloadInput.disabled=!p),h.push("autoReloadEnabled")}if(r.autoReloadIntervalMs!=null&&Be&&typeof Be.setAutoReloadInterval=="function"){const p=Be.setAutoReloadInterval(parseInt(r.autoReloadIntervalMs,10));b!=null&&b.autoReloadInput&&(b.autoReloadInput.value=String(p)),b!=null&&b.autoReloadValue&&(b.autoReloadValue.textContent=Jn.autoReloadInterval(p)),h.push("autoReloadIntervalMs")}if(r.centerItems!=null){const p=ge==null?void 0:ge(io(r.centerItems));Se==null||Se(p),b!=null&&b.tabCenterToggle&&(b.tabCenterToggle.checked=p),h.push("centerItems")}if(r.showSecondaryLinks!=null){const p=io(r.showSecondaryLinks);typeof l.setShowSecondaryLinks=="function"?l.setShowSecondaryLinks(p):l.showSecondaryLinks=p,b!=null&&b.secondaryLinksToggle&&(b.secondaryLinksToggle.checked=p),b!=null&&b.tabSecondaryLinksToggle&&(b.tabSecondaryLinksToggle.checked=p),it?We(it):(rt(),Mt()),h.push("showSecondaryLinks")}if(r.showReusedInMap!=null){const p=io(r.showReusedInMap);typeof l.setShowReusedInMap=="function"?l.setShowReusedInMap(p):l.showReusedInMap=p,b!=null&&b.reusedToggle&&(b.reusedToggle.checked=p),mt==null||mt(),h.push("showReusedInMap")}return{applied:h}}function mc(r,l){const h=new Blob([l],{type:"application/json"}),A=URL.createObjectURL(h),_=document.createElement("a");_.href=A,_.download=r,_.click(),URL.revokeObjectURL(A)}const Hi=typeof{url:Mn&&Mn.tagName.toUpperCase()==="SCRIPT"&&Mn.src||new URL("blockscape.js",document.baseURI).href}<"u"&&"./"||"";function hc(r={}){console.log("[Blockscape] init");const l={localBackend:!0,fileOpen:!0,fileSave:!0,autoLoadFromDir:!0,showModelMeta:!0,seriesNavMinVersions:1,initialSettings:null,initialSettingsUrl:null,...r},h=document.getElementById("jsonBox"),A=document.querySelector(".blockscape-json-panel"),_=document.getElementById("app"),W=document.getElementById("overlay"),Z=document.getElementById("tabTooltip"),z=document.getElementById("modelList"),ne=document.getElementById("itemPreview"),C=document.getElementById("urlForm"),se=document.getElementById("urlInput"),j=document.getElementById("loadUrl"),re=ne.querySelector(".item-preview__title"),Ne=ne.querySelector(".item-preview__body"),ot=ne.querySelector(".item-preview__actions"),Xe=ne.querySelector(".item-preview__close"),ze=document.getElementById("downloadJson"),Ge=document.getElementById("shareModel"),F=document.getElementById("createVersion"),q=document.getElementById("openInEditor"),ve=document.getElementById("copyJson"),$=document.getElementById("copySeries"),ke=document.getElementById("pasteJson"),Pe=document.getElementById("helpButton"),ce=document.getElementById("newPanelButton"),lt=document.getElementById("newBlankButton"),le=document.getElementById("shortcutHelp"),he=document.getElementById("shortcutHelpList"),pt=document.getElementById("shortcutHelpClose"),R=document.getElementById("shortcutHelpBackdrop"),X=document.getElementById("newPanel"),I=document.getElementById("newPanelClose"),Q=document.getElementById("newPanelBackdrop"),ye=document.getElementById("search"),ge=document.getElementById("searchResults"),Se=document.getElementById("localBackendPanel"),Be=document.getElementById("localBackendStatus"),b=document.getElementById("localFileList"),Le=document.getElementById("localDirSelect"),tt=document.getElementById("refreshLocalFiles"),it=document.getElementById("loadLocalFile"),We=document.getElementById("deleteLocalFile"),rt=document.getElementById("toggleServerSidebar"),Mt=document.getElementById("saveLocalFile"),mt=document.getElementById("saveLocalFileAs"),$e=document.getElementById("localSavePath"),ct="blockscape:editorPayload",Bt="blockscape:editorTransfer",Ie="blockscape:serverSidebarWide",Qe=document.title;Se&&(Se.hidden=!0),!l.localBackend&&Se&&(Se.hidden=!0),l.fileOpen||(it&&(it.hidden=!0),Le&&(Le.hidden=!0),tt&&(tt.hidden=!0),We&&(We.hidden=!0),b&&(b.hidden=!0)),l.fileSave||(Mt&&(Mt.hidden=!0),mt&&(mt.hidden=!0),$e&&($e.hidden=!0)),h.value=document.getElementById("seed").textContent.trim();let p=[],w=-1;const ht=ac({models:p,getActiveIndex:()=>w,setActive:Ct,ensureModelMetadata:Tn,getModelId:wt,getSeriesId:Bn,ensureSeriesId:Vt,getModelTitle:Ke,computeJsonFingerprint:Xi,uid:co});let ee=null,st=new Map,kn=new Map,G=null,Je=null,_t=null,at=null,Jt=!0,Kn=!1,Dt=!1,qn="map",$t=null,pn=null,fn=!1,$n=null;const ao=2e3;let sn=null,ln=null,Kt=null,en=null,Ut=null,qt=null,cn=null,d=null,y=null,N="",M=!1,E=null;const D=new Map;let Y=null,J=null,fe=[],be=null;const Ee=30,je=1e3,nt="blockscape:hoverScale",pe=1.5,Rt=1,Ht=2.5,de="blockscape:selectionDimOpacity",oe="blockscape:selectionDimEnabled",ft=.2,mn=.05,dt=1,Ft="blockscape:titleWrap",Wt="blockscape:titleHoverWidth",xn="blockscape:titleHoverTextPortion",tn="wrap",An=1.3,ro=1,xa=1.6,ai=.25,os=0,is=.6,as="blockscape:tileCompactness",ri=1,rs=.75,ss=1.25,ls="blockscape:obsidianLinksEnabled",cs="blockscape:obsidianLinkMode",ds="blockscape:obsidianVault",Aa="title",Fi="id",Wi=Aa,us="blockscape:autoReloadEnabled",ps="blockscape:autoReloadIntervalMs",si=1e3,fs=500,ms=1e4,hs="blockscape:autoIdFromName",ji=!0,gs="blockscape:colorPresets",bs="blockscape:centerItems",ws="blockscape:theme",vs=4,ko=1,zi=4,ys="0.2rem",Io="light",so="dark",Gi="cat:",Ji=!1,Ss="blockscape:depColor",Es="blockscape:revdepColor",ks="blockscape:linkThickness",Is=6,_s={s:{primary:1.5,secondary:1},m:{primary:3,secondary:2.25},l:{primary:6,secondary:4.5}};let _o=pe,Rn=ft,On=!0,Co=ri,Ta=tn,xo=An,Ao=ai,To=!1,li=Wi,Lo="",lo=ji,ci=Io,Yt=[],bt=Ji,Ki="",qi="",di="m",No=null,La=null;const Cs="blockscape:seriesNavDoubleClickMs",ui=900,xs=300,As=4e3;let Pn=ui;const Te={hoverScaleInput:null,hoverScaleValue:null,selectionDimToggle:null,selectionDimInput:null,selectionDimValue:null,tileCompactnessInput:null,tileCompactnessValue:null,titleWrapInput:null,titleWidthInput:null,titleWidthValue:null,titleZoomInput:null,titleZoomValue:null,seriesNavInput:null,seriesNavValue:null,obsidianToggle:null,obsidianModeInputs:[],obsidianVaultInput:null,autoIdToggle:null,autoReloadToggle:null,autoReloadInput:null,autoReloadValue:null,secondaryLinksToggle:null,reusedToggle:null,themeToggle:null,tabThemeToggle:null,tabSecondaryLinksToggle:null,tabCenterToggle:null,colorPresetList:null,depColorInput:null,revdepColorInput:null,linkThicknessInput:null},Bc={detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1,highlightSource(){},getAutoReloadConfig:()=>({enabled:!1,intervalMs:si}),setAutoReloadEnabled(){},setAutoReloadInterval(){},saveModelByIndex:async()=>!1},qe=l.localBackend?od():Bc,Ts=l.localBackend?qe.detect():Promise.resolve(!1);ht.hydrateConfig(),Ma(Uc()),$o(Kc(),{silent:!0}),Wc(),jc(),Jc(),gd(),bd(),yd(),kd(),Sd(),Ed(),Ad(),Nd(),Ld(),Md(),wd(),vd(),Fc(),Zt();function co(){return Math.random().toString(36).slice(2,10)}function $c(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(o=>{n+=String.fromCharCode(o)}),btoa(n)}function Rc(e){const t=atob(e),n=new Uint8Array(t.length);for(let o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new TextDecoder().decode(n)}function Oc(e){return $c(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Pc(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Rc(t)}const Ls=(e,t)=>mc(e,t);function Na(e){return!e||typeof e!="object"?null:e.settings&&typeof e.settings=="object"?e.settings:e}async function Vc(e){if(!e)return null;const t=Array.isArray(e)?e:[e],n=[];t.forEach(i=>{if(typeof i=="string"&&i.trim()){n.push(i.trim());try{const a=new URL(i,window.location.origin).toString();a!==i.trim()&&n.push(a)}catch{}}});const o=new Set;for(const i of n)if(!o.has(i)){o.add(i);try{const a=await Ll(i),s=JSON.parse(a),c=Na(s);if(c)return c}catch(a){console.warn("[Blockscape] initial settings fetch failed",i,a)}}return null}async function Dc(){const e=typeof refreshObsidianLinks=="function"?refreshObsidianLinks:null,t=[];l.initialSettings&&t.push({type:"inline",snapshot:l.initialSettings}),l.initialSettingsUrl&&t.push({type:"url",url:l.initialSettingsUrl});let n=0;for(const o of t)try{const i=o.type==="inline"?Na(o.snapshot):await Vc(o.url);if(!i)continue;const a=Ha(i,{refreshObsidianLinks:e}),s=(a==null?void 0:a.applied)||[];s.length&&(n+=s.length,console.log(`[Blockscape] applied ${s.length} setting${s.length===1?"":"s"} from ${o.type==="inline"?"inline config":o.url}.`))}catch(i){console.warn("[Blockscape] initial settings apply failed",i)}return n}function Uc(){if(typeof window>"u"||!window.localStorage)return Io;try{return window.localStorage.getItem(ws)===so?so:Io}catch{return Io}}function Hc(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ws,e)}catch(t){console.warn("[Blockscape] theme persistence failed",t)}}function Ma(e){const t=e===so?so:Io;return ci=t,typeof document<"u"&&document.documentElement.setAttribute("data-theme",t),Hc(t),ci}function Ns(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(bs,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist center items",t)}}function Mo(e){return bt=!!e,_&&(_.classList.toggle("is-center-mode",bt),_.querySelectorAll(".grid").forEach(t=>{t.classList.toggle("is-centered",bt)}),_.querySelectorAll(".tile-add").forEach(t=>{t.hidden=bt,t.tabIndex=bt?-1:0,t.setAttribute("aria-hidden",bt?"true":"false")}),_.querySelectorAll(".category-add").forEach(t=>{t.hidden=bt,t.tabIndex=bt?-1:0,t.setAttribute("aria-hidden",bt?"true":"false")})),Bs(),Ms(),ee&&(aa(),In()),bt}function Fc(){if(typeof window>"u"||!window.localStorage)return Mo(Ji);try{const e=window.localStorage.getItem(bs);return e==null?Mo(Ji):Mo(e==="true"||e==="1")}catch(e){return console.warn("[Blockscape] failed to read center items pref",e),Mo(Ji)}}function pi(e){if(e==null)return null;const t=Number(e);if(!Number.isFinite(t))return null;const n=Math.round(t);return n<ko||n>zi?null:n}function Ms(){if(!_)return;const e=`repeat(${vs}, minmax(var(--blockscape-tile), 1fr))`;_.querySelectorAll(".grid").forEach(t=>{const n=Array.from(t.querySelectorAll(".tile[data-stage]")).map((m,S)=>({tile:m,stage:pi(m.dataset.stage),order:S})),o=n.some(m=>m.stage),i=bt&&o;i?(t.style.gridTemplateColumns=e,t.style.gridAutoFlow="row",t.style.justifyContent="space-between",t.style.justifyItems="start",t.style.columnGap=ys,t.style.rowGap=ys):(t.style.removeProperty("grid-template-columns"),t.style.removeProperty("grid-auto-flow"),t.style.removeProperty("justify-content"),t.style.removeProperty("justify-items"),t.style.removeProperty("column-gap"),t.style.removeProperty("row-gap"));const a=m=>{m.style.removeProperty("grid-column"),m.style.removeProperty("grid-row")};if(t.querySelectorAll(".tile").forEach(a),!i)return;const s=n.filter(m=>m.stage).sort((m,S)=>m.stage!==S.stage?m.stage-S.stage:m.order-S.order),c=(m,S,O)=>{if(S.has(m)&&S.get(m)===O)return{col:m,needsNewRow:!0};const T=vs-1;for(let L=0;L<=T;L+=1){const P=[];m-L>=ko&&P.push(m-L),L!==0&&m+L<=zi&&P.push(m+L);for(const te of P)if(!S.has(te))return{col:te,needsNewRow:!1}}return{col:null,needsNewRow:!1}};let u=1,g=new Map;s.forEach(({tile:m,stage:S})=>{let O=c(S,g,S);O.needsNewRow&&(u+=1,g=new Map,O=c(S,g,S)),O.col!=null&&(g.set(O.col,S),m.style.gridColumn=String(O.col),m.style.gridRow=String(u))})}),Bs()}function Bs(){La&&(La.hidden=!bt)}function Bo(e){return typeof window>"u"?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function $s(e,t){typeof document>"u"||document.documentElement.style.setProperty(e,t)}function Ba(e,t){const n=(e||"").toString().trim();return n.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i)?n.length===4?"#"+n.slice(1).split("").map(i=>i+i).join(""):n.toLowerCase():t}function Rs(e,{fallbackVar:t,fallbackColor:n}){const o=(e||"").toString().trim(),i=o.match(/^var\((--[^)]+)\)$/);if(i){const a=Bo(i[1]);if(a)return Ba(a,n);if(t){const s=Bo(t);if(s)return Ba(s,n)}}return Ba(o,n)}function Os(e){if(typeof window>"u"||!window.localStorage)return"";try{return window.localStorage.getItem(e)||""}catch(t){return console.warn("[Blockscape] failed to read stored color",e,t),""}}function $a(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ss,e)}catch(t){console.warn("[Blockscape] failed to persist dep color",t)}}function Ra(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Es,e)}catch(t){console.warn("[Blockscape] failed to persist revdep color",t)}}function Oa(e){const t=Rs(e,{fallbackVar:"--color-primary",fallbackColor:Pt.color.primary});return Ki=t,$s("--blockscape-dep",t),W&&In(),Ki}function Pa(e){const t=Rs(e,{fallbackVar:"--color-danger",fallbackColor:Pt.blockscape.revdep});return qi=t,$s("--blockscape-revdep",t),W&&In(),qi}function Wc(){const e=Os(Ss),t=Oa(e||Bo("--blockscape-dep")||Pt.color.primary);return $a(t),t}function jc(){const e=Os(Es),t=Pa(e||Bo("--blockscape-revdep")||Pt.blockscape.revdep);return Ra(t),t}function zc(e){const t=(e||"").toString().toLowerCase();return t==="s"||t==="l"?t:"m"}function Gc(){return _s[di]||_s.m}function fi(e){return di=zc(e),In(),di}function Va(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ks,e)}catch(t){console.warn("[Blockscape] failed to persist link thickness",t)}}function Jc(){if(typeof window>"u"||!window.localStorage)return fi("m");try{const e=window.localStorage.getItem(ks),t=fi(e||"m");return Va(t),t}catch(e){return console.warn("[Blockscape] failed to read link thickness",e),fi("m")}}function Ps(e){const t=o=>/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(o||"");if(!Array.isArray(e))return mi();const n=e.map(o=>({name:((o==null?void 0:o.name)||"").toString().trim()||"Custom",value:((o==null?void 0:o.value)||"").toString().trim()})).filter(o=>t(o.value));return n.length?n:mi()}function mi(){return[{name:"Black",value:Pt.color.ink},{name:"White",value:Pt.color.white},{name:"Red",value:Pt.blockscape.revdep},{name:"Green",value:Pt.color.success}]}function Kc(){if(typeof window>"u"||!window.localStorage)return mi();try{const e=window.localStorage.getItem(gs);if(!e)return mi();const t=JSON.parse(e);return Ps(t)}catch(e){return console.warn("[Blockscape] failed to load color presets",e),mi()}}function qc(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(gs,JSON.stringify(e))}catch(t){console.warn("[Blockscape] failed to persist color presets",t)}}function $o(e,{silent:t=!1}={}){return Yt=Ps(e),qc(Yt),!t&&typeof Jo=="function"&&Jo(Yt),No==null||No(),Yt}function Yc(){if(typeof window>"u"||!window.location)return!1;const e=new URL(window.location.href),n=e.pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=e.searchParams.get("server");return n[0]&&n[0].toLowerCase()==="server"||o&&["1","true","yes","on"].includes(o.toLowerCase())}function Yi(e,{modelId:t,itemId:n}={}){if(typeof window>"u"||!window.location||!e)return;const o=uo(e);if(!o)return;const i=p[w],a=uo(i==null?void 0:i.sourcePath),s=t??(a&&a===o?wt(i):null),c=n??(a&&a===o?G:null),u=o.split("/").filter(Boolean).map(S=>encodeURIComponent(S)),g=s?encodeURIComponent(s):null,m=c?encodeURIComponent(c):null;try{const S=new URL(window.location.href),O=new URLSearchParams(S.search);O.delete("load"),O.delete("share");const T=["","server",...u,...g?[g]:[],...m?[m]:[]].join("/").replace(/\/+/g,"/");S.pathname=T,S.search=O.toString()?`?${O.toString()}`:"",S.hash="",window.history.replaceState({},document.title,S.toString())}catch(S){console.warn("[Blockscape] failed to update URL for server path",S)}}function Xc(e,{origin:t}={}){if(!(typeof window>"u"||!e))try{window.dispatchEvent(new CustomEvent("blockscape:local-save-path",{detail:{path:e,origin:t}}))}catch(n){console.warn("[Blockscape] failed to notify local save path",n)}}function Zc(){if(typeof window>"u"||!window.location)return null;const n=new URL(window.location.href).pathname.replace(/\/+$/,"").split("/").filter(Boolean),o=n.findIndex(P=>P.toLowerCase()==="server");if(o===-1)return null;const i=n.slice(o+1);if(!i.length)return null;const a=i.findIndex(P=>P.toLowerCase().endsWith(".bs"));if(a===-1)return null;const s=i.slice(0,a+1),c=i.slice(a+1),u=P=>{try{return decodeURIComponent(P)}catch{return P}},g=s.map(u),m=c.map(u),S=g.join("/"),O=uo(S);if(!O)return null;const T=m[0]?m[0].trim():null,L=m[1]?m[1].trim():null;return{path:O,modelId:T||null,itemId:L||null}}function Da({itemId:e}={}){const t=p[w];t!=null&&t.sourcePath&&Yi(t.sourcePath,{modelId:wt(t),itemId:e===void 0?G:e})}function Qc(){return typeof window>"u"||!window.location?!1:(window.location.hostname||"").toLowerCase().endsWith("github.io")}function ed(){if(typeof window>"u"||!window.localStorage)return!0;try{const e=window.localStorage.getItem(Ie);return e==null?!0:e==="true"}catch{return!0}}function td(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ie,e?"true":"false")}catch(t){console.warn("[Blockscape] failed to persist sidebar width",t)}}function Vs(e){var t;typeof document>"u"||((t=document.body)==null||t.classList.toggle("blockscape-server-sidebar-wide",!!e),rt&&(rt.setAttribute("aria-pressed",e?"true":"false"),rt.textContent=e?"<":">",rt.title=e?"Switch to thin menu":"Switch to wide menu"))}function nd(e){if(!rt||(rt.hidden=!e,!e))return;let t=ed();Vs(t),rt.onclick=()=>{t=!t,td(t),Vs(t)}}function od(){var ei;const e=()=>typeof window>"u"||!window.location?{}:{host:window.location.host,path:window.location.pathname,search:window.location.search,hash:window.location.hash};function t(k,U={}){console.log("[Blockscape][local-backend]",k,{...e(),...U})}if(Qc())return t("Disabled on github.io host"),Se&&(Se.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};const n=Yc();if(n&&typeof document<"u"&&((ei=document.body)==null||ei.classList.add("blockscape-server-mode")),nd(n),!n||!Se||!Be)return t("Opt-in flag missing or panel unavailable"),Se&&(Se.hidden=!0),{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};if(!Se||!Be)return{detect:async()=>!1,refresh:async()=>{},updateActiveSavePlaceholder(){},isAvailable:()=>!1};let o=!1,i="",a=[],s=[],c="",u=new Map,g=P(),m=Me(),S=null,O=!1;const T=new Set;function L(){return T.size>0}function P(){if(typeof window>"u"||!window.localStorage)return!0;try{const k=window.localStorage.getItem(us);return k==null?!0:k==="true"}catch{return!0}}function te(k){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(us,k?"true":"false")}catch(U){console.warn("[Blockscape] auto-reload: failed to persist",U)}}function Me(){if(typeof window>"u"||!window.localStorage)return si;try{const k=window.localStorage.getItem(ps);if(!k)return si;const U=parseInt(k,10);return _e(U)}catch{return si}}function ut(k){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ps,String(k))}catch(U){console.warn("[Blockscape] auto-reload: failed to persist interval",U)}}function _e(k){return Number.isFinite(k)?Math.min(ms,Math.max(fs,k)):si}function Ce(k){if(!k)return"";const U=k.split("/").filter(Boolean);return U.pop(),U.join("/")}function Ze(k,{error:U=!1}={}){Be.textContent=k,Be.style.color=U?Pt.color.dangerStrong:"",t("Status",{text:k,error:U})}function Ue(k){return uo(k)}function At(k){const U=ta(k);return U?{payload:U,isSeries:!0}:{payload:k==null?void 0:k.data,isSeries:!1}}function jt(){var U;if(w>=0&&((U=p[w])!=null&&U.sourcePath))return p[w].sourcePath;if(w<0)return"blockscape.bs";const k=Ke(p[w])||"blockscape";return`${En(k,"blockscape")}.bs`}function Tt(){var k;$e&&($e.placeholder=jt(),(k=p[w])!=null&&k.sourcePath&&($e.value=p[w].sourcePath))}function xe(){if(!Le)return;Le.innerHTML="";const k=document.createElement("option");k.value="",k.textContent="Root (~/blockscape)",Le.appendChild(k),s.forEach(ie=>{const we=document.createElement("option");we.value=ie,we.textContent=ie||"(root)",Le.appendChild(we)});const U=s.includes(c)?c:"";Le.value=U,c=U}function Et(){if(!b)return;b.innerHTML="";const k=a.filter(U=>Ce(U.path)===c);if(!k.length){const U=document.createElement("option");U.disabled=!0,U.textContent="No .bs files found yet",b.appendChild(U),b.disabled=!0;return}b.disabled=!1,k.forEach(U=>{const ie=document.createElement("option");ie.value=U.path;const we=U.mtimeMs?new Date(U.mtimeMs).toLocaleString():"";ie.textContent=we?`${U.path} · ${we}`:U.path,b.appendChild(ie)}),i&&Array.from(b.options).forEach(U=>{U.value===i&&(U.selected=!0)}),!b.value&&b.options.length&&(b.options[0].selected=!0)}function _n(k){if(!o||!b||!k||!a.find(et=>et.path===k))return;const ie=Ce(k);ie!==c&&(c=ie,xe()),Et(),Array.from(b.options).forEach(et=>{et.selected=et.value===k});const we=Array.from(b.options).find(et=>et.value===k);we!=null&&we.scrollIntoView&&we.scrollIntoView({block:"nearest"}),$e&&($e.value=k)}function Wn(){S&&(clearInterval(S),S=null)}function kt(){Wn(),!(!o||!g||L())&&(S=setInterval(an,m))}function Ot(k){if(!k)return;const U=T.size;T.add(k),T.size!==U&&(t("Auto-reload paused",{reason:k}),kt())}function nn(k){if(!k)return;T.delete(k)&&(t("Auto-reload resumed",{reason:k}),kt())}async function on(k){const U=p.findIndex(ie=>ie.sourcePath===k);if(U!==-1)try{const ie=await fetch(`/api/file?path=${encodeURIComponent(k)}`,{cache:"no-store"});if(!ie.ok)throw new Error(`HTTP ${ie.status}`);const we=await ie.json(),et=JSON.stringify(we.data??we,null,2),He=Dn(et,k,{seriesTitleOverride:`${k} series`});if(!He.length)return;const ae=He[0];if(ae.sourcePath=k,Tn(ae,{titleHint:Ke(p[U]),idHint:wt(p[U])}),ae.isSeries){const Re=ae.title||Ke(ae)||Ke(p[U]),gt=En(Re||"unknown");po(ae,gt),Vt(ae,{seriesName:Re||"unknown",fallbackTitle:"unknown"})}p[U]={...p[U],...ae,title:ae.title||Ke(ae),data:ae.data,sourcePath:k},U===w?(xt(),St()):Vn(),console.log("[Blockscape] auto-reloaded model from",k)}catch(ie){console.warn("[Blockscape] auto-reload failed for",k,ie)}}async function an(){if(!(!o||!g||L()||O)){O=!0;try{const k=await fetch("/api/files",{cache:"no-store"});if(!k.ok)throw new Error(`HTTP ${k.status}`);const ie=((await k.json()).files||[]).slice().sort((ae,Re)=>{const gt=(ae==null?void 0:ae.mtimeMs)||0,un=(Re==null?void 0:Re.mtimeMs)||0;return gt===un?(ae.path||"").localeCompare(Re.path||""):un-gt}),we=new Map;ie.forEach(ae=>we.set(ae.path,ae.mtimeMs||0));const et=p.map((ae,Re)=>({path:ae.sourcePath,idx:Re})).filter(ae=>ae.path);for(const ae of et){const Re=u.get(ae.path)||0;(we.get(ae.path)||0)>Re&&await on(ae.path)}a=ie;const He=new Set;a.forEach(ae=>He.add(Ce(ae.path))),s=Array.from(He).filter(ae=>ae!=="").sort(),u=we,xe(),Et()}catch(k){console.warn("[Blockscape] auto-reload check failed",k)}finally{O=!1}}}function Ye(k){g=!!k,te(g),kt()}function Zo(k){return m=_e(k),ut(m),kt(),m}function rn(k){o=!1,a=[],u=new Map,Wn(),Et(),Se.hidden=!0,k&&Ze(k,{error:!0}),t("Panel hidden",{message:k})}async function go({silent:k=!1}={}){try{t("Health check start");const U=await fetch("/api/health",{cache:"no-store"});if(!U.ok)throw new Error(`HTTP ${U.status}`);const ie=await U.json();if(o=!!(ie!=null&&ie.ok),!o)throw new Error("Health check failed");return Se.hidden=!1,k||Ze(ie.root?`Local server ready (root: ${ie.root})`:"Local server ready"),t("Health check ok",{payload:ie}),!0}catch(U){return k||console.log("[Blockscape] local backend health failed",U),rn("Local server unavailable"),!1}}async function hn(){if(o&&b){Ze("Loading files…");try{const k=await fetch("/api/files",{cache:"no-store"});if(!k.ok)throw new Error(`HTTP ${k.status}`);a=((await k.json()).files||[]).slice().sort((He,ae)=>{const Re=(He==null?void 0:He.mtimeMs)||0,gt=(ae==null?void 0:ae.mtimeMs)||0;return Re===gt?(He.path||"").localeCompare(ae.path||""):gt-Re});const ie=new Set;a.forEach(He=>{ie.add(Ce(He.path))}),s=Array.from(ie).filter(He=>He!=="").sort(),c&&!ie.has(c)&&(c=""),!c&&i&&(c=Ce(i)),u=new Map(a.map(He=>[He.path,He.mtimeMs||0])),xe(),Et();const we=a.filter(He=>Ce(He.path)===c).length,et=c?`~/blockscape/${c}`:"~/blockscape";Ze(we?`Browsing ${we} file(s) in ${et}`:`No .bs files in ${et} yet`)}catch(k){console.warn("[Blockscape] local backend refresh failed",k),rn("Local server unavailable")}}}async function tr(){o=!1,rn(),Ze("Checking for local server…");try{return t("Detect start"),await go()?(Tt(),await hn(),kt(),!0):!1}catch(k){return o=!1,console.log("[Blockscape] local backend not detected",k),t("Detect failed",{err:k}),!1}}async function yi(){if(!o||!b)return;const k=Array.from(b.selectedOptions||[]).map(ie=>ie.value).filter(Boolean).sort((ie,we)=>ie.localeCompare(we));if(!k.length){alert("Select one or more files to load from ~/blockscape.");return}let U=null;for(const ie of k)try{Ze(`Loading ${ie}…`);const we=await Ds(ie);U==null&&(U=(we==null?void 0:we.firstIndex)??null),i=ie,Yi(ie)}catch(we){console.error("[Blockscape] failed to load from local server",we),alert(`Local load failed for ${ie}: ${we.message}`)}U!=null&&Ct(U),Ze(`Loaded ${k.length} file(s)`),Et()}async function Si(){if(!o||!b)return;const k=Array.from(b.selectedOptions||[]).map(ae=>ae.value).filter(Boolean).sort((ae,Re)=>ae.localeCompare(Re));if(!k.length){alert("Select one or more files to delete from ~/blockscape.");return}const U=k.length,ie=U===1?k[0]:`${U} file(s)`,we=U===1?`Delete "${ie}" from ~/blockscape? This cannot be undone.`:`Delete ${ie} from ~/blockscape? This cannot be undone.`;if(!window.confirm(we))return;const et="local-files-delete";Ot(et);const He=[];try{Ze(`Deleting ${ie}…`);for(const ae of k)try{const Re=await fetch(`/api/file?path=${encodeURIComponent(ae)}`,{method:"DELETE"});if(!Re.ok)throw new Error(`HTTP ${Re.status}`);ae===i&&(i=""),($e==null?void 0:$e.value)===ae&&($e.value="")}catch(Re){He.push(ae),console.warn("[Blockscape] local delete failed",ae,Re)}await hn(),He.length?Ze(`Deleted ${U-He.length} file(s), ${He.length} failed`,{error:!0}):Ze(`Deleted ${U} file(s)`)}finally{nn(et)}}async function Qo(k,{statusPrefix:U="Saved to",updateInput:ie=!0}={}){if(!o)return;if(w<0){alert("No active model to save.");return}const we=p[w],{payload:et,isSeries:He}=At(we);if(!et){alert("No model data to save.");return}const ae=Ue(k);if(!ae){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}try{const Re=JSON.stringify(et,null,2);Ze(`Saving ${He?"series":"map"} to ${ae}…`);const un=await fetch(`/api/file?path=${encodeURIComponent(ae)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:Re});if(!un.ok)throw new Error(`HTTP ${un.status}`);const Qt=await un.json();i=Qt.path||ae,we.sourcePath=Qt.path||ae,ie&&$e&&($e.value=Qt.path||ae),Yi(Qt.path||ae),Ze(`${U} ${Qt.path||ae}`),await hn()}catch(Re){console.error("[Blockscape] local save failed",Re),alert(`Local save failed: ${Re.message}`),rn("Local server unavailable")}}async function Ei(){var U;const k=Ue($e==null?void 0:$e.value)||Ue((U=p[w])==null?void 0:U.sourcePath)||jt();if(!k){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Qo(k,{statusPrefix:"Saved to"})}async function Yn(){var we;if(!o)return;if(w<0){alert("No active model to save.");return}if(typeof window>"u"||typeof window.prompt!="function")return;const k=Ue((we=p[w])==null?void 0:we.sourcePath)||jt(),U=window.prompt("Save active map as (under ~/blockscape):",k);if(U==null)return;const ie=Ue(U);if(!ie){alert("Enter a relative path (no ..) to save under ~/blockscape.");return}await Qo(ie,{statusPrefix:"Saved to"})}async function ki(k,U,{refreshAfter:ie=!0,statusPrefix:we="Saved to"}={}){if(!o)return{ok:!1,error:"Local server unavailable"};if(!Number.isInteger(k)||k<0)return{ok:!1,error:"Invalid model index"};const et=p[k],{payload:He,isSeries:ae}=At(et);if(!He)return{ok:!1,error:"Model has no data"};const Re=Ue(U)||Ue(et==null?void 0:et.sourcePath)||jt();if(!Re)return{ok:!1,error:"Enter a relative path (no ..) to save under ~/blockscape."};try{const gt=JSON.stringify(He,null,2);Ze(`Saving ${ae?"series":"map"} to ${Re}…`);const Qt=await fetch(`/api/file?path=${encodeURIComponent(Re)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:gt});if(!Qt.ok)throw new Error(`HTTP ${Qt.status}`);const jn=await Qt.json();return i=jn.path||Re,et.sourcePath=jn.path||Re,k===w&&Tt(),Ze(`${we} ${jn.path||Re}`),ie&&await hn(),{ok:!0,path:jn.path||Re}}catch(gt){return console.error("[Blockscape] local save failed",gt),rn("Local server unavailable"),{ok:!1,error:gt.message}}}if(tt&&(tt.onclick=()=>hn()),it&&(it.onclick=()=>yi()),We&&(We.onclick=()=>Si()),Mt&&(Mt.onclick=()=>Ei()),mt&&(mt.onclick=()=>Yn()),b&&$e&&(b.addEventListener("change",()=>{const k=Array.from(b.selectedOptions||[])[0];k!=null&&k.value&&($e.value=k.value)}),b.addEventListener("dblclick",()=>{yi()})),Le&&Le.addEventListener("change",()=>{c=Le.value||"",Et()}),Se){const k="local-files-panel-focus",U="local-files-panel-pointer";let ie=!1,we=!1;Se.addEventListener("focusin",()=>{ie||(ie=!0,Ot(k))}),Se.addEventListener("focusout",et=>{if(!ie)return;const He=et.relatedTarget;He&&Se.contains(He)||(ie=!1,nn(k))}),Se.addEventListener("pointerenter",()=>{we||(we=!0,Ot(U))}),Se.addEventListener("pointerleave",()=>{we&&(we=!1,nn(U))})}return{detect:tr,refresh:hn,updateActiveSavePlaceholder:Tt,isAvailable:()=>o,highlightSource:_n,saveModelByIndex:ki,getAutoReloadConfig:()=>({enabled:g,intervalMs:m,available:o}),setAutoReloadEnabled:Ye,setAutoReloadInterval:Zo}}async function Ds(e,{labelBase:t=e,seriesTitleOverride:n}={}){if(!e)throw new Error("Missing path");const o=await fetch(`/api/file?path=${encodeURIComponent(e)}`,{cache:"no-store"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json(),a=JSON.stringify(i.data??i,null,2),s=Dn(a,e,{seriesTitleOverride:n||`${e} series`});if(!s.length)throw new Error("No models found in file");let c=null;return s.forEach((u,g)=>{if(u.sourcePath=e,u.isSeries&&!u.title){const O=(e.split("/").filter(Boolean).pop()||e).replace(/\.bs$/i,"");u.title=O}const m=Ln(u,{versionLabel:s.length>1?`${t} #${g+1}`:t});c==null&&(c=m)}),{firstIndex:c,total:s.length}}async function Us(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function id(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Xt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function uo(e){const t=(e||"").trim().replace(/\\/g,"/").replace(/^\/+/,"");return!t||t.includes("..")?null:t.toLowerCase().endsWith(".bs")?t:`${t}.bs`}function ad(e){return((e||"").split("/").filter(Boolean).pop()||"").replace(/\.bs$/i,"").trim()}function rd(e,t){const n=uo(e);if(!n)return null;const o=n.split("/"),s=`${(o.pop()||n).replace(/\.bs$/i,"")}-${t}.bs`;return[...o,s].filter(Boolean).join("/")}function Ua(){const e=new Date,t=n=>String(n).padStart(2,"0");return`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}-${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`}async function hi(){try{await Ts}catch{}return typeof(qe==null?void 0:qe.isAvailable)=="function"?qe.isAvailable():!1}async function sd(){try{const e=await fetch("/api/files",{cache:"no-store"});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return new Set((t.files||[]).map(n=>n.path).filter(Boolean))}catch(e){return console.warn("[Blockscape] failed to list existing local files",e),new Set}}function ld(e,t){const n=uo(e);if(!n)return null;if(!(t!=null&&t.has(n)))return n;const o=n.split("/"),a=(o.pop()||n).replace(/\.bs$/i,"");for(let s=2;s<1e3;s++){const c=`${a}-${s}.bs`,u=[...o,c].filter(Boolean).join("/");if(!t.has(u))return u}return null}function cd(e,t="clipboard"){const n=Ke(e)||(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||t||"blockscape",o=Xt(n),i=Ua();return`${o}-${i}.bs`}function dd(e,t){if(!(e!=null&&e.isSeries)||!Array.isArray(e==null?void 0:e.apicurioVersions)||e.apicurioVersions.length<=1)return!1;const n=ad(t);if(!n)return!1;e.title=n,e.apicurioArtifactName=n;const o=En(n||"unknown");return po(e,o),Vt(e,{seriesName:n,fallbackTitle:n}),!0}function ud(e){return Number.isFinite(e)?Math.min(Ht,Math.max(Rt,e)):pe}function Zt(){if(!_)return;const e=!!G||!!Je;_.classList.toggle("blockscape-has-selection",e),_.classList.toggle("blockscape-has-item-selection",!!G)}function Ro(e){return _o=ud(e),document.documentElement.style.setProperty("--blockscape-tile-hover-scale",_o),_o}function pd(e){return Number.isFinite(e)?Math.min(dt,Math.max(mn,e)):ft}function Oo(e){Rn=pd(e),document.documentElement.style.setProperty("--blockscape-selection-dim-opacity",Rn);const t=On?Rn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),Rn}function fd(e){return Number.isFinite(e)?Math.min(ss,Math.max(rs,e)):ri}function Po(e){return Co=fd(e),document.documentElement.style.setProperty("--blockscape-tile-compactness",Co),Co}function md(e){return Number.isFinite(e)?Math.min(xa,Math.max(ro,e)):An}function Vo(e){return xo=md(e),document.documentElement.style.setProperty("--blockscape-title-hover-width-multiplier",xo),xo}function hd(e){return Number.isFinite(e)?Math.min(is,Math.max(os,e)):ai}function Do(e){return Ao=hd(e),document.documentElement.style.setProperty("--blockscape-tile-hover-text-portion",Ao),Ao}function Uo(e){const t=e==="nowrap"?"nowrap":"wrap";Ta=t;const n=t==="nowrap"?"nowrap":"normal",o=t==="nowrap"?"nowrap":"normal";return document.documentElement.style.setProperty("--blockscape-title-white-space",n),document.documentElement.style.setProperty("--blockscape-title-text-wrap",o),t}function Hs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(nt,String(e))}catch(t){console.warn("[Blockscape] failed to persist hover scale",t)}}function gd(){if(typeof window>"u"||!window.localStorage)return Ro(pe);try{const e=window.localStorage.getItem(nt);if(!e)return Ro(pe);const t=parseFloat(e);return Ro(t)}catch(e){return console.warn("[Blockscape] failed to read hover scale",e),Ro(pe)}}function Fs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(de,String(e))}catch(t){console.warn("[Blockscape] failed to persist selection dimming",t)}}function bd(){if(typeof window>"u"||!window.localStorage)return Oo(ft);try{const e=window.localStorage.getItem(de);if(!e)return Oo(ft);const t=parseFloat(e);return Oo(t)}catch(e){return console.warn("[Blockscape] failed to read selection dimming",e),Oo(ft)}}function Ho(e){On=!!e;const t=On?Rn:1;return document.documentElement.style.setProperty("--blockscape-selection-dim-applied-opacity",t),_&&_.classList.toggle("blockscape-dimming-disabled",!On),On}function Ws(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(oe,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist selection dim toggle",t)}}function wd(){if(typeof window>"u"||!window.localStorage)return Ho(!0);try{const e=window.localStorage.getItem(oe);return e==null?Ho(!0):Ho(e==="1")}catch(e){return console.warn("[Blockscape] failed to read selection dim toggle",e),Ho(!0)}}function Fo(e){return lo=!!e,lo}function js(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(hs,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist auto-id toggle",t)}}function vd(){if(typeof window>"u"||!window.localStorage)return Fo(ji);try{const e=window.localStorage.getItem(hs);return e==null?Fo(ji):Fo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read auto-id toggle",e),Fo(ji)}}function zs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(as,String(e))}catch(t){console.warn("[Blockscape] failed to persist tile compactness",t)}}function yd(){if(typeof window>"u"||!window.localStorage)return Po(ri);try{const e=window.localStorage.getItem(as);if(!e)return Po(ri);const t=parseFloat(e);return Po(t)}catch(e){return console.warn("[Blockscape] failed to read tile compactness",e),Po(ri)}}function Gs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Wt,String(e))}catch(t){console.warn("[Blockscape] failed to persist title hover width",t)}}function Sd(){if(typeof window>"u"||!window.localStorage)return Vo(An);try{const e=window.localStorage.getItem(Wt);if(!e)return Vo(An);const t=parseFloat(e);return Vo(t)}catch(e){return console.warn("[Blockscape] failed to read title hover width",e),Vo(An)}}function Js(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(xn,String(e))}catch(t){console.warn("[Blockscape] failed to persist title text zoom",t)}}function Ed(){if(typeof window>"u"||!window.localStorage)return Do(ai);try{const e=window.localStorage.getItem(xn);if(!e)return Do(ai);const t=parseFloat(e);return Do(t)}catch(e){return console.warn("[Blockscape] failed to read title text zoom",e),Do(ai)}}function Ks(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Ft,e)}catch(t){console.warn("[Blockscape] failed to persist title wrap mode",t)}}function kd(){if(typeof window>"u"||!window.localStorage)return Uo(tn);try{const e=window.localStorage.getItem(Ft);return Uo(e||tn)}catch(e){return console.warn("[Blockscape] failed to read title wrap mode",e),Uo(tn)}}function Id(e){return Number.isFinite(e)?Math.min(As,Math.max(xs,e)):ui}function Wo(e){return Pn=Id(e),Pn}function _d(e){Jt=!!e}function Cd(e){Dt=!!e}function qs(){return{hoverScale:_o,selectionDimOpacity:Rn,selectionDimEnabled:On,tileCompactness:Co,titleWrapMode:Ta,titleHoverWidthMultiplier:xo,titleHoverTextPortion:Ao,obsidianLinksEnabled:To,obsidianLinkMode:li,obsidianVaultName:Lo,autoIdFromNameEnabled:lo,seriesNavDoubleClickWaitMs:Pn,showSecondaryLinks:Jt,centerItems:bt,showReusedInMap:Dt,theme:ci,colorPresets:Yt,depColor:Ki,revdepColor:qi,linkThickness:di}}function Ha(e,{refreshObsidianLinks:t}={}){return fc(e,{applyTileHoverScale:Ro,persistTileHoverScale:Hs,applySelectionDimEnabled:Ho,persistSelectionDimEnabled:Ws,applySelectionDimOpacity:Oo,persistSelectionDimOpacity:Fs,applyTileCompactness:Po,persistTileCompactness:zs,applyTitleWrapMode:Uo,persistTitleWrapMode:Ks,applyTitleHoverWidthMultiplier:Vo,persistTitleHoverWidthMultiplier:Gs,applyTitleHoverTextPortion:Do,persistTitleHoverTextPortion:Js,applyObsidianLinksEnabled:zo,persistObsidianLinksEnabled:Qs,applyObsidianLinkMode:jo,persistObsidianLinkMode:Zs,applyObsidianVaultName:Go,persistObsidianVaultName:el,applyAutoIdFromNameEnabled:Fo,persistAutoIdFromNameEnabled:js,applySeriesNavDoubleClickWait:Wo,persistSeriesNavDoubleClickWait:Xs,localBackend:qe,ui:Te,refreshObsidianLinks:t,scheduleOverlaySync:qo,selection:G,select:yt,clearStyles:sa,drawLinks:In,applyReusedHighlights:Qa,setShowSecondaryLinks:_d,setShowReusedInMap:Cd,applyDepColor:Oa,persistDepColor:$a,applyRevdepColor:Pa,persistRevdepColor:Ra,applyLinkThickness:fi,persistLinkThickness:Va,applyTheme:Ma,setColorPresets:$o,applyCenterItems:Mo,persistCenterItems:Ns,current:qs()})}const Ys=()=>({version:1,exportedAt:new Date().toISOString(),settings:pc(qs(),{localBackend:qe})}),xd=e=>{const t=Na(e);return Ha(t||{})};typeof window<"u"&&(window.__blockscapeSettingsBridge={exportPayload:Ys,applyPayload:xd});function Xs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(Cs,String(e))}catch(t){console.warn("[Blockscape] failed to persist series double-click wait",t)}}function Ad(){if(typeof window>"u"||!window.localStorage)return Wo(ui);try{const e=window.localStorage.getItem(Cs);if(!e)return Wo(ui);const t=parseInt(e,10);return Wo(t)}catch(e){return console.warn("[Blockscape] failed to read series double-click wait",e),Wo(ui)}}function Td(e){return e===Fi?Fi:Aa}function jo(e){return li=Td(e),li}function Zs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(cs,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian link mode",t)}}function Ld(){if(typeof window>"u"||!window.localStorage)return jo(Wi);try{const e=window.localStorage.getItem(cs);return jo(e||Wi)}catch(e){return console.warn("[Blockscape] failed to read Obsidian link mode",e),jo(Wi)}}function zo(e){return To=!!e,To}function Qs(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ls,e?"1":"0")}catch(t){console.warn("[Blockscape] failed to persist Obsidian toggle",t)}}function Nd(){if(typeof window>"u"||!window.localStorage)return zo(!1);try{const e=window.localStorage.getItem(ls);return e==null?zo(!1):zo(e==="1")}catch(e){return console.warn("[Blockscape] failed to read Obsidian toggle",e),zo(!1)}}function Go(e){return Lo=(e??"").toString().trim(),Lo}function el(e){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(ds,e)}catch(t){console.warn("[Blockscape] failed to persist Obsidian vault",t)}}function Md(){if(typeof window>"u"||!window.localStorage)return Go("");try{const e=window.localStorage.getItem(ds);return Go(e||"")}catch(e){return console.warn("[Blockscape] failed to read Obsidian vault",e),Go("")}}function Bd(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function $d(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const o=n.find(a=>a&&typeof a=="object")||n[0];return((o==null?void 0:o.title)??"").toString().trim()||`${t} series`}function po(e,t){!t||!e||typeof e!="object"||(e.seriesId=t,e.apicurioArtifactId=t,e.id=t,e.data&&typeof e.data=="object"&&(e.data.seriesId=t),Array.isArray(e.apicurioVersions)&&e.apicurioVersions.forEach(n=>{n!=null&&n.data&&typeof n.data=="object"&&(n.data.seriesId=t)}))}function Rd(e){if(!e||typeof window>"u"||typeof window.prompt!="function")return!1;const t=(e.title??e.apicurioArtifactName??"").toString().trim()||Zi(e,"Series"),n=window.prompt("Series name",t);if(n==null)return!1;const o=n.trim();if(!o)return!1;const i=Bn(e,{seriesName:o,fallbackTitle:o})||En(o,o),a=window.prompt("Series ID (used for linking and downloads)",i);if(a==null)return!1;const s=En(a.trim()||o,o||"series");return e.title=o,e.apicurioArtifactName=o,po(e,s),!0}function Fa(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>Fa(o)).join(",")}]`:`{${Object.keys(e).sort().map(o=>`${JSON.stringify(o)}:${Fa(e[o])}`).join(",")}}`}function tl(e){try{return Fa(e)}catch{return""}}function Xi(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=tl(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=tl(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const Od=[{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Move up/down through items, pausing on category headers before entering the next category at the same relative position."},{keys:[["Cmd/Ctrl","Arrow Up"],["Cmd/Ctrl","Arrow Down"]],description:"Reorder the selected category (or the category that holds the selected item)."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category (cycles item.stage in Center view)."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Cmd/Ctrl","Arrow Left"],["Cmd/Ctrl","Arrow Right"]],description:"Switch to the previous or next map when viewing a series."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile or category."},{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["F2"]],description:"Edit the selected item; when a category (not an item) is selected, open the category editor."},{keys:[["Delete"]],description:"Delete the selected item or category (use Cmd/Ctrl+Z to undo)."},{keys:[["Insert"]],description:"Add a new category at the bottom of the map."},{keys:[["Escape"]],description:"Unselect item or close the open preview popover."}];function Tn(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const o=(e.title??"").toString().trim();e.title=o||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",s=Xt(a).replace(/\./g,"-");e.id=s||`model-${co()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function Pd(e){var s,c;const t=u=>{const g=(u??"").toString().trim();if(!g)return{base:"",suffix:null};const m=g.match(/^(.*?)-(\d+)$/);return{base:m?m[1]:g,suffix:m?Number.parseInt(m[2],10):null}},n=Array.isArray(e==null?void 0:e.apicurioVersions)?e.apicurioVersions:[],o=(((s=e==null?void 0:e.data)==null?void 0:s.id)??"").toString().trim();let i=t(o).base;if(!i)for(const u of n){if(u!=null&&u.isCategoryView)continue;const g=t(((c=u==null?void 0:u.data)==null?void 0:c.id)??(u==null?void 0:u.id)??"");if(g.base){i=g.base;break}}i||(i=Xt(Bn(e)||Wa(e)||Ke(e,"model")));let a=0;return n.forEach(u=>{var m;if(u!=null&&u.isCategoryView)return;const g=t(((m=u==null?void 0:u.data)==null?void 0:m.id)??(u==null?void 0:u.id)??"");g.base===i&&Number.isFinite(g.suffix)&&g.suffix>a&&(a=g.suffix)}),`${i}-${String(a+1).padStart(2,"0")}`}function Vd(e){return JSON.parse(JSON.stringify(e))}function Ke(e,t="Untitled Model"){var o;return e&&(((o=e.data)==null?void 0:o.title)??e.title??"").toString().trim()||t}function Zi(e,t="Untitled Model"){var o;if(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries)){const i=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(i)return i;const a=wt(e);return a?`${a} series`:t}return Ke(e,t)}function wt(e){var i;const t=Bn(e);if(t)return t;const n=(i=e==null?void 0:e.data)==null?void 0:i.id;return n&&n.toString().trim()||null}function Wa(e){if(!(e!=null&&e.sourcePath))return null;try{const t=e.sourcePath.split("/").filter(Boolean);return(t.length?t[t.length-1]:e.sourcePath).replace(/\.bs$/i,"")}catch{return e.sourcePath.replace(/\.bs$/i,"")}}function Dd(e){return e?e.toString().replace(/-series$/i,""):null}function ja(e){if(!e)return-1;const t=e.toString().trim().toLowerCase();if(!t)return-1;for(let n=0;n<p.length;n++){const o=(wt(p[n])||"").toLowerCase(),i=(Wa(p[n])||"").toLowerCase();if(t===o||t===i)return n}return-1}function nl(e){var c;if(e<0||e>=p.length||!h)return!0;const t=p[e],n=(h.value||"").trim();if(!n)return!0;let o;try{o=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Tn(o,{titleHint:Ke(t),idHint:wt(t)});const i=Xi(t.data),a=Xi(o);if(i===a)return!0;t.data=o;const s=Un(t);return s>=0&&((c=t.apicurioVersions)!=null&&c[s])&&(t.apicurioVersions[s].data=o),!0}function ol(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(o=>{o!=null&&o.id&&t.add(o.id)})),t}function Qi(e){if(w<0||!e)return null;const t=p[w].data,n=(t==null?void 0:t.categories)||[];for(const o of n){const a=(o.items||[]).find(s=>s.id===e);if(a)return{category:o,item:a,modelData:t}}return null}function Ud(e,t){const n=Qi(e);return n?(t?n.item.color=t:delete n.item.color,xt(),St(),yt(e),!0):!1}function Hd(e){if(w<0||!e)return!1;const t=p[w].data,o=((t==null?void 0:t.categories)||[]).find(a=>a.id===e);if(!o)return!1;let i=!1;return(o.items||[]).forEach(a=>{pi(a.stage)!=null&&(delete a.stage,i=!0)}),i?(xt(),St(),G&&yt(G),!0):!1}function Fd(e,t){if(!e||!t||w<0)return!1;const n=Qi(e);if(!n)return!1;const o=pi(n.item.stage),i=o??(t>0?ko:zi),a=zi-ko+1,s=((i-ko+t)%a+a)%a,c=ko+s;return n.item.stage=c,xt(),St(),yt(e),!0}function Wd(e,t){const n=ol(t);let o=Xt(e||"item");if(!n.has(o))return o;const i=()=>co().slice(0,4);for(;n.has(o);)o=`${Xt(e||"item")}-${i()}`;return o}function jd(e="category",t){const n=(t==null?void 0:t.categories)||[],o=Xt(e||"category"),i=c=>n.some(u=>u.id===c);let a=o||`category-${co()}`;if(!i(a))return a;let s=n.length+1;for(;i(`${o}-${s}`);)s+=1;return`${o}-${s}`}const fo=dc({findItemAndCategoryById:Qi,collectAllItemIds:ol,updateItemReferences:cc,loadActiveIntoEditor:xt,rebuildFromActive:St,select:e=>yt(e),onSelectionRenamed:(e,t)=>{var n;G===e&&(G=t,Zt()),((n=$t==null?void 0:$t.item)==null?void 0:n.id)===e&&($t.item.id=t)},makeSlug:Xt,isAutoIdFromNameEnabled:()=>lo});function zd({getActiveModelData:e,loadActiveIntoEditor:t,rebuildFromActive:n,selectCategory:o,onCategoryRenamed:i}){const a={wrapper:null,fields:{},categoryId:null,modelData:null,idManuallyEdited:!1,autoSyncEnabled:!0},s=L=>{if(a.fields.errorEl){if(!L){a.fields.errorEl.hidden=!0,a.fields.errorEl.textContent="";return}a.fields.errorEl.hidden=!1,a.fields.errorEl.textContent=L}},c=()=>{a.wrapper&&(a.wrapper.hidden=!0,a.wrapper.setAttribute("aria-hidden","true"),s(""),a.categoryId=null,a.modelData=null,document.body.classList.remove("category-editor-open"))},u=()=>{a.wrapper&&(a.wrapper.hidden=!1,a.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("category-editor-open"),requestAnimationFrame(()=>{var L,P;(L=a.fields.titleInput)==null||L.focus(),(P=a.fields.titleInput)==null||P.select()}))},g=({force:L}={})=>{var te,Me;if(!lo||!a.autoSyncEnabled||!((te=a.fields)!=null&&te.idInput)||!((Me=a.fields)!=null&&Me.titleInput)||!L&&a.idManuallyEdited)return;const P=Xt(a.fields.titleInput.value||a.categoryId||"category");a.fields.idInput.value=P},m=()=>{if(!a.modelData||!a.categoryId)throw new Error("No category loaded.");const L=a.modelData.categories||[],P=L.find(Ce=>Ce.id===a.categoryId);if(!P)throw new Error("Category not found.");const te=(a.fields.idInput.value||"").trim();if(!te)throw new Error("ID is required.");const Me=(a.fields.titleInput.value||"").trim();if(L.some(Ce=>Ce.id===te&&Ce.id!==P.id))throw new Error("Another category already uses that ID.");const _e=P.id;return P.id=te,P.title=Me||P.id,_e!==te&&typeof i=="function"&&i(_e,te),t(),n(),o(te,{scrollIntoView:!0}),!0},S=()=>{try{return m(),c(),!0}catch(L){return console.warn("[CategoryEditor] save failed",L),s((L==null?void 0:L.message)||"Unable to save category."),!1}},O=()=>{if(a.wrapper)return a.wrapper;const L=document.createElement("div");L.className="item-editor-modal category-editor-modal",L.hidden=!0,L.setAttribute("role","dialog"),L.setAttribute("aria-modal","true");const P=document.createElement("div");P.className="item-editor-modal__backdrop",L.appendChild(P);const te=document.createElement("div");te.className="item-editor",L.appendChild(te);const Me=document.createElement("div");Me.className="item-editor__header";const ut=document.createElement("h2");ut.className="item-editor__title",ut.textContent="Edit category";const _e=document.createElement("button");_e.type="button",_e.className="item-editor__close",_e.setAttribute("aria-label","Close category editor"),_e.textContent="×",Me.appendChild(ut),Me.appendChild(_e),te.appendChild(Me);const Ce=document.createElement("form");Ce.className="item-editor__form",te.appendChild(Ce);const Ze=document.createElement("div");Ze.className="item-editor__meta",Ze.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',Ce.appendChild(Ze);const Ue=document.createElement("div");Ue.className="item-editor__error",Ue.hidden=!0,Ce.appendChild(Ue);const At=(an,Ye,Zo)=>{const rn=document.createElement("label");rn.className="item-editor__field";const go=document.createElement("span");if(go.className="item-editor__label",go.textContent=an,rn.appendChild(go),Ye.classList.add("item-editor__control"),rn.appendChild(Ye),Zo){const hn=document.createElement("div");hn.className="item-editor__hint",hn.textContent=Zo,rn.appendChild(hn)}return rn},jt=document.createElement("input");jt.type="text",Ce.appendChild(At("Title",jt,"Display label shown in the map."));const Tt=document.createElement("input");Tt.type="text",Tt.required=!0,Ce.appendChild(At("ID",Tt,"Unique identifier for this category (used in URLs and references)."));const xe=document.createElement("div");xe.className="item-editor__checkbox";const Et=document.createElement("label");Et.className="item-editor__checkbox-row";const _n=document.createElement("input");_n.type="checkbox";const Wn=document.createElement("span");Wn.textContent="Sync ID while editing title";const kt=document.createElement("div");kt.className="item-editor__hint",kt.textContent="Turn off to keep typing titles without changing the ID.",Et.append(_n,Wn),xe.append(Et,kt),Ce.appendChild(xe);const Ot=document.createElement("div");Ot.className="item-editor__actions";const nn=document.createElement("button");nn.type="submit",nn.className="item-editor__action item-editor__action--primary",nn.textContent="Save";const on=document.createElement("button");return on.type="button",on.className="item-editor__action",on.textContent="Cancel",Ot.appendChild(nn),Ot.appendChild(on),Ce.appendChild(Ot),Ce.addEventListener("submit",an=>{an.preventDefault(),S()}),on.addEventListener("click",c),_e.addEventListener("click",c),P.addEventListener("click",c),Tt.addEventListener("input",()=>{a.idManuallyEdited=!0}),jt.addEventListener("input",()=>g()),_n.addEventListener("change",()=>{a.autoSyncEnabled=!!_n.checked,a.autoSyncEnabled&&(a.idManuallyEdited=!1,g({force:!0}))}),L.addEventListener("keydown",an=>{an.key==="Escape"&&(an.preventDefault(),c())}),document.body.appendChild(L),a.wrapper=L,a.fields={titleInput:jt,idInput:Tt,errorEl:Ue,metaLabel:Ze.querySelector(".item-editor__meta-value"),syncCheckbox:_n},L};return{open:L=>{if(!L||!O())return!1;const te=e(),ut=((te==null?void 0:te.categories)||[]).find(Ce=>Ce.id===L);if(!ut)return!1;a.categoryId=ut.id,a.modelData=te,a.idManuallyEdited=!1;const _e=!!lo;return a.autoSyncEnabled=_e,a.fields.metaLabel.textContent=ut.title||ut.id||"Category",a.fields.titleInput.value=ut.title||ut.id||"",a.fields.idInput.value=ut.id||"",a.fields.syncCheckbox.checked=a.autoSyncEnabled,a.fields.syncCheckbox.disabled=!_e,!a.fields.idInput.value&&_e&&g({force:!0}),s(""),u(),!0},hide:c,isOpen:()=>!!a.wrapper&&a.wrapper.hidden===!1}}const Gd=zd({getActiveModelData:()=>{var e;return(e=p[w])==null?void 0:e.data},loadActiveIntoEditor:xt,rebuildFromActive:St,selectCategory:(e,t={})=>Hn(e,t),onCategoryRenamed:(e,t)=>{Je===e&&(Je=t,Zt())}}),{handleTileContextMenu:Jd,hidePreview:mo,handleDocumentClick:Kd,handleWindowResize:qd,handleWindowScroll:Yd,updateColorPresets:Jo}=uc({menuEl:document.getElementById("tileContextMenu"),previewEl:ne,previewTitleEl:re,previewBodyEl:Ne,previewActionsEl:ot,previewCloseEl:Xe,escapeHtml:wi,onEditItem:e=>fo.open(e),onChangeColor:(e,t)=>Ud(e,t),selectItem:e=>yt(e),colorPresets:Yt});function ea(e,{versionLabel:t="1",createdOn:n}={}){if(!e)return e;if(Array.isArray(e.apicurioVersions)&&e.apicurioVersions.length)return e.apicurioActiveVersionIndex==null&&(e.apicurioActiveVersionIndex=0),!e.data&&e.apicurioVersions[e.apicurioActiveVersionIndex]&&(e.data=e.apicurioVersions[e.apicurioActiveVersionIndex].data),e;const o={version:t,data:e.data,createdOn:n||new Date().toISOString()};e.apicurioVersions=[o],e.apicurioActiveVersionIndex=0;const i=e.title||Ke(e);return Vt(e,{seriesName:i,fallbackTitle:i}),e.isSeries=!0,e}function Xd({seriesId:e=null,mapTitle:t="Blank map"}={}){const n=Xt(`${e||"blank"}-${Ua()}`),o={id:n,title:t,categories:[],abstract:""};return e&&(o.seriesId=e),Tn(o,{titleHint:t,idHint:n}),o}function Zd(){const t=`Blank series ${Ua()}`,n=En(t,"blank-series"),o=Xd({seriesId:n,mapTitle:"Blank map"}),i={id:n,title:t,apicurioArtifactName:t,data:o,apicurioVersions:[{version:"1",data:o,createdOn:new Date().toISOString()}],apicurioActiveVersionIndex:0,isSeries:!0};return po(i,n),Vt(i,{seriesName:t,fallbackTitle:t}),i}function Qd(){const e=Zd(),t=Ln(e,{versionLabel:"blank"});return Ct(t),na(),dn("Blank series created. Add categories and tiles to start.",2600),t}function Ln(e,{versionLabel:t,createdOn:n}={}){var u,g,m;if(e!=null&&e.isSeries||((u=e==null?void 0:e.apicurioVersions)==null?void 0:u.length)>1){const S=e.title||Ke(e);Vt(e,{seriesName:S,fallbackTitle:S}),oa(e)}const o=wt(e);if(!o)return ea(e,{versionLabel:t||"1",createdOn:n}),p.push(e),p.length-1;const i=p.findIndex(S=>wt(S)===o);if(i===-1)return ea(e,{versionLabel:t||"1",createdOn:n}),p.push(e),p.length-1;const a=p[i];if(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length){a.apicurioVersions=[{version:"1",data:a.data,createdOn:(m=(g=a.apicurioVersions)==null?void 0:g[0])==null?void 0:m.createdOn}],a.apicurioActiveVersionIndex=0;const S=a.title||Ke(a);Vt(a,{seriesName:S,fallbackTitle:S})}const s=String(a.apicurioVersions.length+1);a.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=Ke(e)||a.title,a.isSeries=!0;const c=a.title||Ke(a);return Vt(a,{seriesName:c,fallbackTitle:c}),i}function il({versionLabel:e}={}){var c;if(w<0||!p[w])throw new Error("Load or select a model before creating a version.");const t=p[w];ea(t,{versionLabel:"1"});const n=Pd(t);let o;try{o=Vd(t.data)}catch(u){throw console.warn("[Blockscape] failed to clone active model for versioning",u),new Error("Could not copy the current model.")}n&&(o.id=n),Tn(o,{titleHint:Ke(t),idHint:wt(t)||Bn(t)});const a={version:e||String((((c=t.apicurioVersions)==null?void 0:c.length)||0)+1),data:o,createdOn:new Date().toISOString()};t.apicurioVersions.push(a),t.apicurioActiveVersionIndex=t.apicurioVersions.length-1,t.data=o,t.isSeries=!0;const s=t.title||Ke(t);return Vt(t,{seriesName:s,fallbackTitle:s}),w}function za(){const e=w>=0&&p[w]?p[w]:null,t=wt(e);document.title=t?`${t}-blockscape`:Qe}function ta(e){if(!e)return null;oa(e);const t=e.apicurioVersions;if(!Array.isArray(t)||t.length<=1)return null;const n=e.title||e.apicurioArtifactName||Ke(e);return Vt(e,{seriesName:n,fallbackTitle:n}),t.filter((i,a)=>{var u;const s=((i==null?void 0:i.version)??"").toString().trim(),c=(((u=i==null?void 0:i.data)==null?void 0:u.id)??(i==null?void 0:i.id)??"").toString().trim();return i!=null&&i.isCategoryView||s.startsWith(Gi)?(console.log("[Blockscape] not saving computed map",{versionIndex:a,versionId:s,dataId:c}),!1):!0}).map(i=>i&&typeof i=="object"&&"data"in i?i.data:i)}function eu(){const e=p[w],t=ta(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function al(e="shortcut",t=!1){const n=h.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const o=p[w],i=t?ta(o):null,a=!!i,s=a?JSON.stringify(i,null,2):n,c=Bn(o),u=wt(o),g=c||u||Ke(o,"blockscape"),m=a?"-series":"",S=`${Xt(g)}${m}.bs`;return Ls(S,s),console.log(`[Blockscape] saved JSON (${e}):`,S),!0}const tu=Pt.palette.letter,nu=Pt.palette.letterFallback;function rl(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return tu[n]||nu}function ou(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,o=parseInt(n,16),i=o>>16&255,a=o>>8&255,s=o&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?Pt.color.ink:Pt.color.white}function iu(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function Ga(){if(Ut)return;Ut=document.createElement("div"),Ut.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",qt=document.createElement("span"),qt.className="series-nav-notice__text",Ut.appendChild(e),Ut.appendChild(qt),document.body.appendChild(Ut)}function Ja(){cn&&(clearTimeout(cn),cn=null),Ut&&Ut.classList.remove("is-visible"),qt&&(qt.textContent="")}function Ko(){sn=null,ln&&(clearTimeout(ln),ln=null),Ja()}function Ka(){Kt=null,en&&(clearTimeout(en),en=null),Ja()}function au(e,t){var o;if(!((o=e==null?void 0:e.apicurioVersions)!=null&&o[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function ru(e,t,n){Ga(),sn={id:e,targetVersionIndex:t},ln&&clearTimeout(ln),ln=setTimeout(()=>{ln=null,Ko()},Pn);const o=au(n,t);dn(`Click again to open ${o} in this series.`,Pn)}function su(e,t){Ga(),Kt={id:e,targetIndex:t},en&&clearTimeout(en),en=setTimeout(()=>{en=null,Ka()},Pn);const n=Zi(p[t]);dn(`Click again to open "${n}".`,Pn)}function dn(e,t=ao,n=null){if(Ga(),qt.textContent="",qt.appendChild(document.createTextNode(e)),n){const o=document.createTextNode(" "),i=document.createElement("a");i.href=n,i.target="_blank",i.rel="noopener",i.textContent=n,qt.appendChild(o),qt.appendChild(i)}Ut.classList.add("is-visible"),cn&&clearTimeout(cn),cn=setTimeout(()=>Ja(),t)}function lu(){he&&(he.innerHTML="",Od.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((i,a)=>{if(a>0){const c=document.createElement("span");c.className="shortcut-help__or",c.textContent="or",n.appendChild(c)}const s=document.createElement("div");s.className="shortcut-help__combo",i.forEach((c,u)=>{if(u>0){const m=document.createElement("span");m.className="shortcut-help__sep",m.textContent="+",s.appendChild(m)}const g=document.createElement("kbd");g.className="shortcut-help__key",g.textContent=c,s.appendChild(g)}),n.appendChild(s)});const o=document.createElement("div");o.className="shortcut-help__desc",o.textContent=e.description,t.appendChild(n),t.appendChild(o),he.appendChild(t)}),fn=!0)}function cu(){return!!le&&le.hidden===!1}function du(){if(!le)return;fn||lu(),$n=document.activeElement,le.hidden=!1,le.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=le.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function qa(){if(!le||le.hidden)return;le.hidden=!0,le.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=$n;e!=null&&e.focus?e.focus({preventScroll:!0}):Pe!=null&&Pe.focus&&Pe.focus({preventScroll:!0})}function uu(){if(!X)return;X.hidden=!1,X.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=X.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function na(){!X||X.hidden||(X.hidden=!0,X.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open"),ce!=null&&ce.focus&&ce.focus({preventScroll:!0}))}let Ya=!1;function qo(){Ya||(Ya=!0,requestAnimationFrame(()=>{Ya=!1,aa(),In()}))}let sl=!1;function ll(e){return(e||"").toString().toLowerCase().split(/\s+/).map(t=>t.trim()).filter(Boolean)}function pu(e){const t=ll(e);if(!t.length){_.querySelectorAll(".tile").forEach(n=>{n.style.opacity=""});return}_.querySelectorAll(".tile").forEach(n=>{var s;const o=(((s=n.querySelector(".name"))==null?void 0:s.textContent)||"").toLowerCase(),i=(n.dataset.id||"").toLowerCase(),a=t.every(c=>o.includes(c)||i.includes(c));n.style.opacity=a?"1":"0.2"})}function fu(e){const t=ll(e);if(!t.length)return[];const n=[];return p.forEach((o,i)=>{var g;const a=Zi(o),s=wt(o)||"",c=`${a} ${s}`.toLowerCase();t.every(m=>c.includes(m))&&n.push({type:"model",modelIndex:i,modelTitle:a,modelId:s}),(Array.isArray((g=o.data)==null?void 0:g.categories)?o.data.categories:[]).forEach(m=>{const S=(m.title||m.id||"").toString();(m.items||[]).forEach(O=>{const T=(O.name||O.id||"").toString(),L=`${T} ${O.id||""} ${S}`.toLowerCase();t.every(P=>L.includes(P))&&n.push({type:"item",modelIndex:i,modelTitle:a,modelId:s,itemId:O.id,itemName:T,categoryTitle:S})})})}),n.slice(0,Ee)}function cl(e){if(!ge)return;ge.innerHTML="";const t=(e||"").toString();if(!t.trim()){ge.hidden=!0;return}if(!p.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="Load models to search",ge.appendChild(o),ge.hidden=!1;return}const n=fu(t);if(!n.length){const o=document.createElement("div");o.className="search-results__empty",o.textContent="No matches yet",ge.appendChild(o),ge.hidden=!1;return}n.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="search-result",i.dataset.modelIndex=String(o.modelIndex),o.itemId&&(i.dataset.itemId=o.itemId),o.type&&(i.dataset.type=o.type),o.modelIndex===w&&(!o.itemId||G===o.itemId)&&i.classList.add("is-active");const a=document.createElement("div");a.className="search-result__primary";const s=document.createElement("span");s.textContent=o.type==="model"?o.modelTitle:o.itemName||o.itemId||"Item",a.appendChild(s);const c=document.createElement("span");c.className="search-result__badge",c.textContent=o.type==="item"?o.categoryTitle||"Item":"Model",a.appendChild(c);const u=document.createElement("div");u.className="search-result__meta";const g=document.createElement("span");if(g.textContent=o.modelId?`${o.modelTitle} · ${o.modelId}`:o.modelTitle,u.appendChild(g),o.type==="item"&&o.itemId){const m=document.createElement("span");m.textContent=`Item ID: ${o.itemId}`,u.appendChild(m)}else if(o.type==="model"){const m=document.createElement("span");m.textContent="Matches model title",u.appendChild(m)}i.appendChild(a),i.appendChild(u),ge.appendChild(i)}),ge.hidden=!1}function dl(e){pu(e||""),cl(e||"")}function mu(e){!e||!Number.isInteger(e.modelIndex)||(Ct(e.modelIndex),e.itemId&&requestAnimationFrame(()=>{var n;if(w!==e.modelIndex)return;const t=(n=st.get(e.itemId))==null?void 0:n.el;t&&(yt(e.itemId),t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),t.focus({preventScroll:!0}))}))}function Ct(e){var t;if(mo(),Ko(),$t=null,pn=null,Je=null,at=null,e<0||e>=p.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}if(M=!0,w=e,console.log("[Blockscape] active model:",Ke(p[e]),"(index",e+" )"),typeof(qe==null?void 0:qe.highlightSource)=="function"){const n=((t=p[e])==null?void 0:t.sourcePath)||null;qe.highlightSource(n)}za(),Vn(),xt(),St(),ye&&dl(ye.value||""),qe.updateActiveSavePlaceholder(),ht.updateAvailability(),Da()}function Vn(){if(z.innerHTML="",!p.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",z.appendChild(e);return}p.forEach((e,t)=>{var S;const n=document.createElement("li");n.className="model-nav-item";const o=document.createElement("button");o.type="button",o.className="model-nav-button"+(t===w?" is-active":""),o.dataset.index=String(t),o.setAttribute("aria-current",t===w?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=Zi(e),i.appendChild(a);const s=Dd(Wa(e)||wt(e));if(s){const O=document.createElement("span");O.className="model-nav-id",O.textContent=s,i.appendChild(O)}const c=Array.isArray((S=e.data)==null?void 0:S.categories)?e.data.categories:[],u=c.reduce((O,T)=>O+(T.items||[]).length,0),g=document.createElement("span");g.className="model-nav-meta";const m=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} maps`:"";g.textContent=`${c.length} cat · ${u} items${m}`,o.appendChild(i),o.appendChild(g),n.appendChild(o),z.appendChild(n)}),ht.updateAvailability()}function xt(){if(w<0){h.value="",$&&($.disabled=!0);return}const e=p[w];h.value=JSON.stringify(e.data,null,2),$&&($.disabled=!ta(e))}function hu(e){try{return JSON.parse(e)}catch{return null}}function ul(e){if(typeof e!="string")return e;const t=e.trim().match(/^```[a-zA-Z0-9_-]*\s*\r?\n([\s\S]*?)\r?\n```$/);return t?t[1]:e}function gu(e){const t=((e==null?void 0:e.apicurioVersions)||[]).filter(s=>!(s!=null&&s.isCategoryView));if(t.length<2)return[];const n=new Map;t.forEach((s,c)=>{const u=s==null?void 0:s.data;if(!u||!Array.isArray(u.categories))return;const g=Ke(u,`Map ${c+1}`),m=(u.id??"").toString().trim()||Xt(g||`map-${c+1}`),S=Xt(m||g||`map-${c+1}`);u.categories.forEach(O=>{const T=((O==null?void 0:O.id)??"").toString().trim();if(!T)return;n.has(T)||n.set(T,{catTitle:O.title||T,sources:[]});const L=n.get(T);!L.catTitle&&(O.title||T)&&(L.catTitle=O.title||T),L.sources.push({category:O,mapId:m,mapTitle:g,mapSlug:S,versionIndex:c})})});const o=Bn(e)||null,i=(e==null?void 0:e.title)||(e==null?void 0:e.apicurioArtifactName)||Ke(e,"Series"),a=[];return n.forEach((s,c)=>{var O;if((((O=s.sources)==null?void 0:O.length)||0)<2)return;const u=s.catTitle||c,g=new Set,m=s.sources.map(T=>{var ut;let P=T.mapSlug||Xt(T.mapTitle||T.mapId)||`map-${T.versionIndex+1}`;g.has(P)&&(P=`${P}-${T.versionIndex+1}`),g.add(P);const te=new Map,Me=(((ut=T.category)==null?void 0:ut.items)||[]).map((_e,Ce)=>{const Ze=((_e==null?void 0:_e.id)??"").toString().trim()||`item-${Ce+1}`,Ue=`${P}-${Ze}`;te.set(Ze,Ue);const At={..._e,id:Ue};return At.deps=Array.isArray(_e==null?void 0:_e.deps)?[..._e.deps]:[],At});return Me.forEach(_e=>{_e.deps=(_e.deps||[]).map(Ce=>te.get(Ce)).filter(Boolean)}),{id:P,title:T.mapTitle||T.mapId||`Map ${T.versionIndex+1}`,items:Me}}),S={id:Xt(`${c}-category-view`),title:u,abstract:`Items from "${u}" across ${s.sources.length} maps in this series${i?` (${i})`:""}.`,categories:m};o&&(S.seriesId=o),Tn(S,{titleHint:u,idHint:`${o||"series"}-${c}`}),a.push({version:`${Gi}${c}`,data:S,isCategoryView:!0,categoryViewKey:c})}),a}function pl(e){var o;if(!e)return null;if(e.isCategoryView&&e.categoryViewKey)return`${Gi}${e.categoryViewKey}`;const t=(((o=e.data)==null?void 0:o.id)??e.id??"").toString().trim();return t||(e.version??"").toString().trim()||null}function oa(e){var s;if(!((s=e==null?void 0:e.apicurioVersions)!=null&&s.length))return e;const t=pl(e.apicurioVersions[e.apicurioActiveVersionIndex]),n=e.apicurioVersions.filter(c=>!(c!=null&&c.isCategoryView));if(!n.length)return e;if(n.length<2){e.apicurioVersions=n,e.apicurioActiveVersionIndex=Math.max(0,Math.min(Un(e),e.apicurioVersions.length-1));const c=e.apicurioVersions[e.apicurioActiveVersionIndex];return c!=null&&c.data&&(e.data=c.data),e}const o=gu({...e,apicurioVersions:n});e.apicurioVersions=[...n,...o];let i=e.apicurioVersions.findIndex(c=>pl(c)===t);i===-1&&(i=Math.min(e.apicurioActiveVersionIndex||0,e.apicurioVersions.length-1)),e.apicurioActiveVersionIndex=Math.max(i,0);const a=e.apicurioVersions[e.apicurioActiveVersionIndex];return a!=null&&a.data&&(e.data=a.data),e}function bu(e,t="Pasted",n={}){const o=Array.isArray(e)?e:[];if(!o.length)return[];const i=o.map((m,S)=>!m||typeof m!="object"?null:(Tn(m,{titleHint:`${t} #${S+1}`}),{obj:m,idx:S})).filter(Boolean);if(!i.length)return[];const a=i[0].obj,{seriesTitleOverride:s}=n;let c=s||a.title||`${t} series`;s&&!a.title&&(a.title=s);const u={id:co(),title:c,data:a,apicurioVersions:i.map(({obj:m,idx:S})=>({version:String(S+1),data:m})),apicurioActiveVersionIndex:0,isSeries:!0},g=Vt(u,{seriesName:c,fallbackTitle:c});return g&&(u.id=g),oa(u),[u]}function fl(e,t="Pasted",n={}){return Array.isArray(e)?bu(e,t,n):!e||typeof e!="object"?[]:(Tn(e,{titleHint:`${t} #1`}),[{id:co(),title:e.title||`${t} #1`,data:e}])}function Dn(e,t="Pasted",n={}){const a=(ul(typeof e=="string"?e:"")||"").replace(/^\uFEFF/,"").replace(/\u0000/g,"").trim();if(!a)return[];const s=hu(a);if(s){let u=n;if(Array.isArray(s)&&n.promptForSeriesName){const m=$d(s,t),S=Bd(m);u={...n,promptForSeriesName:!1,seriesTitleOverride:S||m}}const g=fl(s,t,u);if(g.length)return g}return a.split(/^\s*(?:---|%%%)\s*$/m).map(u=>u.trim()).filter(Boolean).map((u,g)=>{const m=JSON.parse(u);return Tn(m,{titleHint:`${t} #${g+1}`}),{id:co(),title:m.title||`${t} #${g+1}`,data:m}})}function wu(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function ho(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!wu(e)}function vu(e){if(!e)return!1;const n=(ul(e)||"").trimStart();return/^\s*(\{|\[|---|%%%)/.test(n)}function ml(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(ct)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(ct)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(ct)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=Dn(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let o=null;return n.forEach(i=>{const a=Ln(i,{versionLabel:"editor"});o==null&&(o=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:o,count:n.length}}function hl(e="storage"){const t=ml();return!t||typeof t.index!="number"?!1:(Ct(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function yu(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const s=new URLSearchParams(window.location.search);s.has("share")&&(t=s.get("share"))}if(!t)return null;let o;try{const s=Pc(t);o=JSON.parse(s)}catch(s){return console.warn("[Blockscape] failed to decode share token",s),null}if(!o||typeof o!="object"||o.data==null)return console.warn("[Blockscape] share payload missing data"),null;const i=fl(o.data,o.title||"Shared Model");if(!i.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let a=null;return i.forEach(s=>{const c=s.isSeries?o.title||s.title:null,u=Ln({...s,apicurioArtifactName:c||s.apicurioArtifactName},{versionLabel:"shared"});a==null&&(a=u)}),a}async function Su(){const e=Zc();if(!(e!=null&&e.path))return null;const{path:t,modelId:n,itemId:o}=e;try{if(!await hi())return console.log("[Blockscape] local backend not ready; skipping server-path autoload"),null;const a=await Ds(t);if(typeof(a==null?void 0:a.firstIndex)=="number"){typeof(qe==null?void 0:qe.highlightSource)=="function"&&qe.highlightSource(t);let s=a.firstIndex;if(n){const c=ja(n);c!==-1&&(s=c)}return{modelIndex:s,itemId:o||null,modelId:n||null}}return null}catch(i){return console.warn("[Blockscape] server-path autoload failed",i),null}}async function Eu(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const o=new URLSearchParams(window.location.search);o.has("load")&&(t=o.get("load"))}if(!t)return null;try{const o=await er(t);return typeof o=="number"?o:null}catch(o){return console.warn("[Blockscape] load param failed",o),null}}function ku(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,o=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(s=>{o.add(s.id);const c=new Set(s.deps||[]);t.set(s.id,c),c.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(s.id)})}));const i=new Set;return n.forEach((a,s)=>{((a==null?void 0:a.size)||0)>=2&&i.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:o}}function Iu(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),o=44;n.width=o,n.height=o;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),s=rl(e,t),c=ou(s);return i.fillStyle=s,i.beginPath(),i.arc(o/2,o/2,o/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=c,i.font=`bold ${o*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,o/2,o/2),n.toDataURL("image/png")}function Un(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function gl(e){const t=Un(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function bl(e,t="active"){return Bn(e)||wt(e)||(e==null?void 0:e.apicurioArtifactId)||(e==null?void 0:e.id)||t}function _u(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,o)=>{var s,c;const i=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();i&&t.set(i,o);const a=(((c=n==null?void 0:n.data)==null?void 0:c.seriesId)??"").toString().trim();a&&!t.has(a)&&t.set(a,o)}),t}function Cu(e,t){if(!e||!t)return null;const n=new Set,o=i=>{const a=(i??"").toString().trim();a&&(n.add(a),n.add(a.toLowerCase()),n.add(Xt(a)))};o(e.id),o(e.title);for(const i of n)if(t.has(i))return t.get(i);for(const i of n){const a=i.toLowerCase();for(const[s,c]of t.entries())if(s.toLowerCase()===a)return c}return null}const wl=new WeakMap;function xu(e,t){var Ue;if(!((Ue=e==null?void 0:e.apicurioVersions)!=null&&Ue[t]))return null;const n=e.apicurioVersions[t],o=n.data,i=Xi(o),a=wl.get(n);if(a&&a.fingerprint===i)return a.dataUrl;const s=160,c=160,u=document.createElement("canvas");u.width=s,u.height=c;const g=u.getContext("2d"),m=Bo("--color-surface-ghost")||Pt.color.surfaceGhost,S=Bo("--color-border-muted")||Pt.color.borderMuted;g.fillStyle=m,g.fillRect(0,0,s,c),g.strokeStyle=S,g.strokeRect(.5,.5,s-1,c-1);const O=8,T=8,L=4,P=Array.isArray(o==null?void 0:o.categories)?o.categories:[],te=Math.max(P.length,1),Me=s-L*2,ut=L*3,_e=te>1?Math.min(ut,Me/(te-1)):0,Ce=te>1?(s-_e*(te-1))/2:s/2;P.forEach((At,jt)=>{const Tt=Ce+jt*_e,xe=Array.isArray(At.items)?At.items:[],Et=Math.max(xe.length,1),_n=c-O-T-L*2,Wn=Et>1?Math.min(L*3,_n/(Et-1)):0;xe.forEach((kt,Ot)=>{const nn=c-T-L-Ot*Wn;g.beginPath(),g.arc(Tt,nn,L,0,Math.PI*2);const on=rl(kt.name||kt.id||"",kt.color);g.fillStyle=on,g.strokeStyle="rgba(15,23,42,0.25)",g.fill(),g.stroke()})});const Ze=u.toDataURL("image/png");return wl.set(n,{fingerprint:i,dataUrl:Ze}),Ze}function ia(e,t){var c;if(Ko(),e<0||e>=p.length)return!1;const n=p[e];if(!((c=n==null?void 0:n.apicurioVersions)!=null&&c.length)||!nl(e))return!1;const i=n.apicurioVersions.length,a=(t%i+i)%i,s=n.apicurioVersions[a];return s!=null&&s.data?(n.apicurioActiveVersionIndex=a,n.data=s.data,M=!0,G=null,_t=null,Zt(),xt(),St(),!0):!1}function Xa(e){var o;if(!e||w<0)return!1;const t=p[w];if(!((o=t==null?void 0:t.apicurioVersions)!=null&&o.length))return!1;const n=Un(t);return n===-1?!1:ia(w,n+e)}function Au(e,t){if(Ko(),e<0||e>=p.length)return!1;const n=p[e];if(!Array.isArray(n==null?void 0:n.apicurioVersions)||n.apicurioVersions.length<=1)return alert("A series needs at least one map. Add another before removing this one."),!1;if(!nl(e))return!1;const o=Math.min(Math.max(t,0),n.apicurioVersions.length-1),i=Un(n),[a]=n.apicurioVersions.splice(o,1);if(!a)return!1;let s=i;o===i?s=Math.min(o,n.apicurioVersions.length-1):o<i&&(s=Math.max(0,i-1)),n.apicurioActiveVersionIndex=Math.max(0,s);const c=n.apicurioVersions[n.apicurioActiveVersionIndex];return n.data=(c==null?void 0:c.data)||n.data,n.isSeries=n.apicurioVersions.length>1,Ct(e),!0}function Tu(e){if(!(e!=null&&e.apicurioVersions)||!e.apicurioVersions.length)return null;const t=Math.max(1,l.seriesNavMinVersions||1);if(e.apicurioVersions.length<t)return null;const n=document.createElement("div");n.className="version-nav";const o=document.createElement("div");o.className="version-nav__title",o.textContent=e.apicurioArtifactName||e.apicurioArtifactId||wt(e)||"Artifact",o.title="Double-click to rename this series",o.setAttribute("role","button"),o.tabIndex=0,o.addEventListener("dblclick",()=>{var Me;const P=p[w];!((Me=P==null?void 0:P.apicurioVersions)!=null&&Me.length)||!Rd(P)||(Vn(),xt(),St())}),n.appendChild(o);const i=document.createElement("div");i.className="version-nav__status";const a=Un(e),s=gl(e)||"latest";i.textContent=`No. in series ${s} (${a+1} of ${e.apicurioVersions.length})`,n.appendChild(i);const c=document.createElement("div");c.className="version-nav__controls";const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Previous",u.addEventListener("click",()=>Xa(-1));const g=document.createElement("button");g.type="button",g.className="version-nav__button",g.textContent="Next",g.addEventListener("click",()=>Xa(1)),c.appendChild(u),c.appendChild(g),n.appendChild(c);const m=document.createElement("div");m.className="version-nav__thumbs",e.apicurioVersions.forEach((P,te)=>{var jt,Tt;const Me=document.createElement("button");Me.type="button",Me.className="version-nav__thumb",P!=null&&P.isCategoryView&&Me.classList.add("version-nav__thumb--category"),te===a&&Me.classList.add("is-active");const ut=xu(e,te);if(ut){const xe=document.createElement("img");xe.src=ut,xe.alt=`Version ${te+1}`,Me.appendChild(xe)}const _e=document.createElement("div");_e.className="version-nav__thumb-label";const Ce=document.createElement("span");Ce.className="version-nav__thumb-label-text";const Ze=(((jt=P==null?void 0:P.data)==null?void 0:jt.id)??(P==null?void 0:P.id)??"").toString().trim();let Ue=Ze||(P!=null&&P.version?`v${P.version}`:`${te+1}`),At=Ze||Ue;if(P!=null&&P.isCategoryView){const xe=((Tt=P.data)==null?void 0:Tt.title)||P.categoryViewKey||Ue||"Category";Ue=xe,At=`Category view: ${xe}`,Me.dataset.computed="true"}if(Ce.textContent=Ue,_e.title=At,_e.appendChild(Ce),Me.appendChild(_e),Pu(_e,Ce),e.apicurioVersions.length>1&&!(P!=null&&P.isCategoryView)){const xe=document.createElement("span");xe.className="version-nav__thumb-remove",xe.title=`Remove ${Ue} from this series`,xe.setAttribute("aria-label",`Remove ${Ue} from this series`),xe.setAttribute("role","button"),xe.tabIndex=-1,xe.textContent="×",xe.addEventListener("click",Et=>{Et.stopPropagation(),Et.preventDefault(),window.confirm(`Remove ${Ue} from this series?`)&&Au(w,te)}),Me.appendChild(xe)}Me.addEventListener("click",()=>ia(w,te)),Du(Me,P),m.appendChild(Me)});const S=document.createElement("button");S.type="button",S.className="version-nav__thumb version-nav__thumb--add",S.title="Create a new version from this map",S.addEventListener("click",()=>{try{const P=il({versionLabel:"manual"});Ct(P)}catch(P){alert((P==null?void 0:P.message)||"Unable to create a new version right now.")}});const O=document.createElement("span");O.className="version-nav__thumb-add-icon",O.textContent="+",S.appendChild(O),m.appendChild(S),n.appendChild(m);const T=bl(e,"active"),L=D.get(T);return typeof L=="number"&&!Number.isNaN(L)&&requestAnimationFrame(()=>{m.scrollLeft=L}),m.addEventListener("scroll",()=>{D.set(T,m.scrollLeft)}),n}function gi(){var Hl,Fl;if(!ee)return;const e=w>=0&&p[w]?p[w]:null,t=_&&_.querySelector?_.querySelector(".version-nav__thumbs"):null;if(t&&e){const f=bl(e,w);D.set(f,t.scrollLeft)}Fn(),Array.isArray(ee.m.categories)||(ee.m.categories=[]),console.log("[Blockscape] rendering categories=",ee.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!ee.m.abstract,"- value:",ee.m.abstract?ee.m.abstract.substring(0,50)+"...":"none"),_.innerHTML="",st.clear(),kn.clear(),fe=[],ea(p[w],{versionLabel:"1"});const n=Tu(p[w]);n&&_.appendChild(n),W.setAttribute("width",window.innerWidth),W.setAttribute("height",window.innerHeight);const i=(()=>{var K,Fe,Gt;const f=document.createElement("div");f.className="blockscape-model-meta";const B=document.createElement("div");B.className="blockscape-model-title",B.textContent=ee.m.title&&ee.m.title.trim()||Ke(p[w]),f.appendChild(B),((K=p[w])!=null&&K.isSeries||(Gt=(Fe=p[w])==null?void 0:Fe.apicurioVersions)!=null&&Gt.length)&&Vt(p[w],{seriesName:p[w].title||ee.m.title||Ke(p[w])});const V=gl(p[w]),Ae=Bn(p[w]),me=(ee.m.id??"").toString().trim(),Ve=document.createElement("div");Ve.className="blockscape-model-meta__details";const Oe=(De,Lt)=>{if(!Lt)return;const Sn=document.createElement("div");Sn.className="blockscape-model-id";const wo=document.createElement("span");wo.className="blockscape-model-id__label",wo.textContent=De;const vo=document.createElement("span");vo.className="blockscape-model-id__value",vo.textContent=Lt,Sn.append(wo,vo),Ve.appendChild(Sn)};return Oe("Series ID",Ae),Oe("Model ID",me),Oe("No. in series",V),Ve.childElementCount&&f.appendChild(Ve),f})();l.showModelMeta!==!1&&_.appendChild(i.cloneNode(!0));const s=document.createElement("div");s.className="blockscape-tabs";const c=document.createElement("div");c.className="blockscape-tabrow";const u=document.createElement("div");u.className="blockscape-tablist",u.setAttribute("role","tablist"),c.appendChild(u);const g=document.createElement("div");g.className="blockscape-tabactions",c.appendChild(g),s.appendChild(c);const m=document.createElement("div");m.className="blockscape-tabpanels",s.appendChild(m);const S=document.createElement("div"),O=document.createElement("div"),T=document.createElement("div"),L=document.createElement("div"),P=()=>{const f=document.createElement("div");f.className="blockscape-map-legend";const B=document.createElement("div");return B.className="blockscape-legend",B.setAttribute("role","presentation"),B.innerHTML=`
        <span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span>
        <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span>
      `,f.appendChild(B),f};let te="";const Me=_u(p[w]),ut=Un(p[w]),_e=((Fl=(Hl=p[w])==null?void 0:Hl.apicurioVersions)==null?void 0:Fl[ut])||null,Ce=Kn=!!(_e!=null&&_e.isCategoryView||((_e==null?void 0:_e.version)||"").startsWith(Gi));y=null,N="";const Ze=(f,B)=>{!f||!B||(f.title=f.title?`${f.title}
${B}`:B)},Ue=[{id:"map",label:"Map",panel:S},{id:"abstract",label:"Info",panel:O},{id:"source",label:"Settings",panel:T},{id:"apicurio",label:"Apicurio",panel:L}],At=typeof ht.isEnabled=="function"?ht.isEnabled():!1,jt=f=>{if(!W)return;const B=f==="map";W.hidden=!B,B?(aa(),In()):W.innerHTML=""};Ue.forEach((f,B)=>{const V=document.createElement("button");V.type="button",V.id=`tab-${f.id}`,V.className="blockscape-tab"+(B===0?" is-active":""),V.setAttribute("role","tab"),V.setAttribute("aria-controls",`panel-${f.id}`),V.setAttribute("aria-selected",B===0?"true":"false"),V.textContent=f.label,f.id==="apicurio"&&!At&&(V.hidden=!0,V.tabIndex=-1,V.setAttribute("aria-hidden","true"),V.style.display="none"),f.button=V,u.appendChild(V),f.panel.id=`panel-${f.id}`,f.panel.classList.add("blockscape-tabpanel"),f.panel.setAttribute("role","tabpanel"),f.panel.setAttribute("aria-labelledby",V.id),f.panel.hidden=B!==0,B===0&&f.panel.classList.add("is-active"),m.appendChild(f.panel)});const Tt=f=>{qn=f,Ue.forEach(B=>{const V=B.id===f;B.button.classList.toggle("is-active",V),B.button.setAttribute("aria-selected",V?"true":"false"),B.panel.classList.toggle("is-active",V),B.panel.hidden=!V}),jt(f)},xe=Ue.find(f=>f.id==="apicurio"),Et=f=>{if(!xe||!xe.button||!xe.panel)return;const B=!!f;if(xe.button.hidden=!B,xe.button.tabIndex=B?0:-1,xe.button.setAttribute("aria-hidden",B?"false":"true"),xe.button.style.display=B?"":"none",B){const V=qn==="apicurio";xe.button.classList.toggle("is-active",V),xe.button.setAttribute("aria-selected",V?"true":"false"),xe.panel.classList.toggle("is-active",V),xe.panel.hidden=!V}else{const V=xe.panel.classList.contains("is-active");if(xe.button.classList.remove("is-active"),xe.button.setAttribute("aria-selected","false"),xe.panel.classList.remove("is-active"),xe.panel.hidden=!0,V){const Ae=Ue.find(me=>me.id!=="apicurio");Ae&&Tt(Ae.id)}}Y&&(Y.checked=B)};Ue.forEach(f=>{f.button.addEventListener("click",()=>{Fn(),Tt(f.id)}),f.id==="abstract"&&(y=f.button,f.button.addEventListener("mouseenter",()=>vi(f.button,te,{offset:12})),f.button.addEventListener("mouseleave",Fn),f.button.addEventListener("focus",()=>vi(f.button,te,{offset:12})),f.button.addEventListener("blur",Fn))});const Wn=(f=>{const B=Ue.find(Ae=>Ae.id===qn);if(B&&(B.id!=="apicurio"||f))return B.id;const V=Ue.find(Ae=>Ae.id!=="apicurio"||f);return(V==null?void 0:V.id)||Ue[0].id})(At);Tt(Wn),Et(At),typeof ht.onEnabledChange=="function"&&ht.onEnabledChange(Et),_.appendChild(s),S.appendChild(P());const kt=document.createElement("div");kt.className="blockscape-render";const Ot=document.createElement("div");Ot.className="stage-guides",Ot.hidden=!bt,Ot.setAttribute("aria-hidden","true");const nn=document.createElement("div");nn.className="stage-guide-labels",["Genesis / Inception","Custom","Product / Rental","Service / Commodity"].forEach(f=>{const B=document.createElement("span");B.className="stage-guide-labels__item",B.textContent=f,nn.appendChild(B)}),Ot.appendChild(nn),kt.appendChild(Ot),La=Ot,S.appendChild(kt);const on=document.createElement("div");if(on.className="blockscape-abstract-panel",O.appendChild(i.cloneNode(!0)),ee.m.abstract){console.log("[Blockscape] Rendering abstract content");const f=document.createElement("div");f.className="blockscape-abstract",f.innerHTML=ee.m.abstract,ip(f),on.appendChild(f),te=f.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const f=document.createElement("div");f.className="blockscape-abstract-placeholder",f.textContent="No abstract has been provided for this model.",on.appendChild(f),te=f.outerHTML}N=te,O.appendChild(on);const an=document.createElement("div");an.className="blockscape-source-panel";const Ye=document.createElement("div");Ye.className="blockscape-settings-panel";const Zo=f=>{Te.themeToggle&&(Te.themeToggle.checked=f),Te.tabThemeToggle&&(Te.tabThemeToggle.checked=f)},rn=f=>{Zo(f),Ma(f?so:Io)},go=f=>{Te.tabCenterToggle&&(Te.tabCenterToggle.checked=f)},hn=f=>{const B=Mo(f);go(B),Ns(B)},tr=f=>{Te.secondaryLinksToggle&&(Te.secondaryLinksToggle.checked=f),Te.tabSecondaryLinksToggle&&(Te.tabSecondaryLinksToggle.checked=f)},yi=f=>{const B=!!f;tr(B),Jt=B,G?yt(G):(sa(),In())},Si=({id:f,label:B,checked:V,onChange:Ae})=>{const me=document.createElement("label");me.className="blockscape-tab-toggle",me.setAttribute("for",f);const Ve=document.createElement("input");Ve.type="checkbox",Ve.id=f,Ve.checked=V,typeof Ae=="function"&&Ve.addEventListener("change",()=>Ae(Ve.checked));const Oe=document.createElement("span");return Oe.className="blockscape-tab-toggle__label",Oe.textContent=B,me.append(Ve,Oe),{row:me,input:Ve}},Qo=document.createElement("p");Qo.className="blockscape-settings-panel__title",Qo.textContent="Feature toggles",Ye.appendChild(Qo);const Ei=document.createElement("label");Ei.className="settings-toggle";const Yn=document.createElement("input");Yn.type="checkbox",Yn.checked=ci===so;const ki=document.createElement("span");ki.className="settings-toggle__text";const ei=document.createElement("span");ei.className="settings-toggle__label",ei.textContent="Dark mode";const k=document.createElement("span");k.className="settings-toggle__hint",k.textContent="Switch Blockscape UI to dark colors.",ki.append(ei,k),Ei.append(Yn,ki),Yn.addEventListener("change",()=>{rn(Yn.checked)}),Ye.appendChild(Ei),Te.themeToggle=Yn;const{row:U,input:ie}=Si({id:"tabToggleTheme",label:"Dark mode",checked:ci===so,onChange:f=>rn(f)});g.appendChild(U),Te.tabThemeToggle=ie;const{row:we,input:et}=Si({id:"tabToggleSecondaryLinks",label:"Show indirect links",checked:Jt,onChange:f=>yi(f)});g.appendChild(we),Te.tabSecondaryLinksToggle=et;const{row:He,input:ae}=Si({id:"tabToggleCenterItems",label:"Wardley",checked:bt,onChange:f=>hn(f)});g.appendChild(He),Te.tabCenterToggle=ae;const Re=document.createElement("div");Re.className="settings-actions";const gt=document.createElement("input");gt.type="file",gt.accept="application/json",gt.hidden=!0;const un=document.createElement("button");un.type="button",un.className="pf-v5-c-button pf-m-secondary",un.textContent="Load settings",un.addEventListener("click",()=>gt.click()),gt.addEventListener("change",async()=>{var B,V;const f=(B=gt.files)==null?void 0:B[0];if(f)try{const Ae=await f.text(),me=JSON.parse(Ae),Ve=(me==null?void 0:me.settings)||me,K=((V=Ha(Ve||{},{refreshObsidianLinks:la}).applied)==null?void 0:V.length)||0;dn(K?`Loaded ${K} setting${K===1?"":"s"} from ${f.name}.`:`No matching settings found in ${f.name}.`,2200)}catch(Ae){console.warn("[Blockscape] failed to load settings.json",Ae),dn("Invalid settings file.",2400)}finally{gt.value=""}});const Qt=document.createElement("button");Qt.type="button",Qt.className="pf-v5-c-button pf-m-tertiary",Qt.textContent="Download settings",Qt.addEventListener("click",async()=>{const f=Ys();if(typeof window<"u"&&typeof window.__blockscapeSettingsSaveToFile=="function")try{await window.__blockscapeSettingsSaveToFile(f)?dn("Settings saved to ~/.blockscape/settings.json.",2e3):dn("Settings save failed. Check logs.",2400)}catch(B){console.warn("[Blockscape] settings save failed",B),dn("Settings save failed. Check logs.",2400)}else Ls("settings.json",JSON.stringify(f,null,2)),dn("Settings downloaded.",2e3)}),Re.append(un,Qt,gt),Ye.appendChild(Re);const jn=document.createElement("div");jn.className="color-presets";const nr=document.createElement("div");nr.className="settings-text__label",nr.textContent="Color presets";const or=document.createElement("div");or.className="settings-text__hint",or.textContent="Shown in tile context menu for quick coloring.",jn.append(nr,or);const Ii=document.createElement("div");Ii.className="color-presets__list";const ir=document.createElement("div");ir.className="color-presets__add";const ti=document.createElement("input");ti.type="text",ti.placeholder="Name",ti.className="settings-text__input";const _i=document.createElement("input");_i.type="color",_i.value="#2563eb",_i.className="settings-color-input";const Ci=document.createElement("button");Ci.type="button",Ci.className="pf-v5-c-button pf-m-primary",Ci.textContent="Add preset",Ci.addEventListener("click",()=>{const f=ti.value.trim()||"Custom",B=_i.value,V=[...Yt,{name:f,value:B}];$o(V),Jo(Yt),ti.value=""}),ir.append(ti,_i,Ci),jn.append(Ii,ir),Ye.appendChild(jn),Te.colorPresetList=Ii,No=()=>{Ii.innerHTML="",Yt.forEach((f,B)=>{const V=document.createElement("div");V.className="color-presets__row";const Ae=document.createElement("input");Ae.type="text",Ae.className="settings-text__input",Ae.value=f.name||"",Ae.placeholder="Name",Ae.addEventListener("input",()=>{const Oe=[...Yt];Oe[B]={...Oe[B],name:Ae.value},$o(Oe),Jo(Yt)});const me=document.createElement("input");me.type="color",me.className="settings-color-input",me.value=f.value,me.addEventListener("input",()=>{const Oe=[...Yt];Oe[B]={...Oe[B],value:me.value},$o(Oe),Jo(Yt)});const Ve=document.createElement("button");Ve.type="button",Ve.className="pf-v5-c-button pf-m-plain",Ve.textContent="✕",Ve.title="Remove preset",Ve.addEventListener("click",()=>{const Oe=Yt.filter((K,Fe)=>Fe!==B);$o(Oe),Jo(Yt),No()}),V.append(Ae,me,Ve),Ii.appendChild(V)})},No();const ar=document.createElement("div");ar.className="settings-text";const rr=document.createElement("div");rr.className="settings-text__label",rr.textContent="Link colors";const sr=document.createElement("div");sr.className="settings-text__hint",sr.textContent="Adjust the colors used when highlighting enables/dependents.";const lr=document.createElement("div");lr.className="settings-color-rows";const Bl=({id:f,label:B,hint:V,value:Ae,onChange:me})=>{const Ve=document.createElement("label");Ve.className="settings-color-row",Ve.setAttribute("for",f);const Oe=document.createElement("span");if(Oe.className="settings-color-row__label",Oe.textContent=B,V){const Fe=document.createElement("span");Fe.className="settings-color-row__hint",Fe.textContent=V,Oe.appendChild(Fe)}const K=document.createElement("input");if(K.type="color",K.id=f,K.className="settings-color-input",K.value=Ae,typeof me=="function"){const Fe=()=>me(K.value);K.addEventListener("input",Fe),K.addEventListener("change",Fe)}return Ve.append(Oe,K),lr.appendChild(Ve),K};Te.depColorInput=Bl({id:"depColor",label:"Enables",hint:"Outgoing links from the selected item.",value:Ki,onChange:f=>{const B=Oa(f);$a(B)}}),Te.revdepColorInput=Bl({id:"revdepColor",label:"Dependents",hint:"Incoming links to the selected item.",value:qi,onChange:f=>{const B=Pa(f);Ra(B)}}),ar.append(rr,sr,lr),Ye.appendChild(ar);const cr=document.createElement("div");cr.className="settings-text";const dr=document.createElement("div");dr.className="settings-text__text";const ur=document.createElement("div");ur.className="settings-text__label",ur.textContent="Link thickness";const pr=document.createElement("div");pr.className="settings-text__hint",pr.textContent="Adjust stroke width for enables/dependents lines.",dr.append(ur,pr);const bo=document.createElement("select");bo.id="linkThickness",bo.className="settings-text__input",[{value:"s",label:"Small"},{value:"m",label:"Medium"},{value:"l",label:"Large"}].forEach(({value:f,label:B})=>{const V=document.createElement("option");V.value=f,V.textContent=B,f===di&&(V.selected=!0),bo.appendChild(V)}),bo.addEventListener("change",()=>{const f=fi(bo.value);Va(f)});const fr=document.createElement("div");fr.className="settings-text__row",fr.append(dr,bo),cr.appendChild(fr),Ye.appendChild(cr),Te.linkThicknessInput=bo;const Xn=({id:f,label:B,hint:V,checked:Ae,className:me="",onChange:Ve})=>{const Oe=document.createElement("label");Oe.className=["settings-toggle",me].filter(Boolean).join(" ");const K=document.createElement("input");K.type="checkbox",K.id=f,K.checked=Ae;const Fe=document.createElement("span");Fe.className="settings-toggle__text";const Gt=document.createElement("span");if(Gt.className="settings-toggle__label",Gt.textContent=B,Fe.appendChild(Gt),V){const De=document.createElement("span");De.className="settings-toggle__hint",De.textContent=V,Fe.appendChild(De)}return Oe.appendChild(K),Oe.appendChild(Fe),typeof Ve=="function"&&K.addEventListener("change",()=>Ve(K.checked)),{row:Oe,input:K}},la=()=>{_.querySelectorAll(".tile").forEach(f=>{const B=f.dataset.id,V=Qi(B);if(!(V!=null&&V.item))return;const Ae=Il(V.item.external),me=kl(V.item,{externalMeta:Ae,seriesIdLookup:Me});_l(f,me)})},{row:lp,input:cp}=Xn({id:"toggleSecondaryLinks",label:"Show indirect links",checked:Jt,className:"map-controls__toggle",onChange:f=>yi(f)});Ye.appendChild(lp),Te.secondaryLinksToggle=cp;const{row:dp,input:up}=Xn({id:"toggleReusedInMap",label:"Display reused in map view",hint:"Show markers for nodes used multiple times.",checked:Dt,className:"map-controls__toggle",onChange:f=>{Dt=f,Qa()}});Ye.appendChild(dp),Te.reusedToggle=up;const{row:pp,input:fp}=Xn({id:"toggleAutoIdFromName",label:"Auto-fill IDs from titles",hint:"Keep ID in sync while editing name/title (can be overridden manually).",checked:lo,className:"map-controls__toggle",onChange:f=>{const B=Fo(f);js(B)}});Ye.appendChild(pp),Te.autoIdToggle=fp;const mr=[],{row:mp,input:hp}=Xn({id:"toggleObsidianLinks",label:"Obsidian",hint:"Make tiles open Obsidian when no external URL exists.",checked:To,className:"map-controls__toggle",onChange:f=>{const B=zo(f);Qs(B),mr.forEach(V=>{V.disabled=!B}),la()}});if(Ye.appendChild(mp),Te.obsidianToggle=hp,typeof(qe==null?void 0:qe.isAvailable)=="function"&&qe.isAvailable()&&typeof(qe==null?void 0:qe.getAutoReloadConfig)=="function"){const{enabled:f,intervalMs:B}=qe.getAutoReloadConfig();let V=null;const{row:Ae,input:me}=Xn({id:"toggleAutoReload",label:"Auto-reload local files",hint:"Poll the local backend for file changes and refresh matching models.",checked:f,className:"map-controls__toggle",onChange:Lt=>{qe.setAutoReloadEnabled(Lt),V&&(V.disabled=!Lt)}});Ye.appendChild(Ae),Te.autoReloadToggle=me;const Ve=Lt=>`${(Lt/1e3).toFixed(2)}s`,Oe=document.createElement("label");Oe.className="settings-slider",Oe.setAttribute("for","autoReloadInterval");const K=document.createElement("div");K.className="settings-slider__text";const Fe=document.createElement("span");Fe.className="settings-slider__label",Fe.textContent="Auto-reload interval";const Gt=document.createElement("span");Gt.className="settings-slider__hint",Gt.textContent="Adjust how often to poll for file changes.",K.append(Fe,Gt);const De=document.createElement("span");De.className="settings-slider__value",De.textContent=Ve(B),V=document.createElement("input"),V.type="range",V.id="autoReloadInterval",V.className="settings-slider__input",V.min=String(fs),V.max=String(ms),V.step="100",V.value=String(B),V.disabled=!f,V.setAttribute("aria-label","Set auto-reload polling interval"),V.addEventListener("input",()=>{const Lt=qe.setAutoReloadInterval(parseInt(V.value,10));De.textContent=Ve(Lt)}),Oe.append(K,De,V),Ye.appendChild(Oe),Te.autoReloadInput=V,Te.autoReloadValue=De}const hr=document.createElement("div");hr.className="settings-radio";const gr=document.createElement("div");gr.className="settings-radio__label",gr.textContent="Obsidian link format";const br=document.createElement("div");br.className="settings-radio__hint",br.textContent="Use the tile title or id when building Obsidian links.";const wr=document.createElement("div");wr.className="settings-radio__options";const $l=(f,B)=>{const V=document.createElement("label");V.className="settings-radio__option";const Ae=document.createElement("input");Ae.type="radio",Ae.name="obsidianLinkMode",Ae.value=f,Ae.checked=li===f,Ae.disabled=!To,Ae.addEventListener("change",()=>{if(!Ae.checked)return;const Ve=jo(f);Zs(Ve),la()});const me=document.createElement("span");me.textContent=B,V.append(Ae,me),mr.push(Ae),wr.appendChild(V)};$l(Aa,"Use title"),$l(Fi,"Use id"),hr.append(gr,wr,br),Ye.appendChild(hr),Te.obsidianModeInputs=mr;const ca=document.createElement("label");ca.className="settings-text",ca.setAttribute("for","obsidianVaultInput");const vr=document.createElement("div");vr.className="settings-text__text";const yr=document.createElement("span");yr.className="settings-text__label",yr.textContent="Obsidian vault";const Sr=document.createElement("span");Sr.className="settings-text__hint",Sr.textContent="Optional. Set the vault name to avoid duplicates.",vr.append(yr,Sr);const zn=document.createElement("input");zn.type="text",zn.id="obsidianVaultInput",zn.className="settings-text__input",zn.placeholder="Vault name",zn.value=Lo,zn.addEventListener("input",()=>{const f=Go(zn.value);el(f),la()}),ca.append(vr,zn),Ye.appendChild(ca),Te.obsidianVaultInput=zn;const Er=document.createElement("p");Er.className="settings-note",Er.innerHTML='Requires the Obsidian <a href="https://vinzent03.github.io/obsidian-advanced-uri/" target="_blank" rel="noreferrer noopener">Advanced URI</a> plugin for create/open behavior.',Ye.appendChild(Er);const Rl=f=>`${(f/1e3).toFixed(1)}s`,da=document.createElement("label");da.className="settings-slider",da.setAttribute("for","seriesNavDoubleClickWait");const kr=document.createElement("div");kr.className="settings-slider__text";const Ir=document.createElement("span");Ir.className="settings-slider__label",Ir.textContent="Series double-click wait";const _r=document.createElement("span");_r.className="settings-slider__hint",_r.textContent="Time window to double-click into another map version.",kr.append(Ir,_r);const xi=document.createElement("span");xi.className="settings-slider__value",xi.textContent=Rl(Pn);const gn=document.createElement("input");gn.type="range",gn.id="seriesNavDoubleClickWait",gn.className="settings-slider__input",gn.min=String(xs),gn.max=String(As),gn.step="50",gn.value=String(Pn),gn.setAttribute("aria-label","Adjust double-click wait for series navigation"),gn.addEventListener("input",()=>{const f=Wo(parseInt(gn.value,10));xi.textContent=Rl(f),Xs(f)}),da.append(kr,xi,gn),Ye.appendChild(da),Te.seriesNavInput=gn,Te.seriesNavValue=xi;const Ol=f=>`${Math.round((f-1)*100)}%`,ua=document.createElement("label");ua.className="settings-slider",ua.setAttribute("for","hoverScaleSlider");const Cr=document.createElement("div");Cr.className="settings-slider__text";const xr=document.createElement("span");xr.className="settings-slider__label",xr.textContent="Hover zoom";const Ar=document.createElement("span");Ar.className="settings-slider__hint",Ar.textContent="Expand tiles on hover to see more detail.",Cr.append(xr,Ar);const Ai=document.createElement("span");Ai.className="settings-slider__value",Ai.textContent=Ol(_o);const bn=document.createElement("input");bn.type="range",bn.id="hoverScaleSlider",bn.className="settings-slider__input",bn.min=String(Rt),bn.max=String(Ht),bn.step="0.1",bn.value=String(_o),bn.setAttribute("aria-label","Adjust hover zoom"),bn.addEventListener("input",()=>{const f=Ro(parseFloat(bn.value));Ai.textContent=Ol(f),Hs(f),G&&qo()}),ua.append(Cr,Ai,bn),Ye.appendChild(ua),Te.hoverScaleInput=bn,Te.hoverScaleValue=Ai;let zt=null,Zn=null;const Tr=f=>{const B=Math.round((1-f)*100);return B===0?"Off":`${B}% dim`},{row:gp,input:bp}=Xn({id:"toggleSelectionDimming",label:"Dim unrelated tiles",hint:"When selecting a tile, fade everything except linked tiles.",checked:On,className:"map-controls__toggle",onChange:f=>{const B=Ho(f);Ws(B),zt&&(zt.disabled=!B),Zn&&(Zn.textContent=Tr(B?Rn:1))}});Ye.appendChild(gp),Te.selectionDimToggle=bp;const pa=document.createElement("label");pa.className="settings-slider",pa.setAttribute("for","selectionDimmingSlider");const Lr=document.createElement("div");Lr.className="settings-slider__text";const Nr=document.createElement("span");Nr.className="settings-slider__label",Nr.textContent="Dimming strength";const Mr=document.createElement("span");Mr.className="settings-slider__hint",Mr.textContent="Adjust how much unrelated tiles fade when dimming is on.",Lr.append(Nr,Mr),Zn=document.createElement("span"),Zn.className="settings-slider__value",Zn.textContent=Tr(On?Rn:1),zt=document.createElement("input"),zt.type="range",zt.id="selectionDimmingSlider",zt.className="settings-slider__input",zt.min=String(mn),zt.max=String(dt),zt.step="0.05",zt.value=String(Rn),zt.disabled=!On,zt.setAttribute("aria-label","Adjust how much unrelated tiles dim on selection"),zt.addEventListener("input",()=>{const f=Oo(parseFloat(zt.value));Zn.textContent=Tr(f),Fs(f)}),pa.append(Lr,Zn,zt),Ye.appendChild(pa),Te.selectionDimInput=zt,Te.selectionDimValue=Zn;const Pl=f=>f===1?"Default":`${Math.round(f*100)}%`,fa=document.createElement("label");fa.className="settings-slider",fa.setAttribute("for","tileCompactnessSlider");const Br=document.createElement("div");Br.className="settings-slider__text";const $r=document.createElement("span");$r.className="settings-slider__label",$r.textContent="Tile compactness";const Rr=document.createElement("span");Rr.className="settings-slider__hint",Rr.textContent="Adjust padding, gap, and logo size for tiles.",Br.append($r,Rr);const Ti=document.createElement("span");Ti.className="settings-slider__value",Ti.textContent=Pl(Co);const wn=document.createElement("input");wn.type="range",wn.id="tileCompactnessSlider",wn.className="settings-slider__input",wn.min=String(rs),wn.max=String(ss),wn.step="0.05",wn.value=String(Co),wn.setAttribute("aria-label","Adjust tile compactness"),wn.addEventListener("input",()=>{const f=Po(parseFloat(wn.value));Ti.textContent=Pl(f),zs(f),G&&qo()}),fa.append(Br,Ti,wn),Ye.appendChild(fa),Te.tileCompactnessInput=wn,Te.tileCompactnessValue=Ti;const{row:wp,input:vp}=Xn({id:"titleWrapToggle",label:"Wrap titles",hint:"Allow long titles to wrap instead of truncating.",checked:Ta!=="nowrap",className:"map-controls__toggle",onChange:f=>{const B=f?"wrap":"nowrap";Uo(B),Ks(B)}});Ye.appendChild(wp),Te.titleWrapInput=vp;const Vl=f=>`${Math.round((f-1)*100)}% extra`,ma=document.createElement("label");ma.className="settings-slider",ma.setAttribute("for","titleHoverWidthSlider");const Or=document.createElement("div");Or.className="settings-slider__text";const Pr=document.createElement("span");Pr.className="settings-slider__label",Pr.textContent="Title width on hover";const Vr=document.createElement("span");Vr.className="settings-slider__hint",Vr.textContent="Give titles more room horizontally when zoomed.",Or.append(Pr,Vr);const Li=document.createElement("span");Li.className="settings-slider__value",Li.textContent=Vl(xo);const vn=document.createElement("input");vn.type="range",vn.id="titleHoverWidthSlider",vn.className="settings-slider__input",vn.min=String(ro),vn.max=String(xa),vn.step="0.05",vn.value=String(xo),vn.setAttribute("aria-label","Adjust title width boost on hover"),vn.addEventListener("input",()=>{const f=Vo(parseFloat(vn.value));Li.textContent=Vl(f),Gs(f)}),ma.append(Or,Li,vn),Ye.appendChild(ma),Te.titleWidthInput=vn,Te.titleWidthValue=Li;const Dl=f=>`${Math.round(f*100)}% of hover zoom`,ha=document.createElement("label");ha.className="settings-slider",ha.setAttribute("for","titleZoomPortionSlider");const Dr=document.createElement("div");Dr.className="settings-slider__text";const Ur=document.createElement("span");Ur.className="settings-slider__label",Ur.textContent="Title zoom influence";const Hr=document.createElement("span");Hr.className="settings-slider__hint",Hr.textContent="How much the title scales relative to tile hover zoom.",Dr.append(Ur,Hr);const Ni=document.createElement("span");Ni.className="settings-slider__value",Ni.textContent=Dl(Ao);const yn=document.createElement("input");yn.type="range",yn.id="titleZoomPortionSlider",yn.className="settings-slider__input",yn.min=String(os),yn.max=String(is),yn.step="0.05",yn.value=String(Ao),yn.setAttribute("aria-label","Adjust how much titles scale on hover"),yn.addEventListener("input",()=>{const f=Do(parseFloat(yn.value));Ni.textContent=Dl(f),Js(f)}),ha.append(Dr,Ni,yn),Ye.appendChild(ha),Te.titleZoomInput=yn,Te.titleZoomValue=Ni;const yp=typeof ht.isEnabled=="function"?ht.isEnabled():!1,{row:Sp,input:Ep}=Xn({id:"apicurioFeatureToggle",label:"Apicurio",hint:"Show the Apicurio registry tab when enabled.",checked:yp,className:"apicurio-toggle",onChange:f=>{typeof ht.setEnabled=="function"&&ht.setEnabled(f)}});if(Y=Ep,Ye.appendChild(Sp),an.appendChild(Ye),A)A.hidden=!1,A.classList.remove("pf-v5-c-page__main-section"),an.appendChild(A);else{const f=document.createElement("p");f.className="muted",f.textContent="Source editor unavailable.",an.appendChild(f)}T.appendChild(an),ht.mount(L);let Ul=0;ee.m.categories.forEach(f=>{const B=document.createElement("section");B.className="category",B.dataset.cat=f.id;const V=Ce?Cu(f,Me):null,Ae=(f.items||[]).some(K=>pi(K.stage)),me=document.createElement("div");me.className="cat-head",me.dataset.cat=f.id,me.tabIndex=0,Ce&&Number.isInteger(V)?(me.dataset.seriesVersionIndex=String(V),me.title="Open this category's map in the series",me.classList.add("cat-head--series-link")):me.title="Select category",me.innerHTML=`<div class="cat-title">${wi(f.title||f.id)}</div>
                          ${Ae?`<span class="cat-stage-indicator" title="Contains staged items">Stage</span>
                                 <button type="button" class="cat-stage-clear" title="Clear all stages in this category" aria-label="Clear all stages">×</button>`:""}
                          <div class="muted cat-count">${(f.items||[]).length} items</div>`,me.addEventListener("click",()=>{var Lt;const K=me.dataset.seriesVersionIndex!=null?parseInt(me.dataset.seriesVersionIndex,10):null,Fe=p[w],Gt=Fe?Un(Fe):-1;Ce&&((Lt=Fe==null?void 0:Fe.apicurioVersions)==null?void 0:Lt.length)>1&&Number.isInteger(K)&&K!==Gt&&ia(w,K)||Hn(f.id)}),me.addEventListener("keydown",K=>{(K.key==="Enter"||K.key===" ")&&(K.preventDefault(),me.click())});const Ve=me.querySelector(".cat-stage-clear");Ve&&Ve.addEventListener("click",K=>{K.preventDefault(),K.stopPropagation(),Hd(f.id)&&dn("Cleared stages for this category.",1400)}),me.addEventListener("focus",()=>Hn(f.id,{scrollIntoView:!1})),B.appendChild(me);const Oe=document.createElement("div");if(Oe.className="grid"+(bt?" is-centered":""),B.appendChild(Oe),(f.items||[]).forEach(K=>{Ul+=1;const Fe=Il(K.external),Gt=kl(K,{externalMeta:Fe,seriesIdLookup:Me}),De=document.createElement("div");if(De.className=Fe.isExternal?"tile external":"tile",De.tabIndex=0,De.dataset.id=K.id,De.dataset.globalIndex=String(Ul),Fe.url&&(De.dataset.externalUrl=Fe.url),!Ce){let Cn=null;if(Me.has(K.id)&&(Cn=Me.get(K.id)),Number.isInteger(Cn)){De.dataset.seriesVersionIndex=String(Cn),De.classList.add("tile--series-link");const kp=Cn===ut?"Current map in this series":`Open version ${Cn+1} in this series`;Ze(De,kp)}}Gt&&(De.dataset.obsidianUrl=Gt);const Lt=pi(K.stage);if(Lt&&(De.dataset.stage=String(Lt),bt&&(De.style.gridColumn=String(Lt))),!Ce){const Cn=ja(K.id);Cn!==-1&&Cn!==w&&(De.classList.add("tile--series-link"),De.dataset.navTargetIndex=String(Cn))}const Sn=document.createElement("img");Sn.className="logo",K.logo?(Sn.src=K.logo,Sn.alt=K.name||K.id):(Sn.alt="",Sn.style.opacity=1,Sn.src=Iu(K.name||K.id,K.color));const wo=document.createElement("div");wo.className="name",wo.textContent=K.name||K.id;const vo=document.createElement("div");vo.className="tile-id",vo.textContent=K.id||"";let Mi=null;Lt&&(Mi=document.createElement("div"),Mi.className="tile-stage",Mi.textContent=String(Lt));const Fr=document.createElement("div");Fr.className="badge",Fr.textContent="reused";let Qn=null;Ce||(Qn=document.createElement("button"),Qn.type="button",Qn.className="tile-delete",Qn.setAttribute("aria-label",`Delete ${K.name||K.id}`),Qn.textContent="×",Qn.addEventListener("click",Cn=>{Cn.stopPropagation(),tp(K.id)})),Fe.url&&De.appendChild(Ou(Fe.url)),_l(De,Gt),Qn&&De.appendChild(Qn),De.appendChild(Sn),De.appendChild(wo),De.appendChild(vo),Mi&&De.appendChild(Mi),De.appendChild(Fr),Oe.appendChild(De),st.set(K.id,{el:De,catId:f.id,rect:null})}),kt.appendChild(B),kn.set(f.id,{el:B,headEl:me}),!Ce){const K=document.createElement("button");K.type="button",K.className="tile-add",K.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',K.hidden=bt,K.tabIndex=bt?-1:0,K.setAttribute("aria-hidden",bt?"true":"false"),K.addEventListener("click",()=>Wu(f.id)),Oe.appendChild(K)}});let Nn=null;Ce||(Nn=document.createElement("button"),Nn.type="button",Nn.className="category-add",Nn.innerHTML='<span class="category-add__icon" aria-hidden="true">+</span><span class="category-add__label">Add category</span><span class="category-add__hint">(Insert)</span>',Nn.addEventListener("click",()=>xl()),kt.appendChild(Nn)),Nn&&bt&&(Nn.hidden=!0,Nn.tabIndex=-1,Nn.setAttribute("aria-hidden","true")),Ms(),Qa(),Lu(),aa(),In(),Yo(),Uu()}function Lu(){_.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",n=>{var T;if(typeof n.button=="number"&&n.button!==0)return;mo();const o=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,a=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):null,c=p[w],u=c?Un(c):-1,g=((T=c==null?void 0:c.apicurioVersions)==null?void 0:T.length)>1&&Number.isInteger(i)&&i!==u,m=Number.isInteger(s)&&s!==w&&s>=0&&s<p.length,S=sn&&sn.id===o&&sn.targetVersionIndex===i,O=Kt&&Kt.id===o&&Kt.targetIndex===s;if(sn&&!S&&Ko(),Kt&&!O&&Ka(),g)if(S){if(Ko(),ia(w,i))return}else ru(o,i,c);else if(m){if(O){Ka(),Ct(s);return}su(o,s)}else Number.isInteger(a)&&a>0&&a%5===0&&dn("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",o),G===o&&!(g&&S)&&!(m&&O)){Xo();return}yt(o)}),e.addEventListener("dblclick",n=>{n.preventDefault();const o=e.dataset.id,i=e.dataset.navTargetIndex!=null?parseInt(e.dataset.navTargetIndex,10):ja(o);i!==-1&&i!==w&&Ct(i)}),e.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),e.click())});const t=()=>{G&&qo()};e.addEventListener("pointerenter",t),e.addEventListener("pointerleave",t),e.addEventListener("focus",t),e.addEventListener("blur",t)}),sl||(sl=!0,window.addEventListener("resize",qo),window.addEventListener("scroll",qo,{passive:!0}),window.addEventListener("resize",Cl),document.addEventListener("click",e=>{var a,s,c;if(!G&&!Je||typeof e.button=="number"&&e.button!==0)return;const t=e.target,n=(a=t==null?void 0:t.closest)==null?void 0:a.call(t,".tile"),o=(s=t==null?void 0:t.closest)==null?void 0:s.call(t,".cat-head"),i=(c=t==null?void 0:t.closest)==null?void 0:c.call(t,".tile-context-menu");n||o||i||Xo()})),document.getElementById("clear").onclick=()=>Xo()}function aa(){st.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function vl(e,{includeSecondary:t=Jt}={}){if(!e||!ee)return{deps:new Set,revs:new Set,secondaryDeps:new Set,secondaryRevs:new Set,edges:[]};const n=new Set(ee.fwd.get(e)||[]),o=new Set(ee.rev.get(e)||[]),i=new Set,a=new Set,s=[],c=new Set,u=(g,m,S,O)=>{if(!g||!m)return;const T=`${g}->${m}:${S}:${O}`;c.has(T)||(c.add(T),s.push({from:g,to:m,type:S,depth:O}))};return n.forEach(g=>u(e,g,"dep",1)),o.forEach(g=>u(e,g,"revdep",1)),t&&new Set([...n,...o]).forEach(m=>{(ee.fwd.get(m)||new Set).forEach(T=>{const L=T===e;L||i.add(T),L||u(m,T,"dep",2)}),(ee.rev.get(m)||new Set).forEach(T=>{const L=T===e;L||a.add(T),L||u(m,T,"revdep",2)})}),{deps:n,revs:o,secondaryDeps:i,secondaryRevs:a,edges:s}}function ra(e,t){const n=st.get(e);n&&n.el.classList.add(t)}function yt(e){var c,u,g;if(!e)return;Je=null,G=e,at=null,_t=vl(e),Zt(),sa(),Yo();const{deps:t,revs:n,secondaryDeps:o,secondaryRevs:i}=_t;console.log("[Blockscape] selecting id=",e,"deps=",Array.from(t),"revs=",Array.from(n));const a=st.get(e);a&&a.el.classList.add("selected"),t.forEach(m=>ra(m,"dep")),n.forEach(m=>ra(m,"revdep")),o.forEach(m=>{!t.has(m)&&m!==e&&ra(m,"dep-indirect")}),i.forEach(m=>{!n.has(m)&&!t.has(m)&&m!==e&&ra(m,"revdep-indirect")}),In();const s=(g=(u=(c=st.get(e))==null?void 0:c.el)==null?void 0:u.dataset)==null?void 0:g.externalUrl;s&&dn("This item has link to",ao,s),Da()}function Hn(e,{scrollIntoView:t=!0,preserveEntryHint:n=!1}={}){var s,c;if(!((s=ee==null?void 0:ee.m)!=null&&s.categories)||!e)return!1;const i=(ee.m.categories||[]).find(u=>u.id===e);if(!i)return!1;mo(),Za(),n||(at=null),Je=i.id,Zt(),Yo();const a=kn.get(i.id);return t&&(a!=null&&a.el)&&(a.el.scrollIntoView({behavior:"smooth",block:"center"}),(c=a.headEl)==null||c.focus({preventScroll:!0})),!0}function Yo(){if(kn.forEach(({el:t,headEl:n})=>{t.classList.remove("category--selected"),n&&n.removeAttribute("aria-current")}),!Je)return;const e=kn.get(Je);if(!(e!=null&&e.el)){Je=null,at=null,Zt();return}e.el.classList.add("category--selected"),e.headEl&&e.headEl.setAttribute("aria-current","true")}function bi(){if(Je)return Je;const e=G?st.get(G):null;return e!=null&&e.catId?e.catId:null}function Nu(e){var a,s,c,u;if(!((s=(a=ee==null?void 0:ee.m)==null?void 0:a.categories)!=null&&s.length)||!e)return!1;const t=ee.m.categories,n=bi();let o=t.findIndex(g=>g.id===n);if(o===-1){const g=((c=t.find(m=>(m.items||[]).length))==null?void 0:c.id)||((u=t[0])==null?void 0:u.id);return g?Hn(g):!1}const i=o+e;return i<0||i>=t.length?!1:Hn(t[i].id)}function Za(){G=null,_t=null,sa(),In(),Da({itemId:null})}function Mu(){Je=null,at=null,Yo()}function Xo(){Za(),Mu(),at=null,Zt()}function sa(){_.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","dep-indirect","revdep-indirect","selected"))}function Qa(){ee!=null&&ee.reusedLocal&&ee.reusedLocal.forEach(e=>{const t=st.get(e);if(!t)return;t.el.classList.toggle("reused",Dt);const n=t.el.querySelector(".badge");n&&(n.style.display=Dt?"inline-block":"none")})}function In(){for(;W.firstChild;)W.removeChild(W.firstChild);if(!G||W.hidden)return;_t=vl(G);const e=_t,{primary:t,secondary:n}=Gc();e.edges.forEach(o=>{var P,te;const i=(P=st.get(o.from))==null?void 0:P.rect,a=(te=st.get(o.to))==null?void 0:te.rect;if(!i||!a)return;const s=yl(i),c=yl(a),u=El(Sl(i,c)||s,i,Is)||s,g=El(Sl(a,s)||c,a,Is)||c,m=document.createElementNS("http://www.w3.org/2000/svg","path"),S=(u.x+g.x)/2,O=u.y,T=(u.x+g.x)/2,L=g.y;m.setAttribute("d",`M ${u.x},${u.y} C ${S},${O} ${T},${L} ${g.x},${g.y}`),m.setAttribute("fill","none"),m.setAttribute("stroke",o.type==="dep"?"var(--blockscape-dep)":"var(--blockscape-revdep)"),m.setAttribute("stroke-opacity",o.depth===1?"0.45":"0.22"),m.setAttribute("stroke-width",o.depth===1?t:n),o.depth>1&&m.setAttribute("stroke-dasharray","4 3"),m.setAttribute("vector-effect","non-scaling-stroke"),W.appendChild(m)})}function yl(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Sl(e,t){if(!e||!t)return null;const n=e.left+e.width/2,o=e.top+e.height/2,i=t.x-n,a=t.y-o;if(i===0&&a===0)return{x:n,y:o};const s=e.width/2,c=e.height/2,u=[];i!==0&&u.push((i>0?s:-s)/i),a!==0&&u.push((a>0?c:-c)/a);const g=Math.min(...u.filter(S=>S>0)),m=Number.isFinite(g)?g:0;return{x:n+i*m,y:o+a*m}}function El(e,t,n=0){if(!e||!t||n<=0)return e;const o=t.left+t.width/2,i=t.top+t.height/2,a=o-e.x,s=i-e.y,c=Math.hypot(a,s);if(!c)return e;const u=Math.min(n,c/2)/c;return{x:e.x+a*u,y:e.y+s*u}}function wi(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Bu(e){const t=(e??"").toString().trim();if(!t)return"";const n=t.endsWith(".md")?t:`${t}.md`,o=new URLSearchParams;return o.set("filepath",n),o.set("data"," "),o.set("mode","append"),Lo&&o.set("vault",Lo),`obsidian://advanced-uri?${o.toString()}`}function $u(e){return e?li===Fi?e.id??e.name??"":e.name??e.id??"":""}function kl(e,{externalMeta:t,seriesIdLookup:n}={}){var i;if(!To||!e||(i=n==null?void 0:n.has)!=null&&i.call(n,e.id))return"";const o=$u(e);return Bu(o)}function Il(e){var t;if(typeof e=="string"){const n=e.trim();if(!n)return{isExternal:!1,url:""};try{const o=new URL(n);return/^https?:/i.test(o.protocol)?{isExternal:!0,url:o.toString()}:{isExternal:!1,url:""}}catch{}if(!/^[a-z][a-z0-9+.-]*:/i.test(n))try{const o=typeof window<"u"&&((t=window.location)!=null&&t.href)?window.location.href:void 0;return{isExternal:!0,url:o?new URL(n,o).toString():n}}catch(o){return console.warn("[Blockscape] invalid external url skipped",e,o),{isExternal:!1,url:""}}return console.warn("[Blockscape] invalid external url skipped",e),{isExternal:!1,url:""}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Ru(e){const t=document.createElement("button");return t.type="button",t.className="external-link obsidian-link",t.setAttribute("aria-label","Open in Obsidian"),t.title=e,t.textContent="O",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Ou(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function _l(e,t){if(!e)return;const n=e.querySelector(".obsidian-link");if(!t){n&&n.remove(),e.removeAttribute("data-obsidian-url");return}if(e.dataset.obsidianUrl=t,n){n.title=t;return}e.appendChild(Ru(t))}function Cl(){be||(be=requestAnimationFrame(()=>{be=null,fe=fe.filter(({labelEl:e,textEl:t})=>(e==null?void 0:e.isConnected)&&(t==null?void 0:t.isConnected)),fe.forEach(({labelEl:e,textEl:t})=>{const n=Math.max(t.scrollWidth-e.clientWidth,0);if(n>4){const o=Math.max(4,Math.min(14,4+n/30));e.classList.add("version-nav__thumb-label--scroll"),t.style.setProperty("--marquee-distance",`${n}px`),t.style.setProperty("--marquee-duration",`${o}s`)}else e.classList.remove("version-nav__thumb-label--scroll"),t.style.removeProperty("--marquee-distance"),t.style.removeProperty("--marquee-duration")})}))}function Pu(e,t){!e||!t||(fe.push({labelEl:e,textEl:t}),Cl())}function Vu(e,t){var a,s;const n=[`<div class="version-nav__tooltip-title">${wi(t)}</div>`],o=((e==null?void 0:e.version)??((a=e==null?void 0:e.data)==null?void 0:a.version)??"").toString().trim();o&&n.push(`<div class="version-nav__tooltip-meta">Version ${wi(o)}</div>`);const i=(((s=e==null?void 0:e.data)==null?void 0:s.abstract)??"").toString().trim();return i?n.push(`<div class="version-nav__tooltip-body">${i}</div>`):n.push('<div class="version-nav__tooltip-body muted">No info available for this version.</div>'),n.join("")}function vi(e,t,{offset:n=8}={}){!Z||!e||!t||(Z.innerHTML=t,Z.hidden=!1,Z.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const o=e.getBoundingClientRect(),i=Z.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let c=o.left+o.width/2-i.width/2+a,u=o.top-i.height-n+s;c<a+n&&(c=a+n);const g=a+window.innerWidth-i.width-n;c>g&&(c=g),u<s+n&&(u=o.bottom+n+s),Z.style.left=`${c}px`,Z.style.top=`${u}px`,Z.classList.add("is-visible")}))}function Fn(){d&&(clearTimeout(d),d=null),Z&&(Z.classList.remove("is-visible"),Z.setAttribute("aria-hidden","true"),Z.hidden=!0)}function Du(e,t){if(!e)return;const n=Ke((t==null?void 0:t.data)||t,"Series version");e.title=n,e.setAttribute("aria-label",n);const o=Vu(t,n);let i=null;const a=()=>{i&&(clearTimeout(i),i=null)},s=()=>{J=e,vi(e,`<div class="version-nav__tooltip-title">${wi(n)}</div>`,{offset:10})},c=()=>{a(),i=setTimeout(()=>{J===e&&vi(e,o,{offset:10})},je)},u=()=>{s(),c()},g=()=>{J!==e&&s(),c()},m=()=>{a(),J===e&&(J=null,Fn())};e.addEventListener("mouseenter",u),e.addEventListener("focus",u),e.addEventListener("pointermove",g),e.addEventListener("mouseleave",m),e.addEventListener("blur",m),e.addEventListener("click",m)}function Uu(){M&&(M=!1,!(!y||!N)&&(Fn(),vi(y,N,{offset:12}),d=setTimeout(()=>{Fn(),Hu()},1e3)))}function Hu(){y&&(E&&(clearTimeout(E),E=null),y.classList.add("blockscape-tab--twinkle"),E=setTimeout(()=>{y.classList.remove("blockscape-tab--twinkle"),E=null},1400))}window.addEventListener("scroll",Fn,!0),window.addEventListener("resize",Fn),Pe&&Pe.addEventListener("click",()=>{du()}),ce&&ce.addEventListener("click",()=>{uu()}),lt&&lt.addEventListener("click",()=>{try{iu(),Qd()}catch(e){console.error("[Blockscape] failed to create blank series",e),alert((e==null?void 0:e.message)||"Unable to create a blank map right now.")}}),pt&&pt.addEventListener("click",qa),R&&R.addEventListener("click",qa),I&&I.addEventListener("click",na),Q&&Q.addEventListener("click",na),_&&_.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");Kn||!t||!_.contains(t)||Jd(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||Kd(e)}),ze&&ze.addEventListener("click",()=>{al("button")}),F&&F.addEventListener("click",()=>{if(w<0){alert("Load or select a model before creating a version.");return}try{const e=il({versionLabel:"map edit"});Ct(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),Ge&&Ge.addEventListener("click",async()=>{var a;if(w<0||!p[w]){alert("Select or load a model before sharing.");return}const e={title:Ke(p[w],"Shared Model"),data:p[w].data};let t;try{t=Oc(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const o=n.toString();try{window.history.replaceState({},document.title,o)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(o),i=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",o)}),q&&q.addEventListener("click",()=>{const e=(h.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};G&&(n.selectedItemId=G),localStorage.setItem(ct,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";G&&(t=`editor.html?selected=${encodeURIComponent(G)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==ct||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||hl("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===Bt&&hl("message")})),document.addEventListener("keydown",e=>{var o,i,a,s,c,u,g,m,S,O;if(cu()){e.key==="Escape"&&(e.preventDefault(),qa());return}if(!(X!=null&&X.hidden)&&e.key==="Escape"){e.preventDefault(),na();return}if((o=fo==null?void 0:fo.isOpen)==null?void 0:o.call(fo))return;const n=Kn;if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const T=p[w],L=((i=T==null?void 0:T.apicurioVersions)==null?void 0:i.length)>1;al("shortcut",L);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!ho())return;if(Xu()){e.preventDefault();return}}if(e.key==="Escape"){let T=!1;ne&&!ne.hidden&&(mo(),T=!0),(G||Je)&&(Xo(),T=!0),T&&e.preventDefault()}if(e.key==="ArrowLeft"||e.key==="ArrowRight"){if(n||!ho())return;const T=e.key==="ArrowLeft"?-1:1;if(e.altKey)return;if(bt&&e.shiftKey&&G&&!e.ctrlKey&&!e.metaKey&&Fd(G,T)){e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&!e.shiftKey){Xa(T)&&e.preventDefault();return}if(e.ctrlKey||e.metaKey)return;if(Je&&!e.shiftKey){e.preventDefault();return}e.shiftKey?zu(T)&&e.preventDefault():Gu(T)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(n||!ho())return;const T=e.key==="ArrowUp"?-1:1;if((e.ctrlKey||e.metaKey)&&!e.altKey){Yu(T)&&e.preventDefault();return}if(e.altKey)return;if(Je&&!G&&!e.shiftKey){if(Ku(T)){e.preventDefault();return}if(Nu(T)){e.preventDefault();return}}e.shiftKey?qu(T)&&e.preventDefault():Ju(T)&&e.preventDefault()}if(e.key==="Delete"){if(n||!ho()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;const T=Je?ep():!1,L=T?!0:Al();(T||L)&&e.preventDefault()}if(e.key==="F2"){if(n||!ho())return;const T=Je&&!G&&Je||!G&&((u=(c=(s=(a=e.target)==null?void 0:a.closest)==null?void 0:s.call(a,".category"))==null?void 0:c.dataset)==null?void 0:u.cat)||null;if(T&&!G&&ju(T)){e.preventDefault();return}const L=G||((O=(S=(m=(g=e.target)==null?void 0:g.closest)==null?void 0:m.call(g,".tile"))==null?void 0:S.dataset)==null?void 0:O.id);L&&fo.open(L)&&e.preventDefault()}if(e.key==="Insert"){if(n||!ho()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;xl()&&e.preventDefault()}}),window.addEventListener("resize",()=>{qd()}),window.addEventListener("scroll",()=>Yd(),!0);function Fu(e,t,n){if(w<0)return;const i=p[w].data.categories||[],a=i.find(m=>(m.items||[]).some(S=>S.id===e)),s=i.find(m=>m.id===n);if(!a||!s)return;a.items=a.items||[],s.items=s.items||[];const c=a.items.findIndex(m=>m.id===e);if(c===-1)return;const[u]=a.items.splice(c,1);let g=s.items.length;if(t){const m=s.items.findIndex(S=>S.id===t);m!==-1&&(g=m)}s.items.splice(g,0,u),xt(),St()}function Wu(e){if(w<0||!e)return;const t=p[w].data,o=(t.categories||[]).find(u=>u.id===e);if(!o)return;o.items=o.items||[];const i=`New item ${o.items.length+1}`,s={id:Wd(`${e}-${o.items.length+1}`,t),name:i,deps:[]};o.items.push(s),xt(),St(),mo(),yt(s.id);const c=st.get(s.id);c!=null&&c.el&&c.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",s.id,"to",e)}function xl(){if(w<0)return!1;const e=p[w].data;e.categories=e.categories||[];const t=`New category ${e.categories.length+1}`,n=jd(t,e),o={id:n,title:t,items:[]};return e.categories.push(o),Je=n,G=null,_t=null,at=null,xt(),St(),Hn(n),console.log("[Blockscape] added category",n),!0}function ju(e=bi()){if(w<0||!e)return!1;const t=Gd.open(e);return t&&(G=null,_t=null,Zt()),t}function zu(e){if(!G||w<0||!e)return!1;const n=p[w].data.categories||[],o=st.get(G);let i=null;if(o!=null&&o.catId&&(i=n.find(u=>u.id===o.catId)),i||(i=n.find(u=>(u.items||[]).some(g=>g.id===G))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(u=>u.id===G);if(a===-1)return!1;const s=a+e;if(s<0||s>=i.items.length)return!1;const[c]=i.items.splice(a,1);return i.items.splice(s,0,c),xt(),St(),gi(),yt(G),!0}function Gu(e){if(!ee||!ee.m||!e)return!1;const t=ee.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(g=>(g.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!G){const u=n();return u?(yt(u.item.id),!0):!1}const o=st.get(G);let i=null;if(o!=null&&o.catId&&(i=t.find(u=>u.id===o.catId)),i||(i=t.find(u=>(u.items||[]).some(g=>g.id===G))),!i){const u=n();return u?(yt(u.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const s=a.findIndex(u=>u.id===G);if(s===-1)return!1;const c=s+e;return c<0||c>=a.length?!1:(yt(a[c].id),!0)}function Ju(e){if(!ee||!ee.m||!e)return!1;const t=ee.m.categories||[];if(!t.length)return!1;const n=bi();let o=t.findIndex(s=>s.id===n),i=o+e;if(o===-1&&(i=e>0?0:t.length-1),i<0||i>=t.length)return!1;const a=t[i];if(G){const c=(t[o].items||[]).findIndex(u=>u.id===G);at={catId:a.id,position:c===-1?0:c}}else at=null;return Hn(a.id,{preserveEntryHint:!0})}function Ku(e){var a;if(!Je||!((a=ee==null?void 0:ee.m)!=null&&a.categories)||!e)return!1;const n=(ee.m.categories||[]).find(s=>s.id===Je);if(!n)return!1;const o=n.items||[];if(!o.length)return!1;let i=e>0?0:Math.max(0,o.length-1);return(at==null?void 0:at.catId)===n.id&&(i=Math.min(o.length-1,Math.max(0,at.position||0))),at=null,yt(o[i].id),!0}function qu(e){if(!G||w<0||!e)return!1;const n=p[w].data.categories||[];if(!n.length)return!1;const o=st.get(G);let i=-1;if(o!=null&&o.catId&&(i=n.findIndex(S=>S.id===o.catId)),i===-1&&(i=n.findIndex(S=>(S.items||[]).some(O=>O.id===G))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const s=n[i],c=n[a];if(!c)return!1;s.items=s.items||[],c.items=c.items||[];const u=s.items.findIndex(S=>S.id===G);if(u===-1)return!1;const g=Math.min(c.items.length,Math.max(0,u)),m=g<c.items.length?c.items[g].id:null;return Fu(G,m,c.id),gi(),yt(G),!0}function Yu(e){if(w<0||!e)return!1;const n=p[w].data.categories||[];if(!n.length)return!1;const o=bi();if(!o)return!1;const i=n.findIndex(c=>c.id===o);if(i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const[s]=n.splice(i,1);return n.splice(a,0,s),Je=s.id,Za(),at=null,Zt(),xt(),St(),Yo(),console.log("[Blockscape] moved category",s.id,"from",i,"to",a),!0}function Xu(){if(w<0)return!1;const e=p[w],t=wt(e)||(e?e.id:null),n=[];if($t&&t===$t.modelId&&n.push({...$t,type:"item"}),pn&&t===pn.modelId&&n.push({...pn,type:"category"}),!n.length)return!1;const o=n.reduce((i,a)=>i?(a.ts||0)>(i.ts||0)?a:i:a,null);if(!o)return!1;if(o.type==="category"){if(Qu(o))return!0}else if(o.type==="item"&&Zu(o))return!0;return!1}function Zu(e){const t=p[w],n=wt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const a=(t.data.categories||[]).find(c=>c.id===e.categoryId);if(!a)return!1;a.items=a.items||[];const s=Math.min(Math.max(e.index,0),a.items.length);return a.items.splice(s,0,e.item),$t=null,mo(),G=null,_t=null,Zt(),xt(),St(),gi(),yt(e.item.id),console.log("[Blockscape] undo delete restored",e.item.id),!0}function Qu(e){const t=p[w],n=wt(t)||(t?t.id:null);if(!t||n!==e.modelId)return!1;const o=t.data;o.categories=o.categories||[];const i=Math.min(Math.max(e.index,0),o.categories.length);return o.categories.splice(i,0,e.category),pn=null,G=null,_t=null,Je=e.category.id,at=null,Zt(),xt(),St(),Yo(),Hn(e.category.id),console.log("[Blockscape] undo delete restored category",e.category.id),!0}function Al(){if(!G||w<0)return!1;const t=p[w].data.categories||[];if(!t.length)return!1;const n=st.get(G);let o=null;if(n!=null&&n.catId&&(o=t.find(g=>g.id===n.catId)),o||(o=t.find(g=>(g.items||[]).some(m=>m.id===G))),!o||!Array.isArray(o.items))return!1;const i=o.items.findIndex(g=>g.id===G);if(i===-1)return!1;const a=o.items.splice(i,1)[0];if(!a)return!1;const s=p[w];$t={item:a,categoryId:o.id,index:i,modelId:wt(s)||(s?s.id:null),ts:Date.now()};const u=(()=>{var m;if(o.items.length){const S=Math.min(i,o.items.length-1);return((m=o.items[S])==null?void 0:m.id)||null}const g=t.findIndex(S=>S.id===o.id);if(g===-1)return null;for(let S=g+1;S<t.length;S++){const O=t[S].items||[];if(O.length)return O[0].id}for(let S=g-1;S>=0;S--){const O=t[S].items||[];if(O.length)return O[0].id}return null})();return mo(),G=null,_t=null,at=null,Zt(),xt(),St(),gi(),u?yt(u):Xo(),console.log("[Blockscape] removed item",a.id),!0}function ep(){var c,u;const e=bi();if(!e||w<0)return!1;const n=p[w].data.categories||[];if(!n.length)return!1;const o=n.findIndex(g=>g.id===e);if(o===-1)return!1;const[i]=n.splice(o,1);if(!i)return!1;const a=p[w];pn={category:i,index:o,modelId:wt(a)||(a?a.id:null),ts:Date.now()},Je=null,G=null,_t=null,at=null,Zt(),xt(),St();const s=((c=n[o])==null?void 0:c.id)||((u=n[o-1])==null?void 0:u.id)||null;return s?Hn(s):Xo(),console.log("[Blockscape] removed category",i.id),!0}function tp(e){if(!e)return!1;const t=G;G=e;const n=Al();return n||(G=t,Zt()),n}ve&&ve.addEventListener("click",async()=>{const e=h.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await Us(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),$&&$.addEventListener("click",async()=>{const e=eu();if(!e){alert("No series available to copy. Create another version first.");return}await Us(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),ke&&ke.addEventListener("click",async()=>{try{const e=await id();if(!e){alert("Clipboard is empty.");return}h.value=e,h.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=async()=>{try{const e=await hi(),t=Dn(h.value,"Pasted",{promptForSeriesName:!e});if(!t.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",t.length,"model(s)");let n=null;const o=[];t.forEach((i,a)=>{const s=Ln(i,{versionLabel:t.length>1?`paste #${a+1}`:"paste"});n==null&&(n=s),o.push(s)}),w===-1&&n!=null?Ct(n):Vn(),e&&await Tl(o,{origin:"append"})}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{var e;if(w<0){alert("No active model selected.");return}try{const t=JSON.parse(h.value);if(Tn(t,{titleHint:Ke(p[w]),idHint:wt(p[w])||Ke(p[w])}),p[w].data=t,p[w].title=t.title||p[w].title,p[w].isSeries||((e=p[w].apicurioVersions)==null?void 0:e.length)>1){const n=p[w].title||Ke(p[w]);Vt(p[w],{seriesName:n,fallbackTitle:n})}za(),console.log("[Blockscape] replaced active model:",Ke(p[w])),St(),ht.updateAvailability()}catch(t){console.error("[Blockscape] replace error:",t),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const o of t){const i=await o.text(),a=o.name.replace(/\.[^.]+$/,"")||"File",s=Dn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models in file:",o.name);continue}s.forEach((c,u)=>{var P;const g=(((P=c.data)==null?void 0:P.title)??"").toString().trim(),m=s.length>1?`${o.name} #${u+1}`:o.name,S=`${a} series`,O=c.isSeries?S:null;let T={...c};if(c.isSeries){const te=O||g||c.title||m||"unknown";T.title=te;const Me=En(te||"unknown");po(T,Me),Vt(T,{seriesName:te,fallbackTitle:"unknown"}),T.apicurioArtifactName=T.apicurioArtifactName||te}else T.title=g||m;const L=Ln({...T,apicurioArtifactName:T.apicurioArtifactName||O||T.apicurioArtifactName},{versionLabel:o.name});n==null&&(n=L)})}w===-1&&n!=null?Ct(n):Vn()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",np);async function np(e){var a;if(!ho())return;const t=((a=e.clipboardData)==null?void 0:a.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!vu(t))return;let n=[];try{const s=await hi();n=Dn(t,"Clipboard",{promptForSeriesName:!s})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let o=null;const i=[];n.forEach((s,c)=>{const u=Ln(s,{versionLabel:n.length>1?`paste #${c+1}`:"paste"});o==null&&(o=u),i.push(u)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),o!=null&&Ct(o),await hi()&&await Tl(i,{origin:"clipboard"})}async function Tl(e,{origin:t="clipboard"}={}){if(!await hi()||typeof(qe==null?void 0:qe.saveModelByIndex)!="function")return;const o=(Array.isArray(e)?e:[]).filter(O=>{const T=p[O];return T&&!T.sourcePath});if(!o.length)return;const i=o.length===1?"model":"models",a=p[o[0]],s=cd(a,t==="append"?"pasted":"clipboard");if(typeof window>"u"||typeof window.prompt!="function")return;const c=window.prompt(`Save pasted ${i} as a new .bs file (under ~/blockscape):`,s);if(c==null)return;const u=uo(c);if(!u){alert("Enter a relative filename (no ..) to save under ~/blockscape.");return}const g=await sd(),m=[];for(let O=0;O<o.length;O++){const T=o.length===1?u:rd(u,O+1),L=ld(T,g);if(!L){alert("Could not find a unique filename to save.");return}g.add(L),m.push(L)}let S=null;for(let O=0;O<o.length;O++){const T=o[O],L=m[O],P=p[T];if(!P)continue;o.length===1&&dd(P,L);const te=await qe.saveModelByIndex(T,L,{refreshAfter:!1,statusPrefix:"Auto-saved to"});if(!(te!=null&&te.ok)){alert(`Local auto-save failed: ${(te==null?void 0:te.error)||"unknown error"}`);return}S==null&&(S=L)}S&&(Yi(S),Xc(S,{origin:t})),await qe.refresh(),Vn(),dn(`Saved ${o.length} ${i}.`,2500)}z.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&Ct(n)}),document.getElementById("removeModel").onclick=()=>{if(w<0)return;const e=Ke(p[w]);if(!window.confirm(`Remove "${e}" from this session?`))return;if(console.log("[Blockscape] removing model:",Ke(p[w])),p.splice(w,1),!p.length){w=-1,ee=null,_.innerHTML="",W.innerHTML="",h.value="",Vn(),za();return}const n=Math.min(w,p.length-1);Ct(n)},ye&&(ye.addEventListener("input",e=>{dl(e.target.value||"")}),ye.addEventListener("focus",()=>{ye.value&&ye.value.trim()&&cl(ye.value)})),ge&&ge.addEventListener("click",e=>{const t=e.target.closest(".search-result");if(!t)return;const n=parseInt(t.dataset.modelIndex||"-1",10),o=t.dataset.itemId;mu({modelIndex:n,itemId:o})}),document.addEventListener("click",e=>{if(!ge||ge.hidden)return;const t=e.target;ge.contains(t)||ye&&(t===ye||ye.contains(t))||(ge.hidden=!0)}),C&&se&&j&&C.addEventListener("submit",async e=>{e.preventDefault();const t=se.value.trim();if(!t){alert("Please enter a URL"),se.focus();return}const n=await er(t);if(typeof n=="number"){Ct(n),se.value="";const o=document.getElementById("urlHint");o&&(o.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!se||!t)return;let n=null;se.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=se.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function St(){if(!(w<0))try{oa(p[w]),ee=ku(p[w].data),gi()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function op(){const e=["comms.bs","planets.bs","styleguide.bs","blockscape-features.bs"],t=n=>Hi?Hi.endsWith("/")?`${Hi}${n}`:`${Hi}/${n}`:n;for(const n of e)try{const o=await fetch(t(n),{cache:"no-store"});if(!o.ok){console.warn(`[Blockscape] ${n} not fetched (${o.status}); skipping`);continue}const i=await o.text(),a=n.replace(/\.[^.]+$/,"")||"Model",s=Dn(i,a,{seriesTitleOverride:`${a} series`});if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(c=>{let u={...c};if(c.isSeries){const g=`${a} series`;u={...c,title:g,apicurioArtifactName:g};const m=En(g||"unknown");po(u,m),Vt(u,{seriesName:g,fallbackTitle:"unknown"})}Ln(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(o){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",o)}Vn()}async function Ll(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const o of t)try{console.log(`[Blockscape] fetching ${e} with cache="${o.cache??"default"}"`);const i=await fetch(e,o);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function ip(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(o=>ap(o)),e.querySelectorAll("a[href]").forEach(o=>{const i=o.getAttribute("href");Ml(i)&&Nl(o,i)})}function ap(e){var c,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(c=e.parentNode)==null?void 0:c.closest)!=null&&u.call(c,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,o=[];let i;for(;(i=n.exec(t))!==null;)o.push({url:i[0],index:i.index});if(!o.length)return;const a=document.createDocumentFragment();let s=0;o.forEach(({url:g,index:m})=>{m>s&&a.appendChild(document.createTextNode(t.slice(s,m))),a.appendChild(rp(g)),s=m+g.length}),s<t.length&&a.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(a,e)}function rp(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Ml(e)&&Nl(t,e),t}function Nl(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>sp(n,t,e)))}async function sp(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await er(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Ml(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function er(e){try{console.log("[Blockscape] loading from URL:",e);const t=await Ll(e),o=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=Dn(t,o)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let a=null;return i.forEach((s,c)=>{var T;const u=(((T=s.data)==null?void 0:T.title)??"").toString().trim(),g=i.length>1?`${o} #${c+1}`:o,m=s.isSeries?`${o} series`:null;let S={...s};if(s.isSeries){const L=m||u||S.title||g;S={...s,title:L,apicurioArtifactName:L||s.apicurioArtifactName};const P=En(L||"unknown");po(S,P),Vt(S,{seriesName:L||m||"unknown",fallbackTitle:"unknown"}),console.log("[Blockscape] loadFromUrl: series slug applied",{seriesSlug:P,url:e,baseName:o,seriesTitle:L})}const O=Ln({...S,title:u||S.title||g,apicurioArtifactName:S.apicurioArtifactName||m||s.apicurioArtifactName},{versionLabel:o});a==null&&(a=O)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,o),w===-1&&a!=null?Ct(a):Vn(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const o=Dn(n,"Blockscape");if(!o.length)throw new Error("Seed template could not be parsed.");let i=null;o.forEach(T=>{const L=Ln(T,{versionLabel:"seed"});i==null&&(i=L)}),await Dc(),!await Ts&&l.autoLoadFromDir&&await op();const s=await Su(),c=typeof(s==null?void 0:s.modelIndex)=="number"?s.modelIndex:null,u=await Eu(),g=ml(),m=g==null?void 0:g.index,S=yu(),O=typeof c=="number"?c:typeof u=="number"?u:typeof S=="number"?S:typeof m=="number"?m:i??0;Ct(O),s!=null&&s.itemId&&typeof s.modelIndex=="number"&&s.modelIndex===O&&requestAnimationFrame(()=>{var L;if(w!==s.modelIndex)return;const T=(L=st.get(s.itemId))==null?void 0:L.el;T&&(yt(s.itemId),T.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),T.focus({preventScroll:!0}))})})()}const gc=r=>typeof r=="string"&&r.endsWith("/")?r:`${r||"/"}/`;function bc(){if(typeof window>"u"||!window.location)return"/";const r=(window.location.pathname||"/").split("/").filter(Boolean);return!r.length||r[0].toLowerCase()==="server"?"/":`/${r[0]}/`}function wc(r){return gc(bc())}const vc=`${wc()}documentation/`;function yc(r){let l;return{c(){l=H("div"),l.innerHTML=`<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Help</h2></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <section class="shortcut-help__section"><ul class="shortcut-help__tips"><li>Play around with the example maps.</li> <li>Open the <a href="${vc}">documentation</a>.</li> <li>Read about <a href="https://www.wardleymaps.com" target="_blank" rel="noreferrer noopener">Wardley Maps</a>.</li> <li>Copy this URL and use &quot;Load URL&quot;: <a href="https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs" target="_blank" rel="noreferrer noopener">https://gist.githubusercontent.com/pwright/86dbb074b35d6d17671bf17ecbf1a824/raw/git.bs</a></li> <li>Edit maps by moving items with Shift + Arrow keys.</li></ul></section> <section class="shortcut-help__section"><h3 class="shortcut-help__section-title">Keyboard shortcuts</h3> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></section></div>`,v(l,"id","shortcutHelp"),v(l,"class","shortcut-help"),l.hidden=!0,v(l,"aria-hidden","true"),v(l,"role","dialog"),v(l,"aria-modal","true"),v(l,"aria-labelledby","shortcutHelpTitle")},m(h,A){It(h,l,A)},p:Nt,i:Nt,o:Nt,d(h){h&&vt(l)}}}class Sc extends Di{constructor(l){super(),Vi(this,l,null,yc,Bi,{})}}const Ec=`Generate a blockscape [map|series] for the domain of [DOMAIN]

### Requirements

* Output **valid JSON only** with the structure below (no commentary):

  * Model level:
    * \`id\`: required string, short/sluggy (lowercase, hyphen/underscore ok)
    * \`title\`: required string, human‑friendly model title
    * \`abstract\`: optional string (plain text or simple HTML) that explains the landscape
    * \`categories\`: array of category objects

  * Each category has:
    * \`id\` (short, lowercase, unique)
    * \`title\` (human‑friendly)
    * \`items\`: array of component objects

      * each item has:
        * \`id\` (short, lowercase, unique across all categories)
        * \`name\` (human‑friendly)
        * optional \`logo\` (e.g., \`"logos/[slug].svg"\`)
        * optional \`external\` (string URL) pointing to external documentation or reference material for that item
        * optional \`color\` (hex string) for tile tint
        * optional \`deps\`: array of item \`id\`s this item **depends on** (when present, must reference defined items only)
        * optional \`stage\`: integer 1–4 for Wardley maps only (1=genesis, 2=custom, 3=product, 4=commodity/service). Include only when the user explicitly asks for a Wardley model/series.
* Use **3–6/7 categories** and **2–6/7 items per category**. Prefer clarity over exhaustiveness.
* Order categories roughly from **abstract to concrete**.
* Model **visible user value** via **vertical position** (things closer to the user are higher). Ensure \`deps\` reflect a flow from higher‑value items to their underlying enablers.
* (Optional) You may imply **horizontal evolution/maturity** via category naming or item grouping. Only include the \`stage\` field when explicitly asked for a Wardley map/series.
* Keep all identifiers **ASCII**, hyphen‑separated where needed.

### Domain Guidance

In **[one paragraph]**, summarize the domain’s user‑visible goals and the key enabling components. Use that understanding to choose categories and dependencies.

### Output

If the user asks for a 'series', create an array of json using the following criteria.

Return **only the JSON** matching this schema:

\`\`\`
{
  "id": "[model-id]",
  "title": "[Model Title]",
  "abstract": "[Short description or HTML snippet, optional]",
  "categories": [
    {
      "id": "[category-id]",
      "title": "[Category Title]",
      "items": [
        { "id": "[item-id]", "name": "[Item Name]", "deps": ["[id]"] }
      ]
    }
  ]
}
\`\`\`

### Validation Checklist (the model should self‑check before returning):

* Top-level \`id\` and \`title\` are present and non-empty; if \`abstract\` is provided, it is non-empty.
* All provided \`deps\` reference **existing** item IDs.
* No duplicate \`id\`s across all items.
* 3–6/7 categories; each has 2–6/7 items.
* JSON parses.

---

## One‑shot Example (Machine Learning Model Deployment)

**Prompt to paste**

Generate a **Blockscape value‑chain JSON** for the domain of **machine learning model deployment**.

### Requirements

* Output **valid JSON only** with this structure (no commentary).
* Use **3 - 6/7 categories**, **3–6/7 items each**.
* Order from abstract (user‑facing) to concrete (infrastructure).
* Vertical axis is **visible user value**; \`deps\` should point from user‑visible items down to enablers they rely on.
* Optional \`logo\` paths may use placeholders like \`"logos/[slug].svg"\`.

### Domain Guidance

Users need **reliable predictions** surfaced via **APIs/UI**, backed by **versioned models**, **observability**, and **scalable infra**. Security and governance span across.

### Output (JSON only)

\`\`\`
{
  "categories": [
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "prediction-api", "name": "Prediction API", "deps": ["model-serving", "authz"], "external": "https://example.com/api.html"},
        { "id": "batch-scoring", "name": "Batch Scoring", "deps": ["feature-store", "orchestration"] },
        { "id": "ui-console", "name": "Ops Console", "deps": ["monitoring", "logging"] }
      ]
    },
    {
      "id": "models",
      "title": "Models & Data",
      "items": [
        { "id": "model-serving", "name": "Model Serving", "deps": ["container-runtime", "autoscaling"] },
        { "id": "model-registry", "name": "Model Registry", "deps": ["artifact-store"] },
        { "id": "feature-store", "name": "Feature Store", "deps": ["data-pipelines"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "monitoring", "name": "Monitoring", "deps": ["metrics-backend"] },
        { "id": "logging", "name": "Logging", "deps": ["log-backend"] },
        { "id": "authz", "name": "AuthN/Z", "deps": ["secrets"] },
        { "id": "orchestration", "name": "Orchestration", "deps": ["container-runtime"] }
      ]
    },
    {
      "id": "infrastructure",
      "title": "Infrastructure",
      "items": [
        { "id": "autoscaling", "name": "Autoscaling", "deps": ["metrics-backend"] },
        { "id": "container-runtime", "name": "Container Runtime", "deps": [] },
        { "id": "artifact-store", "name": "Artifact Store", "deps": [] },
        { "id": "data-pipelines", "name": "Data Pipelines", "deps": [] },
        { "id": "metrics-backend", "name": "Metrics Backend", "deps": [] },
        { "id": "log-backend", "name": "Log Backend", "deps": [] },
        { "id": "secrets", "name": "Secrets Management", "deps": [] }
      ]
    }
  ]
}
\`\`\`

---

## Tips

* Keep **names** user‑friendly; keep **ids** short and consistent.
* If an item feels too broad, introduce a new category rather than bloating \`deps\`.
* If there's a link (external), use the favicon from the website as logo
* If you’re unsure about \`logo\`, omit it; you can add paths later.

The following map shows color conventions:

\`\`\`
{
  "id": "conventions",
  "title": "Color Conventions",
  "abstract": "Reference for color conventions.",
  "categories": [
    {
      "id": "color-conventions",
      "title": "Color conventions",
      "items": [
        {
          "id": "old",
          "name": "Old",
          "color": "#000000",
          "deps": []
        },
        {
          "id": "new",
          "name": "New",
          "color": "#FFFFFF",
          "deps": []
        },
        {
          "id": "important",
          "name": "Important",
          "deps": [],
          "color": "#FF0000"
        }
      ]
    }
  ]
}
\`\`\`
`;function es(r){let l,h,A,_,W,Z,z,ne;return{c(){l=H("div"),h=H("div"),A=H("a"),_=ga("Open Blockscape GPT"),W=ue(),Z=H("div"),Z.textContent="Paste the copied prompt into that chat.",z=ue(),ne=H("div"),ne.innerHTML='<span>Gem is not available yet</span> <div class="new-panel__hint">https://gemini.google.com/gems/create</div>',v(A,"href",Ic),v(A,"target","_blank"),v(A,"rel","noreferrer"),v(Z,"class","new-panel__hint"),v(h,"class","new-panel__link"),v(ne,"class","new-panel__link new-panel__link--disabled"),v(l,"class","new-panel__links")},m(C,se){It(C,l,se),x(l,h),x(h,A),x(A,_),x(h,W),x(h,Z),x(l,z),x(l,ne)},p:Nt,d(C){C&&vt(l)}}}function ts(r){let l,h,A,_,W,Z;return{c(){l=H("div"),h=H("div"),h.textContent="Generated prompt",A=ue(),_=H("textarea"),v(h,"class","new-panel__prompt-label"),v(_,"class","pf-v5-c-form-control new-panel__textarea"),v(_,"rows","4"),_.readOnly=!0,v(l,"class","new-panel__prompt")},m(z,ne){It(z,l,ne),x(l,h),x(l,A),x(l,_),oo(_,r[4]),W||(Z=no(_,"input",r[12]),W=!0)},p(z,ne){ne&16&&oo(_,z[4])},d(z){z&&vt(l),W=!1,Z()}}}function kc(r){let l,h,A,_,W,Z,z,ne,C,se,j,re,Ne,ot,Xe,ze,Ge,F,q,ve,$,ke,Pe,ce,lt,le,he,pt,R,X,I,Q,ye,ge,Se,Be,b,Le,tt,it,We,rt,Mt,mt,$e,ct,Bt,Ie=r[2]==="gpt"&&es(),Qe=r[4]&&r[5]&&ts(r);return $e=Gl(r[10][0]),{c(){l=H("div"),h=H("div"),A=ue(),_=H("div"),W=H("div"),W.innerHTML='<div class="shortcut-help__title"><h2 id="newPanelTitle">New blockscape</h2> <p class="shortcut-help__subtitle">Describe what you need and we will create a prompt for you.</p></div> <button id="newPanelClose" class="shortcut-help__close" type="button" aria-label="Close new panel">×</button>',Z=ue(),z=H("form"),ne=H("div"),C=H("label"),C.textContent="Domain",se=ue(),j=H("p"),j.textContent="Describe what you want to create a map for.",re=ue(),Ne=H("textarea"),ot=ue(),Xe=H("div"),ze=H("label"),Ge=H("input"),F=ue(),q=H("span"),q.innerHTML=`Series
            <span class="new-panel__hint">Toggle on to create a series instead of a single map.</span>`,ve=ue(),$=H("fieldset"),ke=H("legend"),ke.textContent="Target",Pe=ue(),ce=H("p"),ce.textContent="Choose where you plan to use the prompt.",lt=ue(),le=H("label"),he=H("input"),pt=ue(),R=H("div"),R.innerHTML='<div class="new-panel__option-title">GPT or Gem</div> <div class="new-panel__hint">Copies a simple prompt tailored for GPT or Gem.</div>',X=ue(),I=H("label"),Q=H("input"),ye=ue(),ge=H("div"),ge.innerHTML='<div class="new-panel__option-title">Plain LLM</div> <div class="new-panel__hint">Creates a large prompt to generate blockscape from scratch.</div>',Se=ue(),Be=H("div"),b=H("button"),b.textContent="Copy prompt",Le=ue(),tt=H("button"),tt.textContent="New blank",it=ue(),We=H("div"),rt=ga(r[3]),Mt=ue(),Ie&&Ie.c(),mt=ue(),Qe&&Qe.c(),v(h,"id","newPanelBackdrop"),v(h,"class","shortcut-help__backdrop"),v(W,"class","shortcut-help__header"),v(C,"for","newDomain"),v(j,"class","new-panel__hint"),v(Ne,"id","newDomain"),v(Ne,"class","pf-v5-c-form-control new-panel__textarea"),v(Ne,"rows","4"),Ne.required=!0,v(Ne,"placeholder","Ex: Companies building open-source geospatial tools"),v(ne,"class","new-panel__field"),v(Ge,"id","seriesToggle"),v(Ge,"type","checkbox"),v(ze,"class","new-panel__toggle"),v(ze,"for","seriesToggle"),v(Xe,"class","new-panel__field"),v(ce,"class","new-panel__hint"),v(he,"type","radio"),v(he,"name","target"),he.__value="gpt",oo(he,he.__value),v(le,"class","new-panel__option"),v(Q,"type","radio"),v(Q,"name","target"),Q.__value="plain",oo(Q,Q.__value),v(I,"class","new-panel__option"),v($,"class","new-panel__field"),v(b,"class","pf-v5-c-button pf-m-primary"),v(b,"type","submit"),v(tt,"id","newBlankButton"),v(tt,"class","pf-v5-c-button pf-m-secondary"),v(tt,"type","button"),v(tt,"title","Start from an empty map"),v(We,"class","new-panel__status"),v(We,"aria-live","polite"),v(Be,"class","new-panel__actions"),v(z,"class","shortcut-help__list new-panel__form"),v(_,"class","shortcut-help__panel"),v(_,"tabindex","-1"),v(l,"id","newPanel"),v(l,"class","shortcut-help"),l.hidden=!0,v(l,"aria-hidden","true"),v(l,"role","dialog"),v(l,"aria-modal","true"),v(l,"aria-labelledby","newPanelTitle"),$e.p(he,Q)},m(p,w){It(p,l,w),x(l,h),x(l,A),x(l,_),x(_,W),x(_,Z),x(_,z),x(z,ne),x(ne,C),x(ne,se),x(ne,j),x(ne,re),x(ne,Ne),oo(Ne,r[0]),x(z,ot),x(z,Xe),x(Xe,ze),x(ze,Ge),Ge.checked=r[1],x(ze,F),x(ze,q),x(z,ve),x(z,$),x($,ke),x($,Pe),x($,ce),x($,lt),x($,le),x(le,he),he.checked=he.__value===r[2],x(le,pt),x(le,R),x($,X),x($,I),x(I,Q),Q.checked=Q.__value===r[2],x(I,ye),x(I,ge),x(z,Se),x(z,Be),x(Be,b),x(Be,Le),x(Be,tt),x(Be,it),x(Be,We),x(We,rt),x(z,Mt),Ie&&Ie.m(z,null),x(z,mt),Qe&&Qe.m(z,null),ct||(Bt=[no(Ne,"input",r[7]),no(Ge,"change",r[8]),no(he,"change",r[9]),no(Q,"change",r[11]),no(z,"submit",zl(r[6]))],ct=!0)},p(p,[w]){w&1&&oo(Ne,p[0]),w&2&&(Ge.checked=p[1]),w&4&&(he.checked=he.__value===p[2]),w&4&&(Q.checked=Q.__value===p[2]),w&8&&Kl(rt,p[3]),p[2]==="gpt"?Ie?Ie.p(p,w):(Ie=es(),Ie.c(),Ie.m(z,mt)):Ie&&(Ie.d(1),Ie=null),p[4]&&p[5]?Qe?Qe.p(p,w):(Qe=ts(p),Qe.c(),Qe.m(z,null)):Qe&&(Qe.d(1),Qe=null)},i:Nt,o:Nt,d(p){p&&vt(l),Ie&&Ie.d(),Qe&&Qe.d(),$e.r(),ct=!1,ni(Bt)}}}const Ic="https://chatgpt.com/g/g-690f6217889c819191786ef16481f534-blockscape";function _c(r,l,h){let A="",_=!1,W="gpt",Z="",z="",ne=!1;const C=()=>{var F;return typeof navigator<"u"&&!!((F=navigator.clipboard)!=null&&F.writeText)};function se(F){const q=F||"[DOMAIN]",ve=_?"series":"map",ke=Ec.replaceAll("[DOMAIN NAME]",q).replaceAll("[DOMAIN]",q).replaceAll("[map|series]",ve).split(`
`),Pe=`Generate a **blockscape ${ve}** for the domain of ${q}.`,ce=ke.findIndex(le=>le.toLowerCase().includes("generate a **blockscape value")||le.toLowerCase().includes("generate a blockscape [map|series]")||le.toLowerCase().startsWith("generate a blockscape"));ce>=0?ke[ce]=Pe:ke.unshift(Pe);const lt=_?`

User requested a series (return an array of models).`:"";return`${ke.join(`
`).trim()}${lt}`}async function j(F){F.preventDefault();const q=A.trim();if(h(3,Z=""),h(5,ne=W!=="gpt"),!q){h(3,Z="Add a domain to generate a prompt."),h(4,z="");return}if(W==="gpt"?h(4,z=`${_?"Create a series":"Create a map"} for ${q}`):(h(4,z=se(q)),h(5,ne=!0)),!C()){h(3,Z="Clipboard access is unavailable. Copy the prompt below."),h(5,ne=!0);return}try{await navigator.clipboard.writeText(z),h(3,Z=W==="gpt"?"Prompt copied. Open the Blockscape GPT link to paste it.":"Prompt copied to clipboard."),W==="gpt"&&h(5,ne=!1)}catch($){console.warn("[Blockscape] clipboard write failed",$),h(3,Z="Copy failed. Use the prompt below."),h(5,ne=!0)}}const re=[[]];function Ne(){A=this.value,h(0,A)}function ot(){_=this.checked,h(1,_)}function Xe(){W=this.__value,h(2,W)}function ze(){W=this.__value,h(2,W)}function Ge(){z=this.value,h(4,z)}return[A,_,W,Z,z,ne,j,Ne,ot,Xe,re,ze,Ge]}class Cc extends Di{constructor(l){super(),Vi(this,l,_c,kc,Bi,{})}}const{document:ns}=jl;function xc(r){let l,h,A,_,W,Z,z,ne,C,se,j,re,Ne,ot,Xe,ze,Ge,F,q,ve,$,ke,Pe,ce,lt,le,he,pt,R,X,I,Q,ye,ge,Se,Be,b,Le,tt,it,We,rt,Mt,mt,$e,ct,Bt,Ie,Qe,p,w,ht,ee,st,kn,G,Je,_t,at,Jt,Kn,Dt,qn,$t,pn,fn,$n,ao,sn,ln,Kt,en,Ut,qt,cn,d=`<script id="seed" type="application/json">${r[4]}<\/script>`,y,N,M,E,D,Y,J,fe,be,Ee,je,nt,pe,Rt,Ht;return Ee=new Sc({}),nt=new Cc({}),{c(){l=H("link"),h=ue(),A=H("div"),_=H("header"),W=H("div"),Z=H("div"),z=H("div"),ne=H("div"),ne.innerHTML='<h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/>',C=ue(),se=H("div"),j=H("div"),re=H("button"),Ne=H("span"),Ne.textContent="Advanced",ot=ue(),Xe=H("span"),Xe.textContent="▾",Ge=ue(),F=H("button"),F.textContent="New",q=ue(),ve=H("label"),ve.innerHTML='<span>Open</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/>',$=ue(),ke=H("button"),ke.textContent="Share",Pe=ue(),ce=H("button"),ce.textContent="Help",lt=ue(),le=H("div"),he=H("div"),he.innerHTML='<label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <div id="searchResults" class="search-results" role="listbox" aria-label="Search across all models" hidden=""></div>',pt=ue(),R=H("form"),R.innerHTML='<label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-primary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div>',X=ue(),I=H("button"),I.textContent="Edit",Se=ue(),Be=H("a"),Be.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>',Le=ue(),tt=H("main"),it=H("div"),We=H("aside"),rt=H("div"),rt.textContent="Models",Mt=ue(),mt=H("ul"),$e=ue(),ct=H("div"),ct.innerHTML='<button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button>',Bt=ue(),Ie=H("section"),Qe=H("div"),Qe.innerHTML='<div class="sidebar-heading">Local files</div> <button id="toggleServerSidebar" class="pf-v5-c-button pf-m-tertiary" type="button" aria-pressed="false" hidden="">Wide menu</button>',p=ue(),w=H("p"),w.textContent="Checking for local server…",ht=ue(),ee=H("div"),st=H("label"),st.textContent="Blockscape files under ~/blockscape",kn=ue(),G=H("div"),Je=H("label"),Je.textContent="Folder",_t=ue(),at=H("select"),Jt=H("option"),Jt.textContent="Root (~/blockscape)",Kn=ue(),Dt=H("select"),qn=ue(),$t=H("div"),$t.innerHTML='<button id="refreshLocalFiles" class="pf-v5-c-button pf-m-tertiary" type="button">Refresh</button> <button id="loadLocalFile" class="pf-v5-c-button pf-m-secondary" type="button">Load</button> <button id="deleteLocalFile" class="pf-v5-c-button pf-m-danger" type="button">Delete</button>',pn=ue(),fn=H("div"),fn.innerHTML='<label for="localSavePath">Save active map to ~/blockscape</label> <input id="localSavePath" class="pf-v5-c-form-control" type="text" placeholder="my-map.bs"/> <div class="local-backend__save-actions"><button id="saveLocalFile" class="pf-v5-c-button pf-m-primary" type="button">Save</button> <button id="saveLocalFileAs" class="pf-v5-c-button pf-m-secondary" type="button">Save as</button></div>',ao=ue(),sn=H("div"),sn.innerHTML=`<section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,deps?:[],logo?,external?:url,color?,stage?:1-4,...}}], ... }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section>`,ln=ue(),Kt=H("footer"),en=H("div"),en.innerHTML='<a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a>',qt=ue(),cn=new ql(!1),y=ue(),N=zr("svg"),M=ue(),E=H("div"),D=ue(),Y=H("div"),J=ue(),fe=H("div"),fe.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',be=ue(),Sa(Ee.$$.fragment),je=ue(),Sa(nt.$$.fragment),ns.title="Blockscape — simple landscape-style tiles",v(l,"rel","icon"),v(l,"type","image/svg+xml"),v(l,"href","./favicon.svg"),v(ne,"class","blockscape-brand"),v(Ne,"class","blockscape-toolbar__toggle-label"),v(Xe,"class","blockscape-toolbar__toggle-icon"),v(Xe,"aria-hidden","true"),v(re,"class","pf-v5-c-button pf-m-secondary blockscape-toolbar__toggle"),v(re,"type","button"),v(re,"aria-expanded",r[0]),v(re,"aria-controls","blockscapeHeaderExtras"),v(re,"aria-label",ze=r[0]?"Hide advanced tools":"Show advanced tools"),v(F,"id","newPanelButton"),v(F,"class","pf-v5-c-button pf-m-primary"),v(F,"type","button"),v(F,"title","Create something new"),v(ve,"class","pf-v5-c-button pf-m-primary blockscape-file"),v(ke,"id","shareModel"),v(ke,"class","pf-v5-c-button pf-m-secondary"),v(ke,"type","button"),v(ke,"title","Copy a shareable URL for this model"),v(ce,"id","helpButton"),v(ce,"class","pf-v5-c-button pf-m-primary"),v(ce,"type","button"),v(ce,"title","Show keyboard shortcuts"),v(j,"class","blockscape-toolbar__primary"),v(he,"class","blockscape-search"),v(R,"id","urlForm"),v(R,"class","blockscape-url-form"),v(R,"autocomplete","on"),R.noValidate=!0,v(I,"id","openInEditor"),v(I,"class","pf-v5-c-button pf-m-secondary"),v(I,"type","button"),v(I,"title","Open current JSON in the editor"),v(le,"id","blockscapeHeaderExtras"),v(le,"class","blockscape-toolbar__extras"),le.hidden=Q=!r[0],v(le,"aria-hidden",ye=!r[0]),v(se,"class","blockscape-toolbar__controls"),v(se,"data-expanded",ge=r[0]?"true":"false"),v(Be,"href","https://github.com/pwright/blockscape"),v(Be,"target","_blank"),v(Be,"class","pf-v5-c-button pf-m-plain blockscape-toolbar__github"),v(Be,"title","View on GitHub"),v(Be,"aria-label","View Blockscape on GitHub"),v(z,"class","blockscape-toolbar"),v(Z,"class","pf-v5-c-masthead__content"),v(W,"class","pf-v5-c-masthead pf-m-display-inline blockscape-masthead"),v(_,"class","pf-v5-c-page__header"),_.hidden=b=!r[3],v(rt,"class","sidebar-heading"),v(mt,"id","modelList"),v(mt,"class","model-nav-list"),v(ct,"class","model-actions"),v(Qe,"class","local-backend__header"),v(w,"id","localBackendStatus"),v(w,"class","local-backend__status muted"),v(st,"class","sr-only"),v(st,"for","localFileList"),v(Je,"for","localDirSelect"),Jt.__value="",oo(Jt,Jt.__value),v(at,"id","localDirSelect"),v(at,"class","pf-v5-c-form-control"),v(at,"aria-label","Folder filter"),v(G,"class","local-backend__dir"),v(Dt,"id","localFileList"),v(Dt,"class","pf-v5-c-form-control"),v(Dt,"size","12"),Dt.multiple=!0,v(Dt,"aria-label","Blockscape files on local server"),v($t,"class","local-backend__actions"),v(ee,"class","local-backend__list"),v(fn,"class","local-backend__save"),v(Ie,"id","localBackendPanel"),v(Ie,"class","local-backend"),Ie.hidden=!0,v(We,"class","blockscape-sidebar"),v(We,"aria-label","Models"),We.hidden=$n=!r[2],v(sn,"class","blockscape-main"),v(it,"class","blockscape-content"),v(tt,"class","pf-v5-c-page__main"),v(en,"class","blockscape-footer__inner"),v(Kt,"class","pf-v5-c-page__footer blockscape-footer"),Kt.hidden=Ut=!r[1],v(A,"class","pf-v5-c-page"),cn.a=y,v(N,"id","overlay"),v(N,"class","svg-layer"),v(E,"id","tabTooltip"),v(E,"class","blockscape-tab-tooltip"),E.hidden=!0,v(E,"aria-hidden","true"),v(Y,"id","tileContextMenu"),v(Y,"class","tile-context-menu"),Y.hidden=!0,v(Y,"aria-hidden","true"),v(fe,"id","itemPreview"),v(fe,"class","item-preview"),fe.hidden=!0,v(fe,"aria-hidden","true")},m(de,oe){x(ns.head,l),It(de,h,oe),It(de,A,oe),x(A,_),x(_,W),x(W,Z),x(Z,z),x(z,ne),x(z,C),x(z,se),x(se,j),x(j,re),x(re,Ne),x(re,ot),x(re,Xe),x(j,Ge),x(j,F),x(j,q),x(j,ve),x(j,$),x(j,ke),x(j,Pe),x(j,ce),x(se,lt),x(se,le),x(le,he),x(le,pt),x(le,R),x(le,X),x(le,I),x(z,Se),x(z,Be),x(A,Le),x(A,tt),x(tt,it),x(it,We),x(We,rt),x(We,Mt),x(We,mt),x(We,$e),x(We,ct),x(We,Bt),x(We,Ie),x(Ie,Qe),x(Ie,p),x(Ie,w),x(Ie,ht),x(Ie,ee),x(ee,st),x(ee,kn),x(ee,G),x(G,Je),x(G,_t),x(G,at),x(at,Jt),x(ee,Kn),x(ee,Dt),x(ee,qn),x(ee,$t),x(Ie,pn),x(Ie,fn),x(it,ao),x(it,sn),x(A,ln),x(A,Kt),x(Kt,en),It(de,qt,oe),cn.m(d,de,oe),It(de,y,oe),It(de,N,oe),It(de,M,oe),It(de,E,oe),It(de,D,oe),It(de,Y,oe),It(de,J,oe),It(de,fe,oe),It(de,be,oe),Oi(Ee,de,oe),It(de,je,oe),Oi(nt,de,oe),pe=!0,Rt||(Ht=no(re,"click",r[5]),Rt=!0)},p(de,[oe]){(!pe||oe&1)&&v(re,"aria-expanded",de[0]),(!pe||oe&1&&ze!==(ze=de[0]?"Hide advanced tools":"Show advanced tools"))&&v(re,"aria-label",ze),(!pe||oe&1&&Q!==(Q=!de[0]))&&(le.hidden=Q),(!pe||oe&1&&ye!==(ye=!de[0]))&&v(le,"aria-hidden",ye),(!pe||oe&1&&ge!==(ge=de[0]?"true":"false"))&&v(se,"data-expanded",ge),(!pe||oe&8&&b!==(b=!de[3]))&&(_.hidden=b),(!pe||oe&4&&$n!==($n=!de[2]))&&(We.hidden=$n),(!pe||oe&2&&Ut!==(Ut=!de[1]))&&(Kt.hidden=Ut)},i(de){pe||(Ri(Ee.$$.fragment,de),Ri(nt.$$.fragment,de),pe=!0)},o(de){ya(Ee.$$.fragment,de),ya(nt.$$.fragment,de),pe=!1},d(de){de&&(vt(h),vt(A),vt(qt),cn.d(),vt(y),vt(N),vt(M),vt(E),vt(D),vt(Y),vt(J),vt(fe),vt(be),vt(je)),vt(l),Pi(Ee,de),Pi(nt,de),Rt=!1,Ht()}}}function Ac(r,l,h){let A,_,W,{seed:Z}=l,{features:z={}}=l;const C=Z?JSON.stringify(Z,null,2):`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;let se=!1;const j=()=>{if(h(0,se=!se),!se){const re=document.getElementById("search");re&&re.value&&(re.value="",re.dispatchEvent(new Event("input",{bubbles:!0})))}};return Xl(()=>{hc(z)}),r.$$set=re=>{"seed"in re&&h(6,Z=re.seed),"features"in re&&h(7,z=re.features)},r.$$.update=()=>{r.$$.dirty&128&&h(3,A=z.showHeader!==!1),r.$$.dirty&128&&h(2,_=z.showSidebar!==!1),r.$$.dirty&128&&h(1,W=z.showFooter!==!1)},[se,W,_,A,C,j,Z,z]}class Tc extends Di{constructor(l){super(),Vi(this,l,Ac,xc,Bi,{seed:6,features:7})}}function Lc(r){let l,h;return l=new Tc({props:{seed:r[0],features:r[1]}}),{c(){Sa(l.$$.fragment)},m(A,_){Oi(l,A,_),h=!0},p(A,[_]){const W={};_&1&&(W.seed=A[0]),_&2&&(W.features=A[1]),l.$set(W)},i(A){h||(Ri(l.$$.fragment,A),h=!0)},o(A){ya(l.$$.fragment,A),h=!1},d(A){Pi(l,A)}}}function Nc(r,l,h){let{seed:A}=l,{features:_={}}=l;return r.$$set=W=>{"seed"in W&&h(0,A=W.seed),"features"in W&&h(1,_=W.features)},[A,_]}class Mc extends Di{constructor(l){super(),Vi(this,l,Nc,Lc,Bi,{seed:0,features:1})}}return Mc}();
