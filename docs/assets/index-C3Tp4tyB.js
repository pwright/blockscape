var wr=Object.defineProperty;var Er=(d,u,p)=>u in d?wr(d,u,{enumerable:!0,configurable:!0,writable:!0,value:p}):d[u]=p;var te=(d,u,p)=>Er(d,typeof u!="symbol"?u+"":u,p);(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const v of document.querySelectorAll('link[rel="modulepreload"]'))w(v);new MutationObserver(v=>{for(const I of v)if(I.type==="childList")for(const y of I.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&w(y)}).observe(document,{childList:!0,subtree:!0});function p(v){const I={};return v.integrity&&(I.integrity=v.integrity),v.referrerPolicy&&(I.referrerPolicy=v.referrerPolicy),v.crossOrigin==="use-credentials"?I.credentials="include":v.crossOrigin==="anonymous"?I.credentials="omit":I.credentials="same-origin",I}function w(v){if(v.ep)return;v.ep=!0;const I=p(v);fetch(v.href,I)}})();function Ie(){}function Gt(d){return d()}function Ht(){return Object.create(null)}function ze(d){d.forEach(Gt)}function zt(d){return typeof d=="function"}function xr(d,u){return d!=d?u==u:d!==u||d&&typeof d=="object"||typeof d=="function"}function kr(d){return Object.keys(d).length===0}function Ar(d,u){d.appendChild(u)}function K(d,u,p){d.insertBefore(u,p||null)}function D(d){d.parentNode&&d.parentNode.removeChild(d)}function De(d){return document.createElement(d)}function Kt(d){return document.createElementNS("http://www.w3.org/2000/svg",d)}function Lr(d){return document.createTextNode(d)}function Ve(){return Lr(" ")}function V(d,u,p){p==null?d.removeAttribute(u):d.getAttribute(u)!==p&&d.setAttribute(u,p)}function Sr(d){return Array.from(d.childNodes)}class Cr{constructor(u=!1){te(this,"is_svg",!1);te(this,"e");te(this,"n");te(this,"t");te(this,"a");this.is_svg=u,this.e=this.n=null}c(u){this.h(u)}m(u,p,w=null){this.e||(this.is_svg?this.e=Kt(p.nodeName):this.e=De(p.nodeType===11?"TEMPLATE":p.nodeName),this.t=p.tagName!=="TEMPLATE"?p:p.content,this.c(u)),this.i(w)}h(u){this.e.innerHTML=u,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(u){for(let p=0;p<this.n.length;p+=1)K(this.t,this.n[p],u)}p(u){this.d(),this.h(u),this.i(this.a)}d(){this.n.forEach(D)}}let Je;function je(d){Je=d}function Ir(){if(!Je)throw new Error("Function called outside component initialization");return Je}function $r(d){Ir().$$.on_mount.push(d)}const Ce=[],Ft=[];let $e=[];const qt=[],Br=Promise.resolve();let mt=!1;function Nr(){mt||(mt=!0,Br.then(Wt))}function ht(d){$e.push(d)}const pt=new Set;let Se=0;function Wt(){if(Se!==0)return;const d=Je;do{try{for(;Se<Ce.length;){const u=Ce[Se];Se++,je(u),_r(u.$$)}}catch(u){throw Ce.length=0,Se=0,u}for(je(null),Ce.length=0,Se=0;Ft.length;)Ft.pop()();for(let u=0;u<$e.length;u+=1){const p=$e[u];pt.has(p)||(pt.add(p),p())}$e.length=0}while(Ce.length);for(;qt.length;)qt.pop()();mt=!1,pt.clear(),je(d)}function _r(d){if(d.fragment!==null){d.update(),ze(d.before_update);const u=d.dirty;d.dirty=[-1],d.fragment&&d.fragment.p(d.ctx,u),d.after_update.forEach(ht)}}function Tr(d){const u=[],p=[];$e.forEach(w=>d.indexOf(w)===-1?u.push(w):p.push(w)),p.forEach(w=>w()),$e=u}const Ur=new Set;function Mr(d,u){d&&d.i&&(Ur.delete(d),d.i(u))}function Or(d,u,p){const{fragment:w,after_update:v}=d.$$;w&&w.m(u,p),ht(()=>{const I=d.$$.on_mount.map(Gt).filter(zt);d.$$.on_destroy?d.$$.on_destroy.push(...I):ze(I),d.$$.on_mount=[]}),v.forEach(ht)}function Pr(d,u){const p=d.$$;p.fragment!==null&&(Tr(p.after_update),ze(p.on_destroy),p.fragment&&p.fragment.d(u),p.on_destroy=p.fragment=null,p.ctx=[])}function Rr(d,u){d.$$.dirty[0]===-1&&(Ce.push(d),Nr(),d.$$.dirty.fill(0)),d.$$.dirty[u/31|0]|=1<<u%31}function Vr(d,u,p,w,v,I,y=null,W=[-1]){const M=Je;je(d);const _=d.$$={fragment:null,ctx:[],props:I,update:Ie,not_equal:v,bound:Ht(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(u.context||(M?M.$$.context:[])),callbacks:Ht(),dirty:W,skip_bound:!1,root:u.target||M.$$.root};y&&y(_.root);let $=!1;if(_.ctx=p?p(d,u.props||{},(L,U,...N)=>{const T=N.length?N[0]:U;return _.ctx&&v(_.ctx[L],_.ctx[L]=T)&&(!_.skip_bound&&_.bound[L]&&_.bound[L](T),$&&Rr(d,L)),U}):[],_.update(),$=!0,ze(_.before_update),_.fragment=w?w(_.ctx):!1,u.target){if(u.hydrate){const L=Sr(u.target);_.fragment&&_.fragment.l(L),L.forEach(D)}else _.fragment&&_.fragment.c();u.intro&&Mr(d.$$.fragment),Or(d,u.target,u.anchor),Wt()}je(M)}class Dr{constructor(){te(this,"$$");te(this,"$$set")}$destroy(){Pr(this,1),this.$destroy=Ie}$on(u,p){if(!zt(p))return Ie;const w=this.$$.callbacks[u]||(this.$$.callbacks[u]=[]);return w.push(p),()=>{const v=w.indexOf(p);v!==-1&&w.splice(v,1)}}$set(u){this.$$set&&!kr(u)&&(this.$$.skip_bound=!0,this.$$set(u),this.$$.skip_bound=!1)}}const jr="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(jr);const Ge=typeof import.meta<"u"&&"/"||"";function Jr(){console.log("[Blockscape] init");const d=document.getElementById("jsonBox"),u=document.querySelector(".blockscape-json-panel"),p=document.getElementById("app"),w=document.getElementById("overlay"),v=document.getElementById("tabTooltip"),I=document.getElementById("modelList"),y=document.getElementById("itemPreview"),W=document.getElementById("urlForm"),M=document.getElementById("urlInput"),_=document.getElementById("loadUrl");let $=null,L=null,U=null,N=null,T=null,ne=null,re=null,pe=null,j=null;const Yt=y.querySelector(".item-preview__title"),me=y.querySelector(".item-preview__body"),Be=y.querySelector(".item-preview__actions"),gt=y.querySelector(".item-preview__close"),bt=document.getElementById("downloadJson"),vt=document.getElementById("shareModel"),yt=document.getElementById("openInEditor"),wt=document.getElementById("copyJson"),Et=document.getElementById("pasteJson"),Ne="blockscape:editorPayload",Xt="blockscape:editorTransfer",Qt=document.title,xt="blockscape:apicurioConfig",Ke="http://localhost:8080/apis/registry/v3",We="bs",Ye=!1,Xe=!1;d.value=document.getElementById("seed").textContent.trim();let g=[],h=-1,k={baseUrl:Ke,groupId:We,authToken:"",enabled:Ye,useSemver:Xe},C=null,O=new Map,E=null,Qe=0,J={x:0,y:0},he=null,Z=new Map,ie=new Map;cn();function oe(){return Math.random().toString(36).slice(2,10)}function Zt(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(r=>{n+=String.fromCharCode(r)}),btoa(n)}function en(e){const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return new TextDecoder().decode(n)}function tn(e){return Zt(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function nn(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),en(t)}function rn(e,t){const n=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=e,i.click(),URL.revokeObjectURL(r)}async function on(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function an(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function kt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function Ze(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(r=>Ze(r)).join(",")}]`:`{${Object.keys(e).sort().map(r=>`${JSON.stringify(r)}:${Ze(e[r])}`).join(",")}}`}function At(e){try{return Ze(e)}catch{return""}}function Lt(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=At(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=At(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}function ae(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const r=(e.title??"").toString().trim();e.title=r||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const o=n||e.title||t||"model",a=kt(o).replace(/\./g,"-");e.id=a||`model-${oe()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function H(e,t="Untitled Model"){var r;return e&&(((r=e.data)==null?void 0:r.title)??e.title??"").toString().trim()||t}function sn(e,t="Untitled Model"){var i;const n=Y(e);return(((i=e==null?void 0:e.apicurioVersions)==null?void 0:i.length)>1||(e==null?void 0:e.isSeries))&&n?`${n} series`:H(e,t)}function Y(e){var r;const t=(r=e==null?void 0:e.data)==null?void 0:r.id;return t&&t.toString().trim()||null}function se(e,{versionLabel:t,createdOn:n}={}){var s,c,l,f;const r=Y(e);if(!r)return g.push(e),g.length-1;const i=g.findIndex(b=>Y(b)===r);if(i===-1)return g.push(e),g.length-1;const o=g[i];(!Array.isArray(o.apicurioVersions)||!o.apicurioVersions.length)&&(o.apicurioVersions=[{version:((c=(s=o.apicurioVersions)==null?void 0:s[0])==null?void 0:c.version)||"v1",data:o.data,createdOn:(f=(l=o.apicurioVersions)==null?void 0:l[0])==null?void 0:f.createdOn}],o.apicurioActiveVersionIndex=0);const a=t||`v${o.apicurioVersions.length+1}`;return o.apicurioVersions.push({version:a,data:e.data,createdOn:n||new Date().toISOString()}),o.apicurioActiveVersionIndex=o.apicurioVersions.length-1,o.data=e.data,o.title=H(e)||o.title,o.isSeries=!0,i}function ce(e){return(e||"").toString().trim().replace(/\/+$/,"")}function cn(){let e={};if(window!=null&&window.localStorage)try{const o=localStorage.getItem(xt);if(o){const a=JSON.parse(o);a&&typeof a=="object"&&(e=a)}}catch(o){console.warn("[Blockscape] failed to restore Apicurio settings",o)}const t=ce(e.baseUrl??Ke),n=(e.groupId??We).toString().trim();let r=Ye,i=Xe;typeof e.enabled=="boolean"?r=e.enabled:typeof e.enabled=="string"&&(r=e.enabled==="true"),typeof e.useSemver=="boolean"?i=e.useSemver:typeof e.useSemver=="string"&&(i=e.useSemver==="true"),k.baseUrl=t||Ke,k.groupId=n||We,k.authToken=(e.authToken??"").toString().trim(),k.enabled=r,k.useSemver=i,_e()}function ln(){U&&(U.value=k.baseUrl||""),N&&(N.value=k.groupId||""),T&&(T.value=k.authToken||""),ne&&(ne.checked=de()),re&&(re.checked=!!k.useSemver)}function _e(){ln(),de()?le()?(x("Apicurio push is ready when a model is selected.","muted"),Z.size||He("Click “List artifacts” to browse the current group.")):(x("Enter Apicurio connection details to enable push.","muted"),et("Enter registry details to browse artifacts.")):(x("Apicurio integration is off. Enable it to allow pushes.","muted"),et("Apicurio integration is disabled.")),ge()}function et(e){Z.clear(),He(e)}function He(e){if(!j||(j.innerHTML="",!e))return;const t=document.createElement("p");t.className="apicurio-hint",t.textContent=e,j.appendChild(t)}function dn(e){if(!j)return;if(j.innerHTML="",!e.length){He("No artifacts found in this group.");return}const t=document.createElement("ul");t.className="apicurio-artifact-list",e.forEach(n=>{if(!(n!=null&&n.artifactId))return;const r=document.createElement("li"),i=document.createElement("button");i.type="button",i.className="apicurio-artifact",i.dataset.artifactId=n.artifactId,i.dataset.artifactTrigger="toggle";const o=document.createElement("span");o.className="apicurio-artifact-title",o.textContent=n.artifactId,i.appendChild(o);const a=[];if(n.name&&a.push(n.name),n.version!=null&&a.push(`v${n.version}`),n.type&&a.push(n.type),a.length){const l=document.createElement("span");l.className="apicurio-artifact-meta",l.textContent=a.join(" • "),i.appendChild(l)}if(n.description){const l=document.createElement("span");l.className="apicurio-artifact-meta",l.textContent=n.description,i.appendChild(l)}r.appendChild(i);const s=document.createElement("div");s.className="apicurio-version-list",s.dataset.versionPanel=n.artifactId,s.hidden=!0;const c=document.createElement("p");c.className="apicurio-hint",c.textContent="Click above to choose a version to load.",s.appendChild(c),r.appendChild(s),t.appendChild(r)}),j.appendChild(t)}function tt(e){return j?j.querySelector(`[data-version-panel="${e}"]`):null}function Te(e,t){if(!e||(e.innerHTML="",!t))return;const n=document.createElement("p");n.className="apicurio-hint",n.textContent=t,e.appendChild(n)}function un(e,t){const n=tt(e);if(!n)return;if(n.innerHTML="",!t.length){Te(n,"No versions found for this artifact.");return}t.forEach(i=>{const o=document.createElement("button");o.type="button",o.className="apicurio-version-button",o.dataset.artifactId=e,o.dataset.artifactVersion=i.version;const a=[`Version ${i.version}`];if(i.createdOn){const s=new Date(i.createdOn);isNaN(s)||a.push(s.toISOString().slice(0,10))}o.textContent=a.join(" — "),n.appendChild(o)});const r=document.createElement("button");r.type="button",r.className="apicurio-version-button",r.dataset.artifactId=e,r.dataset.artifactLoadAll="true",r.textContent=`Load all (${t.length})`,n.appendChild(r)}async function fn(e){const t=tt(e);if(!t)return;if(t.dataset.open==="true"){t.hidden=!0,t.dataset.open="false";return}if(t.hidden=!1,t.dataset.open="true",t.dataset.loaded!=="true"){if(!le()){Te(t,"Enter registry details first.");return}Te(t,"Loading versions…");try{const r=ce(k.baseUrl),i=k.groupId.trim(),o=await Fe(r,i,e);ie.set(e,o),t.dataset.loaded="true",un(e,o)}catch(r){console.error("[Blockscape] failed to load versions",r),Te(t,`Unable to fetch versions: ${r.message}`)}}}function pn(e){return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.artifacts)?e.artifacts:Array.isArray(e==null?void 0:e.items)?e.items:Array.isArray(e==null?void 0:e.results)?e.results:[]}async function St(e,t,n){const r=encodeURIComponent(t),i=encodeURIComponent(n),o=`${e}/groups/${r}/artifacts/${i}`,a=Ue();a.Accept="application/json";const s=await fetch(o,{method:"GET",headers:a});if(!s.ok){let c=s.statusText||"Unknown error";try{const l=await s.text();l&&(c=l.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${s.status}): ${c}`)}return s.json()}async function Fe(e,t,n){const r=encodeURIComponent(t),i=encodeURIComponent(n),o=`${e}/groups/${r}/artifacts/${i}/versions?limit=50&order=desc`,a=Ue();a.Accept="application/json";const s=await fetch(o,{method:"GET",headers:a});if(!s.ok){let l=s.statusText||"Unknown error";try{const f=await s.text();f&&(l=f.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${s.status}): ${l}`)}const c=await s.json();return mn(c).filter(l=>l&&l.version!=null)}function mn(e){return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.versions)?e.versions:Array.isArray(e==null?void 0:e.items)?e.items:[]}function Ct(e=[]){if(!Array.isArray(e)||!e.length)return null;const t=[...e].filter(Boolean);return t.sort((n,r)=>{const i=n!=null&&n.createdOn?new Date(n.createdOn).getTime():0,o=r!=null&&r.createdOn?new Date(r.createdOn).getTime():0;if(i!==o)return o-i;const a=Number(n==null?void 0:n.version),s=Number(r==null?void 0:r.version),c=Number.isFinite(a),l=Number.isFinite(s);if(c&&l&&a!==s)return s-a;const f=String((n==null?void 0:n.version)??"");return String((r==null?void 0:r.version)??"").localeCompare(f,void 0,{numeric:!0})}),t[0]||null}function hn(e){if(!e)return e;let t=e;if(!Array.isArray(e==null?void 0:e.categories)){const r=e==null?void 0:e.content;if(typeof r=="string")try{t=JSON.parse(r)}catch(i){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",i)}else r&&typeof r=="object"&&(t=r)}return t}async function nt(e,t,n,r="latest"){const i=encodeURIComponent(t),o=encodeURIComponent(n),a=encodeURIComponent(r||"latest"),s=`${e}/groups/${i}/artifacts/${o}/versions/${a}/content`,c=Ue();c.Accept="application/json, application/*+json, */*;q=0.8";const l=await fetch(s,{method:"GET",headers:c});if(!l.ok){let A=l.statusText||"Unknown error";try{const P=await l.text();P&&(A=P.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${l.status}): ${A}`)}const f=await l.text();let b=null;try{b=JSON.parse(f)}catch{throw new Error("Artifact content is not valid JSON.")}return hn(b)}async function gn(e,t,n,r="latest"){const i=await nt(e,t,n,r);return{data:i,fingerprint:Lt(i)}}async function bn(e,t,n){try{const i=await Fe(e,t,n);if(i!=null&&i.length){ie.set(n,i);const o=Ct(i);if((o==null?void 0:o.version)!=null)return o.version}}catch(i){console.warn("[Blockscape] compare-version: unable to fetch versions list",i)}try{const i=await St(e,t,n);if((i==null?void 0:i.version)!=null)return i.version}catch(i){console.warn("[Blockscape] compare-version: unable to fetch metadata",i)}const r=ie.get(n);if(r&&r.length){const i=Ct(r);if((i==null?void 0:i.version)!=null)return i.version}return"latest"}function vn(e=document){$=e.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),L=e.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),U=e.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),N=e.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),T=e.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),ne=e.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),re=e.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),pe=e.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),j=e.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function yn(){[U,N,T].forEach(e=>{e&&e.addEventListener("input",$n)}),$&&$.addEventListener("click",()=>{Tn()}),ne&&ne.addEventListener("change",Bn),re&&re.addEventListener("change",Nn),L&&L.addEventListener("click",Un),j&&j.addEventListener("click",e=>{const t=e.target.closest("[data-artifact-version]");if(t){e.stopPropagation();const i=t.dataset.artifactId,o=t.dataset.artifactVersion;i&&o&&Mn(i,o);return}const n=e.target.closest("[data-artifact-load-all]");if(n){e.stopPropagation();const i=n.dataset.artifactId;i&&On(i);return}const r=e.target.closest("[data-artifact-trigger]");if(r){const i=r.dataset.artifactId;if(!i)return;fn(i)}})}function wn(){const e=document.createElement("div");return e.className="blockscape-registry-panel",e.innerHTML=`
        <div class="blockscape-registry-header">
          <h2>Apicurio registry</h2>
          <p>Configure the registry connection and push the active model.</p>
        </div>
        <div class="apicurio-controls">
          <label class="apicurio-toggle">
            <input id="apicurioToggle" type="checkbox" />
            <span>Enable Apicurio push</span>
          </label>
          <label class="apicurio-toggle">
            <input id="apicurioSemver" type="checkbox" />
            <span>Use semantic versioning</span>
          </label>
          <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
          <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
          <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
            title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
          <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
            title="List artifacts in the configured group">List artifacts</button>
          <details id="apicurioSettings" class="apicurio-settings">
            <summary>Connection settings (optional)</summary>
            <div class="apicurio-fields">
              <label>
                Registry base URL
                <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
              </label>
              <label>
                Group ID
                <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
              </label>
              <label>
                Auth token (optional)
                <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
              </label>
            </div>
            <p class="apicurio-hint">Details stay in this browser only.</p>
          </details>
          <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
          <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
        </div>
      `,e}function En(e){if(!e)return;e.innerHTML="";const t=wn();e.appendChild(t),vn(e),yn(),_e()}function rt(){if(window!=null&&window.localStorage)try{localStorage.setItem(xt,JSON.stringify(k))}catch(e){console.warn("[Blockscape] unable to persist Apicurio settings",e)}}function le(){return!!(k.baseUrl&&k.groupId)}function de(){return k.enabled!==!1}function x(e="",t="muted"){pe&&(pe.textContent=e||"",pe.classList.remove("is-error","is-success"),t==="error"?pe.classList.add("is-error"):t==="success"&&pe.classList.add("is-success"))}function ge(){const e=de(),t=le();if($){const n=$.dataset.loading==="true",r=e&&t&&h>=0&&!!Y(g[h]);$.disabled=!e||n||!r,e?n||($.textContent="Push to Apicurio"):$.textContent="Enable Apicurio to push"}if(L){const n=L.dataset.loading==="true",r=e&&t;L.disabled=!r||n,n||(e?t?L.textContent="List artifacts":L.textContent="Enter details to list":L.textContent="Enable Apicurio to list")}}function Ue(){const e={Accept:"application/json"},t=(k.authToken||"").trim();return t&&(e.Authorization=/\s/.test(t)?t:`Bearer ${t}`),e}function xn(e,t,{title:n,description:r,version:i}={}){const o={artifactId:e,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:t}}};return i&&(o.firstVersion.version=i),n&&(o.name=n),r&&(o.description=r),o}function kn(e,{version:t}={}){const n={content:{contentType:"application/json",content:e}};return t&&(n.version=t),n}function An(e){if(e==null)return null;const t=String(e).trim();if(!t)return null;const n=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(t);if(n)return{major:Number(n[1]),minor:Number(n[2]),patch:Number(n[3])};const r=/^v?(\d+)$/.exec(t);return r?{major:Number(r[1]),minor:0,patch:0}:null}function Ln(e){return`${e.major}.${e.minor}.${e.patch}`}function Sn(e,t){return!e&&!t?0:e?t?e.major!==t.major?e.major-t.major:e.minor!==t.minor?e.minor-t.minor:e.patch-t.patch:1:-1}function Cn(e=[]){let t=null;if(e.forEach(r=>{const i=An((r==null?void 0:r.version)??r);i&&(!t||Sn(i,t)>0)&&(t=i)}),!t)return"1.0.0";const n={...t,patch:t.patch+1};return Ln(n)}async function In(e,t,n,r){if(!k.useSemver)return null;if(!r)return"1.0.0";try{const i=await Fe(e,t,n);return Cn(i)}catch(i){throw new Error(`Unable to compute next semantic version: ${i.message}`)}}function $n(){k.baseUrl=ce((U==null?void 0:U.value)??k.baseUrl),k.groupId=((N==null?void 0:N.value)??"").trim(),k.authToken=((T==null?void 0:T.value)??"").trim(),rt(),_e()}function Bn(){k.enabled=ne?ne.checked:Ye,rt(),_e()}function Nn(){k.useSemver=re?re.checked:Xe,rt(),_e()}async function _n(e,t,n,r){const i=encodeURIComponent(t),o=encodeURIComponent(n),a=`${e}/groups/${i}/artifacts/${o}`;try{const s=await fetch(a,{method:"GET",headers:r});if(s.status===404)return!1;if(s.ok)return!0;throw s.status===401||s.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${s.status} while checking the artifact.`)}catch(s){throw s instanceof TypeError?new Error("Network error while contacting Apicurio registry."):s}}function It(e,t){var r;const n=g.findIndex(i=>i.apicurioArtifactId===e);if(n!==-1){const i=g[n].id;g[n]={...t,id:i||t.id},((r=g[n].apicurioVersions)==null?void 0:r.length)>1&&(g[n].isSeries=!0),F(n)}else g.push(t),F(g.length-1)}async function Tn(){var o;if(!$||$.dataset.loading==="true")return;if(!de()){x("Apicurio integration is off. Enable it first.","error");return}if(!le()){x("Enter the registry base URL and group ID before pushing.","error");return}if(h<0||!g[h]){x("No active model to push.","error");return}const e=Y(g[h]);if(!e){x("Active model needs an id before pushing.","error");return}const t=ce(k.baseUrl),n=k.groupId.trim(),r=JSON.stringify(g[h].data,null,2),i=Ue();$.dataset.loading="true",$.textContent="Pushing…",$.disabled=!0,x("Pushing to Apicurio…","muted");try{const a=await _n(t,n,e,i),s=Lt(g[h].data);if(a)try{const m=await bn(t,n,e),{data:S,fingerprint:B}=await gn(t,n,e,m);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",m),console.log("local fingerprint",s),console.log("registry fingerprint",B),console.log("local payload",g[h].data),console.log("registry payload",S),console.groupEnd(),s&&B&&s===B){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){x("Push cancelled (content matches the latest registry version).","muted");return}x("Pushing identical content by user choice.","muted")}else B?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(m){console.warn("[Blockscape] unable to compare registry content before push",m),x("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const c=k.useSemver?await In(t,n,e,a):null;if(k.useSemver&&!c)throw new Error("Semantic versioning is enabled but no version could be computed.");const l=encodeURIComponent(n),f=encodeURIComponent(e),b=a?`${t}/groups/${l}/artifacts/${f}/versions`:`${t}/groups/${l}/artifacts`,A={...i,"Content-Type":"application/json"};c&&(A["X-Registry-Version"]=c,x(`Pushing to Apicurio as version ${c}…`,"muted"));const P=a?kn(r,{version:c}):xn(e,r,{title:H(g[h]),description:(o=g[h].data)==null?void 0:o.abstract,version:c}),Q=await fetch(b,{method:"POST",headers:A,body:JSON.stringify(P)});if(!Q.ok){let m=Q.statusText||"Unknown error";try{const S=await Q.text();S&&(m=S.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Q.status}): ${m}`)}let q=null;try{q=await Q.json()}catch{q=null}const ke=(q==null?void 0:q.version)||(q==null?void 0:q.globalId)||"",Ae=a?"Updated":"Created",Le=ke?` (version ${ke})`:"";x(`${Ae} ${e}${Le}`,"success")}catch(a){console.error("[Blockscape] Apicurio push failed",a),x(`Apicurio push failed: ${a.message}`,"error")}finally{$.dataset.loading="false",ge()}}async function Un(){if(!L||L.dataset.loading==="true")return;if(!de()){x("Enable Apicurio integration to list artifacts.","error");return}if(!le()){x("Enter registry base URL and group ID before listing.","error");return}const e=ce(k.baseUrl),t=k.groupId.trim(),n=encodeURIComponent(t),r=`${e}/groups/${n}/artifacts?limit=50&offset=0`;L.dataset.loading="true",L.textContent="Listing…",L.disabled=!0,x("Listing artifacts…","muted"),He("Contacting registry…");try{const i=Ue();i.Accept="application/json";const o=await fetch(r,{method:"GET",headers:i});if(!o.ok){let l=o.statusText||"Unknown error";try{const f=await o.text();f&&(l=f.slice(0,400))}catch{}throw new Error(`Failed to list artifacts (${o.status}): ${l}`)}const a=await o.json(),s=pn(a).filter(l=>l&&l.artifactId);Z.clear(),ie.clear(),s.forEach(l=>{l!=null&&l.artifactId&&Z.set(l.artifactId,l)}),dn(s);const c=s.length;x(c?`Found ${c} artifact${c===1?"":"s"}.`:"No artifacts found in this group.",c?"success":"muted")}catch(i){console.error("[Blockscape] failed to list artifacts",i),et("Unable to list artifacts."),x(`Listing failed: ${i.message}`,"error")}finally{L.dataset.loading="false",ge()}}async function Mn(e,t=null){if(!e)return;if(!de()){x("Enable Apicurio integration to load artifacts.","error");return}if(!le()){x("Enter registry connection details before loading artifacts.","error");return}const n=ce(k.baseUrl),r=k.groupId.trim();let i=Z.get(e);const o=async()=>{try{const f=await St(n,r,e);return f!=null&&f.artifactId&&Z.set(e,f),f}catch(f){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",f),f}};if(!i)try{i=await o()}catch(f){x(`Failed to fetch artifact metadata: ${f.message}`,"error");return}const a=ie.get(e)||[];let s="latest",c="latest";if(t)s=t,c=t;else{if(!i||i.version==null)try{i=await o()}catch(f){x(`Failed to fetch artifact metadata: ${f.message}`,"error");return}s=(i==null?void 0:i.version)||"latest",c=(i==null?void 0:i.version)||"latest"}const l=a.find(f=>String(f.version)===String(s));(l==null?void 0:l.version)!=null&&(c=l.version),x(`Loading artifact ${e}…`,"muted");try{const f=await nt(n,r,e,s),b=Z.get(e)||i||{};ae(f,{titleHint:b.name||e,idHint:e});const A={version:c,data:f,createdOn:(l==null?void 0:l.createdOn)||b.createdOn},P={id:oe(),title:f.title||b.name||e,data:f,apicurioArtifactId:e,apicurioArtifactName:b.name||"",apicurioVersions:[A],apicurioActiveVersionIndex:0};It(e,P);const Q=c?` (version ${c})`:"";x(`Loaded artifact ${e}${Q}.`,"success")}catch(f){console.error("[Blockscape] failed to load artifact",f),x(`Failed to load artifact: ${f.message}`,"error")}}async function On(e){if(!e)return;if(!de()){x("Enable Apicurio integration to load artifacts.","error");return}if(!le()){x("Enter registry connection details before loading artifacts.","error");return}const t=ce(k.baseUrl),n=k.groupId.trim();let r=ie.get(e);if(!r){Te(tt(e),"Loading versions…");try{r=await Fe(t,n,e),ie.set(e,r)}catch(c){x(`Failed to fetch versions: ${c.message}`,"error");return}}const i=(r||[]).filter(c=>c&&c.version!=null);if(!i.length){x("No versions found for this artifact.","muted");return}x(`Loading ${i.length} version(s) for ${e}…`,"muted");const o=Z.get(e)||{},a=[];try{for(const c of i){const l=c.version??"latest",f=await nt(t,n,e,l);ae(f,{titleHint:o.name||e,idHint:e}),a.push({version:l,createdOn:c.createdOn,data:f})}}catch(c){console.error("[Blockscape] failed to load one or more versions",c),x(`Failed to load all versions: ${c.message}`,"error");return}if(!a.length){x("No versions loaded from registry.","error");return}const s={id:oe(),title:a[0].data.title||o.name||e,data:a[0].data,apicurioArtifactId:e,apicurioArtifactName:o.name||"",apicurioVersions:a,apicurioActiveVersionIndex:0};It(e,s),x(`Loaded ${a.length} version(s) for ${e}.`,"success")}function it(){const e=h>=0&&g[h]?g[h]:null,t=Y(e);document.title=t?`${t}-blockscape`:Qt}function $t(e="shortcut"){const t=d.value||"";if(!t.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const n=H(g[h],"blockscape"),r=`${kt(n)}.json`;return rn(r,t),console.log(`[Blockscape] saved JSON (${e}):`,r),!0}const Pn={A:"#ef4444",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#f43f5e",P:"#e11d48",Q:"#dc2626",R:"#f59e0b",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"};function Rn(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Pn[n]||"#9ca3af"}function Vn(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(c=>c+c).join(""):t,r=parseInt(n,16),i=r>>16&255,o=r>>8&255,a=r&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(o/255,2.2)+.0722*Math.pow(a/255,2.2)>.35?"#111111":"#ffffff"}function Dn(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}let ot=!1;function Bt(){ot||(ot=!0,requestAnimationFrame(()=>{ot=!1,st(),Oe()}))}let Nt=!1;function F(e){if(X(),he=null,e<0||e>=g.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}h=e,console.log("[Blockscape] active model:",H(g[e]),"(index",e+" )"),it(),be(),ve(),ue(),ge()}function be(){if(I.innerHTML="",!g.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",I.appendChild(e);return}g.forEach((e,t)=>{var b;const n=document.createElement("li");n.className="model-nav-item";const r=document.createElement("button");r.type="button",r.className="model-nav-button"+(t===h?" is-active":""),r.dataset.index=String(t),r.setAttribute("aria-current",t===h?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const o=document.createElement("span");o.className="model-nav-title",o.textContent=sn(e),i.appendChild(o);const a=Y(e);if(a){const A=document.createElement("span");A.className="model-nav-id",A.textContent=a,i.appendChild(A)}const s=Array.isArray((b=e.data)==null?void 0:b.categories)?e.data.categories:[],c=s.reduce((A,P)=>A+(P.items||[]).length,0),l=document.createElement("span");l.className="model-nav-meta";const f=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} versions`:"";l.textContent=`${s.length} cat · ${c} items${f}`,r.appendChild(i),r.appendChild(l),n.appendChild(r),I.appendChild(n)}),ge()}function ve(){if(h<0){d.value="";return}d.value=JSON.stringify(g[h].data,null,2)}function jn(e){try{return JSON.parse(e)}catch{return null}}function ye(e,t="Pasted"){const n=(e||"").trim();if(!n)return[];const r=jn(n);return r?(Array.isArray(r)?r:[r]).map((a,s)=>(ae(a,{titleHint:`${t} #${s+1}`}),{id:oe(),title:a.title||`${t} #${s+1}`,data:a})):n.split(/^\s*(?:---|%%%)\s*$/m).map(o=>o.trim()).filter(Boolean).map((o,a)=>{const s=JSON.parse(o);return ae(s,{titleHint:`${t} #${a+1}`}),{id:oe(),title:s.title||`${t} #${a+1}`,data:s}})}function Jn(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function Me(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!Jn(e)}function Hn(e){if(!e)return!1;const t=e.trimStart();return/^\s*(\{|\[|---|%%%)/.test(t)}function _t(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(Ne)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(Ne)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(Ne)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=ye(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let r=null;return n.forEach(i=>{const o=se(i,{versionLabel:"editor"});r==null&&(r=o)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:r,count:n.length}}function Tt(e="storage"){const t=_t();return!t||typeof t.index!="number"?!1:(F(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Fn(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const o=new URLSearchParams(window.location.search);o.has("share")&&(t=o.get("share"))}if(!t)return null;let r;try{const o=nn(t);r=JSON.parse(o)}catch(o){return console.warn("[Blockscape] failed to decode share token",o),null}return!r||typeof r!="object"||typeof r.data!="object"?(console.warn("[Blockscape] share payload missing data"),null):(ae(r.data,{titleHint:r.title||"Shared Model"}),se({id:oe(),title:r.data.title||r.title||"Shared Model",data:r.data},{versionLabel:"shared"}))}async function qn(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const r=new URLSearchParams(window.location.search);r.has("load")&&(t=r.get("load"))}if(!t)return null;try{const r=await dt(t);return typeof r=="number"?r:null}catch(r){return console.warn("[Blockscape] load param failed",r),null}}function Gn(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,r=new Set;(e.categories||[]).forEach(o=>(o.items||[]).forEach(a=>{r.add(a.id);const s=new Set(a.deps||[]);(e.links||[]).forEach(c=>{c.from===a.id&&s.add(c.to)}),t.set(a.id,s),s.forEach(c=>{n.has(c)||n.set(c,new Set),n.get(c).add(a.id)})}));const i=new Set;return n.forEach((o,a)=>{((o==null?void 0:o.size)||0)>=2&&i.add(a)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:r}}function zn(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),r=44;n.width=r,n.height=r;const i=n.getContext("2d"),o=(e||"?").charAt(0).toUpperCase(),a=Rn(e,t),s=Vn(a);return i.fillStyle=a,i.beginPath(),i.arc(r/2,r/2,r/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=s,i.font=`bold ${r*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(o,r/2,r/2),n.toDataURL("image/png")}function at(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Ut(e){const t=at(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Kn(e,t){var a;if(e<0||e>=g.length)return!1;const n=g[e];if(!((a=n==null?void 0:n.apicurioVersions)!=null&&a.length))return!1;const r=n.apicurioVersions.length,i=(t%r+r)%r,o=n.apicurioVersions[i];return o!=null&&o.data?(n.apicurioActiveVersionIndex=i,n.data=o.data,E=null,ve(),ue(),!0):!1}function Mt(e){var r;if(!e||h<0)return;const t=g[h];if(!((r=t==null?void 0:t.apicurioVersions)!=null&&r.length))return;const n=at(t);n!==-1&&Kn(h,n+e)}function Wn(e){if(!(e!=null&&e.apicurioVersions)||e.apicurioVersions.length<=1)return null;const t=document.createElement("div");t.className="version-nav";const n=document.createElement("div");n.className="version-nav__title",n.textContent=e.apicurioArtifactName||e.apicurioArtifactId||Y(e)||"Artifact",t.appendChild(n);const r=document.createElement("div");r.className="version-nav__status";const i=at(e),o=Ut(e)||"latest";r.textContent=`Version ${o} (${i+1} of ${e.apicurioVersions.length})`,t.appendChild(r);const a=document.createElement("div");a.className="version-nav__controls";const s=document.createElement("button");s.type="button",s.className="version-nav__button",s.textContent="Previous",s.addEventListener("click",()=>Mt(-1));const c=document.createElement("button");return c.type="button",c.className="version-nav__button",c.textContent="Next",c.addEventListener("click",()=>Mt(1)),a.appendChild(s),a.appendChild(c),t.appendChild(a),t}function we(){if(!C)return;Ee(),Array.isArray(C.m.categories)||(C.m.categories=[]),console.log("[Blockscape] rendering categories=",C.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!C.m.abstract,"- value:",C.m.abstract?C.m.abstract.substring(0,50)+"...":"none"),p.innerHTML="",O.clear();const e=Wn(g[h]);e&&p.appendChild(e),w.setAttribute("width",window.innerWidth),w.setAttribute("height",window.innerHeight);const t=document.createElement("div");t.className="blockscape-model-meta";const n=document.createElement("div");n.className="blockscape-model-title",n.textContent=C.m.title&&C.m.title.trim()||H(g[h]),t.appendChild(n);const r=Ut(g[h]),i=(C.m.id??"").toString().trim();if(i){const m=document.createElement("div");m.className="blockscape-model-id",m.textContent=`ID: ${i}`,t.appendChild(m)}if(r){const m=document.createElement("div");m.className="blockscape-model-id",m.textContent=`Version: ${r}`,t.appendChild(m)}p.appendChild(t);const o=document.createElement("div");o.className="blockscape-tabs";const a=document.createElement("div");a.className="blockscape-tablist",a.setAttribute("role","tablist"),o.appendChild(a);const s=document.createElement("div");s.className="blockscape-tabpanels",o.appendChild(s);const c=document.createElement("div"),l=document.createElement("div"),f=document.createElement("div"),b=document.createElement("div");let A="";const P=[{id:"map",label:"Map",panel:c},{id:"abstract",label:"Info",panel:l},{id:"source",label:"Source",panel:f},{id:"apicurio",label:"Apicurio",panel:b}],Q=m=>{if(!w)return;const S=m==="map";w.hidden=!S,S?(st(),Oe()):w.innerHTML=""};P.forEach((m,S)=>{const B=document.createElement("button");B.type="button",B.id=`tab-${m.id}`,B.className="blockscape-tab"+(S===0?" is-active":""),B.setAttribute("role","tab"),B.setAttribute("aria-controls",`panel-${m.id}`),B.setAttribute("aria-selected",S===0?"true":"false"),B.textContent=m.label,m.button=B,a.appendChild(B),m.panel.id=`panel-${m.id}`,m.panel.classList.add("blockscape-tabpanel"),m.panel.setAttribute("role","tabpanel"),m.panel.setAttribute("aria-labelledby",B.id),m.panel.hidden=S!==0,S===0&&m.panel.classList.add("is-active"),s.appendChild(m.panel)});const q=m=>{P.forEach(S=>{const B=S.id===m;S.button.classList.toggle("is-active",B),S.button.setAttribute("aria-selected",B?"true":"false"),S.panel.classList.toggle("is-active",B),S.panel.hidden=!B}),Q(m)};P.forEach(m=>{m.button.addEventListener("click",()=>{Ee(),q(m.id)}),m.id==="abstract"&&(m.button.addEventListener("mouseenter",()=>Rt(m.button,A,{offset:12})),m.button.addEventListener("mouseleave",Ee),m.button.addEventListener("focus",()=>Rt(m.button,A,{offset:12})),m.button.addEventListener("blur",Ee))}),q(P[0].id),p.appendChild(o);const ke=document.createElement("div");ke.className="blockscape-render",c.appendChild(ke);const Ae=document.createElement("div");if(Ae.className="blockscape-abstract-panel",C.m.abstract){console.log("[Blockscape] Rendering abstract content");const m=document.createElement("div");m.className="blockscape-abstract",m.innerHTML=C.m.abstract,gr(m),Ae.appendChild(m),A=m.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const m=document.createElement("div");m.className="blockscape-abstract-placeholder",m.textContent="No abstract has been provided for this model.",Ae.appendChild(m),A=m.outerHTML}l.appendChild(Ae);const Le=document.createElement("div");if(Le.className="blockscape-source-panel",u)u.hidden=!1,u.classList.remove("pf-v5-c-page__main-section"),Le.appendChild(u);else{const m=document.createElement("p");m.className="muted",m.textContent="Source editor unavailable.",Le.appendChild(m)}f.appendChild(Le),En(b),C.m.categories.forEach(m=>{const S=document.createElement("section");S.className="category",S.dataset.cat=m.id;const B=document.createElement("div");B.className="cat-head",B.innerHTML=`<div class="cat-title">${lt(m.title||m.id)}</div>
                          <div class="muted cat-count">${(m.items||[]).length} items</div>`,S.appendChild(B);const qe=document.createElement("div");qe.className="grid",S.appendChild(qe),(m.items||[]).forEach(R=>{const Re=Xn(R.external),z=document.createElement("div");z.className=Re.isExternal?"tile external":"tile",z.tabIndex=0,z.dataset.id=R.id,Re.url&&(z.dataset.externalUrl=Re.url);const fe=document.createElement("img");fe.className="logo",R.logo?(fe.src=R.logo,fe.alt=R.name||R.id):(fe.alt="",fe.style.opacity=1,fe.src=zn(R.name||R.id,R.color));const ut=document.createElement("div");ut.className="name",ut.textContent=R.name||R.id;const ft=document.createElement("div");ft.className="badge",ft.textContent="reused",Re.url&&z.appendChild(Qn(Re.url)),z.appendChild(fe),z.appendChild(ut),z.appendChild(ft),qe.appendChild(z),O.set(R.id,{el:z,catId:m.id,rect:null})}),ke.appendChild(S)}),C.reusedLocal.forEach(m=>{const S=O.get(m);S&&(S.el.classList.add("reused"),S.el.querySelector(".badge").style.display="inline-block")}),Yn(),st(),Oe()}function Yn(){p.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",t=>{if(typeof t.button=="number"&&t.button!==0)return;X();const n=e.dataset.id;if(console.log("[Blockscape] click",n),E===n){ct();return}G(n)}),e.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),e.click())}),e.draggable=!0,e.addEventListener("dragstart",tr),e.addEventListener("dragend",nr)}),p.querySelectorAll(".grid").forEach(e=>{e.addEventListener("dragover",rr),e.addEventListener("drop",ar),e.addEventListener("dragenter",ir),e.addEventListener("dragleave",or)}),Nt||(Nt=!0,window.addEventListener("resize",Bt),window.addEventListener("scroll",Bt,{passive:!0})),document.getElementById("clear").onclick=()=>ct()}function st(){O.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function G(e){E=e,Ot();const t=Array.from(C.fwd.get(e)||[]),n=Array.from(C.rev.get(e)||[]);console.log("[Blockscape] selecting id=",e,"deps=",t,"revs=",n);const r=O.get(e);r&&r.el.classList.add("selected"),t.forEach(i=>{const o=O.get(i);o&&o.el.classList.add("dep")}),n.forEach(i=>{const o=O.get(i);o&&o.el.classList.add("revdep")}),Oe()}function ct(){E=null,Ot(),Oe()}function Ot(){p.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","selected"))}function Oe(){var n;for(;w.firstChild;)w.removeChild(w.firstChild);if(!E||w.hidden)return;const e=(n=O.get(E))==null?void 0:n.rect;if(!e)return;new Set([...C.fwd.get(E)||[],...C.rev.get(E)||[]]).forEach(r=>{const i=O.get(r);if(!i||!i.rect)return;const o=Pt(e),a=Pt(i.rect),s=document.createElementNS("http://www.w3.org/2000/svg","path"),c=(o.x+a.x)/2,l=o.y,f=(o.x+a.x)/2,b=a.y,A=(C.fwd.get(E)||new Set).has(r);s.setAttribute("d",`M ${o.x},${o.y} C ${c},${l} ${f},${b} ${a.x},${a.y}`),s.setAttribute("fill","none"),s.setAttribute("stroke",A?"var(--blockscape-dep)":"var(--blockscape-revdep)"),s.setAttribute("stroke-opacity","0.45"),s.setAttribute("stroke-width","2"),s.setAttribute("vector-effect","non-scaling-stroke"),w.appendChild(s)})}function Pt(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function lt(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Xn(e){if(typeof e=="string"){const t=e.trim();if(!t)return{isExternal:!1,url:""};try{const n=new URL(t);return/^https?:/i.test(n.protocol)?{isExternal:!0,url:n.toString()}:{isExternal:!1,url:""}}catch(n){return console.warn("[Blockscape] invalid external url skipped",e,n),{isExternal:!1,url:""}}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Qn(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Rt(e,t,{offset:n=8}={}){!v||!e||!t||(v.innerHTML=t,v.hidden=!1,v.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const r=e.getBoundingClientRect(),i=v.getBoundingClientRect(),o=window.scrollX||document.documentElement.scrollLeft,a=window.scrollY||document.documentElement.scrollTop;let s=r.left+r.width/2-i.width/2+o,c=r.top-i.height-n+a;s<o+n&&(s=o+n);const l=o+window.innerWidth-i.width-n;s>l&&(s=l),c<a+n&&(c=r.bottom+n+a),v.style.left=`${s}px`,v.style.top=`${c}px`,v.classList.add("is-visible")}))}function Ee(){v&&(v.classList.remove("is-visible"),v.setAttribute("aria-hidden","true"),v.hidden=!0)}window.addEventListener("scroll",Ee,!0),window.addEventListener("resize",Ee);function X(){y&&(y.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),y.setAttribute("aria-hidden","true"),y.hidden=!0,Vt(""))}function Zn(e,t){y&&(J={x:e,y:t},y.hidden=!1,y.setAttribute("aria-hidden","false"),y.classList.add("is-visible"),xe(e,t))}function xe(e,t){if(!y)return;const n=12;y.style.left=`${e+n}px`,y.style.top=`${t+n}px`;const r=y.getBoundingClientRect();let i=r.left,o=r.top;r.right>window.innerWidth-n&&(i=Math.max(n,window.innerWidth-r.width-n)),r.bottom>window.innerHeight-n&&(o=Math.max(n,window.innerHeight-r.height-n)),y.style.left=`${i}px`,y.style.top=`${o}px`}function Vt(e){if(Be)if(Be.innerHTML="",e){const t=document.createElement("button");t.type="button",t.className="item-preview__action",t.innerHTML='Open external link <span aria-hidden="true">↗</span>',t.title=e,t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),Be.appendChild(t),Be.hidden=!1}else Be.hidden=!0}async function er(e,t){var c;if(!y)return;e.stopPropagation(),e.preventDefault();const n=t.dataset.id,r=((c=t.querySelector(".name"))==null?void 0:c.textContent)||n||"Preview",i=n?`${n}.html`:"",o=i?`items/${i}`:"",a=++Qe,s=t.dataset.externalUrl||"";if(Vt(s),Yt.textContent=r,me.innerHTML='<div class="item-preview__status">Loading…</div>',y.classList.remove("item-preview--has-frame"),y.classList.add("item-preview--expanded"),Zn(e.clientX,e.clientY),!o){me.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',xe(J.x,J.y);return}try{const l=await fetch(o,{cache:"no-cache"});if(!l.ok)throw new Error(`HTTP ${l.status}`);const f=await l.text();if(a!==Qe)return;if(!f.trim()){me.innerHTML=`<div class="item-preview__status">No content in <code>${lt(i)}</code>.</div>`,xe(J.x,J.y);return}const A=document.createElement("iframe");A.className="item-preview__frame",A.title=`${r} details`,A.srcdoc=f,me.innerHTML="",me.appendChild(A),y.classList.add("item-preview--has-frame"),xe(J.x,J.y)}catch(l){if(a!==Qe)return;me.innerHTML=`<div class="item-preview__status">No preview available for <strong>${lt(r)}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${o}`,l),xe(J.x,J.y)}}gt&&gt.addEventListener("click",X),p&&p.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");!t||!p.contains(t)||er(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||!y||y.hidden||y.contains(e.target)||X()}),bt&&bt.addEventListener("click",()=>{$t("button")}),vt&&vt.addEventListener("click",async()=>{var o;if(h<0||!g[h]){alert("Select or load a model before sharing.");return}const e={title:H(g[h],"Shared Model"),data:g[h].data};let t;try{t=tn(JSON.stringify(e))}catch(a){console.error("[Blockscape] share encode failed",a),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const r=n.toString();try{window.history.replaceState({},document.title,r)}catch(a){console.warn("[Blockscape] failed to update URL for share",a),window.location.hash=n.hash}let i=!1;if((o=navigator.clipboard)!=null&&o.writeText)try{await navigator.clipboard.writeText(r),i=!0}catch(a){console.warn("[Blockscape] clipboard write failed",a)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",r)}),yt&&yt.addEventListener("click",()=>{const e=(d.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};E&&(n.selectedItemId=E),localStorage.setItem(Ne,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";E&&(t=`editor.html?selected=${encodeURIComponent(E)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==Ne||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||Tt("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===Xt&&Tt("message")})),document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault(),$t("shortcut");return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!Me())return;if(ur()){e.preventDefault();return}}if(e.key==="Escape"&&y&&!y.hidden&&X(),e.key==="ArrowLeft"||e.key==="ArrowRight"){if(!Me()||e.altKey||e.ctrlKey||e.metaKey)return;const t=e.key==="ArrowLeft"?-1:1;e.shiftKey?sr(t)&&e.preventDefault():cr(t)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(!Me()||e.altKey||e.ctrlKey||e.metaKey)return;const t=e.key==="ArrowUp"?-1:1;e.shiftKey?dr(t)&&e.preventDefault():lr(t)&&e.preventDefault()}if(e.key==="Delete"){if(!Me()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;fr()&&e.preventDefault()}}),window.addEventListener("resize",()=>{!y||y.hidden||xe(J.x,J.y)}),window.addEventListener("scroll",()=>{!y||y.hidden||X()},!0);let ee=null,Pe=null;function tr(e){X(),ee=e.target.dataset.id,Pe=e.target.closest(".category").dataset.cat,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({itemId:ee,categoryId:Pe})),e.target.closest(".category").querySelector(".grid").classList.add("drag-active"),console.log("[Blockscape] drag start",ee,"from",Pe)}function nr(e){e.target.classList.remove("dragging"),p.querySelectorAll(".grid").forEach(t=>t.classList.remove("drag-active")),p.querySelectorAll(".tile").forEach(t=>t.classList.remove("drag-over")),ee=null,Pe=null}function rr(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function ir(e){e.preventDefault();const t=e.target.closest(".grid");t&&t.classList.add("drag-active")}function or(e){const t=e.target.closest(".grid");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-active")}function ar(e){e.preventDefault();const t=e.target.closest(".grid");if(!t)return;const n=t.closest(".category");if(!n)return;const r=n.dataset.cat;if(!ee||!r)return;const o=Array.from(t.querySelectorAll(".tile")).filter(a=>a.dataset.id!==ee).find(a=>{const s=a.getBoundingClientRect();return e.clientY<s.top+s.height/2});Dt(ee,o?o.dataset.id:null,r),we(),console.log("[Blockscape] drop completed",ee,"from",Pe,"to",r)}function Dt(e,t,n){if(h<0)return;const i=g[h].data.categories||[],o=i.find(f=>(f.items||[]).some(b=>b.id===e)),a=i.find(f=>f.id===n);if(!o||!a)return;o.items=o.items||[],a.items=a.items||[];const s=o.items.findIndex(f=>f.id===e);if(s===-1)return;const[c]=o.items.splice(s,1);let l=a.items.length;if(t){const f=a.items.findIndex(b=>b.id===t);f!==-1&&(l=f)}a.items.splice(l,0,c),ve(),ue()}function sr(e){if(!E||h<0||!e)return!1;const n=g[h].data.categories||[],r=O.get(E);let i=null;if(r!=null&&r.catId&&(i=n.find(c=>c.id===r.catId)),i||(i=n.find(c=>(c.items||[]).some(l=>l.id===E))),!i)return!1;i.items=i.items||[];const o=i.items.findIndex(c=>c.id===E);if(o===-1)return!1;const a=o+e;if(a<0||a>=i.items.length)return!1;const[s]=i.items.splice(o,1);return i.items.splice(a,0,s),ve(),ue(),we(),G(E),!0}function cr(e){if(!C||!C.m||!e)return!1;const t=C.m.categories||[];if(!t.length)return!1;const n=()=>{const c=t.find(l=>(l.items||[]).length);return c?{category:c,item:c.items[0]}:null};if(!E){const c=n();return c?(G(c.item.id),!0):!1}const r=O.get(E);let i=null;if(r!=null&&r.catId&&(i=t.find(c=>c.id===r.catId)),i||(i=t.find(c=>(c.items||[]).some(l=>l.id===E))),!i){const c=n();return c?(G(c.item.id),!0):!1}const o=i.items||[];if(!o.length)return!1;const a=o.findIndex(c=>c.id===E);if(a===-1)return!1;const s=a+e;return s<0||s>=o.length?!1:(G(o[s].id),!0)}function lr(e){if(!C||!C.m||!e)return!1;const t=C.m.categories||[];if(!t.length)return!1;const n=()=>{for(const c of t)if(c.items&&c.items.length)return c.items[0].id;return null};let i=(()=>{if(!E)return-1;const c=O.get(E);if(c!=null&&c.catId){const l=t.findIndex(f=>f.id===c.catId);if(l!==-1)return l}return t.findIndex(l=>(l.items||[]).some(f=>f.id===E))})();if(i===-1){const c=n();return c?(G(c),!0):!1}let a=(t[i].items||[]).findIndex(c=>c.id===E);a===-1&&(a=0);let s=i+e;for(;s>=0&&s<t.length;){const l=t[s].items||[];if(l.length){const f=Math.min(l.length-1,Math.max(0,a));return G(l[f].id),!0}s+=e>0?1:-1}return!1}function dr(e){if(!E||h<0||!e)return!1;const n=g[h].data.categories||[];if(!n.length)return!1;const r=O.get(E);let i=-1;if(r!=null&&r.catId&&(i=n.findIndex(b=>b.id===r.catId)),i===-1&&(i=n.findIndex(b=>(b.items||[]).some(A=>A.id===E))),i===-1)return!1;const o=i+e;if(o<0||o>=n.length)return!1;const a=n[i],s=n[o];if(!s)return!1;a.items=a.items||[],s.items=s.items||[];const c=a.items.findIndex(b=>b.id===E);if(c===-1)return!1;const l=Math.min(s.items.length,Math.max(0,c)),f=l<s.items.length?s.items[l].id:null;return Dt(E,f,s.id),we(),G(E),!0}function ur(){if(!he||h<0)return!1;const e=g[h];if(!e||e.id!==he.modelId)return!1;const t=he,i=(e.data.categories||[]).find(a=>a.id===t.categoryId);if(!i)return!1;i.items=i.items||[];const o=Math.min(Math.max(t.index,0),i.items.length);return i.items.splice(o,0,t.item),he=null,X(),E=null,ve(),ue(),we(),G(t.item.id),console.log("[Blockscape] undo delete restored",t.item.id),!0}function fr(){if(!E||h<0)return!1;const t=g[h].data.categories||[];if(!t.length)return!1;const n=O.get(E);let r=null;if(n!=null&&n.catId&&(r=t.find(l=>l.id===n.catId)),r||(r=t.find(l=>(l.items||[]).some(f=>f.id===E))),!r||!Array.isArray(r.items))return!1;const i=r.items.findIndex(l=>l.id===E);if(i===-1)return!1;const o=r.items.splice(i,1)[0];if(!o)return!1;const a=g[h];he={item:o,categoryId:r.id,index:i,modelId:a?a.id:null};const c=(()=>{var f;if(r.items.length){const b=Math.min(i,r.items.length-1);return((f=r.items[b])==null?void 0:f.id)||null}const l=t.findIndex(b=>b.id===r.id);if(l===-1)return null;for(let b=l+1;b<t.length;b++){const A=t[b].items||[];if(A.length)return A[0].id}for(let b=l-1;b>=0;b--){const A=t[b].items||[];if(A.length)return A[0].id}return null})();return X(),E=null,ve(),ue(),we(),c?G(c):ct(),console.log("[Blockscape] removed item",o.id),!0}wt&&wt.addEventListener("click",async()=>{const e=d.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await on(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),Et&&Et.addEventListener("click",async()=>{try{const e=await an();if(!e){alert("Clipboard is empty.");return}d.value=e,d.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=()=>{try{const e=ye(d.value,"Pasted");if(!e.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",e.length,"model(s)");let t=null;e.forEach((n,r)=>{const i=se(n,{versionLabel:e.length>1?`paste #${r+1}`:"paste"});t==null&&(t=i)}),h===-1&&t!=null?F(t):be()}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{if(h<0){alert("No active model selected.");return}try{const e=JSON.parse(d.value);ae(e,{titleHint:H(g[h]),idHint:Y(g[h])||H(g[h])}),g[h].data=e,g[h].title=e.title||g[h].title,it(),console.log("[Blockscape] replaced active model:",H(g[h])),ue(),ge()}catch(e){console.error("[Blockscape] replace error:",e),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const r of t){const i=await r.text(),o=ye(i,r.name.replace(/\.[^.]+$/,"")||"File");if(!o.length){console.warn("[Blockscape] no models in file:",r.name);continue}o.forEach((a,s)=>{var b;const c=(((b=a.data)==null?void 0:b.title)??"").toString().trim(),l=o.length>1?`${r.name} #${s+1}`:r.name,f=se({...a,title:c||l},{versionLabel:r.name});n==null&&(n=f)})}h===-1&&n!=null?F(n):be()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",pr);function pr(e){var i;if(!Me())return;const t=((i=e.clipboardData)==null?void 0:i.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Hn(t))return;let n=[];try{n=ye(t,"Clipboard")}catch(o){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",o);return}if(!n.length)return;e.preventDefault();let r=null;n.forEach((o,a)=>{const s=se(o,{versionLabel:n.length>1?`paste #${a+1}`:"paste"});r==null&&(r=s)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),r!=null&&F(r)}I.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&(Dn(),F(n))}),document.getElementById("removeModel").onclick=()=>{if(h<0)return;if(console.log("[Blockscape] removing model:",H(g[h])),g.splice(h,1),!g.length){h=-1,C=null,p.innerHTML="",w.innerHTML="",d.value="",be(),it();return}const e=Math.min(h,g.length-1);F(e)},document.getElementById("search").addEventListener("input",e=>{const t=e.target.value.trim().toLowerCase();console.log("[Blockscape] search:",t),p.querySelectorAll(".tile").forEach(n=>{const r=n.querySelector(".name").textContent.toLowerCase();n.style.opacity=!t||r.includes(t)?1:.2})}),W&&M&&_&&W.addEventListener("submit",async e=>{e.preventDefault();const t=M.value.trim();if(!t){alert("Please enter a URL"),M.focus();return}const n=await dt(t);if(typeof n=="number"){F(n),M.value="";const r=document.getElementById("urlHint");r&&(r.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!M||!t)return;let n=null;M.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=M.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function ue(){if(!(h<0))try{C=Gn(g[h].data),we()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function mr(){const e=["blockscape.bs","planets.bs"],t=n=>Ge?Ge.endsWith("/")?`${Ge}${n}`:`${Ge}/${n}`:n;for(const n of e)try{const r=await fetch(t(n),{cache:"no-store"});if(!r.ok){console.warn(`[Blockscape] ${n} not fetched (${r.status}); skipping`);continue}const i=await r.text(),o=n.replace(/\.[^.]+$/,"")||"Model",a=ye(i,o);if(!a.length){console.warn("[Blockscape] no models found in",n);continue}a.forEach(s=>{se(s,{versionLabel:n})}),console.log(`[Blockscape] loaded ${a.length} model(s) from ${n}`)}catch(r){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",r)}be()}async function hr(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const r of t)try{console.log(`[Blockscape] fetching ${e} with cache="${r.cache??"default"}"`);const i=await fetch(e,r);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function gr(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(r=>br(r)),e.querySelectorAll("a[href]").forEach(r=>{const i=r.getAttribute("href");Jt(i)&&jt(r,i)})}function br(e){if(!e||!e.nodeValue||!e.nodeValue.includes("http"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,r=[];let i;for(;(i=n.exec(t))!==null;)Jt(i[0])&&r.push({url:i[0],index:i.index});if(!r.length)return;const o=document.createDocumentFragment();let a=0;r.forEach(({url:s,index:c})=>{c>a&&o.appendChild(document.createTextNode(t.slice(a,c))),o.appendChild(vr(s)),a=c+s.length}),a<t.length&&o.appendChild(document.createTextNode(t.slice(a))),e.parentNode.replaceChild(o,e)}function vr(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",jt(t,e),t}function jt(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>yr(n,t,e)))}async function yr(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await dt(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Jt(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function dt(e){try{console.log("[Blockscape] loading from URL:",e);const t=await hr(e),r=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=ye(t,r)}catch(a){throw new Error(`Invalid JSON payload: ${a.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let o=null;return i.forEach((a,s)=>{var b;const c=(((b=a.data)==null?void 0:b.title)??"").toString().trim(),l=i.length>1?`${r} #${s+1}`:r,f=se({...a,title:c||l},{versionLabel:r});o==null&&(o=f)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,r),h===-1&&o!=null?F(o):be(),o}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const r=JSON.parse(n);ae(r,{titleHint:r.title||"Blockscape",idHint:r.id||"blockscape"}),g.push({id:oe(),title:r.title||"Blockscape",data:r}),await mr();const i=await qn(),o=_t(),a=o==null?void 0:o.index,s=Fn();F(typeof i=="number"?i:typeof s=="number"?s:typeof a=="number"?a:0)})()}function Hr(d){let u,p,w,v,I,y=`<script id="seed" type="application/json">${d[0]}<\/script>`,W,M,_,$,L,U;return{c(){u=De("link"),p=Ve(),w=De("div"),w.innerHTML=`<header class="pf-v5-c-page__header"><div class="pf-v5-c-masthead pf-m-display-inline blockscape-masthead"><div class="pf-v5-c-masthead__content"><div class="blockscape-toolbar"><div class="blockscape-brand"><h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/> <a href="https://github.com/pwright/blockscape" target="_blank" class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></div> <div class="blockscape-toolbar__controls"><label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <form id="urlForm" class="blockscape-url-form" autocomplete="on" novalidate=""><label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-secondary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div></form> <label class="pf-v5-c-button pf-m-secondary blockscape-file"><span>Load File(s)</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/></label> <button id="openInEditor" class="pf-v5-c-button pf-m-primary" type="button" title="Open current JSON in the editor">Edit</button> <button id="shareModel" class="pf-v5-c-button pf-m-primary" type="button" title="Copy a shareable URL for this model">Share</button></div> <div class="blockscape-legend" role="presentation"><span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span> <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span> <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span> <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span></div></div></div></div></header> <main class="pf-v5-c-page__main"><div class="blockscape-content"><aside class="blockscape-sidebar" aria-label="Models"><div class="sidebar-heading">Models</div> <ul id="modelList" class="model-nav-list"></ul> <div class="model-actions"><button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button></div></aside> <div class="blockscape-main"><section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,logo?,external?:url,color?,deps:[]}}], links?:[{from,to}] }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code> to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section></div></div></main>`,v=Ve(),I=new Cr(!1),W=Ve(),M=Kt("svg"),_=Ve(),$=De("div"),L=Ve(),U=De("div"),U.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',document.title="Blockscape — simple landscape-style tiles",V(u,"rel","icon"),V(u,"type","image/svg+xml"),V(u,"href","/favicon.svg"),V(w,"class","pf-v5-c-page"),I.a=W,V(M,"id","overlay"),V(M,"class","svg-layer"),V($,"id","tabTooltip"),V($,"class","blockscape-tab-tooltip"),$.hidden=!0,V($,"aria-hidden","true"),V(U,"id","itemPreview"),V(U,"class","item-preview"),U.hidden=!0,V(U,"aria-hidden","true")},m(N,T){Ar(document.head,u),K(N,p,T),K(N,w,T),K(N,v,T),I.m(y,N,T),K(N,W,T),K(N,M,T),K(N,_,T),K(N,$,T),K(N,L,T),K(N,U,T)},p:Ie,i:Ie,o:Ie,d(N){N&&(D(p),D(w),D(v),I.d(),D(W),D(M),D(_),D($),D(L),D(U)),D(u)}}}function Fr(d){const u=`{
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the Communication layer that makes maps comprehensible, alongside concrete user experiences, authoring & LLM flows, presentation semantics, and the platform services that enable them.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        { "id": "gestalt", "name": "Visual schema", "deps": [] },
        { "id": "value-chain", "name": "Value chain (y-axis)", "deps": [] },
        { "id": "spacial-memory", "name": "Spacial memory", "deps": [] },
        { "id": "evolution", "name": "Evolution (x-axis)", "deps": [] },
        { "id": "legend-literacy", "name": "Legend literacy", "deps": [] },
        { "id": "relational-awareness", "name": "Relational awareness", "deps": [] },
        { "id": "icons", "name": "Iconography", "deps": [] }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        { "id": "paste-bs-file", "name": "Paste BS File", "deps": ["bs-parser", "schema-validator"] },
        { "id": "load-multidoc-file", "name": "Load Multi-Document File", "deps": ["multidoc-assembler", "bs-parser", "schema-validator"] },
        { "id": "load-multidoc-from-url", "name": "Load Multi-Document from URL", "deps": ["url-fetcher", "multidoc-assembler", "bs-parser", "schema-validator"] },
        { "id": "create-gist-multidoc", "name": "Create Header+Detail in Gist", "deps": ["gist-integration", "multidoc-assembler", "schema-validator"] },
        { "id": "abstract-gist-loading", "name": "Abstract Supports Gist Loading", "deps": ["gist-integration", "bs-parser", "schema-validator"] }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring and LLM",
      "items": [
        { "id": "bs-format-simple", "name": "BS format is simple", "deps": [] },
        { "id": "editor-human-terms", "name": "Editor (human terms)", "deps": ["gestalt"] },
        { "id": "llm-generate-bs", "name": "LLM generates BS", "deps": ["schema-validator"], "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md" },
        { "id": "llm-consume-bs", "name": "LLM consumes BS", "deps": ["bs-parser"] }
      ]
    },
    {
      "id": "presentation",
      "title": "Presentation Semantics",
      "items": [
        { "id": "layout_engine", "name": "Layout Engine", "deps": ["bs-parser", "gestalt", "icons"] },
        { "id": "value_visibility_axis", "name": "Vertical Position = Visible Value", "deps": ["spacial-memory", "legend-literacy", "value-chain"] },
        { "id": "evolution_axis", "name": "Horizontal Evolution (Optional)", "deps": ["legend-literacy", "evolution"] }
      ]
    },
    {
      "id": "platform",
      "title": "Platform Services",
      "items": [
        { "id": "bs-parser", "name": "BS Parser", "deps": [] },
        { "id": "multidoc-assembler", "name": "Multi-Doc Assembler", "deps": [] },
        { "id": "gist-integration", "name": "Gist Integration", "deps": [] },
        { "id": "url-fetcher", "name": "URL Fetcher", "deps": [] },
        { "id": "schema-validator", "name": "Schema Validator", "deps": [] }
      ]
    }
  ]
}`;return $r(()=>{Jr()}),[u]}class qr extends Dr{constructor(u){super(),Vr(this,u,Fr,Hr,xr,{})}}const Gr=document.getElementById("root");new qr({target:Gr});
