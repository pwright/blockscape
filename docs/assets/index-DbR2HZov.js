var bn=Object.defineProperty;var vn=(s,f,g)=>f in s?bn(s,f,{enumerable:!0,configurable:!0,writable:!0,value:g}):s[f]=g;var Ce=(s,f,g)=>vn(s,typeof f!="symbol"?f+"":f,g);(function(){const f=document.createElement("link").relList;if(f&&f.supports&&f.supports("modulepreload"))return;for(const L of document.querySelectorAll('link[rel="modulepreload"]'))N(L);new MutationObserver(L=>{for(const R of L)if(R.type==="childList")for(const S of R.addedNodes)S.tagName==="LINK"&&S.rel==="modulepreload"&&N(S)}).observe(document,{childList:!0,subtree:!0});function g(L){const R={};return L.integrity&&(R.integrity=L.integrity),L.referrerPolicy&&(R.referrerPolicy=L.referrerPolicy),L.crossOrigin==="use-credentials"?R.credentials="include":L.crossOrigin==="anonymous"?R.credentials="omit":R.credentials="same-origin",R}function N(L){if(L.ep)return;L.ep=!0;const R=g(L);fetch(L.href,R)}})();function Ve(){}function Ft(s){return s()}function jt(){return Object.create(null)}function st(s){s.forEach(Ft)}function qt(s){return typeof s=="function"}function yn(s,f){return s!=s?f==f:s!==f||s&&typeof s=="object"||typeof s=="function"}function wn(s){return Object.keys(s).length===0}function En(s,f){s.appendChild(f)}function me(s,f,g){s.insertBefore(f,g||null)}function ae(s){s.parentNode&&s.parentNode.removeChild(s)}function Ke(s){return document.createElement(s)}function Gt(s){return document.createElementNS("http://www.w3.org/2000/svg",s)}function xn(s){return document.createTextNode(s)}function ze(){return xn(" ")}function ie(s,f,g){g==null?s.removeAttribute(f):s.getAttribute(f)!==g&&s.setAttribute(f,g)}function kn(s){return Array.from(s.childNodes)}class An{constructor(f=!1){Ce(this,"is_svg",!1);Ce(this,"e");Ce(this,"n");Ce(this,"t");Ce(this,"a");this.is_svg=f,this.e=this.n=null}c(f){this.h(f)}m(f,g,N=null){this.e||(this.is_svg?this.e=Gt(g.nodeName):this.e=Ke(g.nodeType===11?"TEMPLATE":g.nodeName),this.t=g.tagName!=="TEMPLATE"?g:g.content,this.c(f)),this.i(N)}h(f){this.e.innerHTML=f,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(f){for(let g=0;g<this.n.length;g+=1)me(this.t,this.n[g],f)}p(f){this.d(),this.h(f),this.i(this.a)}d(){this.n.forEach(ae)}}let Ye;function We(s){Ye=s}function Ln(){if(!Ye)throw new Error("Function called outside component initialization");return Ye}function Sn(s){Ln().$$.on_mount.push(s)}const Re=[],Dt=[];let je=[];const Jt=[],Cn=Promise.resolve();let _t=!1;function In(){_t||(_t=!0,Cn.then(zt))}function Ut(s){je.push(s)}const It=new Set;let Pe=0;function zt(){if(Pe!==0)return;const s=Ye;do{try{for(;Pe<Re.length;){const f=Re[Pe];Pe++,We(f),$n(f.$$)}}catch(f){throw Re.length=0,Pe=0,f}for(We(null),Re.length=0,Pe=0;Dt.length;)Dt.pop()();for(let f=0;f<je.length;f+=1){const g=je[f];It.has(g)||(It.add(g),g())}je.length=0}while(Re.length);for(;Jt.length;)Jt.pop()();_t=!1,It.clear(),We(s)}function $n(s){if(s.fragment!==null){s.update(),st(s.before_update);const f=s.dirty;s.dirty=[-1],s.fragment&&s.fragment.p(s.ctx,f),s.after_update.forEach(Ut)}}function Nn(s){const f=[],g=[];je.forEach(N=>s.indexOf(N)===-1?f.push(N):g.push(N)),g.forEach(N=>N()),je=f}const Bn=new Set;function Tn(s,f){s&&s.i&&(Bn.delete(s),s.i(f))}function _n(s,f,g){const{fragment:N,after_update:L}=s.$$;N&&N.m(f,g),Ut(()=>{const R=s.$$.on_mount.map(Ft).filter(qt);s.$$.on_destroy?s.$$.on_destroy.push(...R):st(R),s.$$.on_mount=[]}),L.forEach(Ut)}function Un(s,f){const g=s.$$;g.fragment!==null&&(Nn(g.after_update),st(g.on_destroy),g.fragment&&g.fragment.d(f),g.on_destroy=g.fragment=null,g.ctx=[])}function Mn(s,f){s.$$.dirty[0]===-1&&(Re.push(s),In(),s.$$.dirty.fill(0)),s.$$.dirty[f/31|0]|=1<<f%31}function On(s,f,g,N,L,R,S=null,te=[-1]){const O=Ye;We(s);const T=s.$$={fragment:null,ctx:[],props:R,update:Ve,not_equal:L,bound:jt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(f.context||(O?O.$$.context:[])),callbacks:jt(),dirty:te,skip_bound:!1,root:f.target||O.$$.root};S&&S(T.root);let q=!1;if(T.ctx=g?g(s,f.props||{},(V,D,...j)=>{const H=j.length?j[0]:D;return T.ctx&&L(T.ctx[V],T.ctx[V]=H)&&(!T.skip_bound&&T.bound[V]&&T.bound[V](H),q&&Mn(s,V)),D}):[],T.update(),q=!0,st(T.before_update),T.fragment=N?N(T.ctx):!1,f.target){if(f.hydrate){const V=kn(f.target);T.fragment&&T.fragment.l(V),V.forEach(ae)}else T.fragment&&T.fragment.c();f.intro&&Tn(s.$$.fragment),_n(s,f.target,f.anchor),zt()}We(O)}class Pn{constructor(){Ce(this,"$$");Ce(this,"$$set")}$destroy(){Un(this,1),this.$destroy=Ve}$on(f,g){if(!qt(g))return Ve;const N=this.$$.callbacks[f]||(this.$$.callbacks[f]=[]);return N.push(g),()=>{const L=N.indexOf(g);L!==-1&&N.splice(L,1)}}$set(f){this.$$set&&!wn(f)&&(this.$$.skip_bound=!0,this.$$set(f),this.$$.skip_bound=!1)}}const Rn="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Rn);const Ht="blockscape:apicurioConfig",$t="http://localhost:8080/apis/registry/v3",Nt="bs",Bt=!1,Tt=!1;function Vn({models:s,getActiveIndex:f,setActive:g,ensureModelMetadata:N,getModelId:L,getModelTitle:R,computeJsonFingerprint:S,uid:te}){let O=null,T=null,q=null,V=null,D=null,j=null,H=null,he=null,Q=null;const _={baseUrl:$t,groupId:Nt,authToken:"",enabled:Bt,useSemver:Tt},se=new Map,Z=new Map;function ge(o){return(o||"").toString().trim().replace(/\/+$/,"")}function be(){return!!(_.baseUrl&&_.groupId)}function x(){return _.enabled!==!1}function k(){q&&(q.value=_.baseUrl||""),V&&(V.value=_.groupId||""),D&&(D.value=_.authToken||""),j&&(j.checked=x()),H&&(H.checked=!!_.useSemver)}function B(o="",c="muted"){he&&(he.textContent=o||"",he.classList.remove("is-error","is-success"),c==="error"?he.classList.add("is-error"):c==="success"&&he.classList.add("is-success"))}function P(o){if(!Q||(Q.innerHTML="",!o))return;const c=document.createElement("p");c.className="apicurio-hint",c.textContent=o,Q.appendChild(c)}function z(o){se.clear(),Z.clear(),P(o)}function C(){const o=f(),c=x(),u=be();if(O){const p=O.dataset.loading==="true",d=c&&u&&o>=0&&!!L(s[o]);O.disabled=!c||p||!d,c?p||(O.textContent="Push to Apicurio"):O.textContent="Enable Apicurio to push"}if(T){const p=T.dataset.loading==="true",d=c&&u;T.disabled=!d||p,p||(c?u?T.textContent="List artifacts":T.textContent="Enter details to list":T.textContent="Enable Apicurio to list")}}function ve(){k(),x()?be()?(B("Apicurio push is ready when a model is selected.","muted"),se.size||P("Click “List artifacts” to browse the current group.")):(B("Enter Apicurio connection details to enable push.","muted"),z("Enter registry details to browse artifacts.")):(B("Apicurio integration is off. Enable it to allow pushes.","muted"),z("Apicurio integration is disabled.")),C()}function Y(){if(window!=null&&window.localStorage)try{localStorage.setItem(Ht,JSON.stringify(_))}catch(o){console.warn("[Blockscape] unable to persist Apicurio settings",o)}}function Ee(){let o={};if(window!=null&&window.localStorage)try{const b=localStorage.getItem(Ht);if(b){const I=JSON.parse(b);I&&typeof I=="object"&&(o=I)}}catch(b){console.warn("[Blockscape] failed to restore Apicurio settings",b)}const c=ge(o.baseUrl??$t),u=(o.groupId??Nt).toString().trim();let p=Bt,d=Tt;typeof o.enabled=="boolean"?p=o.enabled:typeof o.enabled=="string"&&(p=o.enabled==="true"),typeof o.useSemver=="boolean"?d=o.useSemver:typeof o.useSemver=="string"&&(d=o.useSemver==="true"),_.baseUrl=c||$t,_.groupId=u||Nt,_.authToken=(o.authToken??"").toString().trim(),_.enabled=p,_.useSemver=d,ve()}function ne(){const o={Accept:"application/json"},c=(_.authToken||"").trim();return c&&(o.Authorization=/\s/.test(c)?c:`Bearer ${c}`),o}function ct(o,c,{title:u,description:p,version:d}={}){const b={artifactId:o,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:c}}};return d&&(b.firstVersion.version=d),u&&(b.name=u),p&&(b.description=p),b}function lt(o,{version:c}={}){const u={content:{contentType:"application/json",content:o}};return c&&(u.version=c),u}function dt(o){if(o==null)return null;const c=String(o).trim();if(!c)return null;const u=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(c);if(u)return{major:Number(u[1]),minor:Number(u[2]),patch:Number(u[3])};const p=/^v?(\d+)$/.exec(c);return p?{major:Number(p[1]),minor:0,patch:0}:null}function ut(o){return`${o.major}.${o.minor}.${o.patch}`}function ft(o,c){return!o&&!c?0:o?c?o.major!==c.major?o.major-c.major:o.minor!==c.minor?o.minor-c.minor:o.patch-c.patch:1:-1}function pt(o=[]){let c=null;if(o.forEach(p=>{const d=dt((p==null?void 0:p.version)??p);d&&(!c||ft(d,c)>0)&&(c=d)}),!c)return"1.0.0";const u={...c,patch:c.patch+1};return ut(u)}function mt(o){return Array.isArray(o)?o:Array.isArray(o==null?void 0:o.artifacts)?o.artifacts:Array.isArray(o==null?void 0:o.items)?o.items:Array.isArray(o==null?void 0:o.results)?o.results:[]}function Xe(o){return Array.isArray(o)?o:Array.isArray(o==null?void 0:o.versions)?o.versions:Array.isArray(o==null?void 0:o.items)?o.items:[]}function _e(o=[]){if(!Array.isArray(o)||!o.length)return null;const c=[...o].filter(Boolean);return c.sort((u,p)=>{const d=u!=null&&u.createdOn?new Date(u.createdOn).getTime():0,b=p!=null&&p.createdOn?new Date(p.createdOn).getTime():0;if(d!==b)return b-d;const I=Number(u==null?void 0:u.version),y=Number(p==null?void 0:p.version),$=Number.isFinite(I),w=Number.isFinite(y);if($&&w&&I!==y)return y-I;const A=String((u==null?void 0:u.version)??"");return String((p==null?void 0:p.version)??"").localeCompare(A,void 0,{numeric:!0})}),c[0]||null}function Qe(o){if(!o)return o;let c=o;if(!Array.isArray(o==null?void 0:o.categories)){const p=o==null?void 0:o.content;if(typeof p=="string")try{c=JSON.parse(p)}catch(d){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",d)}else p&&typeof p=="object"&&(c=p)}return c}async function Ze(o,c,u){const p=encodeURIComponent(c),d=encodeURIComponent(u),b=`${o}/groups/${p}/artifacts/${d}`,I=ne();I.Accept="application/json";const y=await fetch(b,{method:"GET",headers:I});if(!y.ok){let $=y.statusText||"Unknown error";try{const w=await y.text();w&&($=w.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${y.status}): ${$}`)}return y.json()}async function ce(o,c,u){const p=encodeURIComponent(c),d=encodeURIComponent(u),b=`${o}/groups/${p}/artifacts/${d}/versions?limit=50&order=desc`,I=ne();I.Accept="application/json";const y=await fetch(b,{method:"GET",headers:I});if(!y.ok){let w=y.statusText||"Unknown error";try{const A=await y.text();A&&(w=A.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${y.status}): ${w}`)}const $=await y.json();return Xe($).filter(w=>w&&w.version!=null)}async function X(o,c,u,p="latest"){const d=encodeURIComponent(c),b=encodeURIComponent(u),I=encodeURIComponent(p||"latest"),y=`${o}/groups/${d}/artifacts/${b}/versions/${I}/content`,$=ne();$.Accept="application/json, application/*+json, */*;q=0.8";const w=await fetch(y,{method:"GET",headers:$});if(!w.ok){let ue=w.statusText||"Unknown error";try{const K=await w.text();K&&(ue=K.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${w.status}): ${ue}`)}const A=await w.text();let re=null;try{re=JSON.parse(A)}catch{throw new Error("Artifact content is not valid JSON.")}return Qe(re)}async function ht(o,c,u,p="latest"){const d=await X(o,c,u,p);return{data:d,fingerprint:S(d)}}async function de(o,c,u){try{const d=await ce(o,c,u);if(d!=null&&d.length){Z.set(u,d);const b=_e(d);if((b==null?void 0:b.version)!=null)return b.version}}catch(d){console.warn("[Blockscape] compare-version: unable to fetch versions list",d)}try{const d=await Ze(o,c,u);if((d==null?void 0:d.version)!=null)return d.version}catch(d){console.warn("[Blockscape] compare-version: unable to fetch metadata",d)}const p=Z.get(u);if(p&&p.length){const d=_e(p);if((d==null?void 0:d.version)!=null)return d.version}return"latest"}async function ye(o,c,u,p){if(!_.useSemver)return null;if(!p)return"1.0.0";try{const d=await ce(o,c,u);return pt(d)}catch(d){throw new Error(`Unable to compute next semantic version: ${d.message}`)}}function De(o=document){O=o.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),T=o.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),q=o.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),V=o.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),D=o.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),j=o.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),H=o.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),he=o.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),Q=o.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function et(){_.baseUrl=ge((q==null?void 0:q.value)??_.baseUrl),_.groupId=((V==null?void 0:V.value)??"").trim(),_.authToken=((D==null?void 0:D.value)??"").trim(),Y(),ve()}function gt(){_.enabled=j?j.checked:Bt,Y(),ve()}function bt(){_.useSemver=H?H.checked:Tt,Y(),ve()}function vt(){[q,V,D].forEach(o=>{o&&o.addEventListener("input",et)}),O&&O.addEventListener("click",()=>{wt()}),j&&j.addEventListener("change",gt),H&&H.addEventListener("change",bt),T&&T.addEventListener("click",Ie),Q&&Q.addEventListener("click",o=>{const c=o.target.closest("[data-artifact-version]");if(c){o.stopPropagation();const d=c.dataset.artifactId,b=c.dataset.artifactVersion;d&&b&&Et(d,b);return}const u=o.target.closest("[data-artifact-load-all]");if(u){o.stopPropagation();const d=u.dataset.artifactId;d&&rt(d);return}const p=o.target.closest("[data-artifact-trigger]");if(p){const d=p.dataset.artifactId;if(!d)return;ke(d)}})}function yt(){const o=document.createElement("div");return o.className="blockscape-registry-panel",o.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,o}function Je(o){if(!o)return;o.innerHTML="";const c=yt();o.appendChild(c),De(o),vt(),ve()}function tt(o){if(!Q)return;if(Q.innerHTML="",!o.length){P("No artifacts found in this group.");return}const c=document.createElement("ul");c.className="apicurio-artifact-list",o.forEach(u=>{if(!(u!=null&&u.artifactId))return;const p=document.createElement("li"),d=document.createElement("button");d.type="button",d.className="apicurio-artifact",d.dataset.artifactId=u.artifactId,d.dataset.artifactTrigger="toggle";const b=document.createElement("span");b.className="apicurio-artifact-title",b.textContent=u.artifactId,d.appendChild(b);const I=[];if(u.name&&I.push(u.name),u.version!=null&&I.push(`v${u.version}`),u.type&&I.push(u.type),I.length){const w=document.createElement("span");w.className="apicurio-artifact-meta",w.textContent=I.join(" • "),d.appendChild(w)}if(u.description){const w=document.createElement("span");w.className="apicurio-artifact-meta",w.textContent=u.description,d.appendChild(w)}p.appendChild(d);const y=document.createElement("div");y.className="apicurio-version-list",y.dataset.versionPanel=u.artifactId,y.hidden=!0;const $=document.createElement("p");$.className="apicurio-hint",$.textContent="Click above to choose a version to load.",y.appendChild($),p.appendChild(y),c.appendChild(p)}),Q.appendChild(c)}function Ue(o){return Q?Q.querySelector(`[data-version-panel="${o}"]`):null}function W(o,c){if(!o||(o.innerHTML="",!c))return;const u=document.createElement("p");u.className="apicurio-hint",u.textContent=c,o.appendChild(u)}function xe(o,c){const u=Ue(o);if(!u)return;if(u.innerHTML="",!c.length){W(u,"No versions found for this artifact.");return}c.forEach(d=>{const b=document.createElement("button");b.type="button",b.className="apicurio-version-button",b.dataset.artifactId=o,b.dataset.artifactVersion=d.version;const I=[`Version ${d.version}`];if(d.createdOn){const y=new Date(d.createdOn);isNaN(y)||I.push(y.toISOString().slice(0,10))}b.textContent=I.join(" — "),u.appendChild(b)});const p=document.createElement("button");p.type="button",p.className="apicurio-version-button",p.dataset.artifactId=o,p.dataset.artifactLoadAll="true",p.textContent=`Load all (${c.length})`,u.appendChild(p)}async function ke(o){const c=Ue(o);if(!c)return;if(c.dataset.open==="true"){c.hidden=!0,c.dataset.open="false";return}if(c.hidden=!1,c.dataset.open="true",c.dataset.loaded!=="true"){if(!be()){W(c,"Enter registry details first.");return}W(c,"Loading versions…");try{const p=ge(_.baseUrl),d=_.groupId.trim(),b=await ce(p,d,o);Z.set(o,b),c.dataset.loaded="true",xe(o,b)}catch(p){console.error("[Blockscape] failed to load versions",p),W(c,`Unable to fetch versions: ${p.message}`)}}}function nt(o,c){var p;const u=s.findIndex(d=>d.apicurioArtifactId===o);if(u!==-1){const d=s[u].id;s[u]={...c,id:d||c.id},((p=s[u].apicurioVersions)==null?void 0:p.length)>1&&(s[u].isSeries=!0),g(u)}else s.push(c),g(s.length-1)}async function Ae(o,c,u,p){const d=encodeURIComponent(c),b=encodeURIComponent(u),I=`${o}/groups/${d}/artifacts/${b}`;try{const y=await fetch(I,{method:"GET",headers:p});if(y.status===404)return!1;if(y.ok)return!0;throw y.status===401||y.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${y.status} while checking the artifact.`)}catch(y){throw y instanceof TypeError?new Error("Network error while contacting Apicurio registry."):y}}async function wt(){var I;if(!O||O.dataset.loading==="true")return;if(!x()){B("Apicurio integration is off. Enable it first.","error");return}if(!be()){B("Enter the registry base URL and group ID before pushing.","error");return}const o=f();if(o<0||!s[o]){B("No active model to push.","error");return}const c=L(s[o]);if(!c){B("Active model needs an id before pushing.","error");return}const u=ge(_.baseUrl),p=_.groupId.trim(),d=JSON.stringify(s[o].data,null,2),b=ne();O.dataset.loading="true",O.textContent="Pushing…",O.disabled=!0,B("Pushing to Apicurio…","muted");try{const y=await Ae(u,p,c,b),$=S(s[o].data);if(y)try{const we=await de(u,p,c),{data:Ne,fingerprint:le}=await ht(u,p,c,we);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",we),console.log("local fingerprint",$),console.log("registry fingerprint",le),console.log("local payload",s[o].data),console.log("registry payload",Ne),console.groupEnd(),$&&le&&$===le){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){B("Push cancelled (content matches the latest registry version).","muted");return}B("Pushing identical content by user choice.","muted")}else le?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):B("Unable to compare with registry content (skipping confirmation).","muted")}catch(we){console.warn("[Blockscape] unable to compare registry content before push",we),B("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const w=_.useSemver?await ye(u,p,c,y):null;if(_.useSemver&&!w)throw new Error("Semantic versioning is enabled but no version could be computed.");const A=encodeURIComponent(p),re=encodeURIComponent(c),ue=y?`${u}/groups/${A}/artifacts/${re}/versions`:`${u}/groups/${A}/artifacts`,K={...b,"Content-Type":"application/json"};w&&(K["X-Registry-Version"]=w,B(`Pushing to Apicurio as version ${w}…`,"muted"));const $e=y?lt(d,{version:w}):ct(c,d,{title:R(s[o]),description:(I=s[o].data)==null?void 0:I.abstract,version:w}),Le=await fetch(ue,{method:"POST",headers:K,body:JSON.stringify($e)});if(!Le.ok){let we=Le.statusText||"Unknown error";try{const Ne=await Le.text();Ne&&(we=Ne.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Le.status}): ${we}`)}let ee=null;try{ee=await Le.json()}catch{ee=null}const He=(ee==null?void 0:ee.version)||(ee==null?void 0:ee.globalId)||"",Fe=y?"Updated":"Created",xt=He?` (version ${He})`:"";B(`${Fe} ${c}${xt}`,"success")}catch(y){console.error("[Blockscape] Apicurio push failed",y),B(`Apicurio push failed: ${y.message}`,"error")}finally{O.dataset.loading="false",C()}}async function Ie(){if(!T||T.dataset.loading==="true")return;if(!x()){B("Enable Apicurio integration to list artifacts.","error");return}if(!be()){B("Enter registry base URL and group ID before listing.","error");return}const o=ge(_.baseUrl),c=_.groupId.trim(),u=encodeURIComponent(c),p=`${o}/groups/${u}/artifacts?limit=50&offset=0`;T.dataset.loading="true",T.textContent="Listing…",T.disabled=!0,B("Listing artifacts…","muted"),P("Contacting registry…");try{const d=ne();d.Accept="application/json";const b=await fetch(p,{method:"GET",headers:d});if(!b.ok){let w=b.statusText||"Unknown error";try{const A=await b.text();A&&(w=A.slice(0,400))}catch{}throw new Error(`Failed to list artifacts (${b.status}): ${w}`)}const I=await b.json(),y=mt(I).filter(w=>w&&w.artifactId);se.clear(),Z.clear(),y.forEach(w=>{w!=null&&w.artifactId&&se.set(w.artifactId,w)}),tt(y);const $=y.length;B($?`Found ${$} artifact${$===1?"":"s"}.`:"No artifacts found in this group.",$?"success":"muted")}catch(d){console.error("[Blockscape] failed to list artifacts",d),z("Unable to list artifacts."),B(`Listing failed: ${d.message}`,"error")}finally{T.dataset.loading="false",C()}}async function Et(o,c=null){if(!o)return;if(!x()){B("Enable Apicurio integration to load artifacts.","error");return}if(!be()){B("Enter registry connection details before loading artifacts.","error");return}const u=ge(_.baseUrl),p=_.groupId.trim();let d=se.get(o);const b=async()=>{try{const A=await Ze(u,p,o);return A!=null&&A.artifactId&&se.set(o,A),A}catch(A){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",A),A}};if(!d)try{d=await b()}catch(A){B(`Failed to fetch artifact metadata: ${A.message}`,"error");return}const I=Z.get(o)||[];let y="latest",$="latest";if(c)y=c,$=c;else{if(!d||d.version==null)try{d=await b()}catch(A){B(`Failed to fetch artifact metadata: ${A.message}`,"error");return}y=(d==null?void 0:d.version)||"latest",$=(d==null?void 0:d.version)||"latest"}const w=I.find(A=>String(A.version)===String(y));(w==null?void 0:w.version)!=null&&($=w.version),B(`Loading artifact ${o}…`,"muted");try{const A=await X(u,p,o,y),re=se.get(o)||d||{};N(A,{titleHint:re.name||o,idHint:o});const ue={version:$,data:A,createdOn:(w==null?void 0:w.createdOn)||re.createdOn},K={id:te(),title:A.title||re.name||o,data:A,apicurioArtifactId:o,apicurioArtifactName:re.name||"",apicurioVersions:[ue],apicurioActiveVersionIndex:0};nt(o,K);const $e=$?` (version ${$})`:"";B(`Loaded artifact ${o}${$e}.`,"success")}catch(A){console.error("[Blockscape] failed to load artifact",A),B(`Failed to load artifact: ${A.message}`,"error")}}async function rt(o){if(!o)return;if(!x()){B("Enable Apicurio integration to load artifacts.","error");return}if(!be()){B("Enter registry connection details before loading artifacts.","error");return}const c=ge(_.baseUrl),u=_.groupId.trim();let p=Z.get(o);if(!p){W(Ue(o),"Loading versions…");try{p=await ce(c,u,o),Z.set(o,p)}catch($){B(`Failed to fetch versions: ${$.message}`,"error");return}}const d=(p||[]).filter($=>$&&$.version!=null);if(!d.length){B("No versions found for this artifact.","muted");return}B(`Loading ${d.length} version(s) for ${o}…`,"muted");const b=se.get(o)||{},I=[];try{for(const $ of d){const w=$.version??"latest",A=await X(c,u,o,w);N(A,{titleHint:b.name||o,idHint:o}),I.push({version:w,createdOn:$.createdOn,data:A})}}catch($){console.error("[Blockscape] failed to load one or more versions",$),B(`Failed to load all versions: ${$.message}`,"error");return}if(!I.length){B("No versions loaded from registry.","error");return}const y={id:te(),title:I[0].data.title||b.name||o,data:I[0].data,apicurioArtifactId:o,apicurioArtifactName:b.name||"",apicurioVersions:I,apicurioActiveVersionIndex:0};nt(o,y),B(`Loaded ${I.length} version(s) for ${o}.`,"success")}return{hydrateConfig:Ee,mount:Je,updateAvailability:C}}const at=typeof import.meta<"u"&&"./"||"";function jn(){console.log("[Blockscape] init");const s=document.getElementById("jsonBox"),f=document.querySelector(".blockscape-json-panel"),g=document.getElementById("app"),N=document.getElementById("overlay"),L=document.getElementById("tabTooltip"),R=document.getElementById("modelList"),S=document.getElementById("itemPreview"),te=document.getElementById("urlForm"),O=document.getElementById("urlInput"),T=document.getElementById("loadUrl"),q=S.querySelector(".item-preview__title"),V=S.querySelector(".item-preview__body"),D=S.querySelector(".item-preview__actions"),j=S.querySelector(".item-preview__close"),H=document.getElementById("downloadJson"),he=document.getElementById("shareModel"),Q=document.getElementById("openInEditor"),_=document.getElementById("copyJson"),se=document.getElementById("pasteJson"),Z="blockscape:editorPayload",ge="blockscape:editorTransfer",be=document.title;s.value=document.getElementById("seed").textContent.trim();let x=[],k=-1;const B=Vn({models:x,getActiveIndex:()=>k,setActive:W,ensureModelMetadata:ce,getModelId:de,getModelTitle:X,computeJsonFingerprint:Ze,uid:ne});let P=null,z=new Map,C=null,ve=0,Y={x:0,y:0},Ee=null;B.hydrateConfig();function ne(){return Math.random().toString(36).slice(2,10)}function ct(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(r=>{n+=String.fromCharCode(r)}),btoa(n)}function lt(e){const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return new TextDecoder().decode(n)}function dt(e){return ct(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function ut(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),lt(t)}function ft(e,t){const n=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=e,i.click(),URL.revokeObjectURL(r)}async function pt(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function mt(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Xe(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function _e(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(r=>_e(r)).join(",")}]`:`{${Object.keys(e).sort().map(r=>`${JSON.stringify(r)}:${_e(e[r])}`).join(",")}}`}function Qe(e){try{return _e(e)}catch{return""}}function Ze(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=Qe(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=Qe(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}function ce(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const r=(e.title??"").toString().trim();e.title=r||t||"Untitled Model";const i=(e.id??"").toString().trim();if(i)e.id=i;else{const a=n||e.title||t||"model",l=Xe(a).replace(/\./g,"-");e.id=l||`model-${ne()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function X(e,t="Untitled Model"){var r;return e&&(((r=e.data)==null?void 0:r.title)??e.title??"").toString().trim()||t}function ht(e,t="Untitled Model"){var i;const n=de(e);return(((i=e==null?void 0:e.apicurioVersions)==null?void 0:i.length)>1||(e==null?void 0:e.isSeries))&&n?`${n} series`:X(e,t)}function de(e){var r;const t=(r=e==null?void 0:e.data)==null?void 0:r.id;return t&&t.toString().trim()||null}function ye(e,{versionLabel:t,createdOn:n}={}){var h,m;const r=de(e);if(!r)return x.push(e),x.length-1;const i=x.findIndex(E=>de(E)===r);if(i===-1)return x.push(e),x.length-1;const a=x[i];(!Array.isArray(a.apicurioVersions)||!a.apicurioVersions.length)&&(a.apicurioVersions=[{version:"1",data:a.data,createdOn:(m=(h=a.apicurioVersions)==null?void 0:h[0])==null?void 0:m.createdOn}],a.apicurioActiveVersionIndex=0);const l=String(a.apicurioVersions.length+1);return a.apicurioVersions.push({version:l,data:e.data,createdOn:n||new Date().toISOString()}),a.apicurioActiveVersionIndex=a.apicurioVersions.length-1,a.data=e.data,a.title=X(e)||a.title,a.isSeries=!0,i}function De(){const e=k>=0&&x[k]?x[k]:null,t=de(e);document.title=t?`${t}-blockscape`:be}function et(e="shortcut"){const t=s.value||"";if(!t.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const n=X(x[k],"blockscape"),r=`${Xe(n)}.json`;return ft(r,t),console.log(`[Blockscape] saved JSON (${e}):`,r),!0}const gt={A:"#ef4444",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#f43f5e",P:"#e11d48",Q:"#dc2626",R:"#f59e0b",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"};function bt(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return gt[n]||"#9ca3af"}function vt(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(m=>m+m).join(""):t,r=parseInt(n,16),i=r>>16&255,a=r>>8&255,l=r&255;return .2126*Math.pow(i/255,2.2)+.7152*Math.pow(a/255,2.2)+.0722*Math.pow(l/255,2.2)>.35?"#111111":"#ffffff"}function yt(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}let Je=!1;function tt(){Je||(Je=!0,requestAnimationFrame(()=>{Je=!1,ue(),ee()}))}let Ue=!1;function W(e){if(fe(),Ee=null,e<0||e>=x.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}k=e,console.log("[Blockscape] active model:",X(x[e]),"(index",e+" )"),De(),xe(),ke(),Be(),B.updateAvailability()}function xe(){if(R.innerHTML="",!x.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",R.appendChild(e);return}x.forEach((e,t)=>{var U;const n=document.createElement("li");n.className="model-nav-item";const r=document.createElement("button");r.type="button",r.className="model-nav-button"+(t===k?" is-active":""),r.dataset.index=String(t),r.setAttribute("aria-current",t===k?"true":"false");const i=document.createElement("span");i.className="model-nav-label";const a=document.createElement("span");a.className="model-nav-title",a.textContent=ht(e),i.appendChild(a);const l=de(e);if(l){const J=document.createElement("span");J.className="model-nav-id",J.textContent=l,i.appendChild(J)}const h=Array.isArray((U=e.data)==null?void 0:U.categories)?e.data.categories:[],m=h.reduce((J,Oe)=>J+(Oe.items||[]).length,0),E=document.createElement("span");E.className="model-nav-meta";const M=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} versions`:"";E.textContent=`${h.length} cat · ${m} items${M}`,r.appendChild(i),r.appendChild(E),n.appendChild(r),R.appendChild(n)}),B.updateAvailability()}function ke(){if(k<0){s.value="";return}s.value=JSON.stringify(x[k].data,null,2)}function nt(e){try{return JSON.parse(e)}catch{return null}}function Ae(e,t="Pasted"){const n=(e||"").trim();if(!n)return[];const r=nt(n);return r?(Array.isArray(r)?r:[r]).map((l,h)=>(ce(l,{titleHint:`${t} #${h+1}`}),{id:ne(),title:l.title||`${t} #${h+1}`,data:l})):n.split(/^\s*(?:---|%%%)\s*$/m).map(a=>a.trim()).filter(Boolean).map((a,l)=>{const h=JSON.parse(a);return ce(h,{titleHint:`${t} #${l+1}`}),{id:ne(),title:h.title||`${t} #${l+1}`,data:h}})}function wt(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function Ie(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!wt(e)}function Et(e){if(!e)return!1;const t=e.trimStart();return/^\s*(\{|\[|---|%%%)/.test(t)}function rt(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(Z)}catch(i){return console.warn("[Blockscape] failed to access editor payload",i),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(i){console.warn("[Blockscape] invalid payload JSON",i);try{localStorage.removeItem(Z)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(Z)}catch(i){console.warn("[Blockscape] failed to clear editor payload",i)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=Ae(t.text,t.title||"Editor Export")}catch(i){return console.warn("[Blockscape] could not parse payload text",i),null}if(!n.length)return null;let r=null;return n.forEach(i=>{const a=ye(i,{versionLabel:"editor"});r==null&&(r=a)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:r,count:n.length}}function o(e="storage"){const t=rt();return!t||typeof t.index!="number"?!1:(W(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function c(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const a=new URLSearchParams(window.location.search);a.has("share")&&(t=a.get("share"))}if(!t)return null;let r;try{const a=ut(t);r=JSON.parse(a)}catch(a){return console.warn("[Blockscape] failed to decode share token",a),null}return!r||typeof r!="object"||typeof r.data!="object"?(console.warn("[Blockscape] share payload missing data"),null):(ce(r.data,{titleHint:r.title||"Shared Model"}),ye({id:ne(),title:r.data.title||r.title||"Shared Model",data:r.data},{versionLabel:"shared"}))}async function u(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const r=new URLSearchParams(window.location.search);r.has("load")&&(t=r.get("load"))}if(!t)return null;try{const r=await kt(t);return typeof r=="number"?r:null}catch(r){return console.warn("[Blockscape] load param failed",r),null}}function p(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,r=new Set;(e.categories||[]).forEach(a=>(a.items||[]).forEach(l=>{r.add(l.id);const h=new Set(l.deps||[]);(e.links||[]).forEach(m=>{m.from===l.id&&h.add(m.to)}),t.set(l.id,h),h.forEach(m=>{n.has(m)||n.set(m,new Set),n.get(m).add(l.id)})}));const i=new Set;return n.forEach((a,l)=>{((a==null?void 0:a.size)||0)>=2&&i.add(l)}),{m:e,fwd:t,rev:n,reusedLocal:i,seen:r}}function d(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),r=44;n.width=r,n.height=r;const i=n.getContext("2d"),a=(e||"?").charAt(0).toUpperCase(),l=bt(e,t),h=vt(l);return i.fillStyle=l,i.beginPath(),i.arc(r/2,r/2,r/2-2,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(0,0,0,0.15)",i.lineWidth=1,i.stroke(),i.fillStyle=h,i.font=`bold ${r*.5}px system-ui, -apple-system, sans-serif`,i.textAlign="center",i.textBaseline="middle",i.fillText(a,r/2,r/2),n.toDataURL("image/png")}function b(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function I(e){const t=b(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function y(e,t){var l;if(e<0||e>=x.length)return!1;const n=x[e];if(!((l=n==null?void 0:n.apicurioVersions)!=null&&l.length))return!1;const r=n.apicurioVersions.length,i=(t%r+r)%r,a=n.apicurioVersions[i];return a!=null&&a.data?(n.apicurioActiveVersionIndex=i,n.data=a.data,C=null,ke(),Be(),!0):!1}function $(e){var r;if(!e||k<0)return;const t=x[k];if(!((r=t==null?void 0:t.apicurioVersions)!=null&&r.length))return;const n=b(t);n!==-1&&y(k,n+e)}function w(e){if(!(e!=null&&e.apicurioVersions)||e.apicurioVersions.length<=1)return null;const t=document.createElement("div");t.className="version-nav";const n=document.createElement("div");n.className="version-nav__title",n.textContent=e.apicurioArtifactName||e.apicurioArtifactId||de(e)||"Artifact",t.appendChild(n);const r=document.createElement("div");r.className="version-nav__status";const i=b(e),a=I(e)||"latest";r.textContent=`No. in series ${a} (${i+1} of ${e.apicurioVersions.length})`,t.appendChild(r);const l=document.createElement("div");l.className="version-nav__controls";const h=document.createElement("button");h.type="button",h.className="version-nav__button",h.textContent="Previous",h.addEventListener("click",()=>$(-1));const m=document.createElement("button");return m.type="button",m.className="version-nav__button",m.textContent="Next",m.addEventListener("click",()=>$(1)),l.appendChild(h),l.appendChild(m),t.appendChild(l),t}function A(){if(!P)return;le(),Array.isArray(P.m.categories)||(P.m.categories=[]),console.log("[Blockscape] rendering categories=",P.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!P.m.abstract,"- value:",P.m.abstract?P.m.abstract.substring(0,50)+"...":"none"),g.innerHTML="",z.clear();const e=w(x[k]);e&&g.appendChild(e),N.setAttribute("width",window.innerWidth),N.setAttribute("height",window.innerHeight);const t=document.createElement("div");t.className="blockscape-model-meta";const n=document.createElement("div");n.className="blockscape-model-title",n.textContent=P.m.title&&P.m.title.trim()||X(x[k]),t.appendChild(n);const r=I(x[k]),i=(P.m.id??"").toString().trim();if(i){const v=document.createElement("div");v.className="blockscape-model-id",v.textContent=`ID: ${i}`,t.appendChild(v)}if(r){const v=document.createElement("div");v.className="blockscape-model-id",v.textContent=`No. in series: ${r}`,t.appendChild(v)}g.appendChild(t);const a=document.createElement("div");a.className="blockscape-tabs";const l=document.createElement("div");l.className="blockscape-tablist",l.setAttribute("role","tablist"),a.appendChild(l);const h=document.createElement("div");h.className="blockscape-tabpanels",a.appendChild(h);const m=document.createElement("div"),E=document.createElement("div"),M=document.createElement("div"),U=document.createElement("div");let J="";const Oe=[{id:"map",label:"Map",panel:m},{id:"abstract",label:"Info",panel:E},{id:"source",label:"Source",panel:M},{id:"apicurio",label:"Apicurio",panel:U}],gn=v=>{if(!N)return;const F=v==="map";N.hidden=!F,F?(ue(),ee()):N.innerHTML=""};Oe.forEach((v,F)=>{const G=document.createElement("button");G.type="button",G.id=`tab-${v.id}`,G.className="blockscape-tab"+(F===0?" is-active":""),G.setAttribute("role","tab"),G.setAttribute("aria-controls",`panel-${v.id}`),G.setAttribute("aria-selected",F===0?"true":"false"),G.textContent=v.label,v.button=G,l.appendChild(G),v.panel.id=`panel-${v.id}`,v.panel.classList.add("blockscape-tabpanel"),v.panel.setAttribute("role","tabpanel"),v.panel.setAttribute("aria-labelledby",G.id),v.panel.hidden=F!==0,F===0&&v.panel.classList.add("is-active"),h.appendChild(v.panel)});const Vt=v=>{Oe.forEach(F=>{const G=F.id===v;F.button.classList.toggle("is-active",G),F.button.setAttribute("aria-selected",G?"true":"false"),F.panel.classList.toggle("is-active",G),F.panel.hidden=!G}),gn(v)};Oe.forEach(v=>{v.button.addEventListener("click",()=>{le(),Vt(v.id)}),v.id==="abstract"&&(v.button.addEventListener("mouseenter",()=>Ne(v.button,J,{offset:12})),v.button.addEventListener("mouseleave",le),v.button.addEventListener("focus",()=>Ne(v.button,J,{offset:12})),v.button.addEventListener("blur",le))}),Vt(Oe[0].id),g.appendChild(a);const At=document.createElement("div");At.className="blockscape-render",m.appendChild(At);const ot=document.createElement("div");if(ot.className="blockscape-abstract-panel",P.m.abstract){console.log("[Blockscape] Rendering abstract content");const v=document.createElement("div");v.className="blockscape-abstract",v.innerHTML=P.m.abstract,fn(v),ot.appendChild(v),J=v.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const v=document.createElement("div");v.className="blockscape-abstract-placeholder",v.textContent="No abstract has been provided for this model.",ot.appendChild(v),J=v.outerHTML}E.appendChild(ot);const it=document.createElement("div");if(it.className="blockscape-source-panel",f)f.hidden=!1,f.classList.remove("pf-v5-c-page__main-section"),it.appendChild(f);else{const v=document.createElement("p");v.className="muted",v.textContent="Source editor unavailable.",it.appendChild(v)}M.appendChild(it),B.mount(U),P.m.categories.forEach(v=>{const F=document.createElement("section");F.className="category",F.dataset.cat=v.id;const G=document.createElement("div");G.className="cat-head",G.innerHTML=`<div class="cat-title">${Fe(v.title||v.id)}</div>
                          <div class="muted cat-count">${(v.items||[]).length} items</div>`,F.appendChild(G);const Lt=document.createElement("div");Lt.className="grid",F.appendChild(Lt),(v.items||[]).forEach(oe=>{const Ge=xt(oe.external),pe=document.createElement("div");pe.className=Ge.isExternal?"tile external":"tile",pe.tabIndex=0,pe.dataset.id=oe.id,Ge.url&&(pe.dataset.externalUrl=Ge.url);const Te=document.createElement("img");Te.className="logo",oe.logo?(Te.src=oe.logo,Te.alt=oe.name||oe.id):(Te.alt="",Te.style.opacity=1,Te.src=d(oe.name||oe.id,oe.color));const St=document.createElement("div");St.className="name",St.textContent=oe.name||oe.id;const Ct=document.createElement("div");Ct.className="badge",Ct.textContent="reused",Ge.url&&pe.appendChild(we(Ge.url)),pe.appendChild(Te),pe.appendChild(St),pe.appendChild(Ct),Lt.appendChild(pe),z.set(oe.id,{el:pe,catId:v.id,rect:null})}),At.appendChild(F)}),P.reusedLocal.forEach(v=>{const F=z.get(v);F&&(F.el.classList.add("reused"),F.el.querySelector(".badge").style.display="inline-block")}),re(),ue(),ee()}function re(){g.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",t=>{if(typeof t.button=="number"&&t.button!==0)return;fe();const n=e.dataset.id;if(console.log("[Blockscape] click",n),C===n){$e();return}K(n)}),e.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),e.click())}),e.draggable=!0,e.addEventListener("dragstart",Yt),e.addEventListener("dragend",Xt)}),g.querySelectorAll(".grid").forEach(e=>{e.addEventListener("dragover",Qt),e.addEventListener("drop",tn),e.addEventListener("dragenter",Zt),e.addEventListener("dragleave",en)}),Ue||(Ue=!0,window.addEventListener("resize",tt),window.addEventListener("scroll",tt,{passive:!0})),document.getElementById("clear").onclick=()=>$e()}function ue(){z.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function K(e){C=e,Le();const t=Array.from(P.fwd.get(e)||[]),n=Array.from(P.rev.get(e)||[]);console.log("[Blockscape] selecting id=",e,"deps=",t,"revs=",n);const r=z.get(e);r&&r.el.classList.add("selected"),t.forEach(i=>{const a=z.get(i);a&&a.el.classList.add("dep")}),n.forEach(i=>{const a=z.get(i);a&&a.el.classList.add("revdep")}),ee()}function $e(){C=null,Le(),ee()}function Le(){g.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","selected"))}function ee(){var n;for(;N.firstChild;)N.removeChild(N.firstChild);if(!C||N.hidden)return;const e=(n=z.get(C))==null?void 0:n.rect;if(!e)return;new Set([...P.fwd.get(C)||[],...P.rev.get(C)||[]]).forEach(r=>{const i=z.get(r);if(!i||!i.rect)return;const a=He(e),l=He(i.rect),h=document.createElementNS("http://www.w3.org/2000/svg","path"),m=(a.x+l.x)/2,E=a.y,M=(a.x+l.x)/2,U=l.y,J=(P.fwd.get(C)||new Set).has(r);h.setAttribute("d",`M ${a.x},${a.y} C ${m},${E} ${M},${U} ${l.x},${l.y}`),h.setAttribute("fill","none"),h.setAttribute("stroke",J?"var(--blockscape-dep)":"var(--blockscape-revdep)"),h.setAttribute("stroke-opacity","0.45"),h.setAttribute("stroke-width","2"),h.setAttribute("vector-effect","non-scaling-stroke"),N.appendChild(h)})}function He(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Fe(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function xt(e){if(typeof e=="string"){const t=e.trim();if(!t)return{isExternal:!1,url:""};try{const n=new URL(t);return/^https?:/i.test(n.protocol)?{isExternal:!0,url:n.toString()}:{isExternal:!1,url:""}}catch(n){return console.warn("[Blockscape] invalid external url skipped",e,n),{isExternal:!1,url:""}}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function we(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Ne(e,t,{offset:n=8}={}){!L||!e||!t||(L.innerHTML=t,L.hidden=!1,L.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const r=e.getBoundingClientRect(),i=L.getBoundingClientRect(),a=window.scrollX||document.documentElement.scrollLeft,l=window.scrollY||document.documentElement.scrollTop;let h=r.left+r.width/2-i.width/2+a,m=r.top-i.height-n+l;h<a+n&&(h=a+n);const E=a+window.innerWidth-i.width-n;h>E&&(h=E),m<l+n&&(m=r.bottom+n+l),L.style.left=`${h}px`,L.style.top=`${m}px`,L.classList.add("is-visible")}))}function le(){L&&(L.classList.remove("is-visible"),L.setAttribute("aria-hidden","true"),L.hidden=!0)}window.addEventListener("scroll",le,!0),window.addEventListener("resize",le);function fe(){S&&(S.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),S.setAttribute("aria-hidden","true"),S.hidden=!0,Mt(""))}function Kt(e,t){S&&(Y={x:e,y:t},S.hidden=!1,S.setAttribute("aria-hidden","false"),S.classList.add("is-visible"),Me(e,t))}function Me(e,t){if(!S)return;const n=12;S.style.left=`${e+n}px`,S.style.top=`${t+n}px`;const r=S.getBoundingClientRect();let i=r.left,a=r.top;r.right>window.innerWidth-n&&(i=Math.max(n,window.innerWidth-r.width-n)),r.bottom>window.innerHeight-n&&(a=Math.max(n,window.innerHeight-r.height-n)),S.style.left=`${i}px`,S.style.top=`${a}px`}function Mt(e){if(D)if(D.innerHTML="",e){const t=document.createElement("button");t.type="button",t.className="item-preview__action",t.innerHTML='Open external link <span aria-hidden="true">↗</span>',t.title=e,t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),D.appendChild(t),D.hidden=!1}else D.hidden=!0}async function Wt(e,t){var m;if(!S)return;e.stopPropagation(),e.preventDefault();const n=t.dataset.id,r=((m=t.querySelector(".name"))==null?void 0:m.textContent)||n||"Preview",i=n?`${n}.html`:"",a=i?`items/${i}`:"",l=++ve,h=t.dataset.externalUrl||"";if(Mt(h),q.textContent=r,V.innerHTML='<div class="item-preview__status">Loading…</div>',S.classList.remove("item-preview--has-frame"),S.classList.add("item-preview--expanded"),Kt(e.clientX,e.clientY),!a){V.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',Me(Y.x,Y.y);return}try{const E=await fetch(a,{cache:"no-cache"});if(!E.ok)throw new Error(`HTTP ${E.status}`);const M=await E.text();if(l!==ve)return;if(!M.trim()){V.innerHTML=`<div class="item-preview__status">No content in <code>${Fe(i)}</code>.</div>`,Me(Y.x,Y.y);return}const J=document.createElement("iframe");J.className="item-preview__frame",J.title=`${r} details`,J.srcdoc=M,V.innerHTML="",V.appendChild(J),S.classList.add("item-preview--has-frame"),Me(Y.x,Y.y)}catch(E){if(l!==ve)return;V.innerHTML=`<div class="item-preview__status">No preview available for <strong>${Fe(r)}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${a}`,E),Me(Y.x,Y.y)}}j&&j.addEventListener("click",fe),g&&g.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");!t||!g.contains(t)||Wt(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||!S||S.hidden||S.contains(e.target)||fe()}),H&&H.addEventListener("click",()=>{et("button")}),he&&he.addEventListener("click",async()=>{var a;if(k<0||!x[k]){alert("Select or load a model before sharing.");return}const e={title:X(x[k],"Shared Model"),data:x[k].data};let t;try{t=dt(JSON.stringify(e))}catch(l){console.error("[Blockscape] share encode failed",l),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const r=n.toString();try{window.history.replaceState({},document.title,r)}catch(l){console.warn("[Blockscape] failed to update URL for share",l),window.location.hash=n.hash}let i=!1;if((a=navigator.clipboard)!=null&&a.writeText)try{await navigator.clipboard.writeText(r),i=!0}catch(l){console.warn("[Blockscape] clipboard write failed",l)}i?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",r)}),Q&&Q.addEventListener("click",()=>{const e=(s.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};C&&(n.selectedItemId=C),localStorage.setItem(Z,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";C&&(t=`editor.html?selected=${encodeURIComponent(C)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==Z||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||o("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===ge&&o("message")})),document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault(),et("shortcut");return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!Ie())return;if(sn()){e.preventDefault();return}}if(e.key==="Escape"&&S&&!S.hidden&&fe(),e.key==="ArrowLeft"||e.key==="ArrowRight"){if(!Ie()||e.altKey||e.ctrlKey||e.metaKey)return;const t=e.key==="ArrowLeft"?-1:1;e.shiftKey?nn(t)&&e.preventDefault():rn(t)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(!Ie()||e.altKey||e.ctrlKey||e.metaKey)return;const t=e.key==="ArrowUp"?-1:1;e.shiftKey?an(t)&&e.preventDefault():on(t)&&e.preventDefault()}if(e.key==="Delete"){if(!Ie()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;cn()&&e.preventDefault()}}),window.addEventListener("resize",()=>{!S||S.hidden||Me(Y.x,Y.y)}),window.addEventListener("scroll",()=>{!S||S.hidden||fe()},!0);let Se=null,qe=null;function Yt(e){fe(),Se=e.target.dataset.id,qe=e.target.closest(".category").dataset.cat,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({itemId:Se,categoryId:qe})),e.target.closest(".category").querySelector(".grid").classList.add("drag-active"),console.log("[Blockscape] drag start",Se,"from",qe)}function Xt(e){e.target.classList.remove("dragging"),g.querySelectorAll(".grid").forEach(t=>t.classList.remove("drag-active")),g.querySelectorAll(".tile").forEach(t=>t.classList.remove("drag-over")),Se=null,qe=null}function Qt(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function Zt(e){e.preventDefault();const t=e.target.closest(".grid");t&&t.classList.add("drag-active")}function en(e){const t=e.target.closest(".grid");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-active")}function tn(e){e.preventDefault();const t=e.target.closest(".grid");if(!t)return;const n=t.closest(".category");if(!n)return;const r=n.dataset.cat;if(!Se||!r)return;const a=Array.from(t.querySelectorAll(".tile")).filter(l=>l.dataset.id!==Se).find(l=>{const h=l.getBoundingClientRect();return e.clientY<h.top+h.height/2});Ot(Se,a?a.dataset.id:null,r),A(),console.log("[Blockscape] drop completed",Se,"from",qe,"to",r)}function Ot(e,t,n){if(k<0)return;const i=x[k].data.categories||[],a=i.find(M=>(M.items||[]).some(U=>U.id===e)),l=i.find(M=>M.id===n);if(!a||!l)return;a.items=a.items||[],l.items=l.items||[];const h=a.items.findIndex(M=>M.id===e);if(h===-1)return;const[m]=a.items.splice(h,1);let E=l.items.length;if(t){const M=l.items.findIndex(U=>U.id===t);M!==-1&&(E=M)}l.items.splice(E,0,m),ke(),Be()}function nn(e){if(!C||k<0||!e)return!1;const n=x[k].data.categories||[],r=z.get(C);let i=null;if(r!=null&&r.catId&&(i=n.find(m=>m.id===r.catId)),i||(i=n.find(m=>(m.items||[]).some(E=>E.id===C))),!i)return!1;i.items=i.items||[];const a=i.items.findIndex(m=>m.id===C);if(a===-1)return!1;const l=a+e;if(l<0||l>=i.items.length)return!1;const[h]=i.items.splice(a,1);return i.items.splice(l,0,h),ke(),Be(),A(),K(C),!0}function rn(e){if(!P||!P.m||!e)return!1;const t=P.m.categories||[];if(!t.length)return!1;const n=()=>{const m=t.find(E=>(E.items||[]).length);return m?{category:m,item:m.items[0]}:null};if(!C){const m=n();return m?(K(m.item.id),!0):!1}const r=z.get(C);let i=null;if(r!=null&&r.catId&&(i=t.find(m=>m.id===r.catId)),i||(i=t.find(m=>(m.items||[]).some(E=>E.id===C))),!i){const m=n();return m?(K(m.item.id),!0):!1}const a=i.items||[];if(!a.length)return!1;const l=a.findIndex(m=>m.id===C);if(l===-1)return!1;const h=l+e;return h<0||h>=a.length?!1:(K(a[h].id),!0)}function on(e){if(!P||!P.m||!e)return!1;const t=P.m.categories||[];if(!t.length)return!1;const n=()=>{for(const m of t)if(m.items&&m.items.length)return m.items[0].id;return null};let i=(()=>{if(!C)return-1;const m=z.get(C);if(m!=null&&m.catId){const E=t.findIndex(M=>M.id===m.catId);if(E!==-1)return E}return t.findIndex(E=>(E.items||[]).some(M=>M.id===C))})();if(i===-1){const m=n();return m?(K(m),!0):!1}let l=(t[i].items||[]).findIndex(m=>m.id===C);l===-1&&(l=0);let h=i+e;for(;h>=0&&h<t.length;){const E=t[h].items||[];if(E.length){const M=Math.min(E.length-1,Math.max(0,l));return K(E[M].id),!0}h+=e>0?1:-1}return!1}function an(e){if(!C||k<0||!e)return!1;const n=x[k].data.categories||[];if(!n.length)return!1;const r=z.get(C);let i=-1;if(r!=null&&r.catId&&(i=n.findIndex(U=>U.id===r.catId)),i===-1&&(i=n.findIndex(U=>(U.items||[]).some(J=>J.id===C))),i===-1)return!1;const a=i+e;if(a<0||a>=n.length)return!1;const l=n[i],h=n[a];if(!h)return!1;l.items=l.items||[],h.items=h.items||[];const m=l.items.findIndex(U=>U.id===C);if(m===-1)return!1;const E=Math.min(h.items.length,Math.max(0,m)),M=E<h.items.length?h.items[E].id:null;return Ot(C,M,h.id),A(),K(C),!0}function sn(){if(!Ee||k<0)return!1;const e=x[k];if(!e||e.id!==Ee.modelId)return!1;const t=Ee,i=(e.data.categories||[]).find(l=>l.id===t.categoryId);if(!i)return!1;i.items=i.items||[];const a=Math.min(Math.max(t.index,0),i.items.length);return i.items.splice(a,0,t.item),Ee=null,fe(),C=null,ke(),Be(),A(),K(t.item.id),console.log("[Blockscape] undo delete restored",t.item.id),!0}function cn(){if(!C||k<0)return!1;const t=x[k].data.categories||[];if(!t.length)return!1;const n=z.get(C);let r=null;if(n!=null&&n.catId&&(r=t.find(E=>E.id===n.catId)),r||(r=t.find(E=>(E.items||[]).some(M=>M.id===C))),!r||!Array.isArray(r.items))return!1;const i=r.items.findIndex(E=>E.id===C);if(i===-1)return!1;const a=r.items.splice(i,1)[0];if(!a)return!1;const l=x[k];Ee={item:a,categoryId:r.id,index:i,modelId:l?l.id:null};const m=(()=>{var M;if(r.items.length){const U=Math.min(i,r.items.length-1);return((M=r.items[U])==null?void 0:M.id)||null}const E=t.findIndex(U=>U.id===r.id);if(E===-1)return null;for(let U=E+1;U<t.length;U++){const J=t[U].items||[];if(J.length)return J[0].id}for(let U=E-1;U>=0;U--){const J=t[U].items||[];if(J.length)return J[0].id}return null})();return fe(),C=null,ke(),Be(),A(),m?K(m):$e(),console.log("[Blockscape] removed item",a.id),!0}_&&_.addEventListener("click",async()=>{const e=s.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await pt(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),se&&se.addEventListener("click",async()=>{try{const e=await mt();if(!e){alert("Clipboard is empty.");return}s.value=e,s.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=()=>{try{const e=Ae(s.value,"Pasted");if(!e.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",e.length,"model(s)");let t=null;e.forEach((n,r)=>{const i=ye(n,{versionLabel:e.length>1?`paste #${r+1}`:"paste"});t==null&&(t=i)}),k===-1&&t!=null?W(t):xe()}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{if(k<0){alert("No active model selected.");return}try{const e=JSON.parse(s.value);ce(e,{titleHint:X(x[k]),idHint:de(x[k])||X(x[k])}),x[k].data=e,x[k].title=e.title||x[k].title,De(),console.log("[Blockscape] replaced active model:",X(x[k])),Be(),B.updateAvailability()}catch(e){console.error("[Blockscape] replace error:",e),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const r of t){const i=await r.text(),a=Ae(i,r.name.replace(/\.[^.]+$/,"")||"File");if(!a.length){console.warn("[Blockscape] no models in file:",r.name);continue}a.forEach((l,h)=>{var U;const m=(((U=l.data)==null?void 0:U.title)??"").toString().trim(),E=a.length>1?`${r.name} #${h+1}`:r.name,M=ye({...l,title:m||E},{versionLabel:r.name});n==null&&(n=M)})}k===-1&&n!=null?W(n):xe()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",ln);function ln(e){var i;if(!Ie())return;const t=((i=e.clipboardData)==null?void 0:i.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Et(t))return;let n=[];try{n=Ae(t,"Clipboard")}catch(a){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",a);return}if(!n.length)return;e.preventDefault();let r=null;n.forEach((a,l)=>{const h=ye(a,{versionLabel:n.length>1?`paste #${l+1}`:"paste"});r==null&&(r=h)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),r!=null&&W(r)}R.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&(yt(),W(n))}),document.getElementById("removeModel").onclick=()=>{if(k<0)return;if(console.log("[Blockscape] removing model:",X(x[k])),x.splice(k,1),!x.length){k=-1,P=null,g.innerHTML="",N.innerHTML="",s.value="",xe(),De();return}const e=Math.min(k,x.length-1);W(e)},document.getElementById("search").addEventListener("input",e=>{const t=e.target.value.trim().toLowerCase();console.log("[Blockscape] search:",t),g.querySelectorAll(".tile").forEach(n=>{const r=n.querySelector(".name").textContent.toLowerCase();n.style.opacity=!t||r.includes(t)?1:.2})}),te&&O&&T&&te.addEventListener("submit",async e=>{e.preventDefault();const t=O.value.trim();if(!t){alert("Please enter a URL"),O.focus();return}const n=await kt(t);if(typeof n=="number"){W(n),O.value="";const r=document.getElementById("urlHint");r&&(r.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!O||!t)return;let n=null;O.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const i=O.value.slice(-12);t.textContent=i?`…${i}`:""},300)})}();function Be(){if(!(k<0))try{P=p(x[k].data),A()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function dn(){const e=["NFR.bs","planets.bs","letters.bs"],t=n=>at?at.endsWith("/")?`${at}${n}`:`${at}/${n}`:n;for(const n of e)try{const r=await fetch(t(n),{cache:"no-store"});if(!r.ok){console.warn(`[Blockscape] ${n} not fetched (${r.status}); skipping`);continue}const i=await r.text(),a=n.replace(/\.[^.]+$/,"")||"Model",l=Ae(i,a);if(!l.length){console.warn("[Blockscape] no models found in",n);continue}l.forEach(h=>{ye(h,{versionLabel:n})}),console.log(`[Blockscape] loaded ${l.length} model(s) from ${n}`)}catch(r){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",r)}xe()}async function un(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const r of t)try{console.log(`[Blockscape] fetching ${e} with cache="${r.cache??"default"}"`);const i=await fetch(e,r);if(i.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);return await i.text()}catch(i){n=i}throw n||new Error("Unable to fetch URL")}function fn(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(r=>pn(r)),e.querySelectorAll("a[href]").forEach(r=>{const i=r.getAttribute("href");Rt(i)&&Pt(r,i)})}function pn(e){if(!e||!e.nodeValue||!e.nodeValue.includes("http"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,r=[];let i;for(;(i=n.exec(t))!==null;)Rt(i[0])&&r.push({url:i[0],index:i.index});if(!r.length)return;const a=document.createDocumentFragment();let l=0;r.forEach(({url:h,index:m})=>{m>l&&a.appendChild(document.createTextNode(t.slice(l,m))),a.appendChild(mn(h)),l=m+h.length}),l<t.length&&a.appendChild(document.createTextNode(t.slice(l))),e.parentNode.replaceChild(a,e)}function mn(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Pt(t,e),t}function Pt(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>hn(n,t,e)))}async function hn(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await kt(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Rt(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function kt(e){try{console.log("[Blockscape] loading from URL:",e);const t=await un(e),r=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let i;try{i=Ae(t,r)}catch(l){throw new Error(`Invalid JSON payload: ${l.message}`)}if(!i.length)throw new Error("No JSON objects found in response.");let a=null;return i.forEach((l,h)=>{var U;const m=(((U=l.data)==null?void 0:U.title)??"").toString().trim(),E=i.length>1?`${r} #${h+1}`:r,M=ye({...l,title:m||E},{versionLabel:r});a==null&&(a=M)}),console.log(`[Blockscape] loaded ${i.length} model(s) from URL:`,r),k===-1&&a!=null?W(a):xe(),a}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const r=JSON.parse(n);ce(r,{titleHint:r.title||"Blockscape",idHint:r.id||"blockscape"}),x.push({id:ne(),title:r.title||"Blockscape",data:r}),await dn();const i=await u(),a=rt(),l=a==null?void 0:a.index,h=c();W(typeof i=="number"?i:typeof h=="number"?h:typeof l=="number"?l:0)})()}function Dn(s){let f,g,N,L,R,S=`<script id="seed" type="application/json">${s[0]}<\/script>`,te,O,T,q,V,D;return{c(){f=Ke("link"),g=ze(),N=Ke("div"),N.innerHTML=`<header class="pf-v5-c-page__header"><div class="pf-v5-c-masthead pf-m-display-inline blockscape-masthead"><div class="pf-v5-c-masthead__content"><div class="blockscape-toolbar"><div class="blockscape-brand"><h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/> <a href="https://github.com/pwright/blockscape" target="_blank" class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></div> <div class="blockscape-toolbar__controls"><label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <form id="urlForm" class="blockscape-url-form" autocomplete="on" novalidate=""><label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-secondary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div></form> <label class="pf-v5-c-button pf-m-secondary blockscape-file"><span>Load File(s)</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/></label> <button id="openInEditor" class="pf-v5-c-button pf-m-primary" type="button" title="Open current JSON in the editor">Edit</button> <button id="shareModel" class="pf-v5-c-button pf-m-primary" type="button" title="Copy a shareable URL for this model">Share</button></div> <div class="blockscape-legend" role="presentation"><span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span> <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span> <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span> <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span></div></div></div></div></header> <main class="pf-v5-c-page__main"><div class="blockscape-content"><aside class="blockscape-sidebar" aria-label="Models"><div class="sidebar-heading">Models</div> <ul id="modelList" class="model-nav-list"></ul> <div class="model-actions"><button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button></div></aside> <div class="blockscape-main"><section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,logo?,external?:url,color?,deps:[]}}], links?:[{from,to}] }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code> to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section></div></div></main>`,L=ze(),R=new An(!1),te=ze(),O=Gt("svg"),T=ze(),q=Ke("div"),V=ze(),D=Ke("div"),D.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',document.title="Blockscape — simple landscape-style tiles",ie(f,"rel","icon"),ie(f,"type","image/svg+xml"),ie(f,"href","./favicon.svg"),ie(N,"class","pf-v5-c-page"),R.a=te,ie(O,"id","overlay"),ie(O,"class","svg-layer"),ie(q,"id","tabTooltip"),ie(q,"class","blockscape-tab-tooltip"),q.hidden=!0,ie(q,"aria-hidden","true"),ie(D,"id","itemPreview"),ie(D,"class","item-preview"),D.hidden=!0,ie(D,"aria-hidden","true")},m(j,H){En(document.head,f),me(j,g,H),me(j,N,H),me(j,L,H),R.m(S,j,H),me(j,te,H),me(j,O,H),me(j,T,H),me(j,q,H),me(j,V,H),me(j,D,H)},p:Ve,i:Ve,o:Ve,d(j){j&&(ae(g),ae(N),ae(L),R.d(),ae(te),ae(O),ae(T),ae(q),ae(V),ae(D)),ae(f)}}}function Jn(s){const f=`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;return Sn(()=>{jn()}),[f]}class Hn extends Pn{constructor(f){super(),On(this,f,Jn,Dn,yn,{})}}const Fn=document.getElementById("root");new Hn({target:Fn});
