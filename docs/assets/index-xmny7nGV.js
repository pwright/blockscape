var wr=Object.defineProperty;var Er=(d,u,p)=>u in d?wr(d,u,{enumerable:!0,configurable:!0,writable:!0,value:p}):d[u]=p;var te=(d,u,p)=>Er(d,typeof u!="symbol"?u+"":u,p);(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const v of document.querySelectorAll('link[rel="modulepreload"]'))w(v);new MutationObserver(v=>{for(const I of v)if(I.type==="childList")for(const y of I.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&w(y)}).observe(document,{childList:!0,subtree:!0});function p(v){const I={};return v.integrity&&(I.integrity=v.integrity),v.referrerPolicy&&(I.referrerPolicy=v.referrerPolicy),v.crossOrigin==="use-credentials"?I.credentials="include":v.crossOrigin==="anonymous"?I.credentials="omit":I.credentials="same-origin",I}function w(v){if(v.ep)return;v.ep=!0;const I=p(v);fetch(v.href,I)}})();function Ie(){}function Gt(d){return d()}function Ht(){return Object.create(null)}function ze(d){d.forEach(Gt)}function zt(d){return typeof d=="function"}function xr(d,u){return d!=d?u==u:d!==u||d&&typeof d=="object"||typeof d=="function"}function kr(d){return Object.keys(d).length===0}function Ar(d,u){d.appendChild(u)}function K(d,u,p){d.insertBefore(u,p||null)}function j(d){d.parentNode&&d.parentNode.removeChild(d)}function je(d){return document.createElement(d)}function Kt(d){return document.createElementNS("http://www.w3.org/2000/svg",d)}function Lr(d){return document.createTextNode(d)}function Ve(){return Lr(" ")}function V(d,u,p){p==null?d.removeAttribute(u):d.getAttribute(u)!==p&&d.setAttribute(u,p)}function Sr(d){return Array.from(d.childNodes)}class Cr{constructor(u=!1){te(this,"is_svg",!1);te(this,"e");te(this,"n");te(this,"t");te(this,"a");this.is_svg=u,this.e=this.n=null}c(u){this.h(u)}m(u,p,w=null){this.e||(this.is_svg?this.e=Kt(p.nodeName):this.e=je(p.nodeType===11?"TEMPLATE":p.nodeName),this.t=p.tagName!=="TEMPLATE"?p:p.content,this.c(u)),this.i(w)}h(u){this.e.innerHTML=u,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(u){for(let p=0;p<this.n.length;p+=1)K(this.t,this.n[p],u)}p(u){this.d(),this.h(u),this.i(this.a)}d(){this.n.forEach(j)}}let Je;function De(d){Je=d}function Ir(){if(!Je)throw new Error("Function called outside component initialization");return Je}function $r(d){Ir().$$.on_mount.push(d)}const Ce=[],Ft=[];let $e=[];const qt=[],Nr=Promise.resolve();let mt=!1;function Br(){mt||(mt=!0,Nr.then(Wt))}function ht(d){$e.push(d)}const pt=new Set;let Se=0;function Wt(){if(Se!==0)return;const d=Je;do{try{for(;Se<Ce.length;){const u=Ce[Se];Se++,De(u),Tr(u.$$)}}catch(u){throw Ce.length=0,Se=0,u}for(De(null),Ce.length=0,Se=0;Ft.length;)Ft.pop()();for(let u=0;u<$e.length;u+=1){const p=$e[u];pt.has(p)||(pt.add(p),p())}$e.length=0}while(Ce.length);for(;qt.length;)qt.pop()();mt=!1,pt.clear(),De(d)}function Tr(d){if(d.fragment!==null){d.update(),ze(d.before_update);const u=d.dirty;d.dirty=[-1],d.fragment&&d.fragment.p(d.ctx,u),d.after_update.forEach(ht)}}function _r(d){const u=[],p=[];$e.forEach(w=>d.indexOf(w)===-1?u.push(w):p.push(w)),p.forEach(w=>w()),$e=u}const Ur=new Set;function Mr(d,u){d&&d.i&&(Ur.delete(d),d.i(u))}function Or(d,u,p){const{fragment:w,after_update:v}=d.$$;w&&w.m(u,p),ht(()=>{const I=d.$$.on_mount.map(Gt).filter(zt);d.$$.on_destroy?d.$$.on_destroy.push(...I):ze(I),d.$$.on_mount=[]}),v.forEach(ht)}function Pr(d,u){const p=d.$$;p.fragment!==null&&(_r(p.after_update),ze(p.on_destroy),p.fragment&&p.fragment.d(u),p.on_destroy=p.fragment=null,p.ctx=[])}function Rr(d,u){d.$$.dirty[0]===-1&&(Ce.push(d),Br(),d.$$.dirty.fill(0)),d.$$.dirty[u/31|0]|=1<<u%31}function Vr(d,u,p,w,v,I,y=null,W=[-1]){const M=Je;De(d);const T=d.$$={fragment:null,ctx:[],props:I,update:Ie,not_equal:v,bound:Ht(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(u.context||(M?M.$$.context:[])),callbacks:Ht(),dirty:W,skip_bound:!1,root:u.target||M.$$.root};y&&y(T.root);let $=!1;if(T.ctx=p?p(d,u.props||{},(L,U,...B)=>{const _=B.length?B[0]:U;return T.ctx&&v(T.ctx[L],T.ctx[L]=_)&&(!T.skip_bound&&T.bound[L]&&T.bound[L](_),$&&Rr(d,L)),U}):[],T.update(),$=!0,ze(T.before_update),T.fragment=w?w(T.ctx):!1,u.target){if(u.hydrate){const L=Sr(u.target);T.fragment&&T.fragment.l(L),L.forEach(j)}else T.fragment&&T.fragment.c();u.intro&&Mr(d.$$.fragment),Or(d,u.target,u.anchor),Wt()}De(M)}class jr{constructor(){te(this,"$$");te(this,"$$set")}$destroy(){Pr(this,1),this.$destroy=Ie}$on(u,p){if(!zt(p))return Ie;const w=this.$$.callbacks[u]||(this.$$.callbacks[u]=[]);return w.push(p),()=>{const v=w.indexOf(p);v!==-1&&w.splice(v,1)}}$set(u){this.$$set&&!kr(u)&&(this.$$.skip_bound=!0,this.$$set(u),this.$$.skip_bound=!1)}}const Dr="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Dr);const Ge=typeof import.meta<"u"&&"/"||"";function Jr(){console.log("[Blockscape] init");const d=document.getElementById("jsonBox"),u=document.querySelector(".blockscape-json-panel"),p=document.getElementById("app"),w=document.getElementById("overlay"),v=document.getElementById("tabTooltip"),I=document.getElementById("modelList"),y=document.getElementById("itemPreview"),W=document.getElementById("urlForm"),M=document.getElementById("urlInput"),T=document.getElementById("loadUrl");let $=null,L=null,U=null,B=null,_=null,ne=null,re=null,pe=null,D=null;const Yt=y.querySelector(".item-preview__title"),me=y.querySelector(".item-preview__body"),Ne=y.querySelector(".item-preview__actions"),gt=y.querySelector(".item-preview__close"),bt=document.getElementById("downloadJson"),vt=document.getElementById("shareModel"),yt=document.getElementById("openInEditor"),wt=document.getElementById("copyJson"),Et=document.getElementById("pasteJson"),Be="blockscape:editorPayload",Xt="blockscape:editorTransfer",Qt=document.title,xt="blockscape:apicurioConfig",Ke="http://localhost:8080/apis/registry/v3",We="bs",Ye=!1,Xe=!1;d.value=document.getElementById("seed").textContent.trim();let g=[],h=-1,k={baseUrl:Ke,groupId:We,authToken:"",enabled:Ye,useSemver:Xe},C=null,O=new Map,E=null,Qe=0,J={x:0,y:0},he=null,Z=new Map,oe=new Map;cn();function ie(){return Math.random().toString(36).slice(2,10)}function Zt(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(r=>{n+=String.fromCharCode(r)}),btoa(n)}function en(e){const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return new TextDecoder().decode(n)}function tn(e){return Zt(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function nn(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),en(t)}function rn(e,t){const n=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=e,o.click(),URL.revokeObjectURL(r)}async function on(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function sn(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function kt(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function Ze(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(r=>Ze(r)).join(",")}]`:`{${Object.keys(e).sort().map(r=>`${JSON.stringify(r)}:${Ze(e[r])}`).join(",")}}`}function At(e){try{return Ze(e)}catch{return""}}function Lt(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=At(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=At(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}function se(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const r=(e.title??"").toString().trim();e.title=r||t||"Untitled Model";const o=(e.id??"").toString().trim();if(o)e.id=o;else{const i=n||e.title||t||"model",s=kt(i).replace(/\./g,"-");e.id=s||`model-${ie()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function H(e,t="Untitled Model"){var r;return e&&(((r=e.data)==null?void 0:r.title)??e.title??"").toString().trim()||t}function an(e,t="Untitled Model"){var o;const n=Y(e);return(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries))&&n?`${n} series`:H(e,t)}function Y(e){var r;const t=(r=e==null?void 0:e.data)==null?void 0:r.id;return t&&t.toString().trim()||null}function ae(e,{versionLabel:t,createdOn:n}={}){var a,c;const r=Y(e);if(!r)return g.push(e),g.length-1;const o=g.findIndex(l=>Y(l)===r);if(o===-1)return g.push(e),g.length-1;const i=g[o];(!Array.isArray(i.apicurioVersions)||!i.apicurioVersions.length)&&(i.apicurioVersions=[{version:"1",data:i.data,createdOn:(c=(a=i.apicurioVersions)==null?void 0:a[0])==null?void 0:c.createdOn}],i.apicurioActiveVersionIndex=0);const s=String(i.apicurioVersions.length+1);return i.apicurioVersions.push({version:s,data:e.data,createdOn:n||new Date().toISOString()}),i.apicurioActiveVersionIndex=i.apicurioVersions.length-1,i.data=e.data,i.title=H(e)||i.title,i.isSeries=!0,o}function ce(e){return(e||"").toString().trim().replace(/\/+$/,"")}function cn(){let e={};if(window!=null&&window.localStorage)try{const i=localStorage.getItem(xt);if(i){const s=JSON.parse(i);s&&typeof s=="object"&&(e=s)}}catch(i){console.warn("[Blockscape] failed to restore Apicurio settings",i)}const t=ce(e.baseUrl??Ke),n=(e.groupId??We).toString().trim();let r=Ye,o=Xe;typeof e.enabled=="boolean"?r=e.enabled:typeof e.enabled=="string"&&(r=e.enabled==="true"),typeof e.useSemver=="boolean"?o=e.useSemver:typeof e.useSemver=="string"&&(o=e.useSemver==="true"),k.baseUrl=t||Ke,k.groupId=n||We,k.authToken=(e.authToken??"").toString().trim(),k.enabled=r,k.useSemver=o,Te()}function ln(){U&&(U.value=k.baseUrl||""),B&&(B.value=k.groupId||""),_&&(_.value=k.authToken||""),ne&&(ne.checked=de()),re&&(re.checked=!!k.useSemver)}function Te(){ln(),de()?le()?(x("Apicurio push is ready when a model is selected.","muted"),Z.size||He("Click “List artifacts” to browse the current group.")):(x("Enter Apicurio connection details to enable push.","muted"),et("Enter registry details to browse artifacts.")):(x("Apicurio integration is off. Enable it to allow pushes.","muted"),et("Apicurio integration is disabled.")),ge()}function et(e){Z.clear(),He(e)}function He(e){if(!D||(D.innerHTML="",!e))return;const t=document.createElement("p");t.className="apicurio-hint",t.textContent=e,D.appendChild(t)}function dn(e){if(!D)return;if(D.innerHTML="",!e.length){He("No artifacts found in this group.");return}const t=document.createElement("ul");t.className="apicurio-artifact-list",e.forEach(n=>{if(!(n!=null&&n.artifactId))return;const r=document.createElement("li"),o=document.createElement("button");o.type="button",o.className="apicurio-artifact",o.dataset.artifactId=n.artifactId,o.dataset.artifactTrigger="toggle";const i=document.createElement("span");i.className="apicurio-artifact-title",i.textContent=n.artifactId,o.appendChild(i);const s=[];if(n.name&&s.push(n.name),n.version!=null&&s.push(`v${n.version}`),n.type&&s.push(n.type),s.length){const l=document.createElement("span");l.className="apicurio-artifact-meta",l.textContent=s.join(" • "),o.appendChild(l)}if(n.description){const l=document.createElement("span");l.className="apicurio-artifact-meta",l.textContent=n.description,o.appendChild(l)}r.appendChild(o);const a=document.createElement("div");a.className="apicurio-version-list",a.dataset.versionPanel=n.artifactId,a.hidden=!0;const c=document.createElement("p");c.className="apicurio-hint",c.textContent="Click above to choose a version to load.",a.appendChild(c),r.appendChild(a),t.appendChild(r)}),D.appendChild(t)}function tt(e){return D?D.querySelector(`[data-version-panel="${e}"]`):null}function _e(e,t){if(!e||(e.innerHTML="",!t))return;const n=document.createElement("p");n.className="apicurio-hint",n.textContent=t,e.appendChild(n)}function un(e,t){const n=tt(e);if(!n)return;if(n.innerHTML="",!t.length){_e(n,"No versions found for this artifact.");return}t.forEach(o=>{const i=document.createElement("button");i.type="button",i.className="apicurio-version-button",i.dataset.artifactId=e,i.dataset.artifactVersion=o.version;const s=[`Version ${o.version}`];if(o.createdOn){const a=new Date(o.createdOn);isNaN(a)||s.push(a.toISOString().slice(0,10))}i.textContent=s.join(" — "),n.appendChild(i)});const r=document.createElement("button");r.type="button",r.className="apicurio-version-button",r.dataset.artifactId=e,r.dataset.artifactLoadAll="true",r.textContent=`Load all (${t.length})`,n.appendChild(r)}async function fn(e){const t=tt(e);if(!t)return;if(t.dataset.open==="true"){t.hidden=!0,t.dataset.open="false";return}if(t.hidden=!1,t.dataset.open="true",t.dataset.loaded!=="true"){if(!le()){_e(t,"Enter registry details first.");return}_e(t,"Loading versions…");try{const r=ce(k.baseUrl),o=k.groupId.trim(),i=await Fe(r,o,e);oe.set(e,i),t.dataset.loaded="true",un(e,i)}catch(r){console.error("[Blockscape] failed to load versions",r),_e(t,`Unable to fetch versions: ${r.message}`)}}}function pn(e){return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.artifacts)?e.artifacts:Array.isArray(e==null?void 0:e.items)?e.items:Array.isArray(e==null?void 0:e.results)?e.results:[]}async function St(e,t,n){const r=encodeURIComponent(t),o=encodeURIComponent(n),i=`${e}/groups/${r}/artifacts/${o}`,s=Ue();s.Accept="application/json";const a=await fetch(i,{method:"GET",headers:s});if(!a.ok){let c=a.statusText||"Unknown error";try{const l=await a.text();l&&(c=l.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${a.status}): ${c}`)}return a.json()}async function Fe(e,t,n){const r=encodeURIComponent(t),o=encodeURIComponent(n),i=`${e}/groups/${r}/artifacts/${o}/versions?limit=50&order=desc`,s=Ue();s.Accept="application/json";const a=await fetch(i,{method:"GET",headers:s});if(!a.ok){let l=a.statusText||"Unknown error";try{const f=await a.text();f&&(l=f.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${a.status}): ${l}`)}const c=await a.json();return mn(c).filter(l=>l&&l.version!=null)}function mn(e){return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.versions)?e.versions:Array.isArray(e==null?void 0:e.items)?e.items:[]}function Ct(e=[]){if(!Array.isArray(e)||!e.length)return null;const t=[...e].filter(Boolean);return t.sort((n,r)=>{const o=n!=null&&n.createdOn?new Date(n.createdOn).getTime():0,i=r!=null&&r.createdOn?new Date(r.createdOn).getTime():0;if(o!==i)return i-o;const s=Number(n==null?void 0:n.version),a=Number(r==null?void 0:r.version),c=Number.isFinite(s),l=Number.isFinite(a);if(c&&l&&s!==a)return a-s;const f=String((n==null?void 0:n.version)??"");return String((r==null?void 0:r.version)??"").localeCompare(f,void 0,{numeric:!0})}),t[0]||null}function hn(e){if(!e)return e;let t=e;if(!Array.isArray(e==null?void 0:e.categories)){const r=e==null?void 0:e.content;if(typeof r=="string")try{t=JSON.parse(r)}catch(o){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",o)}else r&&typeof r=="object"&&(t=r)}return t}async function nt(e,t,n,r="latest"){const o=encodeURIComponent(t),i=encodeURIComponent(n),s=encodeURIComponent(r||"latest"),a=`${e}/groups/${o}/artifacts/${i}/versions/${s}/content`,c=Ue();c.Accept="application/json, application/*+json, */*;q=0.8";const l=await fetch(a,{method:"GET",headers:c});if(!l.ok){let A=l.statusText||"Unknown error";try{const P=await l.text();P&&(A=P.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${l.status}): ${A}`)}const f=await l.text();let b=null;try{b=JSON.parse(f)}catch{throw new Error("Artifact content is not valid JSON.")}return hn(b)}async function gn(e,t,n,r="latest"){const o=await nt(e,t,n,r);return{data:o,fingerprint:Lt(o)}}async function bn(e,t,n){try{const o=await Fe(e,t,n);if(o!=null&&o.length){oe.set(n,o);const i=Ct(o);if((i==null?void 0:i.version)!=null)return i.version}}catch(o){console.warn("[Blockscape] compare-version: unable to fetch versions list",o)}try{const o=await St(e,t,n);if((o==null?void 0:o.version)!=null)return o.version}catch(o){console.warn("[Blockscape] compare-version: unable to fetch metadata",o)}const r=oe.get(n);if(r&&r.length){const o=Ct(r);if((o==null?void 0:o.version)!=null)return o.version}return"latest"}function vn(e=document){$=e.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),L=e.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),U=e.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),B=e.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),_=e.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),ne=e.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),re=e.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),pe=e.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),D=e.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function yn(){[U,B,_].forEach(e=>{e&&e.addEventListener("input",$n)}),$&&$.addEventListener("click",()=>{_n()}),ne&&ne.addEventListener("change",Nn),re&&re.addEventListener("change",Bn),L&&L.addEventListener("click",Un),D&&D.addEventListener("click",e=>{const t=e.target.closest("[data-artifact-version]");if(t){e.stopPropagation();const o=t.dataset.artifactId,i=t.dataset.artifactVersion;o&&i&&Mn(o,i);return}const n=e.target.closest("[data-artifact-load-all]");if(n){e.stopPropagation();const o=n.dataset.artifactId;o&&On(o);return}const r=e.target.closest("[data-artifact-trigger]");if(r){const o=r.dataset.artifactId;if(!o)return;fn(o)}})}function wn(){const e=document.createElement("div");return e.className="blockscape-registry-panel",e.innerHTML=`
        <div class="blockscape-registry-header">
          <h2>Apicurio registry</h2>
          <p>Configure the registry connection and push the active model.</p>
        </div>
        <div class="apicurio-controls">
          <label class="apicurio-toggle">
            <input id="apicurioToggle" type="checkbox" />
            <span>Enable Apicurio push</span>
          </label>
          <label class="apicurio-toggle">
            <input id="apicurioSemver" type="checkbox" />
            <span>Use semantic versioning</span>
          </label>
          <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
          <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
          <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
            title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
          <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
            title="List artifacts in the configured group">List artifacts</button>
          <details id="apicurioSettings" class="apicurio-settings">
            <summary>Connection settings (optional)</summary>
            <div class="apicurio-fields">
              <label>
                Registry base URL
                <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
              </label>
              <label>
                Group ID
                <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
              </label>
              <label>
                Auth token (optional)
                <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
              </label>
            </div>
            <p class="apicurio-hint">Details stay in this browser only.</p>
          </details>
          <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
          <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
        </div>
      `,e}function En(e){if(!e)return;e.innerHTML="";const t=wn();e.appendChild(t),vn(e),yn(),Te()}function rt(){if(window!=null&&window.localStorage)try{localStorage.setItem(xt,JSON.stringify(k))}catch(e){console.warn("[Blockscape] unable to persist Apicurio settings",e)}}function le(){return!!(k.baseUrl&&k.groupId)}function de(){return k.enabled!==!1}function x(e="",t="muted"){pe&&(pe.textContent=e||"",pe.classList.remove("is-error","is-success"),t==="error"?pe.classList.add("is-error"):t==="success"&&pe.classList.add("is-success"))}function ge(){const e=de(),t=le();if($){const n=$.dataset.loading==="true",r=e&&t&&h>=0&&!!Y(g[h]);$.disabled=!e||n||!r,e?n||($.textContent="Push to Apicurio"):$.textContent="Enable Apicurio to push"}if(L){const n=L.dataset.loading==="true",r=e&&t;L.disabled=!r||n,n||(e?t?L.textContent="List artifacts":L.textContent="Enter details to list":L.textContent="Enable Apicurio to list")}}function Ue(){const e={Accept:"application/json"},t=(k.authToken||"").trim();return t&&(e.Authorization=/\s/.test(t)?t:`Bearer ${t}`),e}function xn(e,t,{title:n,description:r,version:o}={}){const i={artifactId:e,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:t}}};return o&&(i.firstVersion.version=o),n&&(i.name=n),r&&(i.description=r),i}function kn(e,{version:t}={}){const n={content:{contentType:"application/json",content:e}};return t&&(n.version=t),n}function An(e){if(e==null)return null;const t=String(e).trim();if(!t)return null;const n=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(t);if(n)return{major:Number(n[1]),minor:Number(n[2]),patch:Number(n[3])};const r=/^v?(\d+)$/.exec(t);return r?{major:Number(r[1]),minor:0,patch:0}:null}function Ln(e){return`${e.major}.${e.minor}.${e.patch}`}function Sn(e,t){return!e&&!t?0:e?t?e.major!==t.major?e.major-t.major:e.minor!==t.minor?e.minor-t.minor:e.patch-t.patch:1:-1}function Cn(e=[]){let t=null;if(e.forEach(r=>{const o=An((r==null?void 0:r.version)??r);o&&(!t||Sn(o,t)>0)&&(t=o)}),!t)return"1.0.0";const n={...t,patch:t.patch+1};return Ln(n)}async function In(e,t,n,r){if(!k.useSemver)return null;if(!r)return"1.0.0";try{const o=await Fe(e,t,n);return Cn(o)}catch(o){throw new Error(`Unable to compute next semantic version: ${o.message}`)}}function $n(){k.baseUrl=ce((U==null?void 0:U.value)??k.baseUrl),k.groupId=((B==null?void 0:B.value)??"").trim(),k.authToken=((_==null?void 0:_.value)??"").trim(),rt(),Te()}function Nn(){k.enabled=ne?ne.checked:Ye,rt(),Te()}function Bn(){k.useSemver=re?re.checked:Xe,rt(),Te()}async function Tn(e,t,n,r){const o=encodeURIComponent(t),i=encodeURIComponent(n),s=`${e}/groups/${o}/artifacts/${i}`;try{const a=await fetch(s,{method:"GET",headers:r});if(a.status===404)return!1;if(a.ok)return!0;throw a.status===401||a.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${a.status} while checking the artifact.`)}catch(a){throw a instanceof TypeError?new Error("Network error while contacting Apicurio registry."):a}}function It(e,t){var r;const n=g.findIndex(o=>o.apicurioArtifactId===e);if(n!==-1){const o=g[n].id;g[n]={...t,id:o||t.id},((r=g[n].apicurioVersions)==null?void 0:r.length)>1&&(g[n].isSeries=!0),F(n)}else g.push(t),F(g.length-1)}async function _n(){var i;if(!$||$.dataset.loading==="true")return;if(!de()){x("Apicurio integration is off. Enable it first.","error");return}if(!le()){x("Enter the registry base URL and group ID before pushing.","error");return}if(h<0||!g[h]){x("No active model to push.","error");return}const e=Y(g[h]);if(!e){x("Active model needs an id before pushing.","error");return}const t=ce(k.baseUrl),n=k.groupId.trim(),r=JSON.stringify(g[h].data,null,2),o=Ue();$.dataset.loading="true",$.textContent="Pushing…",$.disabled=!0,x("Pushing to Apicurio…","muted");try{const s=await Tn(t,n,e,o),a=Lt(g[h].data);if(s)try{const m=await bn(t,n,e),{data:S,fingerprint:N}=await gn(t,n,e,m);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",m),console.log("local fingerprint",a),console.log("registry fingerprint",N),console.log("local payload",g[h].data),console.log("registry payload",S),console.groupEnd(),a&&N&&a===N){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){x("Push cancelled (content matches the latest registry version).","muted");return}x("Pushing identical content by user choice.","muted")}else N?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):x("Unable to compare with registry content (skipping confirmation).","muted")}catch(m){console.warn("[Blockscape] unable to compare registry content before push",m),x("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const c=k.useSemver?await In(t,n,e,s):null;if(k.useSemver&&!c)throw new Error("Semantic versioning is enabled but no version could be computed.");const l=encodeURIComponent(n),f=encodeURIComponent(e),b=s?`${t}/groups/${l}/artifacts/${f}/versions`:`${t}/groups/${l}/artifacts`,A={...o,"Content-Type":"application/json"};c&&(A["X-Registry-Version"]=c,x(`Pushing to Apicurio as version ${c}…`,"muted"));const P=s?kn(r,{version:c}):xn(e,r,{title:H(g[h]),description:(i=g[h].data)==null?void 0:i.abstract,version:c}),Q=await fetch(b,{method:"POST",headers:A,body:JSON.stringify(P)});if(!Q.ok){let m=Q.statusText||"Unknown error";try{const S=await Q.text();S&&(m=S.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Q.status}): ${m}`)}let q=null;try{q=await Q.json()}catch{q=null}const ke=(q==null?void 0:q.version)||(q==null?void 0:q.globalId)||"",Ae=s?"Updated":"Created",Le=ke?` (version ${ke})`:"";x(`${Ae} ${e}${Le}`,"success")}catch(s){console.error("[Blockscape] Apicurio push failed",s),x(`Apicurio push failed: ${s.message}`,"error")}finally{$.dataset.loading="false",ge()}}async function Un(){if(!L||L.dataset.loading==="true")return;if(!de()){x("Enable Apicurio integration to list artifacts.","error");return}if(!le()){x("Enter registry base URL and group ID before listing.","error");return}const e=ce(k.baseUrl),t=k.groupId.trim(),n=encodeURIComponent(t),r=`${e}/groups/${n}/artifacts?limit=50&offset=0`;L.dataset.loading="true",L.textContent="Listing…",L.disabled=!0,x("Listing artifacts…","muted"),He("Contacting registry…");try{const o=Ue();o.Accept="application/json";const i=await fetch(r,{method:"GET",headers:o});if(!i.ok){let l=i.statusText||"Unknown error";try{const f=await i.text();f&&(l=f.slice(0,400))}catch{}throw new Error(`Failed to list artifacts (${i.status}): ${l}`)}const s=await i.json(),a=pn(s).filter(l=>l&&l.artifactId);Z.clear(),oe.clear(),a.forEach(l=>{l!=null&&l.artifactId&&Z.set(l.artifactId,l)}),dn(a);const c=a.length;x(c?`Found ${c} artifact${c===1?"":"s"}.`:"No artifacts found in this group.",c?"success":"muted")}catch(o){console.error("[Blockscape] failed to list artifacts",o),et("Unable to list artifacts."),x(`Listing failed: ${o.message}`,"error")}finally{L.dataset.loading="false",ge()}}async function Mn(e,t=null){if(!e)return;if(!de()){x("Enable Apicurio integration to load artifacts.","error");return}if(!le()){x("Enter registry connection details before loading artifacts.","error");return}const n=ce(k.baseUrl),r=k.groupId.trim();let o=Z.get(e);const i=async()=>{try{const f=await St(n,r,e);return f!=null&&f.artifactId&&Z.set(e,f),f}catch(f){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",f),f}};if(!o)try{o=await i()}catch(f){x(`Failed to fetch artifact metadata: ${f.message}`,"error");return}const s=oe.get(e)||[];let a="latest",c="latest";if(t)a=t,c=t;else{if(!o||o.version==null)try{o=await i()}catch(f){x(`Failed to fetch artifact metadata: ${f.message}`,"error");return}a=(o==null?void 0:o.version)||"latest",c=(o==null?void 0:o.version)||"latest"}const l=s.find(f=>String(f.version)===String(a));(l==null?void 0:l.version)!=null&&(c=l.version),x(`Loading artifact ${e}…`,"muted");try{const f=await nt(n,r,e,a),b=Z.get(e)||o||{};se(f,{titleHint:b.name||e,idHint:e});const A={version:c,data:f,createdOn:(l==null?void 0:l.createdOn)||b.createdOn},P={id:ie(),title:f.title||b.name||e,data:f,apicurioArtifactId:e,apicurioArtifactName:b.name||"",apicurioVersions:[A],apicurioActiveVersionIndex:0};It(e,P);const Q=c?` (version ${c})`:"";x(`Loaded artifact ${e}${Q}.`,"success")}catch(f){console.error("[Blockscape] failed to load artifact",f),x(`Failed to load artifact: ${f.message}`,"error")}}async function On(e){if(!e)return;if(!de()){x("Enable Apicurio integration to load artifacts.","error");return}if(!le()){x("Enter registry connection details before loading artifacts.","error");return}const t=ce(k.baseUrl),n=k.groupId.trim();let r=oe.get(e);if(!r){_e(tt(e),"Loading versions…");try{r=await Fe(t,n,e),oe.set(e,r)}catch(c){x(`Failed to fetch versions: ${c.message}`,"error");return}}const o=(r||[]).filter(c=>c&&c.version!=null);if(!o.length){x("No versions found for this artifact.","muted");return}x(`Loading ${o.length} version(s) for ${e}…`,"muted");const i=Z.get(e)||{},s=[];try{for(const c of o){const l=c.version??"latest",f=await nt(t,n,e,l);se(f,{titleHint:i.name||e,idHint:e}),s.push({version:l,createdOn:c.createdOn,data:f})}}catch(c){console.error("[Blockscape] failed to load one or more versions",c),x(`Failed to load all versions: ${c.message}`,"error");return}if(!s.length){x("No versions loaded from registry.","error");return}const a={id:ie(),title:s[0].data.title||i.name||e,data:s[0].data,apicurioArtifactId:e,apicurioArtifactName:i.name||"",apicurioVersions:s,apicurioActiveVersionIndex:0};It(e,a),x(`Loaded ${s.length} version(s) for ${e}.`,"success")}function ot(){const e=h>=0&&g[h]?g[h]:null,t=Y(e);document.title=t?`${t}-blockscape`:Qt}function $t(e="shortcut"){const t=d.value||"";if(!t.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const n=H(g[h],"blockscape"),r=`${kt(n)}.json`;return rn(r,t),console.log(`[Blockscape] saved JSON (${e}):`,r),!0}const Pn={A:"#ef4444",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#f43f5e",P:"#e11d48",Q:"#dc2626",R:"#f59e0b",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"};function Rn(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Pn[n]||"#9ca3af"}function Vn(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(c=>c+c).join(""):t,r=parseInt(n,16),o=r>>16&255,i=r>>8&255,s=r&255;return .2126*Math.pow(o/255,2.2)+.7152*Math.pow(i/255,2.2)+.0722*Math.pow(s/255,2.2)>.35?"#111111":"#ffffff"}function jn(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}let it=!1;function Nt(){it||(it=!0,requestAnimationFrame(()=>{it=!1,at(),Oe()}))}let Bt=!1;function F(e){if(X(),he=null,e<0||e>=g.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}h=e,console.log("[Blockscape] active model:",H(g[e]),"(index",e+" )"),ot(),be(),ve(),ue(),ge()}function be(){if(I.innerHTML="",!g.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",I.appendChild(e);return}g.forEach((e,t)=>{var b;const n=document.createElement("li");n.className="model-nav-item";const r=document.createElement("button");r.type="button",r.className="model-nav-button"+(t===h?" is-active":""),r.dataset.index=String(t),r.setAttribute("aria-current",t===h?"true":"false");const o=document.createElement("span");o.className="model-nav-label";const i=document.createElement("span");i.className="model-nav-title",i.textContent=an(e),o.appendChild(i);const s=Y(e);if(s){const A=document.createElement("span");A.className="model-nav-id",A.textContent=s,o.appendChild(A)}const a=Array.isArray((b=e.data)==null?void 0:b.categories)?e.data.categories:[],c=a.reduce((A,P)=>A+(P.items||[]).length,0),l=document.createElement("span");l.className="model-nav-meta";const f=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} versions`:"";l.textContent=`${a.length} cat · ${c} items${f}`,r.appendChild(o),r.appendChild(l),n.appendChild(r),I.appendChild(n)}),ge()}function ve(){if(h<0){d.value="";return}d.value=JSON.stringify(g[h].data,null,2)}function Dn(e){try{return JSON.parse(e)}catch{return null}}function ye(e,t="Pasted"){const n=(e||"").trim();if(!n)return[];const r=Dn(n);return r?(Array.isArray(r)?r:[r]).map((s,a)=>(se(s,{titleHint:`${t} #${a+1}`}),{id:ie(),title:s.title||`${t} #${a+1}`,data:s})):n.split(/^\s*(?:---|%%%)\s*$/m).map(i=>i.trim()).filter(Boolean).map((i,s)=>{const a=JSON.parse(i);return se(a,{titleHint:`${t} #${s+1}`}),{id:ie(),title:a.title||`${t} #${s+1}`,data:a}})}function Jn(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function Me(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!Jn(e)}function Hn(e){if(!e)return!1;const t=e.trimStart();return/^\s*(\{|\[|---|%%%)/.test(t)}function Tt(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(Be)}catch(o){return console.warn("[Blockscape] failed to access editor payload",o),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(o){console.warn("[Blockscape] invalid payload JSON",o);try{localStorage.removeItem(Be)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(Be)}catch(o){console.warn("[Blockscape] failed to clear editor payload",o)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=ye(t.text,t.title||"Editor Export")}catch(o){return console.warn("[Blockscape] could not parse payload text",o),null}if(!n.length)return null;let r=null;return n.forEach(o=>{const i=ae(o,{versionLabel:"editor"});r==null&&(r=i)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:r,count:n.length}}function _t(e="storage"){const t=Tt();return!t||typeof t.index!="number"?!1:(F(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Fn(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const i=new URLSearchParams(window.location.search);i.has("share")&&(t=i.get("share"))}if(!t)return null;let r;try{const i=nn(t);r=JSON.parse(i)}catch(i){return console.warn("[Blockscape] failed to decode share token",i),null}return!r||typeof r!="object"||typeof r.data!="object"?(console.warn("[Blockscape] share payload missing data"),null):(se(r.data,{titleHint:r.title||"Shared Model"}),ae({id:ie(),title:r.data.title||r.title||"Shared Model",data:r.data},{versionLabel:"shared"}))}async function qn(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const r=new URLSearchParams(window.location.search);r.has("load")&&(t=r.get("load"))}if(!t)return null;try{const r=await dt(t);return typeof r=="number"?r:null}catch(r){return console.warn("[Blockscape] load param failed",r),null}}function Gn(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,r=new Set;(e.categories||[]).forEach(i=>(i.items||[]).forEach(s=>{r.add(s.id);const a=new Set(s.deps||[]);(e.links||[]).forEach(c=>{c.from===s.id&&a.add(c.to)}),t.set(s.id,a),a.forEach(c=>{n.has(c)||n.set(c,new Set),n.get(c).add(s.id)})}));const o=new Set;return n.forEach((i,s)=>{((i==null?void 0:i.size)||0)>=2&&o.add(s)}),{m:e,fwd:t,rev:n,reusedLocal:o,seen:r}}function zn(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),r=44;n.width=r,n.height=r;const o=n.getContext("2d"),i=(e||"?").charAt(0).toUpperCase(),s=Rn(e,t),a=Vn(s);return o.fillStyle=s,o.beginPath(),o.arc(r/2,r/2,r/2-2,0,2*Math.PI),o.fill(),o.strokeStyle="rgba(0,0,0,0.15)",o.lineWidth=1,o.stroke(),o.fillStyle=a,o.font=`bold ${r*.5}px system-ui, -apple-system, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(i,r/2,r/2),n.toDataURL("image/png")}function st(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function Ut(e){const t=st(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Kn(e,t){var s;if(e<0||e>=g.length)return!1;const n=g[e];if(!((s=n==null?void 0:n.apicurioVersions)!=null&&s.length))return!1;const r=n.apicurioVersions.length,o=(t%r+r)%r,i=n.apicurioVersions[o];return i!=null&&i.data?(n.apicurioActiveVersionIndex=o,n.data=i.data,E=null,ve(),ue(),!0):!1}function Mt(e){var r;if(!e||h<0)return;const t=g[h];if(!((r=t==null?void 0:t.apicurioVersions)!=null&&r.length))return;const n=st(t);n!==-1&&Kn(h,n+e)}function Wn(e){if(!(e!=null&&e.apicurioVersions)||e.apicurioVersions.length<=1)return null;const t=document.createElement("div");t.className="version-nav";const n=document.createElement("div");n.className="version-nav__title",n.textContent=e.apicurioArtifactName||e.apicurioArtifactId||Y(e)||"Artifact",t.appendChild(n);const r=document.createElement("div");r.className="version-nav__status";const o=st(e),i=Ut(e)||"latest";r.textContent=`No. in series ${i} (${o+1} of ${e.apicurioVersions.length})`,t.appendChild(r);const s=document.createElement("div");s.className="version-nav__controls";const a=document.createElement("button");a.type="button",a.className="version-nav__button",a.textContent="Previous",a.addEventListener("click",()=>Mt(-1));const c=document.createElement("button");return c.type="button",c.className="version-nav__button",c.textContent="Next",c.addEventListener("click",()=>Mt(1)),s.appendChild(a),s.appendChild(c),t.appendChild(s),t}function we(){if(!C)return;Ee(),Array.isArray(C.m.categories)||(C.m.categories=[]),console.log("[Blockscape] rendering categories=",C.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!C.m.abstract,"- value:",C.m.abstract?C.m.abstract.substring(0,50)+"...":"none"),p.innerHTML="",O.clear();const e=Wn(g[h]);e&&p.appendChild(e),w.setAttribute("width",window.innerWidth),w.setAttribute("height",window.innerHeight);const t=document.createElement("div");t.className="blockscape-model-meta";const n=document.createElement("div");n.className="blockscape-model-title",n.textContent=C.m.title&&C.m.title.trim()||H(g[h]),t.appendChild(n);const r=Ut(g[h]),o=(C.m.id??"").toString().trim();if(o){const m=document.createElement("div");m.className="blockscape-model-id",m.textContent=`ID: ${o}`,t.appendChild(m)}if(r){const m=document.createElement("div");m.className="blockscape-model-id",m.textContent=`No. in series: ${r}`,t.appendChild(m)}p.appendChild(t);const i=document.createElement("div");i.className="blockscape-tabs";const s=document.createElement("div");s.className="blockscape-tablist",s.setAttribute("role","tablist"),i.appendChild(s);const a=document.createElement("div");a.className="blockscape-tabpanels",i.appendChild(a);const c=document.createElement("div"),l=document.createElement("div"),f=document.createElement("div"),b=document.createElement("div");let A="";const P=[{id:"map",label:"Map",panel:c},{id:"abstract",label:"Info",panel:l},{id:"source",label:"Source",panel:f},{id:"apicurio",label:"Apicurio",panel:b}],Q=m=>{if(!w)return;const S=m==="map";w.hidden=!S,S?(at(),Oe()):w.innerHTML=""};P.forEach((m,S)=>{const N=document.createElement("button");N.type="button",N.id=`tab-${m.id}`,N.className="blockscape-tab"+(S===0?" is-active":""),N.setAttribute("role","tab"),N.setAttribute("aria-controls",`panel-${m.id}`),N.setAttribute("aria-selected",S===0?"true":"false"),N.textContent=m.label,m.button=N,s.appendChild(N),m.panel.id=`panel-${m.id}`,m.panel.classList.add("blockscape-tabpanel"),m.panel.setAttribute("role","tabpanel"),m.panel.setAttribute("aria-labelledby",N.id),m.panel.hidden=S!==0,S===0&&m.panel.classList.add("is-active"),a.appendChild(m.panel)});const q=m=>{P.forEach(S=>{const N=S.id===m;S.button.classList.toggle("is-active",N),S.button.setAttribute("aria-selected",N?"true":"false"),S.panel.classList.toggle("is-active",N),S.panel.hidden=!N}),Q(m)};P.forEach(m=>{m.button.addEventListener("click",()=>{Ee(),q(m.id)}),m.id==="abstract"&&(m.button.addEventListener("mouseenter",()=>Rt(m.button,A,{offset:12})),m.button.addEventListener("mouseleave",Ee),m.button.addEventListener("focus",()=>Rt(m.button,A,{offset:12})),m.button.addEventListener("blur",Ee))}),q(P[0].id),p.appendChild(i);const ke=document.createElement("div");ke.className="blockscape-render",c.appendChild(ke);const Ae=document.createElement("div");if(Ae.className="blockscape-abstract-panel",C.m.abstract){console.log("[Blockscape] Rendering abstract content");const m=document.createElement("div");m.className="blockscape-abstract",m.innerHTML=C.m.abstract,gr(m),Ae.appendChild(m),A=m.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const m=document.createElement("div");m.className="blockscape-abstract-placeholder",m.textContent="No abstract has been provided for this model.",Ae.appendChild(m),A=m.outerHTML}l.appendChild(Ae);const Le=document.createElement("div");if(Le.className="blockscape-source-panel",u)u.hidden=!1,u.classList.remove("pf-v5-c-page__main-section"),Le.appendChild(u);else{const m=document.createElement("p");m.className="muted",m.textContent="Source editor unavailable.",Le.appendChild(m)}f.appendChild(Le),En(b),C.m.categories.forEach(m=>{const S=document.createElement("section");S.className="category",S.dataset.cat=m.id;const N=document.createElement("div");N.className="cat-head",N.innerHTML=`<div class="cat-title">${lt(m.title||m.id)}</div>
                          <div class="muted cat-count">${(m.items||[]).length} items</div>`,S.appendChild(N);const qe=document.createElement("div");qe.className="grid",S.appendChild(qe),(m.items||[]).forEach(R=>{const Re=Xn(R.external),z=document.createElement("div");z.className=Re.isExternal?"tile external":"tile",z.tabIndex=0,z.dataset.id=R.id,Re.url&&(z.dataset.externalUrl=Re.url);const fe=document.createElement("img");fe.className="logo",R.logo?(fe.src=R.logo,fe.alt=R.name||R.id):(fe.alt="",fe.style.opacity=1,fe.src=zn(R.name||R.id,R.color));const ut=document.createElement("div");ut.className="name",ut.textContent=R.name||R.id;const ft=document.createElement("div");ft.className="badge",ft.textContent="reused",Re.url&&z.appendChild(Qn(Re.url)),z.appendChild(fe),z.appendChild(ut),z.appendChild(ft),qe.appendChild(z),O.set(R.id,{el:z,catId:m.id,rect:null})}),ke.appendChild(S)}),C.reusedLocal.forEach(m=>{const S=O.get(m);S&&(S.el.classList.add("reused"),S.el.querySelector(".badge").style.display="inline-block")}),Yn(),at(),Oe()}function Yn(){p.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",t=>{if(typeof t.button=="number"&&t.button!==0)return;X();const n=e.dataset.id;if(console.log("[Blockscape] click",n),E===n){ct();return}G(n)}),e.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),e.click())}),e.draggable=!0,e.addEventListener("dragstart",tr),e.addEventListener("dragend",nr)}),p.querySelectorAll(".grid").forEach(e=>{e.addEventListener("dragover",rr),e.addEventListener("drop",sr),e.addEventListener("dragenter",or),e.addEventListener("dragleave",ir)}),Bt||(Bt=!0,window.addEventListener("resize",Nt),window.addEventListener("scroll",Nt,{passive:!0})),document.getElementById("clear").onclick=()=>ct()}function at(){O.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function G(e){E=e,Ot();const t=Array.from(C.fwd.get(e)||[]),n=Array.from(C.rev.get(e)||[]);console.log("[Blockscape] selecting id=",e,"deps=",t,"revs=",n);const r=O.get(e);r&&r.el.classList.add("selected"),t.forEach(o=>{const i=O.get(o);i&&i.el.classList.add("dep")}),n.forEach(o=>{const i=O.get(o);i&&i.el.classList.add("revdep")}),Oe()}function ct(){E=null,Ot(),Oe()}function Ot(){p.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","selected"))}function Oe(){var n;for(;w.firstChild;)w.removeChild(w.firstChild);if(!E||w.hidden)return;const e=(n=O.get(E))==null?void 0:n.rect;if(!e)return;new Set([...C.fwd.get(E)||[],...C.rev.get(E)||[]]).forEach(r=>{const o=O.get(r);if(!o||!o.rect)return;const i=Pt(e),s=Pt(o.rect),a=document.createElementNS("http://www.w3.org/2000/svg","path"),c=(i.x+s.x)/2,l=i.y,f=(i.x+s.x)/2,b=s.y,A=(C.fwd.get(E)||new Set).has(r);a.setAttribute("d",`M ${i.x},${i.y} C ${c},${l} ${f},${b} ${s.x},${s.y}`),a.setAttribute("fill","none"),a.setAttribute("stroke",A?"var(--blockscape-dep)":"var(--blockscape-revdep)"),a.setAttribute("stroke-opacity","0.45"),a.setAttribute("stroke-width","2"),a.setAttribute("vector-effect","non-scaling-stroke"),w.appendChild(a)})}function Pt(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function lt(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Xn(e){if(typeof e=="string"){const t=e.trim();if(!t)return{isExternal:!1,url:""};try{const n=new URL(t);return/^https?:/i.test(n.protocol)?{isExternal:!0,url:n.toString()}:{isExternal:!1,url:""}}catch(n){return console.warn("[Blockscape] invalid external url skipped",e,n),{isExternal:!1,url:""}}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Qn(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function Rt(e,t,{offset:n=8}={}){!v||!e||!t||(v.innerHTML=t,v.hidden=!1,v.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const r=e.getBoundingClientRect(),o=v.getBoundingClientRect(),i=window.scrollX||document.documentElement.scrollLeft,s=window.scrollY||document.documentElement.scrollTop;let a=r.left+r.width/2-o.width/2+i,c=r.top-o.height-n+s;a<i+n&&(a=i+n);const l=i+window.innerWidth-o.width-n;a>l&&(a=l),c<s+n&&(c=r.bottom+n+s),v.style.left=`${a}px`,v.style.top=`${c}px`,v.classList.add("is-visible")}))}function Ee(){v&&(v.classList.remove("is-visible"),v.setAttribute("aria-hidden","true"),v.hidden=!0)}window.addEventListener("scroll",Ee,!0),window.addEventListener("resize",Ee);function X(){y&&(y.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),y.setAttribute("aria-hidden","true"),y.hidden=!0,Vt(""))}function Zn(e,t){y&&(J={x:e,y:t},y.hidden=!1,y.setAttribute("aria-hidden","false"),y.classList.add("is-visible"),xe(e,t))}function xe(e,t){if(!y)return;const n=12;y.style.left=`${e+n}px`,y.style.top=`${t+n}px`;const r=y.getBoundingClientRect();let o=r.left,i=r.top;r.right>window.innerWidth-n&&(o=Math.max(n,window.innerWidth-r.width-n)),r.bottom>window.innerHeight-n&&(i=Math.max(n,window.innerHeight-r.height-n)),y.style.left=`${o}px`,y.style.top=`${i}px`}function Vt(e){if(Ne)if(Ne.innerHTML="",e){const t=document.createElement("button");t.type="button",t.className="item-preview__action",t.innerHTML='Open external link <span aria-hidden="true">↗</span>',t.title=e,t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),Ne.appendChild(t),Ne.hidden=!1}else Ne.hidden=!0}async function er(e,t){var c;if(!y)return;e.stopPropagation(),e.preventDefault();const n=t.dataset.id,r=((c=t.querySelector(".name"))==null?void 0:c.textContent)||n||"Preview",o=n?`${n}.html`:"",i=o?`items/${o}`:"",s=++Qe,a=t.dataset.externalUrl||"";if(Vt(a),Yt.textContent=r,me.innerHTML='<div class="item-preview__status">Loading…</div>',y.classList.remove("item-preview--has-frame"),y.classList.add("item-preview--expanded"),Zn(e.clientX,e.clientY),!i){me.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',xe(J.x,J.y);return}try{const l=await fetch(i,{cache:"no-cache"});if(!l.ok)throw new Error(`HTTP ${l.status}`);const f=await l.text();if(s!==Qe)return;if(!f.trim()){me.innerHTML=`<div class="item-preview__status">No content in <code>${lt(o)}</code>.</div>`,xe(J.x,J.y);return}const A=document.createElement("iframe");A.className="item-preview__frame",A.title=`${r} details`,A.srcdoc=f,me.innerHTML="",me.appendChild(A),y.classList.add("item-preview--has-frame"),xe(J.x,J.y)}catch(l){if(s!==Qe)return;me.innerHTML=`<div class="item-preview__status">No preview available for <strong>${lt(r)}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${i}`,l),xe(J.x,J.y)}}gt&&gt.addEventListener("click",X),p&&p.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");!t||!p.contains(t)||er(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||!y||y.hidden||y.contains(e.target)||X()}),bt&&bt.addEventListener("click",()=>{$t("button")}),vt&&vt.addEventListener("click",async()=>{var i;if(h<0||!g[h]){alert("Select or load a model before sharing.");return}const e={title:H(g[h],"Shared Model"),data:g[h].data};let t;try{t=tn(JSON.stringify(e))}catch(s){console.error("[Blockscape] share encode failed",s),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const r=n.toString();try{window.history.replaceState({},document.title,r)}catch(s){console.warn("[Blockscape] failed to update URL for share",s),window.location.hash=n.hash}let o=!1;if((i=navigator.clipboard)!=null&&i.writeText)try{await navigator.clipboard.writeText(r),o=!0}catch(s){console.warn("[Blockscape] clipboard write failed",s)}o?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",r)}),yt&&yt.addEventListener("click",()=>{const e=(d.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};E&&(n.selectedItemId=E),localStorage.setItem(Be,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";E&&(t=`editor.html?selected=${encodeURIComponent(E)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==Be||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||_t("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===Xt&&_t("message")})),document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault(),$t("shortcut");return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!Me())return;if(ur()){e.preventDefault();return}}if(e.key==="Escape"&&y&&!y.hidden&&X(),e.key==="ArrowLeft"||e.key==="ArrowRight"){if(!Me()||e.altKey||e.ctrlKey||e.metaKey)return;const t=e.key==="ArrowLeft"?-1:1;e.shiftKey?ar(t)&&e.preventDefault():cr(t)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(!Me()||e.altKey||e.ctrlKey||e.metaKey)return;const t=e.key==="ArrowUp"?-1:1;e.shiftKey?dr(t)&&e.preventDefault():lr(t)&&e.preventDefault()}if(e.key==="Delete"){if(!Me()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;fr()&&e.preventDefault()}}),window.addEventListener("resize",()=>{!y||y.hidden||xe(J.x,J.y)}),window.addEventListener("scroll",()=>{!y||y.hidden||X()},!0);let ee=null,Pe=null;function tr(e){X(),ee=e.target.dataset.id,Pe=e.target.closest(".category").dataset.cat,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({itemId:ee,categoryId:Pe})),e.target.closest(".category").querySelector(".grid").classList.add("drag-active"),console.log("[Blockscape] drag start",ee,"from",Pe)}function nr(e){e.target.classList.remove("dragging"),p.querySelectorAll(".grid").forEach(t=>t.classList.remove("drag-active")),p.querySelectorAll(".tile").forEach(t=>t.classList.remove("drag-over")),ee=null,Pe=null}function rr(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function or(e){e.preventDefault();const t=e.target.closest(".grid");t&&t.classList.add("drag-active")}function ir(e){const t=e.target.closest(".grid");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-active")}function sr(e){e.preventDefault();const t=e.target.closest(".grid");if(!t)return;const n=t.closest(".category");if(!n)return;const r=n.dataset.cat;if(!ee||!r)return;const i=Array.from(t.querySelectorAll(".tile")).filter(s=>s.dataset.id!==ee).find(s=>{const a=s.getBoundingClientRect();return e.clientY<a.top+a.height/2});jt(ee,i?i.dataset.id:null,r),we(),console.log("[Blockscape] drop completed",ee,"from",Pe,"to",r)}function jt(e,t,n){if(h<0)return;const o=g[h].data.categories||[],i=o.find(f=>(f.items||[]).some(b=>b.id===e)),s=o.find(f=>f.id===n);if(!i||!s)return;i.items=i.items||[],s.items=s.items||[];const a=i.items.findIndex(f=>f.id===e);if(a===-1)return;const[c]=i.items.splice(a,1);let l=s.items.length;if(t){const f=s.items.findIndex(b=>b.id===t);f!==-1&&(l=f)}s.items.splice(l,0,c),ve(),ue()}function ar(e){if(!E||h<0||!e)return!1;const n=g[h].data.categories||[],r=O.get(E);let o=null;if(r!=null&&r.catId&&(o=n.find(c=>c.id===r.catId)),o||(o=n.find(c=>(c.items||[]).some(l=>l.id===E))),!o)return!1;o.items=o.items||[];const i=o.items.findIndex(c=>c.id===E);if(i===-1)return!1;const s=i+e;if(s<0||s>=o.items.length)return!1;const[a]=o.items.splice(i,1);return o.items.splice(s,0,a),ve(),ue(),we(),G(E),!0}function cr(e){if(!C||!C.m||!e)return!1;const t=C.m.categories||[];if(!t.length)return!1;const n=()=>{const c=t.find(l=>(l.items||[]).length);return c?{category:c,item:c.items[0]}:null};if(!E){const c=n();return c?(G(c.item.id),!0):!1}const r=O.get(E);let o=null;if(r!=null&&r.catId&&(o=t.find(c=>c.id===r.catId)),o||(o=t.find(c=>(c.items||[]).some(l=>l.id===E))),!o){const c=n();return c?(G(c.item.id),!0):!1}const i=o.items||[];if(!i.length)return!1;const s=i.findIndex(c=>c.id===E);if(s===-1)return!1;const a=s+e;return a<0||a>=i.length?!1:(G(i[a].id),!0)}function lr(e){if(!C||!C.m||!e)return!1;const t=C.m.categories||[];if(!t.length)return!1;const n=()=>{for(const c of t)if(c.items&&c.items.length)return c.items[0].id;return null};let o=(()=>{if(!E)return-1;const c=O.get(E);if(c!=null&&c.catId){const l=t.findIndex(f=>f.id===c.catId);if(l!==-1)return l}return t.findIndex(l=>(l.items||[]).some(f=>f.id===E))})();if(o===-1){const c=n();return c?(G(c),!0):!1}let s=(t[o].items||[]).findIndex(c=>c.id===E);s===-1&&(s=0);let a=o+e;for(;a>=0&&a<t.length;){const l=t[a].items||[];if(l.length){const f=Math.min(l.length-1,Math.max(0,s));return G(l[f].id),!0}a+=e>0?1:-1}return!1}function dr(e){if(!E||h<0||!e)return!1;const n=g[h].data.categories||[];if(!n.length)return!1;const r=O.get(E);let o=-1;if(r!=null&&r.catId&&(o=n.findIndex(b=>b.id===r.catId)),o===-1&&(o=n.findIndex(b=>(b.items||[]).some(A=>A.id===E))),o===-1)return!1;const i=o+e;if(i<0||i>=n.length)return!1;const s=n[o],a=n[i];if(!a)return!1;s.items=s.items||[],a.items=a.items||[];const c=s.items.findIndex(b=>b.id===E);if(c===-1)return!1;const l=Math.min(a.items.length,Math.max(0,c)),f=l<a.items.length?a.items[l].id:null;return jt(E,f,a.id),we(),G(E),!0}function ur(){if(!he||h<0)return!1;const e=g[h];if(!e||e.id!==he.modelId)return!1;const t=he,o=(e.data.categories||[]).find(s=>s.id===t.categoryId);if(!o)return!1;o.items=o.items||[];const i=Math.min(Math.max(t.index,0),o.items.length);return o.items.splice(i,0,t.item),he=null,X(),E=null,ve(),ue(),we(),G(t.item.id),console.log("[Blockscape] undo delete restored",t.item.id),!0}function fr(){if(!E||h<0)return!1;const t=g[h].data.categories||[];if(!t.length)return!1;const n=O.get(E);let r=null;if(n!=null&&n.catId&&(r=t.find(l=>l.id===n.catId)),r||(r=t.find(l=>(l.items||[]).some(f=>f.id===E))),!r||!Array.isArray(r.items))return!1;const o=r.items.findIndex(l=>l.id===E);if(o===-1)return!1;const i=r.items.splice(o,1)[0];if(!i)return!1;const s=g[h];he={item:i,categoryId:r.id,index:o,modelId:s?s.id:null};const c=(()=>{var f;if(r.items.length){const b=Math.min(o,r.items.length-1);return((f=r.items[b])==null?void 0:f.id)||null}const l=t.findIndex(b=>b.id===r.id);if(l===-1)return null;for(let b=l+1;b<t.length;b++){const A=t[b].items||[];if(A.length)return A[0].id}for(let b=l-1;b>=0;b--){const A=t[b].items||[];if(A.length)return A[0].id}return null})();return X(),E=null,ve(),ue(),we(),c?G(c):ct(),console.log("[Blockscape] removed item",i.id),!0}wt&&wt.addEventListener("click",async()=>{const e=d.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await on(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),Et&&Et.addEventListener("click",async()=>{try{const e=await sn();if(!e){alert("Clipboard is empty.");return}d.value=e,d.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=()=>{try{const e=ye(d.value,"Pasted");if(!e.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",e.length,"model(s)");let t=null;e.forEach((n,r)=>{const o=ae(n,{versionLabel:e.length>1?`paste #${r+1}`:"paste"});t==null&&(t=o)}),h===-1&&t!=null?F(t):be()}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{if(h<0){alert("No active model selected.");return}try{const e=JSON.parse(d.value);se(e,{titleHint:H(g[h]),idHint:Y(g[h])||H(g[h])}),g[h].data=e,g[h].title=e.title||g[h].title,ot(),console.log("[Blockscape] replaced active model:",H(g[h])),ue(),ge()}catch(e){console.error("[Blockscape] replace error:",e),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const r of t){const o=await r.text(),i=ye(o,r.name.replace(/\.[^.]+$/,"")||"File");if(!i.length){console.warn("[Blockscape] no models in file:",r.name);continue}i.forEach((s,a)=>{var b;const c=(((b=s.data)==null?void 0:b.title)??"").toString().trim(),l=i.length>1?`${r.name} #${a+1}`:r.name,f=ae({...s,title:c||l},{versionLabel:r.name});n==null&&(n=f)})}h===-1&&n!=null?F(n):be()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",pr);function pr(e){var o;if(!Me())return;const t=((o=e.clipboardData)==null?void 0:o.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Hn(t))return;let n=[];try{n=ye(t,"Clipboard")}catch(i){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",i);return}if(!n.length)return;e.preventDefault();let r=null;n.forEach((i,s)=>{const a=ae(i,{versionLabel:n.length>1?`paste #${s+1}`:"paste"});r==null&&(r=a)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),r!=null&&F(r)}I.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&(jn(),F(n))}),document.getElementById("removeModel").onclick=()=>{if(h<0)return;if(console.log("[Blockscape] removing model:",H(g[h])),g.splice(h,1),!g.length){h=-1,C=null,p.innerHTML="",w.innerHTML="",d.value="",be(),ot();return}const e=Math.min(h,g.length-1);F(e)},document.getElementById("search").addEventListener("input",e=>{const t=e.target.value.trim().toLowerCase();console.log("[Blockscape] search:",t),p.querySelectorAll(".tile").forEach(n=>{const r=n.querySelector(".name").textContent.toLowerCase();n.style.opacity=!t||r.includes(t)?1:.2})}),W&&M&&T&&W.addEventListener("submit",async e=>{e.preventDefault();const t=M.value.trim();if(!t){alert("Please enter a URL"),M.focus();return}const n=await dt(t);if(typeof n=="number"){F(n),M.value="";const r=document.getElementById("urlHint");r&&(r.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!M||!t)return;let n=null;M.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=M.value.slice(-12);t.textContent=o?`…${o}`:""},300)})}();function ue(){if(!(h<0))try{C=Gn(g[h].data),we()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function mr(){const e=["NFR.bs","planets.bs"],t=n=>Ge?Ge.endsWith("/")?`${Ge}${n}`:`${Ge}/${n}`:n;for(const n of e)try{const r=await fetch(t(n),{cache:"no-store"});if(!r.ok){console.warn(`[Blockscape] ${n} not fetched (${r.status}); skipping`);continue}const o=await r.text(),i=n.replace(/\.[^.]+$/,"")||"Model",s=ye(o,i);if(!s.length){console.warn("[Blockscape] no models found in",n);continue}s.forEach(a=>{ae(a,{versionLabel:n})}),console.log(`[Blockscape] loaded ${s.length} model(s) from ${n}`)}catch(r){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",r)}be()}async function hr(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const r of t)try{console.log(`[Blockscape] fetching ${e} with cache="${r.cache??"default"}"`);const o=await fetch(e,r);if(o.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return await o.text()}catch(o){n=o}throw n||new Error("Unable to fetch URL")}function gr(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(r=>br(r)),e.querySelectorAll("a[href]").forEach(r=>{const o=r.getAttribute("href");Jt(o)&&Dt(r,o)})}function br(e){if(!e||!e.nodeValue||!e.nodeValue.includes("http"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,r=[];let o;for(;(o=n.exec(t))!==null;)Jt(o[0])&&r.push({url:o[0],index:o.index});if(!r.length)return;const i=document.createDocumentFragment();let s=0;r.forEach(({url:a,index:c})=>{c>s&&i.appendChild(document.createTextNode(t.slice(s,c))),i.appendChild(vr(a)),s=c+a.length}),s<t.length&&i.appendChild(document.createTextNode(t.slice(s))),e.parentNode.replaceChild(i,e)}function vr(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Dt(t,e),t}function Dt(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>yr(n,t,e)))}async function yr(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await dt(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Jt(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function dt(e){try{console.log("[Blockscape] loading from URL:",e);const t=await hr(e),r=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let o;try{o=ye(t,r)}catch(s){throw new Error(`Invalid JSON payload: ${s.message}`)}if(!o.length)throw new Error("No JSON objects found in response.");let i=null;return o.forEach((s,a)=>{var b;const c=(((b=s.data)==null?void 0:b.title)??"").toString().trim(),l=o.length>1?`${r} #${a+1}`:r,f=ae({...s,title:c||l},{versionLabel:r});i==null&&(i=f)}),console.log(`[Blockscape] loaded ${o.length} model(s) from URL:`,r),h===-1&&i!=null?F(i):be(),i}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const r=JSON.parse(n);se(r,{titleHint:r.title||"Blockscape",idHint:r.id||"blockscape"}),g.push({id:ie(),title:r.title||"Blockscape",data:r}),await mr();const o=await qn(),i=Tt(),s=i==null?void 0:i.index,a=Fn();F(typeof o=="number"?o:typeof a=="number"?a:typeof s=="number"?s:0)})()}function Hr(d){let u,p,w,v,I,y=`<script id="seed" type="application/json">${d[0]}<\/script>`,W,M,T,$,L,U;return{c(){u=je("link"),p=Ve(),w=je("div"),w.innerHTML=`<header class="pf-v5-c-page__header"><div class="pf-v5-c-masthead pf-m-display-inline blockscape-masthead"><div class="pf-v5-c-masthead__content"><div class="blockscape-toolbar"><div class="blockscape-brand"><h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/> <a href="https://github.com/pwright/blockscape" target="_blank" class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></div> <div class="blockscape-toolbar__controls"><label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <form id="urlForm" class="blockscape-url-form" autocomplete="on" novalidate=""><label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-secondary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div></form> <label class="pf-v5-c-button pf-m-secondary blockscape-file"><span>Load File(s)</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/></label> <button id="openInEditor" class="pf-v5-c-button pf-m-primary" type="button" title="Open current JSON in the editor">Edit</button> <button id="shareModel" class="pf-v5-c-button pf-m-primary" type="button" title="Copy a shareable URL for this model">Share</button></div> <div class="blockscape-legend" role="presentation"><span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span> <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span> <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span> <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span></div></div></div></div></header> <main class="pf-v5-c-page__main"><div class="blockscape-content"><aside class="blockscape-sidebar" aria-label="Models"><div class="sidebar-heading">Models</div> <ul id="modelList" class="model-nav-list"></ul> <div class="model-actions"><button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button></div></aside> <div class="blockscape-main"><section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,logo?,external?:url,color?,deps:[]}}], links?:[{from,to}] }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code> to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section></div></div></main>`,v=Ve(),I=new Cr(!1),W=Ve(),M=Kt("svg"),T=Ve(),$=je("div"),L=Ve(),U=je("div"),U.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',document.title="Blockscape — simple landscape-style tiles",V(u,"rel","icon"),V(u,"type","image/svg+xml"),V(u,"href","/favicon.svg"),V(w,"class","pf-v5-c-page"),I.a=W,V(M,"id","overlay"),V(M,"class","svg-layer"),V($,"id","tabTooltip"),V($,"class","blockscape-tab-tooltip"),$.hidden=!0,V($,"aria-hidden","true"),V(U,"id","itemPreview"),V(U,"class","item-preview"),U.hidden=!0,V(U,"aria-hidden","true")},m(B,_){Ar(document.head,u),K(B,p,_),K(B,w,_),K(B,v,_),I.m(y,B,_),K(B,W,_),K(B,M,_),K(B,T,_),K(B,$,_),K(B,L,_),K(B,U,_)},p:Ie,i:Ie,o:Ie,d(B){B&&(j(p),j(w),j(v),I.d(),j(W),j(M),j(T),j($),j(L),j(U)),j(u)}}}function Fr(d){const u=`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;return $r(()=>{Jr()}),[u]}class qr extends jr{constructor(u){super(),Vr(this,u,Fr,Hr,xr,{})}}const Gr=document.getElementById("root");new qr({target:Gr});
