var ki=Object.defineProperty;var Ai=(c,m,b)=>m in c?ki(c,m,{enumerable:!0,configurable:!0,writable:!0,value:b}):c[m]=b;var Xe=(c,m,b)=>Ai(c,typeof m!="symbol"?m+"":m,b);(function(){const m=document.createElement("link").relList;if(m&&m.supports&&m.supports("modulepreload"))return;for(const I of document.querySelectorAll('link[rel="modulepreload"]'))M(I);new MutationObserver(I=>{for(const F of I)if(F.type==="childList")for(const U of F.addedNodes)U.tagName==="LINK"&&U.rel==="modulepreload"&&M(U)}).observe(document,{childList:!0,subtree:!0});function b(I){const F={};return I.integrity&&(F.integrity=I.integrity),I.referrerPolicy&&(F.referrerPolicy=I.referrerPolicy),I.crossOrigin==="use-credentials"?F.credentials="include":I.crossOrigin==="anonymous"?F.credentials="omit":F.credentials="same-origin",F}function M(I){if(I.ep)return;I.ep=!0;const F=b(I);fetch(I.href,F)}})();function Ct(){}function Bn(c){return c()}function Nn(){return Object.create(null)}function Ht(c){c.forEach(Bn)}function Un(c){return typeof c=="function"}function Ci(c,m){return c!=c?m==m:c!==m||c&&typeof c=="object"||typeof c=="function"}function Si(c){return Object.keys(c).length===0}function Ii(c,m){c.appendChild(m)}function Ce(c,m,b){c.insertBefore(m,b||null)}function be(c){c.parentNode&&c.parentNode.removeChild(c)}function kt(c){return document.createElement(c)}function On(c){return document.createElementNS("http://www.w3.org/2000/svg",c)}function Li(c){return document.createTextNode(c)}function wt(){return Li(" ")}function ae(c,m,b){b==null?c.removeAttribute(m):c.getAttribute(m)!==b&&c.setAttribute(m,b)}function Ni(c){return Array.from(c.childNodes)}class _i{constructor(m=!1){Xe(this,"is_svg",!1);Xe(this,"e");Xe(this,"n");Xe(this,"t");Xe(this,"a");this.is_svg=m,this.e=this.n=null}c(m){this.h(m)}m(m,b,M=null){this.e||(this.is_svg?this.e=On(b.nodeName):this.e=kt(b.nodeType===11?"TEMPLATE":b.nodeName),this.t=b.tagName!=="TEMPLATE"?b:b.content,this.c(m)),this.i(M)}h(m){this.e.innerHTML=m,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(m){for(let b=0;b<this.n.length;b+=1)Ce(this.t,this.n[b],m)}p(m){this.d(),this.h(m),this.i(this.a)}d(){this.n.forEach(be)}}let Bt;function Tt(c){Bt=c}function $i(){if(!Bt)throw new Error("Function called outside component initialization");return Bt}function Ti(c){$i().$$.on_mount.push(c)}const At=[],_n=[];let St=[];const $n=[],Bi=Promise.resolve();let pn=!1;function Ui(){pn||(pn=!0,Bi.then(Mn))}function fn(c){St.push(c)}const an=new Set;let Et=0;function Mn(){if(Et!==0)return;const c=Bt;do{try{for(;Et<At.length;){const m=At[Et];Et++,Tt(m),Oi(m.$$)}}catch(m){throw At.length=0,Et=0,m}for(Tt(null),At.length=0,Et=0;_n.length;)_n.pop()();for(let m=0;m<St.length;m+=1){const b=St[m];an.has(b)||(an.add(b),b())}St.length=0}while(At.length);for(;$n.length;)$n.pop()();pn=!1,an.clear(),Tt(c)}function Oi(c){if(c.fragment!==null){c.update(),Ht(c.before_update);const m=c.dirty;c.dirty=[-1],c.fragment&&c.fragment.p(c.ctx,m),c.after_update.forEach(fn)}}function Mi(c){const m=[],b=[];St.forEach(M=>c.indexOf(M)===-1?m.push(M):b.push(M)),b.forEach(M=>M()),St=m}const Vi=new Set;function Pi(c,m){c&&c.i&&(Vi.delete(c),c.i(m))}function Ri(c,m,b){const{fragment:M,after_update:I}=c.$$;M&&M.m(m,b),fn(()=>{const F=c.$$.on_mount.map(Bn).filter(Un);c.$$.on_destroy?c.$$.on_destroy.push(...F):Ht(F),c.$$.on_mount=[]}),I.forEach(fn)}function Hi(c,m){const b=c.$$;b.fragment!==null&&(Mi(b.after_update),Ht(b.on_destroy),b.fragment&&b.fragment.d(m),b.on_destroy=b.fragment=null,b.ctx=[])}function Ji(c,m){c.$$.dirty[0]===-1&&(At.push(c),Ui(),c.$$.dirty.fill(0)),c.$$.dirty[m/31|0]|=1<<m%31}function Fi(c,m,b,M,I,F,U=null,A=[-1]){const R=Bt;Tt(c);const P=c.$$={fragment:null,ctx:[],props:F,update:Ct,not_equal:I,bound:Nn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(m.context||(R?R.$$.context:[])),callbacks:Nn(),dirty:A,skip_bound:!1,root:m.target||R.$$.root};U&&U(P.root);let Z=!1;if(P.ctx=b?b(c,m.props||{},(j,K,...ie)=>{const G=ie.length?ie[0]:K;return P.ctx&&I(P.ctx[j],P.ctx[j]=G)&&(!P.skip_bound&&P.bound[j]&&P.bound[j](G),Z&&Ji(c,j)),K}):[],P.update(),Z=!0,Ht(P.before_update),P.fragment=M?M(P.ctx):!1,m.target){if(m.hydrate){const j=Ni(m.target);P.fragment&&P.fragment.l(j),j.forEach(be)}else P.fragment&&P.fragment.c();m.intro&&Pi(c.$$.fragment),Ri(c,m.target,m.anchor),Mn()}Tt(R)}class Di{constructor(){Xe(this,"$$");Xe(this,"$$set")}$destroy(){Hi(this,1),this.$destroy=Ct}$on(m,b){if(!Un(b))return Ct;const M=this.$$.callbacks[m]||(this.$$.callbacks[m]=[]);return M.push(b),()=>{const I=M.indexOf(b);I!==-1&&M.splice(I,1)}}$set(m){this.$$set&&!Si(m)&&(this.$$.skip_bound=!0,this.$$set(m),this.$$.skip_bound=!1)}}const ji="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(ji);const Tn="blockscape:apicurioConfig",cn="http://localhost:8080/apis/registry/v3",ln="bs",dn=!1,un=!1;function qi({models:c,getActiveIndex:m,setActive:b,ensureModelMetadata:M,getModelId:I,getModelTitle:F,computeJsonFingerprint:U,uid:A}){let R=null,P=null,Z=null,j=null,K=null,ie=null,G=null,N=null,_=null,q=null;const C={baseUrl:cn,groupId:ln,authToken:"",enabled:dn,useSemver:un},Y=new Map,te=new Map;function D(r){return(r||"").toString().trim().replace(/\/+$/,"")}function z(){return!!(C.baseUrl&&C.groupId)}function ne(){return C.enabled!==!1}function ue(){Z&&(Z.value=C.baseUrl||""),j&&(j.value=C.groupId||""),K&&(K.value=C.authToken||""),ie&&(ie.checked=ne()),G&&(G.checked=!!C.useSemver)}function S(r="",u="muted"){N&&(N.textContent=r||"",N.classList.remove("is-error","is-success"),u==="error"?N.classList.add("is-error"):u==="success"&&N.classList.add("is-success"))}function pe(r){if(!q||(q.innerHTML="",!r))return;const u=document.createElement("p");u.className="apicurio-hint",u.textContent=r,q.appendChild(u)}function Se(r){Y.clear(),te.clear(),pe(r)}function ve(){const r=m(),u=ne(),p=z(),g=r>=0?c[r]:null,f=!!(g!=null&&g.apicurioVersions&&g.apicurioVersions.length>1);if(R){const y=R.dataset.loading==="true",$=u&&p&&r>=0&&!!I(c[r]);R.disabled=!u||y||!$,u?y||(R.textContent="Push to Apicurio"):R.textContent="Enable Apicurio to push"}if(_){const y=_.dataset.loading==="true",$=u&&p&&f&&!!I(g);_.disabled=!$||y,_.hidden=!f,u?y||(_.textContent="Push series"):_.textContent="Enable Apicurio to push series"}if(P){const y=P.dataset.loading==="true",$=u&&p;P.disabled=!$||y,y||(u?p?P.textContent="List artifacts":P.textContent="Enter details to list":P.textContent="Enable Apicurio to list")}}function E(){ue(),ne()?z()?(S("Apicurio push is ready when a model is selected.","muted"),Y.size||pe("Click “List artifacts” to browse the current group.")):(S("Enter Apicurio connection details to enable push.","muted"),Se("Enter registry details to browse artifacts.")):(S("Apicurio integration is off. Enable it to allow pushes.","muted"),Se("Apicurio integration is disabled.")),ve()}function v(){if(window!=null&&window.localStorage)try{localStorage.setItem(Tn,JSON.stringify(C))}catch(r){console.warn("[Blockscape] unable to persist Apicurio settings",r)}}function Ie(){let r={};if(window!=null&&window.localStorage)try{const y=localStorage.getItem(Tn);if(y){const $=JSON.parse(y);$&&typeof $=="object"&&(r=$)}}catch(y){console.warn("[Blockscape] failed to restore Apicurio settings",y)}const u=D(r.baseUrl??cn),p=(r.groupId??ln).toString().trim();let g=dn,f=un;typeof r.enabled=="boolean"?g=r.enabled:typeof r.enabled=="string"&&(g=r.enabled==="true"),typeof r.useSemver=="boolean"?f=r.useSemver:typeof r.useSemver=="string"&&(f=r.useSemver==="true"),C.baseUrl=u||cn,C.groupId=p||ln,C.authToken=(r.authToken??"").toString().trim(),C.enabled=g,C.useSemver=f,E()}function H(){const r={Accept:"application/json"},u=(C.authToken||"").trim();return u&&(r.Authorization=/\s/.test(u)?u:`Bearer ${u}`),r}function X(r,u,{title:p,description:g,version:f}={}){const y={artifactId:r,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:u}}};return f&&(y.firstVersion.version=f),p&&(y.name=p),g&&(y.description=g),y}function V(r,{version:u}={}){const p={content:{contentType:"application/json",content:r}};return u&&(p.version=u),p}function Te(r){if(r==null)return null;const u=String(r).trim();if(!u)return null;const p=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(u);if(p)return{major:Number(p[1]),minor:Number(p[2]),patch:Number(p[3])};const g=/^v?(\d+)$/.exec(u);return g?{major:Number(g[1]),minor:0,patch:0}:null}function re(r){return`${r.major}.${r.minor}.${r.patch}`}function Be(r,u){return!r&&!u?0:r?u?r.major!==u.major?r.major-u.major:r.minor!==u.minor?r.minor-u.minor:r.patch-u.patch:1:-1}function ce(r=[]){let u=null;if(r.forEach(g=>{const f=Te((g==null?void 0:g.version)??g);f&&(!u||Be(f,u)>0)&&(u=f)}),!u)return"1.0.0";const p={...u,patch:u.patch+1};return re(p)}function xe(r){return Array.isArray(r)?r:Array.isArray(r==null?void 0:r.artifacts)?r.artifacts:Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r==null?void 0:r.results)?r.results:[]}function Ze(r){return Array.isArray(r)?r:Array.isArray(r==null?void 0:r.versions)?r.versions:Array.isArray(r==null?void 0:r.items)?r.items:[]}function De(r=[]){if(!Array.isArray(r)||!r.length)return null;const u=[...r].filter(Boolean);return u.sort((p,g)=>{const f=p!=null&&p.createdOn?new Date(p.createdOn).getTime():0,y=g!=null&&g.createdOn?new Date(g.createdOn).getTime():0;if(f!==y)return y-f;const $=Number(p==null?void 0:p.version),L=Number(g==null?void 0:g.version),T=Number.isFinite($),x=Number.isFinite(L);if(T&&x&&$!==L)return L-$;const B=String((p==null?void 0:p.version)??"");return String((g==null?void 0:g.version)??"").localeCompare(B,void 0,{numeric:!0})}),u[0]||null}function fe(r){if(!r)return r;let u=r;if(!Array.isArray(r==null?void 0:r.categories)){const g=r==null?void 0:r.content;if(typeof g=="string")try{u=JSON.parse(g)}catch(f){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",f)}else g&&typeof g=="object"&&(u=g)}return u}async function de(r,u,p){const g=encodeURIComponent(u),f=encodeURIComponent(p),y=`${r}/groups/${g}/artifacts/${f}`,$=H();$.Accept="application/json";const L=await fetch(y,{method:"GET",headers:$});if(!L.ok){let T=L.statusText||"Unknown error";try{const x=await L.text();x&&(T=x.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${L.status}): ${T}`)}return L.json()}async function oe(r,u,p){const g=encodeURIComponent(u),f=encodeURIComponent(p),y=`${r}/groups/${g}/artifacts/${f}/versions?limit=50&order=desc`,$=H();$.Accept="application/json";const L=await fetch(y,{method:"GET",headers:$});if(!L.ok){let x=L.statusText||"Unknown error";try{const B=await L.text();B&&(x=B.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${L.status}): ${x}`)}const T=await L.json();return Ze(T).filter(x=>x&&x.version!=null)}async function Ue(r,u,p,g="latest"){const f=encodeURIComponent(u),y=encodeURIComponent(p),$=encodeURIComponent(g||"latest"),L=`${r}/groups/${f}/artifacts/${y}/versions/${$}/content`,T=H();T.Accept="application/json, application/*+json, */*;q=0.8";const x=await fetch(L,{method:"GET",headers:T});if(!x.ok){let le=x.statusText||"Unknown error";try{const ke=await x.text();ke&&(le=ke.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${x.status}): ${le}`)}const B=await x.text();let se=null;try{se=JSON.parse(B)}catch{throw new Error("Artifact content is not valid JSON.")}return fe(se)}async function Qe(r,u,p,g="latest"){const f=await Ue(r,u,p,g);return{data:f,fingerprint:U(f)}}async function Oe(r,u,p){try{const f=await oe(r,u,p);if(f!=null&&f.length){te.set(p,f);const y=De(f);if((y==null?void 0:y.version)!=null)return y.version}}catch(f){console.warn("[Blockscape] compare-version: unable to fetch versions list",f)}try{const f=await de(r,u,p);if((f==null?void 0:f.version)!=null)return f.version}catch(f){console.warn("[Blockscape] compare-version: unable to fetch metadata",f)}const g=te.get(p);if(g&&g.length){const f=De(g);if((f==null?void 0:f.version)!=null)return f.version}return"latest"}async function et(r,u,p,g){if(!C.useSemver)return null;if(!g)return"1.0.0";try{const f=await oe(r,u,p);return ce(f)}catch(f){throw new Error(`Unable to compute next semantic version: ${f.message}`)}}function at(r=document){R=r.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),_=r.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),P=r.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),Z=r.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),j=r.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),K=r.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),ie=r.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),G=r.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),N=r.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),q=r.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function tt(){C.baseUrl=D((Z==null?void 0:Z.value)??C.baseUrl),C.groupId=((j==null?void 0:j.value)??"").trim(),C.authToken=((K==null?void 0:K.value)??"").trim(),v(),E()}function je(){C.enabled=ie?ie.checked:dn,v(),E()}function Jt(){C.useSemver=G?G.checked:un,v(),E()}function Ft(){[Z,j,K].forEach(r=>{r&&r.addEventListener("input",tt)}),R&&R.addEventListener("click",()=>{Ot()}),_&&_.addEventListener("click",()=>{dt()}),ie&&ie.addEventListener("change",je),G&&G.addEventListener("change",Jt),P&&P.addEventListener("click",zt),q&&q.addEventListener("click",r=>{const u=r.target.closest("[data-artifact-version]");if(u){r.stopPropagation();const f=u.dataset.artifactId,y=u.dataset.artifactVersion;f&&y&&Pe(f,y);return}const p=r.target.closest("[data-artifact-load-all]");if(p){r.stopPropagation();const f=p.dataset.artifactId;f&&Kt(f);return}const g=r.target.closest("[data-artifact-trigger]");if(g){const f=g.dataset.artifactId;if(!f)return;Gt(f)}})}function Dt(){const r=document.createElement("div");return r.className="blockscape-registry-panel",r.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,r}function jt(r){if(!r)return;r.innerHTML="";const u=Dt();r.appendChild(u),at(r),Ft(),E()}function qt(r){if(!q)return;if(q.innerHTML="",!r.length){pe("No artifacts found in this group.");return}const u=document.createElement("ul");u.className="apicurio-artifact-list",r.forEach(p=>{if(!(p!=null&&p.artifactId))return;const g=document.createElement("li"),f=document.createElement("button");f.type="button",f.className="apicurio-artifact",f.dataset.artifactId=p.artifactId,f.dataset.artifactTrigger="toggle";const y=document.createElement("span");y.className="apicurio-artifact-title",y.textContent=p.artifactId,f.appendChild(y);const $=[];if(p.name&&$.push(p.name),p.version!=null&&$.push(`v${p.version}`),p.type&&$.push(p.type),$.length){const x=document.createElement("span");x.className="apicurio-artifact-meta",x.textContent=$.join(" • "),f.appendChild(x)}if(p.description){const x=document.createElement("span");x.className="apicurio-artifact-meta",x.textContent=p.description,f.appendChild(x)}g.appendChild(f);const L=document.createElement("div");L.className="apicurio-version-list",L.dataset.versionPanel=p.artifactId,L.hidden=!0;const T=document.createElement("p");T.className="apicurio-hint",T.textContent="Click above to choose a version to load.",L.appendChild(T),g.appendChild(L),u.appendChild(g)}),q.appendChild(u)}function ct(r){return q?q.querySelector(`[data-version-panel="${r}"]`):null}function nt(r,u){if(!r||(r.innerHTML="",!u))return;const p=document.createElement("p");p.className="apicurio-hint",p.textContent=u,r.appendChild(p)}function Ve(r,u){const p=ct(r);if(!p)return;if(p.innerHTML="",!u.length){nt(p,"No versions found for this artifact.");return}u.forEach(f=>{const y=document.createElement("button");y.type="button",y.className="apicurio-version-button",y.dataset.artifactId=r,y.dataset.artifactVersion=f.version;const $=[`Version ${f.version}`];if(f.createdOn){const L=new Date(f.createdOn);isNaN(L)||$.push(L.toISOString().slice(0,10))}y.textContent=$.join(" — "),p.appendChild(y)});const g=document.createElement("button");g.type="button",g.className="apicurio-version-button",g.dataset.artifactId=r,g.dataset.artifactLoadAll="true",g.textContent=`Load all (${u.length})`,p.appendChild(g)}async function Gt(r){const u=ct(r);if(!u)return;if(u.dataset.open==="true"){u.hidden=!0,u.dataset.open="false";return}if(u.hidden=!1,u.dataset.open="true",u.dataset.loaded!=="true"){if(!z()){nt(u,"Enter registry details first.");return}nt(u,"Loading versions…");try{const g=D(C.baseUrl),f=C.groupId.trim(),y=await oe(g,f,r);te.set(r,y),u.dataset.loaded="true",Ve(r,y)}catch(g){console.error("[Blockscape] failed to load versions",g),nt(u,`Unable to fetch versions: ${g.message}`)}}}function Ut(r,u){var g;const p=c.findIndex(f=>f.apicurioArtifactId===r);if(p!==-1){const f=c[p].id;c[p]={...u,id:f||u.id},((g=c[p].apicurioVersions)==null?void 0:g.length)>1&&(c[p].isSeries=!0),b(p)}else c.push(u),b(c.length-1)}async function lt(r,u,p,g){const f=encodeURIComponent(u),y=encodeURIComponent(p),$=`${r}/groups/${f}/artifacts/${y}`;try{const L=await fetch($,{method:"GET",headers:g});if(L.status===404)return!1;if(L.ok)return!0;throw L.status===401||L.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${L.status} while checking the artifact.`)}catch(L){throw L instanceof TypeError?new Error("Network error while contacting Apicurio registry."):L}}async function Ot(){var $;if(!R||R.dataset.loading==="true")return;if(!ne()){S("Apicurio integration is off. Enable it first.","error");return}if(!z()){S("Enter the registry base URL and group ID before pushing.","error");return}const r=m();if(r<0||!c[r]){S("No active model to push.","error");return}const u=I(c[r]);if(!u){S("Active model needs an id before pushing.","error");return}const p=D(C.baseUrl),g=C.groupId.trim(),f=JSON.stringify(c[r].data,null,2),y=H();R.dataset.loading="true",R.textContent="Pushing…",R.disabled=!0,S("Pushing to Apicurio…","muted");try{const L=await lt(p,g,u,y),T=U(c[r].data);if(L)try{const we=await Oe(p,g,u),{data:Le,fingerprint:Ge}=await Qe(p,g,u,we);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",we),console.log("local fingerprint",T),console.log("registry fingerprint",Ge),console.log("local payload",c[r].data),console.log("registry payload",Le),console.groupEnd(),T&&Ge&&T===Ge){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){S("Push cancelled (content matches the latest registry version).","muted");return}S("Pushing identical content by user choice.","muted")}else Ge?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):S("Unable to compare with registry content (skipping confirmation).","muted")}catch(we){console.warn("[Blockscape] unable to compare registry content before push",we),S("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const x=C.useSemver?await et(p,g,u,L):null;if(C.useSemver&&!x)throw new Error("Semantic versioning is enabled but no version could be computed.");const B=encodeURIComponent(g),se=encodeURIComponent(u),le=L?`${p}/groups/${B}/artifacts/${se}/versions`:`${p}/groups/${B}/artifacts`,ke={...y,"Content-Type":"application/json"};x&&(ke["X-Registry-Version"]=x,S(`Pushing to Apicurio as version ${x}…`,"muted"));const qe=L?V(f,{version:x}):X(u,f,{title:F(c[r]),description:($=c[r].data)==null?void 0:$.abstract,version:x}),Re=await fetch(le,{method:"POST",headers:ke,body:JSON.stringify(qe)});if(!Re.ok){let we=Re.statusText||"Unknown error";try{const Le=await Re.text();Le&&(we=Le.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${Re.status}): ${we}`)}let me=null;try{me=await Re.json()}catch{me=null}const ut=(me==null?void 0:me.version)||(me==null?void 0:me.globalId)||"",He=L?"Updated":"Created",ye=ut?` (version ${ut})`:"";S(`${He} ${u}${ye}`,"success")}catch(L){console.error("[Blockscape] Apicurio push failed",L),S(`Apicurio push failed: ${L.message}`,"error")}finally{R.dataset.loading="false",ve()}}async function dt(){var T,x;if(!_||_.dataset.loading==="true")return;if(!ne()){S("Apicurio integration is off. Enable it first.","error");return}if(!z()){S("Enter the registry base URL and group ID before pushing.","error");return}const r=m(),u=r>=0?c[r]:null;if(!u||!u.apicurioVersions||u.apicurioVersions.length<2){S("Series push requires a model with multiple versions.","error");return}const p=I(u);if(!p){S("Active series needs an id before pushing.","error");return}const g=D(C.baseUrl),f=C.groupId.trim(),y=u.apicurioVersions.map(B=>B.data),$=JSON.stringify(y,null,2),L=H();_.dataset.loading="true",_.textContent="Pushing…",_.disabled=!0,S("Pushing series to Apicurio…","muted");try{const B=await lt(g,f,p,L),se=U(y);if(B)try{const Me=await Oe(g,f,p),{data:ze,fingerprint:pt}=await Qe(g,f,p,Me);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",Me),console.log("local fingerprint",se),console.log("registry fingerprint",pt),console.log("local payload (series)",y),console.log("registry payload",ze),console.groupEnd(),se&&pt&&se===pt){if(!window.confirm("The current registry version matches this series. Push anyway?")){S("Series push cancelled (content matches latest).","muted");return}S("Pushing identical series by user choice.","muted")}else pt?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):S("Unable to compare with registry content (skipping confirmation).","muted")}catch(Me){console.warn("[Blockscape] unable to compare registry content before series push",Me),S("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const le=C.useSemver?await et(g,f,p,B):null;if(C.useSemver&&!le)throw new Error("Semantic versioning is enabled but no version could be computed.");const ke=encodeURIComponent(f),qe=encodeURIComponent(p),Re=B?`${g}/groups/${ke}/artifacts/${qe}/versions`:`${g}/groups/${ke}/artifacts`,me={...L,"Content-Type":"application/json"};le&&(me["X-Registry-Version"]=le,S(`Pushing series to Apicurio as version ${le}…`,"muted"));const ut=B?V($,{version:le}):X(p,$,{title:u.apicurioArtifactName||((T=u.data)==null?void 0:T.title)||p,description:(x=u.data)==null?void 0:x.abstract,version:le}),He=await fetch(Re,{method:"POST",headers:me,body:JSON.stringify(ut)});if(!He.ok){let Me=He.statusText||"Unknown error";try{const ze=await He.text();ze&&(Me=ze.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${He.status}): ${Me}`)}let ye=null;try{ye=await He.json()}catch{ye=null}const we=(ye==null?void 0:ye.version)||(ye==null?void 0:ye.globalId)||"",Le=B?"Updated":"Created",Ge=we?` (version ${we})`:"";S(`${Le} ${p} series${Ge}`,"success")}catch(B){console.error("[Blockscape] Apicurio series push failed",B),S(`Apicurio series push failed: ${B.message}`,"error")}finally{_.dataset.loading="false",ve()}}async function zt(){if(!P||P.dataset.loading==="true")return;if(!ne()){S("Enable Apicurio integration to list artifacts.","error");return}if(!z()){S("Enter registry base URL and group ID before listing.","error");return}const r=D(C.baseUrl),u=C.groupId.trim(),p=encodeURIComponent(u),g=`${r}/groups/${p}/artifacts?limit=50&offset=0`;P.dataset.loading="true",P.textContent="Listing…",P.disabled=!0,S("Listing artifacts…","muted"),pe("Contacting registry…");try{const f=H();f.Accept="application/json";const y=await fetch(g,{method:"GET",headers:f});if(!y.ok){let x=y.statusText||"Unknown error";try{const B=await y.text();B&&(x=B.slice(0,400))}catch{}throw new Error(`Failed to list artifacts (${y.status}): ${x}`)}const $=await y.json(),L=xe($).filter(x=>x&&x.artifactId);Y.clear(),te.clear(),L.forEach(x=>{x!=null&&x.artifactId&&Y.set(x.artifactId,x)}),qt(L);const T=L.length;S(T?`Found ${T} artifact${T===1?"":"s"}.`:"No artifacts found in this group.",T?"success":"muted")}catch(f){console.error("[Blockscape] failed to list artifacts",f),Se("Unable to list artifacts."),S(`Listing failed: ${f.message}`,"error")}finally{P.dataset.loading="false",ve()}}async function Pe(r,u=null){if(!r)return;if(!ne()){S("Enable Apicurio integration to load artifacts.","error");return}if(!z()){S("Enter registry connection details before loading artifacts.","error");return}const p=D(C.baseUrl),g=C.groupId.trim();let f=Y.get(r);const y=async()=>{try{const B=await de(p,g,r);return B!=null&&B.artifactId&&Y.set(r,B),B}catch(B){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",B),B}};if(!f)try{f=await y()}catch(B){S(`Failed to fetch artifact metadata: ${B.message}`,"error");return}const $=te.get(r)||[];let L="latest",T="latest";if(u)L=u,T=u;else{if(!f||f.version==null)try{f=await y()}catch(B){S(`Failed to fetch artifact metadata: ${B.message}`,"error");return}L=(f==null?void 0:f.version)||"latest",T=(f==null?void 0:f.version)||"latest"}const x=$.find(B=>String(B.version)===String(L));(x==null?void 0:x.version)!=null&&(T=x.version),S(`Loading artifact ${r}…`,"muted");try{const B=await Ue(p,g,r,L),se=Y.get(r)||f||{};M(B,{titleHint:se.name||r,idHint:r});const le={version:T,data:B,createdOn:(x==null?void 0:x.createdOn)||se.createdOn},ke={id:A(),title:B.title||se.name||r,data:B,apicurioArtifactId:r,apicurioArtifactName:se.name||"",apicurioVersions:[le],apicurioActiveVersionIndex:0};Ut(r,ke);const qe=T?` (version ${T})`:"";S(`Loaded artifact ${r}${qe}.`,"success")}catch(B){console.error("[Blockscape] failed to load artifact",B),S(`Failed to load artifact: ${B.message}`,"error")}}async function Kt(r){if(!r)return;if(!ne()){S("Enable Apicurio integration to load artifacts.","error");return}if(!z()){S("Enter registry connection details before loading artifacts.","error");return}const u=D(C.baseUrl),p=C.groupId.trim();let g=te.get(r);if(!g){nt(ct(r),"Loading versions…");try{g=await oe(u,p,r),te.set(r,g)}catch(T){S(`Failed to fetch versions: ${T.message}`,"error");return}}const f=(g||[]).filter(T=>T&&T.version!=null);if(!f.length){S("No versions found for this artifact.","muted");return}S(`Loading ${f.length} version(s) for ${r}…`,"muted");const y=Y.get(r)||{},$=[];try{for(const T of f){const x=T.version??"latest",B=await Ue(u,p,r,x);M(B,{titleHint:y.name||r,idHint:r}),$.push({version:x,createdOn:T.createdOn,data:B})}}catch(T){console.error("[Blockscape] failed to load one or more versions",T),S(`Failed to load all versions: ${T.message}`,"error");return}if(!$.length){S("No versions loaded from registry.","error");return}const L={id:A(),title:$[0].data.title||y.name||r,data:$[0].data,apicurioArtifactId:r,apicurioArtifactName:y.name||"",apicurioVersions:$,apicurioActiveVersionIndex:0};Ut(r,L),S(`Loaded ${$.length} version(s) for ${r}.`,"success")}return{hydrateConfig:Ie,mount:jt,updateAvailability:ve}}function xt(c,m){if(typeof c!="function")throw new Error(`[itemEditor] expected ${m} to be a function`)}function Gi(c,{excludeId:m}={}){if(!c)return[];const b=c.split(/[\s,]+/).map(I=>I.trim()).filter(Boolean),M=[];return b.forEach(I=>{m&&I===m||M.includes(I)||M.push(I)}),M}function zi(c,m,b){if(!m||!b||m===b)return;((c==null?void 0:c.categories)||[]).forEach(I=>{(I.items||[]).forEach(F=>{Array.isArray(F.deps)&&(F.deps=F.deps.map(U=>U===m?b:U))})}),Array.isArray(c==null?void 0:c.links)&&c.links.forEach(I=>{I.from===m&&(I.from=b),I.to===m&&(I.to=b)})}function Ki({findItemAndCategoryById:c,collectAllItemIds:m,updateItemReferences:b,loadActiveIntoEditor:M,rebuildFromActive:I,select:F,onSelectionRenamed:U}={}){xt(c,"findItemAndCategoryById"),xt(m,"collectAllItemIds"),xt(b,"updateItemReferences"),xt(M,"loadActiveIntoEditor"),xt(I,"rebuildFromActive"),xt(F,"select");const A={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null};function R(N){if(A.fields.errorEl){if(!N){A.fields.errorEl.hidden=!0,A.fields.errorEl.textContent="";return}A.fields.errorEl.hidden=!1,A.fields.errorEl.textContent=N}}function P(){A.wrapper&&(A.wrapper.hidden=!0,A.wrapper.setAttribute("aria-hidden","true"),R(""),A.categoryId=null,A.itemId=null,A.modelData=null,document.body.classList.remove("item-editor-open"))}function Z(){A.wrapper&&(A.wrapper.hidden=!1,A.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var N,_;(N=A.fields.nameInput)==null||N.focus(),(_=A.fields.nameInput)==null||_.select()}))}function j(N){var ue;if(!A.modelData||!A.categoryId||!A.itemId)throw new Error("No item loaded.");const q=(((ue=A.modelData)==null?void 0:ue.categories)||[]).find(S=>S.id===A.categoryId);if(!q)throw new Error("Category not found.");q.items=q.items||[];const C=q.items.find(S=>S.id===A.itemId);if(!C)throw new Error("Item not found.");const Y=(N.id||"").trim();if(!Y)throw new Error("ID is required.");const te=m(A.modelData);if(Y!==C.id&&te.has(Y))throw new Error("Another item already uses that ID.");C.id=Y;const D=(N.name||"").trim();C.name=D||C.id;const z=(N.logo||"").trim();if(z?C.logo=z:delete C.logo,N.externalFlag&&!N.external)C.external=!0;else{const S=(N.external??"").toString().trim();S?C.external=S:delete C.external}const ne=(N.color||"").trim();return ne?C.color=ne:delete C.color,C.deps=Array.isArray(N.deps)?N.deps:[],C.id!==N.originalId&&typeof U=="function"&&U(N.originalId,C.id),b(A.modelData,N.originalId,C.id),M(),I(),F(C.id),C.id}function K(){if(!A.fields||!A.fields.idInput)return!1;const N=(A.fields.idInput.value||"").trim(),_={originalId:A.itemId,id:N,name:A.fields.nameInput.value||"",logo:A.fields.logoInput.value||"",external:A.fields.externalInput.value||"",externalFlag:A.fields.externalFlagInput.checked,color:A.fields.colorInput.value||"",deps:Gi(A.fields.depsInput.value,{excludeId:N})};try{return j(_),P(),!0}catch(q){return console.warn("[itemEditor] item edit failed",q),R((q==null?void 0:q.message)||"Unable to save item."),!1}}function ie(){if(A.wrapper)return A.wrapper;const N=document.createElement("div");N.className="item-editor-modal",N.hidden=!0,N.setAttribute("role","dialog"),N.setAttribute("aria-modal","true");const _=document.createElement("div");_.className="item-editor-modal__backdrop",N.appendChild(_);const q=document.createElement("div");q.className="item-editor",N.appendChild(q);const C=document.createElement("div");C.className="item-editor__header";const Y=document.createElement("h2");Y.className="item-editor__title",Y.textContent="Edit item";const te=document.createElement("button");te.type="button",te.className="item-editor__close",te.setAttribute("aria-label","Close item editor"),te.textContent="×",C.appendChild(Y),C.appendChild(te),q.appendChild(C);const D=document.createElement("form");D.className="item-editor__form",q.appendChild(D);const z=document.createElement("div");z.className="item-editor__meta",z.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',D.appendChild(z);const ne=document.createElement("div");ne.className="item-editor__error",ne.hidden=!0,D.appendChild(ne);const ue=(xe,Ze,De)=>{const fe=document.createElement("label");fe.className="item-editor__field";const de=document.createElement("span");if(de.className="item-editor__label",de.textContent=xe,fe.appendChild(de),Ze.classList.add("item-editor__control"),fe.appendChild(Ze),De){const oe=document.createElement("div");oe.className="item-editor__hint",oe.textContent=De,fe.appendChild(oe)}return fe},S=document.createElement("input");S.type="text",S.required=!0,D.appendChild(ue("ID",S,"Unique identifier used for links and dependencies."));const pe=document.createElement("input");pe.type="text",D.appendChild(ue("Name",pe,"Visible label shown on the tile."));const Se=document.createElement("input");Se.type="url",Se.inputMode="url",Se.placeholder="https://…",D.appendChild(ue("Logo URL",Se,"Optional image URL."));const ve=document.createElement("input");ve.type="url",ve.inputMode="url",ve.placeholder="https://…",D.appendChild(ue("External link",ve,"Shown with ↗ icon and in preview."));const E=document.createElement("div");E.className="item-editor__checkbox";const v=document.createElement("label");v.className="item-editor__checkbox-row";const Ie=document.createElement("input");Ie.type="checkbox";const H=document.createElement("span");H.textContent="Mark as external without link";const X=document.createElement("div");X.className="item-editor__hint",X.textContent="Keeps dashed border even without a URL.",v.appendChild(Ie),v.appendChild(H),E.appendChild(v),E.appendChild(X),D.appendChild(E);const V=document.createElement("input");V.type="text",V.placeholder="#2563eb",D.appendChild(ue("Color",V,"Optional badge color (hex or CSS color)."));const Te=document.createElement("textarea");Te.rows=2,Te.placeholder="Comma or space separated ids",D.appendChild(ue("Dependencies",Te,"Use item IDs, separated by commas or spaces."));const re=document.createElement("div");re.className="item-editor__actions";const Be=document.createElement("button");Be.type="button",Be.className="pf-v5-c-button pf-m-tertiary",Be.textContent="Cancel";const ce=document.createElement("button");return ce.type="submit",ce.className="pf-v5-c-button pf-m-primary",ce.textContent="Save",re.appendChild(Be),re.appendChild(ce),D.appendChild(re),A.wrapper=N,A.fields={idInput:S,nameInput:pe,logoInput:Se,externalInput:ve,externalFlagInput:Ie,colorInput:V,depsInput:Te,categoryValue:z.querySelector(".item-editor__meta-value"),errorEl:ne},Be.addEventListener("click",P),te.addEventListener("click",P),_.addEventListener("click",P),D.addEventListener("submit",xe=>{xe.preventDefault(),K()}),document.addEventListener("keydown",xe=>{xe.key==="Escape"&&!N.hidden&&(xe.preventDefault(),xe.stopPropagation(),P())}),document.body.appendChild(N),N}function G(N){const _=c(N);return _?(ie(),A.categoryId=_.category.id,A.itemId=_.item.id,A.modelData=_.modelData,A.fields.categoryValue.textContent=_.category.title||_.category.id,A.fields.idInput.value=_.item.id||"",A.fields.nameInput.value=_.item.name||"",A.fields.logoInput.value=_.item.logo||"",A.fields.externalInput.value=typeof _.item.external=="string"?_.item.external:"",A.fields.externalFlagInput.checked=_.item.external===!0,A.fields.colorInput.value=_.item.color||"",A.fields.depsInput.value=Array.isArray(_.item.deps)?_.item.deps.join(", "):"",R(""),F(_.item.id),Z(),!0):!1}return{open:G,hide:P,isOpen:()=>!!A.wrapper&&!A.wrapper.hidden}}const Rt=typeof import.meta<"u"&&"./"||"";function Wi(){console.log("[Blockscape] init");const c=document.getElementById("jsonBox"),m=document.querySelector(".blockscape-json-panel"),b=document.getElementById("app"),M=document.getElementById("overlay"),I=document.getElementById("tabTooltip"),F=document.getElementById("modelList"),U=document.getElementById("itemPreview"),A=document.getElementById("urlForm"),R=document.getElementById("urlInput"),P=document.getElementById("loadUrl"),Z=U.querySelector(".item-preview__title"),j=U.querySelector(".item-preview__body"),K=U.querySelector(".item-preview__actions"),ie=U.querySelector(".item-preview__close"),G=document.getElementById("downloadJson"),N=document.getElementById("shareModel"),_=document.getElementById("createVersion"),q=document.getElementById("openInEditor"),C=document.getElementById("copyJson"),Y=document.getElementById("copySeries"),te=document.getElementById("pasteJson"),D=document.getElementById("helpButton"),z=document.getElementById("shortcutHelp"),ne=document.getElementById("shortcutHelpList"),ue=document.getElementById("shortcutHelpClose"),S=document.getElementById("shortcutHelpBackdrop"),pe="blockscape:editorPayload",Se="blockscape:editorTransfer",ve=document.title;c.value=document.getElementById("seed").textContent.trim();let E=[],v=-1;const Ie=qi({models:E,getActiveIndex:()=>v,setActive:Ne,ensureModelMetadata:Pe,getModelId:p,getModelTitle:r,computeJsonFingerprint:dt,uid:je});let H=null,X=new Map,V=null,Te=0,re={x:0,y:0},Be="map",ce=null,xe=!1,Ze=null;const De=2e3;let fe=null,de=null,oe=null,Ue=null,Qe=null,Oe=null,et="",at=!1,tt=null;Ie.hydrateConfig();function je(){return Math.random().toString(36).slice(2,10)}function Jt(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(i=>{n+=String.fromCharCode(i)}),btoa(n)}function Ft(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new TextDecoder().decode(n)}function Dt(e){return Jt(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function jt(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Ft(t)}function qt(e,t){const n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e,o.click(),URL.revokeObjectURL(i)}async function ct(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function nt(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Ve(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function Gt(e){return typeof window>"u"||typeof window.prompt!="function"?null:(window.prompt("Name this series",e)||"").trim()||null}function Ut(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return`${t} series`;const i=n.find(s=>s&&typeof s=="object")||n[0];return((i==null?void 0:i.title)??"").toString().trim()||`${t} series`}function lt(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(i=>lt(i)).join(",")}]`:`{${Object.keys(e).sort().map(i=>`${JSON.stringify(i)}:${lt(e[i])}`).join(",")}}`}function Ot(e){try{return lt(e)}catch{return""}}function dt(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=Ot(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=Ot(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const zt=[{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile."},{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Jump to the previous or next category while keeping position where possible."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Delete"]],description:"Delete the selected item (use Cmd/Ctrl+Z to undo)."},{keys:[["F2"]],description:"Open the item editor for the selected tile."},{keys:[["Escape"]],description:"Close the open preview popover."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."}];function Pe(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const i=(e.title??"").toString().trim();e.title=i||t||"Untitled Model";const o=(e.id??"").toString().trim();if(o)e.id=o;else{const s=n||e.title||t||"model",a=Ve(s).replace(/\./g,"-");e.id=a||`model-${je()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function Kt(e){return JSON.parse(JSON.stringify(e))}function r(e,t="Untitled Model"){var i;return e&&(((i=e.data)==null?void 0:i.title)??e.title??"").toString().trim()||t}function u(e,t="Untitled Model"){var i;if(((i=e==null?void 0:e.apicurioVersions)==null?void 0:i.length)>1||(e==null?void 0:e.isSeries)){const o=((e==null?void 0:e.title)??"").toString().trim()||((e==null?void 0:e.apicurioArtifactName)??"").toString().trim();if(o)return o;const s=p(e);return s?`${s} series`:t}return r(e,t)}function p(e){var i;const t=(i=e==null?void 0:e.data)==null?void 0:i.id;return t&&t.toString().trim()||null}function g(e){const t=(e??"").toString().trim();return t?t.split(/[^a-zA-Z0-9]+/).filter(Boolean)[0]||t:""}function f(e){var l;if(e<0||e>=E.length||!c)return!0;const t=E[e],n=(c.value||"").trim();if(!n)return!0;let i;try{i=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Pe(i,{titleHint:r(t),idHint:p(t)});const o=dt(t.data),s=dt(i);if(o===s)return!0;t.data=i;const a=ht(t);return a>=0&&((l=t.apicurioVersions)!=null&&l[a])&&(t.apicurioVersions[a].data=i),!0}function y(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(i=>{i!=null&&i.id&&t.add(i.id)})),t}function $(e){if(v<0||!e)return null;const t=E[v].data,n=(t==null?void 0:t.categories)||[];for(const i of n){const s=(i.items||[]).find(a=>a.id===e);if(s)return{category:i,item:s,modelData:t}}return null}function L(e,t){const n=y(t);let i=Ve(e||"item");if(!n.has(i))return i;const o=()=>je().slice(0,4);for(;n.has(i);)i=`${Ve(e||"item")}-${o()}`;return i}const T=Ki({findItemAndCategoryById:$,collectAllItemIds:y,updateItemReferences:zi,loadActiveIntoEditor:Ke,rebuildFromActive:Je,select:e=>Ee(e),onSelectionRenamed:(e,t)=>{var n;V===e&&(V=t),((n=ce==null?void 0:ce.item)==null?void 0:n.id)===e&&(ce.item.id=t)}});function x(e,{versionLabel:t,createdOn:n}={}){var l,d;const i=p(e);if(!i)return E.push(e),E.length-1;const o=E.findIndex(h=>p(h)===i);if(o===-1)return E.push(e),E.length-1;const s=E[o];(!Array.isArray(s.apicurioVersions)||!s.apicurioVersions.length)&&(s.apicurioVersions=[{version:"1",data:s.data,createdOn:(d=(l=s.apicurioVersions)==null?void 0:l[0])==null?void 0:d.createdOn}],s.apicurioActiveVersionIndex=0);const a=String(s.apicurioVersions.length+1);return s.apicurioVersions.push({version:a,data:e.data,createdOn:n||new Date().toISOString()}),s.apicurioActiveVersionIndex=s.apicurioVersions.length-1,s.data=e.data,s.title=r(e)||s.title,s.isSeries=!0,o}function B({versionLabel:e}={}){if(v<0||!E[v])throw new Error("Load or select a model before creating a version.");let t;try{t=Kt(E[v].data)}catch(i){throw console.warn("[Blockscape] failed to clone active model for versioning",i),new Error("Could not copy the current model.")}return Pe(t,{titleHint:r(E[v]),idHint:p(E[v])}),x({title:r(E[v]),data:t},{versionLabel:e||"manual",createdOn:new Date().toISOString()})}function se(){const e=v>=0&&E[v]?E[v]:null,t=p(e);document.title=t?`${t}-blockscape`:ve}function le(e){if(!e)return null;const t=e.apicurioVersions;return!Array.isArray(t)||t.length<=1?null:t.map(n=>n&&typeof n=="object"&&"data"in n?n.data:n)}function ke(){const e=E[v],t=le(e);if(!t)return null;try{return JSON.stringify(t,null,2)}catch(n){return console.warn("[Blockscape] failed to stringify series",n),null}}function qe(e="shortcut",t=!1){const n=c.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const i=E[v],o=t?le(i):null,s=!!o,a=s?JSON.stringify(o,null,2):n,l=r(i,"blockscape"),d=s?"-series":"",h=`${Ve(l)}${d}.json`;return qt(h,a),console.log(`[Blockscape] saved JSON (${e}):`,h),!0}const Re={A:"#ef4444",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#f43f5e",P:"#e11d48",Q:"#dc2626",R:"#f59e0b",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"};function me(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return Re[n]||"#9ca3af"}function ut(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(d=>d+d).join(""):t,i=parseInt(n,16),o=i>>16&255,s=i>>8&255,a=i&255;return .2126*Math.pow(o/255,2.2)+.7152*Math.pow(s/255,2.2)+.0722*Math.pow(a/255,2.2)>.35?"#111111":"#ffffff"}function He(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function ye(){if(de)return;de=document.createElement("div"),de.className="series-nav-notice";const e=document.createElement("span");e.className="series-nav-notice__dot",oe=document.createElement("span"),oe.className="series-nav-notice__text",de.appendChild(e),de.appendChild(oe),document.body.appendChild(de)}function we(){Ue&&(clearTimeout(Ue),Ue=null),de&&de.classList.remove("is-visible"),oe&&(oe.textContent="")}function Le(){fe=null,we()}function Ge(e,t){var i;if(!((i=e==null?void 0:e.apicurioVersions)!=null&&i[t]))return`version ${t+1}`;const n=e.apicurioVersions[t].version;return n?`version "${n}"`:`version ${t+1}`}function Me(e,t,n){ye(),fe={id:e,targetVersionIndex:t};const i=Ge(n,t);ze(`Click again to open ${i} in this series.`)}function ze(e,t=De,n=null){if(ye(),oe.textContent="",oe.appendChild(document.createTextNode(e)),n){const i=document.createTextNode(" "),o=document.createElement("a");o.href=n,o.target="_blank",o.rel="noopener",o.textContent=n,oe.appendChild(i),oe.appendChild(o)}de.classList.add("is-visible"),Ue&&clearTimeout(Ue),Ue=setTimeout(()=>we(),t)}function pt(){ne&&(ne.innerHTML="",zt.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((o,s)=>{if(s>0){const l=document.createElement("span");l.className="shortcut-help__or",l.textContent="or",n.appendChild(l)}const a=document.createElement("div");a.className="shortcut-help__combo",o.forEach((l,d)=>{if(d>0){const w=document.createElement("span");w.className="shortcut-help__sep",w.textContent="+",a.appendChild(w)}const h=document.createElement("kbd");h.className="shortcut-help__key",h.textContent=l,a.appendChild(h)}),n.appendChild(a)});const i=document.createElement("div");i.className="shortcut-help__desc",i.textContent=e.description,t.appendChild(n),t.appendChild(i),ne.appendChild(t)}),xe=!0)}function mn(){return!!z&&z.hidden===!1}function Vn(){if(!z)return;xe||pt(),Ze=document.activeElement,z.hidden=!1,z.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=z.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function Wt(){if(!z||z.hidden)return;z.hidden=!0,z.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=Ze;e!=null&&e.focus?e.focus({preventScroll:!0}):D!=null&&D.focus&&D.focus({preventScroll:!0})}let Yt=!1;function hn(){Yt||(Yt=!0,requestAnimationFrame(()=>{Yt=!1,Zt(),It()}))}let gn=!1;function Ne(e){if(_e(),Le(),ce=null,e<0||e>=E.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}at=!0,v=e,console.log("[Blockscape] active model:",r(E[e]),"(index",e+" )"),se(),ft(),Ke(),Je(),Ie.updateAvailability()}function ft(){if(F.innerHTML="",!E.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",F.appendChild(e);return}E.forEach((e,t)=>{var O;const n=document.createElement("li");n.className="model-nav-item";const i=document.createElement("button");i.type="button",i.className="model-nav-button"+(t===v?" is-active":""),i.dataset.index=String(t),i.setAttribute("aria-current",t===v?"true":"false");const o=document.createElement("span");o.className="model-nav-label";const s=document.createElement("span");s.className="model-nav-title",s.textContent=u(e),o.appendChild(s);const a=p(e);if(a){const J=document.createElement("span");J.className="model-nav-id",J.textContent=a,o.appendChild(J)}const l=Array.isArray((O=e.data)==null?void 0:O.categories)?e.data.categories:[],d=l.reduce((J,Q)=>J+(Q.items||[]).length,0),h=document.createElement("span");h.className="model-nav-meta";const w=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} versions`:"";h.textContent=`${l.length} cat · ${d} items${w}`,i.appendChild(o),i.appendChild(h),n.appendChild(i),F.appendChild(n)}),Ie.updateAvailability()}function Ke(){if(v<0){c.value="",Y&&(Y.disabled=!0);return}const e=E[v];c.value=JSON.stringify(e.data,null,2),Y&&(Y.disabled=!le(e))}function Pn(e){try{return JSON.parse(e)}catch{return null}}function Rn(e,t="Pasted",n={}){const i=Array.isArray(e)?e:[];if(!i.length)return[];const o=i.map((h,w)=>!h||typeof h!="object"?null:(Pe(h,{titleHint:`${t} #${w+1}`}),{obj:h,idx:w})).filter(Boolean);if(!o.length)return[];const s=o[0].obj,{seriesTitleOverride:a}=n;let l=a||s.title||`${t} series`;return a&&!s.title&&(s.title=a),[{id:je(),title:l,data:s,apicurioVersions:o.map(({obj:h,idx:w})=>({version:String(w+1),data:h})),apicurioActiveVersionIndex:0,isSeries:!0}]}function bn(e,t="Pasted",n={}){return Array.isArray(e)?Rn(e,t,n):!e||typeof e!="object"?[]:(Pe(e,{titleHint:`${t} #1`}),[{id:je(),title:e.title||`${t} #1`,data:e}])}function it(e,t="Pasted",n={}){const i=(e||"").trim();if(!i)return[];const o=Pn(i);if(o){let a=n;if(Array.isArray(o)&&n.promptForSeriesName){const d=Ut(o,t),h=Gt(d);a={...n,promptForSeriesName:!1,seriesTitleOverride:h||d}}const l=bn(o,t,a);if(l.length)return l}return i.split(/^\s*(?:---|%%%)\s*$/m).map(a=>a.trim()).filter(Boolean).map((a,l)=>{const d=JSON.parse(a);return Pe(d,{titleHint:`${t} #${l+1}`}),{id:je(),title:d.title||`${t} #${l+1}`,data:d}})}function Hn(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function mt(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!Hn(e)}function Jn(e){if(!e)return!1;const t=e.trimStart();return/^\s*(\{|\[|---|%%%)/.test(t)}function vn(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(pe)}catch(o){return console.warn("[Blockscape] failed to access editor payload",o),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(o){console.warn("[Blockscape] invalid payload JSON",o);try{localStorage.removeItem(pe)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(pe)}catch(o){console.warn("[Blockscape] failed to clear editor payload",o)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=it(t.text,t.title||"Editor Export")}catch(o){return console.warn("[Blockscape] could not parse payload text",o),null}if(!n.length)return null;let i=null;return n.forEach(o=>{const s=x(o,{versionLabel:"editor"});i==null&&(i=s)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:i,count:n.length}}function yn(e="storage"){const t=vn();return!t||typeof t.index!="number"?!1:(Ne(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Fn(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const a=new URLSearchParams(window.location.search);a.has("share")&&(t=a.get("share"))}if(!t)return null;let i;try{const a=jt(t);i=JSON.parse(a)}catch(a){return console.warn("[Blockscape] failed to decode share token",a),null}if(!i||typeof i!="object"||i.data==null)return console.warn("[Blockscape] share payload missing data"),null;const o=bn(i.data,i.title||"Shared Model");if(!o.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let s=null;return o.forEach(a=>{const l=a.isSeries?i.title||a.title:null,d=x({...a,apicurioArtifactName:l||a.apicurioArtifactName},{versionLabel:"shared"});s==null&&(s=d)}),s}async function Dn(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const i=new URLSearchParams(window.location.search);i.has("load")&&(t=i.get("load"))}if(!t)return null;try{const i=await nn(t);return typeof i=="number"?i:null}catch(i){return console.warn("[Blockscape] load param failed",i),null}}function jn(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,i=new Set;(e.categories||[]).forEach(s=>(s.items||[]).forEach(a=>{i.add(a.id);const l=new Set(a.deps||[]);(e.links||[]).forEach(d=>{d.from===a.id&&l.add(d.to)}),t.set(a.id,l),l.forEach(d=>{n.has(d)||n.set(d,new Set),n.get(d).add(a.id)})}));const o=new Set;return n.forEach((s,a)=>{((s==null?void 0:s.size)||0)>=2&&o.add(a)}),{m:e,fwd:t,rev:n,reusedLocal:o,seen:i}}function qn(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),i=44;n.width=i,n.height=i;const o=n.getContext("2d"),s=(e||"?").charAt(0).toUpperCase(),a=me(e,t),l=ut(a);return o.fillStyle=a,o.beginPath(),o.arc(i/2,i/2,i/2-2,0,2*Math.PI),o.fill(),o.strokeStyle="rgba(0,0,0,0.15)",o.lineWidth=1,o.stroke(),o.fillStyle=l,o.font=`bold ${i*.5}px system-ui, -apple-system, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(s,i/2,i/2),n.toDataURL("image/png")}function ht(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function wn(e){const t=ht(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function Gn(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,i)=>{var s;const o=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();o&&t.set(o,i)}),t}const En=new WeakMap;function zn(e,t){var Fe;if(!((Fe=e==null?void 0:e.apicurioVersions)!=null&&Fe[t]))return null;const n=e.apicurioVersions[t],i=n.data,o=dt(i),s=En.get(n);if(s&&s.fingerprint===o)return s.dataUrl;const a=160,l=90,d=document.createElement("canvas");d.width=a,d.height=l;const h=d.getContext("2d");h.fillStyle="#f8fafc",h.fillRect(0,0,a,l),h.strokeStyle="#e5e7eb",h.strokeRect(.5,.5,a-1,l-1);const w=Array.isArray(i==null?void 0:i.categories)?i.categories:[],O=Math.max(w.length,1),J=a/O,Q=8,Ae=8,$e=4;w.forEach((Mt,Nt)=>{const vt=Nt*J+J/2,ot=Array.isArray(Mt.items)?Mt.items:[],Vt=Math.max(ot.length,1);ot.forEach((yt,k)=>{const W=Q+(k+.5)*((l-Q-Ae)/Vt);h.beginPath(),h.arc(vt,W,$e,0,Math.PI*2);const ee=me(yt.name||yt.id||"",yt.color);h.fillStyle=ee,h.strokeStyle="rgba(15,23,42,0.25)",h.fill(),h.stroke()})});const rt=d.toDataURL("image/png");return En.set(n,{fingerprint:o,dataUrl:rt}),rt}function Xt(e,t){var l;if(Le(),e<0||e>=E.length)return!1;const n=E[e];if(!((l=n==null?void 0:n.apicurioVersions)!=null&&l.length)||!f(e))return!1;const o=n.apicurioVersions.length,s=(t%o+o)%o,a=n.apicurioVersions[s];return a!=null&&a.data?(n.apicurioActiveVersionIndex=s,n.data=a.data,at=!0,V=null,Ke(),Je(),!0):!1}function xn(e){var i;if(!e||v<0)return;const t=E[v];if(!((i=t==null?void 0:t.apicurioVersions)!=null&&i.length))return;const n=ht(t);n!==-1&&Xt(v,n+e)}function Kn(e){if(!(e!=null&&e.apicurioVersions)||e.apicurioVersions.length<=1)return null;const t=document.createElement("div");t.className="version-nav";const n=document.createElement("div");n.className="version-nav__title",n.textContent=e.apicurioArtifactName||e.apicurioArtifactId||p(e)||"Artifact",t.appendChild(n);const i=document.createElement("div");i.className="version-nav__status";const o=ht(e),s=wn(e)||"latest";i.textContent=`No. in series ${s} (${o+1} of ${e.apicurioVersions.length})`,t.appendChild(i);const a=document.createElement("div");a.className="version-nav__controls";const l=document.createElement("button");l.type="button",l.className="version-nav__button",l.textContent="Previous",l.addEventListener("click",()=>xn(-1));const d=document.createElement("button");d.type="button",d.className="version-nav__button",d.textContent="Next",d.addEventListener("click",()=>xn(1)),a.appendChild(l),a.appendChild(d),t.appendChild(a);const h=document.createElement("div");return h.className="version-nav__thumbs",e.apicurioVersions.forEach((w,O)=>{var rt;const J=document.createElement("button");J.type="button",J.className="version-nav__thumb",O===o&&J.classList.add("is-active");const Q=zn(e,O);if(Q){const Fe=document.createElement("img");Fe.src=Q,Fe.alt=`Version ${O+1}`,J.appendChild(Fe)}const Ae=document.createElement("div");Ae.className="version-nav__thumb-label";const $e=g(((rt=w==null?void 0:w.data)==null?void 0:rt.id)||(w==null?void 0:w.id)||"");Ae.textContent=$e||(w!=null&&w.version?`v${w.version}`:`${O+1}`),J.appendChild(Ae),J.addEventListener("click",()=>Xt(v,O)),h.appendChild(J)}),t.appendChild(h),t}function gt(){var yt;if(!H)return;We(),Array.isArray(H.m.categories)||(H.m.categories=[]),console.log("[Blockscape] rendering categories=",H.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!H.m.abstract,"- value:",H.m.abstract?H.m.abstract.substring(0,50)+"...":"none"),b.innerHTML="",X.clear();const e=Kn(E[v]);e&&b.appendChild(e),M.setAttribute("width",window.innerWidth),M.setAttribute("height",window.innerHeight);const t=document.createElement("div");t.className="blockscape-model-meta";const n=document.createElement("div");n.className="blockscape-model-title",n.textContent=H.m.title&&H.m.title.trim()||r(E[v]),t.appendChild(n);const i=wn(E[v]),o=(H.m.id??"").toString().trim();if(o){const k=document.createElement("div");k.className="blockscape-model-id",k.textContent=`ID: ${o}`,t.appendChild(k)}if(i){const k=document.createElement("div");k.className="blockscape-model-id",k.textContent=`No. in series: ${i}`,t.appendChild(k)}b.appendChild(t);const s=document.createElement("div");s.className="blockscape-tabs";const a=document.createElement("div");a.className="blockscape-tablist",a.setAttribute("role","tablist"),s.appendChild(a);const l=document.createElement("div");l.className="blockscape-tabpanels",s.appendChild(l);const d=document.createElement("div"),h=document.createElement("div"),w=document.createElement("div"),O=document.createElement("div");let J="";const Q=Gn(E[v]),Ae=ht(E[v]);Oe=null,et="";const $e=[{id:"map",label:"Map",panel:d},{id:"abstract",label:"Info",panel:h},{id:"source",label:"Source",panel:w},{id:"apicurio",label:"Apicurio",panel:O}],rt=k=>{if(!M)return;const W=k==="map";M.hidden=!W,W?(Zt(),It()):M.innerHTML=""};$e.forEach((k,W)=>{const ee=document.createElement("button");ee.type="button",ee.id=`tab-${k.id}`,ee.className="blockscape-tab"+(W===0?" is-active":""),ee.setAttribute("role","tab"),ee.setAttribute("aria-controls",`panel-${k.id}`),ee.setAttribute("aria-selected",W===0?"true":"false"),ee.textContent=k.label,k.button=ee,a.appendChild(ee),k.panel.id=`panel-${k.id}`,k.panel.classList.add("blockscape-tabpanel"),k.panel.setAttribute("role","tabpanel"),k.panel.setAttribute("aria-labelledby",ee.id),k.panel.hidden=W!==0,W===0&&k.panel.classList.add("is-active"),l.appendChild(k.panel)});const Fe=k=>{Be=k,$e.forEach(W=>{const ee=W.id===k;W.button.classList.toggle("is-active",ee),W.button.setAttribute("aria-selected",ee?"true":"false"),W.panel.classList.toggle("is-active",ee),W.panel.hidden=!ee}),rt(k)};$e.forEach(k=>{k.button.addEventListener("click",()=>{We(),Fe(k.id)}),k.id==="abstract"&&(Oe=k.button,k.button.addEventListener("mouseenter",()=>tn(k.button,J,{offset:12})),k.button.addEventListener("mouseleave",We),k.button.addEventListener("focus",()=>tn(k.button,J,{offset:12})),k.button.addEventListener("blur",We))});const Mt=((yt=$e.find(k=>k.id===Be))==null?void 0:yt.id)||$e[0].id;Fe(Mt),b.appendChild(s);const Nt=document.createElement("div");Nt.className="blockscape-render",d.appendChild(Nt);const vt=document.createElement("div");if(vt.className="blockscape-abstract-panel",H.m.abstract){console.log("[Blockscape] Rendering abstract content");const k=document.createElement("div");k.className="blockscape-abstract",k.innerHTML=H.m.abstract,vi(k),vt.appendChild(k),J=k.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const k=document.createElement("div");k.className="blockscape-abstract-placeholder",k.textContent="No abstract has been provided for this model.",vt.appendChild(k),J=k.outerHTML}et=J,h.appendChild(vt);const ot=document.createElement("div");if(ot.className="blockscape-source-panel",m)m.hidden=!1,m.classList.remove("pf-v5-c-page__main-section"),ot.appendChild(m);else{const k=document.createElement("p");k.className="muted",k.textContent="Source editor unavailable.",ot.appendChild(k)}w.appendChild(ot),Ie.mount(O);let Vt=0;H.m.categories.forEach(k=>{const W=document.createElement("section");W.className="category",W.dataset.cat=k.id;const ee=document.createElement("div");ee.className="cat-head",ee.innerHTML=`<div class="cat-title">${en(k.title||k.id)}</div>
                          <div class="muted cat-count">${(k.items||[]).length} items</div>`,W.appendChild(ee);const Pt=document.createElement("div");Pt.className="grid",W.appendChild(Pt),(k.items||[]).forEach(he=>{Vt+=1;const $t=Yn(he.external),ge=document.createElement("div");if(ge.className=$t.isExternal?"tile external":"tile",ge.tabIndex=0,ge.dataset.id=he.id,ge.dataset.globalIndex=String(Vt),$t.url&&(ge.dataset.externalUrl=$t.url),Q.has(he.id)){const sn=Q.get(he.id);ge.dataset.seriesVersionIndex=String(sn),ge.classList.add("tile--series-link");const xi=sn===Ae?"Current map in this series":`Open version ${sn+1} in this series`;ge.title=xi}const st=document.createElement("img");st.className="logo",he.logo?(st.src=he.logo,st.alt=he.name||he.id):(st.alt="",st.style.opacity=1,st.src=qn(he.name||he.id,he.color));const rn=document.createElement("div");rn.className="name",rn.textContent=he.name||he.id;const on=document.createElement("div");on.className="badge",on.textContent="reused",$t.url&&ge.appendChild(Xn($t.url)),ge.appendChild(st),ge.appendChild(rn),ge.appendChild(on),Pt.appendChild(ge),X.set(he.id,{el:ge,catId:k.id,rect:null})}),Nt.appendChild(W);const _t=document.createElement("button");_t.type="button",_t.className="tile-add",_t.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',_t.addEventListener("click",()=>ci(k.id)),Pt.appendChild(_t)}),H.reusedLocal.forEach(k=>{const W=X.get(k);W&&(W.el.classList.add("reused"),W.el.querySelector(".badge").style.display="inline-block")}),Wn(),Zt(),It(),Zn()}function Wn(){b.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",t=>{var h;if(typeof t.button=="number"&&t.button!==0)return;_e();const n=e.dataset.id,i=e.dataset.seriesVersionIndex!=null?parseInt(e.dataset.seriesVersionIndex,10):null,o=e.dataset.globalIndex!=null?parseInt(e.dataset.globalIndex,10):null,s=E[v],a=s?ht(s):-1,l=((h=s==null?void 0:s.apicurioVersions)==null?void 0:h.length)>1&&Number.isInteger(i)&&i!==a,d=fe&&fe.id===n&&fe.targetVersionIndex===i;if(fe&&!d&&Le(),l)if(d){if(Le(),Xt(v,i))return}else Me(n,i,s);else Number.isInteger(o)&&o>0&&o%5===0&&ze("Use arrow keys to move between blocks. Shift arrow to move block.");if(console.log("[Blockscape] click",n),V===n&&!(l&&d)){Qt();return}Ee(n)}),e.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),e.click())}),e.draggable=!0,e.addEventListener("dragstart",ni),e.addEventListener("dragend",ii)}),b.querySelectorAll(".grid").forEach(e=>{e.addEventListener("dragover",ri),e.addEventListener("drop",ai),e.addEventListener("dragenter",oi),e.addEventListener("dragleave",si)}),gn||(gn=!0,window.addEventListener("resize",hn),window.addEventListener("scroll",hn,{passive:!0})),document.getElementById("clear").onclick=()=>Qt()}function Zt(){X.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function Ee(e){var s,a,l;V=e,kn();const t=Array.from(H.fwd.get(e)||[]),n=Array.from(H.rev.get(e)||[]);console.log("[Blockscape] selecting id=",e,"deps=",t,"revs=",n);const i=X.get(e);i&&i.el.classList.add("selected"),t.forEach(d=>{const h=X.get(d);h&&h.el.classList.add("dep")}),n.forEach(d=>{const h=X.get(d);h&&h.el.classList.add("revdep")}),It();const o=(l=(a=(s=X.get(e))==null?void 0:s.el)==null?void 0:a.dataset)==null?void 0:l.externalUrl;o&&ze("This item has link to",De,o)}function Qt(){V=null,kn(),It()}function kn(){b.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","selected"))}function It(){var n;for(;M.firstChild;)M.removeChild(M.firstChild);if(!V||M.hidden)return;const e=(n=X.get(V))==null?void 0:n.rect;if(!e)return;new Set([...H.fwd.get(V)||[],...H.rev.get(V)||[]]).forEach(i=>{const o=X.get(i);if(!o||!o.rect)return;const s=An(e),a=An(o.rect),l=document.createElementNS("http://www.w3.org/2000/svg","path"),d=(s.x+a.x)/2,h=s.y,w=(s.x+a.x)/2,O=a.y,J=(H.fwd.get(V)||new Set).has(i);l.setAttribute("d",`M ${s.x},${s.y} C ${d},${h} ${w},${O} ${a.x},${a.y}`),l.setAttribute("fill","none"),l.setAttribute("stroke",J?"var(--blockscape-dep)":"var(--blockscape-revdep)"),l.setAttribute("stroke-opacity","0.45"),l.setAttribute("stroke-width","2"),l.setAttribute("vector-effect","non-scaling-stroke"),M.appendChild(l)})}function An(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function en(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Yn(e){if(typeof e=="string"){const t=e.trim();if(!t)return{isExternal:!1,url:""};try{const n=new URL(t);return/^https?:/i.test(n.protocol)?{isExternal:!0,url:n.toString()}:{isExternal:!1,url:""}}catch(n){return console.warn("[Blockscape] invalid external url skipped",e,n),{isExternal:!1,url:""}}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Xn(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function tn(e,t,{offset:n=8}={}){!I||!e||!t||(I.innerHTML=t,I.hidden=!1,I.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const i=e.getBoundingClientRect(),o=I.getBoundingClientRect(),s=window.scrollX||document.documentElement.scrollLeft,a=window.scrollY||document.documentElement.scrollTop;let l=i.left+i.width/2-o.width/2+s,d=i.top-o.height-n+a;l<s+n&&(l=s+n);const h=s+window.innerWidth-o.width-n;l>h&&(l=h),d<a+n&&(d=i.bottom+n+a),I.style.left=`${l}px`,I.style.top=`${d}px`,I.classList.add("is-visible")}))}function We(){Qe&&(clearTimeout(Qe),Qe=null),I&&(I.classList.remove("is-visible"),I.setAttribute("aria-hidden","true"),I.hidden=!0)}function Zn(){at&&(at=!1,!(!Oe||!et)&&(We(),tn(Oe,et,{offset:12}),Qe=setTimeout(()=>{We(),Qn()},1e3)))}function Qn(){Oe&&(tt&&(clearTimeout(tt),tt=null),Oe.classList.add("blockscape-tab--twinkle"),tt=setTimeout(()=>{Oe.classList.remove("blockscape-tab--twinkle"),tt=null},1400))}window.addEventListener("scroll",We,!0),window.addEventListener("resize",We);function _e(){U&&(U.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),U.setAttribute("aria-hidden","true"),U.hidden=!0,Cn([]))}function ei(e,t){U&&(re={x:e,y:t},U.hidden=!1,U.setAttribute("aria-hidden","false"),U.classList.add("is-visible"),bt(e,t))}function bt(e,t){if(!U)return;const n=12;U.style.left=`${e+n}px`,U.style.top=`${t+n}px`;const i=U.getBoundingClientRect();let o=i.left,s=i.top;i.right>window.innerWidth-n&&(o=Math.max(n,window.innerWidth-i.width-n)),i.bottom>window.innerHeight-n&&(s=Math.max(n,window.innerHeight-i.height-n)),U.style.left=`${o}px`,U.style.top=`${s}px`}function Cn(e=[]){K&&(K.innerHTML="",e.forEach(t=>{const n=document.createElement("button");n.type="button",n.className="item-preview__action",n.textContent=t.label||"Action",t.title&&(n.title=t.title),n.addEventListener("click",i=>{i.stopPropagation(),typeof t.onClick=="function"&&t.onClick(i)}),K.appendChild(n)}),K.hidden=e.length===0)}async function ti(e,t){var h;if(!U)return;e.stopPropagation(),e.preventDefault();const n=t.dataset.id,i=((h=t.querySelector(".name"))==null?void 0:h.textContent)||n||"Preview",o=n?`${n}.html`:"",s=o?`items/${o}`:"",a=++Te,l=t.dataset.externalUrl||"",d=[{label:"Edit",title:"Edit this item",onClick:()=>{_e(),T.open(n)}}];if(l&&d.push({label:"Open link ↗",title:l,onClick:()=>window.open(l,"_blank","noopener")}),Cn(d),n&&Ee(n),Z.textContent=i,j.innerHTML='<div class="item-preview__status">Loading…</div>',U.classList.remove("item-preview--has-frame"),U.classList.add("item-preview--expanded"),ei(e.clientX,e.clientY),!s){j.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',bt(re.x,re.y);return}try{const w=await fetch(s,{cache:"no-cache"});if(!w.ok)throw new Error(`HTTP ${w.status}`);const O=await w.text();if(a!==Te)return;if(!O.trim()){j.innerHTML=`<div class="item-preview__status">No content in <code>${en(o)}</code>.</div>`,bt(re.x,re.y);return}const Q=document.createElement("iframe");Q.className="item-preview__frame",Q.title=`${i} details`,Q.srcdoc=O,j.innerHTML="",j.appendChild(Q),U.classList.add("item-preview--has-frame"),bt(re.x,re.y)}catch(w){if(a!==Te)return;j.innerHTML=`<div class="item-preview__status">No preview available for <strong>${en(i)}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${s}`,w),bt(re.x,re.y)}}ie&&ie.addEventListener("click",_e),D&&D.addEventListener("click",()=>{Vn()}),ue&&ue.addEventListener("click",Wt),S&&S.addEventListener("click",Wt),b&&b.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");!t||!b.contains(t)||ti(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||!U||U.hidden||U.contains(e.target)||_e()}),G&&G.addEventListener("click",()=>{qe("button")}),_&&_.addEventListener("click",()=>{if(v<0){alert("Load or select a model before creating a version.");return}try{const e=B({versionLabel:"map edit"});Ne(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),N&&N.addEventListener("click",async()=>{var s;if(v<0||!E[v]){alert("Select or load a model before sharing.");return}const e={title:r(E[v],"Shared Model"),data:E[v].data};let t;try{t=Dt(JSON.stringify(e))}catch(a){console.error("[Blockscape] share encode failed",a),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const i=n.toString();try{window.history.replaceState({},document.title,i)}catch(a){console.warn("[Blockscape] failed to update URL for share",a),window.location.hash=n.hash}let o=!1;if((s=navigator.clipboard)!=null&&s.writeText)try{await navigator.clipboard.writeText(i),o=!0}catch(a){console.warn("[Blockscape] clipboard write failed",a)}o?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",i)}),q&&q.addEventListener("click",()=>{const e=(c.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};V&&(n.selectedItemId=V),localStorage.setItem(pe,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";V&&(t=`editor.html?selected=${encodeURIComponent(V)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==pe||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||yn("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===Se&&yn("message")})),document.addEventListener("keydown",e=>{var n,i,o,s,a,l;if(mn()){e.key==="Escape"&&(e.preventDefault(),Wt());return}if(!((n=T==null?void 0:T.isOpen)!=null&&n.call(T))){if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const d=E[v],h=((i=d==null?void 0:d.apicurioVersions)==null?void 0:i.length)>1;qe("shortcut",h);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!mt())return;if(fi()){e.preventDefault();return}}if(e.key==="Escape"&&U&&!U.hidden&&_e(),e.key==="ArrowLeft"||e.key==="ArrowRight"){if(!mt()||e.altKey||e.ctrlKey||e.metaKey)return;const d=e.key==="ArrowLeft"?-1:1;e.shiftKey?li(d)&&e.preventDefault():di(d)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(!mt()||e.altKey||e.ctrlKey||e.metaKey)return;const d=e.key==="ArrowUp"?-1:1;e.shiftKey?pi(d)&&e.preventDefault():ui(d)&&e.preventDefault()}if(e.key==="Delete"){if(!mt()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;mi()&&e.preventDefault()}if(e.key==="F2"){if(!mt())return;const d=V||((l=(a=(s=(o=e.target)==null?void 0:o.closest)==null?void 0:s.call(o,".tile"))==null?void 0:a.dataset)==null?void 0:l.id);d&&T.open(d)&&e.preventDefault()}}}),window.addEventListener("resize",()=>{!U||U.hidden||bt(re.x,re.y)}),window.addEventListener("scroll",()=>{!U||U.hidden||_e()},!0);let Ye=null,Lt=null;function ni(e){_e(),Ye=e.target.dataset.id,Lt=e.target.closest(".category").dataset.cat,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({itemId:Ye,categoryId:Lt})),e.target.closest(".category").querySelector(".grid").classList.add("drag-active"),console.log("[Blockscape] drag start",Ye,"from",Lt)}function ii(e){e.target.classList.remove("dragging"),b.querySelectorAll(".grid").forEach(t=>t.classList.remove("drag-active")),b.querySelectorAll(".tile").forEach(t=>t.classList.remove("drag-over")),Ye=null,Lt=null}function ri(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function oi(e){e.preventDefault();const t=e.target.closest(".grid");t&&t.classList.add("drag-active")}function si(e){const t=e.target.closest(".grid");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-active")}function ai(e){e.preventDefault();const t=e.target.closest(".grid");if(!t)return;const n=t.closest(".category");if(!n)return;const i=n.dataset.cat;if(!Ye||!i)return;const s=Array.from(t.querySelectorAll(".tile")).filter(a=>a.dataset.id!==Ye).find(a=>{const l=a.getBoundingClientRect();return e.clientY<l.top+l.height/2});Sn(Ye,s?s.dataset.id:null,i),gt(),console.log("[Blockscape] drop completed",Ye,"from",Lt,"to",i)}function Sn(e,t,n){if(v<0)return;const o=E[v].data.categories||[],s=o.find(w=>(w.items||[]).some(O=>O.id===e)),a=o.find(w=>w.id===n);if(!s||!a)return;s.items=s.items||[],a.items=a.items||[];const l=s.items.findIndex(w=>w.id===e);if(l===-1)return;const[d]=s.items.splice(l,1);let h=a.items.length;if(t){const w=a.items.findIndex(O=>O.id===t);w!==-1&&(h=w)}a.items.splice(h,0,d),Ke(),Je()}function ci(e){if(v<0||!e)return;const t=E[v].data,i=(t.categories||[]).find(d=>d.id===e);if(!i)return;i.items=i.items||[];const o=`New item ${i.items.length+1}`,a={id:L(`${e}-${i.items.length+1}`,t),name:o,deps:[]};i.items.push(a),Ke(),Je(),_e(),Ee(a.id);const l=X.get(a.id);l!=null&&l.el&&l.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",a.id,"to",e)}function li(e){if(!V||v<0||!e)return!1;const n=E[v].data.categories||[],i=X.get(V);let o=null;if(i!=null&&i.catId&&(o=n.find(d=>d.id===i.catId)),o||(o=n.find(d=>(d.items||[]).some(h=>h.id===V))),!o)return!1;o.items=o.items||[];const s=o.items.findIndex(d=>d.id===V);if(s===-1)return!1;const a=s+e;if(a<0||a>=o.items.length)return!1;const[l]=o.items.splice(s,1);return o.items.splice(a,0,l),Ke(),Je(),gt(),Ee(V),!0}function di(e){if(!H||!H.m||!e)return!1;const t=H.m.categories||[];if(!t.length)return!1;const n=()=>{const d=t.find(h=>(h.items||[]).length);return d?{category:d,item:d.items[0]}:null};if(!V){const d=n();return d?(Ee(d.item.id),!0):!1}const i=X.get(V);let o=null;if(i!=null&&i.catId&&(o=t.find(d=>d.id===i.catId)),o||(o=t.find(d=>(d.items||[]).some(h=>h.id===V))),!o){const d=n();return d?(Ee(d.item.id),!0):!1}const s=o.items||[];if(!s.length)return!1;const a=s.findIndex(d=>d.id===V);if(a===-1)return!1;const l=a+e;return l<0||l>=s.length?!1:(Ee(s[l].id),!0)}function ui(e){if(!H||!H.m||!e)return!1;const t=H.m.categories||[];if(!t.length)return!1;const n=()=>{for(const d of t)if(d.items&&d.items.length)return d.items[0].id;return null};let o=(()=>{if(!V)return-1;const d=X.get(V);if(d!=null&&d.catId){const h=t.findIndex(w=>w.id===d.catId);if(h!==-1)return h}return t.findIndex(h=>(h.items||[]).some(w=>w.id===V))})();if(o===-1){const d=n();return d?(Ee(d),!0):!1}let a=(t[o].items||[]).findIndex(d=>d.id===V);a===-1&&(a=0);let l=o+e;for(;l>=0&&l<t.length;){const h=t[l].items||[];if(h.length){const w=Math.min(h.length-1,Math.max(0,a));return Ee(h[w].id),!0}l+=e>0?1:-1}return!1}function pi(e){if(!V||v<0||!e)return!1;const n=E[v].data.categories||[];if(!n.length)return!1;const i=X.get(V);let o=-1;if(i!=null&&i.catId&&(o=n.findIndex(O=>O.id===i.catId)),o===-1&&(o=n.findIndex(O=>(O.items||[]).some(J=>J.id===V))),o===-1)return!1;const s=o+e;if(s<0||s>=n.length)return!1;const a=n[o],l=n[s];if(!l)return!1;a.items=a.items||[],l.items=l.items||[];const d=a.items.findIndex(O=>O.id===V);if(d===-1)return!1;const h=Math.min(l.items.length,Math.max(0,d)),w=h<l.items.length?l.items[h].id:null;return Sn(V,w,l.id),gt(),Ee(V),!0}function fi(){if(!ce||v<0)return!1;const e=E[v];if(!e||e.id!==ce.modelId)return!1;const t=ce,o=(e.data.categories||[]).find(a=>a.id===t.categoryId);if(!o)return!1;o.items=o.items||[];const s=Math.min(Math.max(t.index,0),o.items.length);return o.items.splice(s,0,t.item),ce=null,_e(),V=null,Ke(),Je(),gt(),Ee(t.item.id),console.log("[Blockscape] undo delete restored",t.item.id),!0}function mi(){if(!V||v<0)return!1;const t=E[v].data.categories||[];if(!t.length)return!1;const n=X.get(V);let i=null;if(n!=null&&n.catId&&(i=t.find(h=>h.id===n.catId)),i||(i=t.find(h=>(h.items||[]).some(w=>w.id===V))),!i||!Array.isArray(i.items))return!1;const o=i.items.findIndex(h=>h.id===V);if(o===-1)return!1;const s=i.items.splice(o,1)[0];if(!s)return!1;const a=E[v];ce={item:s,categoryId:i.id,index:o,modelId:a?a.id:null};const d=(()=>{var w;if(i.items.length){const O=Math.min(o,i.items.length-1);return((w=i.items[O])==null?void 0:w.id)||null}const h=t.findIndex(O=>O.id===i.id);if(h===-1)return null;for(let O=h+1;O<t.length;O++){const J=t[O].items||[];if(J.length)return J[0].id}for(let O=h-1;O>=0;O--){const J=t[O].items||[];if(J.length)return J[0].id}return null})();return _e(),V=null,Ke(),Je(),gt(),d?Ee(d):Qt(),console.log("[Blockscape] removed item",s.id),!0}C&&C.addEventListener("click",async()=>{const e=c.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await ct(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),Y&&Y.addEventListener("click",async()=>{const e=ke();if(!e){alert("No series available to copy. Create another version first.");return}await ct(e)?alert("Series JSON copied to clipboard."):window.prompt("Copy this series JSON manually:",e)}),te&&te.addEventListener("click",async()=>{try{const e=await nt();if(!e){alert("Clipboard is empty.");return}c.value=e,c.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=()=>{try{const e=it(c.value,"Pasted",{promptForSeriesName:!0});if(!e.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",e.length,"model(s)");let t=null;e.forEach((n,i)=>{const o=x(n,{versionLabel:e.length>1?`paste #${i+1}`:"paste"});t==null&&(t=o)}),v===-1&&t!=null?Ne(t):ft()}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{if(v<0){alert("No active model selected.");return}try{const e=JSON.parse(c.value);Pe(e,{titleHint:r(E[v]),idHint:p(E[v])||r(E[v])}),E[v].data=e,E[v].title=e.title||E[v].title,se(),console.log("[Blockscape] replaced active model:",r(E[v])),Je(),Ie.updateAvailability()}catch(e){console.error("[Blockscape] replace error:",e),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const i of t){const o=await i.text(),s=i.name.replace(/\.[^.]+$/,"")||"File",a=it(o,s);if(!a.length){console.warn("[Blockscape] no models in file:",i.name);continue}a.forEach((l,d)=>{var Q;const h=(((Q=l.data)==null?void 0:Q.title)??"").toString().trim(),w=a.length>1?`${i.name} #${d+1}`:i.name,O=l.isSeries?s:null;if(l.isSeries){const Ae=Ve(s)||s;l.data.title=h||O||l.data.title||w,l.data.id=Ae,l.title=l.data.title}const J=x({...l,title:h||w,apicurioArtifactName:O||l.apicurioArtifactName},{versionLabel:i.name});n==null&&(n=J)})}v===-1&&n!=null?Ne(n):ft()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",hi);function hi(e){var o;if(!mt())return;const t=((o=e.clipboardData)==null?void 0:o.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!Jn(t))return;let n=[];try{n=it(t,"Clipboard",{promptForSeriesName:!0})}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let i=null;n.forEach((s,a)=>{const l=x(s,{versionLabel:n.length>1?`paste #${a+1}`:"paste"});i==null&&(i=l)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),i!=null&&Ne(i)}F.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&(He(),Ne(n))}),document.getElementById("removeModel").onclick=()=>{if(v<0)return;if(console.log("[Blockscape] removing model:",r(E[v])),E.splice(v,1),!E.length){v=-1,H=null,b.innerHTML="",M.innerHTML="",c.value="",ft(),se();return}const e=Math.min(v,E.length-1);Ne(e)},document.getElementById("search").addEventListener("input",e=>{const t=e.target.value.trim().toLowerCase();console.log("[Blockscape] search:",t),b.querySelectorAll(".tile").forEach(n=>{const i=n.querySelector(".name").textContent.toLowerCase();n.style.opacity=!t||i.includes(t)?1:.2})}),A&&R&&P&&A.addEventListener("submit",async e=>{e.preventDefault();const t=R.value.trim();if(!t){alert("Please enter a URL"),R.focus();return}const n=await nn(t);if(typeof n=="number"){Ne(n),R.value="";const i=document.getElementById("urlHint");i&&(i.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!R||!t)return;let n=null;R.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=R.value.slice(-12);t.textContent=o?`…${o}`:""},300)})}();function Je(){if(!(v<0))try{H=jn(E[v].data),gt()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function gi(){const e=["NFR.bs","planets.bs","styleguide.bs"],t=n=>Rt?Rt.endsWith("/")?`${Rt}${n}`:`${Rt}/${n}`:n;for(const n of e)try{const i=await fetch(t(n),{cache:"no-store"});if(!i.ok){console.warn(`[Blockscape] ${n} not fetched (${i.status}); skipping`);continue}const o=await i.text(),s=n.replace(/\.[^.]+$/,"")||"Model",a=it(o,s);if(!a.length){console.warn("[Blockscape] no models found in",n);continue}a.forEach(l=>{var h;let d={...l};if(l.isSeries){const w=Ve(s)||s;d={...l,title:s,apicurioArtifactName:s,data:{...l.data,id:w,title:((h=l.data)==null?void 0:h.title)||s}}}x(d,{versionLabel:n})}),console.log(`[Blockscape] loaded ${a.length} model(s) from ${n}`)}catch(i){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",i)}ft()}async function bi(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const i of t)try{console.log(`[Blockscape] fetching ${e} with cache="${i.cache??"default"}"`);const o=await fetch(e,i);if(o.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return await o.text()}catch(o){n=o}throw n||new Error("Unable to fetch URL")}function vi(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(i=>yi(i)),e.querySelectorAll("a[href]").forEach(i=>{const o=i.getAttribute("href");Ln(o)&&In(i,o)})}function yi(e){var l,d;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(d=(l=e.parentNode)==null?void 0:l.closest)!=null&&d.call(l,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,i=[];let o;for(;(o=n.exec(t))!==null;)i.push({url:o[0],index:o.index});if(!i.length)return;const s=document.createDocumentFragment();let a=0;i.forEach(({url:h,index:w})=>{w>a&&s.appendChild(document.createTextNode(t.slice(a,w))),s.appendChild(wi(h)),a=w+h.length}),a<t.length&&s.appendChild(document.createTextNode(t.slice(a))),e.parentNode.replaceChild(s,e)}function wi(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",Ln(e)&&In(t,e),t}function In(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Ei(n,t,e)))}async function Ei(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await nn(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function Ln(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function nn(e){try{console.log("[Blockscape] loading from URL:",e);const t=await bi(e),i=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let o;try{o=it(t,i)}catch(a){throw new Error(`Invalid JSON payload: ${a.message}`)}if(!o.length)throw new Error("No JSON objects found in response.");let s=null;return o.forEach((a,l)=>{var Q,Ae;const d=(((Q=a.data)==null?void 0:Q.title)??"").toString().trim(),h=o.length>1?`${i} #${l+1}`:i,w=a.isSeries?i:null;let O={...a};if(a.isSeries){const $e=Ve(i)||i;O={...a,title:d||w||h,apicurioArtifactName:w||a.apicurioArtifactName,data:{...a.data,id:$e,title:((Ae=a.data)==null?void 0:Ae.title)||w||h}}}const J=x({...O,title:d||O.title||h,apicurioArtifactName:O.apicurioArtifactName||w||a.apicurioArtifactName},{versionLabel:i});s==null&&(s=J)}),console.log(`[Blockscape] loaded ${o.length} model(s) from URL:`,i),v===-1&&s!=null?Ne(s):ft(),s}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const i=it(n,"Blockscape");if(!i.length)throw new Error("Seed template could not be parsed.");let o=null;i.forEach(w=>{const O=x(w,{versionLabel:"seed"});o==null&&(o=O)}),await gi();const s=await Dn(),a=vn(),l=a==null?void 0:a.index,d=Fn();Ne(typeof s=="number"?s:typeof d=="number"?d:typeof l=="number"?l:o??0)})()}function Yi(c){let m,b,M,I,F,U=`<script id="seed" type="application/json">${c[0]}<\/script>`,A,R,P,Z,j,K,ie,G;return{c(){m=kt("link"),b=wt(),M=kt("div"),M.innerHTML=`<header class="pf-v5-c-page__header"><div class="pf-v5-c-masthead pf-m-display-inline blockscape-masthead"><div class="pf-v5-c-masthead__content"><div class="blockscape-toolbar"><div class="blockscape-brand"><h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/> <a href="https://github.com/pwright/blockscape" target="_blank" class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></div> <div class="blockscape-toolbar__controls"><label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <form id="urlForm" class="blockscape-url-form" autocomplete="on" novalidate=""><label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-secondary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div></form> <label class="pf-v5-c-button pf-m-secondary blockscape-file"><span>Load File(s)</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/></label> <button id="openInEditor" class="pf-v5-c-button pf-m-primary" type="button" title="Open current JSON in the editor">Edit</button> <button id="helpButton" class="pf-v5-c-button pf-m-tertiary" type="button" title="Show keyboard shortcuts">Help</button> <button id="shareModel" class="pf-v5-c-button pf-m-primary" type="button" title="Copy a shareable URL for this model">Share</button></div> <div class="blockscape-legend" role="presentation"><span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span> <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span> <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span> <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span></div></div></div></div></header> <main class="pf-v5-c-page__main"><div class="blockscape-content"><aside class="blockscape-sidebar" aria-label="Models"><div class="sidebar-heading">Models</div> <ul id="modelList" class="model-nav-list"></ul> <div class="model-actions"><button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button></div></aside> <div class="blockscape-main"><section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,logo?,external?:url,color?,deps:[]}}], links?:[{from,to}] }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="copySeries" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy every version in this series as an array">Copy series</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section></div></div></main> <footer class="pf-v5-c-page__footer blockscape-footer"><div class="blockscape-footer__inner"><a href="https://pwright.github.io/backscape/" target="_blank" rel="noreferrer noopener">Old versions</a></div></footer>`,I=wt(),F=new _i(!1),A=wt(),R=On("svg"),P=wt(),Z=kt("div"),j=wt(),K=kt("div"),K.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',ie=wt(),G=kt("div"),G.innerHTML='<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Keyboard shortcuts</h2> <p class="shortcut-help__subtitle">Stay in flow with navigation, editing, and quick exports.</p></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></div>',document.title="Blockscape — simple landscape-style tiles",ae(m,"rel","icon"),ae(m,"type","image/svg+xml"),ae(m,"href","./favicon.svg"),ae(M,"class","pf-v5-c-page"),F.a=A,ae(R,"id","overlay"),ae(R,"class","svg-layer"),ae(Z,"id","tabTooltip"),ae(Z,"class","blockscape-tab-tooltip"),Z.hidden=!0,ae(Z,"aria-hidden","true"),ae(K,"id","itemPreview"),ae(K,"class","item-preview"),K.hidden=!0,ae(K,"aria-hidden","true"),ae(G,"id","shortcutHelp"),ae(G,"class","shortcut-help"),G.hidden=!0,ae(G,"aria-hidden","true"),ae(G,"role","dialog"),ae(G,"aria-modal","true"),ae(G,"aria-labelledby","shortcutHelpTitle")},m(N,_){Ii(document.head,m),Ce(N,b,_),Ce(N,M,_),Ce(N,I,_),F.m(U,N,_),Ce(N,A,_),Ce(N,R,_),Ce(N,P,_),Ce(N,Z,_),Ce(N,j,_),Ce(N,K,_),Ce(N,ie,_),Ce(N,G,_)},p:Ct,i:Ct,o:Ct,d(N){N&&(be(b),be(M),be(I),F.d(),be(A),be(R),be(P),be(Z),be(j),be(K),be(ie),be(G)),be(m)}}}function Xi(c){const m=`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;return Ti(()=>{Wi()}),[m]}class Zi extends Di{constructor(m){super(),Fi(this,m,Xi,Yi,Ci,{})}}const Qi=document.getElementById("root");new Zi({target:Qi});
