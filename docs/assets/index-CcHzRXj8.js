var Qn=Object.defineProperty;var ei=(c,m,b)=>m in c?Qn(c,m,{enumerable:!0,configurable:!0,writable:!0,value:b}):c[m]=b;var Ke=(c,m,b)=>ei(c,typeof m!="symbol"?m+"":m,b);(function(){const m=document.createElement("link").relList;if(m&&m.supports&&m.supports("modulepreload"))return;for(const I of document.querySelectorAll('link[rel="modulepreload"]'))O(I);new MutationObserver(I=>{for(const H of I)if(H.type==="childList")for(const T of H.addedNodes)T.tagName==="LINK"&&T.rel==="modulepreload"&&O(T)}).observe(document,{childList:!0,subtree:!0});function b(I){const H={};return I.integrity&&(H.integrity=I.integrity),I.referrerPolicy&&(H.referrerPolicy=I.referrerPolicy),I.crossOrigin==="use-credentials"?H.credentials="include":I.crossOrigin==="anonymous"?H.credentials="omit":H.credentials="same-origin",H}function O(I){if(I.ep)return;I.ep=!0;const H=b(I);fetch(I.href,H)}})();function mt(){}function wn(c){return c()}function gn(){return Object.create(null)}function Vt(c){c.forEach(wn)}function En(c){return typeof c=="function"}function ti(c,m){return c!=c?m==m:c!==m||c&&typeof c=="object"||typeof c=="function"}function ni(c){return Object.keys(c).length===0}function ii(c,m){c.appendChild(m)}function Ae(c,m,b){c.insertBefore(m,b||null)}function be(c){c.parentNode&&c.parentNode.removeChild(c)}function pt(c){return document.createElement(c)}function xn(c){return document.createElementNS("http://www.w3.org/2000/svg",c)}function ri(c){return document.createTextNode(c)}function lt(){return ri(" ")}function le(c,m,b){b==null?c.removeAttribute(m):c.getAttribute(m)!==b&&c.setAttribute(m,b)}function oi(c){return Array.from(c.childNodes)}class si{constructor(m=!1){Ke(this,"is_svg",!1);Ke(this,"e");Ke(this,"n");Ke(this,"t");Ke(this,"a");this.is_svg=m,this.e=this.n=null}c(m){this.h(m)}m(m,b,O=null){this.e||(this.is_svg?this.e=xn(b.nodeName):this.e=pt(b.nodeType===11?"TEMPLATE":b.nodeName),this.t=b.tagName!=="TEMPLATE"?b:b.content,this.c(m)),this.i(O)}h(m){this.e.innerHTML=m,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(m){for(let b=0;b<this.n.length;b+=1)Ae(this.t,this.n[b],m)}p(m){this.d(),this.h(m),this.i(this.a)}d(){this.n.forEach(be)}}let St;function Ct(c){St=c}function ai(){if(!St)throw new Error("Function called outside component initialization");return St}function ci(c){ai().$$.on_mount.push(c)}const ft=[],bn=[];let ht=[];const vn=[],li=Promise.resolve();let nn=!1;function di(){nn||(nn=!0,li.then(kn))}function rn(c){ht.push(c)}const Xt=new Set;let dt=0;function kn(){if(dt!==0)return;const c=St;do{try{for(;dt<ft.length;){const m=ft[dt];dt++,Ct(m),ui(m.$$)}}catch(m){throw ft.length=0,dt=0,m}for(Ct(null),ft.length=0,dt=0;bn.length;)bn.pop()();for(let m=0;m<ht.length;m+=1){const b=ht[m];Xt.has(b)||(Xt.add(b),b())}ht.length=0}while(ft.length);for(;vn.length;)vn.pop()();nn=!1,Xt.clear(),Ct(c)}function ui(c){if(c.fragment!==null){c.update(),Vt(c.before_update);const m=c.dirty;c.dirty=[-1],c.fragment&&c.fragment.p(c.ctx,m),c.after_update.forEach(rn)}}function pi(c){const m=[],b=[];ht.forEach(O=>c.indexOf(O)===-1?m.push(O):b.push(O)),b.forEach(O=>O()),ht=m}const fi=new Set;function mi(c,m){c&&c.i&&(fi.delete(c),c.i(m))}function hi(c,m,b){const{fragment:O,after_update:I}=c.$$;O&&O.m(m,b),rn(()=>{const H=c.$$.on_mount.map(wn).filter(En);c.$$.on_destroy?c.$$.on_destroy.push(...H):Vt(H),c.$$.on_mount=[]}),I.forEach(rn)}function gi(c,m){const b=c.$$;b.fragment!==null&&(pi(b.after_update),Vt(b.on_destroy),b.fragment&&b.fragment.d(m),b.on_destroy=b.fragment=null,b.ctx=[])}function bi(c,m){c.$$.dirty[0]===-1&&(ft.push(c),di(),c.$$.dirty.fill(0)),c.$$.dirty[m/31|0]|=1<<m%31}function vi(c,m,b,O,I,H,T=null,A=[-1]){const R=St;Ct(c);const P=c.$$={fragment:null,ctx:[],props:H,update:mt,not_equal:I,bound:gn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(m.context||(R?R.$$.context:[])),callbacks:gn(),dirty:A,skip_bound:!1,root:m.target||R.$$.root};T&&T(P.root);let Z=!1;if(P.ctx=b?b(c,m.props||{},(j,z,...re)=>{const G=re.length?re[0]:z;return P.ctx&&I(P.ctx[j],P.ctx[j]=G)&&(!P.skip_bound&&P.bound[j]&&P.bound[j](G),Z&&bi(c,j)),z}):[],P.update(),Z=!0,Vt(P.before_update),P.fragment=O?O(P.ctx):!1,m.target){if(m.hydrate){const j=oi(m.target);P.fragment&&P.fragment.l(j),j.forEach(be)}else P.fragment&&P.fragment.c();m.intro&&mi(c.$$.fragment),hi(c,m.target,m.anchor),kn()}Ct(R)}class yi{constructor(){Ke(this,"$$");Ke(this,"$$set")}$destroy(){gi(this,1),this.$destroy=mt}$on(m,b){if(!En(b))return mt;const O=this.$$.callbacks[m]||(this.$$.callbacks[m]=[]);return O.push(b),()=>{const I=O.indexOf(b);I!==-1&&O.splice(I,1)}}$set(m){this.$$set&&!ni(m)&&(this.$$.skip_bound=!0,this.$$set(m),this.$$.skip_bound=!1)}}const wi="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(wi);const yn="blockscape:apicurioConfig",Zt="http://localhost:8080/apis/registry/v3",Qt="bs",en=!1,tn=!1;function Ei({models:c,getActiveIndex:m,setActive:b,ensureModelMetadata:O,getModelId:I,getModelTitle:H,computeJsonFingerprint:T,uid:A}){let R=null,P=null,Z=null,j=null,z=null,re=null,G=null,N=null,_=null,q=null;const C={baseUrl:Zt,groupId:Qt,authToken:"",enabled:en,useSemver:tn},te=new Map,X=new Map;function J(r){return(r||"").toString().trim().replace(/\/+$/,"")}function ne(){return!!(C.baseUrl&&C.groupId)}function oe(){return C.enabled!==!1}function pe(){Z&&(Z.value=C.baseUrl||""),j&&(j.value=C.groupId||""),z&&(z.value=C.authToken||""),re&&(re.checked=oe()),G&&(G.checked=!!C.useSemver)}function k(r="",d="muted"){N&&(N.textContent=r||"",N.classList.remove("is-error","is-success"),d==="error"?N.classList.add("is-error"):d==="success"&&N.classList.add("is-success"))}function $e(r){if(!q||(q.innerHTML="",!r))return;const d=document.createElement("p");d.className="apicurio-hint",d.textContent=r,q.appendChild(d)}function Ce(r){te.clear(),X.clear(),$e(r)}function x(){const r=m(),d=oe(),f=ne(),h=r>=0?c[r]:null,p=!!(h!=null&&h.apicurioVersions&&h.apicurioVersions.length>1);if(R){const y=R.dataset.loading==="true",B=d&&f&&r>=0&&!!I(c[r]);R.disabled=!d||y||!B,d?y||(R.textContent="Push to Apicurio"):R.textContent="Enable Apicurio to push"}if(_){const y=_.dataset.loading==="true",B=d&&f&&p&&!!I(h);_.disabled=!B||y,_.hidden=!p,d?y||(_.textContent="Push series"):_.textContent="Enable Apicurio to push series"}if(P){const y=P.dataset.loading==="true",B=d&&f;P.disabled=!B||y,y||(d?f?P.textContent="List artifacts":P.textContent="Enter details to list":P.textContent="Enable Apicurio to list")}}function v(){pe(),oe()?ne()?(k("Apicurio push is ready when a model is selected.","muted"),te.size||$e("Click “List artifacts” to browse the current group.")):(k("Enter Apicurio connection details to enable push.","muted"),Ce("Enter registry details to browse artifacts.")):(k("Apicurio integration is off. Enable it to allow pushes.","muted"),Ce("Apicurio integration is disabled.")),x()}function fe(){if(window!=null&&window.localStorage)try{localStorage.setItem(yn,JSON.stringify(C))}catch(r){console.warn("[Blockscape] unable to persist Apicurio settings",r)}}function F(){let r={};if(window!=null&&window.localStorage)try{const y=localStorage.getItem(yn);if(y){const B=JSON.parse(y);B&&typeof B=="object"&&(r=B)}}catch(y){console.warn("[Blockscape] failed to restore Apicurio settings",y)}const d=J(r.baseUrl??Zt),f=(r.groupId??Qt).toString().trim();let h=en,p=tn;typeof r.enabled=="boolean"?h=r.enabled:typeof r.enabled=="string"&&(h=r.enabled==="true"),typeof r.useSemver=="boolean"?p=r.useSemver:typeof r.useSemver=="string"&&(p=r.useSemver==="true"),C.baseUrl=d||Zt,C.groupId=f||Qt,C.authToken=(r.authToken??"").toString().trim(),C.enabled=h,C.useSemver=p,v()}function W(){const r={Accept:"application/json"},d=(C.authToken||"").trim();return d&&(r.Authorization=/\s/.test(d)?d:`Bearer ${d}`),r}function M(r,d,{title:f,description:h,version:p}={}){const y={artifactId:r,artifactType:"JSON",firstVersion:{content:{contentType:"application/json",content:d}}};return p&&(y.firstVersion.version=p),f&&(y.name=f),h&&(y.description=h),y}function Se(r,{version:d}={}){const f={content:{contentType:"application/json",content:r}};return d&&(f.version=d),f}function ae(r){if(r==null)return null;const d=String(r).trim();if(!d)return null;const f=/^v?(\d+)\.(\d+)\.(\d+)(?:-.+)?$/.exec(d);if(f)return{major:Number(f[1]),minor:Number(f[2]),patch:Number(f[3])};const h=/^v?(\d+)$/.exec(d);return h?{major:Number(h[1]),minor:0,patch:0}:null}function Oe(r){return`${r.major}.${r.minor}.${r.patch}`}function ce(r,d){return!r&&!d?0:r?d?r.major!==d.major?r.major-d.major:r.minor!==d.minor?r.minor-d.minor:r.patch-d.patch:1:-1}function Me(r=[]){let d=null;if(r.forEach(h=>{const p=ae((h==null?void 0:h.version)??h);p&&(!d||ce(p,d)>0)&&(d=p)}),!d)return"1.0.0";const f={...d,patch:d.patch+1};return Oe(f)}function we(r){return Array.isArray(r)?r:Array.isArray(r==null?void 0:r.artifacts)?r.artifacts:Array.isArray(r==null?void 0:r.items)?r.items:Array.isArray(r==null?void 0:r.results)?r.results:[]}function Ie(r){return Array.isArray(r)?r:Array.isArray(r==null?void 0:r.versions)?r.versions:Array.isArray(r==null?void 0:r.items)?r.items:[]}function We(r=[]){if(!Array.isArray(r)||!r.length)return null;const d=[...r].filter(Boolean);return d.sort((f,h)=>{const p=f!=null&&f.createdOn?new Date(f.createdOn).getTime():0,y=h!=null&&h.createdOn?new Date(h.createdOn).getTime():0;if(p!==y)return y-p;const B=Number(f==null?void 0:f.version),S=Number(h==null?void 0:h.version),V=Number.isFinite(B),L=Number.isFinite(S);if(V&&L&&B!==S)return S-B;const $=String((f==null?void 0:f.version)??"");return String((h==null?void 0:h.version)??"").localeCompare($,void 0,{numeric:!0})}),d[0]||null}function Ve(r){if(!r)return r;let d=r;if(!Array.isArray(r==null?void 0:r.categories)){const h=r==null?void 0:r.content;if(typeof h=="string")try{d=JSON.parse(h)}catch(p){console.warn("[Blockscape] artifact payload contained string content that could not be parsed",p)}else h&&typeof h=="object"&&(d=h)}return d}async function Ge(r,d,f){const h=encodeURIComponent(d),p=encodeURIComponent(f),y=`${r}/groups/${h}/artifacts/${p}`,B=W();B.Accept="application/json";const S=await fetch(y,{method:"GET",headers:B});if(!S.ok){let V=S.statusText||"Unknown error";try{const L=await S.text();L&&(V=L.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact metadata (${S.status}): ${V}`)}return S.json()}async function Be(r,d,f){const h=encodeURIComponent(d),p=encodeURIComponent(f),y=`${r}/groups/${h}/artifacts/${p}/versions?limit=50&order=desc`,B=W();B.Accept="application/json";const S=await fetch(y,{method:"GET",headers:B});if(!S.ok){let L=S.statusText||"Unknown error";try{const $=await S.text();$&&(L=$.slice(0,400))}catch{}throw new Error(`Failed to fetch artifact versions (${S.status}): ${L}`)}const V=await S.json();return Ie(V).filter(L=>L&&L.version!=null)}async function gt(r,d,f,h="latest"){const p=encodeURIComponent(d),y=encodeURIComponent(f),B=encodeURIComponent(h||"latest"),S=`${r}/groups/${p}/artifacts/${y}/versions/${B}/content`,V=W();V.Accept="application/json, application/*+json, */*;q=0.8";const L=await fetch(S,{method:"GET",headers:V});if(!L.ok){let ie=L.statusText||"Unknown error";try{const se=await L.text();se&&(ie=se.slice(0,400))}catch{}throw new Error(`Failed to load artifact content (${L.status}): ${ie}`)}const $=await L.text();let K=null;try{K=JSON.parse($)}catch{throw new Error("Artifact content is not valid JSON.")}return Ve(K)}async function It(r,d,f,h="latest"){const p=await gt(r,d,f,h);return{data:p,fingerprint:T(p)}}async function Lt(r,d,f){try{const p=await Be(r,d,f);if(p!=null&&p.length){X.set(f,p);const y=We(p);if((y==null?void 0:y.version)!=null)return y.version}}catch(p){console.warn("[Blockscape] compare-version: unable to fetch versions list",p)}try{const p=await Ge(r,d,f);if((p==null?void 0:p.version)!=null)return p.version}catch(p){console.warn("[Blockscape] compare-version: unable to fetch metadata",p)}const h=X.get(f);if(h&&h.length){const p=We(h);if((p==null?void 0:p.version)!=null)return p.version}return"latest"}async function Te(r,d,f,h){if(!C.useSemver)return null;if(!h)return"1.0.0";try{const p=await Be(r,d,f);return Me(p)}catch(p){throw new Error(`Unable to compute next semantic version: ${p.message}`)}}function bt(r=document){R=r.querySelector("#pushApicurio")||document.getElementById("pushApicurio"),_=r.querySelector("#pushApicurioSeries")||document.getElementById("pushApicurioSeries"),P=r.querySelector("#listApicurioArtifacts")||document.getElementById("listApicurioArtifacts"),Z=r.querySelector("#apicurioUrl")||document.getElementById("apicurioUrl"),j=r.querySelector("#apicurioGroup")||document.getElementById("apicurioGroup"),z=r.querySelector("#apicurioToken")||document.getElementById("apicurioToken"),re=r.querySelector("#apicurioToggle")||document.getElementById("apicurioToggle"),G=r.querySelector("#apicurioSemver")||document.getElementById("apicurioSemver"),N=r.querySelector("#apicurioStatus")||document.getElementById("apicurioStatus"),q=r.querySelector("#apicurioArtifacts")||document.getElementById("apicurioArtifacts")}function Nt(){C.baseUrl=J((Z==null?void 0:Z.value)??C.baseUrl),C.groupId=((j==null?void 0:j.value)??"").trim(),C.authToken=((z==null?void 0:z.value)??"").trim(),fe(),v()}function tt(){C.enabled=re?re.checked:en,fe(),v()}function Pt(){C.useSemver=G?G.checked:tn,fe(),v()}function Pe(){[Z,j,z].forEach(r=>{r&&r.addEventListener("input",Nt)}),R&&R.addEventListener("click",()=>{Re()}),_&&_.addEventListener("click",()=>{Le()}),re&&re.addEventListener("change",tt),G&&G.addEventListener("change",Pt),P&&P.addEventListener("click",Jt),q&&q.addEventListener("click",r=>{const d=r.target.closest("[data-artifact-version]");if(d){r.stopPropagation();const p=d.dataset.artifactId,y=d.dataset.artifactVersion;p&&y&&vt(p,y);return}const f=r.target.closest("[data-artifact-load-all]");if(f){r.stopPropagation();const p=f.dataset.artifactId;p&&Tt(p);return}const h=r.target.closest("[data-artifact-trigger]");if(h){const p=h.dataset.artifactId;if(!p)return;_t(p)}})}function Rt(){const r=document.createElement("div");return r.className="blockscape-registry-panel",r.innerHTML=`
      <div class="blockscape-registry-header">
        <h2>Apicurio registry</h2>
        <p>Configure the registry connection and push the active model.</p>
      </div>
      <div class="apicurio-controls">
        <label class="apicurio-toggle">
          <input id="apicurioToggle" type="checkbox" />
          <span>Enable Apicurio push</span>
        </label>
        <label class="apicurio-toggle">
          <input id="apicurioSemver" type="checkbox" />
          <span>Use semantic versioning</span>
        </label>
        <p class="apicurio-hint">When disabled, Blockscape never contacts your registry.</p>
        <p class="apicurio-hint apicurio-subnote">When on, Blockscape reads the latest version and auto-bumps the next semver on each push.</p>
        <button id="pushApicurio" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="Enter Apicurio connection details to enable pushes">Push to Apicurio</button>
        <button id="pushApicurioSeries" class="pf-v5-c-button pf-m-secondary" type="button" disabled hidden
          title="Push all versions in this series as a JSON array">Push series</button>
        <button id="listApicurioArtifacts" class="pf-v5-c-button pf-m-secondary" type="button" disabled
          title="List artifacts in the configured group">List artifacts</button>
        <details id="apicurioSettings" class="apicurio-settings">
          <summary>Connection settings (optional)</summary>
          <div class="apicurio-fields">
            <label>
              Registry base URL
              <input id="apicurioUrl" type="url" placeholder="https://registry.example/apis/registry/v3" autocomplete="url" />
            </label>
            <label>
              Group ID
              <input id="apicurioGroup" type="text" placeholder="default" autocomplete="organization" />
            </label>
            <label>
              Auth token (optional)
              <input id="apicurioToken" type="password" placeholder="Bearer token" autocomplete="off" />
            </label>
          </div>
          <p class="apicurio-hint">Details stay in this browser only.</p>
        </details>
        <div id="apicurioStatus" class="apicurio-status" role="status" aria-live="polite"></div>
        <div id="apicurioArtifacts" class="apicurio-artifacts" aria-live="polite"></div>
      </div>
    `,r}function ue(r){if(!r)return;r.innerHTML="";const d=Rt();r.appendChild(d),bt(r),Pe(),v()}function Ht(r){if(!q)return;if(q.innerHTML="",!r.length){$e("No artifacts found in this group.");return}const d=document.createElement("ul");d.className="apicurio-artifact-list",r.forEach(f=>{if(!(f!=null&&f.artifactId))return;const h=document.createElement("li"),p=document.createElement("button");p.type="button",p.className="apicurio-artifact",p.dataset.artifactId=f.artifactId,p.dataset.artifactTrigger="toggle";const y=document.createElement("span");y.className="apicurio-artifact-title",y.textContent=f.artifactId,p.appendChild(y);const B=[];if(f.name&&B.push(f.name),f.version!=null&&B.push(`v${f.version}`),f.type&&B.push(f.type),B.length){const L=document.createElement("span");L.className="apicurio-artifact-meta",L.textContent=B.join(" • "),p.appendChild(L)}if(f.description){const L=document.createElement("span");L.className="apicurio-artifact-meta",L.textContent=f.description,p.appendChild(L)}h.appendChild(p);const S=document.createElement("div");S.className="apicurio-version-list",S.dataset.versionPanel=f.artifactId,S.hidden=!0;const V=document.createElement("p");V.className="apicurio-hint",V.textContent="Click above to choose a version to load.",S.appendChild(V),h.appendChild(S),d.appendChild(h)}),q.appendChild(d)}function me(r){return q?q.querySelector(`[data-version-panel="${r}"]`):null}function Ye(r,d){if(!r||(r.innerHTML="",!d))return;const f=document.createElement("p");f.className="apicurio-hint",f.textContent=d,r.appendChild(f)}function Dt(r,d){const f=me(r);if(!f)return;if(f.innerHTML="",!d.length){Ye(f,"No versions found for this artifact.");return}d.forEach(p=>{const y=document.createElement("button");y.type="button",y.className="apicurio-version-button",y.dataset.artifactId=r,y.dataset.artifactVersion=p.version;const B=[`Version ${p.version}`];if(p.createdOn){const S=new Date(p.createdOn);isNaN(S)||B.push(S.toISOString().slice(0,10))}y.textContent=B.join(" — "),f.appendChild(y)});const h=document.createElement("button");h.type="button",h.className="apicurio-version-button",h.dataset.artifactId=r,h.dataset.artifactLoadAll="true",h.textContent=`Load all (${d.length})`,f.appendChild(h)}async function _t(r){const d=me(r);if(!d)return;if(d.dataset.open==="true"){d.hidden=!0,d.dataset.open="false";return}if(d.hidden=!1,d.dataset.open="true",d.dataset.loaded!=="true"){if(!ne()){Ye(d,"Enter registry details first.");return}Ye(d,"Loading versions…");try{const h=J(C.baseUrl),p=C.groupId.trim(),y=await Be(h,p,r);X.set(r,y),d.dataset.loaded="true",Dt(r,y)}catch(h){console.error("[Blockscape] failed to load versions",h),Ye(d,`Unable to fetch versions: ${h.message}`)}}}function $t(r,d){var h;const f=c.findIndex(p=>p.apicurioArtifactId===r);if(f!==-1){const p=c[f].id;c[f]={...d,id:p||d.id},((h=c[f].apicurioVersions)==null?void 0:h.length)>1&&(c[f].isSeries=!0),b(f)}else c.push(d),b(c.length-1)}async function Bt(r,d,f,h){const p=encodeURIComponent(d),y=encodeURIComponent(f),B=`${r}/groups/${p}/artifacts/${y}`;try{const S=await fetch(B,{method:"GET",headers:h});if(S.status===404)return!1;if(S.ok)return!0;throw S.status===401||S.status===403?new Error("Authentication failed while checking the registry."):new Error(`Registry responded with status ${S.status} while checking the artifact.`)}catch(S){throw S instanceof TypeError?new Error("Network error while contacting Apicurio registry."):S}}async function Re(){var B;if(!R||R.dataset.loading==="true")return;if(!oe()){k("Apicurio integration is off. Enable it first.","error");return}if(!ne()){k("Enter the registry base URL and group ID before pushing.","error");return}const r=m();if(r<0||!c[r]){k("No active model to push.","error");return}const d=I(c[r]);if(!d){k("Active model needs an id before pushing.","error");return}const f=J(C.baseUrl),h=C.groupId.trim(),p=JSON.stringify(c[r].data,null,2),y=W();R.dataset.loading="true",R.textContent="Pushing…",R.disabled=!0,k("Pushing to Apicurio…","muted");try{const S=await Bt(f,h,d,y),V=T(c[r].data);if(S)try{const xe=await Lt(f,h,d),{data:Je,fingerprint:Fe}=await It(f,h,d,xe);if(console.group("[Blockscape] Apicurio push compare"),console.log("compare version",xe),console.log("local fingerprint",V),console.log("registry fingerprint",Fe),console.log("local payload",c[r].data),console.log("registry payload",Je),console.groupEnd(),V&&Fe&&V===Fe){if(!window.confirm("The current registry version is identical to this model. Push anyway?")){k("Push cancelled (content matches the latest registry version).","muted");return}k("Pushing identical content by user choice.","muted")}else Fe?console.log("[Blockscape] Apicurio compare mismatch (proceeding with push)"):k("Unable to compare with registry content (skipping confirmation).","muted")}catch(xe){console.warn("[Blockscape] unable to compare registry content before push",xe),k("Skipped comparison with registry (content fetch failed). Proceeding with push.","muted")}const L=C.useSemver?await Te(f,h,d,S):null;if(C.useSemver&&!L)throw new Error("Semantic versioning is enabled but no version could be computed.");const $=encodeURIComponent(h),K=encodeURIComponent(d),ie=S?`${f}/groups/${$}/artifacts/${K}/versions`:`${f}/groups/${$}/artifacts`,se={...y,"Content-Type":"application/json"};L&&(se["X-Registry-Version"]=L,k(`Pushing to Apicurio as version ${L}…`,"muted"));const Xe=S?Se(p,{version:L}):M(d,p,{title:H(c[r]),description:(B=c[r].data)==null?void 0:B.abstract,version:L}),He=await fetch(ie,{method:"POST",headers:se,body:JSON.stringify(Xe)});if(!He.ok){let xe=He.statusText||"Unknown error";try{const Je=await He.text();Je&&(xe=Je.slice(0,400))}catch{}throw new Error(`Registry rejected the push (${He.status}): ${xe}`)}let he=null;try{he=await He.json()}catch{he=null}const Ee=(he==null?void 0:he.version)||(he==null?void 0:he.globalId)||"",De=S?"Updated":"Created",de=Ee?` (version ${Ee})`:"";k(`${De} ${d}${de}`,"success")}catch(S){console.error("[Blockscape] Apicurio push failed",S),k(`Apicurio push failed: ${S.message}`,"error")}finally{R.dataset.loading="false",x()}}async function Le(){var V,L;if(!_||_.dataset.loading==="true")return;if(!oe()){k("Apicurio integration is off. Enable it first.","error");return}if(!ne()){k("Enter the registry base URL and group ID before pushing.","error");return}const r=m(),d=r>=0?c[r]:null;if(!d||!d.apicurioVersions||d.apicurioVersions.length<2){k("Series push requires a model with multiple versions.","error");return}const f=I(d);if(!f){k("Active series needs an id before pushing.","error");return}const h=J(C.baseUrl),p=C.groupId.trim(),y=d.apicurioVersions.map($=>$.data),B=JSON.stringify(y,null,2),S=W();_.dataset.loading="true",_.textContent="Pushing…",_.disabled=!0,k("Pushing series to Apicurio…","muted");try{const $=await Bt(h,p,f,S),K=T(y);if($)try{const Ue=await Lt(h,p,f),{data:nt,fingerprint:it}=await It(h,p,f,Ue);if(console.group("[Blockscape] Apicurio series push compare"),console.log("compare version",Ue),console.log("local fingerprint",K),console.log("registry fingerprint",it),console.log("local payload (series)",y),console.log("registry payload",nt),console.groupEnd(),K&&it&&K===it){if(!window.confirm("The current registry version matches this series. Push anyway?")){k("Series push cancelled (content matches latest).","muted");return}k("Pushing identical series by user choice.","muted")}else it?console.log("[Blockscape] Apicurio compare mismatch (proceeding with series push)"):k("Unable to compare with registry content (skipping confirmation).","muted")}catch(Ue){console.warn("[Blockscape] unable to compare registry content before series push",Ue),k("Skipped comparison with registry (content fetch failed). Proceeding with series push.","muted")}const ie=C.useSemver?await Te(h,p,f,$):null;if(C.useSemver&&!ie)throw new Error("Semantic versioning is enabled but no version could be computed.");const se=encodeURIComponent(p),Xe=encodeURIComponent(f),He=$?`${h}/groups/${se}/artifacts/${Xe}/versions`:`${h}/groups/${se}/artifacts`,he={...S,"Content-Type":"application/json"};ie&&(he["X-Registry-Version"]=ie,k(`Pushing series to Apicurio as version ${ie}…`,"muted"));const Ee=$?Se(B,{version:ie}):M(f,B,{title:d.apicurioArtifactName||((V=d.data)==null?void 0:V.title)||f,description:(L=d.data)==null?void 0:L.abstract,version:ie}),De=await fetch(He,{method:"POST",headers:he,body:JSON.stringify(Ee)});if(!De.ok){let Ue=De.statusText||"Unknown error";try{const nt=await De.text();nt&&(Ue=nt.slice(0,400))}catch{}throw new Error(`Registry rejected the series push (${De.status}): ${Ue}`)}let de=null;try{de=await De.json()}catch{de=null}const xe=(de==null?void 0:de.version)||(de==null?void 0:de.globalId)||"",Je=$?"Updated":"Created",Fe=xe?` (version ${xe})`:"";k(`${Je} ${f} series${Fe}`,"success")}catch($){console.error("[Blockscape] Apicurio series push failed",$),k(`Apicurio series push failed: ${$.message}`,"error")}finally{_.dataset.loading="false",x()}}async function Jt(){if(!P||P.dataset.loading==="true")return;if(!oe()){k("Enable Apicurio integration to list artifacts.","error");return}if(!ne()){k("Enter registry base URL and group ID before listing.","error");return}const r=J(C.baseUrl),d=C.groupId.trim(),f=encodeURIComponent(d),h=`${r}/groups/${f}/artifacts?limit=50&offset=0`;P.dataset.loading="true",P.textContent="Listing…",P.disabled=!0,k("Listing artifacts…","muted"),$e("Contacting registry…");try{const p=W();p.Accept="application/json";const y=await fetch(h,{method:"GET",headers:p});if(!y.ok){let L=y.statusText||"Unknown error";try{const $=await y.text();$&&(L=$.slice(0,400))}catch{}throw new Error(`Failed to list artifacts (${y.status}): ${L}`)}const B=await y.json(),S=we(B).filter(L=>L&&L.artifactId);te.clear(),X.clear(),S.forEach(L=>{L!=null&&L.artifactId&&te.set(L.artifactId,L)}),Ht(S);const V=S.length;k(V?`Found ${V} artifact${V===1?"":"s"}.`:"No artifacts found in this group.",V?"success":"muted")}catch(p){console.error("[Blockscape] failed to list artifacts",p),Ce("Unable to list artifacts."),k(`Listing failed: ${p.message}`,"error")}finally{P.dataset.loading="false",x()}}async function vt(r,d=null){if(!r)return;if(!oe()){k("Enable Apicurio integration to load artifacts.","error");return}if(!ne()){k("Enter registry connection details before loading artifacts.","error");return}const f=J(C.baseUrl),h=C.groupId.trim();let p=te.get(r);const y=async()=>{try{const $=await Ge(f,h,r);return $!=null&&$.artifactId&&te.set(r,$),$}catch($){throw console.error("[Blockscape] failed to fetch artifact metadata before loading",$),$}};if(!p)try{p=await y()}catch($){k(`Failed to fetch artifact metadata: ${$.message}`,"error");return}const B=X.get(r)||[];let S="latest",V="latest";if(d)S=d,V=d;else{if(!p||p.version==null)try{p=await y()}catch($){k(`Failed to fetch artifact metadata: ${$.message}`,"error");return}S=(p==null?void 0:p.version)||"latest",V=(p==null?void 0:p.version)||"latest"}const L=B.find($=>String($.version)===String(S));(L==null?void 0:L.version)!=null&&(V=L.version),k(`Loading artifact ${r}…`,"muted");try{const $=await gt(f,h,r,S),K=te.get(r)||p||{};O($,{titleHint:K.name||r,idHint:r});const ie={version:V,data:$,createdOn:(L==null?void 0:L.createdOn)||K.createdOn},se={id:A(),title:$.title||K.name||r,data:$,apicurioArtifactId:r,apicurioArtifactName:K.name||"",apicurioVersions:[ie],apicurioActiveVersionIndex:0};$t(r,se);const Xe=V?` (version ${V})`:"";k(`Loaded artifact ${r}${Xe}.`,"success")}catch($){console.error("[Blockscape] failed to load artifact",$),k(`Failed to load artifact: ${$.message}`,"error")}}async function Tt(r){if(!r)return;if(!oe()){k("Enable Apicurio integration to load artifacts.","error");return}if(!ne()){k("Enter registry connection details before loading artifacts.","error");return}const d=J(C.baseUrl),f=C.groupId.trim();let h=X.get(r);if(!h){Ye(me(r),"Loading versions…");try{h=await Be(d,f,r),X.set(r,h)}catch(V){k(`Failed to fetch versions: ${V.message}`,"error");return}}const p=(h||[]).filter(V=>V&&V.version!=null);if(!p.length){k("No versions found for this artifact.","muted");return}k(`Loading ${p.length} version(s) for ${r}…`,"muted");const y=te.get(r)||{},B=[];try{for(const V of p){const L=V.version??"latest",$=await gt(d,f,r,L);O($,{titleHint:y.name||r,idHint:r}),B.push({version:L,createdOn:V.createdOn,data:$})}}catch(V){console.error("[Blockscape] failed to load one or more versions",V),k(`Failed to load all versions: ${V.message}`,"error");return}if(!B.length){k("No versions loaded from registry.","error");return}const S={id:A(),title:B[0].data.title||y.name||r,data:B[0].data,apicurioArtifactId:r,apicurioArtifactName:y.name||"",apicurioVersions:B,apicurioActiveVersionIndex:0};$t(r,S),k(`Loaded ${B.length} version(s) for ${r}.`,"success")}return{hydrateConfig:F,mount:ue,updateAvailability:x}}function ut(c,m){if(typeof c!="function")throw new Error(`[itemEditor] expected ${m} to be a function`)}function xi(c,{excludeId:m}={}){if(!c)return[];const b=c.split(/[\s,]+/).map(I=>I.trim()).filter(Boolean),O=[];return b.forEach(I=>{m&&I===m||O.includes(I)||O.push(I)}),O}function ki(c,m,b){if(!m||!b||m===b)return;((c==null?void 0:c.categories)||[]).forEach(I=>{(I.items||[]).forEach(H=>{Array.isArray(H.deps)&&(H.deps=H.deps.map(T=>T===m?b:T))})}),Array.isArray(c==null?void 0:c.links)&&c.links.forEach(I=>{I.from===m&&(I.from=b),I.to===m&&(I.to=b)})}function Ai({findItemAndCategoryById:c,collectAllItemIds:m,updateItemReferences:b,loadActiveIntoEditor:O,rebuildFromActive:I,select:H,onSelectionRenamed:T}={}){ut(c,"findItemAndCategoryById"),ut(m,"collectAllItemIds"),ut(b,"updateItemReferences"),ut(O,"loadActiveIntoEditor"),ut(I,"rebuildFromActive"),ut(H,"select");const A={wrapper:null,fields:{},categoryId:null,itemId:null,modelData:null};function R(N){if(A.fields.errorEl){if(!N){A.fields.errorEl.hidden=!0,A.fields.errorEl.textContent="";return}A.fields.errorEl.hidden=!1,A.fields.errorEl.textContent=N}}function P(){A.wrapper&&(A.wrapper.hidden=!0,A.wrapper.setAttribute("aria-hidden","true"),R(""),A.categoryId=null,A.itemId=null,A.modelData=null,document.body.classList.remove("item-editor-open"))}function Z(){A.wrapper&&(A.wrapper.hidden=!1,A.wrapper.setAttribute("aria-hidden","false"),document.body.classList.add("item-editor-open"),requestAnimationFrame(()=>{var N,_;(N=A.fields.nameInput)==null||N.focus(),(_=A.fields.nameInput)==null||_.select()}))}function j(N){var pe;if(!A.modelData||!A.categoryId||!A.itemId)throw new Error("No item loaded.");const q=(((pe=A.modelData)==null?void 0:pe.categories)||[]).find(k=>k.id===A.categoryId);if(!q)throw new Error("Category not found.");q.items=q.items||[];const C=q.items.find(k=>k.id===A.itemId);if(!C)throw new Error("Item not found.");const te=(N.id||"").trim();if(!te)throw new Error("ID is required.");const X=m(A.modelData);if(te!==C.id&&X.has(te))throw new Error("Another item already uses that ID.");C.id=te;const J=(N.name||"").trim();C.name=J||C.id;const ne=(N.logo||"").trim();if(ne?C.logo=ne:delete C.logo,N.externalFlag&&!N.external)C.external=!0;else{const k=(N.external??"").toString().trim();k?C.external=k:delete C.external}const oe=(N.color||"").trim();return oe?C.color=oe:delete C.color,C.deps=Array.isArray(N.deps)?N.deps:[],C.id!==N.originalId&&typeof T=="function"&&T(N.originalId,C.id),b(A.modelData,N.originalId,C.id),O(),I(),H(C.id),C.id}function z(){if(!A.fields||!A.fields.idInput)return!1;const N=(A.fields.idInput.value||"").trim(),_={originalId:A.itemId,id:N,name:A.fields.nameInput.value||"",logo:A.fields.logoInput.value||"",external:A.fields.externalInput.value||"",externalFlag:A.fields.externalFlagInput.checked,color:A.fields.colorInput.value||"",deps:xi(A.fields.depsInput.value,{excludeId:N})};try{return j(_),P(),!0}catch(q){return console.warn("[itemEditor] item edit failed",q),R((q==null?void 0:q.message)||"Unable to save item."),!1}}function re(){if(A.wrapper)return A.wrapper;const N=document.createElement("div");N.className="item-editor-modal",N.hidden=!0,N.setAttribute("role","dialog"),N.setAttribute("aria-modal","true");const _=document.createElement("div");_.className="item-editor-modal__backdrop",N.appendChild(_);const q=document.createElement("div");q.className="item-editor",N.appendChild(q);const C=document.createElement("div");C.className="item-editor__header";const te=document.createElement("h2");te.className="item-editor__title",te.textContent="Edit item";const X=document.createElement("button");X.type="button",X.className="item-editor__close",X.setAttribute("aria-label","Close item editor"),X.textContent="×",C.appendChild(te),C.appendChild(X),q.appendChild(C);const J=document.createElement("form");J.className="item-editor__form",q.appendChild(J);const ne=document.createElement("div");ne.className="item-editor__meta",ne.innerHTML='<div class="item-editor__meta-label">Category</div><div class="item-editor__meta-value"></div>',J.appendChild(ne);const oe=document.createElement("div");oe.className="item-editor__error",oe.hidden=!0,J.appendChild(oe);const pe=(we,Ie,We)=>{const Ve=document.createElement("label");Ve.className="item-editor__field";const Ge=document.createElement("span");if(Ge.className="item-editor__label",Ge.textContent=we,Ve.appendChild(Ge),Ie.classList.add("item-editor__control"),Ve.appendChild(Ie),We){const Be=document.createElement("div");Be.className="item-editor__hint",Be.textContent=We,Ve.appendChild(Be)}return Ve},k=document.createElement("input");k.type="text",k.required=!0,J.appendChild(pe("ID",k,"Unique identifier used for links and dependencies."));const $e=document.createElement("input");$e.type="text",J.appendChild(pe("Name",$e,"Visible label shown on the tile."));const Ce=document.createElement("input");Ce.type="url",Ce.inputMode="url",Ce.placeholder="https://…",J.appendChild(pe("Logo URL",Ce,"Optional image URL."));const x=document.createElement("input");x.type="url",x.inputMode="url",x.placeholder="https://…",J.appendChild(pe("External link",x,"Shown with ↗ icon and in preview."));const v=document.createElement("div");v.className="item-editor__checkbox";const fe=document.createElement("label");fe.className="item-editor__checkbox-row";const F=document.createElement("input");F.type="checkbox";const W=document.createElement("span");W.textContent="Mark as external without link";const M=document.createElement("div");M.className="item-editor__hint",M.textContent="Keeps dashed border even without a URL.",fe.appendChild(F),fe.appendChild(W),v.appendChild(fe),v.appendChild(M),J.appendChild(v);const Se=document.createElement("input");Se.type="text",Se.placeholder="#2563eb",J.appendChild(pe("Color",Se,"Optional badge color (hex or CSS color)."));const ae=document.createElement("textarea");ae.rows=2,ae.placeholder="Comma or space separated ids",J.appendChild(pe("Dependencies",ae,"Use item IDs, separated by commas or spaces."));const Oe=document.createElement("div");Oe.className="item-editor__actions";const ce=document.createElement("button");ce.type="button",ce.className="pf-v5-c-button pf-m-tertiary",ce.textContent="Cancel";const Me=document.createElement("button");return Me.type="submit",Me.className="pf-v5-c-button pf-m-primary",Me.textContent="Save",Oe.appendChild(ce),Oe.appendChild(Me),J.appendChild(Oe),A.wrapper=N,A.fields={idInput:k,nameInput:$e,logoInput:Ce,externalInput:x,externalFlagInput:F,colorInput:Se,depsInput:ae,categoryValue:ne.querySelector(".item-editor__meta-value"),errorEl:oe},ce.addEventListener("click",P),X.addEventListener("click",P),_.addEventListener("click",P),J.addEventListener("submit",we=>{we.preventDefault(),z()}),document.addEventListener("keydown",we=>{we.key==="Escape"&&!N.hidden&&(we.preventDefault(),we.stopPropagation(),P())}),document.body.appendChild(N),N}function G(N){const _=c(N);return _?(re(),A.categoryId=_.category.id,A.itemId=_.item.id,A.modelData=_.modelData,A.fields.categoryValue.textContent=_.category.title||_.category.id,A.fields.idInput.value=_.item.id||"",A.fields.nameInput.value=_.item.name||"",A.fields.logoInput.value=_.item.logo||"",A.fields.externalInput.value=typeof _.item.external=="string"?_.item.external:"",A.fields.externalFlagInput.checked=_.item.external===!0,A.fields.colorInput.value=_.item.color||"",A.fields.depsInput.value=Array.isArray(_.item.deps)?_.item.deps.join(", "):"",R(""),H(_.item.id),Z(),!0):!1}return{open:G,hide:P,isOpen:()=>!!A.wrapper&&!A.wrapper.hidden}}const Mt=typeof import.meta<"u"&&"./"||"";function Ci(){console.log("[Blockscape] init");const c=document.getElementById("jsonBox"),m=document.querySelector(".blockscape-json-panel"),b=document.getElementById("app"),O=document.getElementById("overlay"),I=document.getElementById("tabTooltip"),H=document.getElementById("modelList"),T=document.getElementById("itemPreview"),A=document.getElementById("urlForm"),R=document.getElementById("urlInput"),P=document.getElementById("loadUrl"),Z=T.querySelector(".item-preview__title"),j=T.querySelector(".item-preview__body"),z=T.querySelector(".item-preview__actions"),re=T.querySelector(".item-preview__close"),G=document.getElementById("downloadJson"),N=document.getElementById("shareModel"),_=document.getElementById("createVersion"),q=document.getElementById("openInEditor"),C=document.getElementById("copyJson"),te=document.getElementById("pasteJson"),X=document.getElementById("helpButton"),J=document.getElementById("shortcutHelp"),ne=document.getElementById("shortcutHelpList"),oe=document.getElementById("shortcutHelpClose"),pe=document.getElementById("shortcutHelpBackdrop"),k="blockscape:editorPayload",$e="blockscape:editorTransfer",Ce=document.title;c.value=document.getElementById("seed").textContent.trim();let x=[],v=-1;const fe=Ei({models:x,getActiveIndex:()=>v,setActive:K,ensureModelMetadata:Pe,getModelId:me,getModelTitle:ue,computeJsonFingerprint:tt,uid:Ie});let F=null,W=new Map,M=null,Se=0,ae={x:0,y:0},Oe="map",ce=null,Me=!1,we=null;fe.hydrateConfig();function Ie(){return Math.random().toString(36).slice(2,10)}function We(e){const t=new TextEncoder().encode(e);let n="";return t.forEach(i=>{n+=String.fromCharCode(i)}),btoa(n)}function Ve(e){const t=atob(e),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return new TextDecoder().decode(n)}function Ge(e){return We(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function Be(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const n=t.length%4;return n&&(t+="=".repeat(4-n)),Ve(t)}function gt(e,t){const n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e,o.click(),URL.revokeObjectURL(i)}async function It(e){var t;if(!((t=navigator.clipboard)!=null&&t.writeText))return!1;try{return await navigator.clipboard.writeText(e),!0}catch(n){return console.warn("[Blockscape] clipboard write failed",n),!1}}async function Lt(){var e;if(!((e=navigator.clipboard)!=null&&e.readText))throw new Error("Clipboard read not supported");return navigator.clipboard.readText()}function Te(e){return(e||"blockscape").trim().toLowerCase().replace(/[^a-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"blockscape"}function bt(e){return e===null||typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(i=>bt(i)).join(",")}]`:`{${Object.keys(e).sort().map(i=>`${JSON.stringify(i)}:${bt(e[i])}`).join(",")}}`}function Nt(e){try{return bt(e)}catch{return""}}function tt(e){try{const t=typeof e=="string"?JSON.parse(e):e,n=Nt(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint parse failed (first pass)",t)}try{const t=JSON.parse(JSON.stringify(e)),n=Nt(t);if(n)return n}catch(t){console.warn("[Blockscape] fingerprint failed for value",t)}try{return JSON.stringify(e)||""}catch{return""}}const Pt=[{keys:[["Cmd/Ctrl","S"]],description:"Download the active model JSON (series if multiple versions are open)."},{keys:[["Cmd/Ctrl","Z"]],description:"Undo the last deleted tile."},{keys:[["Arrow Left"],["Arrow Right"]],description:"Move selection to the previous or next item in the current category."},{keys:[["Shift","Arrow Left"],["Shift","Arrow Right"]],description:"Reorder the selected item inside its category."},{keys:[["Arrow Up"],["Arrow Down"]],description:"Jump to the previous or next category while keeping position where possible."},{keys:[["Shift","Arrow Up"],["Shift","Arrow Down"]],description:"Move the selected item to the previous or next category."},{keys:[["Delete"]],description:"Delete the selected item (use Cmd/Ctrl+Z to undo)."},{keys:[["F2"]],description:"Open the item editor for the selected tile."},{keys:[["Escape"]],description:"Close the open preview popover."},{keys:[["Enter"],["Space"]],description:"Activate a focused tile, same as clicking it."},{keys:[["Cmd/Ctrl","V"]],description:"Append JSON models from the clipboard when focus is outside inputs."}];function Pe(e,{titleHint:t="Untitled Model",idHint:n}={}){if(!e||typeof e!="object")return e;const i=(e.title??"").toString().trim();e.title=i||t||"Untitled Model";const o=(e.id??"").toString().trim();if(o)e.id=o;else{const s=n||e.title||t||"model",a=Te(s).replace(/\./g,"-");e.id=a||`model-${Ie()}`}return typeof e.abstract!="string"&&(e.abstract=e.abstract==null?"":String(e.abstract)),e}function Rt(e){return JSON.parse(JSON.stringify(e))}function ue(e,t="Untitled Model"){var i;return e&&(((i=e.data)==null?void 0:i.title)??e.title??"").toString().trim()||t}function Ht(e,t="Untitled Model"){var o;const n=me(e);return(((o=e==null?void 0:e.apicurioVersions)==null?void 0:o.length)>1||(e==null?void 0:e.isSeries))&&n?`${n} series`:ue(e,t)}function me(e){var i;const t=(i=e==null?void 0:e.data)==null?void 0:i.id;return t&&t.toString().trim()||null}function Ye(e){const t=(e??"").toString().trim();return t?t.split(/[^a-zA-Z0-9]+/).filter(Boolean)[0]||t:""}function Dt(e){var l;if(e<0||e>=x.length||!c)return!0;const t=x[e],n=(c.value||"").trim();if(!n)return!0;let i;try{i=JSON.parse(n)}catch{return alert("Current JSON is invalid. Fix it before switching versions."),!1}Pe(i,{titleHint:ue(t),idHint:me(t)});const o=tt(t.data),s=tt(i);if(o===s)return!0;t.data=i;const a=yt(t);return a>=0&&((l=t.apicurioVersions)!=null&&l[a])&&(t.apicurioVersions[a].data=i),!0}function _t(e){const t=new Set;return((e==null?void 0:e.categories)||[]).forEach(n=>(n.items||[]).forEach(i=>{i!=null&&i.id&&t.add(i.id)})),t}function $t(e){if(v<0||!e)return null;const t=x[v].data,n=(t==null?void 0:t.categories)||[];for(const i of n){const s=(i.items||[]).find(a=>a.id===e);if(s)return{category:i,item:s,modelData:t}}return null}function Bt(e,t){const n=_t(t);let i=Te(e||"item");if(!n.has(i))return i;const o=()=>Ie().slice(0,4);for(;n.has(i);)i=`${Te(e||"item")}-${o()}`;return i}const Re=Ai({findItemAndCategoryById:$t,collectAllItemIds:_t,updateItemReferences:ki,loadActiveIntoEditor:se,rebuildFromActive:je,select:e=>ve(e),onSelectionRenamed:(e,t)=>{var n;M===e&&(M=t),((n=ce==null?void 0:ce.item)==null?void 0:n.id)===e&&(ce.item.id=t)}});function Le(e,{versionLabel:t,createdOn:n}={}){var l,u;const i=me(e);if(!i)return x.push(e),x.length-1;const o=x.findIndex(g=>me(g)===i);if(o===-1)return x.push(e),x.length-1;const s=x[o];(!Array.isArray(s.apicurioVersions)||!s.apicurioVersions.length)&&(s.apicurioVersions=[{version:"1",data:s.data,createdOn:(u=(l=s.apicurioVersions)==null?void 0:l[0])==null?void 0:u.createdOn}],s.apicurioActiveVersionIndex=0);const a=String(s.apicurioVersions.length+1);return s.apicurioVersions.push({version:a,data:e.data,createdOn:n||new Date().toISOString()}),s.apicurioActiveVersionIndex=s.apicurioVersions.length-1,s.data=e.data,s.title=ue(e)||s.title,s.isSeries=!0,o}function Jt({versionLabel:e}={}){if(v<0||!x[v])throw new Error("Load or select a model before creating a version.");let t;try{t=Rt(x[v].data)}catch(i){throw console.warn("[Blockscape] failed to clone active model for versioning",i),new Error("Could not copy the current model.")}return Pe(t,{titleHint:ue(x[v]),idHint:me(x[v])}),Le({title:ue(x[v]),data:t},{versionLabel:e||"manual",createdOn:new Date().toISOString()})}function vt(){const e=v>=0&&x[v]?x[v]:null,t=me(e);document.title=t?`${t}-blockscape`:Ce}function Tt(e="shortcut",t=!1){var g;const n=c.value||"";if(!n.trim())return console.warn("[Blockscape] download ignored: JSON box is empty."),!1;const i=x[v],o=t&&((g=i==null?void 0:i.apicurioVersions)==null?void 0:g.length)>1,s=o?JSON.stringify(i.apicurioVersions.map(w=>w.data),null,2):n,a=ue(i,"blockscape"),l=o?"-series":"",u=`${Te(a)}${l}.json`;return gt(u,s),console.log(`[Blockscape] saved JSON (${e}):`,u),!0}const r={A:"#ef4444",B:"#3b82f6",C:"#06b6d4",D:"#a855f7",E:"#f59e0b",F:"#f97316",G:"#22c55e",H:"#84cc16",I:"#10b981",J:"#14b8a6",K:"#0ea5e9",L:"#60a5fa",M:"#8b5cf6",N:"#d946ef",O:"#f43f5e",P:"#e11d48",Q:"#dc2626",R:"#f59e0b",S:"#eab308",T:"#a3e635",U:"#22d3ee",V:"#38bdf8",W:"#818cf8",X:"#a78bfa",Y:"#f472b6",Z:"#fb7185"};function d(e,t){if(t&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(t))return t;const n=(e||"?").charAt(0).toUpperCase();return r[n]||"#9ca3af"}function f(e){const t=e.replace("#",""),n=t.length===3?t.split("").map(u=>u+u).join(""):t,i=parseInt(n,16),o=i>>16&255,s=i>>8&255,a=i&255;return .2126*Math.pow(o/255,2.2)+.7152*Math.pow(s/255,2.2)+.0722*Math.pow(a/255,2.2)>.35?"#111111":"#ffffff"}function h(){if(!(typeof window>"u"||typeof window.scrollTo!="function"))try{window.scrollTo({top:0,behavior:"smooth"})}catch{window.scrollTo(0,0)}}function p(){ne&&(ne.innerHTML="",Pt.forEach(e=>{const t=document.createElement("div");t.className="shortcut-help__row";const n=document.createElement("div");n.className="shortcut-help__keys",e.keys.forEach((o,s)=>{if(s>0){const l=document.createElement("span");l.className="shortcut-help__or",l.textContent="or",n.appendChild(l)}const a=document.createElement("div");a.className="shortcut-help__combo",o.forEach((l,u)=>{if(u>0){const w=document.createElement("span");w.className="shortcut-help__sep",w.textContent="+",a.appendChild(w)}const g=document.createElement("kbd");g.className="shortcut-help__key",g.textContent=l,a.appendChild(g)}),n.appendChild(a)});const i=document.createElement("div");i.className="shortcut-help__desc",i.textContent=e.description,t.appendChild(n),t.appendChild(i),ne.appendChild(t)}),Me=!0)}function y(){return!!J&&J.hidden===!1}function B(){if(!J)return;Me||p(),we=document.activeElement,J.hidden=!1,J.setAttribute("aria-hidden","false"),document.body.classList.add("shortcut-help-open");const e=J.querySelector(".shortcut-help__panel");e==null||e.focus({preventScroll:!0})}function S(){if(!J||J.hidden)return;J.hidden=!0,J.setAttribute("aria-hidden","true"),document.body.classList.remove("shortcut-help-open");const e=we;e!=null&&e.focus?e.focus({preventScroll:!0}):X!=null&&X.focus&&X.focus({preventScroll:!0})}let V=!1;function L(){V||(V=!0,requestAnimationFrame(()=>{V=!1,jt(),wt()}))}let $=!1;function K(e){if(Ne(),ce=null,e<0||e>=x.length){console.warn("[Blockscape] setActive called with out-of-range index:",e);return}v=e,console.log("[Blockscape] active model:",ue(x[e]),"(index",e+" )"),vt(),ie(),se(),je(),fe.updateAvailability()}function ie(){if(H.innerHTML="",!x.length){const e=document.createElement("li");e.className="model-nav-empty",e.textContent="No models loaded yet.",H.appendChild(e);return}x.forEach((e,t)=>{var U;const n=document.createElement("li");n.className="model-nav-item";const i=document.createElement("button");i.type="button",i.className="model-nav-button"+(t===v?" is-active":""),i.dataset.index=String(t),i.setAttribute("aria-current",t===v?"true":"false");const o=document.createElement("span");o.className="model-nav-label";const s=document.createElement("span");s.className="model-nav-title",s.textContent=Ht(e),o.appendChild(s);const a=me(e);if(a){const D=document.createElement("span");D.className="model-nav-id",D.textContent=a,o.appendChild(D)}const l=Array.isArray((U=e.data)==null?void 0:U.categories)?e.data.categories:[],u=l.reduce((D,Q)=>D+(Q.items||[]).length,0),g=document.createElement("span");g.className="model-nav-meta";const w=e.apicurioVersions&&e.apicurioVersions.length>1?` · ${e.apicurioVersions.length} versions`:"";g.textContent=`${l.length} cat · ${u} items${w}`,i.appendChild(o),i.appendChild(g),n.appendChild(i),H.appendChild(n)}),fe.updateAvailability()}function se(){if(v<0){c.value="";return}c.value=JSON.stringify(x[v].data,null,2)}function Xe(e){try{return JSON.parse(e)}catch{return null}}function He(e,t="Pasted"){const n=Array.isArray(e)?e:[];if(!n.length)return[];const i=n.map((l,u)=>!l||typeof l!="object"?null:(Pe(l,{titleHint:`${t} #${u+1}`}),{obj:l,idx:u})).filter(Boolean);if(!i.length)return[];const o=i[0].obj,s=o.title||`${t} series`;return[{id:Ie(),title:s,data:o,apicurioVersions:i.map(({obj:l,idx:u})=>({version:String(u+1),data:l})),apicurioActiveVersionIndex:0,isSeries:!0}]}function he(e,t="Pasted"){return Array.isArray(e)?He(e,t):!e||typeof e!="object"?[]:(Pe(e,{titleHint:`${t} #1`}),[{id:Ie(),title:e.title||`${t} #1`,data:e}])}function Ee(e,t="Pasted"){const n=(e||"").trim();if(!n)return[];const i=Xe(n);if(i){const s=he(i,t);if(s.length)return s}return n.split(/^\s*(?:---|%%%)\s*$/m).map(s=>s.trim()).filter(Boolean).map((s,a)=>{const l=JSON.parse(s);return Pe(l,{titleHint:`${t} #${a+1}`}),{id:Ie(),title:l.title||`${t} #${a+1}`,data:l}})}function De(e){if(!e)return!1;if(e.isContentEditable)return!0;const t=(e.tagName||"").toLowerCase();return t==="input"||t==="textarea"||t==="select"}function de(){const e=document.activeElement;return!e||e===document.body||e===document.documentElement?!0:!De(e)}function xe(e){if(!e)return!1;const t=e.trimStart();return/^\s*(\{|\[|---|%%%)/.test(t)}function Je(){if(typeof window>"u"||!window.localStorage)return null;let e;try{e=localStorage.getItem(k)}catch(o){return console.warn("[Blockscape] failed to access editor payload",o),null}if(!e)return null;let t;try{t=JSON.parse(e)}catch(o){console.warn("[Blockscape] invalid payload JSON",o);try{localStorage.removeItem(k)}catch{}return null}if((t==null?void 0:t.source)!=="editor")return null;try{localStorage.removeItem(k)}catch(o){console.warn("[Blockscape] failed to clear editor payload",o)}if(!t.text||typeof t.text!="string")return console.warn("[Blockscape] payload missing text"),null;let n=[];try{n=Ee(t.text,t.title||"Editor Export")}catch(o){return console.warn("[Blockscape] could not parse payload text",o),null}if(!n.length)return null;let i=null;return n.forEach(o=>{const s=Le(o,{versionLabel:"editor"});i==null&&(i=s)}),console.log(`[Blockscape] imported ${n.length} model(s) from editor`),{index:i,count:n.length}}function Fe(e="storage"){const t=Je();return!t||typeof t.index!="number"?!1:(K(t.index),console.log(`[Blockscape] imported ${t.count} model(s) from editor via ${e}.`),!0)}function Ue(){const e=window.location.hash||"";let t=null;const n=e.match(/share=([^&]+)/);if(n&&(t=n[1]),!t){const a=new URLSearchParams(window.location.search);a.has("share")&&(t=a.get("share"))}if(!t)return null;let i;try{const a=Be(t);i=JSON.parse(a)}catch(a){return console.warn("[Blockscape] failed to decode share token",a),null}if(!i||typeof i!="object"||i.data==null)return console.warn("[Blockscape] share payload missing data"),null;const o=he(i.data,i.title||"Shared Model");if(!o.length)return console.warn("[Blockscape] share payload did not contain usable models"),null;let s=null;return o.forEach(a=>{const l=a.isSeries?i.title||a.title:null,u=Le({...a,apicurioArtifactName:l||a.apicurioArtifactName},{versionLabel:"shared"});s==null&&(s=u)}),s}async function nt(){const e=window.location.hash||"";let t=null;const n=e.match(/load=([^&]+)/);if(n)try{t=decodeURIComponent(n[1])}catch{t=n[1]}if(!t){const i=new URLSearchParams(window.location.search);i.has("load")&&(t=i.get("load"))}if(!t)return null;try{const i=await zt(t);return typeof i=="number"?i:null}catch(i){return console.warn("[Blockscape] load param failed",i),null}}function it(e){console.log("[Blockscape] parsing model; categories=",((e==null?void 0:e.categories)||[]).length);const t=new Map,n=new Map,i=new Set;(e.categories||[]).forEach(s=>(s.items||[]).forEach(a=>{i.add(a.id);const l=new Set(a.deps||[]);(e.links||[]).forEach(u=>{u.from===a.id&&l.add(u.to)}),t.set(a.id,l),l.forEach(u=>{n.has(u)||n.set(u,new Set),n.get(u).add(a.id)})}));const o=new Set;return n.forEach((s,a)=>{((s==null?void 0:s.size)||0)>=2&&o.add(a)}),{m:e,fwd:t,rev:n,reusedLocal:o,seen:i}}function on(e,t){console.log("[Blockscape] generateLetterImage for:",e);const n=document.createElement("canvas"),i=44;n.width=i,n.height=i;const o=n.getContext("2d"),s=(e||"?").charAt(0).toUpperCase(),a=d(e,t),l=f(a);return o.fillStyle=a,o.beginPath(),o.arc(i/2,i/2,i/2-2,0,2*Math.PI),o.fill(),o.strokeStyle="rgba(0,0,0,0.15)",o.lineWidth=1,o.stroke(),o.fillStyle=l,o.font=`bold ${i*.5}px system-ui, -apple-system, sans-serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(s,i/2,i/2),n.toDataURL("image/png")}function yt(e){var n;if(!((n=e==null?void 0:e.apicurioVersions)!=null&&n.length))return-1;const t=Number.isInteger(e.apicurioActiveVersionIndex)?e.apicurioActiveVersionIndex:0;return Math.min(Math.max(t,0),e.apicurioVersions.length-1)}function sn(e){const t=yt(e);if(t===-1)return null;const n=e.apicurioVersions[t];return(n==null?void 0:n.version)??null}function An(e){const t=new Map;return((e==null?void 0:e.apicurioVersions)||[]).forEach((n,i)=>{var s;const o=(((s=n==null?void 0:n.data)==null?void 0:s.id)??"").toString().trim();o&&t.set(o,i)}),t}const an=new WeakMap;function Cn(e,t){var qe;if(!((qe=e==null?void 0:e.apicurioVersions)!=null&&qe[t]))return null;const n=e.apicurioVersions[t],i=n.data,o=tt(i),s=an.get(n);if(s&&s.fingerprint===o)return s.dataUrl;const a=160,l=90,u=document.createElement("canvas");u.width=a,u.height=l;const g=u.getContext("2d");g.fillStyle="#f8fafc",g.fillRect(0,0,a,l),g.strokeStyle="#e5e7eb",g.strokeRect(.5,.5,a-1,l-1);const w=Array.isArray(i==null?void 0:i.categories)?i.categories:[],U=Math.max(w.length,1),D=a/U,Q=8,ke=8,_e=4;w.forEach((Ut,xt)=>{const at=xt*D+D/2,Qe=Array.isArray(Ut.items)?Ut.items:[],Ot=Math.max(Qe.length,1);Qe.forEach((E,Y)=>{const ee=Q+(Y+.5)*((l-Q-ke)/Ot);g.beginPath(),g.arc(at,ee,_e,0,Math.PI*2);const ct=d(E.name||E.id||"",E.color);g.fillStyle=ct,g.strokeStyle="rgba(15,23,42,0.25)",g.fill(),g.stroke()})});const Ze=u.toDataURL("image/png");return an.set(n,{fingerprint:o,dataUrl:Ze}),Ze}function Ft(e,t){var l;if(e<0||e>=x.length)return!1;const n=x[e];if(!((l=n==null?void 0:n.apicurioVersions)!=null&&l.length)||!Dt(e))return!1;const o=n.apicurioVersions.length,s=(t%o+o)%o,a=n.apicurioVersions[s];return a!=null&&a.data?(n.apicurioActiveVersionIndex=s,n.data=a.data,M=null,se(),je(),!0):!1}function cn(e){var i;if(!e||v<0)return;const t=x[v];if(!((i=t==null?void 0:t.apicurioVersions)!=null&&i.length))return;const n=yt(t);n!==-1&&Ft(v,n+e)}function Sn(e){if(!(e!=null&&e.apicurioVersions)||e.apicurioVersions.length<=1)return null;const t=document.createElement("div");t.className="version-nav";const n=document.createElement("div");n.className="version-nav__title",n.textContent=e.apicurioArtifactName||e.apicurioArtifactId||me(e)||"Artifact",t.appendChild(n);const i=document.createElement("div");i.className="version-nav__status";const o=yt(e),s=sn(e)||"latest";i.textContent=`No. in series ${s} (${o+1} of ${e.apicurioVersions.length})`,t.appendChild(i);const a=document.createElement("div");a.className="version-nav__controls";const l=document.createElement("button");l.type="button",l.className="version-nav__button",l.textContent="Previous",l.addEventListener("click",()=>cn(-1));const u=document.createElement("button");u.type="button",u.className="version-nav__button",u.textContent="Next",u.addEventListener("click",()=>cn(1)),a.appendChild(l),a.appendChild(u),t.appendChild(a);const g=document.createElement("div");return g.className="version-nav__thumbs",e.apicurioVersions.forEach((w,U)=>{var Ze;const D=document.createElement("button");D.type="button",D.className="version-nav__thumb",U===o&&D.classList.add("is-active");const Q=Cn(e,U);if(Q){const qe=document.createElement("img");qe.src=Q,qe.alt=`Version ${U+1}`,D.appendChild(qe)}const ke=document.createElement("div");ke.className="version-nav__thumb-label";const _e=Ye(((Ze=w==null?void 0:w.data)==null?void 0:Ze.id)||(w==null?void 0:w.id)||"");ke.textContent=_e||(w!=null&&w.version?`v${w.version}`:`${U+1}`),D.appendChild(ke),D.addEventListener("click",()=>Ft(v,U)),g.appendChild(D)}),t.appendChild(g),t}function rt(){var Ot;if(!F)return;ot(),Array.isArray(F.m.categories)||(F.m.categories=[]),console.log("[Blockscape] rendering categories=",F.m.categories.length),console.log("[Blockscape] model.m has abstract?",!!F.m.abstract,"- value:",F.m.abstract?F.m.abstract.substring(0,50)+"...":"none"),b.innerHTML="",W.clear();const e=Sn(x[v]);e&&b.appendChild(e),O.setAttribute("width",window.innerWidth),O.setAttribute("height",window.innerHeight);const t=document.createElement("div");t.className="blockscape-model-meta";const n=document.createElement("div");n.className="blockscape-model-title",n.textContent=F.m.title&&F.m.title.trim()||ue(x[v]),t.appendChild(n);const i=sn(x[v]),o=(F.m.id??"").toString().trim();if(o){const E=document.createElement("div");E.className="blockscape-model-id",E.textContent=`ID: ${o}`,t.appendChild(E)}if(i){const E=document.createElement("div");E.className="blockscape-model-id",E.textContent=`No. in series: ${i}`,t.appendChild(E)}b.appendChild(t);const s=document.createElement("div");s.className="blockscape-tabs";const a=document.createElement("div");a.className="blockscape-tablist",a.setAttribute("role","tablist"),s.appendChild(a);const l=document.createElement("div");l.className="blockscape-tabpanels",s.appendChild(l);const u=document.createElement("div"),g=document.createElement("div"),w=document.createElement("div"),U=document.createElement("div");let D="";const Q=An(x[v]),ke=yt(x[v]),_e=[{id:"map",label:"Map",panel:u},{id:"abstract",label:"Info",panel:g},{id:"source",label:"Source",panel:w},{id:"apicurio",label:"Apicurio",panel:U}],Ze=E=>{if(!O)return;const Y=E==="map";O.hidden=!Y,Y?(jt(),wt()):O.innerHTML=""};_e.forEach((E,Y)=>{const ee=document.createElement("button");ee.type="button",ee.id=`tab-${E.id}`,ee.className="blockscape-tab"+(Y===0?" is-active":""),ee.setAttribute("role","tab"),ee.setAttribute("aria-controls",`panel-${E.id}`),ee.setAttribute("aria-selected",Y===0?"true":"false"),ee.textContent=E.label,E.button=ee,a.appendChild(ee),E.panel.id=`panel-${E.id}`,E.panel.classList.add("blockscape-tabpanel"),E.panel.setAttribute("role","tabpanel"),E.panel.setAttribute("aria-labelledby",ee.id),E.panel.hidden=Y!==0,Y===0&&E.panel.classList.add("is-active"),l.appendChild(E.panel)});const qe=E=>{Oe=E,_e.forEach(Y=>{const ee=Y.id===E;Y.button.classList.toggle("is-active",ee),Y.button.setAttribute("aria-selected",ee?"true":"false"),Y.panel.classList.toggle("is-active",ee),Y.panel.hidden=!ee}),Ze(E)};_e.forEach(E=>{E.button.addEventListener("click",()=>{ot(),qe(E.id)}),E.id==="abstract"&&(E.button.addEventListener("mouseenter",()=>un(E.button,D,{offset:12})),E.button.addEventListener("mouseleave",ot),E.button.addEventListener("focus",()=>un(E.button,D,{offset:12})),E.button.addEventListener("blur",ot))});const Ut=((Ot=_e.find(E=>E.id===Oe))==null?void 0:Ot.id)||_e[0].id;qe(Ut),b.appendChild(s);const xt=document.createElement("div");xt.className="blockscape-render",u.appendChild(xt);const at=document.createElement("div");if(at.className="blockscape-abstract-panel",F.m.abstract){console.log("[Blockscape] Rendering abstract content");const E=document.createElement("div");E.className="blockscape-abstract",E.innerHTML=F.m.abstract,Kn(E),at.appendChild(E),D=E.outerHTML}else{console.log("[Blockscape] No abstract found in model.m");const E=document.createElement("div");E.className="blockscape-abstract-placeholder",E.textContent="No abstract has been provided for this model.",at.appendChild(E),D=E.outerHTML}g.appendChild(at);const Qe=document.createElement("div");if(Qe.className="blockscape-source-panel",m)m.hidden=!1,m.classList.remove("pf-v5-c-page__main-section"),Qe.appendChild(m);else{const E=document.createElement("p");E.className="muted",E.textContent="Source editor unavailable.",Qe.appendChild(E)}w.appendChild(Qe),fe.mount(U),F.m.categories.forEach(E=>{const Y=document.createElement("section");Y.className="category",Y.dataset.cat=E.id;const ee=document.createElement("div");ee.className="cat-head",ee.innerHTML=`<div class="cat-title">${Gt(E.title||E.id)}</div>
                          <div class="muted cat-count">${(E.items||[]).length} items</div>`,Y.appendChild(ee);const ct=document.createElement("div");ct.className="grid",Y.appendChild(ct),(E.items||[]).forEach(ge=>{const At=Ln(ge.external),ye=document.createElement("div");if(ye.className=At.isExternal?"tile external":"tile",ye.tabIndex=0,ye.dataset.id=ge.id,At.url&&(ye.dataset.externalUrl=At.url),Q.has(ge.id)){const Yt=Q.get(ge.id);ye.dataset.seriesVersionIndex=String(Yt),ye.classList.add("tile--series-link");const Zn=Yt===ke?"Current map in this series":`Open version ${Yt+1} in this series`;ye.title=Zn}const et=document.createElement("img");et.className="logo",ge.logo?(et.src=ge.logo,et.alt=ge.name||ge.id):(et.alt="",et.style.opacity=1,et.src=on(ge.name||ge.id,ge.color));const Kt=document.createElement("div");Kt.className="name",Kt.textContent=ge.name||ge.id;const Wt=document.createElement("div");Wt.className="badge",Wt.textContent="reused",At.url&&ye.appendChild(Nn(At.url)),ye.appendChild(et),ye.appendChild(Kt),ye.appendChild(Wt),ct.appendChild(ye),W.set(ge.id,{el:ye,catId:E.id,rect:null})}),xt.appendChild(Y);const kt=document.createElement("button");kt.type="button",kt.className="tile-add",kt.innerHTML='<span class="tile-add__icon" aria-hidden="true">+</span><span class="tile-add__label"></span>',kt.addEventListener("click",()=>Pn(E.id)),ct.appendChild(kt)}),F.reusedLocal.forEach(E=>{const Y=W.get(E);Y&&(Y.el.classList.add("reused"),Y.el.querySelector(".badge").style.display="inline-block")}),In(),jt(),wt()}function In(){b.querySelectorAll(".tile").forEach(e=>{e.addEventListener("click",t=>{if(typeof t.button=="number"&&t.button!==0)return;if(Ne(),e.dataset.seriesVersionIndex!=null){const i=parseInt(e.dataset.seriesVersionIndex,10);if(Number.isInteger(i)&&Ft(v,i))return}const n=e.dataset.id;if(console.log("[Blockscape] click",n),M===n){qt();return}ve(n)}),e.addEventListener("keydown",t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),e.click())}),e.draggable=!0,e.addEventListener("dragstart",Bn),e.addEventListener("dragend",Tn)}),b.querySelectorAll(".grid").forEach(e=>{e.addEventListener("dragover",Un),e.addEventListener("drop",Vn),e.addEventListener("dragenter",On),e.addEventListener("dragleave",Mn)}),$||($=!0,window.addEventListener("resize",L),window.addEventListener("scroll",L,{passive:!0})),document.getElementById("clear").onclick=()=>qt()}function jt(){W.forEach(e=>{e.rect=e.el.getBoundingClientRect()})}function ve(e){M=e,ln();const t=Array.from(F.fwd.get(e)||[]),n=Array.from(F.rev.get(e)||[]);console.log("[Blockscape] selecting id=",e,"deps=",t,"revs=",n);const i=W.get(e);i&&i.el.classList.add("selected"),t.forEach(o=>{const s=W.get(o);s&&s.el.classList.add("dep")}),n.forEach(o=>{const s=W.get(o);s&&s.el.classList.add("revdep")}),wt()}function qt(){M=null,ln(),wt()}function ln(){b.querySelectorAll(".tile").forEach(e=>e.classList.remove("dep","revdep","selected"))}function wt(){var n;for(;O.firstChild;)O.removeChild(O.firstChild);if(!M||O.hidden)return;const e=(n=W.get(M))==null?void 0:n.rect;if(!e)return;new Set([...F.fwd.get(M)||[],...F.rev.get(M)||[]]).forEach(i=>{const o=W.get(i);if(!o||!o.rect)return;const s=dn(e),a=dn(o.rect),l=document.createElementNS("http://www.w3.org/2000/svg","path"),u=(s.x+a.x)/2,g=s.y,w=(s.x+a.x)/2,U=a.y,D=(F.fwd.get(M)||new Set).has(i);l.setAttribute("d",`M ${s.x},${s.y} C ${u},${g} ${w},${U} ${a.x},${a.y}`),l.setAttribute("fill","none"),l.setAttribute("stroke",D?"var(--blockscape-dep)":"var(--blockscape-revdep)"),l.setAttribute("stroke-opacity","0.45"),l.setAttribute("stroke-width","2"),l.setAttribute("vector-effect","non-scaling-stroke"),O.appendChild(l)})}function dn(e){return{x:e.left+e.width/2,y:e.top+e.height/2}}function Gt(e){return e.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function Ln(e){if(typeof e=="string"){const t=e.trim();if(!t)return{isExternal:!1,url:""};try{const n=new URL(t);return/^https?:/i.test(n.protocol)?{isExternal:!0,url:n.toString()}:{isExternal:!1,url:""}}catch(n){return console.warn("[Blockscape] invalid external url skipped",e,n),{isExternal:!1,url:""}}}return e===!0?{isExternal:!0,url:""}:{isExternal:!1,url:""}}function Nn(e){const t=document.createElement("button");return t.type="button",t.className="external-link",t.setAttribute("aria-label","Open external reference in a new tab"),t.title=e,t.textContent="↗",t.addEventListener("click",n=>{n.stopPropagation(),window.open(e,"_blank","noopener")}),t.addEventListener("keydown",n=>n.stopPropagation()),t}function un(e,t,{offset:n=8}={}){!I||!e||!t||(I.innerHTML=t,I.hidden=!1,I.setAttribute("aria-hidden","false"),requestAnimationFrame(()=>{const i=e.getBoundingClientRect(),o=I.getBoundingClientRect(),s=window.scrollX||document.documentElement.scrollLeft,a=window.scrollY||document.documentElement.scrollTop;let l=i.left+i.width/2-o.width/2+s,u=i.top-o.height-n+a;l<s+n&&(l=s+n);const g=s+window.innerWidth-o.width-n;l>g&&(l=g),u<a+n&&(u=i.bottom+n+a),I.style.left=`${l}px`,I.style.top=`${u}px`,I.classList.add("is-visible")}))}function ot(){I&&(I.classList.remove("is-visible"),I.setAttribute("aria-hidden","true"),I.hidden=!0)}window.addEventListener("scroll",ot,!0),window.addEventListener("resize",ot);function Ne(){T&&(T.classList.remove("is-visible","item-preview--has-frame","item-preview--expanded"),T.setAttribute("aria-hidden","true"),T.hidden=!0,pn([]))}function _n(e,t){T&&(ae={x:e,y:t},T.hidden=!1,T.setAttribute("aria-hidden","false"),T.classList.add("is-visible"),st(e,t))}function st(e,t){if(!T)return;const n=12;T.style.left=`${e+n}px`,T.style.top=`${t+n}px`;const i=T.getBoundingClientRect();let o=i.left,s=i.top;i.right>window.innerWidth-n&&(o=Math.max(n,window.innerWidth-i.width-n)),i.bottom>window.innerHeight-n&&(s=Math.max(n,window.innerHeight-i.height-n)),T.style.left=`${o}px`,T.style.top=`${s}px`}function pn(e=[]){z&&(z.innerHTML="",e.forEach(t=>{const n=document.createElement("button");n.type="button",n.className="item-preview__action",n.textContent=t.label||"Action",t.title&&(n.title=t.title),n.addEventListener("click",i=>{i.stopPropagation(),typeof t.onClick=="function"&&t.onClick(i)}),z.appendChild(n)}),z.hidden=e.length===0)}async function $n(e,t){var g;if(!T)return;e.stopPropagation(),e.preventDefault();const n=t.dataset.id,i=((g=t.querySelector(".name"))==null?void 0:g.textContent)||n||"Preview",o=n?`${n}.html`:"",s=o?`items/${o}`:"",a=++Se,l=t.dataset.externalUrl||"",u=[{label:"Edit",title:"Edit this item",onClick:()=>{Ne(),Re.open(n)}}];if(l&&u.push({label:"Open link ↗",title:l,onClick:()=>window.open(l,"_blank","noopener")}),pn(u),n&&ve(n),Z.textContent=i,j.innerHTML='<div class="item-preview__status">Loading…</div>',T.classList.remove("item-preview--has-frame"),T.classList.add("item-preview--expanded"),_n(e.clientX,e.clientY),!s){j.innerHTML='<div class="item-preview__status">Preview unavailable for this item.</div>',st(ae.x,ae.y);return}try{const w=await fetch(s,{cache:"no-cache"});if(!w.ok)throw new Error(`HTTP ${w.status}`);const U=await w.text();if(a!==Se)return;if(!U.trim()){j.innerHTML=`<div class="item-preview__status">No content in <code>${Gt(o)}</code>.</div>`,st(ae.x,ae.y);return}const Q=document.createElement("iframe");Q.className="item-preview__frame",Q.title=`${i} details`,Q.srcdoc=U,j.innerHTML="",j.appendChild(Q),T.classList.add("item-preview--has-frame"),st(ae.x,ae.y)}catch(w){if(a!==Se)return;j.innerHTML=`<div class="item-preview__status">No preview available for <strong>${Gt(i)}</strong>.</div>`,console.warn(`[Blockscape] preview unavailable for ${s}`,w),st(ae.x,ae.y)}}re&&re.addEventListener("click",Ne),X&&X.addEventListener("click",()=>{B()}),oe&&oe.addEventListener("click",S),pe&&pe.addEventListener("click",S),b&&b.addEventListener("contextmenu",e=>{const t=e.target.closest(".tile");!t||!b.contains(t)||$n(e,t)}),document.addEventListener("click",e=>{typeof e.button=="number"&&e.button!==0||!T||T.hidden||T.contains(e.target)||Ne()}),G&&G.addEventListener("click",()=>{Tt("button")}),_&&_.addEventListener("click",()=>{if(v<0){alert("Load or select a model before creating a version.");return}try{const e=Jt({versionLabel:"map edit"});K(e),console.log("[Blockscape] created new version from map view")}catch(e){alert((e==null?void 0:e.message)||"Unable to create a new version right now.")}}),N&&N.addEventListener("click",async()=>{var s;if(v<0||!x[v]){alert("Select or load a model before sharing.");return}const e={title:ue(x[v],"Shared Model"),data:x[v].data};let t;try{t=Ge(JSON.stringify(e))}catch(a){console.error("[Blockscape] share encode failed",a),alert("Unable to encode this model for sharing.");return}const n=new URL(window.location.href);n.searchParams.delete("share"),n.hash=`share=${t}`;const i=n.toString();try{window.history.replaceState({},document.title,i)}catch(a){console.warn("[Blockscape] failed to update URL for share",a),window.location.hash=n.hash}let o=!1;if((s=navigator.clipboard)!=null&&s.writeText)try{await navigator.clipboard.writeText(i),o=!0}catch(a){console.warn("[Blockscape] clipboard write failed",a)}o?alert("Share URL copied to clipboard."):window.prompt("Copy this share URL:",i)}),q&&q.addEventListener("click",()=>{const e=(c.value||"").trim();if(!e){alert("Load or paste a model before opening the editor.");return}try{JSON.parse(e)}catch{alert("Current JSON is invalid. Fix it before opening the editor.");return}try{const n={ts:Date.now(),text:e,source:"viewer"};M&&(n.selectedItemId=M),localStorage.setItem(k,JSON.stringify(n))}catch(n){console.error("[Blockscape] failed to store editor payload",n),alert("Unable to stash JSON for the editor (storage disabled?).");return}let t="editor.html#viewer";M&&(t=`editor.html?selected=${encodeURIComponent(M)}#viewer`),window.open(t,"_blank")}),typeof window<"u"&&(window.addEventListener("storage",e=>{if(!e||e.storageArea&&e.storageArea!==window.localStorage||e.key!==k||!e.newValue)return;let t;try{t=JSON.parse(e.newValue)}catch(n){console.warn("[Blockscape] storage payload parse failed",n);return}!t||t.source!=="editor"||Fe("storage-event")}),window.addEventListener("message",e=>{if(!e||!e.data)return;const t=window.location.origin;if(t&&t!=="null"){if(e.origin!==t)return}else if(e.origin&&e.origin!=="null")return;typeof e.data=="object"&&e.data!==null&&e.data.type===$e&&Fe("message")})),document.addEventListener("keydown",e=>{var n,i,o,s,a,l;if(y()){e.key==="Escape"&&(e.preventDefault(),S());return}if(!((n=Re==null?void 0:Re.isOpen)!=null&&n.call(Re))){if((e.ctrlKey||e.metaKey)&&e.code==="KeyS"){e.preventDefault();const u=x[v],g=((i=u==null?void 0:u.apicurioVersions)==null?void 0:i.length)>1;Tt("shortcut",g);return}if((e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key&&e.key.toLowerCase()==="z"){if(!de())return;if(Fn()){e.preventDefault();return}}if(e.key==="Escape"&&T&&!T.hidden&&Ne(),e.key==="ArrowLeft"||e.key==="ArrowRight"){if(!de()||e.altKey||e.ctrlKey||e.metaKey)return;const u=e.key==="ArrowLeft"?-1:1;e.shiftKey?Rn(u)&&e.preventDefault():Hn(u)&&e.preventDefault()}if(e.key==="ArrowUp"||e.key==="ArrowDown"){if(!de()||e.altKey||e.ctrlKey||e.metaKey)return;const u=e.key==="ArrowUp"?-1:1;e.shiftKey?Jn(u)&&e.preventDefault():Dn(u)&&e.preventDefault()}if(e.key==="Delete"){if(!de()||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;jn()&&e.preventDefault()}if(e.key==="F2"){if(!de())return;const u=M||((l=(a=(s=(o=e.target)==null?void 0:o.closest)==null?void 0:s.call(o,".tile"))==null?void 0:a.dataset)==null?void 0:l.id);u&&Re.open(u)&&e.preventDefault()}}}),window.addEventListener("resize",()=>{!T||T.hidden||st(ae.x,ae.y)}),window.addEventListener("scroll",()=>{!T||T.hidden||Ne()},!0);let ze=null,Et=null;function Bn(e){Ne(),ze=e.target.dataset.id,Et=e.target.closest(".category").dataset.cat,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({itemId:ze,categoryId:Et})),e.target.closest(".category").querySelector(".grid").classList.add("drag-active"),console.log("[Blockscape] drag start",ze,"from",Et)}function Tn(e){e.target.classList.remove("dragging"),b.querySelectorAll(".grid").forEach(t=>t.classList.remove("drag-active")),b.querySelectorAll(".tile").forEach(t=>t.classList.remove("drag-over")),ze=null,Et=null}function Un(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function On(e){e.preventDefault();const t=e.target.closest(".grid");t&&t.classList.add("drag-active")}function Mn(e){const t=e.target.closest(".grid");t&&!t.contains(e.relatedTarget)&&t.classList.remove("drag-active")}function Vn(e){e.preventDefault();const t=e.target.closest(".grid");if(!t)return;const n=t.closest(".category");if(!n)return;const i=n.dataset.cat;if(!ze||!i)return;const s=Array.from(t.querySelectorAll(".tile")).filter(a=>a.dataset.id!==ze).find(a=>{const l=a.getBoundingClientRect();return e.clientY<l.top+l.height/2});fn(ze,s?s.dataset.id:null,i),rt(),console.log("[Blockscape] drop completed",ze,"from",Et,"to",i)}function fn(e,t,n){if(v<0)return;const o=x[v].data.categories||[],s=o.find(w=>(w.items||[]).some(U=>U.id===e)),a=o.find(w=>w.id===n);if(!s||!a)return;s.items=s.items||[],a.items=a.items||[];const l=s.items.findIndex(w=>w.id===e);if(l===-1)return;const[u]=s.items.splice(l,1);let g=a.items.length;if(t){const w=a.items.findIndex(U=>U.id===t);w!==-1&&(g=w)}a.items.splice(g,0,u),se(),je()}function Pn(e){if(v<0||!e)return;const t=x[v].data,i=(t.categories||[]).find(u=>u.id===e);if(!i)return;i.items=i.items||[];const o=`New item ${i.items.length+1}`,a={id:Bt(`${e}-${i.items.length+1}`,t),name:o,deps:[]};i.items.push(a),se(),je(),Ne(),ve(a.id);const l=W.get(a.id);l!=null&&l.el&&l.el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),console.log("[Blockscape] added item",a.id,"to",e)}function Rn(e){if(!M||v<0||!e)return!1;const n=x[v].data.categories||[],i=W.get(M);let o=null;if(i!=null&&i.catId&&(o=n.find(u=>u.id===i.catId)),o||(o=n.find(u=>(u.items||[]).some(g=>g.id===M))),!o)return!1;o.items=o.items||[];const s=o.items.findIndex(u=>u.id===M);if(s===-1)return!1;const a=s+e;if(a<0||a>=o.items.length)return!1;const[l]=o.items.splice(s,1);return o.items.splice(a,0,l),se(),je(),rt(),ve(M),!0}function Hn(e){if(!F||!F.m||!e)return!1;const t=F.m.categories||[];if(!t.length)return!1;const n=()=>{const u=t.find(g=>(g.items||[]).length);return u?{category:u,item:u.items[0]}:null};if(!M){const u=n();return u?(ve(u.item.id),!0):!1}const i=W.get(M);let o=null;if(i!=null&&i.catId&&(o=t.find(u=>u.id===i.catId)),o||(o=t.find(u=>(u.items||[]).some(g=>g.id===M))),!o){const u=n();return u?(ve(u.item.id),!0):!1}const s=o.items||[];if(!s.length)return!1;const a=s.findIndex(u=>u.id===M);if(a===-1)return!1;const l=a+e;return l<0||l>=s.length?!1:(ve(s[l].id),!0)}function Dn(e){if(!F||!F.m||!e)return!1;const t=F.m.categories||[];if(!t.length)return!1;const n=()=>{for(const u of t)if(u.items&&u.items.length)return u.items[0].id;return null};let o=(()=>{if(!M)return-1;const u=W.get(M);if(u!=null&&u.catId){const g=t.findIndex(w=>w.id===u.catId);if(g!==-1)return g}return t.findIndex(g=>(g.items||[]).some(w=>w.id===M))})();if(o===-1){const u=n();return u?(ve(u),!0):!1}let a=(t[o].items||[]).findIndex(u=>u.id===M);a===-1&&(a=0);let l=o+e;for(;l>=0&&l<t.length;){const g=t[l].items||[];if(g.length){const w=Math.min(g.length-1,Math.max(0,a));return ve(g[w].id),!0}l+=e>0?1:-1}return!1}function Jn(e){if(!M||v<0||!e)return!1;const n=x[v].data.categories||[];if(!n.length)return!1;const i=W.get(M);let o=-1;if(i!=null&&i.catId&&(o=n.findIndex(U=>U.id===i.catId)),o===-1&&(o=n.findIndex(U=>(U.items||[]).some(D=>D.id===M))),o===-1)return!1;const s=o+e;if(s<0||s>=n.length)return!1;const a=n[o],l=n[s];if(!l)return!1;a.items=a.items||[],l.items=l.items||[];const u=a.items.findIndex(U=>U.id===M);if(u===-1)return!1;const g=Math.min(l.items.length,Math.max(0,u)),w=g<l.items.length?l.items[g].id:null;return fn(M,w,l.id),rt(),ve(M),!0}function Fn(){if(!ce||v<0)return!1;const e=x[v];if(!e||e.id!==ce.modelId)return!1;const t=ce,o=(e.data.categories||[]).find(a=>a.id===t.categoryId);if(!o)return!1;o.items=o.items||[];const s=Math.min(Math.max(t.index,0),o.items.length);return o.items.splice(s,0,t.item),ce=null,Ne(),M=null,se(),je(),rt(),ve(t.item.id),console.log("[Blockscape] undo delete restored",t.item.id),!0}function jn(){if(!M||v<0)return!1;const t=x[v].data.categories||[];if(!t.length)return!1;const n=W.get(M);let i=null;if(n!=null&&n.catId&&(i=t.find(g=>g.id===n.catId)),i||(i=t.find(g=>(g.items||[]).some(w=>w.id===M))),!i||!Array.isArray(i.items))return!1;const o=i.items.findIndex(g=>g.id===M);if(o===-1)return!1;const s=i.items.splice(o,1)[0];if(!s)return!1;const a=x[v];ce={item:s,categoryId:i.id,index:o,modelId:a?a.id:null};const u=(()=>{var w;if(i.items.length){const U=Math.min(o,i.items.length-1);return((w=i.items[U])==null?void 0:w.id)||null}const g=t.findIndex(U=>U.id===i.id);if(g===-1)return null;for(let U=g+1;U<t.length;U++){const D=t[U].items||[];if(D.length)return D[0].id}for(let U=g-1;U>=0;U--){const D=t[U].items||[];if(D.length)return D[0].id}return null})();return Ne(),M=null,se(),je(),rt(),u?ve(u):qt(),console.log("[Blockscape] removed item",s.id),!0}C&&C.addEventListener("click",async()=>{const e=c.value||"";if(!e.trim()){alert("JSON editor is empty.");return}await It(e)?alert("JSON copied to clipboard."):window.prompt("Copy this JSON manually:",e)}),te&&te.addEventListener("click",async()=>{try{const e=await Lt();if(!e){alert("Clipboard is empty.");return}c.value=e,c.focus()}catch(e){console.warn("[Blockscape] clipboard read failed",e),alert("Unable to read from the clipboard. Use Cmd/Ctrl+V inside the editor instead.")}}),document.getElementById("appendFromBox").onclick=()=>{try{const e=Ee(c.value,"Pasted");if(!e.length){alert("No valid JSON found to append.");return}console.log("[Blockscape] appending",e.length,"model(s)");let t=null;e.forEach((n,i)=>{const o=Le(n,{versionLabel:e.length>1?`paste #${i+1}`:"paste"});t==null&&(t=o)}),v===-1&&t!=null?K(t):ie()}catch(e){console.error("[Blockscape] append error:",e),alert("Append error (see console).")}},document.getElementById("replaceActive").onclick=()=>{if(v<0){alert("No active model selected.");return}try{const e=JSON.parse(c.value);Pe(e,{titleHint:ue(x[v]),idHint:me(x[v])||ue(x[v])}),x[v].data=e,x[v].title=e.title||x[v].title,vt(),console.log("[Blockscape] replaced active model:",ue(x[v])),je(),fe.updateAvailability()}catch(e){console.error("[Blockscape] replace error:",e),alert("JSON parse error (see console).")}},document.getElementById("file").onchange=async e=>{const t=Array.from(e.target.files||[]);if(t.length)try{console.log("[Blockscape] reading",t.length,"file(s)");let n=null;for(const i of t){const o=await i.text(),s=i.name.replace(/\.[^.]+$/,"")||"File",a=Ee(o,s);if(!a.length){console.warn("[Blockscape] no models in file:",i.name);continue}a.forEach((l,u)=>{var Q;const g=(((Q=l.data)==null?void 0:Q.title)??"").toString().trim(),w=a.length>1?`${i.name} #${u+1}`:i.name,U=l.isSeries?s:null;if(l.isSeries){const ke=Te(s)||s;l.data.title=g||U||l.data.title||w,l.data.id=ke,l.title=l.data.title}const D=Le({...l,title:g||w,apicurioArtifactName:U||l.apicurioArtifactName},{versionLabel:i.name});n==null&&(n=D)})}v===-1&&n!=null?K(n):ie()}catch(n){console.error("[Blockscape] file load error:",n),alert("File load error (see console).")}finally{e.target.value=""}},document.addEventListener("paste",qn);function qn(e){var o;if(!de())return;const t=((o=e.clipboardData)==null?void 0:o.getData("text/plain"))||window.clipboardData&&window.clipboardData.getData("Text")||"";if(!xe(t))return;let n=[];try{n=Ee(t,"Clipboard")}catch(s){console.warn("[Blockscape] clipboard paste ignored (invalid JSON)",s);return}if(!n.length)return;e.preventDefault();let i=null;n.forEach((s,a)=>{const l=Le(s,{versionLabel:n.length>1?`paste #${a+1}`:"paste"});i==null&&(i=l)}),console.log(`[Blockscape] pasted ${n.length} model(s) from clipboard`),i!=null&&K(i)}H.addEventListener("click",e=>{const t=e.target.closest("button[data-index]");if(!t)return;const n=parseInt(t.dataset.index,10);Number.isInteger(n)&&(h(),K(n))}),document.getElementById("removeModel").onclick=()=>{if(v<0)return;if(console.log("[Blockscape] removing model:",ue(x[v])),x.splice(v,1),!x.length){v=-1,F=null,b.innerHTML="",O.innerHTML="",c.value="",ie(),vt();return}const e=Math.min(v,x.length-1);K(e)},document.getElementById("search").addEventListener("input",e=>{const t=e.target.value.trim().toLowerCase();console.log("[Blockscape] search:",t),b.querySelectorAll(".tile").forEach(n=>{const i=n.querySelector(".name").textContent.toLowerCase();n.style.opacity=!t||i.includes(t)?1:.2})}),A&&R&&P&&A.addEventListener("submit",async e=>{e.preventDefault();const t=R.value.trim();if(!t){alert("Please enter a URL"),R.focus();return}const n=await zt(t);if(typeof n=="number"){K(n),R.value="";const i=document.getElementById("urlHint");i&&(i.textContent="")}}),function(){const t=document.getElementById("urlHint");if(!R||!t)return;let n=null;R.addEventListener("input",()=>{clearTimeout(n),n=setTimeout(()=>{const o=R.value.slice(-12);t.textContent=o?`…${o}`:""},300)})}();function je(){if(!(v<0))try{F=it(x[v].data),rt()}catch(e){console.error("[Blockscape] rebuild error (active model likely malformed):",e),alert("Active model parse/render error (see console).")}}async function Gn(){const e=["NFR.bs","planets.bs","styleguide.bs"],t=n=>Mt?Mt.endsWith("/")?`${Mt}${n}`:`${Mt}/${n}`:n;for(const n of e)try{const i=await fetch(t(n),{cache:"no-store"});if(!i.ok){console.warn(`[Blockscape] ${n} not fetched (${i.status}); skipping`);continue}const o=await i.text(),s=n.replace(/\.[^.]+$/,"")||"Model",a=Ee(o,s);if(!a.length){console.warn("[Blockscape] no models found in",n);continue}a.forEach(l=>{var g;let u={...l};if(l.isSeries){const w=Te(s)||s;u={...l,title:s,apicurioArtifactName:s,data:{...l.data,id:w,title:((g=l.data)==null?void 0:g.title)||s}}}Le(u,{versionLabel:n})}),console.log(`[Blockscape] loaded ${a.length} model(s) from ${n}`)}catch(i){console.log("[Blockscape] could not load",n,"- this is normal for file:// protocol",i)}ie()}async function zn(e){const t=[{cache:"no-store"},{cache:"reload"},{}];let n=null;for(const i of t)try{console.log(`[Blockscape] fetching ${e} with cache="${i.cache??"default"}"`);const o=await fetch(e,i);if(o.status===304){console.warn("[Blockscape] fetch returned 304 (Not Modified), retrying without cache");continue}if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return await o.text()}catch(o){n=o}throw n||new Error("Unable to fetch URL")}function Kn(e){if(!e)return;const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[];for(;t.nextNode();)n.push(t.currentNode);n.forEach(i=>Wn(i)),e.querySelectorAll("a[href]").forEach(i=>{const o=i.getAttribute("href");hn(o)&&mn(i,o)})}function Wn(e){var l,u;if(!e||!e.nodeValue||!e.nodeValue.includes("http")||(u=(l=e.parentNode)==null?void 0:l.closest)!=null&&u.call(l,"a"))return;const t=e.nodeValue,n=/(https?:\/\/[^\s<]+)/gi,i=[];let o;for(;(o=n.exec(t))!==null;)i.push({url:o[0],index:o.index});if(!i.length)return;const s=document.createDocumentFragment();let a=0;i.forEach(({url:g,index:w})=>{w>a&&s.appendChild(document.createTextNode(t.slice(a,w))),s.appendChild(Yn(g)),a=w+g.length}),a<t.length&&s.appendChild(document.createTextNode(t.slice(a))),e.parentNode.replaceChild(s,e)}function Yn(e){const t=document.createElement("a");return t.href=e,t.textContent=e,t.target="_blank",t.rel="noopener noreferrer",hn(e)&&mn(t,e),t}function mn(e,t){!e||e.dataset.gistLinkBound==="true"||(e.dataset.gistLinkBound="true",e.classList.add("blockscape-gist-link"),e.title="Load this Gist into Blockscape",e.addEventListener("click",n=>Xn(n,t,e)))}async function Xn(e,t,n){if(e.preventDefault(),e.stopPropagation(),!(!t||n.dataset.loading==="true")){n.dataset.loading="true",n.classList.add("is-loading");try{await zt(t)}finally{n.dataset.loading="false",n.classList.remove("is-loading")}}}function hn(e){if(typeof e!="string")return!1;try{const n=new URL(e,window.location.href).hostname.toLowerCase();return n==="gist.githubusercontent.com"||n.startsWith("gist.")&&n.endsWith("githubusercontent.com")}catch{return!1}}async function zt(e){try{console.log("[Blockscape] loading from URL:",e);const t=await zn(e),i=(e.split("/").pop()||"").replace(/\.[^.]+$/,"")||"URL Model";let o;try{o=Ee(t,i)}catch(a){throw new Error(`Invalid JSON payload: ${a.message}`)}if(!o.length)throw new Error("No JSON objects found in response.");let s=null;return o.forEach((a,l)=>{var Q,ke;const u=(((Q=a.data)==null?void 0:Q.title)??"").toString().trim(),g=o.length>1?`${i} #${l+1}`:i,w=a.isSeries?i:null;let U={...a};if(a.isSeries){const _e=Te(i)||i;U={...a,title:u||w||g,apicurioArtifactName:w||a.apicurioArtifactName,data:{...a.data,id:_e,title:((ke=a.data)==null?void 0:ke.title)||w||g}}}const D=Le({...U,title:u||U.title||g,apicurioArtifactName:U.apicurioArtifactName||w||a.apicurioArtifactName},{versionLabel:i});s==null&&(s=D)}),console.log(`[Blockscape] loaded ${o.length} model(s) from URL:`,i),v===-1&&s!=null?K(s):ie(),s}catch(t){return console.error("[Blockscape] URL load error:",t),alert(`Failed to load JSON from URL: ${t.message}`),null}}(async function(){const t=document.getElementById("seed");if(!t)throw new Error("Seed template not found in document.");const n=(t.textContent||t.innerHTML||"").trim();if(!n)throw new Error("Seed template is empty.");const i=Ee(n,"Blockscape");if(!i.length)throw new Error("Seed template could not be parsed.");let o=null;i.forEach(w=>{const U=Le(w,{versionLabel:"seed"});o==null&&(o=U)}),await Gn();const s=await nt(),a=Je(),l=a==null?void 0:a.index,u=Ue();K(typeof s=="number"?s:typeof u=="number"?u:typeof l=="number"?l:o??0)})()}function Si(c){let m,b,O,I,H,T=`<script id="seed" type="application/json">${c[0]}<\/script>`,A,R,P,Z,j,z,re,G;return{c(){m=pt("link"),b=lt(),O=pt("div"),O.innerHTML=`<header class="pf-v5-c-page__header"><div class="pf-v5-c-masthead pf-m-display-inline blockscape-masthead"><div class="pf-v5-c-masthead__content"><div class="blockscape-toolbar"><div class="blockscape-brand"><h1 class="sr-only">Blockscape</h1> <img class="blockscape-brand__logo" src="logos/blockscape-logo.svg" alt="Blockscape — landscape tile explorer" decoding="async"/> <a href="https://github.com/pwright/blockscape" target="_blank" class="pf-v5-c-button pf-m-plain" title="View on GitHub" aria-label="View Blockscape on GitHub"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></div> <div class="blockscape-toolbar__controls"><label class="sr-only" for="search">Search tiles</label> <input id="search" class="pf-v5-c-form-control" type="text" placeholder="Search…"/> <form id="urlForm" class="blockscape-url-form" autocomplete="on" novalidate=""><label class="sr-only" for="urlInput">Load JSON from URL</label> <input id="urlInput" name="modelUrl" class="pf-v5-c-form-control is-url" type="url" placeholder="Load JSON from URL…" autocomplete="additional-name"/> <button id="loadUrl" class="pf-v5-c-button pf-m-secondary" type="submit">Load URL</button> <div id="urlHint" class="url-hint" aria-live="polite"></div></form> <label class="pf-v5-c-button pf-m-secondary blockscape-file"><span>Load File(s)</span> <input id="file" type="file" accept=".bs,.json,.txt" multiple=""/></label> <button id="openInEditor" class="pf-v5-c-button pf-m-primary" type="button" title="Open current JSON in the editor">Edit</button> <button id="helpButton" class="pf-v5-c-button pf-m-tertiary" type="button" title="Show keyboard shortcuts">Help</button> <button id="shareModel" class="pf-v5-c-button pf-m-primary" type="button" title="Copy a shareable URL for this model">Share</button></div> <div class="blockscape-legend" role="presentation"><span class="legend-entry"><span class="legend-dot legend-dot--dep"></span> enables</span> <span class="legend-entry"><span class="legend-dot legend-dot--revdep"></span> dependents</span> <span class="legend-entry"><span class="legend-dot legend-dot--reused"></span> reused</span> <span class="legend-entry"><span class="legend-dot legend-dot--external"></span> external link</span></div></div></div></div></header> <main class="pf-v5-c-page__main"><div class="blockscape-content"><aside class="blockscape-sidebar" aria-label="Models"><div class="sidebar-heading">Models</div> <ul id="modelList" class="model-nav-list"></ul> <div class="model-actions"><button id="removeModel" class="pf-v5-c-button pf-m-tertiary" type="button" title="Remove selected model">Remove active</button> <button id="clear" class="pf-v5-c-button pf-m-tertiary" type="button">Clear selection</button></div></aside> <div class="blockscape-main"><section class="pf-v5-c-page__main-section blockscape-json-panel" hidden="" aria-label="Model source JSON editor"><p class="blockscape-json-panel__title">Paste / edit JSON for the <b>active</b> model (schema below)</p> <div class="muted">Schema: <code>{ id, title, abstract?, categories:[{id,title,items:[{id,name,logo?,external?:url,color?,deps:[]}}], links?:[{from,to}] }</code><br/>
            You can paste multiple objects separated by <code>---</code> or <code>%%%</code>, or a JSON array of models, to append several models.
            A single object replaces only when you click “Replace active with JSON”. Tip: with no input focused, press
            Cmd/Ctrl+V anywhere on the page to append clipboard JSON instantly.</div> <div class="blockscape-json-controls"><textarea id="jsonBox" class="pf-v5-c-form-control" aria-label="JSON editor for the active model"></textarea> <div class="blockscape-json-actions"><button id="copyJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Copy the current JSON to your clipboard">Copy</button> <button id="pasteJson" class="pf-v5-c-button pf-m-tertiary" type="button" title="Paste clipboard JSON to replace the editor contents">Paste</button> <button id="appendFromBox" class="pf-v5-c-button pf-m-primary" type="button">Append model(s)</button> <button id="replaceActive" class="pf-v5-c-button pf-m-secondary" type="button">Replace active with
                JSON</button> <button id="createVersion" class="pf-v5-c-button pf-m-secondary" type="button" title="Create a new version from the current map">New version</button></div></div></section> <section class="pf-v5-c-page__main-section blockscape-main-section"><div id="app" aria-live="polite"></div></section></div></div></main>`,I=lt(),H=new si(!1),A=lt(),R=xn("svg"),P=lt(),Z=pt("div"),j=lt(),z=pt("div"),z.innerHTML='<div class="item-preview__header"><span class="item-preview__title">Preview</span> <div class="item-preview__actions" hidden=""></div> <button type="button" class="item-preview__close" aria-label="Close preview">×</button></div> <div class="item-preview__body"><div class="item-preview__status">Right-click a tile to see related notes.</div></div>',re=lt(),G=pt("div"),G.innerHTML='<div id="shortcutHelpBackdrop" class="shortcut-help__backdrop"></div> <div class="shortcut-help__panel" tabindex="-1"><div class="shortcut-help__header"><div class="shortcut-help__title"><h2 id="shortcutHelpTitle">Keyboard shortcuts</h2> <p class="shortcut-help__subtitle">Stay in flow with navigation, editing, and quick exports.</p></div> <button id="shortcutHelpClose" class="shortcut-help__close" type="button" aria-label="Close keyboard shortcuts">×</button></div> <div id="shortcutHelpList" class="shortcut-help__list" aria-live="polite"></div></div>',document.title="Blockscape — simple landscape-style tiles",le(m,"rel","icon"),le(m,"type","image/svg+xml"),le(m,"href","./favicon.svg"),le(O,"class","pf-v5-c-page"),H.a=A,le(R,"id","overlay"),le(R,"class","svg-layer"),le(Z,"id","tabTooltip"),le(Z,"class","blockscape-tab-tooltip"),Z.hidden=!0,le(Z,"aria-hidden","true"),le(z,"id","itemPreview"),le(z,"class","item-preview"),z.hidden=!0,le(z,"aria-hidden","true"),le(G,"id","shortcutHelp"),le(G,"class","shortcut-help"),G.hidden=!0,le(G,"aria-hidden","true"),le(G,"role","dialog"),le(G,"aria-modal","true"),le(G,"aria-labelledby","shortcutHelpTitle")},m(N,_){ii(document.head,m),Ae(N,b,_),Ae(N,O,_),Ae(N,I,_),H.m(T,N,_),Ae(N,A,_),Ae(N,R,_),Ae(N,P,_),Ae(N,Z,_),Ae(N,j,_),Ae(N,z,_),Ae(N,re,_),Ae(N,G,_)},p:mt,i:mt,o:mt,d(N){N&&(be(b),be(O),be(I),H.d(),be(A),be(R),be(P),be(Z),be(j),be(z),be(re),be(G)),be(m)}}}function Ii(c){const m=`
  {
  "id": "blockscape",
  "title": "Blockscape (AI maps)",
  "abstract": "Blockscape (pronounced BYK-shed) visualizes value chains and dependencies using a BS file. Inspired by Wardley maps, these maps emphasizes the topology that makes maps useful.",
  "categories": [
    {
      "id": "communication",
      "title": "Communication",
      "items": [
        {
          "id": "gestalt",
          "name": "Visualise to understand",
          "logo": "./logos/block-mind-blown.gif",
          "deps": []
        },
        {
          "id": "value-chain",
          "name": "Visible value chain (y-axis)",
          "deps": []
        },
        {
          "id": "evolution",
          "name": "Evolution and maturity (x-axis)",
          "deps": []
        },
        {
          "id": "relational-awareness",
          "name": "Relations",
          "logo": "./logos/relations.png",
          "deps": []
        },
        {
          "id": "icons",
          "name": "Icons",
          "deps": []
        }
      ]
    },
    {
      "id": "experience",
      "title": "User Experience",
      "items": [
        {
          "id": "paste-bs-file",
          "name": "Paste (cmd-v)",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "load-multidoc-file",
          "name": "Series",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "create-gist-multidoc",
          "name": "Gist",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "abstract-gist-loading",
          "name": "Links",
          "deps": [
            "gists",
            "bs-format-simple"
          ]
        },
        {
          "id": "model-collection",
          "name": "Portfolio",
          "deps": [
            "apicurio",
            "bs-format-simple"
          ]
        }
      ]
    },
    {
      "id": "authoring-ai",
      "title": "Authoring (LLM)",
      "items": [
        {
          "id": "bs-format-simple",
          "name": "BS Schema",
          "deps": []
        },
        {
          "id": "editor-human-terms",
          "name": "Edit",
          "deps": [
            "bs-format-simple",
            "gestalt"
          ]
        },
        {
          "id": "llm-generate-bs",
          "name": "LLM generates BS",
          "external": "https://github.com/pwright/blockscape/blob/main/map-generation-prompt.md",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "llm-consume-bs",
          "name": "LLM consumes BS",
          "deps": [
            "bs-format-simple"
          ]
        },
        {
          "id": "move-items",
          "name": "Move (shift - arrow keys)",
          "logo": "./logos/block-swap.gif",
          "deps": []
        }
      ]
    },
    {
      "id": "platforms",
      "title": "Platforms",
      "items": [
        {
          "id": "gists",
          "name": "Gist",
          "logo": "https://favicon.im/github.com",
          "deps": []
        },
        {
          "id": "apicurio",
          "name": "Apicurio",
          "logo": "https://www.google.com/s2/favicons?domain=apicur.io&sz=96",
          "deps": []
        }
      ]
    }
  ]
}`;return ci(()=>{Ci()}),[m]}class Li extends yi{constructor(m){super(),vi(this,m,Ii,Si,ti,{})}}const Ni=document.getElementById("root");new Li({target:Ni});
